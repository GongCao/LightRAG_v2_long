{
  "chunk-e903481da2ca933e6149fef01f1db534": {
    "tokens": 1200,
    "content": "## 一、故障简述\n故障简述：于18:08开始，飞猪商旅首页异常，最近10分钟最小值失败量大于40，成功率小于60%，已达到P3故障，经排查故障是由tddl_rule变更导致，于18:18通过回滚恢复\n\n## 二、故障过程回顾\n### 2.1【故障处理时间线】\n故障时间线：\n\n2024-01-24 19:59，「[@阿豪](undefined/liufuhao.lfh)」变更**开发库**btrip_control.journey_info结构变更，增加一个字段，并修改了索引\n\n2024-01-25 10:54，「[@阿豪](undefined/liufuhao.lfh)」在开发库btrip_control.journey_info_0063表中插入条数据，查询也进行的验证\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/75856355/1706604120736-ebe9f072-fdb7-4a80-a9d0-952ec895cb93.png)\n\n2024-01-25 11:30，【功能问题触发】「[@阿豪](undefined/liufuhao.lfh)」变更**生产库**btrip_control.journey_info结构变更，增加一个字段，并修改了索引。此时线上该表的分表路由失效。\n\n2024-01-26 17:46，【技术发现问题】「[@阿豪](undefined/liufuhao.lfh)[@奇宁](undefined/weiguanda.wgd)」发现journey_info分表路由失效。意味着该表的大部分查询、写入结果错误（但不是异常）。相关业务已受影响，有潜在资损。\n\n2024-01-26 18:01，「[@奇宁](undefined/weiguanda.wgd)」尝试在预发重新发布和激活分表拓扑规则（即TDDL Rule）修复该问题 [prectrl平台](http://prectrl.alibaba.com/prectrl/user_apps.htm)\n\n2024-01-26 18:02，「[@奇宁](undefined/weiguanda.wgd)[@阿豪](undefined/liufuhao.lfh)」在预发验证journey_info表分表路由失效的问题已修复，但未到预订主链路对其他表做验证\n\n2024-01-26 18:08，【故障引入、功能问题修复】「[@奇宁](undefined/weiguanda.wgd)」在线上重新发布和激活分表拓扑规则 [变更单](https://aicf.alibaba-inc.com/aicf/change/v2/detail/735560953?spm=goc-apm.aicf-_changeList.0.0.182f2388ulxpyx)\n\n2024-01-26 18:09，「[@奇宁](undefined/weiguanda.wgd)[@阿豪](undefined/liufuhao.lfh)」在线上验证journey_info表分表路由失效的问题已修复，但同样未到预订主链路对其他表做验证\n\n2024-01-26 18:14，【故障发现及故障响应】「[@自先](undefined/huguobin.hgb)[@奇宁](undefined/weiguanda.wgd)」[@自先](undefined/huguobin.hgb)在管控报警群、商旅故障场景风险预警群等看到监控报警，并通知到[@奇宁](undefined/weiguanda.wgd)\n\n2024-01-26 18:15，【故障定位】「[@自先](undefined/huguobin.hgb)[@奇宁](undefined/weiguanda.wgd)」定位到是TDDL Rule有问题，开始尝试重新更新拓扑规则\n\n2024-01-26 18:18，**【故障发生】**故障触达故障定义\n\n2024-01-26 18:18，【恢复执行】「[@奇宁](undefined/weiguanda.wgd)」重新发布和激活了无问题的路由分表拓扑规则\n\n2024-01-26 18:19，**【故障恢复】**监控完全恢复正常\n\n2024-01-27 16:46，【影响消除】「[@奇宁](undefined/weiguanda.wgd)」联系metaq同学进行消息位点重置，对消息消费存在问题的metaq消息进行重新消费\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256373/1706495123161-22ce4505-bf09-41c7-b971-e3f1e2c01f8b.png)\n\n\n\n## 三、故障原因\n### 3.1【背景说明】\n背景：\n\n商旅管控侧依赖订单行程记录的管控能力，是基于btrip_control.journey_info订单旅程信息记录表实现的。该表的查询异常（推测是分表路由失效），会导致企业对员工重复预订行为的管控失效，从而产生重复预订订单。故在prectrl平台尝试重新生成和发布拓扑规则，以修复此问题。\n\n### 3.2【原因分析】\n一句话原因：\n\n变更btrip_control库TDDL Rule动态规则，导致btrip_control.control_module_select表TDDL Rule丢失，管控组件化接口查询失败，商旅首页对该",
    "chunk_order_index": 0,
    "full_doc_id": "doc-b8622f78416dd60a9b96f9f3bd6936ab"
  },
  "chunk-77cafdc9ad6ba576199e6d27d35abc67": {
    "tokens": 1200,
    "content": "路由失效），会导致企业对员工重复预订行为的管控失效，从而产生重复预订订单。故在prectrl平台尝试重新生成和发布拓扑规则，以修复此问题。\n\n### 3.2【原因分析】\n一句话原因：\n\n变更btrip_control库TDDL Rule动态规则，导致btrip_control.control_module_select表TDDL Rule丢失，管控组件化接口查询失败，商旅首页对该接口有强依赖，故跌零。\n\n\n根因分析：\n\n起因是btrip_control.journey_info分表路由失效，试图刷新分表拓扑规则，故进行了btrip_control库TDDL Rule动态规则变更。\n\n选择拓扑规则时，只选择了journey_info，未选择其他表。在预发进行验证后（只验证了journey_info表，未验证其他表），发起了TDDL Rule变更审批，将规则发布到线上，导致btrip_control.control_module_select表查询异常（btrip_control其他表也受影响，但仅该表为商旅首页核心依赖表）。而商旅首页对依赖该表的管控服务有强依赖，引发故障。\n\n\n> 商旅首页强依赖的服务：\n>\n> com.alitrip.btrip.btripcontrol.client.service.CorpControlService@querySelectControl~S\n>\n> com.alitrip.btrip.btripcontrol.client.service.CorpControlService@queryModuleControlByCorp~S\n>\n> com.alitrip.btrip.btripcontrol.client.service.PlaceService@checkCityAdcodeAvailable~C（btms查询人员时有调用，实际上不应该调用，已在优化中）\n>\n\n\n\n### 3.3【疑问点分析】\n#### 为什么首页没有马上跌零，而是间歇性下跌？\nTDDL Rule变更有一定延时，依赖Diamond推送到应用机器上，且配置生效需要时间，不是变更后马上对所有机器生效。\n\n\n\n#### 为什么没有回滚，而是发布了另一版拓扑规则？\n1. 已知变更前的TDDL Rule版本（V1），对功能有影响，有资损风险\n2. 回退到变更前的TDDL Rule版本（V1），同样需要审批\n\n故临时决定，先发布一版新的TDDL Rule（V10），观察故障是否恢复，若未恢复再回退到历史版本（V1）\n\n\n\n#### 为什么要变更TDDL Rule？\nbtrip_control.journey_info路由失效，造成管控侧依赖订单行程的管控项失效，有资损可能。故尝试刷新路由规则，以修复问题。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/25956541/1706323445116-35f7918b-6672-47e3-9ba1-4e90bbf7bcb2.png)\n\n可以在dms看到物理表有[0000-0063] 64张表，但逻辑表数却只有16张。\n\n且在dms中执行带路由键（corpId）的select sql语句，可以从执行日志中看到一次性查询了[0000-0015]16张表（截图未保留下来，问题修复后已无法复现）\n\n\n\n#### 为什么要变更journey_info表\n需求：欢行国际/中国港澳台机票管控服务，添加行程重复预订管控，需要管控侧同步出行人订单行程记录。该表的原有结构无法满足一笔订单中有多段行程的情况，需要进行库表结构变更。\n变更前表的唯一索引是：uk_corp_order_category_user(corp_id,order_id,category,traveler_user_id)\n\n企业ID+订单ID+类目+出行人ID，即一笔订单、一个出行人下只允许有一个行程记录。\n\n\n\n国际机票是一个订单可能会有多个行程（往返、多程），如果还是以前的结构，满足不了国际机票的订单行程信息的存储，故添加journey_index行程序号字段，并且修改了唯一索引：\n\nuk_corp_order_category_user_index(corp_id,order_id,category,traveler_user_id,journey_index)\n\n企业ID+订单ID+类目+出行人ID+行程序号，即一笔订单、一个出行人下允许有多个行程记录。\n\n\n\n#### journey_info分表路由失效原因？\n失效原因：\n\n    1. 修改表结构后，有主备延迟，主库的数据还没有同步到备库，导致主/备库物理表结构不一致，物理表没有聚合在一起，从而路由规则只能路由到聚合在一起的表上\n    2. 修改表结构导致tddl的路由规则失效\n\ndms解答：\n\ndms修改表结构已经变更成功了，没有出现变更失败的情况\ndms的逻辑库只在dms使用，dms的逻辑表数量存在问题不会影响业务\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/75856355/1706708022435-31b3eddf-8ac6-47f1-a592-f80d4b042ddf.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/75856355/1706708067613",
    "chunk_order_index": 1,
    "full_doc_id": "doc-b8622f78416dd60a9b96f9f3bd6936ab"
  },
  "chunk-3cee975ce826acbd362846fc2e25b053": {
    "tokens": 1200,
    "content": "ms的逻辑表数量存在问题不会影响业务\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/75856355/1706708022435-31b3eddf-8ac6-47f1-a592-f80d4b042ddf.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/75856355/1706708067613-ad84fcd7-5e1b-4da8-85aa-260b0aba1045.png)\n\ntddl解答：\n\ntddl的路由规则和索引没有关系，索引的变更不会导致路由失效。tddl不关心索引，就是按规则计算路由。仅此而已。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/75856355/1706708128646-b68c4cd5-3fe2-4981-b025-b5501226bd1d.png)\n\n\n\n而经过确认，[@阿豪](undefined/liufuhao.lfh)对journey_info发起的库表结构变更，并无操作上的问题。但据dms、tddl同学的答复，不应当存在路由失效的问题，故路由失效原因存疑，目前tddl的同学还在协助排查中。\n\n\n\n## 四、关注点分析\n### 4.1【系统质量】\n#### 4.1.1 需求&设计评估\n**〖关注点1〗****是否涉及产品、技术方案评估？此核心的问题是什么，如何改进？**\n\n- [x] **是，涉及**\n    - [ ] 需求评估遗漏\n    - [ ] 产品设计缺陷\n    - [ ] 系统架构设计缺陷\n        - [ ] 容错性不足 \n        - [ ] 单点，无冗余\n        - [ ] 缺乏自我保护\n        - [ ] 缓存设计不当\n        - [ ] 容量评估不足\n        - [ ] 非幂等设计\n        - [ ] 强弱依赖不合理\n        - [ ] 其他：__________\n- [ ] 否，不涉及\n\n**〖问题总结〗**\n\n**相关需求的技术方案评估无问题。**\n\n**〖改进点〗**_**需明确写明不同故障相关方的改进项（若有的话），下同。**_\n\n\n\n\n\n**〖关注点2〗****是否经过CodeReview？CodeReview阶段是否发现问题？为何没发现？**\n\n+ **是否经过CR**\n    - [ ] 是\n    - [ ] 否\n    - [x] 不涉及\n+ **是否设置合理的CR卡点**\n    - [ ] 是\n    - [ ] 否\n    - [x] 不涉及\n+ **CodeReview阶段是否发现问题？为何没发现？后续如何发现？**\n    - [ ] 是\n    - [ ] 否\n    - [x] 不涉及\n\n**〖问题分析〗******\n\n**〖改进点〗**_**需明确写明不同故障相关方的改进项（若有的话），下同。**_\n\n\n\n**〖关注点3〗****测试阶段**\n\n+ **测试内容：**涉及的测试提交单、测试用例等\n+ **测试人员：**\n+ **是否经过测试验证**\n    - [ ] 是，验证环境\n        - [ ] 预发环境\n        - [ ] 日常环境\n    - [ ] 是，测试方法\n        - [ ] 单元测试\n        - [ ] 功能回归测试\n        - [ ] 集成测试/链路测试\n        - [ ] 验收测试\n    - [ ] 否\n    - [x] 不涉及\n\n#### 4.1.3 变更质量\n+ **是否涉及变更：**\n    - [x] 是\n    - [ ] 否\n+ **变更类型：**\n    - [ ] 代码发布\n    - [x] 配置变更\n    - [ ] 其他变更：____________\n    - [ ] 不涉及\n+ **变更平台是否接入ChangeFree：**\n    - [x] 是，CF变更单链接：___[https://aicf.alibaba-inc.com/aicf/change/v2/detail/735560953?spm=goc-apm.aicf-_changeList.0.0.182f2388ulxpyx](https://aicf.alibaba-inc.com/aicf/change/v2/detail/735560953?spm=goc-apm.aicf-_changeList.0.0.182f2388ulxpyx)_____\n\n_/*要这样的链接_ [https://aicf.alibaba-inc.com/aicf/change/detail/1725370372](https://aicf.alibaba-inc.com/aicf/change/detail/1725370372) */\n\n    - [ ] 否\n+ **是否违反变更红线3.1**** **[链接](https://aliyuque.antfin.com/ngoc/fzg6dy/uar1k6)\n    - [ ] 是，违反哪条原则：\n    - [x] 否\n\n\n\n**〖关注点1〗****灰度阶段**\n\n+ **是否经过灰度：**\n    - [ ] 是\n    - [x] 否\n\nprectrl平台 tddl rule发布无灰度阶段\n\n\n\n+ **观测了",
    "chunk_order_index": 2,
    "full_doc_id": "doc-b8622f78416dd60a9b96f9f3bd6936ab"
  },
  "chunk-65dbff37716e93d938e11e7ee509fcb0": {
    "tokens": 1200,
    "content": "红线3.1**** **[链接](https://aliyuque.antfin.com/ngoc/fzg6dy/uar1k6)\n    - [ ] 是，违反哪条原则：\n    - [x] 否\n\n\n\n**〖关注点1〗****灰度阶段**\n\n+ **是否经过灰度：**\n    - [ ] 是\n    - [x] 否\n\nprectrl平台 tddl rule发布无灰度阶段\n\n\n\n+ **观测了哪些监控**：_可以附链接_\n    - [ ] 黑屏、白屏\n    - [ ] GOC监控：\n    - [ ] 系统大盘：\n    - [ ] 其他：___________\n+ **是否灰度期间发现问题？**\n    - [ ] 是\n        - [ ] 是否灰度流量过大，导致故障\n        - [ ] 灰度发现但未有效或及时修复，导致故障\n        - [ ] 其他：___________\n    - [x] 否，后续如何灰度发现？_____________\n+ **未灰度发现原因**\n    - [ ] 应用灰\n        - [ ] 灰度流量太小\n        - [ ] 灰度阶段无监控\n        - [ ] 灰度批次不合理\n        - [ ] 超长时间灰度才能发现\n    - [ ] 业务灰：策略不合理\n    - [ ] 灰度无法发现\n    - [x] 其他：  无灰度阶段  \n\n\n\n**〖关注点2〗****上线阶段**\n\n+ **是否有确定的监控观测指标**\n    - [ ] 是，监控指标及监控链接：\n    - [x] 否\n+ **是否在窗口期进行发布变更**\n    - [ ] 是\n    - [x] 否，原因：是出于修复线上问题的目的，进行的tddl rule变更\n+ **变更是否影响上下游**\n    - [x] 是，是否有提前知会上下游评估及关注变更\n        - [ ] 有提前知会\n        - [x] 没有提前知会\n    - [ ] 否\n\n### 4.2【处置能力】\n#### 4.2.1 故障发现&响应\n+ **是否监控发现**\n    - [x] 故障触发方 监控发现\n    - [x] 故障受影响方 监控发现\n    - [ ] 否，原因为：（监控无效/监控缺失）\n+ **是否5分钟内响应**\n    - [x] 是\n    - [ ] 否，原因为：\n+ **是否存在应急协同问题**\n    - [ ] 是\n        - [ ] 应急流程不明确（无流程或者流程不清晰、应急相关角色&职责不明确，缺失一号位等)\n        - [ ] 应急执行不到位（有流程，但未按流程执行，通告发送不及时，响应不及时等）\n    - [x] 否\n\n#### 4.2.2 故障定位&恢复\n+ **主要恢复方式：**\n    - [ ] 代码发布/回滚\n    - [x] 配置发布/回滚\n    - [ ] 数据订正\n    - [ ] 机器隔离/重启/扩容\n    - [ ] 配置限流\n    - [ ] 预案降级\n    - [ ] 自动恢复\n    - [ ] 其他：\n\n## 六、故障Action\n| **序号** | *******Action标题** | *******负责人** | *******计划完成时间** | **Action描述** | **验收标准** | **验收人** | **是否keyAction** | **是否回血Action** |\n| --- | --- | --- | --- | --- | --- | :---: | --- | --- |\n| 1 | 带回沟通：收敛tddl_rule的操作权限到db owner（GOC协同推进），平台能力细化 | [@箩航](undefined/cxy140446) |  | |  | | | |\n| 2 | 短期：管控侧重新同步订单行程记录，并梳理重复预订的订单 | [@奇宁](undefined/weiguanda.wgd) | 已完成 | |  | | | |\n| 3 | 长期：商旅安全生产知识库沉淀 | [@奇宁](undefined/weiguanda.wgd)[@阿豪](undefined/liufuhao.lfh) | 3.15 | 1. 补充数据类平台回滚流程2. 补充分库分表测试验证流程 |  | | | |\n\n\naction：tddl-rule 变更预发时间，发布窗口时间（流量高峰期不发布），全链路验证规范    商旅宣讲规范，写进相关文档   箩航    2.27\n\naction：tddl-rule 配置规范（本地or prectrl）文档梳理    自先    2.27\n\naction：tddl V9 V1 V10 版本差异在哪，（预发可复现）问题原因  奇宁 海遇 \n\naction：分业务商旅交易大盘监控建设  罗航   2.27\n\n\n\n## 七、影响产品线&影响面\n以下分为故障的影响和功能业务的影响两部分。\n\n#### 商旅首页跌零影响\n    - [",
    "chunk_order_index": 3,
    "full_doc_id": "doc-b8622f78416dd60a9b96f9f3bd6936ab"
  },
  "chunk-dcc4363365710963968d1de3f72af9d4": {
    "tokens": 1200,
    "content": "档梳理    自先    2.27\n\naction：tddl V9 V1 V10 版本差异在哪，（预发可复现）问题原因  奇宁 海遇 \n\naction：分业务商旅交易大盘监控建设  罗航   2.27\n\n\n\n## 七、影响产品线&影响面\n以下分为故障的影响和功能业务的影响两部分。\n\n#### 商旅首页跌零影响\n    - [x] 是否影响可用性\n        * 【10分钟】2024-01-26 18:08～2024-01-26 18:18\n    - [x] 业务影响：\n        * 商旅侧页面： 火车票，用车，机票 相关页面搜索成功率 以及成功量几乎跌零  持续时间19:08-19:18 持续十分钟\n        * 商旅交易创建下跌\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256373/1706498201609-492698ed-77bd-413b-82cc-815b6c01ab96.png)\n\n    - [x] 是否有客诉量：\n        * 无工单，但有18:15～18:23左右有热线批量进线，热线+KP求助量：20\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/25956541/1706532264412-df2b0078-3950-460d-a92c-d726939c7057.png)\n\n    - [ ] 是否有社会舆情：\n        * 舆情ESU等级/未到E等级，舆情关键词，总声量，负声量\n    - [ ] 是否产生资损：\n        * 理论资损金额，实际资损金额\n\n\n\n#### 商旅管控功能业务影响\n    - [ ] 是否影响可用性\n    - [x] 业务影响：\n        * 依赖订单行程记录的管控项（行程重复预订管控、返程管控、行程酒店预订间夜管控）失效，可能导致企业资损\n        * 影响企业数量：\n\n使用行程重复预订管控的企业（排除测试企业，22家强管控，3家弱管控）强管控企业：btrip47vh29i6whj1o995\t北京自如生活企业管理有限公司btripdvjnld2lsa3r85wv\t太极商旅测试公司btripthhl5b37pboavcuq\t广东汇天航空航天科技有限公司ding0c58c829427da423\t新开普电子股份有限公司ding614949de72a0b8a2\t康帕斯ding667e8c7e5144e95135c2f4657eb6378f\t上海欧力德物流科技有限公司ding775e1d228ffbcc4435c2f4657eb6378f\t广州瑞泰生物科技有限公司dingaded6eb89822f79e24f2f5cc6abecb85\t阳采集团有限公司dingc0fa0f2c2bdb29fa35c2f4657eb6378f\t杭州巨星科技股份有限公司dingc2352369b775d61b35c2f4657eb6378f\t闻泰通讯股份有限公司dingcc3abe41ba9e8d27f2c783f7214b6d69\t筱遇科技网络有限公司dingd127506e850d1444\t北京智网易联科技有限公司dingde8849b3edfa2291\t海南生态软件园集团有限公司dingdfb4ba73e7516c4235c2f4657eb6378f\t深圳市幸福商城科技股份有限公司dingec12d672a828a69135c2f4657eb6378f\t凯盛浩丰农业集团有限公司dingfc2382994da4c85135c2f4657eb6378f\t北京白龙马云行科技有限公司isv_platform0b18ktws0z9ji6bl\t广汽能源科技有限公司isv_platform2636pm8116yh9kd6\t比亚迪isv_platform2ou8erd060hgjx2h\t杭州云徙科技有限公司isv_platformf29m5shudf3av0b0\t德莎胶带（上海）有限公司isv_platformfdq1hp4muc4pohrf\t比亚迪lark5u9q2l5xllakzo60\t雪球玩数学弱管控企业：ding37893af6fe2f1670\t中建电子商务有限责任公司dingc6ea79f3e805963a4ac5d6980864d335\t北京全路通信信号研究设计院集团有限公司isv_platformtpk9c3hw7t412axq\t城云科技（中国）有限公司SELECT *  FROM `rule_character_case` \n\tWHERE `region` = 'corp' and `template_key` = 'corp_control'  AND `case_key` in ( 'ITINERARY_REPEAT_BOOKING_CONTROL')\n\tand `value` = '1'\n使用返程管控的企业（排除测试企业，2家）ding455afa6753963b2e\t上海哈啰普惠科技有限公司ding4a991f8e5c763ce535c2f4657eb6378f",
    "chunk_order_index": 4,
    "full_doc_id": "doc-b8622f78416dd60a9b96f9f3bd6936ab"
  },
  "chunk-926bea603fd89bdade796bf251a3db7c": {
    "tokens": 284,
    "content": "WHERE `region` = 'corp' and `template_key` = 'corp_control'  AND `case_key` in ( 'ITINERARY_REPEAT_BOOKING_CONTROL')\n\tand `value` = '1'\n使用返程管控的企业（排除测试企业，2家）ding455afa6753963b2e\t上海哈啰普惠科技有限公司ding4a991f8e5c763ce535c2f4657eb6378f\t福建宁德惠智无限科技有限公司SELECT *  FROM `rule_character_case` \n\tWHERE `region` = 'corp' and `template_key` = 'corp_control'  AND `case_key` in ( 'CORP_APPLY_RETURN_SWITCH')\n\tand `value` = '1'\n使用行程酒店预订间夜管控的企业（排除测试企业，3家）btript4li2a95op17upjv_2p33y\t浙江兰贝斯信息技术有限公司btript4li2a95op17upjv_yv846\t杭钢商旅testding171816696d1e9c1535c2f4657eb6378f\t湖南慧泽生物医药科技有限公司SELECT DISTINCT( `corp_id`)  FROM `reserve_apply_standard` WHERE `reserve_type` = 'applyRule'",
    "chunk_order_index": 5,
    "full_doc_id": "doc-b8622f78416dd60a9b96f9f3bd6936ab"
  },
  "chunk-9ceb6e826e8d344cab1d0813c89d3f9f": {
    "tokens": 1200,
    "content": "## 一、故障简述\n故障简述：于10:31开始，飞猪省钱卡开卡页监控异常总量最近10分钟最小值大于50，成功率最近10分钟均值小于80%，已达到P4故障，故障原因确认是下游fr-coupon线程池被打满，扩容后于10:41监控恢复正常水平\n\n## 二、故障过程回顾\n### 2.1【故障处理时间线】\n故障时间线：\n\n2023-09-12  10:30，CPU耗时异常上涨\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/80256373/1694490509604-791282cb-aaa8-418b-bc57-8dafab41e03d.png)\n\n2023-09-12  10:33，触发sunfire监控预警后上应急**【故障发现】**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/80256373/1694489083806-480623a2-6e8a-4cd3-a4e0-12bd2765a5cb.png)\n\n2023-09-12  10:35，goc拉群后研发响应排查问题**【故障响应】**\n\n2023-09-12  10:40，泊瓴定位到 fr-coupon线程池满 并进行扩容 【初因定位】【恢复执行】\n\n2023-09-12  10:40，总量最近10分钟最小值大于50且成功率最近10分钟均值小于80%**【故障发生】**\n\n2023-09-12  10:41， 营销扩容后，玩法切流到ump后监控指标恢复正常水位**【故障恢复】**\n\n\n\n### 2.2【时间线概览】\n_/* 填写说明：P1P2故障必填，后续考虑产品化，沉淀到故障管理平台，无需文档记录*/_\n\n![画板](https://intranetproxy.alipay.com/skylark/lark/0/2023/jpeg/7773/1688971427269-d3bc50df-aa87-4ac9-9d5c-bf10e0e07646.jpeg)\n\n\n\n## 三、故障原因\n### 3.1【背景说明】\n背景：无任何变更\n\n### 3.2【原因分析】\n一句话原因：\n\nDB连接池被打满，导致想求读写请求耗时出现异常，进而导致hsf请求连接池被打满,上游业务报错出现异常。\n\n根因分析：\n\nDB层面磁盘使用率达到96% 数据需要清理\n\n## 四、关注点分析\n### 4.2【处置能力】\n#### 4.2.1 故障发现&响应\n+ **是否监控发现**\n    - [x] 故障触发方 监控发现\n    - [ ] 故障受影响方 监控发现\n    - [ ] 否，原因为：（监控无效/监控缺失）\n+ **是否5分钟内响应**\n    - [x] 是\n    - [ ] 否，原因为：\n+ **是否存在应急协同问题**\n    - [ ] 是\n        - [ ] 应急流程不明确（无流程或者流程不清晰、应急相关角色&职责不明确，缺失一号位等)\n        - [ ] 应急执行不到位（有流程，但未按流程执行，通告发送不及时，响应不及时等）\n    - [x] 否\n\n**〖问题总结〗**\n\n**〖改进点〗**_****_\n\naction：核心场景依赖梳理  木霄 亚琼   10.15\n\n\n\n#### 4.2.2 故障定位&恢复\n+ **主要恢复方式：**\n    - [ ] 代码发布/回滚\n    - [ ] 配置发布/回滚\n    - [ ] 数据订正\n    - [ ] 机器隔离/重启/扩容\n    - [ ] 配置限流\n    - [x] 预案降级\n    - [ ] 自动恢复\n    - [ ] 其他：\n\n**〖关注点1〗定位&恢复阶段存在什么问题？是否可以增加预案，****有更快的恢复方式？****相关的优化改进？**\n\n**〖问题总结〗**\n\n**〖改进点〗**\n\n1、DB 磁盘没有配置监控 磁盘使用率过高导致的数据异常 \n\n## 六、故障Action\n| **序号** | *******Action标题** | *******负责人** | *******计划完成时间** | **Action描述** | **验收标准** | **验收人** | **是否keyAction** | **是否回血Action** |\n| --- | --- | --- | --- | --- | --- | :---: | --- | --- |\n| 1 | 短期：升级DB配置 | 亚琼 | 9.12 |  |  | | | |\n| 2 | 短期：DB磁盘清理 | 木霄亚琼 | 10.13 | |  | | | |\n| 3 | 短期： |  |  | |  | |",
    "chunk_order_index": 0,
    "full_doc_id": "doc-a907f40cf861c8e07e48fe526ce445df"
  },
  "chunk-7a2d9cb4a64e3ed1d410ea5a7c7760c1": {
    "tokens": 498,
    "content": "--- | --- | --- | --- | --- | --- | :---: | --- | --- |\n| 1 | 短期：升级DB配置 | 亚琼 | 9.12 |  |  | | | |\n| 2 | 短期：DB磁盘清理 | 木霄亚琼 | 10.13 | |  | | | |\n| 3 | 短期： |  |  | |  | | | |\n| 4 | 长期:   卡券的DB依赖降级到ump | 木霄，亚琼 | 10.20 | |  | | | |\n| 5 | 长期：定期清理磁盘方案 | 木霄 | 11.15 | |  | | | |\n\n\naction：调研数据库监控   马达   10.20\n\naction：玩法切流ump常态化备案   破势 10.20\naction：ai升级版本  亚琼    9.28\n\naction：核心场景依赖梳理  木霄 亚琼   10.15\n\n## 七、影响产品线&影响面\n    - [x] 是否影响可用性\n        * 可用性指标，可用性时长消耗\n    - [ ] 业务影响：\n        * 影响的产品线，业务功能，功能受损程度（成功量/率下跌多少%），持续多少时间\n    - [ ] 是否有客诉量：\n        * 在线，热线，排队量\n    - [ ] 是否有社会舆情：\n        * 舆情ESU等级/未到E等级，舆情关键词，总声量，负声量\n    - [ ] 是否产生资损：\n        * 理论资损金额，实际资损金额\n\n_/* 可附相关故障等级定义的链接和截图]*/_\n\n**飞猪省钱卡开卡页异常时间10:30-10:41 持续12分钟，成功率最低55%**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/80256373/1694489846969-abd5a112-7aa6-4fbf-a346-9d2945b2c545.png)",
    "chunk_order_index": 1,
    "full_doc_id": "doc-a907f40cf861c8e07e48fe526ce445df"
  },
  "chunk-b34a2569d25aff9955648b1e287dc5ad": {
    "tokens": 1200,
    "content": "## 一、故障简述\n故障简述：于9月19日20:32开始，飞猪火车票、零售通提交订单异常，达到P4故障，故障原因初步确认为主站压测，开启了数据库查询预案，部分流量切到了备库，导致查不到数据。主站停止压测，切回预案。飞猪增加写后查的查询重试逻辑。于21:03监控恢复正常水位，故障恢复。\n\n## 二、故障过程回顾\n### 2.1【故障处理时间线】\n【飞猪时间线】\n\n2023-09-19  20:04，wft应用报警【故障发现】\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/80256373/1695177382499-f0adeba4-afa3-4a48-ad26-d2b6a63c2a5b.png)\n\n2023-09-19  20:04，研发在下午的飞猪火车票_提交订单异常风险预警群响应排查问题【业务响应】\n\n2023-09-19  20:07，集团全链路压测，buyers库水位比较高，已做cpu限制放开，监控水位回升，于20:10恢复正常（不是主要原因）\n\n2023-09-19  20:30，飞猪火车票监控成功率又开始下跌，应急群抛出问题继续排查\n\n2023-09-19  20:42，触达飞猪故障等级【故障发生】\n\n2023-09-19  20:58，迹航 定位到是数据库查询预案影响，申请停止压测，恢复预案\n\n2023-09-19  21:03，集团停止压测流量恢复预案【故障止血】\n\n2023-09-19  21:16，之贺增加写后查的查询重试逻辑  \n\n【零售通时间线】\n\n2023-09-19 20:02，【故障发现】零售通\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/158789/1695648883530-2be1e619-9012-49c9-8cc4-2d7357d1d20d.png)\n\n2023-09-19 20:09，【故障响应&定位】由于下午切流期间出现类似问题，因此判断和单元化回切相关，咨询切流进度（零售通）\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/158789/1695649010162-155945ac-f49c-4ac6-abdc-5c76c68e638d.png)\n\n2023-09-19 20:10，【成功率恢复】认为切流完成，问题恢复，未做进一步处理（零售通）\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/158789/1695649245021-79631cc8-7754-4603-baa1-9844196bec19.png)\n\n2023-09-19 20:30，成功率第二次下跌（零售通）\n\n2023-09-19 20:31，【故障发生】达到故障标准（零售通）\n\n2023-09-19 20:42，联系GOC同学，确认是否是切流导致（零售通）\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/158789/1695650494482-b10ee362-db13-43fc-a21d-714ed4a29187.png)\n\n2023-09-19 20:51，找迹航确认问题原因（零售通）\n\n2023-09-19 20:58，申请暂停压测（零售通）\n\n2023-09-19 21:03，压测暂停，成功率上升【故障止血】（零售通）\n\n2023-09-19 21:17，压测恢复，成功率再次下跌（零售通）\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/158789/1695650442598-2de1b22c-d478-43ce-83f3-894b29e98d64.png)\n\n2023-09-19 21:25，压测停止，故障恢复；（零售通）\n\n## 三、故障原因\n### 3.1【背景说明】\n背景：\n\n双11大促压测和大促峰值时候会开启查询数据库的主备分流，用于减轻对数据库的压力。开启主备分流后，部分查询流量会到交易数据库的备库。由于写流量是在主库，读流量被分流到了备库，当压测流量打起来后，主备的写入延迟会变高，备库流量读取到的数据会有延迟。\n\n\n\n业务方出问题的场景都是写入后直接读取，或者读取并且判断是否存在后再写入，前一种情况会出现读取到老状态导致校验失败，后一种情况会出现写入成功了但是读取不到数据。\n\n### 3.2【原因分析",
    "chunk_order_index": 0,
    "full_doc_id": "doc-a93439770537eb5e5c4432ce72a8d09e"
  },
  "chunk-3ccce3deb6328879318e696e3d112022": {
    "tokens": 1200,
    "content": "被分流到了备库，当压测流量打起来后，主备的写入延迟会变高，备库流量读取到的数据会有延迟。\n\n\n\n业务方出问题的场景都是写入后直接读取，或者读取并且判断是否存在后再写入，前一种情况会出现读取到老状态导致校验失败，后一种情况会出现写入成功了但是读取不到数据。\n\n### 3.2【原因分析】\n【一句话原因】交易数据库开启大促主备分流预案，分流到备库的流量会有数据延迟，业务方写后读等自行重新校验订单数据状态的场景被延迟干扰，导致报错。[@迹航](undefined/zhenghang.wzh)\n\n\n\n根因分析：\n\n【飞猪侧】\n\n1、飞猪火车票下单可见之后会反查所有订单的流水号，使用了tp的批量查询订单接口，如果查询不到，就认为生单没有成功返回报错，因此导致下单成功率下跌。\n\n2、 通过增加查询重试逻辑，设置重试次数和重试间隔，提升查询成功率，故障恢复\n\n3、下单链路要与可见和查询解耦[@勿痴](undefined/jinliang.njl)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/104093/1696765801269-bda4f525-f734-41b0-82e3-d57d57a4ab97.png)\n\n【零售通侧】[@青泓](undefined/zhenhong.tzh)\n\n1、零售通的订单模型，是批次单-主单-子单三层结构。为了把各个主单关联起来，需要在主单创建完成之后，把关联关系打到垂直标（valueType=0，key=b_rc）上。\n2、正常情况下，主单创建成功，垂直标valueType=0已经创建，在打b_rc标时，可以查询到该垂直标，然后走update流程。\n3、问题发生时，主单创建成功，垂直标valueType=0已经创建，在打b_rc标时，查询该垂直标，没有查询到，因此会走到create流程，create时使用同一个key，导致主键冲突，创单失败。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/158789/1695650830964-8a8fd283-9af1-4fe6-98db-3ccd3d5be1a4.png)\n\n## 四、关注点分析\n### 4.1【系统质量】\n#### 4.1.1 需求&设计评估\n**〖关注点〗****是否涉及压测预案评估方案评估？此核心的问题是什么，如何改进？**\n\n- [x] 否，不涉及\n\n**〖问题总结〗**\n\n**问题核心在于往年是否采用类似的压测方式，有无问题暴露？**\n\n**1、无零售通流量，主要是主站数据库延迟问题**\n\n**2、数据库预案分流往年都是这么执行的，无暴露此问题（分流代码2016年）**\n\n**〖改进点〗**\n\n_**1、业务（飞猪、零售通）关于预案分流加白（已完成）；**_\n\n_**2、飞猪做好异步同步（已完成）；**_\n\n_**3、接入文档中做好“交易数据库开启大促主备分流预案，分流到备库的流量会有数据延迟”相关接口注释，10.10，@jihang；**_\n\n**压测流量的推进，此次是否逐步放大，尝试用预警换故障？**\n\n1、满足流量逐步放大\n\n2、故障前几个小时，已有相关预警产生，但恢复较快，和单元化切流时间一致；\n\n\n\n### 4.2【处置能力】\n#### 4.2.1 故障发现&响应\n+ **是否监控发现**\n    - [x] 故障受影响方 监控发现\n+ **是否5分钟内响应**\n    - [x] 是\n+ **是否存在应急协同问题**\n    - [x] 否\n\n\n\n#### 4.2.2 故障定位&恢复\n+ **主要恢复方式：**\n    - [x] 其他：停止压测\n\n**〖关注点〗定位&恢复阶段存在什么问题？****有更快的恢复方式？****相关的优化改进？**\n\n**--**\n\n**1、目前预案恢复最快，应急执行也是这么做的；**\n\n**2、主备延迟，加白名单机制的GOC做好SOP，**[@晓与](undefined/zxy382343)**10.11**\n\n****\n\n**〖关注点〗数据库主备延迟告警情况**\n\n**--**\n\n**1、沟通云侧的告警平台，关于主备延迟告警能帮助到中台，**[@迹航](undefined/zhenghang.wzh)**，10.11，监控预警评估方案**\n\n\n\n## 七、影响产品线&影响面\n    - [x] 业务影响：\n        * 【飞猪】P4 20:30-21:03影响时长33分钟\n\n![](https://intranet",
    "chunk_order_index": 1,
    "full_doc_id": "doc-a93439770537eb5e5c4432ce72a8d09e"
  },
  "chunk-5a0b5c47fcb2c1c83f8c0d6000925f4b": {
    "tokens": 341,
    "content": "**\n\n**1、沟通云侧的告警平台，关于主备延迟告警能帮助到中台，**[@迹航](undefined/zhenghang.wzh)**，10.11，监控预警评估方案**\n\n\n\n## 七、影响产品线&影响面\n    - [x] 业务影响：\n        * 【飞猪】P4 20:30-21:03影响时长33分钟\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/80256373/1695193182438-0760867d-368c-452d-9d63-941c0da9e13c.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/80256373/1695193197636-49b907a9-fd43-4d66-b894-cded5c296517.png)\n\n+ 【零售通】P4 19:31-21:03影响时长32分钟\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/66856475/1696644557129-3d3cea71-d77e-4904-b9f7-c29ced94edd2.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/66856475/1696644579408-6754d67a-e8b2-4b17-bdb8-9e2edaef8985.png)\n\n##",
    "chunk_order_index": 2,
    "full_doc_id": "doc-a93439770537eb5e5c4432ce72a8d09e"
  },
  "chunk-9b6a1e1596bb11a51bad2ba53093b6bc": {
    "tokens": 1200,
    "content": "## 一、故障简述\n故障简述：于15:42开始高德分销交易量异常成功量持续10分钟与基线同比下跌大于等于40%，且成功量最近10分钟最小值大于等于20，触达P4故障，原因为高德大C用户触发集团的防刷风控，导致验价失败，于16:15麟空清理大C用户的防刷计数的缓存数据故障恢复\n\n## 二、故障过程回顾\n### 2.1【故障处理时间线】\n故障时间线：\n\n2023-08-10 15:43，吹哨人钉钉群提示高德侧有一定数量的验价报错【F-10000-02-16-025】**【故障发现】**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/127727/1691993563354-7f321f17-6437-4c83-933d-d2bfb811d13b.png?x-oss-process=image%2Fresize%2Cw_841%2Climit_0)\n\n2023-08-10 15:44，吹哨人报警【风险预警】，相关技术人员开始介入排查【故障响应】\n\n2023-08-10 15:52，成功量持续10分钟与基线同比下跌大于等于40%，且成功量最近10分钟最小值大于等于20【故障发生】\n\n2023-08-10 15:57，俅然确认是被mtee拦截，未命中飞猪风控拦截\n\n2023-08-10 16:15，中台同学麟空清理大C用户的防刷计数的缓存数据，问题恢复**【故障恢复】**【恢复执行】\n\n2023-08-10 16:20，麟空同步在创建或者渲染过程中，如果出现错误，针对疑似刷单的错误码集合，会累加到[ta](#)[ir](#)中\n\n## 三、故障原因\n### 3.1【原因分析】\n一句话原因：高德大C用户触发集团的防刷风控，导致验价失败\n\n根因分析：\n\n以下是触发报错的代码位置，大意是大C用户在1分钟内触发某种类型的报错超过5次，超过防刷风控的阈值，因此后续大C用户直接被防刷风控拦截，影响验价\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/127727/1691994549598-2679cb7e-32a2-48ed-af33-6633727a19c4.png)![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/127727/1691994541403-7ba8a7d5-b437-46e4-bcc6-cd07b76bf242.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/1956458/1692090794201-deb2585c-6999-43aa-a182-14ff70a1bd2b.png)\n\n从fliggy-buy2的监控看，触发防刷单拦截的时间点15:41前一分钟内的错误码未在疑似防刷错误码集合内。大C用户被加到刷单tair原因为真实账号在预发下单，然后预发线上tair用的同一套，导致被拦截掉：\n\n1. 线上和预发配置不一样，预发优惠扣减失败，也认作刷单，线上放过\n\n2. 该账号预发下单，多次出现扣减优惠失败\n\n3. tair线上和预发用的同一套，预发将阻断情况put到tair里，然后线上读取到了同一份tair配置，导致线上阻断\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/1956458/1692090677253-1d5789bb-8b9c-49ae-ab01-ada715f9dbeb.png)\n\n\n\n## 四、关注点分析\n### 4.2【处置能力】\n#### 4.2.1 故障发现&响应\n+ **是否监控发现**\n    - [x] 故障触发方 监控发现\n    - [ ] 故障受影响方 监控发现\n    - [ ] 否，原因为：（监控无效/监控缺失）\n+ **是否5分钟内响应**\n    - [x] 是\n    - [ ] 否，原因为：\n+ **是否存在应急协同问题**\n    - [ ] 是\n        - [ ] 应急流程不明确（无流程或者流程不清晰、应急相关角色&职责不明确，缺失一号位等)\n        - [ ] 应急执行不到位（有流程，但未按流程执行，通告发送不及时，响应不及时等）\n    - [ ] 否\n\n**〖问题总结〗**问题与集团的diamond和tair相关，应急方案\n\n**〖改进点〗**_**需明确写明不同故障相关方的改进项",
    "chunk_order_index": 0,
    "full_doc_id": "doc-c522baccc49fcfc39911987f7c5fa255"
  },
  "chunk-60c90f317652f83e7874d1a5f3671fb1": {
    "tokens": 1200,
    "content": "流程不清晰、应急相关角色&职责不明确，缺失一号位等)\n        - [ ] 应急执行不到位（有流程，但未按流程执行，通告发送不及时，响应不及时等）\n    - [ ] 否\n\n**〖问题总结〗**问题与集团的diamond和tair相关，应急方案\n\n**〖改进点〗**_**需明确写明不同故障相关方的改进项（若有的话），下同。**_\n\n1、\n\n#### 4.2.2 故障定位&恢复\n+ **主要恢复方式：**\n    - [ ] 代码发布/回滚\n    - [ ] 配置发布/回滚\n    - [ ] 数据订正\n    - [ ] 机器隔离/重启/扩容\n    - [ ] 配置限流\n    - [ ] 预案降级\n    - [ ] 自动恢复\n    - [x] 其他：清理缓存数据\n+ **是否10分钟内恢复**_/* P1P2故障填写*/_\n    - [ ] 是\n    - [ ] 否，原因：__________\n\n**〖关注点1〗定位&恢复阶段存在什么问题？是否可以增加预案，****有更快的恢复方式？****相关的优化改进？**\n\n**〖问题总结〗**fliggy-buy2独立部署之后仍然保留了一部分集团中台的代码，使用集团中台的中间件配置，因此即使定位到问题，仍然依赖于中台同学对配置进行操作，导致问题恢复较慢，平台交易同学需要及时清理或迁移类似的功能\n\n**〖改进点〗**\n\n1、防刷单校验逻辑删除。2023-08-10 16:11:46完成发布。默认线上关闭，酒店大C账号默认跳过防刷单校验。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/1956458/1692090297208-876a75bb-ac18-4970-8e44-d6d5145d47ec.png)\n\n## 六、故障Action\naction：高德大c账号 使用渠道确认 --     木哲   8.18\n\naction：中台日志来源 故障发生前账号被写入tair  麟空  昭言  8.21\n\naction：防刷单校验逻辑删除 已完成\n\n## 七、影响产品线&影响面\n    - [ ] 是否影响可用性\n        * 可用性指标，可用性时长消耗\n    - [x] 业务影响：\n        * 影响的产品线，业务功能，功能受损程度（成功量/率下跌多少%），持续多少时间\n    - [ ] 是否有客诉量：\n        * 在线，热线，排队量\n    - [ ] 是否有社会舆情：\n        * 舆情ESU等级/未到E等级，舆情关键词，总声量，负声量\n    - [ ] 是否产生资损：\n        * 理论资损金额，实际资损金额\n\n_/* 可附相关故障等级定义的链接和截图]*/_\n\n链接：\n\n截图：\n\n| **产品影响** | | **业务影响** |\n| --- | --- | --- |\n| **故障时长:**15:42-16:14 | **影响范围: 高德大C用户验价成功率** | **受影响业务: 高德大C用户间夜量** |\n| **产品异常: 高德大C用户验价成功率降低****产品优化需求:** | | **现象: 高德大C用户验证成功率降低，从而导致高德大C用户的创单总量降低，进一步影响高德大C用户的间夜量****业务侧影响:**高德验价接口成功率低于50%，持续32分钟。[https://x.alibaba-inc.com/custom/43/product/preview/generalComp/1650](https://x.alibaba-inc.com/custom/43/product/preview/generalComp/1650) |\n| | |\n\n\n飞猪：\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/127727/1691992841698-89409028-2db5-4c9b-aeab-c31dc8e61cca.png?x-oss-process=image%2Fresize%2Cw_1406%2Climit_0)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/80256373/1692069607033-12687327-c184-4faf-a24f-acf269b647e8.png)\n\n[故障场景](https://tr.alibaba-inc.com/orm/config/emergency-scene/list/online?children=true&nodeId=46059&depth=1&description=&includeRule=true&buId=17713&__tenant__=alibabaGroup&scenarioTypes%5B0%5D=FAULT_RISK&scenarioTypes%5B1%5D=FAULT&refId=387d54b6bf4974ec)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/80256373/1692069623793-0c0baed5-4c25-428c-940a-eb4b372b4cf4.png)\n\n[高德：](https://x.alibaba-inc.com/custom",
    "chunk_order_index": 1,
    "full_doc_id": "doc-c522baccc49fcfc39911987f7c5fa255"
  },
  "chunk-7affaf7dc69e09559e4c58acaf3589a8": {
    "tokens": 168,
    "content": "=FAULT_RISK&scenarioTypes%5B1%5D=FAULT&refId=387d54b6bf4974ec)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/80256373/1692069623793-0c0baed5-4c25-428c-940a-eb4b372b4cf4.png)\n\n[高德：](https://x.alibaba-inc.com/custom/43/product/preview/generalComp/1650)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/80256373/1692091189198-ed193c60-5e0e-4cba-97e1-166741315e8d.png)",
    "chunk_order_index": 2,
    "full_doc_id": "doc-c522baccc49fcfc39911987f7c5fa255"
  },
  "chunk-3c7f417fdf50ebbcb45f0a1b7fd71594": {
    "tokens": 1200,
    "content": "## 一、故障简述\n故障简述： 0928，部分用户点击租车订单详情页按钮无效，0929批量用户反馈至客满无法取消订单，原因为前端代码bug，0929 16:19 紫猫回滚订单详情页H5版本，故障止血，请知晓。\n\n## 二、故障过程回顾\n### 2.1【故障处理时间线】\n2023-09-07 16:21，[@蓑雨](undefined/zhangmingrui.zmr) [修改国内订单取消订单的代码枚举值至错误值](https://code.alibaba-inc.com/mono/vehicle-components/commit/94685f8203745882bd764aa10e751deb8bb3bf0e) 【故障注入】\n\n2023-09-21 15:53，[@紫猫](undefined/suliang.sl) 同意该改动[CR](https://code.alibaba-inc.com/mono/vehicle-components/codereview/14025339?tab=logs)\n\n2023-09-28 14:55，[@蓑雨](undefined/zhangmingrui.zmr) 开始向外灰度国内租车订单详情页5%，此后开始有部分用户反馈无法取消订单，客满同学操作帮忙取消订单 【故障发生】\n\n2023-09-28 15:25，[@蓑雨](undefined/zhangmingrui.zmr) 开始向外灰度国内租车订单详情页25%\n\n2023-09-29 10:49，[@蓑雨](undefined/zhangmingrui.zmr) 开始向外灰度国内租车订单详情页50%\n\n2023-09-29 11:27，[@蓑雨](undefined/zhangmingrui.zmr) 全量\n\n2023-09-29 16:02，[@楠絮](undefined/wanghaicong.whc) 反馈用户批量进线无法取消订单 【故障发现】\n\n2023-09-29 16:07，[@紫猫](undefined/suliang.sl) 收到问题，开始排查【故障响应】\n\n2023-09-29 16:19，[@紫猫](undefined/suliang.sl) 回滚租车订单详情页H5版本【恢复执行】【故障恢复】【影响消除】\n\n2023-09-29 16:36，[@紫猫](undefined/suliang.sl) 确认故障代码产生位置【故障定位】\n\n## 三、故障原因\n### 3.1【背景说明】\n背景：国际租车改动调整时，蓑雨同学误操作，修改国际租车代码时误替换国内租车代码；\n\n### 3.2【原因分析】\n一句话原因：修改国内租车取消订单按钮浮层事件枚举导致浮层事件未触发\n\n根因分析：\n\n[https://code.alibaba-inc.com/mono/vehicle-components/commit/94685f8203745882bd764aa10e751deb8bb3bf0e](https://code.alibaba-inc.com/mono/vehicle-components/commit/94685f8203745882bd764aa10e751deb8bb3bf0e)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/282613/1696825051704-aecd20e4-136b-45c2-a857-4bd882b071a3.png)\n\n\n\n## 四、关注点分析\n### 4.1【系统质量】 [@紫猫](undefined/suliang.sl) 评估下，不涉及可以不用填，测试，灰度，变更\n#### 4.1.1 需求&设计评估\n**〖关注点1〗****是否涉及产品、技术方案评估？此核心的问题是什么，如何改进？**\n\n- [ ] **是，涉及**\n    - [ ] 需求评估遗漏\n    - [ ] 产品设计缺陷\n    - [ ] 系统架构设计缺陷\n        - [ ] 容错性不足 \n        - [ ] 单点，无冗余\n        - [ ] 缺乏自我保护\n        - [ ] 缓存设计不当\n        - [ ] 容量评估不足\n        - [ ] 非幂等设计\n        - [ ] 强弱依赖不合理\n        - [ ] 其他：__________\n- [x] 否，不涉及\n\n**〖问题总结〗**\n\n**〖改进点〗**_**需明确写明不同故障相关方的改进项（若有的话），下同。**_\n\n1、\n\n#### 4.1.2 代码质量\n**〖关注点1〗是否代码自身存在漏洞或BUG、代码健壮性是否存在问题等?**\n\n**〖问题分析〗存在**\n\n**〖改进点〗**_****_\n\n1、当浮层事件枚举未被监听到时，应当触发告警埋点逻辑，并通过arms进行预警\n\n\n\n**〖关注点2〗****是否经过CodeReview？CodeReview阶段是否发现问题？为何没发现？**\n\n+ **是否经过CR**\n    - [x] 是\n    - [ ] 否\n    - [ ] 不涉及\n+ **是否设置合理的CR卡点**\n    - [x] 是\n    - [ ] 否\n    - [ ] 不涉及\n+ **CodeReview阶段是否发现问题？",
    "chunk_order_index": 0,
    "full_doc_id": "doc-3af0535648f78b8fdbdbf5d3783fe543"
  },
  "chunk-b750367b2a3d835a8e6e96020dd2b0b7": {
    "tokens": 1200,
    "content": "辑，并通过arms进行预警\n\n\n\n**〖关注点2〗****是否经过CodeReview？CodeReview阶段是否发现问题？为何没发现？**\n\n+ **是否经过CR**\n    - [x] 是\n    - [ ] 否\n    - [ ] 不涉及\n+ **是否设置合理的CR卡点**\n    - [x] 是\n    - [ ] 否\n    - [ ] 不涉及\n+ **CodeReview阶段是否发现问题？为何没发现？后续如何发现？**\n    - [ ] 是\n    - [x] 否\n    - [ ] 不涉及\n\n**〖问题分析〗****国际租车代码改动CR时遗漏对本部分内容的审核**\n\n**〖改进点〗**_****_\n\n1、CR时，由他人查阅CR并进行主讲，不能由本人主讲本人的CR。由于国际租车的代码改动量规模较为庞大（+32624，-18580），采用CR会的形式进行CR，[代码CR](https://code.alibaba-inc.com/mono/vehicle-components/codereview/14025339)时由个人进行主讲，主讲时会由主观原因跳过一部分内容，导致漏判；\n\n\n\n**〖关注点3〗****测试阶段**\n\n+ **测试未发现原因是什么？后续如何改进？**\n    - [x] 回归测试遗漏\n        - [ ] 手工回归测试用例遗漏\n        - [ ] 自动化未建设\n        - [ ] 自动化回归覆盖不足\n        - [x] 其他：自动化测试未进行预警\n    - [ ] 新场景测试遗漏\n        - [ ] 功能测试用例遗漏，包括正常分支和异常分支\n        - [ ] 容灾兜底测试遗漏\n        - [ ] 客户端兼容性测试遗漏\n        - [ ] 埋点测试遗漏\n        - [ ] 性能测试遗漏，影响评估不足\n        - [ ] 安全测试遗漏\n    - [x] 其他：自测不充分\n\n**〖问题总结〗**\n\n**〖改进点〗**_**需明确写明不同故障相关方的改进项（若有的话），下同。**_\n\n1、规范发布流程，严格遵守发布规范\n\n#### 4.1.3 变更质量   \n+ **是否涉及变更：**\n    - [x] 是\n    - [ ] 否\n+ **变更类型：**\n    - [x] 代码发布\n    - [ ] 配置变更\n    - [ ] 其他变更：____________\n    - [ ] 不涉及\n+ **变更平台是否接入ChangeFree：**\n    - [x] 是，CF变更单链接：___[https://aicf.alibaba-inc.com/aicf/change/v2/detail/556049301?spm=goc-apm.aicf-_changeList.0.0.48252388DKUiSH](https://aicf.alibaba-inc.com/aicf/change/v2/detail/556049301?spm=goc-apm.aicf-_changeList.0.0.48252388DKUiSH)_____\n\n_/*要这样的链接_ [https://aicf.alibaba-inc.com/aicf/change/detail/1725370372](https://aicf.alibaba-inc.com/aicf/change/detail/1725370372) */\n\n    - [ ] 否\n+ **是否违反变更红线3.1**** **[链接](https://aliyuque.antfin.com/ngoc/fzg6dy/uar1k6)\n    - [ ] 是，违反哪条原则：\n    - [x] 否\n\n**〖关注点1〗****灰度阶段**\n\n+ **是否经过灰度：**\n    - [x] 是\n    - [ ] 否\n+ **观测了哪些监控**：_可以附链接_\n    - [ ] 黑屏、白屏\n    - [ ] GOC监控：\n    - [ ] 系统大盘：\n    - [x] 其他：Arms监控，监控未监控此类场景，故无预警\n+ **是否灰度期间发现问题？**\n    - [ ] 是\n        - [ ] 是否灰度流量过大，导致故障\n        - [ ] 灰度发现但未有效或及时修复，导致故障\n        - [ ] 其他：___________\n    - [x] 否，后续如何灰度发现？增加监控预警\n+ **未灰度发现原因**\n    - [x] 应用灰\n        - [ ] 灰度流量太小\n        - [x] 灰度阶段无监控\n        - [ ] 灰度批次不合理\n        - [ ] 超长时间灰度才能发现\n    - [ ] 业务灰：策略不合理\n    - [ ] 灰度无法发现\n    - [ ] 其他：_____________\n\n**〖问题总结〗**\n\n**〖改进点〗**_****_\n\n1、增加监控能力\n\n\n\n### 4.2【处置能力】\n#### 4.2.1 故障发现&响应\n+ **是否监控发现**\n    - [ ] 故障触发方 监控发现\n    - [ ] 故障受影响方 监控发现\n    - [x] 否，原因为：（监控无效/监控缺",
    "chunk_order_index": 1,
    "full_doc_id": "doc-3af0535648f78b8fdbdbf5d3783fe543"
  },
  "chunk-c920c67a8f2b461fca761d8c71d77d12": {
    "tokens": 1200,
    "content": "�**\n\n**〖改进点〗**_****_\n\n1、增加监控能力\n\n\n\n### 4.2【处置能力】\n#### 4.2.1 故障发现&响应\n+ **是否监控发现**\n    - [ ] 故障触发方 监控发现\n    - [ ] 故障受影响方 监控发现\n    - [x] 否，原因为：（监控无效/监控缺失）\n+ **是否5分钟内响应**\n    - [x] 是\n    - [ ] 否，原因为：\n+ **是否存在应急协同问题**\n    - [ ] 是\n        - [ ] 应急流程不明确（无流程或者流程不清晰、应急相关角色&职责不明确，缺失一号位等)\n        - [ ] 应急执行不到位（有流程，但未按流程执行，通告发送不及时，响应不及时等）\n    - [x] 否\n\n**〖问题总结〗**\n\n**〖改进点〗**_****_\n\n1、需要增加监控维度与监控预警\n\n#### 4.2.2 故障定位&恢复\n+ **主要恢复方式：**\n    - [x] 代码发布/回滚\n    - [ ] 配置发布/回滚\n    - [ ] 数据订正\n    - [ ] 机器隔离/重启/扩容\n    - [ ] 配置限流\n    - [ ] 预案降级\n    - [ ] 自动恢复\n    - [ ] 其他：\n\n## 六、故障Action\n| **序号** | *******Action标题** | *******负责人** | *******计划完成时间** | **Action描述** | **验收标准** | **验收人** | **是否keyAction** | **是否回血Action** |\n| --- | --- | --- | --- | --- | --- | --- | --- | --- |\n| 1 | 短期：修复缺陷 | 蓑雨 | 2023-09-29 | 修复误调整带来的问题 | 取消浮层正常弹出 | 夏慕 | 否 | 是 |\n| 2 | 短期：增加订详通用事件处理报警 | 蓑雨 | 2023-10-31 | 对租车订详页添加事件处理的异常执行逻辑埋点 | 模拟异常场景，异常埋点正常发送 | 紫猫 | 否 | 否 |\n| 3 | 短期：规范发布流程 | 紫猫 | 2023-10-31 | 规范用车组内的发布流程，用车业务线核心页面接入[交通线稳定性发布流程与规范](https://aliyuque.antfin.com/wp9weg/hdi9l3/zgugo93mkgdn9bhh?singleDoc) | 符合交通线稳定性发布规范（主宣传） | 江渺 | 否 | 否 |\n| 4 | 短期： 自动化线上巡检没有发现问题 | 凝越 | 2023-10-31 | 查看为什么自动化巡检没有检测出问题并报警 | 问题修复（+覆盖取消订单） | 紫猫 | 否 | 否 |\n| 5 | （带回） 优化服务端指标统计及预警机制 | 侠乐 | 2023-10-31 | 对取消订单场景，数据样本量较少的场景，优化统计方式，尽可能给出预警 | 给出预警（跌零场景） | 凝越 | 否 | 否 |\n| 6 | 长期：规划推进整个用车域前端稳定性治理 用车域核心链路自动化巡检建设   方案 | 蓑雨 | 2023-10-31 | 跟进交通线稳定性专项在用车域的建设，整治Arms报错异常，建设完善的预警机制 | 对线上的异常及时预警 | 紫猫/江渺 | 是 | 否 |\n| 7 | 长期：用车域核心链路自动化巡检建设   （合并上一个） | 凝越 | 2023-10-31 | 检查接送、国内租车、国际租车核心业务的导购、交易、逆向订详等核心页面的自动化巡检流程，并在结果异常时预警通知负责人 | 每次发布后可正常触发巡检任务并通知结果，对线上的异常及时预警 | 紫猫 | 是 | 否 |\n\n\n## 七、影响产品线&影响面\n    - [x] 是否影响可用性\n        * 取消订单功能不可用\n    - [x] 业务影响：\n        * 影响的产品线： 国内租车\n        * 影响范围：\n            + 支付宝端用户\n            + 淘宝端用户\n        * 业务功能： 履约域无法取消订单\n        * 功能受损程度：\n            + 成功量上看，全量后每小时成功取消订单量受损约10单左右，总灰度持续时间19.5小时，总全量持续时间4.5小时，受影响单数按最大区间预估为60单左右；\n    - [x] 是否有客诉量：\n        * 客诉进线量50+\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/282",
    "chunk_order_index": 2,
    "full_doc_id": "doc-3af0535648f78b8fdbdbf5d3783fe543"
  },
  "chunk-36fdb9bfb8bd1e66f07c1d080af129db": {
    "tokens": 131,
    "content": "：\n            + 成功量上看，全量后每小时成功取消订单量受损约10单左右，总灰度持续时间19.5小时，总全量持续时间4.5小时，受影响单数按最大区间预估为60单左右；\n    - [x] 是否有客诉量：\n        * 客诉进线量50+\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/282613/1696852190784-5262ab91-279c-4575-bb55-09462a7cf41f.png)",
    "chunk_order_index": 3,
    "full_doc_id": "doc-3af0535648f78b8fdbdbf5d3783fe543"
  },
  "chunk-5c5f295043275649e7b44770bfcd4bc4": {
    "tokens": 1200,
    "content": "## 一、故障简述\n故障简述：于18:25开始，飞猪辅营下单成功率_新链路异常监控，成功量最近10分钟与基线同比下跌大于40%，已达到P3故障，故障原因初步确认为atap磁盘满，服务不可用导致，通过清理日志，扩容，监控成功率于18:50恢复正常水位，最后通过ateye开关关闭日志，监控成功量于18:55恢复正常\n\n## 二、故障过程回顾\n### 2.1【故障处理时间线】\n2023-0807 19:06，关闭磁盘利用率预警\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/70017/1691658585525-bfa3b8d6-5cd1-4494-8957-37185d023243.png?x-oss-process=image%2Fresize%2Cw_1406%2Climit_0)\n\n2023-08-08 15:57，全量搜索日志开关被浏览器刷新后打开\n\n2023-08-08 18:25，飞猪交通辅营生单成功量开始下跌，同时收到atap系统报警开始响应**【故障发现】**\n\n2023-08-08 18:26， 鼎霖  定位到atap load变高，但是对外接口qps没有变化， 伟喆开始重启机器，同时操作xsp推荐降级预案（国际+listing）以及同步排查是否有xsp策略配置异常（国际延误无忧上线刚操作策略配置）\n\n2023-08-08 18:35，触达故障等级定义最近10分钟与基线同比下跌大于40%**【故障发生】**\n\n2023-08-08 18:37，atap机器重启失败， 芙瞳开始紧急扩容 【恢复执行1】\n\n2023-08-08 18:40左右，atap机器重启失败， 芙瞳开始紧急扩容；同时大概在这个时间定位到是atap磁盘满导致【故障定位】\n\n2023-08-08 18:49，扩容逐步完成后，开始恢复\n\n2023-08-08 18:50， 鼎霖 发现atap搜索链路全量日志开关被打开，紧急关闭开关，成功率恢复正常水位**【故障恢复】【恢复执行】**\n\n2023-08-08 18:55，成功量恢复正常水位\n\n2023-08-08 19:30，恢复紧急预案\n\n### 2.2【时间线概览】\n![画板](https://intranetproxy.alipay.com/skylark/lark/0/2023/jpeg/70017/1691648113430-1dfb1bd9-b00f-45d4-bf64-7711b11774b1.jpeg)\n\n\n\n## 三、故障原因\n### 3.2【原因分析】\n一句话原因：\n\nateye自动修改配置值导致磁盘被打满，同时磁盘报警之前被意外关闭\n\n\n\n根因分析：\n\n1、8.7ateye批量操作打开全量搜索日志开关操作成功后（通过其他页面关闭），chrome没有关闭，8.8页面自动刷新后，又再次自动打开开关\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/70017/1691649238567-e3790ae6-fbe7-4171-9d99-511da084a6dd.png)![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/70017/1691649060630-97bd822b-14fe-4e21-bb5c-98d283172370.png)\n\n该页面如果因为页面卡住等原因没有自动返回，再次打开该页面，chrome自动刷新时，会重新设置开关\n\n\n\n2、8.7关闭预发机器磁盘报警，线上也默认被关闭（系统预警默认不区分环境）\n\n8.7号有预发机器预警，定位到原因后，先将该报警关闭\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/70017/1691658585525-bfa3b8d6-5cd1-4494-8957-37185d023243.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/70017/1691655559643-f7caea27-2920-4d05-a9da-110787f5f88c.png)\n\n\n\n## 四、关注点分析\n_一、【atap磁盘满问题】包含磁盘利用率异常上涨原因_\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/80256373/1691571132414-8be8c268-420c-4bae-a239-15ca837c1c97.png)\n\n\n\n8.7号操作打开，后来操作关闭，但是ateye操作成功页没有关闭，后来浏览器刷新后，开关又自动被执行\n\n\n\n_二、当天16:25  atap应用磁盘利用率95.06% 但实际影响服务在18：25左右_\n\ncpu大量等待io，能处理的新链接越来越少\n\n\n\n![](https",
    "chunk_order_index": 0,
    "full_doc_id": "doc-7f454bd6f31092e2ee17ce3eda2171cd"
  },
  "chunk-417bbf1819ff5dd0e0cbbce107272650": {
    "tokens": 1200,
    "content": "8be8c268-420c-4bae-a239-15ca837c1c97.png)\n\n\n\n8.7号操作打开，后来操作关闭，但是ateye操作成功页没有关闭，后来浏览器刷新后，开关又自动被执行\n\n\n\n_二、当天16:25  atap应用磁盘利用率95.06% 但实际影响服务在18：25左右_\n\ncpu大量等待io，能处理的新链接越来越少\n\n\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/70017/1691655869589-481b2a4d-687e-47da-85a4-32a3a3dc9b99.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/70017/1691659239703-b1ab4651-85f0-4991-ba8a-8947d20d6877.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/70017/1691659381139-79536baf-e626-4964-b5ac-0f147da37cf3.png)\n\n\n\n\n\n### 4.2【处置能力】\n#### 4.2.1 故障发现&响应\n+ **是否监控发现**\n    - [x] 故障触发方 监控发现\n    - [ ] 故障受影响方 监控发现\n    - [ ] 否，原因为：（监控无效/监控缺失）\n+ **是否5分钟内响应**\n    - [x] 是\n    - [ ] 否，原因为：\n+ **是否存在应急协同问题**\n    - [ ] 是\n        - [ ] 应急流程不明确（无流程或者流程不清晰、应急相关角色&职责不明确，缺失一号位等)\n        - [ ] 应急执行不到位（有流程，但未按流程执行，通告发送不及时，响应不及时等）\n    - [x] 否\n\n**〖问题总结〗**\n\n**〖改进点〗**_**需明确写明不同故障相关方的改进项（若有的话），下同。**_\n\n1、\n\n#### 4.2.2 故障定位&恢复\n+ **主要恢复方式：**\n    - [ ] 代码发布/回滚\n    - [ ] 配置发布/回滚\n    - [ ] 数据订正\n    - [x] 机器隔离/重启/扩容\n    - [ ] 配置限流\n    - [ ] 预案降级\n    - [ ] 自动恢复\n    - [x] 其他：磁盘清理\n+ **是否10分钟内恢复**_/* P1P2故障填写*/_\n    - [ ] 是\n    - [x] 否，原因：__________\n\n## 六、故障Action\n| **序号** | *******Action标题** | *******负责人** | *******计划完成时间** | **是否keyAction** |\n| --- | --- | --- | --- | --- |\n| 1 | 短期：load 内存 磁盘 hsfqps波动监控 和 订阅人检查 | 团队内应用owner昊喆 | 8.11 | 是 |\n| 2 | 核心接口响应时间监控增加 | 团队内应用owner昊喆 | 9.15 | 否 |\n| 3 | 短期：ateye配置问题讨论解决方案 | 时关 | 8.18 | 是 |\n| 4 | 短期：全量日志开关屏蔽/加白名单 | 宸星 | 8.18 | 否 |\n\n\n## 七、影响产品线&影响面\n    - [ ] 是否影响可用性\n        * 可用性指标，可用性时长消耗\n    - [x] 业务影响：\n        * 影响的产品线，业务功能，功能受损程度（成功量/率下跌多少%），持续多少时间\n\n辅营18:23-18:55影响时长32分钟  P3  [保险收益同比减少5.5W  ](https://aliyuque.antfin.com/alitripqa/uzg882/cbp4epvge7oy294k?singleDoc# 《2323/8/8机票辅营P3故障》)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/80256373/1691546133394-fafb99f9-7f5c-4fc9-8cfd-dfb6878411f7.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/80256373/1691545990804-d719bea7-2937-4171-8242-91302f4540c3.png)\n\n火车票交易辅营18:23-18:50\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/80256373/1691546462199-541d02ed-cb2d-4d18-b2f6-7ff499aa8ac0.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/80256373/1691546339955",
    "chunk_order_index": 1,
    "full_doc_id": "doc-7f454bd6f31092e2ee17ce3eda2171cd"
  },
  "chunk-2116cd1272483cbff74b346ba770ddaa": {
    "tokens": 129,
    "content": "交易辅营18:23-18:50\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/80256373/1691546462199-541d02ed-cb2d-4d18-b2f6-7ff499aa8ac0.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/80256373/1691546339955-9d319c35-0edb-4c6e-95eb-80e43c55cbb7.png)",
    "chunk_order_index": 2,
    "full_doc_id": "doc-7f454bd6f31092e2ee17ce3eda2171cd"
  },
  "chunk-4722805fbce251b939fe02661fe269d6": {
    "tokens": 1200,
    "content": "## 一、故障简述\n故障简述： 于15:58 交通辅营生单成功率下跌场景，成功量最近10分钟与基线同比下跌大于40%触发P3故障，同时由于OFFER链路成功量下跌超过60%，故障升级至P2。故障原因初步排查为5502代理人投放不限OD政策150万条以上，导致数据查询异常实时服务瘫痪，16:26通过重启atw2后监控开始逐步恢复，18:00 dms 删除5502投放政策后，多场景监控恢复正常水位，于19:10完成恢复OTA限流配置并且atw2有问题机器均已重启完成，至此所有监控均恢复正常水位。  \n\n## 二、故障过程回顾\n### 2.1【故障处理时间线】\n故障时间线：\n\n【故障引入】2023-08-03 15:40，5502代理从15:15开始投放政策，到15:40达到投放峰值，投放政策没有指定出发到达，默认为全部都能匹配，总投放量有150万条以上。\n\n**【故障发现】**2023-08-03 15:43，交通核心链路safe稳定性预警 推送预警“flysp分行测类型搜索模式有结果率”\n\n[https://x.alibaba-inc.com/custom/59/product/preview/spm/10082?crossTenant=true](https://x.alibaba-inc.com/custom/59/product/preview/spm/10082?crossTenant=true)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/2368/1691070569938-afe4d49e-99fa-4926-be3d-e5b878f3d4c7.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/2368/1691070953716-98a003fc-bb94-4236-8844-3a3bb9a45f5d.png)\n\n【故障响应】2023-08-03 15:44:44，伯潜 操作单程中转拼接最多出一个航班组合(bluekingfisher) routeSwitch.onlyCheapOne = true  ，但效果不明显\n\n2023-08-03 15:45 飞猪风险预警信息同步群 推送预警“飞猪国内机票搜索mtop监控异常”，容照接手处理。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/2368/1691065966534-a95502f2-f6c0-437b-ad3d-e3b8a1321298.png)\n\n\n\n2023-08-03 15:48 容照反馈初步定位flysp的rt上升，当前排查中；\n\n2023-08-03 15:48 发现搜索量翻倍，怀疑可能是C端的问题，去排查C端相关的流量问题（干扰排查）。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/4524/1691140044153-35d4717f-fb54-4946-8028-5560949c8d18.png)\n\n2023-08-03 15:53，伯潜操作关闭单程中转拼接 crossSwitchManager.openOneWayCross = false \n\n【故障发生】2023-08-03 15:58，[交通辅营生单成功率](https://cofree.alibaba-inc.com/orm/config/emergency-scene/list/online?children=true&depth=1&scenarioTypes%5B0%5D=FAULT_RISK&scenarioTypes%5B1%5D=FAULT&includeRule=false&typeCode=1&buId=1&__tenant__=alibabaGroup&nodeId=46134&refId=c08bea3653f1aae5)下跌场景，成功量最近10分钟与基线同比下跌大于40%触发P3故障\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/80256373/1691137961091-b7548eb1-7bea-4298-aab4-cfbe8ce02c85.png)\n\n【故障升级】2023-08-03 15:58   [国内机票履约下单及预订成功量](https://goc-yunding.alibaba-inc.com/orm/config/emergency-scene/list/online?children=true&depth=1&scenarioTypes%5B0%5D=FAULT_RISK&scenarioTypes%5B1%5D=FAULT&nodeId=46138&refId=85f01cc8d1b78b5e)最近10分钟与基线同比下跌大于60%升级P2\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/80256373/1691373043878-8b8bf9dc-046c-41e9-8927-58ce4b83f696.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/80256373/1691137405950-96b080ab-df43-43c9-bd54",
    "chunk_order_index": 0,
    "full_doc_id": "doc-c24a669d1e99f036feca92d1a6aa3a21"
  },
  "chunk-fcc59a79db9a46e4ba12930037d6c5e1": {
    "tokens": 1200,
    "content": "intranetproxy.alipay.com/skylark/lark/0/2023/png/80256373/1691373043878-8b8bf9dc-046c-41e9-8927-58ce4b83f696.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/80256373/1691137405950-96b080ab-df43-43c9-bd54-1de2442b47fc.png)\n\n2023-08-03 16:00 发现atw2的FULLGC严重，cpu水位较高，焱火开始扩容atw2，于16:20扩容完毕。扩容期间成功率开始逐渐恢复到30%。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/80256373/1691373158710-12057604-20af-4a92-abd3-0d1610ade8d5.png)\n\n2023-08-03 16:12:17 容照操作开关cutoutManager.nonSupplyOfferTripTypeChannelCutoff变更为NULL  打开非供销。\n\n2023-08-03 16:19:26 容照操作关闭供销，开关aggSearchSwitch.openSupplyOfferService变更为false\n\n完成切换非供销。\n\n[~~https://sunfire.alibaba-inc.com/custom/59/product/preview/cms/1529~~](https://sunfire.alibaba-inc.com/custom/59/product/preview/cms/1529)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/2368/1691071213340-20fbedb0-6b26-4fc0-b76f-1ba22b39fa0a.png)\n\n2023-08-03 16:24，桓玖重启atw2 prod_unit集群，总共分两批发布，期间有一部分好的机器也出现问题，导致成功率有所下降。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/2368/1691071698180-b2b905c1-fe6f-4739-ae4b-1c8b8ed773e6.png)\n\n2023-08-03 16:46，大部分机器重启完成，成功率恢复到80%左右。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/80256373/1691233898738-52226ce2-af63-42fc-9915-cf897e36606c.png)\n\n2023-08-03 16:46，机器重启的差不多了，成功率恢复到80%。  \n\n2023-08-03 16:50，发现政策有问题，联系彻空，彻空反馈政策数量查询异常。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/4524/1691140847679-fec71d90-11f2-4c0f-901c-077cc9421217.png)\n\n2023-08-03 17:10:29 容照操作恢复供销，开关aggSearchSwitch.openSupplyOfferService变更为true\n\n2023-08-03 17:30     成功率有所下跌，初步怀疑和拼接有关系。\n\n2023-08-03 17:44     伯潜定位到政策有问题，删除共享出主飞政策。\n\n【恢复执行】【根因定位】2023-08-03 18:00     伯潜定位到到5502政策问题，开始批量变更删除5502政策，搜索成功率有显著提升。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/80256373/1691377077554-79c63a36-83ae-465f-8347-ac2b875a760c.png)\n\n【故障恢复】2023-08-03 18:19，核心链路监控水位恢复正常\n\n2023-08-03 18:19，观察直飞已经比较平稳，伯潜 操作打开单程中转拼接 crossSwitchManager.openOneWayCross = true，影响 成功率10%\n2023-08-03 18:40  谨询有误操作，ateye页面刷新触发开关回滚，供销链路被关闭，搜索跌零2分钟，时间较短，无影响（交易无波动）\n\n2023-08-03 19:10，ota成功率恢复到基线,原因是部分atw2机器一直有问题，在不停的置换机器（换了10+台机器），dii不支持直接下线，需要置换，申请资源卡了一阵。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/80256373/1691234076839-587e74d9-53a1-4e29-b092-76c3491dcb04.png)\n\n【影响消除】2023-08-03 19:10，至此全部监控水位恢复正常[ 搜索无结果或信息错误](https://goc-yunding.alibaba-inc.com/ormEmergency/workbench/emergency/202308030000005842001)\n\n### 2.2【时间线概览】\n![画板](https",
    "chunk_order_index": 1,
    "full_doc_id": "doc-c24a669d1e99f036feca92d1a6aa3a21"
  },
  "chunk-4416b343a3dfea295274c411bb8675f6": {
    "tokens": 1200,
    "content": "587e74d9-53a1-4e29-b092-76c3491dcb04.png)\n\n【影响消除】2023-08-03 19:10，至此全部监控水位恢复正常[ 搜索无结果或信息错误](https://goc-yunding.alibaba-inc.com/ormEmergency/workbench/emergency/202308030000005842001)\n\n### 2.2【时间线概览】\n![画板](https://intranetproxy.alipay.com/skylark/lark/0/2023/jpeg/80256373/1691550182872-68fb418d-5e49-4c5c-8e85-9bad36c140e5.jpeg)\n\n\n\n## 三、故障原因\n### 3.1【背景说明】\n背景：现有的国内搜索架构\n\n![画板](https://intranetproxy.alipay.com/skylark/lark/0/2023/jpeg/4524/1691295180325-7eedc267-5202-4d40-9598-ab60e7f0cbad.jpeg)\n\n\t\n\n1. 目前国内供应链搜索的架构，有两个核心应用依赖flysp和atw2，任何一个应用完全挂掉都会导致搜索无结果，如果atw2完全挂掉，会导致获取不到派单销售规则等基础信息。\n2. atw2层面代理人投放的销售规则会直接影响报价引擎的计算量和响应速度，日常的平均政策查询数量是7000条，出问题的时候达到50万条（默认限制50万）。\n3. 5502是近期新上线的代理人，当天5502代理人投放了150万条不限OD的规则政策（代理人视角：把所有航司的B2B政策全部铺了一遍，在铺的过程中忘记写OD了），导致atw2引擎全部无响应（GC机器全部挂掉），最终导致搜索无结果。\n\n### 3.2【原因分析】\n一句话原因：系统缺乏自我保护机制，代理人的投放误操作有可能导致整个搜索系统瘫痪\n\n根因分析：\n\n1)    代理人投放错误导致一次计算的政策量大量增加，政策查询数达到50万。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/4524/1691319354915-4785cb09-2593-439b-9a2c-79b492eb34af.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/4524/1691320171290-9b374be8-fc8e-4a67-8a28-4ce92daf70fd.png)\n\n2） 政策数增大导致搜索请求全部都卡顿住，从而导致系统FullGC无法响应，政策对象填满了缓存。\n\n3） 扩容，限流，打开非供销，降级拼接等手段能够缓解机器计算的负载，使得部分请求能响应，但不是完全解决问题的办法，从时间线上看也基本能够符合。\n\n4） 最终解决问题的方法，订正了数据，把代理人数据全部删掉，同时临时发布一版黑名单把代理人关掉，禁止此代理人再继续投放政策。\n\n## 四、关注点分析\n### 4.1【系统质量】\n#### 4.1.1 需求&设计评估\n**〖关注点1〗****是否涉及产品、技术方案评估？此核心的问题是什么，如何改进？**\n\n- [ ] **是，涉及**\n    - [ ] 需求评估遗漏\n    - [ ] 产品设计缺陷\n    - [ ] 系统架构设计缺陷\n        - [ ] 容错性不足 \n        - [ ] 单点，无冗余\n        - [x] 缺乏自我保护\n        - [ ] 缓存设计不当\n        - [ ] 容量评估不足\n        - [ ] 非幂等设计\n        - [ ] 强弱依赖不合理\n        - [ ] 其他：__________\n- [ ] 否，不涉及\n\n**〖问题总结1〗**单个代理政策投放量级在为100万量级会把核心链路打挂问题\n\n### 4.2【处置能力】\n#### 4.2.1 故障发现&响应\n+ **是否监控发现**\n    - [ ] 故障触发方 监控发现\n    - [x] 故障受影响方 监控发现\n    - [ ] 否，原因为：（监控无效/监控缺失）\n+ **是否5分钟内响应**\n    - [x] 是\n    - [ ] 否，原因为：\n+ **是否存在应急协同问题**\n    - [ ] 是\n        - [ ] 应急流程不明确（无流程或者流程不清晰、应急相关角色&职责不明确，缺失一号位等)\n        - [ ] 应急执行不到位（有流程，但未按流程执行，通告发送不及时，响应不及时等）\n    - [ ] 否\n\n**〖问题总结1〗**应急协同过程方面是否有可以提升的点，问题定位时间比较长\n\n**〖改进点〗**_****_\n\n_**后续约定QA做故障同步的事情**",
    "chunk_order_index": 2,
    "full_doc_id": "doc-c24a669d1e99f036feca92d1a6aa3a21"
  },
  "chunk-525d84d25d42074b8329e30c8881acfb": {
    "tokens": 1200,
    "content": "&职责不明确，缺失一号位等)\n        - [ ] 应急执行不到位（有流程，但未按流程执行，通告发送不及时，响应不及时等）\n    - [ ] 否\n\n**〖问题总结1〗**应急协同过程方面是否有可以提升的点，问题定位时间比较长\n\n**〖改进点〗**_****_\n\n_**后续约定QA做故障同步的事情**_\n\n#### 4.2.2 故障定位&恢复\n+ **主要恢复方式：**\n    - [ ] 代码发布/回滚\n    - [ ] 配置发布/回滚\n    - [x] 数据订正\n    - [x] 机器隔离/重启/扩容\n    - [ ] 配置限流\n    - [ ] 预案降级\n    - [ ] 自动恢复\n    - [ ] 其他：\n+ **是否10分钟内恢复**_/* P1P2故障填写*/_\n    - [ ] 是\n    - [x] 否，原因：__________\n\n**〖关注点1〗定位&恢复阶段存在什么问题？是否可以增加预案，****有更快的恢复方式？****相关的优化改进？**\n\n**〖问题总结1〗**故障处理中各业务限流以及预案是否可以梳理成文档\n\n## 六、故障Action\n| **序号** | *******Action标题** | *******负责人** | *******计划完成时间** | **Action描述** | **验收标准** | **验收人** | **是否keyAction** | **是否回血Action** |\n| --- | --- | --- | --- | --- | --- | --- | --- | --- |\n| 1 | 短期：调整查询dii的一次返回条数 | 桓玖 | 8.3 | 查询onepolicy一次返回数量调整到10w-查询onefare一次返回数量调整到10w | 1  | 芊荀 | | |\n| 2 | 短期：政策投放增加代理人维度细化监控、报警。 | 桓玖 | 8.4 | 实时监控分代理人的投放情况， |  | 芊荀 | | |\n| 3 | 短期：政策查询增加排除代理商功能。 | 桓玖 | 8.4 | 及时关闭有问题代理商。 |  | 芊荀 | | |\n| 4 | 1）监控政策，运价查询是否触发limit限制。2）细粒度的查询限制。缓存视角，实时视角。dii视角，用户视角。全量OD视角，指定OD视角。运价视角，政策视角。3) 政策缓存对比逻辑关闭。 | 玄渡 | 8.6 | 更细粒度的监控和线上对比功能的关闭。 | | | | |\n| 5 | 政策投放总体/商家维度限流政策投放去掉默认值空 | 焱火 | 8.17 | 定好每个代理人的投放限额。每个代理人，每种政策的投放数量。 | | | | |\n| 6 | 四类供给渠道，做好隔离，互不影响。同时做到采购政策隔离。flysp不依赖atw2，atw2出现问题只返回外部报价。因为dii理论上也不可控。 | 焱火 | 8.31 | 需要做好验收，每一次 | _keyAction_ | | | |\n| 7 | 计算引擎能力拆分代理维度。 | 焱火 | 带回 | 底层架构变更，持续推进 | | | | |\n| 8 | 政策量，运价量流量评估，指定政策量，运价量的压测。 | 焱火 | 9.30 | 摸底 | | | | |\n| 9 | 搜索的预案的梳理。 | 芊荀 | 8.20 | | | | | |\n| 10 | d2熟悉程度、形成文档沉淀 | 焱火 | 8.20 | | | | | |\n| 11 | 飞猪各行业引擎对数据的依赖，梳理方案 | 龙幽 | 8.20  | | | | | |\n| 12 |  | | | | | | | |\n\n\naction  机票故障场景定义规则调整  音素  海遇  8.11\n\n飞猪机票行业内部系统梳理\n\n技术、业务信息同步机制\n\n定位问题、恢复问题、自我保护机制\n\n外部不可控操作风险梳理 \n\n\n\n## ![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/4524/1691138489633-38cd5e59-08e9-4c19-b774-b46cc6117beb.png)\n## 七、影响产品线&影响面\n    - [ ] 是否影响可用性\n        * 可用性指标，可用性时长消耗\n    - [x] 业务影响：\n        * 影响的产品线，业务功能，功能受损程度（成功量/率下跌多少%），持续多少时间\n\n产品线：飞猪/机票/国内机票\n故障场景 履",
    "chunk_order_index": 3,
    "full_doc_id": "doc-c24a669d1e99f036feca92d1a6aa3a21"
  },
  "chunk-0dd50166fd9961617dd3e251f728b0ef": {
    "tokens": 1200,
    "content": "774-b46cc6117beb.png)\n## 七、影响产品线&影响面\n    - [ ] 是否影响可用性\n        * 可用性指标，可用性时长消耗\n    - [x] 业务影响：\n        * 影响的产品线，业务功能，功能受损程度（成功量/率下跌多少%），持续多少时间\n\n产品线：飞猪/机票/国内机票\n故障场景 履约[**【国内机票履约下单及预订成功量下跌】**](https://cofree.alibaba-inc.com/orm/config/emergency-scene/list/online?children=true&nodeId=46136&depth=1&scenarioTypes%5B0%5D=FAULT_RISK&scenarioTypes%5B1%5D=FAULT&includeRule=false&buId=1&__tenant__=alibabaGroup&refId=85f01cc8d1b78b5e)P2  总影响时间 15:48-18:10\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/80256373/1691129560990-54005152-1de4-4a04-802f-5171cca9189c.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/80256373/1691374841411-f30d0ad9-699c-44f0-9042-95f6c15d33d5.png)\n\n故障场景搜索[**【****搜索无结果或信息错误****】** ](https://cofree.alibaba-inc.com/orm/config/emergency-scene/list/online?children=true&nodeId=46136&depth=1&scenarioTypes%5B0%5D=FAULT_RISK&scenarioTypes%5B1%5D=FAULT&includeRule=false&buId=1&__tenant__=alibabaGroup)**P3**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/80256373/1691374920450-687a1977-a215-4f2e-b695-d5ea5fee1fc7.png)\n\n\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/80256373/1691374825303-abb8a4fd-6702-4fe2-afa6-f5d70dfc72f6.png)\n\n故障场景机票详情**【国内机票订单详情页打开异常】**P3 \n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/80256373/1691120760574-347b7d47-cd1a-4904-aaa2-50a9fc11d032.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/80256373/1691374950428-209b0816-c428-47c7-b6b6-ca7fecf096f7.png)\n\n产品线：飞猪/机票  \n故障场景4虚拟商品（保险等）**【****交通辅营生单成功率下跌****】** P3\n\n[保险收益影响](https://aliyuque.antfin.com/alitripqa/uzg882/tgu24dyg8fo02lry?singleDoc#)  收益同比影响减少23万，创单减少约35万  \n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/80256373/1691130814966-70e6157a-726b-426f-b473-3bebb9ccc43c.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/80256373/1691374972224-6042e343-3d62-4e70-963e-8e72175d51cc.png)\n\n产品线：飞猪/平台技术/交易\n故障场景机票【**国内机票交易下跌（包含创建、下单）**】 P2总影响时长 15:43-18:10 \n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/80256373/1691375217404-a50af259-f8aa-451b-9346-81fadebc28e8.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/80256373/1691375097519-3d706e1e-1839-407b-873a-a87e6b6164e8.png)\n\n故障场景可用性【[飞猪可用率交易下跌（包含创建、支付）影响三个业务线](https://tr.alibaba-inc.com/orm/config/emergency-scene/list/online?includeRule=false&typeCode=1&buId=1&refId=8096658d388911b7&__tenant__=alibabaGroup)】未到故障级别\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/80256373/1691131123904-0127404b-a8e8-4936-af04-ebf3e9ac2154.png)\n\n![](https://intranetproxy.alipay.com/skyl",
    "chunk_order_index": 4,
    "full_doc_id": "doc-c24a669d1e99f036feca92d1a6aa3a21"
  },
  "chunk-6e0934468611bfbe6102efc5249632b2": {
    "tokens": 426,
    "content": "buId=1&refId=8096658d388911b7&__tenant__=alibabaGroup)】未到故障级别\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/80256373/1691131123904-0127404b-a8e8-4936-af04-ebf3e9ac2154.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/80256373/1691378303368-6a3e54e2-04da-41cb-8c53-2e8ce00632a6.png)\n\n产品线飞猪/商旅/机票预订故障场景【机票搜索无结果或异常】P3\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/80256373/1691138710842-2fd983d3-4f0d-4e3f-ad2a-f3dadeed0221.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/80256373/1691375261754-8cdcb75c-f24b-4deb-84df-07747c8373e9.png)\n\n\n\n    - [x] 是否有客诉量： [@柔颂](undefined/rousong) 8.3搜索支付批量故障问题复盘\n        * 在线，热线，排队量   \n注：（口径为全渠道客诉量级）无法下单支付类目工单8月2日共计101单，8月3日上涨到263，增长160.4%\n    - [x] 是否产生资损：\n        * 理论资损金额，实际资损金额\n\n1.8月3日系统无法下单产生的体验赔付共计5单，金额合计400元",
    "chunk_order_index": 5,
    "full_doc_id": "doc-c24a669d1e99f036feca92d1a6aa3a21"
  },
  "chunk-2a1f21bd4438aadb4ca54978b2525a1b": {
    "tokens": 1200,
    "content": "## 一、故障简述\n故障简述：于21:32开始，飞猪国内机票_渲染订单成功量最近10分钟与基线同比下跌大于等于20%，成功量最近10分钟最小值大于等于50，已达到P4故障，故障原因初步判断导购链路异常，切换非供销链路后于21:49故障恢复\n\n## 二、故障过程回顾\n### 2.1【故障处理时间线】\n【故障引入】\n\n为验证缓存预加载系统容量时，逐步加大对链路的请求量。2023-07-26 21:30以前的操作没有发现异常现象，2023-07-26 21:32 收到监控报警，关键操作时间如下：\n2023-07-26 13:56:42 feynman 调度单机 5QPS, 集群60 qps；\n2023-07-26 17:15:13 feynman  调度单机 10QPS, 集群120 qps ；\n2023-07-26 20:51:22 feynman  调度单机7QPS, 集群84 qps ；\n2023-07-26 21:02:05 feynman  调度单机10QPS, 集群120 qps ；\n2023-07-26 21:31:08 feynman  调度单机15QPS, 集群180QPS -导致故障的操作\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/337235/1690776976870-8ecb65a8-a4f2-4b05-bf75-49b682f4126e.png)\n\n[MTAOBAO渠道请求量监控 ](https://x.alibaba-inc.com/custom/59/product/preview/generalComp/2374)\n\n\n\n【故障发现】\n2023-07-26 21:32，sunfire监控触发预警\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/80256373/1690423041424-fd1172d8-04f2-4a6c-a799-742282917964.png)\n\n【初因定位】\n2023-07-26 21:34，玄渡发现报警，操作开关恢复。\n【故障发生】\n2023-07-26 21:42，猪国内机票_渲染订单成功量最近10分钟与基线同比下跌大于等于20%，成功量最近10分钟最小值大于等于50，已达到P4故障\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/80256373/1690423483806-8b12eb08-5698-4421-ac1e-43636bccf64c.png)\n\n【恢复执行】2023-07-26 21:44 用户搜索量降低 成功量/率开始恢复\n                  2023-07-26 21:49 打开非供销报价和拼接降级 报价成功率完全恢复\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/337235/1690961029478-01936198-0a21-4dea-a90f-14c95ffb9cdb.png)\n\n            2023-07-26  22:04 非供销报价关闭\n\n            2023-07-26  22:20 拼接降级恢复\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/337235/1690961441605-a9e6f78e-24c3-42e7-89f6-497da6aabe4e.png)  \n\n\n【故障恢复】\n2023-07-26 21:49，成功率恢复正常水位\n\n### 2.2【时间线概览】\n![画板](https://intranetproxy.alipay.com/skylark/lark/0/2023/jpeg/7773/1688971427269-d3bc50df-aa87-4ac9-9d5c-bf10e0e07646.jpeg)\n\n\n\n## 三、故障原因\n### 3.1【背景说明】\n背景：\n\n机票缓存预加载业务，走Forge、Flysp、Atw2爬虫集群，写缓存；用户请求缓存命时直接使用缓存，预请求量预计是线上流量的一倍。通过逐步加大对下游请求量，逐渐加量验证缓存调度及链路资源、查定比时，导致正常用户搜索链路成功率下跌；\n\n### 3.2【原因分析】\n一句话原因：\n\n预加载量到单机15QPS，集群180QPS时，爬虫集群和正式集群生成全局唯一ID服务依赖的数据库压力大响应时间变长，导致搜索超时。\n\n根因分析：\n\n1）预加载请求是相对热门OD，报价数量多，需要为所有报价都需要生成唯一ID。导致全局唯一ID服务依赖的数据库行锁冲突加剧，数据库CPU陡增，响应变慢，最终导致搜索超时；\n\n2）虽然预加载、C用户搜索请求走独立集群，但是依赖的",
    "chunk_order_index": 0,
    "full_doc_id": "doc-4ecd114d40c1ae98534e901ca0823f5a"
  },
  "chunk-ba9e6ec153b7dc380675d4c96071c5da": {
    "tokens": 1200,
    "content": "局唯一ID服务依赖的数据库压力大响应时间变长，导致搜索超时。\n\n根因分析：\n\n1）预加载请求是相对热门OD，报价数量多，需要为所有报价都需要生成唯一ID。导致全局唯一ID服务依赖的数据库行锁冲突加剧，数据库CPU陡增，响应变慢，最终导致搜索超时；\n\n2）虽然预加载、C用户搜索请求走独立集群，但是依赖的数据库服务没有隔离。\n\n## 四、关注点分析\n_/* 填写说明：根据故障实际情况可增删关注点，并提供详细内容分析*/_\n\n### 4.1【系统质量】\n#### 4.1.1 需求&设计评估\n**〖关注点1〗****是否涉及产品、技术方案评估？此核心的问题是什么，如何改进？**\n\n- [ ] **是，涉及**\n    - [ ] 需求评估遗漏\n    - [ ] 产品设计缺陷\n    - [ ] 系统架构设计缺陷\n        - [ ] 容错性不足 \n        - [ ] 单点，无冗余\n        - [ ] 缺乏自我保护\n        - [ ] 缓存设计不当\n        - [x] 容量评估不足\n        - [ ] 非幂等设计\n        - [x] 强弱依赖不合理\n        - [ ] 其他：__________\n- [ ] 否，不涉及\n\n**〖问题总结〗**\n\n**〖改进点〗**_**需明确写明不同故障相关方的改进项（若有的话），下同。**_\n\n1、Flysp 去除Listing/OTA 报价ID对数据库的依赖  这周or下周\n\n#### 4.1.2 代码质量\n**〖关注点1〗是否代码自身存在漏洞或BUG、代码健壮性是否存在问题等?**\n\n**〖问题分析〗**\n\n**〖改进点〗**_**需明确写明不同故障相关方的改进项（若有的话），下同。**_\n\n1、\n\n\n\n**〖关注点2〗****是否经过CodeReview？CodeReview阶段是否发现问题？为何没发现？**\n\n+ **是否经过CR**\n    - [ ] 是\n    - [ ] 否\n    - [ ] 不涉及\n+ **是否设置合理的CR卡点**\n    - [ ] 是\n    - [ ] 否\n    - [ ] 不涉及\n+ **CodeReview阶段是否发现问题？为何没发现？后续如何发现？**\n    - [ ] 是\n    - [ ] 否\n    - [ ] 不涉及\n\n**〖问题分析〗******\n\n**〖改进点〗**_**需明确写明不同故障相关方的改进项（若有的话），下同。**_\n\n1、\n\n\n\n**〖关注点3〗****测试阶段**\n\n+ **测试内容：**涉及的测试提交单、测试用例等\n+ **测试人员：**\n+ **是否经过测试验证**\n    - [ ] 是，验证环境\n        - [ ] 预发环境\n        - [ ] 日常环境\n    - [ ] 是，测试方法\n        - [ ] 单元测试\n        - [ ] 功能回归测试\n        - [ ] 集成测试/链路测试\n        - [ ] 验收测试\n    - [ ] 否\n    - [ ] 不涉及\n+ **测试未发现原因是什么？后续如何改进？**\n    - [ ] 回归测试遗漏\n        - [ ] 手工回归测试用例遗漏\n        - [ ] 自动化未建设\n        - [ ] 自动化回归覆盖不足\n        - [ ] 其他：__________\n    - [ ] 新场景测试遗漏\n        - [ ] 功能测试用例遗漏，包括正常分支和异常分支\n        - [ ] 容灾兜底测试遗漏\n        - [ ] 客户端兼容性测试遗漏\n        - [ ] 埋点测试遗漏\n        - [ ] 性能测试遗漏，影响评估不足\n        - [ ] 安全测试遗漏\n    - [ ] 其他：__________\n\n**〖问题总结〗**\n\n**〖改进点〗**_**需明确写明不同故障相关方的改进项（若有的话），下同。**_\n\n1、\n\n#### 4.1.3 变更质量\n+ **是否涉及变更：**\n    - [x] 是\n    - [ ] 否\n+ **变更类型：**\n    - [ ] 代码发布\n    - [x] 配置变更\n    - [ ] 其他变更：____________\n    - [ ] 不涉及\n+ **变更平台是否接入ChangeFree：**\n    - [ ] 是，CF变更单链接：________\n\n_/*要这样的链接_ [https://aicf.alibaba-inc.com/aicf/change/detail/1725370372](https://aicf.alibaba-inc.com/aicf/change/detail/1725370372) */\n\n    - [x] 否\n+ **是否违反变更红线3.1**** **[链接](https://aliyuque.antfin.com/ngoc/fzg6dy/uar1k6)\n    - [ ] 是，违反哪条原则：\n    - [x] 否\n\n待定，未经过变更管理平台，并且没有在发布时间处理。\n\n**〖关注点1〗****",
    "chunk_order_index": 1,
    "full_doc_id": "doc-4ecd114d40c1ae98534e901ca0823f5a"
  },
  "chunk-4870e37796ff59c5ea07164800433948": {
    "tokens": 1200,
    "content": ".com/aicf/change/detail/1725370372) */\n\n    - [x] 否\n+ **是否违反变更红线3.1**** **[链接](https://aliyuque.antfin.com/ngoc/fzg6dy/uar1k6)\n    - [ ] 是，违反哪条原则：\n    - [x] 否\n\n待定，未经过变更管理平台，并且没有在发布时间处理。\n\n**〖关注点1〗****灰度阶段**\n\n+ **是否经过灰度：**\n    - [x] 是\n    - [ ] 否\n+ **观测了哪些监控**：_可以附链接_\n    - [ ] 黑屏、白屏\n    - [ ] GOC监控：\n    - [x] 系统大盘：\n        * flysp 监控系统大盘 [https://x.alibaba-inc.com/custom/59/product/preview/cms/1291](https://x.alibaba-inc.com/custom/59/product/preview/cms/1291) \n    - [ ] 其他：___________\n+ **是否灰度期间发现问题？**\n    - [x] 是\n        - [x] 是否灰度流量过大，导致故障\n        - [ ] 灰度发现但未有效或及时修复，导致故障\n        - [ ] 其他：___________\n    - [ ] 否，后续如何灰度发现？_____________\n+ **未灰度发现原因**\n    - [ ] 应用灰\n        - [ ] 灰度流量太小\n        - [ ] 灰度阶段无监控\n        - [ ] 灰度批次不合理\n        - [ ] 超长时间灰度才能发现\n    - [ ] 业务灰：策略不合理\n    - [x] 灰度无法发现\n    - [ ] 其他：_____________\n\n**〖问题总结〗**\n\n**〖改进点〗**_**需明确写明不同故障相关方的改进项（若有的话），下同。**_\n\n1、 新需求对链路冲击大，需要安排专门的压测时间。\n\n2、规范发布流程。\n\n**〖关注点2〗****上线阶段**\n\n+ **是否有确定的监控观测指标**\n    - [x] 是，监控指标及监控链接：\n\n缓存预加载量监控 [https://x.alibaba-inc.com/custom/59/product/preview/generalComp/2374](https://x.alibaba-inc.com/custom/59/product/preview/generalComp/2374)\n\nFlysp监控大盘 [https://x.alibaba-inc.com/custom/59/product/preview/cms/1291](https://x.alibaba-inc.com/custom/59/product/preview/cms/1291)\n\n    - [ ] 否\n+ **是否在窗口期进行发布变更**\n    - [ ] 是\n    - [x] 否，原因： \n\n系统容量验证时间需要持续很长，无法完全在发布窗口期完成。\n\n+ **变更是否影响上下游**\n    - [x] 是，是否有提前知会上下游评估及关注变更\n        - [x] 有提前知会 \n        - [ ] 没有提前知会\n    - [ ] 否\n\n**〖问题总结〗**\n\n**〖改进点〗**_**需明确写明不同故障相关方的改进项（若有的话），下同。**_\n\n1、对现有链路冲击比较大的变更，需要安排专门的压测\n\n### 4.2【处置能力】\n#### 4.2.1 故障发现&响应\n+ **是否监控发现**\n    - [ ] 故障触发方 监控发现\n    - [x] 故障受影响方 监控发现\n    - [ ] 否，原因为：（监控无效/监控缺失）\n+ **是否5分钟内响应**\n    - [x] 是\n    - [ ] 否，原因为：\n+ **是否存在应急协同问题**\n    - [x] 是\n        - [x] 应急流程不明确（无流程或者流程不清晰、应急相关角色&职责不明确，缺失一号位等)\n        - [ ] 应急执行不到位（有流程，但未按流程执行，通告发送不及时，响应不及时等）\n    - [ ] 否\n\n**〖问题总结〗**\n\n**〖改进点〗**_**需明确写明不同故障相关方的改进项（若有的话），下同。**_\n\n1、需要第一时间降级拼接业务降低系统压力\n\n2、开启非供销报价，提升报价有结果率\n\n#### 4.2.2 故障定位&恢复\n+ **主要恢复方式：**\n    - [ ] 代码发布/回滚\n    - [ ] 配置发布/回滚\n    - [ ] 数据订正\n    - [ ] 机器隔离/重启/扩容\n    - [ ] 配置限流\n    - [ ] 预案降级\n    - [ ] 自动恢复\n    - [x] 其他：流量链切换\n\n## 六、故障Action\n#### 快速降级和系统恢复\n    - 拼接降级 \n        * openOneWayCross\u0000 \n        * openRoundTripCross\u0000\n        * openMultiJourneyCross\u0000\n    - 导购预请求降级  待对时间\n    - 开启备用链",
    "chunk_order_index": 2,
    "full_doc_id": "doc-4ecd114d40c1ae98534e901ca0823f5a"
  },
  "chunk-fa2ea626e066421e931562762ea8708a": {
    "tokens": 887,
    "content": "流\n    - [ ] 预案降级\n    - [ ] 自动恢复\n    - [x] 其他：流量链切换\n\n## 六、故障Action\n#### 快速降级和系统恢复\n    - 拼接降级 \n        * openOneWayCross\u0000 \n        * openRoundTripCross\u0000\n        * openMultiJourneyCross\u0000\n    - 导购预请求降级  待对时间\n    - 开启备用链路 非供销报价\n\naction:常态化应急恢复预案   8.10   焱火\n\n#### 发布流程和规范\n      对链路冲击较大需求上线安排专门压测\n\n拉核心系统负责人/测试一起盯监控\n\nateye变更不允许晚上进行（dii等特殊变更除外）\n\naction：后续搜索实施常态化压测   芊荀\n\n#### 代码层面规范\n+ 清理 Listing/OTA 搜索对数据库的强依赖\n+ Agg 超时设置调整 shoppingAggTimeout\u0000\n\n保证部分运价源有结果，不因为一支链路慢 导致全部无结；\n\n旗舰店、API 报价依赖Atw2的结果，架构上有一定的风险\n\naction带回，搜索无结果兜底\n\n#### 事件同步机制\n\n\n+ 搜索下跌的故障，等级定义。\n+ 线上常态化压测。（供销拼接+搜索前端预加载） 导致恶化。\n+ 压测观察的指标和责任人明确出来。（单独弄个监控大盘出来，弄出来之前停止灰度）。\n    - 缓存监控大盘 [https://x.alibaba-inc.com/custom/59/product/preview/cms/1721](https://x.alibaba-inc.com/custom/59/product/preview/cms/1721)\n+ action：缺少信息同步。搜索源信息和及时性。(同步到 **交通核心链路safe稳定性预警**)（群待更新）\n    - 发生故障第一时间同步；\n    - 处理过程每隔15 分钟同步一次；\n\naction带回，搜索无结果兜底方案，Agg 超时设置调整 shoppingAggTimeout\u0000\naction:常态化应急恢复预案   8.10   焱火\naction：缺少信息同步。搜索源信息和及时性。(同步到 **交通核心链路safe稳定性预警**)（群待更新）\naction：后续搜索实施常态化压测   芊荀\n\n| **序号** | *******Action标题** | *******负责人** | *******计划完成时间** |\n| --- | --- | --- | --- |\n| 1 | 短期：梳理Flysp Listing/OTA 对数据库依赖，去除唯一ID服务对数据库依赖 | 玄渡 | 已发布、待验证 |\n| 2 | 短期：常态化应急恢复预案 | 玄渡 |  8.10 |\n| 3 | 短期： |  |  |\n| 4 | 长期：后续搜索实施常态化压测 | 芊荀 |  |\n| 5 | 长期：搜索无结果兜底方案 | 玄渡 |  |\n\n\n## 七、影响产品线&影响面\n    - [ ] 是否影响可用性\n        * 可用性指标，可用性时长消耗\n    - [x] 业务影响：\n        * 影响的产品线，业务功能，功能受损程度（成功量/率下跌多少%），持续多少时间\n    - [ ] 是否有客诉量：\n        * 在线，热线，排队量\n\n__\n\n链接：\n\n截图：飞机国内机票搜索成功量最低低至98，影响时间21:32-21:49持续17分钟\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/80256373/1690877162764-a30af8be-a542-4b78-b576-077f794afc5a.png)",
    "chunk_order_index": 3,
    "full_doc_id": "doc-4ecd114d40c1ae98534e901ca0823f5a"
  },
  "chunk-b5cfa6684178ebd0d7e0144847885dff": {
    "tokens": 1200,
    "content": "## 一、故障简述\n2023-07-20 20:35:00~2023-07-21 09:00期间，由于修改机场航站楼信息缓存前缀，导致飞猪里程无法兑换接送机，期间有35个用户来电，资损300元，在21号09:00缓存切换到实时数据，故障恢复。\n\n## 二、故障过程回顾\n### 2.1【故障处理时间线】\n【故障引入】\n\n2023-07-20 20:35:00  鸿德修复租车缓存取不到问题，把两个系统的key前缀设置为一样。\n【故障发现】\n2023-07-20 21:20:00 解语无法下里程订单并反馈到相关人\n【故障响应】\n2023-07-20 21:44:00 白哉群里找到侠乐，开始进行问题排查\n【初因定位】\n2023-07-20 23:43:00 幕凡发现缓存数据错误，进行了单条数据修复\n【故障发生】\n\n2023-07-21  08:24:00 客服投诉到20\n\n 2023-07-21  08:39:00 解语表示还不可用\n\n【恢复执行】【故障恢复】\n\n2023-07-21  09:00:00 幕凡操作切到实时接口调用\n\n【根因确认】\n\n2023-07-21  10:10:00  幕凡和鸿德排查到是缓存数据bean无法转化导致\n\n### 2.2【时间线概览】\n![画板](https://intranetproxy.alipay.com/skylark/lark/0/2023/jpeg/7773/1688971427269-d3bc50df-aa87-4ac9-9d5c-bf10e0e07646.jpeg)\n\n\n\n## 三、故障原因\n### 3.1【背景说明】\n7月20日 13:53租车运营同学在钉钉群里反馈淘宝app主搜的租车长颈鹿卡片点击搜索跳转至租车首页，并且会自动带入非用户搜索的城市，然后页面自动跳转。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/2742/1690182706639-2ab83982-21d0-4acd-b184-cb8adcab2f1b.png)\n\n经前后端开发排查，确实存在问题。\n\n有2个问题：\n\n1、为什么用户输入的“上海”没有自动带入到租车首页，而是默填的其他poi？\n\n2、为什么页面会使用页面默填的城市+poi发起自动搜索？\n\n\n\n问题2是因为前端有一个自动跳转逻辑：当判断当前城市+poi是非空时，就会自动发起搜索去下一页面。\n\n那么以上2个问题就变成一个问题，为什么会默填上非用户填写的城市？\n\n\n\n此时必须介绍一下手淘searchbar的前后端交互流程：\n\n1、用户在手淘主搜输入“上海租车”时，手淘searchbar前端请求searchbar推荐接口，带上用户搜索的“上海租车”，searchbar推荐接口：com.alitrip.ftaxi.suggest.TripHomePageSuggestService#searchBarSuggest。\n\n该接口会使用当前请求的鹰眼trace拼上前缀，存入缓存，并将trace作为唯一请求标记\u0000contextId\u0000返回给前端\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/2742/1690186709142-e2b645b1-fae2-4ccb-aad2-4021dcbd4dc0.png)\n\n2、用户在searchbar页面点击搜索、城市、poi时，前端都会离开卡片，打开飞猪租车首页。飞猪租车首页会请求首页推荐接口mtop.trip.ftaxi.sug.home接口，并将上一个接口返回的唯一请求标记\u0000contextId传给推荐接口。该接口会拿这个唯一标识查缓存，获取上一个接口的结果，这样做是为了保证两个推荐接口返回的数据一致性。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/2742/1690187515902-08c19117-22cc-482b-941d-56d481ad457d.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/2742/1690187497956-7c426e8a-0d6a-4750-8b04-babc06972547.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/2742/1690187608705-27fd0667-fa81-4e56-a8f5-3e7d3511bd96.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/2742/1690187590462-e032331e-71d0-4132-95da-22aad2264b24.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/2742/1690187633679-e03601f7-6e53-47",
    "chunk_order_index": 0,
    "full_doc_id": "doc-d0cd34e427f062b208dc9160cea80fdf"
  },
  "chunk-36eaa7d7f36b3a72f96d1ade9d5f231d": {
    "tokens": 1200,
    "content": "3511bd96.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/2742/1690187590462-e032331e-71d0-4132-95da-22aad2264b24.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/2742/1690187633679-e03601f7-6e53-47b7-97d1-4d344f9db284.png)\n\n3、今年6月份做了一个接口迁移的项目：将：mtop.trip.ftaxi.sug.home这个mtop底层服务从ftaxi应用的com.alitrip.ftaxi.suggest.TripSuggestService#homeSuggest，在该服务里做切流，走tfsug提供的\n\ncom.alitrip.tfsug.rentcar.home.impl.DomesticRentcarHomeSuggestServiceImpl#homeSuggest服务。\n\n4、但是：由于tfsug取缓存时加了前缀“tfsug”导致获取不到，因此接口重新做了默认数据的推荐，就出现上面运营反馈的问题。\n\n5、为了修复上面问题，开发将tfsug与ftaxi的tair前缀改成一致的，不在tfsug加“tfsug_”前缀\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/2742/1690188922698-3c670309-ac92-4c07-88be-d983dcd0406e.png)\n\n开发修改完开关，自测了手淘searchbar场景、用车首页场景，没有问题，没有自测到里程兑换首页场景。\n\n\n\n\n\n### 3.2【原因分析】\n#### 一句话原因\n读取tair缓存反序列化成对象时失败，导致接送机里程兑换处理异常用户无法兑换接送机。\n\n#### 根因分析\n背景：ftaxi和tfsug两个系统使用了相同的tair key（suggest系统迁移，所以两个系统处理代码逻辑是一样的但包路径不一样）。\n\n原因：ftaxi写入了机场的基础数据，数据是通过Hessian\u0000序列化的。里程兑换业务有一个逻辑是调用tfsug里根据机场的三字码反查出机场对象进而补充经纬度数据。新系统（tfsug）读取缓存后反序列化对象转换的时候异常，导致经纬度数据未能补全。前端会判断数据不全来提示用户无法兑换。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/57573/1690181781526-9810408b-097e-4177-9a90-985d8d63642b.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/57573/1690181838848-8e277b5e-9395-4399-9e88-ed204b3d1e9d.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/57573/1690183577104-7cc72a74-e7d8-4e63-bb3f-df41839a7d6a.png)\n\naction：\n\n## 四、关注点分析\n### 4.1【系统质量】\n#### 4.1.1 需求&设计评估\n**〖关注点1〗****是否涉及产品、技术方案评估？此核心的问题是什么，如何改进？**\n\n- [ ] **是，涉及**\n    - [ ] 需求评估遗漏\n    - [ ] 产品设计缺陷\n    - [ ] 系统架构设计缺陷\n        - [ ] 容错性不足 \n        - [ ] 单点，无冗余\n        - [ ] 缺乏自我保护\n        - [x] 缓存设计不当\n        - [ ] 容量评估不足\n        - [ ] 非幂等设计\n        - [ ] 强弱依赖不合理\n        - [ ] 其他：__________\n- [ ] 否，不涉及\n\n\n\n#### 4.1.2 代码质量\n**〖关注点1〗是否代码自身存在漏洞或BUG、代码健壮性是否存在问题等?**\n\n**〖问题分析〗**\n\n**1、根据机场三字码，反查机场经纬度的服务是一个核心依赖，如果失败会导致里程兑换、交叉推荐等场景异常。因此需要埋点重点监控此服务成功率。之前有失败后发送消息到钉钉群代码，但是未能生效需要排查原因解决。**\n\n**〖改进点〗**_****_\n\n1、添加对根据机场三字码查经纬度服务端监控报警 \n\n2、解决钉钉预警失败问题\n\n\n\n**〖关注点3〗****测试阶段**\n\n+ **测试内容：**涉及的测试提交单、测试用例等\n+ **测试人员：**\n+ **是否经过测试验证**\n    - [x] 是，验证环境\n        - [x] 预发环境\n        - [ ] 日常环境\n    - [ ] 是，测试方法\n        - [ ] 单元测试\n        - [ ] 功能回归测试\n        - [ ] 集成测试/链路测试\n        - [x]",
    "chunk_order_index": 1,
    "full_doc_id": "doc-d0cd34e427f062b208dc9160cea80fdf"
  },
  "chunk-98b2560f54b49235901bc93da4bb91b4": {
    "tokens": 1200,
    "content": "测试内容：**涉及的测试提交单、测试用例等\n+ **测试人员：**\n+ **是否经过测试验证**\n    - [x] 是，验证环境\n        - [x] 预发环境\n        - [ ] 日常环境\n    - [ ] 是，测试方法\n        - [ ] 单元测试\n        - [ ] 功能回归测试\n        - [ ] 集成测试/链路测试\n        - [x] 验收测试\n    - [ ] 否\n    - [ ] 不涉及\n+ **测试未发现原因是什么？后续如何改进？**\n    - [ ] 回归测试遗漏\n        - [x] 手工回归测试用例遗漏\n        - [ ] 自动化未建设\n        - [ ] 自动化回归覆盖不足\n        - [ ] 其他：__________\n    - [ ] 新场景测试遗漏\n        - [ ] 功能测试用例遗漏，包括正常分支和异常分支\n        - [ ] 容灾兜底测试遗漏\n        - [ ] 客户端兼容性测试遗漏\n        - [ ] 埋点测试遗漏\n        - [ ] 性能测试遗漏，影响评估不足\n        - [ ] 安全测试遗漏\n    - [ ] 其他：__________\n\n**〖问题总结〗**\n\n**〖改进点〗**_****_\n\n1、开发自测时很难覆盖里程兑换场景，测试数据难构造，且机票有效期必须是3日内。\n\naction:研发线下问题修复的场景，同步测试评估规范文档（变更类）   wanfeng\n\n### 4.2【处置能力】\n#### 4.2.1 故障发现&响应\n+ **是否监控发现**\n    - [ ] 故障触发方 未监控发现\n    - [ ] 故障受影响方 监控发现\n    - [x] 否，原因为：（监控无效/监控缺失）\n+ **是否5分钟内响应**\n    - [ ] 是\n    - [x] 否，原因为：里程场景流量小，并且缺乏监控报警\n+ **是否存在应急协同问题**\n    - [ ] 是\n        - [ ] 应急流程不明确（无流程或者流程不清晰、应急相关角色&职责不明确，缺失一号位等)\n        - [x] 应急执行不到位（有流程，但未按流程执行，通告发送不及时，响应不及时等）\n    - [ ] 否\n\n**〖问题总结〗**\n\n**〖改进点〗**_**需明确写明不同故障相关方的改进项（若有的话），下同。**_\n\n这部分主要是客服同学在连续接到客诉并没有上升，到第二天已经累积到故障了才反馈\n\nactiom：客服人工问题上报机制（提前）\n\n#### 4.2.2 故障定位&恢复\n+ **主要恢复方式：**\n    - [ ] 代码发布/回滚\n    - [x] 配置发布/回滚\n    - [ ] 数据订正\n    - [ ] 机器隔离/重启/扩容\n    - [ ] 配置限流\n    - [ ] 预案降级\n    - [ ] 自动恢复\n    - [ ] 其他：\n+ **是否10分钟内恢复**_/* P1P2故障填写*/_\n    - [ ] 是\n    - [x] 否，原因：__________\n\n\n\n**〖关注点2〗业务自身是否具备容灾逃逸能力？后续如何改进？**_/* 如涉及基础设施引发的故障，可填写*/_\n\n- [x] 具备容灾能力\n    - [ ] 因未演练不敢执行\n    - [ ] 因有损评估决策不执行\n    - [ ] 无决策或者决策不当，未执行\n- [ ] 不具备容灾能力\n\n## 五、故障总结反思\n_/* P1故障必填，主要用于总结分享和提炼分析*/_\n\n**【做得好的】**\n\n1、拿到问题后，响应比较及时\n\n**【经验教训】**\n\n举一反三，学习，避免踩坑\n\n1、避免惯性问题处理思路，里程之前经常出现个例case问题就当做个例去处理了，应该按照正常的思路流程去处理，评估影响看变更快速恢复\n\n2、里程业务量虽然不大，但是不能掉以轻心，需要把每个业务场景涉及的监控/告警补充全\n\n3、操作完开关后，只是线上测试验证了searchbar是没问题的。ftaxi里当时没有异常报警。但是没有去看tfsug应用里的异常。导致没能及时发现问题。今后开关操作也要及时查看是否有异常，避免影响其他业务而不知晓。\n\n4、tfsug是个新应用，没有配置异常报警，导致应用出现了异常没能预警出来。应用异常报警一定要加上。\n\n5、客服同学接到线上类似工单反馈，超过3个的时候要升级工单。转交给对应技术同学排查是否是共性问题。尤其是周二周四发布日出现类似工单要及时升级，避免因为链路过",
    "chunk_order_index": 2,
    "full_doc_id": "doc-d0cd34e427f062b208dc9160cea80fdf"
  },
  "chunk-3aae70336e868b264aa24fabf3f90c0d": {
    "tokens": 472,
    "content": "避免影响其他业务而不知晓。\n\n4、tfsug是个新应用，没有配置异常报警，导致应用出现了异常没能预警出来。应用异常报警一定要加上。\n\n5、客服同学接到线上类似工单反馈，超过3个的时候要升级工单。转交给对应技术同学排查是否是共性问题。尤其是周二周四发布日出现类似工单要及时升级，避免因为链路过长导致反馈到技术时已触发故障。\n\n6、技术支持同学处理工单时，如果发现批量工单要尽早发给技术排查。避免技术同学当做不紧急工单处理，酿成线上故障。\n\n7、业务逻辑迁移彻底避免数据覆盖\n\n## 六、故障Action\n| *******Action标题** | *******负责人** | *******计划完成时间** | **Action描述** |\n| --- | --- | --- | --- |\n| searchbar服务迁移至tfsug | 书植 | 7.27 | ftaxi里添加切流开关，切流至tfsug推荐 |\n| 核心交叉场景预警配置 | 慕凡 | 8.1 | 里程兑换、合并支付、各种searchbar导流监控预警配置 |\n| 核心应用异常清理 | 慕凡/鸿德/书植 | 8.1 | ftaxi/tfsug/tfo/tfrcs |\n| 研发线下问题修复的场景，同步测试评估规范文档 | 婉风 | 7.31 |  |\n| 客服上报流程机制 | 悦瑶/海遇 | 7.31 |  |\n| 里程兑换业务链路打通 | 夏慕 | 8.30 | 非主链路的测试场景支持，由青铜剑提供：里程兑换、淘宝searchbar预发链路，微信（待定）、租客宝（待定） |\n\n\n## 七、影响产品线&影响面\n+ 用户进线咨询\n        * 已去重：35个用户来电，资损300元\n\n##",
    "chunk_order_index": 3,
    "full_doc_id": "doc-d0cd34e427f062b208dc9160cea80fdf"
  },
  "chunk-ef6159a8145132d3c2c7b027aeb2b02b": {
    "tokens": 1200,
    "content": "## 一、故障简述\n故障简述： 于11:56开始，酒店_提交订单_排错成功率最近10分钟最大值小于等于80%，失败量最近10分钟最小值大于等于10，已达到P4故障。故障原因为依赖的机器fullgc，经过机器的下线、扩容和重启，数据重新订正后，监控于12:15恢复  \n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/10122/1689318361226-fc23520b-aad4-46a0-89c8-c095095fba76.png)\n\n## 二、故障过程回顾\n### 2.1【故障处理时间线】\n故障时间线：\n\n【故障注入】：2023-07-14 11:01，商品开发 进行rp数据订正，共订正9条rateplan表数据，涉及hotel_ic及hotel_supplier_ic两个数据库\n\n【故障发现】【业务响应】：\n\n2023-07-14 11:11，商品告警B群各应用出现大量超时以及线程池满的告警，玉铮开始介入排查\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/10122/1689319336491-0d19ec4f-177a-4ecd-82a1-1264128ba56c.png)\n\n2023-07-14 11:20，钉钉群【大住宿稳定性群】中出现 交易-提交订单-排错成功率 风险预警；\n\n【恢复执行1】：\n\n2023-07-14 11:44  故障定位前：尝试对hic核心分组进行扩容、下线、重启操作维持下单顺畅率\n\n 扩容分两批次，共80台，分别于11:55、12:13扩容完成\n\n【故障发生】：2023-07-14 11:56，酒店_提交订单_排错成功率最近10分钟最大值小于等于80%，失败量最近10分钟最小值大于等于10，触达故障定义\n【故障定位】：\n\n2023-07-14 12:05 定位到原因是 RatePlanDO json序列化异常导致的死循环引起；\n\n【恢复执行2】：\n\n2023-07-14 12:10  故障定位后：开始执行订正数据恢复操作\n\n2023-07-14 12:11  数据订正完成\n\n【故障恢复】：\n\n2023-07-14 12:15 酒店订单和渲染成功率恢复，民宿有波动 ；于12:28，民宿详情页完全恢复\n\n### 2.2【时间线概览】\n![画板](https://intranetproxy.alipay.com/skylark/lark/0/2023/jpeg/80256373/1689649119850-c527de77-6c70-46d1-af6c-2312b07d7c2c.jpeg)\n\n\n\n## 三、故障原因\n### 3.1【背景说明】\n背景：\n\n服务调用链如下：\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/233807/1689334311817-1bf33e04-853c-4b5f-9a3e-9eff7a67f8e4.png)\n\n交易链路调用的是hic核心分组服务，但是因为hic机器CMC GC耗时特别长，导致hic服务基本上不可用，上游服务调用出现大量超时：\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/233807/1689334462325-a2dd7fdf-c37c-4f9d-9560-de05431cdd3c.png)\n\n从监控中可以看到，hic CMC GC耗时**一直持续在50s-1m**之间；\n\n### 3.2【原因分析】\n一句话原因：\n\nfastjson序列化引发死循环，导致hic机器Fullgc(CMC GC)耗时居高不下，最终导致hic服务不可用；\n\n根因分析：\n\n7月14号上午发现hic有NPE，通过排查，发现是RatePlan查询时，extend(扩展信息字段)有问题，导致解析extend中的内容时，出现NPE，经过统计有问题的数据一共9条；11点左右的时候，对有问题的数据做订正，数据订正SQL执行完后，11点11分时商品告警群出现大量HSF线程池满告警，同时上游反馈交易链路服务时间查询出现大量超时和HSF线程池满异常，经过排查发现是因为hic机器CMC GC耗时非常长，导致服务不可用，所有HSF请求Block住了；\n\nDump内存分析，发现存在内存泄漏：\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/233807/1689579769900-c02e9be6-9a1e-4df5-a846-8ccec8a40c77.png)\n\n对应线程ID：HSFBizProcessor-DEFAULT-8-thread-42，内存泄漏：2.2个G，继续分析线程堆栈，发现该线程是存在大量的**com",
    "chunk_order_index": 0,
    "full_doc_id": "doc-fe1743f5bc7e335f601760848fbb91d7"
  },
  "chunk-61d90351a195f804189b247b8cdd4ada": {
    "tokens": 1200,
    "content": "https://intranetproxy.alipay.com/skylark/lark/0/2023/png/233807/1689579769900-c02e9be6-9a1e-4df5-a846-8ccec8a40c77.png)\n\n对应线程ID：HSFBizProcessor-DEFAULT-8-thread-42，内存泄漏：2.2个G，继续分析线程堆栈，发现该线程是存在大量的**com.alibaba.fastjson.JSON.toJSON(Ljava/lang/Object;Lcom/alibaba/fastjson/serializer/SerializeConfig;)Ljava/lang/Object; (JSON.java:1117)**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/233807/1689579926538-538d689d-4424-46e5-9dbe-c6a3cf8d25df.png)\n\n初步判断是因为JSON转换导致的；Dump堆栈信息:[https://grace-parser.alibaba-inc.com/heapDump?file=TPS-1689306685933-33.8.99.178-1689306685914-jmap.log-xiao.xql-35258251.bin](https://grace-parser.alibaba-inc.com/heapDump?file=TPS-1689306685933-33.8.99.178-1689306685914-jmap.log-xiao.xql-35258251.bin)\n\n**为什么没有立刻回滚订正SQL？**\n\n当天没有任何发布，也没有做任何开关发布，没有联想到是因为数据订正导致的；其次，订正的卖家是一个小的渠道卖家，成交不多，订正的数据量较小：9个rp，所以没有及时反馈，排查定位的方向有偏差；\n\n\n\n**为什么没有及时定位出具体代码位置？**\n\ndump出堆栈、线程栈信息后，已经断定是因为GC问题导致的，通过查HSF线程，因为是线程池，所以确定不了具体是哪个接口；其次，从堆栈中看到的都是\n\n**com.alibaba.fastjson.JSON.toJSON(Ljava/lang/Object;Lcom/alibaba/fastjson/serializer/SerializeConfig;)Ljava/lang/Object; (JSON.java:1117)**，追踪对象引用链，也没有找到具体和业务相关的Java Class，这个过程耗时比较长，后来在线程栈最后面才发现是RatePlanNXService接口引起的\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/233807/1689580688795-befa7d56-5fdc-43d1-b0e4-294147866d2b.png)\n\n**为什么一个toJSON会导致机器完全不可用呢？**\n\n因为数据不正确，RatePlanNXService查询RP时，会解析RP中的extend字段(JSON格式的)，extend字段JSON格式不正确，导致解析时throw Exception，代码如下：\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/233807/1689580851958-df7dad80-733c-4f02-8336-0f8cb2905073.png)\n\n在log.error中，会将入参RatePlan对象打印出来(正是因为这里引起的故障)，RatePlanPO对象是面向数据库层持久化对象，对象定义如下：\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/233807/1689581340077-277ff16b-4669-4184-982f-f6a93987b0cd.png)\n\n在RatePlanPO中有一个属性：\n\n```java\nLog log = LogFactory.getLog(RatePlanPO.class);\n```\n\n而且RatePlanPO对象上加了lombok的Data注解，这样就会导致在做JSON转换(序列化反序列化)时，将log当作是RatePlanPO的一个属性；fastjson的toJSON在做序列化的时候会判断当前属性是否是Java对象，如果是Java对象(非基础数据类型、Map、集合、JSON、枚举)，则会递归对该属性执行序列化操作(_**这是fastjson的bug，高版本已修复**_)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/233807/1689581313340-2cc32048-c399-435b-9d4b-17b5572384c2.png)\n\nLogger循环依赖嵌套：\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/233807/1689581819985-4727c222-0965-44f7-9f19-46ae8b17d249.png)\n\n因此在toJSON序列化过程中，会陷入死循环：不断的创建toJSON执行序列化，最终导致内存泄漏；\n\n**为什么这么写代码？**\n\n```java\nLog log = LogFactory.getLog(RatePlanPO.class);\n```\n\n\u0000这行代码已经是13年的了，以前RatePlanPO是通过get、set方法访问和设置属性的，但是后来被改为lombok的Data注解；\n\n## 四、关注点分析\n_**引入阶段：**_\n\naction1：商品数据变更相关规范细化     负责人：枭龙   \n\n_1、增加灰度操作后验证环节    _\n\n_2、数据订正避开业务高峰_\n\n_action2：_问题数据修",
    "chunk_order_index": 1,
    "full_doc_id": "doc-fe1743f5bc7e335f601760848fbb91d7"
  },
  "chunk-cac47ca5e80f0f5447924b7e5482e99d": {
    "tokens": 1200,
    "content": "是13年的了，以前RatePlanPO是通过get、set方法访问和设置属性的，但是后来被改为lombok的Data注解；\n\n## 四、关注点分析\n_**引入阶段：**_\n\naction1：商品数据变更相关规范细化     负责人：枭龙   \n\n_1、增加灰度操作后验证环节    _\n\n_2、数据订正避开业务高峰_\n\n_action2：_问题数据修复：         负责人：维汉\n\n_1、问题数据通过程序方式修复   _\n\n_**发生阶段：**_\n\n【关注点1】更快恢复\n故障引发时间点变更及时同步包含数据订正等，评估无影响，及时回滚（待讨论如何落地）\n\n_ action（带回分享）： 数据变更审批流程owner，问题发生时，相关时间段变更评估意识  ，__新人先不要做owner_\n\n_action1： 后续待聊，db变更单同步safe可查 --龙幽_\n\n_**事后改进：**_\n\n【关注点1】_规避再次出现fastjson序列化异常问题_\n\naction1：问题代码修复      负责人：_玉铮_\n\n_1、toJSON死循环问题代码&同类问题修复_\n\n_2、fastJson升包   促升低版本 --馬达_\n\n_3、形成代码规约，禁止此类写法  （内部约束（CR等））_\n\n_action2：扩容规范，出现问题优先降低影响面，形成应急规范手册（内部培训，演练实操）主要沉淀商品域重点知识沉淀_\n\n_**变更：**_\n\n### 4.1【系统质量】\n#### 4.1.3 变更质量   涉及\n+ **是否涉及变更：**\n    - [x] 是\n    - [ ] 否\n+ **变更类型：**数据订正\n\n### 4.2【处置能力】\n#### 4.2.1 故障发现&响应\n+ **是否监控发现**\n    - [ ] 故障触发方 监控发现\n    - [x] 故障受影响方 监控发现\n    - [ ] 否，原因为：（监控无效/监控缺失）\n+ **是否5分钟内响应**\n    - [x] 是\n    - [ ] 否，原因为：\n+ **是否存在应急协同问题**\n    - [ ] 是\n        - [ ] 应急流程不明确（无流程或者流程不清晰、应急相关角色&职责不明确，缺失一号位等)\n        - [ ] 应急执行不到位（有流程，但未按流程执行，通告发送不及时，响应不及时等）\n    - [x] 否\n\n#### 4.2.2 故障定位&恢复\n+ **主要恢复方式：**\n    - [ ] 代码发布/回滚\n    - [ ] 配置发布/回滚\n    - [x] 数据订正\n    - [ ] 机器隔离/重启/扩容\n    - [ ] 配置限流\n    - [ ] 预案降级\n    - [ ] 自动恢复\n    - [ ] 其他：\n\n## 六、故障Action\n| **序号** | *******Action标题** | *******负责人** | *******计划完成时间** |\n| --- | --- | --- | --- |\n| 1 | 问题数据修复：问题数据通过程序方式修复 | 维汉 | [@维汉](undefined/cky392418)辛苦线下对完后，补充完成时间 |\n| 2 | 问题代码修复：1、toJSON死循环问题代码&同类问题修复3、形成代码规约，禁止此类写法_（内部约束（CR等））_ | 玉铮 |  |\n| 3 | 商品数据变更相关规范细化：1、增加灰度操作后验证环节2、数据订正避开业务高峰 | 枭龙 |  |\n| 4 | _fastJson升包   促升低版本 _ | _馬达_ |  |\n| 5 |  |  |  |\n\n\n_action1： 后续待聊，db变更单同步safe可查 --龙幽_\n\n_带回分享：_\n\n_action（带回分享）： 数据变更审批流程owner，问题发生时，相关时间段变更评估意识  ，__新人先不要做owner_\n\n_action2：扩容规范，出现问题优先降低影响面，形成应急规范手册（内部培训，演练实操）主要沉淀商品域重点知识沉淀_\n\n__\n\n## 七、影响产品线&影响面\n    - [ ] 是否影响可用性\n        * 可用性指标，可用性时长消耗\n    - [x] 业务影响：\n        * 影响的产品线，业务功能，功能受损程度（成功量/率下跌多少%），持续多少时间\n    - [ ] 是否有客诉量：\n        * 在线，热线，排队量\n    - [ ] 是否有社会舆情：\n        * 舆情ESU等级/未到E等级，舆情关键词，总声量，负声量\n    - [ ] 是否产生资损：\n        * 理论资损金额，实际资损金额\n\n_/* 可附",
    "chunk_order_index": 2,
    "full_doc_id": "doc-fe1743f5bc7e335f601760848fbb91d7"
  },
  "chunk-84debe2034c5f1324a9a31f7f2567306": {
    "tokens": 192,
    "content": "受损程度（成功量/率下跌多少%），持续多少时间\n    - [ ] 是否有客诉量：\n        * 在线，热线，排队量\n    - [ ] 是否有社会舆情：\n        * 舆情ESU等级/未到E等级，舆情关键词，总声量，负声量\n    - [ ] 是否产生资损：\n        * 理论资损金额，实际资损金额\n\n_/* 可附相关故障等级定义的链接和截图]*/_\n\n链接：\n\n截图：\n\n酒店提交订单11:11-12:15持续64分钟，成功率最低58%\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/80256373/1689565395144-a86a6d8c-818d-49a7-9ce3-373618e307ff.png)",
    "chunk_order_index": 3,
    "full_doc_id": "doc-fe1743f5bc7e335f601760848fbb91d7"
  },
  "chunk-a1676402d41895987ff82fb3c416b8fc": {
    "tokens": 1200,
    "content": "## 一、故障概述（含影响产品线及影响面）\n**故障概述：**\n\n2023-07-06 17:24开始，飞猪供销票号回填整体监控异常，成功量最近10分钟与基线同比下跌大于30%，已达到P4故障， 故障原因确认为删除tt中的topic导致详情查询的日志记录异常，导致商家api详情接口异常，通过紧急发布后（删除写tt）2023-07-06 17:45 监控自动冲高恢复。\n\n\n**影响面：**\n\n    - 是否影响可用性**：**是**；**\n    - **业务影响：**\n        * 导致代理商无法查询订单详情，可能影响回填票号。（因每个代理商回填票号的方式不统一,无法确认是否会影响票回填）\n    - 是否有客诉量（在线，热线，排队量）：否\n    - 是否有社会舆情：否\n    - 是否产生资损：否\n\n## 二、故障过程回顾【故障处理时间线】\n\n\n### 【故障处理时间线】\n整体故障时间线。需要着重强调【故障注入】【故障发生】【故障发现】【业务响应】【故障定位】【恢复执行】【故障恢复】时间点。\n\n【故障注入】2023-07-06 17:19 删除TT topic消息导致api往tt写入数据异常。监控ateye未发现异常情况。![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/101856398/1688648837174-904ff900-31e1-4af7-b53d-bd6f8da05821.png)\n\n【故障发现】2023-07-06 17:27 触发GOC风险预警\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/39701/1688710363004-a06d1d73-e094-4809-bc0e-e479208ed5a9.png)\n\n【故障定位】2023-07-06 17:31 定位是tt top被删除导致\n【业务响应】2023-07-06 17:34 机票行业平台楚伊反馈石页排查。\n\n【故障发生】2023-07-06 17:37 飞猪供销票号回填成功量最近10分钟与基线同比下跌大于30%，达到P4故障\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/39701/1689043762352-9a489555-c46b-4130-b0cd-d3b471478e43.png)\n\n【恢复执行】2023-07-06 17:31-2023-07-06 17:34  尝试恢复tt topic解决。\n\n### ![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/101856398/1688649022553-9eec0ade-6c34-428f-acae-e232c481bfb6.png)\n监控falog发现,添加了topic后并未恢复。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/101856398/1688649406426-93c60489-6047-4774-a5a9-45544779b273.png)\n\n#### 2023-07-06 17:38-2023-07-06 17:46\n去除TT写日志记录。![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/101856398/1688649199646-93f220cb-6626-4a2c-a411-d4d22bb5a8dd.png)\n\n【故障恢复】2023-07-06 17:46 执行发布并发布完毕后恢复\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/101856398/1688649496102-cd04ac99-f983-407e-9dc6-21fb21e67783.png)\n\n\n\n## \n## 三、故障影响面\n#### 影响及资损情况\n##### 影响：\n导致代理商无法查询订单详情，影响回填票号。（因每个代理商回填票号的方式不统一,无法确认是否会影响票回填）\n\n##### 资损情况：\n在17-18点在这期间未产生兜底订单。\n\n通过Ateye查询16-18点之间产生的兜底订单:5419960746399并确认该兜底单与本次发布无关联。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/101856398/1688643214355-bd0221d0-3840-47dd-863f-c77ac865e084.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/101856398/1688643144105-ba7370e8-81dd-4f30-a928-72f6e8e8cf8c.png)\n\n并且通过追款信息佐证了兜底划扣情况\n\n![](https://intranetproxy.alipay.com/skylark/lark/",
    "chunk_order_index": 0,
    "full_doc_id": "doc-a5306e9c59db40e34c8f841593c8cee4"
  },
  "chunk-4f7f740daab3c3d66ad89370f85937d8": {
    "tokens": 1200,
    "content": "863f-c77ac865e084.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/101856398/1688643144105-ba7370e8-81dd-4f30-a928-72f6e8e8cf8c.png)\n\n并且通过追款信息佐证了兜底划扣情况\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/101856398/1688643281512-621f4a82-bddb-418f-b9d2-206eba49f535.png)\n\n### \n## 四、故障原因\n### 4.1【一句话原因】\n提前清除了tt的topic,导致之前写入tt的日志异常\n\n\n\n### 4.2【背景说明】\n因最近信息泄露情况严重,风控团队同学希望添加ODPS表可查看API请求日志,通过API应用往TT发送日志数据，再通过TT同步至ODPS。后经过讨论认为TT写ODPS表的方案过于个性化，转为使用onelog记录操作日志。\n\n\n\n### 4.3【根因分析】\n原定先发布API变更,但实际执行顺序为先清除了TTTopic，导致TT工具发送日志异常。导致接口方法抛出异常,无法正常返回详情。间接影响商家回填票号的时效（因为不确定商家回填票号的时候会不会再来查询详情，会不会因为查询详情失败商家内部系统回填票号逻辑异常）\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/101856398/1689045412905-c095f978-b990-4abd-8208-c2cdb06f16a3.png)\n\n## 四、故障关注点\n/* 根据故障实际情况可增删关注点，并提供详细内容分析*/\n\n### 4.1【系统质量】\n#### 4.1.1 需求&设计评估\n**〖关注点1〗****是否涉及产品、技术方案评估？此核心的问题是什么，如何改进？**\n\n- [ ] **是，涉及**\n    - [ ] 需求评估遗漏\n    - [ ] 产品设计缺陷\n    - [ ] 系统架构设计缺陷\n        - [x] 容错性不足 \n        - [ ] 单点，无冗余\n        - [ ] 缺乏自我保护\n        - [ ] 缓存设计不当\n        - [ ] 容量评估不足\n        - [ ] 非幂等设计\n        - [ ] 强弱依赖不合理\n        - [ ] 其他：\n- [ ] 否，不涉及\n\n**〖问题总结〗**\n\n**优化代码**\n\n#### 4.1.2  代码质量\n**〖关注点1〗是否代码自身存在漏洞或BUG、代码健壮性是否存在问题等?**\n\n**〖问题分析〗**\n\n**〖改进点〗外部连接代码块通过Try包裹,避免异常情况下导致原有业务的不可用**\n\n****\n\n**〖关注点2〗****是否经过CodeReview？CodeReview阶段是否发现问题？为何没发现？**\n\n+ **是否经过CR**\n    - [ ] 是\n    - [ ] 否\n    - [x] 不涉及\n+ **是否设置合理的CR卡点**\n    - [ ] 是\n    - [ ] 否\n    - [x] 不涉及\n    - [CR卡点设置要求](https://ata.alibaba-inc.com/articles/225396?spm=ata.25287382.0.0.5e0c7536X43l05)\n+ **CR人员：**\n+ **CR时长：**\n+ **CodeReview阶段是否发现问题？为何没发现？后续如何发现？**\n    - [ ] 是\n    - [x] 否\n\n**〖问题分析〗**\n\n**〖改进点〗CR阶段确认是否外部连接。确定异常情况是否终止业务**\n\n#### 4.1.3 变更质量\n+ **是否涉及变更：**\n    - [x] 是\n    - [ ] 否\n+ **变更类型：**\n    - [ ] 代码发布\n    - [ ] 配置变更\n    - [x] 其他变更：清除了tt topic;\n    - [ ] 不涉及\n+ **变更平台是否接入ChangeFree：**\n    - [ ] 是，CF变更单链接：\n    - [x] 否\n+ **变更内容：**_****_\n    - [x] 变更执行人: 郑增都\n    - [x] 变更系统：TT&DataHub\n    - [x] 变更对象：消息 topic\n\n**〖关注点1〗****测试阶段**\n\n+ **测试内容：商品策略管理需求相关内容**\n+ **测试人员：郝宝成、光白、方宇豪**\n+ **是否经过测试验证**\n    - [ ] 是，验证环境\n        - [ ] 预发环境\n        - [ ] 日常环境\n    - [ ] 是，测试方法\n        - [ ] 回归测试\n        - [ ] 单元测试\n        - [ ] 集成测试\n        - [ ] 链路测试\n        - [ ] 验收测试\n    - [ ] 否\n    - [x] 不涉及\n+ **",
    "chunk_order_index": 1,
    "full_doc_id": "doc-a5306e9c59db40e34c8f841593c8cee4"
  },
  "chunk-8b5fbeb3ea07fe46173f2fe512c91177": {
    "tokens": 845,
    "content": "**是否经过测试验证**\n    - [ ] 是，验证环境\n        - [ ] 预发环境\n        - [ ] 日常环境\n    - [ ] 是，测试方法\n        - [ ] 回归测试\n        - [ ] 单元测试\n        - [ ] 集成测试\n        - [ ] 链路测试\n        - [ ] 验收测试\n    - [ ] 否\n    - [x] 不涉及\n+ **测试未发现原因是什么？后续如何改进？**\n    - [ ] 回归遗漏\n        - [ ] 手工回归case遗漏\n        - [ ] 自动化未建设\n        - [ ] 自动化回归覆盖不足\n        - [ ] 性能影响评估不足\n    - [ ] 新场景遗漏\n        - [ ] 新增功能case遗漏\n        - [ ] 性能影响评估不足\n        - [ ] 无线端稳定性评估/测试不足（如：crash）\n        - [ ] 无线端兼容性测试不足\n        - [ ] 安全问题\n        - [x] 异常场景评估/测试遗漏\n    - [ ] 其他原因说明\n\n\n\n### 4.2【处置能力】\n#### 4.2.1 故障发现&响应\n+ **是否监控发现**\n    - [x] 是\n        - [x] 故障触发方\n        - [x] 受影响方\n    - [ ] 否 ：****\n+ **发现后是否五分钟内响应**\n    - [x] 是\n    - [ ] 否，原因为：\n+ **应急协同组织是否存在问题**\n    - [ ] 应急流程不明确（无流程或者流程不清晰、应急相关角色&职责不明确，缺失一号位等) \n\n     \n\n    - [ ] 应急执行不到位（有流程，但未按流程执行，通告发送不及时，响应不及时等）\n\n**〖问题总结〗**\n\n**〖改进点〗**建立API分均请求量,监控请求情况。异常时发送告警信息\n\n#### 4.2.2 故障定位&恢复\n+ **故障涉及恢复方式：**\n    - [x] 代码发布\n    - [ ] 代码回滚\n    - [ ] 配置回滚\n    - [ ] 隔离\n    - [ ] 扩容\n    - [ ] 重启\n    - [ ] 限流\n    - [ ] 降级预案\n    - [ ] 自动恢复\n    - [ ] 其他：\n+ **是否达到10分钟快恢（**_**P1P2故障填写**_**）**\n    - [ ] 是\n    - [ ] 否，原因：\n\n****\n\n**〖关注点〗是否有更快恢复的方式？如何确保以后不再出现类似问题？是否可以做到真实数据的测试验证？**\n\n**〖改进点〗在清除无用资源是需要确认当前资源的使用情况**\n\n## 五、故障Action\n| **ACTION** | **是否keyAction** | **计划完成时间** | **验收标准** | **Action负责人** |\n| --- | --- | --- | --- | --- |\n| 新增top分钟请求量告警配置 | 否 | 07-12 | 所有相关接口都有告警配置 | 景衍 |\n| 发布规范--后端系统发布检查流程 |  | 07-21 |  | 景衍 |\n\n\n\n\n## 九、故障反思总结\n### 【做得好的】\n最佳实践\n\n### 【经验教训】\n+ 新增外部接入的时候通过try保护主业务流程的正常运行。\n+ 在清除无用资源是需要确认当前资源的使用情况\n+ 建立API分均请求量,监控请求情况。异常时发送告警信息",
    "chunk_order_index": 2,
    "full_doc_id": "doc-a5306e9c59db40e34c8f841593c8cee4"
  },
  "chunk-a0f402a81e57a51d69df1f90cdebabdd": {
    "tokens": 1200,
    "content": "## 一、故障概述（含影响产品线及影响面）\n**故障概述：**\n\n于2023-07-04 16:15起，飞猪_酒店_渲染订单_排错监控异常，失败量最近10分钟最小值大于等于10，成功率最近10分钟最大值小于等于80%，触达P4故障等级，经确认故障原因为部分规则数据异常，于16:56数据订正完成，故障恢复\n\n## 二、故障过程回顾【故障处理时间线】\n### 【1-5-10概览】\n![画板](https://intranetproxy.alipay.com/skylark/lark/0/2023/jpeg/332176/1688465384875-ec5db413-4bc6-465f-922a-c0a563247f7e.jpeg)\n\n### 【故障处理时间线】\n整体故障时间线。需要着重强调【故障注入】【故障发生】【故障发现】【业务响应】【故障定位】【恢复执行】【故障恢复】时间点。\n\n【故障注入】：2023-07-04 16:00 在预发环境发起迁店测试，产生迁店任务；\n\n【故障发现】：2023-07-04 16:18 在钉钉群 大住宿稳定性群 中出现报警；\n\n【业务响应】：2023-07-04 16:20 照眠接手报警，并反馈到商品，开始定位问题；\n\n【故障发生】：2023-07-04 16:25 调Ateye方法启动迁店流程，迁店完成，清空了菲住卖家的加价数据；\n\n【故障定位】：2023-07-04 16:45 定位到原因是 b_price_rule_base 数据被清空；\n\n【恢复执行】：\n\n2023-07-04 16:57  写一条卖家维度的加价，作为兜底查询，恢复渲染报错；\n\n2023-07-04 17:00  操作价格计算开关回商品老链路，价格计算切流读hotel_ic 库；\n\n2023-07-04 18:56 从离线表中拉取前一天的数据，回流到MySQL实时表中；\n\n2023-07-04 19:42 跑恢复数据，双写酒店的 hotel_ic 库和hotel_supplier_ic 中；\n\n2023-07-05 10:04 切流价格计算切回读hotel_supplier_ic 库；\n\n【故障恢复】：2023-07-04 16:57 \n\n## 三、故障影响面\n影响菲住酒店联盟旗舰店 卖家的下单成功率 42分钟，整体卖家下单页渲染成功率最低跌至65.7%，平均跌至 76.22%，菲住卖家下单成功率最低跌至0.46%，平均跌至16.18%，其他卖家没有受影响。预估影响菲住订单数：483。\n\n总成功率\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/332176/1688469109548-ca89c8a1-5bf7-4563-bf63-68a96736426f.png)\n\n\n\n菲住卖家成功率\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/332176/1688468980636-7f425bd2-c1a1-4255-b502-6294b10abdd3.png)\n\n## ![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/332176/1688648842907-87618ddf-337b-4708-8e13-921cc14e3662.png)\n## 四、故障原因\n### 4.1【一句话原因】\n菲住迁店项目测试中，使用菲住卖家下的测试酒店，因hic加价规则更新bug，hid维度加价规则删除未失效，将底价加价 b_price_rule_base 表中菲住卖家下的的数据清掉了，导致填单页渲染中价格计算因查不到底价加价规则报错，渲染失败。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/58146/1688559064570-85454502-8a8e-47b2-97c5-e29a7a6f0f67.png)\n\n### 4.2【背景说明】\n_/* 根据实际情况，选择填写下面的内容 */_\n\n在菲住回退项目中，酒店商品需要进行酒店数据的迁移，在需要迁移的数据中，包括新货品库的加价数据 b_price_rule_base ，这个表存储了rate维度之外，包括卖家、供应商、酒店维度的加价数据。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/332176/1688469343387-eadbe7f9-86b5-45f8-8f36-cae366813a98.png)\n\n\n\n技术方案文档：\n\n[菲住回退 - 新货品库方案](https://aliyuque.antfin.com/fliggy-hotel/lrukxc/xci04ro2ofu5scnh)\n\n\n\n### 4.3【根因分析】\n#### 数据隔离相关\n在预发",
    "chunk_order_index": 0,
    "full_doc_id": "doc-e121f11748daa915886beec5e16a07d3"
  },
  "chunk-42ff8c6bdcaa497f74faafae5cdd1ac2": {
    "tokens": 1075,
    "content": "2023/png/332176/1688469343387-eadbe7f9-86b5-45f8-8f36-cae366813a98.png)\n\n\n\n技术方案文档：\n\n[菲住回退 - 新货品库方案](https://aliyuque.antfin.com/fliggy-hotel/lrukxc/xci04ro2ofu5scnh)\n\n\n\n### 4.3【根因分析】\n#### 数据隔离相关\n在预发环境操作测试，与线上的数据没有进行隔离；\n\n#### 测试数据相关\n由于需要测试菲住相关的业务逻辑，测试用了真实卖家下的测试酒店，导致影响到了真实卖家的数据。\n\n#### 代码相关\n在迁店过程中需要查出酒店相关数据后，修改supplierId ，插入新的分库中，并清除原来的数据。\n\n在查酒店数据时，SQL写的有问题，代码如下：\n\nb_price_rule_base 表中实体id既可能是hid，也可能是 supplier，需要指定实体类型和实体id进行酒店维度的查询，问题SQL会导致查出卖家下所有的数据，需要加上 entity_id 和 entity_type的限制条件。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/332176/1688475038412-d11a9a5b-f155-4072-aa77-92cac054a45f.png)\n\n\n\n迁店任务记录：\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/332176/1688471008422-eb6ab5db-fc1e-4d32-9f08-436fa14dacdd.png)\n\n#### \n\n\n## 四、故障关注点\n/* 根据故障实际情况可增删关注点，并提供详细内容分析*/\n\n### 4.1【系统质量】\n#### 4.1.1 需求&设计评估\n**〖关注点1〗****是否涉及产品、技术方案评估？此核心的问题是什么，如何改进？**\n\n- [ ] **是，涉及**\n    - [ ] 需求评估遗漏\n    - [ ] 产品设计缺陷\n    - [ ] 系统架构设计缺陷\n        - [x] 容错性不足 \n        - [ ] 单点，无冗余\n        - [x] 缺乏自我保护\n        - [ ] 缓存设计不当\n        - [ ] 容量评估不足\n        - [ ] 非幂等设计\n        - [ ] 强弱依赖不合理\n        - [ ] 其他：\n- [ ] 否，不涉及\n\n**〖问题总结〗**\n\n**优化代码**\n\n#### 4.1.3 变更质量\n+ **是否涉及变更：**\n    - [x] 是\n    - [ ] 否\n+ **变更类型：**\n    - [ ] 代码发布\n    - [ ] 配置变更\n    - [x] 其他变更：__测试____\n    - [ ] 不涉及\n+ **变更平台是否接入ChangeFree：**\n    - [ ] 是，CF变更单链接：\n    - [ ] 否\n+ **变更内容：**_****_\n    - [x] 变更执行人:  寄奴，李康\n    - [ ] 变更系统：hshoppingcenter \n    - [ ] 变更对象：迁店接口\n\n## 五、故障Action\n| **序号** | **ACTION** | **是否keyAction** | **计划完成时间** | **验收标准** | **Action负责人** |\n| --- | --- | --- | --- | --- | --- |\n| 1 | 迁店场景的查询数据校验，增加hid的判断 | 是 | 2023.7.6 | 菲住场景接口验证通过 | 寄奴 |\n| 2 | 加价规则场景，针对加价金额过低、加价规则批量删除/修改等高危场景添加监控 | 是 | 2023.7.20 | 监控添加完成且验证有效 | 言慕 |\n| 3 | 针对底价加价规则快恢机制：数据恢复到上一个版本（备注：idb数据追踪过慢原因） | 是 | 2023.7.14 | 快恢方案明确，且测试卖家线上验证可用 | 玉铮、言慕 |\n| 4 | 预估迁店影响数据量，实际执行有差异报警 | | 2023.7.14 | 飞猪迁店需求验证通过 | 寄奴、毅盛、怡晨 |\n| 5 | 增加底价兜底规则，和业务确认底价，命中兜底规则预警 | | 2023.7.11 | 兜底规则产品确认，系统实现并测试通过 | 玉铮、言慕 |",
    "chunk_order_index": 1,
    "full_doc_id": "doc-e121f11748daa915886beec5e16a07d3"
  },
  "chunk-816417adf0438af8becc8f191f87711f": {
    "tokens": 1200,
    "content": "## 一、故障概述（含影响产品线及影响面）\n**故障概述：**\n\n2023-07-03 17:16开始[国内机票履约下单及预订成功量下跌](https://cofree.alibaba-inc.com/orm/config/emergency-scene/list/online?includeRule=false&typeCode=1&buId=1&refId=85f01cc8d1b78b5e&__tenant__=alibabaGroup)：持续10分钟成功率小于70%，触发P4，初步定位为配置变更导致打日志导致线程阻塞，引发系统full GC，影响飞猪国内国际机票下单，期间产生客诉23例。回滚配置后于18:25分线上完全恢复。\n\n\n**影响面：**\n\n    - 是否影响可用性**：是**\n    - **业务影响：**\n\n| **时间** | **订单量** | | | **人航段票量** |\n| --- | --- | --- | --- | --- |\n| **07.03** | **131204** | **昨天同比** | **上周同比****** | **226920** | **昨天同比****** | **上周同比****** |\n| | | 涨**21.3%****108162** | 降**3.45%****135892** | | 涨**20.41%****（188456）** | 涨**0.12%****（226649）** |\n| **07.02** | **108162** | | 降**17.47%****131054** | **188456** | | 降**12.25%****214759** |\n\n\n##### ****\n        * **国内机票提交订单异常：**\n        * ![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/39701/1688456462578-6692d5f3-8791-4472-ab14-71e9d5158007.png)\n    - 是否有客诉量（在线，热线，排队量）：23单，国内21单，国际2单\n    - 是否有社会舆情：无\n    - 是否产生资损：无\n\n## 二、故障过程回顾【故障处理时间线】\n### 【1-5-10概览】\n![画板](https://intranetproxy.alipay.com/skylark/lark/0/2022/jpeg/3536/1664281997005-b98bc6b2-4078-4961-9951-eae343abe2ee.jpeg)\n\n### 【故障处理时间线】\n整体故障时间线。需要着重强调【故障注入】【故障发生】【故障发现】【业务响应】【故障定位】【恢复执行】【故障恢复】时间点。\n\n【故障注入】2023-07-03 10:33 新增IBE+AV配置（行程类型） Velocity\n\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/39701/1688458837148-7290cd3d-8e7e-4241-867d-a472bcf2845b.png)\n\n2023-07-03 11:08 新增AV(1G，1A)配置（库存管理 POC） Velocity\n\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/39701/1688458852068-cafcc6b6-93d1-4c46-92af-8e400d415889.png)\n\n2023-07-03 11:32 （库存管理 POC） Velocity 转Java规则\n\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/115858/1688438932095-0b8dd239-778a-42cb-b935-14c097a5a68e.png?x-oss-process=image%2Fresize%2Cw_1218%2Climit_0)\n\n\n\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/115858/1688438848384-d5a95807-0080-46f2-b451-a39dbc303fcb.png?x-oss-process=image%2Fresize%2Cw_1258%2Climit_0)\n\n\n2023-07-03 16:26 新增AV(1G，1A)配置(office类型) Velocity\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/39701/1688458874221-780df3e0-cda0-4920-b08f-7eb27148881f.png)\n\n【故障发现】【业务响应】2023-07-03 17:06 收到告警，同时开始排查，日常此类问题多因航信导致，初步判断为航信平台问题\n\n2023-07-03 17:11 线上发现flygds 1G AV出现问题，开始定位内部问题\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/39701/1688459080269-fc460cf8-3b2e-4392-b52c-7f9ea51ddb15.png)\n\n【故障发生】2023-07-03 17:16～2023-07-03 17:26 [国内机票履约下单及",
    "chunk_order_index": 0,
    "full_doc_id": "doc-2f62ca8fcfcf4223bac05d6335346b5a"
  },
  "chunk-197a50e3f8fbb049050645d757d775b7": {
    "tokens": 1200,
    "content": "AV出现问题，开始定位内部问题\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/39701/1688459080269-fc460cf8-3b2e-4392-b52c-7f9ea51ddb15.png)\n\n【故障发生】2023-07-03 17:16～2023-07-03 17:26 [国内机票履约下单及预订成功量下跌](https://cofree.alibaba-inc.com/orm/config/emergency-scene/list/online?includeRule=false&typeCode=1&buId=1&refId=85f01cc8d1b78b5e&__tenant__=alibabaGroup)：持续10分钟成功率小于70%，触发P4\n2023-07-03 17:11~ 期间多次重启flygds,扩容，尝试恢复系统服务，未果\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/39701/1688548584840-c67afc90-e824-4c10-919f-8b33c1b43c8f.png)\n\n【初因定位】2023-07-03 17:43 发现flygds线程阻塞原因：资源标签Velocity资源规则\n【恢复执行】2023-07-03 17:46 关闭线上资源标签总开关\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/115858/1688387349300-fd3e6fb4-27fd-47ff-9c0e-2bf8fc7b4259.png)\n\n期间大量机器无法自动化重启，人工逐台重启\n2023-07-03 18:04 删除AV(1G，1A)配置(office类型) Velocity\n【故障恢复】2023-07-03 18:25 线上完全恢复\n\n## \n## 三、故障影响面\n\n\n[国内机票履约下单及预订成功量下跌](https://cofree.alibaba-inc.com/orm/config/emergency-scene/list/online?includeRule=false&typeCode=1&buId=1&refId=85f01cc8d1b78b5e&__tenant__=alibabaGroup)：持续10分钟成功率小于70%，触发P4\n\n## ![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/39701/1688454710558-13ce1b5f-e7af-4d91-97b7-9f420ef7b8f8.png)\n\n\n##### 渠道影响：\n+ 1E： shopping、NFD、AV、验价、预定、可支付校验\n\n##### 接口服务影响：\n+ 验座成功率下降39%左右\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/4509/1688438313401-7b3387f0-2bdd-4880-8792-f02f3f607b31.png)\n\n+ 预定接口成功率下降30%左右\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/4509/1688438394796-4dfe210e-552c-4e8a-9ae6-84942f84c4a1.png)\n\n+ 可支付校验成功率下降20%左右\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/4509/1688438511674-aaf6f59a-6d33-4604-93c2-35f2fc34c6fe.png)\n\n#### 国际\n##### 订单量影响：\n##### 客诉量影响：\n##### 渠道影响：\n+ 1G:  AV\n+ 1A：MPAV、BAMAV\n\n##### 接口服务影响\n+ 验座成功率下降11%左右\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/4509/1688439255475-a22bab41-bee2-4a84-8820-06d401a5deaf.png)\n\n+ \n\n### \n## 四、故障原因\n### 4.1【一句话原因】\n\n\n水滴资源标签Velocity打日志导致线程阻塞，导致应用fullGC。\n\n### 4.2【背景说明】\n### 4.3【根因分析】\n#### Velocity引擎打印日志详细代码\n原因：同步阻塞打印debug日志\n\n```java\n  public\n  void callAppenders(LoggingEvent event) {\n    int writes = 0;\n\n    for(Category c = this; c != null; c=c.parent) {\n      // Protected against simultaneous call to addAppender, removeAppender,...\n      synchronized(c) {\n\tif(c.aai != null) {\n\t  writes += c.aai.appendLoopOnAppenders(event);\n\t}\n\tif(!c.additive) {\n\t  break;\n\t}\n      }\n    }\n\n    if(writes == 0) {\n      repository.emitNoAppenderWarning(this);\n    }\n  }\n\n  protected\n  void forcedLog(String fqcn, Priority level, Object message, Throwable t) {\n    callAppenders(new LoggingEvent(fqcn, this, level, message, t));\n  }\n\n\n\n public\n  void debug(Object message) {\n    if(repository.isDisabled(Level.DEBUG",
    "chunk_order_index": 1,
    "full_doc_id": "doc-2f62ca8fcfcf4223bac05d6335346b5a"
  },
  "chunk-a5f98e82582359cea309e3b30f34394f": {
    "tokens": 1200,
    "content": "enders(event);\n\t}\n\tif(!c.additive) {\n\t  break;\n\t}\n      }\n    }\n\n    if(writes == 0) {\n      repository.emitNoAppenderWarning(this);\n    }\n  }\n\n  protected\n  void forcedLog(String fqcn, Priority level, Object message, Throwable t) {\n    callAppenders(new LoggingEvent(fqcn, this, level, message, t));\n  }\n\n\n\n public\n  void debug(Object message) {\n    if(repository.isDisabled(Level.DEBUG_INT))\n      return;\n    if(Level.DEBUG.isGreaterOrEqual(this.getEffectiveLevel())) {\n      forcedLog(FQCN, Level.DEBUG, message, null);\n    }\n  }\n\n```\n\n#### 线上应用正常不打印debug日志\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/115858/1688390266181-322874d9-5fea-4e77-af59-91ed941b7ebf.png)\n\n```java\n  public\n  Level getEffectiveLevel() {\n    for(Category c = this; c != null; c=c.parent) {\n      if(c.level != null)\n\treturn c.level;\n    }\n    return null; // If reached will cause an NullPointerException.\n  }\n```\n\n\n\n#### flygds发现两个ROOT/root\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/115858/1688389875193-abea2dae-811e-4689-82f3-ebc2248ef110.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/115858/1688387495278-5e9d0525-d894-4c01-9136-f337349488a0.png)\n\n##### log4j\n```java\npublic final class RootLogger extends Logger {\n  /**\n     The root logger names itself as \"root\". However, the root\n     logger cannot be retrieved by name.\n  */\n  public RootLogger(Level level) {\n    super(\"root\");\n    setLevel(level);\n  }\n\n  /**\n     Return the assigned level value without walking the logger\n     hierarchy.\n  */\n  public final Level getChainedLevel() {\n    return level;\n  }\n\n  /**\n     Setting a null value to the level of the root logger may have catastrophic\n     results. We prevent this here.\n\n     @since 0.8.3 */\n  public final void setLevel(Level level) {\n    if (level == null) {\n      LogLog.error(\n        \"You have tried to set a null level to root.\", new Throwable());\n    } else {\n      this.level = level;\n    }\n  }\n\n}\n```\n\nlogback\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/115858/1688389643391-b20eba48-d881-4c78-8d6d-8a3b32c6b8b1.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/115858/1688389739407-4787c659-80f2-4152-8d50-6c215d80ac65.png)\n\n### 操作流程与问题\n0703水滴资源配置修改后， 检查流程如下\n\n1. 通过查看水滴日志标签信息是否新增，确认是否有效\n2. 通过查看ateye异常日志 确认是否存在规则异常\n3. 通过arthas定位具体Velocity or Java规则是否存在异常\n\n遗漏点：\n\n1. 修改线上配置未及时检查机器性能，负载情况，fullgc指标等， 第一时间看机器线程状态 GC量，也能及时发现问题![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/115858/1688452729361-7c9929fe-1751-4a34-99b0-e5358e108fe2.png)\n2. 修改线上配置， 改动内容未及时同步钉钉群，导致团队内部第一时间无法关联变更\n\n## 五、故障Action\n| **ACTION** | **是否keyAction** | **计划完成时间** | **验收标准** | **Action负责人** |\n| --- | --- | --- | --- | --- |\n| 核心应用限制debug级别日志 | 是 | 07-14 | 核心应用默认不打印debug日志 | [@瀚渺](https://aliyuque.antfin.com/hanmiao.lx) |\n| 国内、国际、搜索与交易服务隔离 | 是 | 07-14 | 服务隔离验证通过 | 陈克 |\n| 核心应用服务设置单机限流，针对fullgc情况，可以临时加限流，重启/扩容机器等确保服务存活，降低影响 | 是 | 07-07 | 核心应用服务，设置单机限流 | 路衍 |\n| 水滴框架安全性升级1）Velocity引擎单独设置日志级别， 改为异步执行2）增加资源标签功能自动降级； | 是 | 07-30 | Velocity引擎不打印debug日志 | [@瀚渺](https://aliyuque.antfin.com/hanmiao.lx) |\n| 水滴等中间件涉及新增功能，较多改动升级需进行性能测试， | 否 | 08-30 | 水滴性能测试平台 | [瀚渺](https://aliyuque.antfin.com/hanmiao.lx",
    "chunk_order_index": 2,
    "full_doc_id": "doc-2f62ca8fcfcf4223bac05d6335346b5a"
  },
  "chunk-913556f590584b83cf42da12925e994d": {
    "tokens": 313,
    "content": "自动降级； | 是 | 07-30 | Velocity引擎不打印debug日志 | [@瀚渺](https://aliyuque.antfin.com/hanmiao.lx) |\n| 水滴等中间件涉及新增功能，较多改动升级需进行性能测试， | 否 | 08-30 | 水滴性能测试平台 | [瀚渺](https://aliyuque.antfin.com/hanmiao.lx) |\n| 改动内容及时同步钉钉发布群，涉及ateye开关【已有】，守望者配置等， 搭建配置开关监控平台，人工及时同步 | 否 | 08-30 | 线上变更配置同步-人工SOP守望者配置变更记录 | [瀚渺](https://aliyuque.antfin.com/hanmiao.lx) |\n| 系统fullgc服务监控标准梳理与处理流程 | 否 | 07-21 | fullGC故障处理流程 | [瀚渺](https://aliyuque.antfin.com/hanmiao.lx) |\n| 故障应对处理流程与培训1. 第一时间确认应用与初步影响范围2. 涉及相关发布，配置改动，能回滚即回滚，确保第一时间恢复服务； | 否 | 07-30 | 故障应对处理流程与培训 | 陈克 |",
    "chunk_order_index": 3,
    "full_doc_id": "doc-2f62ca8fcfcf4223bac05d6335346b5a"
  },
  "chunk-143d1fbd4341440230c375b1beb211ec": {
    "tokens": 1200,
    "content": "## 一、故障概述（含影响产品线及影响面）\n**故障概述：**\n\n 于2023-06-02 12:23开始，飞猪度假提交订单下跌大于等于50%，12:33分监控下跌超过10分钟，触发P2故障等级，影响飞猪度假、住宿、接送机三个产品线。原因定位为代码依赖包引用错误导致缓存失效，于12:37回滚后恢复。\n\n## 二、故障过程回顾\n【故障注入】12:02 trip-service-center正式发布，分四批，12:20 trip-service-center 发布到最后一批\n12:23 trip-service-center发布完成。\n【GOC报警】于 2023-06-02 12:23:00分，[度假_提交订单_排错_成功量](https://x.alibaba-inc.com/custom/59/product/preview/spm/4128) 监控指标异常，当前值（成功量）：31.0，基线值：161.17，偏离基线比：-80.77%\n【故障发生】【故障发现】于 2023-06-02 12:33:00分，监控下跌持续10分钟，达到P2故障\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/46649/1685686992550-1ebfd019-af0a-4c8d-b957-f5ae0a694001.png)\n\n12:24 风险预警，故障定位\n12:32 开始回滚\n12:37 第一批回滚完成，成功率恢复，故障恢复\n【业务响应】于 2023-06-02 12:34:00分，报障后龙幽立即应急\n\n【恢复执行】【故障定位】于 2023-06-02 12:36:00分，回滚和降级止血，问题原因还在排查中\n【故障恢复】于 2023-06-02 12:37:00分，回滚后恢复，故障持续4分钟。\n【故障根因定位】于 2023-06-02 16:00点定位根因，代码依赖包引用错误导致缓存失效，引发线上运行时错误。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/46649/1685687432428-1d54920a-d747-455e-aa00-ffde9b1fe12a.png)\n\n## 三、故障影响面\n**监控**：[度假-提交订单异常](https://x.alibaba-inc.com/custom/59/product/preview/spm/4128)\n\n**影响面：**\n\n    - 是否影响可用性**：**否\n    - 业务影响：门票、线路、接送车、菲住联盟-高德渠道购卡，其中门票、线路、接送车之前在度假的业务身份下。\n    - 是否有客诉量（在线，热线，排队量）：否\n    - 是否有社会舆情：否\n    - 是否产生资损：否\n    - 持续时间：监控下跌持续14分钟，故障持续4分钟；\n\n## 四、故障原因\n### 4.1【一句话原因】\n代码依赖包引用错误导致缓存失效，引发线上运行时错误。\n\n### 4.2【分析过程】\n#### ftbuy渲染失败日志\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/25156516/1685682244072-5aa25af4-2491-48ae-881b-9fff26a33513.png)\n\n#### ftbuy调用tsc的小黄条\n调用小黄条失败，返回map结构，map转换移除导致。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/25156516/1685682216569-611e25b6-2d0a-4d17-8e11-55b115b4ae5f.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/25156516/1685682507510-eaf43201-55b0-44eb-a745-90d17943cf14.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/25156516/1685682403918-f45c779e-6963-45da-9807-4c9cf01fff97.png)\n\n\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/25156516/1685684881775-fabe4499-3842-440c-8b64-da9594a49a07.png)\n\n#### 涉及业务\n门票、线路、接送车、菲住联盟-高德渠道购卡，其中门票、线路、接送车之前在度假的业务身份下。\n菲住联盟-高德渠道（2107d87316794657658095865d07a4），理论上不应该依赖小黄条\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/25156516/1685687048310-59dd6b4b-540f-452c-b3d",
    "chunk_order_index": 0,
    "full_doc_id": "doc-a49cc9f0f87aa013fb3a96f24a1a553e"
  },
  "chunk-87381cdb888564ada5131b058bb02e67": {
    "tokens": 1200,
    "content": "渠道购卡，其中门票、线路、接送车之前在度假的业务身份下。\n菲住联盟-高德渠道（2107d87316794657658095865d07a4），理论上不应该依赖小黄条\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/25156516/1685687048310-59dd6b4b-540f-452c-b3d8-640eba13dab5.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/25156516/1685687092938-a7ed9bdb-6468-47ea-ac21-ff75443ac793.png)\n\n\n\n#### 主要问题原因\ntsc-service 依赖 tfc-shared-kernel包，而tfc-shared-kernel依赖tfc-dal包，而tsc-service本身依赖自己的tsc-shared-kernel，里面包含tsc-dal，里面的配置文件一致。导致tsc使用tfc里面的配置文件，在进行数据库查询时，无法找到对应的mapper配置导致报错。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/25156516/1685695111802-a40672b8-a56f-4456-954b-c0a271208c53.png)\n\ntsc-dal config配置文件\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/25156516/1685695167676-c8be7ed7-630e-43df-a8e4-f225b2078251.png)\n\ntfc-dal config配置文件\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/25156516/1685695240681-501ebd01-ee7a-4d18-a548-d641c00793eb.png)\n\n#### 疑问-到底是注入不同Bean还是扫描到不同的Xml导致\n首先通过修改扫描xml包来验证一下是否加载xml的问题\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/306513/1685700842744-f2d4990c-2883-47e4-8137-d135a52f57ad.png)\n\n验证结果是注入bean是没有问题，具体分析如下：\n\n（1）sqlSessionFactory的mapperRegistry是扫描注册的tfc的mapper文件\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/306513/1685718748500-b69b2e22-c7f9-44e4-80b2-000b6295bc21.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/306513/1685718758378-bdc916c7-e3b6-4757-9a86-2f2e66c467b7.png)\n\n（2）先看看sqlSessionFactory是否注册的是tfc的bean，排查是否sqlSessionBean加载的问题，加入bean加载的日志，发现tfc的config和sqlsessionFactory是没有加载的，反倒是tfc的几个mapper被从jar包中加载出来了\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/306513/1685725740267-7be5691a-f613-4022-9ef5-a973ae5a8e40.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/306513/1685725655211-91cf69d9-acf6-4cad-b578-3ebf5080f831.png)\n\n继续追代码发现是maperRegister会去加载jar包中扫描到的mapper文件，到此终于说明bean没有问题，是加载的xml出了问题导致\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/306513/1685725442056-72a3c041-fae9-48bb-aed6-a0b729908cf7.png)\n\n（3）继续看xml源头扫描的部分，org.mybatis.spring.SqlSessionFactoryBean#buildSqlSessionFactory这里是构建sqlSessionFactory和对应xml文件解析的地方\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/306513/1685726279762-9713d306-cf8b-4848-859c-5bd7ffb96a77.png)\n\n（4）xml来源是configLocation，\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/306513/1685726325848-95663c11-935d-42e2-a988-66074801c530.png)\n\n在回到代码，还是最终这里有问题，和jar包中tfc同样的路径\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/306513/1685726382933-9915c789-13fb-4fd9-9410-b3344d3e62cb.png)\n\n（4）根据spring加载资源代码，classpath是通过ClassPathResource加载classpath下的资源，也就是这里的path就是travel-order-config.xml\n\n![](https://intranetproxy.alipay.com/skylark",
    "chunk_order_index": 1,
    "full_doc_id": "doc-a49cc9f0f87aa013fb3a96f24a1a553e"
  },
  "chunk-e68fd3c97f09f1e4b921d30b6a35e348": {
    "tokens": 1200,
    "content": "![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/306513/1685726382933-9915c789-13fb-4fd9-9410-b3344d3e62cb.png)\n\n（4）根据spring加载资源代码，classpath是通过ClassPathResource加载classpath下的资源，也就是这里的path就是travel-order-config.xml\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/306513/1685964043137-17be14c7-ebf7-46be-ab1f-f58083126eee.png)\n\n最终是利用jdk的classloader去加载资源，在classpath下加载依赖的包的\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/306513/1685964279755-187861fc-06c7-4b3a-b4fd-f4359d06576b.png)\n\nclassLoader加载资源在classpath下通过AppClassLoader加载，会加载依赖jar包和自己的资源文件，优先加载的jar包中资源。从验证结果来看是\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/306513/1685966465611-b1f75706-f000-481d-a998-013a837baab8.png)\n\n至此确认，是被引入的jar包的同名资源导致\n\n\n\n## 故障其他疑问\n#### trip-service-center小黄条服务报“Invaild bound statement”异常原因：\n  业务需求变更分支在引入二方包时，引入其tfc应用的“DAO层模块”，DAO层模块有Mybatis的config文件，且命名相同，trip-service-center应用的mybatis在初始化阶段，从classpth解析Mapper文件的时候就解析了tfc的jar包中的Mapper文件，没有解析trip-service-center自己的Mapper文件，因此在运行时阶段报了“Invalid bound statement”的错误。\n\n#### 为什么会影响度假/非度假行业的下单页渲染成功率？\n+  fliggy-buy2和 ftbuy对TravelTradeCommonAbilityService#queryOrderTipsCfg小黄条是强依赖，一旦小黄条服务出现了异常，会导致渲染失败。这里不合理，渲染页对小黄条应该是，弱依赖才对，小黄条获取失败不应该阻断渲染流程。\n+ 住宿、接送机2个类目，作为非度假的类目，通过非度假的类目，通过调用链分析，底层页依赖了TravelTradeCommonAbilityService#queryOrderTipsCfg小黄条服务，并且是强依赖，所以同样被影响了。\n\n#### 为什么发布阶段要最后一批开始发布时才出现下单渲染成功率显著下跌？\n    因为trip-service-center应用的TravelTradeCommonAbilityService#queryOrderTipsCfg服务使用了Tair缓存，只要有一台机器还活着，就会往Tair中写入小黄条的数据，其他的服务器再次请求就会优先走到Tair缓存，只有所有的机器都挂了+Tair缓存失效了接口成功率才会立马下跌。\n\n#### 为什么回滚机器第一批机器上线后渲染就冲高恢复了？\n     同上，还是因为缓存，只要有一台机器恢复了，将小黄条的数据写入到Tair缓存，那么所有的机器都会读Tair缓存的值直接返回，而不是查询数据库，就不会触发“Invalid bound statement”的错误。\n\n\n\n## 五、故障关注点\n> 从设计、代码、变更、发现应急、快速恢复 4个方面自我检查。\n>\n\n### 4.1【系统质量】\n#### 4.1.1 需求&设计评估\n**〖关注点1〗****是否涉及产品、技术方案评估？此核心的问题是什么，如何改进？**\n\n- [ ] **是，涉及**\n    - [ ] 需求评估遗漏\n    - [ ] 产品设计缺陷\n    - [ ] 系统架构设计缺陷\n        - [x] 容错性不足 \n        - [ ] 单点，无冗余\n        - [ ] 缺乏自我保护\n        - [ ] 缓存设计不当\n        - [ ] 容量评估不足\n        - [ ] 非幂等设计\n        - [ ] 强弱依赖不合理\n        - [ ] 其他：\n- [ ] 否，不涉及\n\n\n#### 4.1.2  代码质量\n**〖关注点1〗是否代码自身存在漏洞或BUG、代码健壮性是否存在问题等?**\n\n**〖问题分析**〗代码依赖关系有问题，不应该强依赖服务\n\n**〖改进点〗**\n\n****\n\n**〖关注点2〗****是否经过CodeReview？CodeReview阶段是否发现问题？为何没发现？**\n\n+ **是否经过CR**\n    - [x] 是\n    - [ ] 否\n    - [ ] 不涉及\n+ **是否设置合理的CR卡点**\n    - [x] 是\n    - [ ] 否\n    - [ ] 不涉及\n    - [CR卡点设置要求](https://ata.alibaba-inc.com/articles/225396?spm=ata.25287382.0.0.5e0c7536X43l05)\n+ **CR人员：**\n+ **CR时长",
    "chunk_order_index": 2,
    "full_doc_id": "doc-a49cc9f0f87aa013fb3a96f24a1a553e"
  },
  "chunk-9d449a16a01149e42081963808d31b13": {
    "tokens": 1200,
    "content": "- [ ] 否\n    - [ ] 不涉及\n+ **是否设置合理的CR卡点**\n    - [x] 是\n    - [ ] 否\n    - [ ] 不涉及\n    - [CR卡点设置要求](https://ata.alibaba-inc.com/articles/225396?spm=ata.25287382.0.0.5e0c7536X43l05)\n+ **CR人员：**\n+ **CR时长：**\n+ **CodeReview阶段是否发现问题？为何没发现？后续如何发现？**\n    - [ ] 是\n    - [x] 否  \n\n**〖问题分析〗**\n\n重点关注业务逻辑，开关逻辑细节关注不够\n\n**〖改进点〗**\n\n**发布文档增加可能出现的异常情况和异常情况的处置机制**\n\n#### 4.1.3 变更质量\n+ **是否涉及变更：**\n    - [x] 是\n    - [ ] 否\n+ **变更类型：**\n    - [x] 代码发布\n    - [ ] 配置变更\n    - [ ] 其他变更：____________\n    - [ ] 不涉及\n+ **变更平台是否接入ChangeFree：**\n    - [x] 是，CF变更单链接：\n    - [ ] 否\n+ **变更内容：**_****_\n    - [x] 变更执行人: [@沐柚](undefined/shaowenzheng.swz)\n    - [x] 变更系统：trip-service-center\n    - [x] 变更对象：trip-service-center\n    - [ ] 发布单链接：\n+ **变更级别：**\n    - [ ] 高危\n    - [ ] 重大\n    - [x] 一般变更\n\n**〖关注点1〗****测试阶段**\n\n+ **测试内容： 代理人自动出票逻辑**\n+ **测试人员： 胡小芳**\n+ **是否经过测试验证**\n    - [x] 是，验证环境\n        - [x] 预发环境\n        - [ ] 日常环境\n    - [x] 是，测试方法\n        - [ ] 回归测试\n        - [ ] 单元测试\n        - [ ] 集成测试\n        - [ ] 链路测试\n        - [ ] 验收测试\n    - [ ] 否\n    - [ ] 不涉及\n    - [x] 其他原因说明：缓存问题，只有所有机器都发布完成后，才会出现该问题\n\n\n**〖关注点2〗****灰度阶段**\n\n+ **是否经过灰度：**\n    - [x] 是\n    - [ ] 否\n+ **未灰度发现原因**\n    - [x] 灰度无法发现：缓存问题，只有所有机器都发布完成后，才会出现该问题\n\n****\n\n**〖关注点3〗****上线阶段**\n\n+ **是否分批发布**\n    - [x] 是\n        * 分批数量：4批\n        * 前两批间隔时长：\n    - [ ] 否\n+ **是否有确定的监控观测指标**\n    - [x] 是\n    - [ ] 否\n+ **是否在窗口期进行发布变更**\n    - [ ] 是\n    - [x] 否，原因：非核心应用没有强管控，该问题是饭点发布，人没有持续观测；\n+ **变更是否影响上下游**\n    - [x] 是\n    - [ ] 否\n+ **是否提前知会上下游评估及关注变更**\n    - [ ] 是\n    - [x] 否\n\n\n**〖关注点4〗红线检查**\n\n**变更系统是否接入ChangeFree？ChangeFree单链接请提供？**\n\n**已接入ChangeFree.**\n\n发布单链接：[https://cd.aone.alibaba-inc.com/ec/app/70656/deploy/order?spm=a2o8d.mix_deploy_order.page.343.133a7368MXOtGp&id=75060559&envId=379308](https://cd.aone.alibaba-inc.com/ec/app/70656/deploy/order?spm=a2o8d.mix_deploy_order.page.343.133a7368MXOtGp&id=75060559&envId=379308)\n\n### 4.2【处置能力】\n#### 4.2.1 故障发现&响应\n+ **是否监控发现**\n    - [x] 是\n        - [x] 故障触发方\n        - [ ] 受影响方\n    - [ ] 否 ：****\n+ **发现后是否五分钟内响应**\n    - [x] 是\n    - [ ] 否，原因为：\n+ **应急协同组织是否存在问题**\n    - [ ] 应急流程不明确（无流程或者流程不清晰、应急相关角色&职责不明确，缺失一号位等) \n    - [ ] 应急执行不到位（有流程，但未按流程执行，通告发送不及时，响应不及时等）\n\n**〖问题总结〗**\n\n**〖改进点〗**\n\n#### 4.2.2 故障定位&恢复\n+ **故障涉及恢复方式：**\n    - [ ] 代码发布\n    - [x] 代码回滚\n    - [ ] 配置回滚\n    - [ ] 隔离\n    - [ ] 扩容",
    "chunk_order_index": 3,
    "full_doc_id": "doc-a49cc9f0f87aa013fb3a96f24a1a553e"
  },
  "chunk-4277b7222da7698e696f014d4da201d3": {
    "tokens": 321,
    "content": "流程，但未按流程执行，通告发送不及时，响应不及时等）\n\n**〖问题总结〗**\n\n**〖改进点〗**\n\n#### 4.2.2 故障定位&恢复\n+ **故障涉及恢复方式：**\n    - [ ] 代码发布\n    - [x] 代码回滚\n    - [ ] 配置回滚\n    - [ ] 隔离\n    - [ ] 扩容\n    - [ ] 重启\n    - [ ] 限流\n    - [ ] 降级预案\n    - [ ] 自动恢复\n    - [ ] 其他：\n+ **是否达到10分钟快恢（**_**P1P2故障填写**_**）**\n    - [x] 是\n    - [ ] 否，原因：\n\n## 六、故障Action\n1. 安全生产流程，饭点不发布，然后停留时间保障。安全生产内部会议宣导。@少启@文须 6.15前\n2. 强弱依赖梳理，fliggy-buy2、ftbuy渲染小黄条降级为弱依赖。 @回薄  6.6 发布\n3. 容错的机制：优化对异常的处理Exception/Error/Throwable。[@唤酒](undefined/maocheng.xmc) 6.2 发布\n\n## 七、故障定级&相关方\n#### 【故障等级】P2降P3",
    "chunk_order_index": 4,
    "full_doc_id": "doc-a49cc9f0f87aa013fb3a96f24a1a553e"
  },
  "chunk-2e2e101cadd77cfc2ce550afa1793363": {
    "tokens": 1200,
    "content": "## 一、故障概述（含影响产品线及影响面）\n**故障概述：**\n\n 于2023-06-08 10:29开始火车票-保险推荐-常用服务指标下跌超过38%，成功率最近10分钟最大值小于等于85%，已达到P4故障，故障影响：火车票保险推荐 ，初步确认为发布导致，于10:44回滚完成后，故障恢复。\n\n## 二、故障过程回顾\n【故障注入】2023-06-08 10:26，[熊维远](https://work.alibaba-inc.com/work/u/WB01096548)操作发布需求：[https://aone.alibaba-inc.com/v2/project/1045657/req/49902123](https://aone.alibaba-inc.com/v2/project/1045657/req/49902123)，发布单：[https://cd.aone.alibaba-inc.com/ec/app/167353/deploy/order?spm=a2o8d.mix_deploy_order.page.24.16e31d15xthwvl&id=79518224&envId=2592006](https://cd.aone.alibaba-inc.com/ec/app/167353/deploy/order?spm=a2o8d.mix_deploy_order.page.24.16e31d15xthwvl&id=79518224&envId=2592006)\n\n\n【故障发现】2023-06-08 10:34 平台保险故障群接到风险预警（由于飞猪预警群没有订阅该产品线，预警未报到大群）\naction：目前已订阅到大群，需安排演练\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/39701/1686296065819-c3bbac9b-9228-4115-b3a6-8653eeb5b9c2.png)\n\n【业务响应】【初因定位】【恢复执行】2023-06-08 10:34 技术开始操作回滚： [https://cd.aone.alibaba-inc.com/ec/app/167353/deploy/order?id=79519131&envId=2592006&flowInstId=3004739419&flowComponentInstId=3015005546](https://cd.aone.alibaba-inc.com/ec/app/167353/deploy/order?id=79519131&envId=2592006&flowInstId=3004739419&flowComponentInstId=3015005546)\n\n\n【故障发生】2023-06-08 10:39 成功率最近10分钟最大值小于等于85%，达到P4故障\n【故障恢复】2023-06-08 10:44 回滚完成，故障恢复。\n【根因定位】2023-06-08 16:24 [https://aliyuque.antfin.com/fplat/blsh19/lh4w779sffwfmt2i?singleDoc#](https://aliyuque.antfin.com/fplat/blsh19/lh4w779sffwfmt2i?singleDoc#) \n\n## 三、故障影响面\n**监控**：[https://x.alibaba-inc.com/custom/59/product/preview/spm/8476](https://x.alibaba-inc.com/custom/59/product/preview/spm/8476)\n\n**影响面：火车票**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/39701/1686296647434-12f944de-3f7a-448e-be36-a54f55945ad0.png)\n\n    - 是否影响可用性**：**否\n    - 业务影响：\n    - 是否有客诉量（在线，热线，排队量）：否\n    - 是否有社会舆情：否\n    - 是否产生资损：否\n    - 持续时间：\n\n## 四、故障原因\n### 4.1【一句话原因】\nhsf接口参数校验，由于参数会为空，导致不断校验失败：[https://aone.alibaba-inc.com/v2/project/1045657/req/49902123](https://aone.alibaba-inc.com/v2/project/1045657/req/49902123)\n\n### 4.2【分析过程】\n#### 追溯原因发现是排序算法出现问题，导致process方法执行顺序不确定，使本次变更的process中调用hsf方法没有办法获取对应参数，导致hsf接口入参为空\n\n\n补充下代码截图及业务逻辑说明（建议补充下逻辑流程图）\n\norder = 10 的 processor 会把 city 补进去，然后在 order = 19 的处理器里使用\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/6504/1686298734174-f200edd3-818a-48b6-8128-e8efe97a5089.png)\n\n此处没有判空，也没有 try catch。入参为空，异常上抛到最外层导致接口挂掉。\n\n取不到 city 是因为：\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/6504/1686298663343-eb59064b-4d99-4b4c-9140-b653b58e480f.png)\n\n集合 sort 只能返回 0 -1 1，返回其他数值导致排序结果不可靠\n\n## 故障其他疑",
    "chunk_order_index": 0,
    "full_doc_id": "doc-69f274dd6a03c16d94ecaaad88229b58"
  },
  "chunk-67508468515aa8d86767d47e16ed0182": {
    "tokens": 1200,
    "content": "抛到最外层导致接口挂掉。\n\n取不到 city 是因为：\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/6504/1686298663343-eb59064b-4d99-4b4c-9140-b653b58e480f.png)\n\n集合 sort 只能返回 0 -1 1，返回其他数值导致排序结果不可靠\n\n## 故障其他疑问\n#### 1、非核心应用的核心场景加入自动化测试 [@栀芊](undefined/hongxia.khx)\n\n\n## 五、故障关注点\n### 4.1【系统质量】\n#### 4.1.1 需求&设计评估\n**〖关注点1〗****是否涉及产品、技术方案评估？此核心的问题是什么，如何改进？**\n\n- [ ] **是，涉及**\n    - [ ] 需求评估遗漏\n    - [ ] 产品设计缺陷\n    - [ ] 系统架构设计缺陷\n        - [x] 容错性不足 \n        - [ ] 单点，无冗余\n        - [ ] 缺乏自我保护\n        - [ ] 缓存设计不当\n        - [ ] 容量评估不足\n        - [ ] 非幂等设计\n        - [ ] 强弱依赖不合理\n        - [ ] 其他：\n- [ ] 否，不涉及\n\n**〖问题总结〗**\n\n在开发时应该做兜底，在推荐流程中，单个process失败不应该影响其他的process\n\n#### 4.1.2  代码质量\n**〖关注点1〗是否代码自身存在漏洞或BUG、代码健壮性是否存在问题等?**\n\n**〖问题分析**〗代码依赖关系有问题，不应该强依赖服务\n\n**〖改进点〗开发时应该做兜底**\n\n****\n\n**〖关注点2〗****是否经过CodeReview？CodeReview阶段是否发现问题？为何没发现？**\n\n+ **是否经过CR**\n    - [x] 是\n    - [ ] 否\n    - [ ] 不涉及\n+ **是否设置合理的CR卡点**\n    - [x] 是\n    - [ ] 否\n    - [ ] 不涉及\n    - [CR卡点设置要求](https://ata.alibaba-inc.com/articles/225396?spm=ata.25287382.0.0.5e0c7536X43l05)\n+ **CR人员：长统**\n+ **CR时长：**\n+ **CodeReview阶段是否发现问题？为何没发现？后续如何发现？**\n    - [ ] 是\n    - [x] 否  \n\n**〖问题分析〗**\n\n之前老代码的原因，在这次开发中并没有涉及修改，并且在预发自测中没有出现问题\n\n**〖改进点〗**\n\n**发布文档增加可能出现的异常情况和异常情况的处置机制**\n\n#### 4.1.3 变更质量\n+ **是否涉及变更：**\n    - [x] 是\n    - [ ] 否\n+ **变更类型：**\n    - [x] 代码发布\n    - [ ] 配置变更\n    - [ ] 其他变更：____________\n    - [ ] 不涉及\n+ **变更平台是否接入ChangeFree：**\n    - [x] 是，CF变更单链接：[https://aicf.alibaba-inc.com/aicf/orderDetailNew/410505968?spm=goc-apm.aicf-_change_v2_detail_-id?.0.0.67e92388nmj6sy](https://aicf.alibaba-inc.com/aicf/orderDetailNew/410505968?spm=goc-apm.aicf-_change_v2_detail_-id?.0.0.67e92388nmj6sy)\n    - [ ] 否\n+ **变更内容：**_****_\n    - [ ] 变更执行人:熊维远\n    - [ ] 变更系统：aone\n    - [ ] 变更对象：f-ins-rec\n    - [ ] 发布单链接：[https://cd.aone.alibaba-inc.com/ec/app/167353/deploy/order?spm=a2o8d.mix_deploy_order.page.24.16e31d15xthwvl&id=79518224&envId=2592006](https://cd.aone.alibaba-inc.com/ec/app/167353/deploy/order?spm=a2o8d.mix_deploy_order.page.24.16e31d15xthwvl&id=79518224&envId=2592006)\n+ **变更级别：**\n    - [ ] 高危\n    - [ ] 重大\n    - [x] 一般变更\n\n**〖关注点1〗****测试阶段**\n\n+ **测试内容：火车票推荐流程**\n+ **测试人员： 熊维远**\n+ **是否经过测试验证**\n    - [x] 是，验证环境\n        - [x] 预发环境\n        - [ ] 日常环境\n+ **测试未发现原因是什么？后续如何改进？**\n    - [x] 其他原因说明：预发环境未出现错误\n\n**〖问题总结〗**\n\n**只在预发进行了自测，没有在安全生产验证**\n\n**〖改进点〗**\n\n核心应用都要找测试走流程验证\n\n**",
    "chunk_order_index": 1,
    "full_doc_id": "doc-69f274dd6a03c16d94ecaaad88229b58"
  },
  "chunk-b65c83699b7da9f3030aa136ffb90067": {
    "tokens": 749,
    "content": "- [x] 是，验证环境\n        - [x] 预发环境\n        - [ ] 日常环境\n+ **测试未发现原因是什么？后续如何改进？**\n    - [x] 其他原因说明：预发环境未出现错误\n\n**〖问题总结〗**\n\n**只在预发进行了自测，没有在安全生产验证**\n\n**〖改进点〗**\n\n核心应用都要找测试走流程验证\n\n**〖关注点2〗灰度阶段   **** --灰度流程是否涉及**\n\n+ **是否经过灰度：**\n    - [x] 是\n    - [ ] 否\n\n**〖关注点3〗****上线阶段**\n\n+ **是否分批发布**\n    - [ ] 是\n        * 分批数量：\n        * 前两批间隔时长：\n    - [x] 否\n+ **是否有确定的监控观测指标**\n    - [x] 是\n    - [ ] 否\n+ **是否在窗口期进行发布变更**\n    - [x] 是\n    - [ ] 否，原因：\n+ **变更是否影响上下游**\n    - [x] 是\n    - [ ] 否\n+ **是否提前知会上下游评估及关注变更**\n    - [ ] 是\n    - [x] 否\n\n### 4.2【处置能力】\n#### 4.2.1 故障发现&响应\n+ **是否监控发现**\n    - [x] 是\n        - [x] 故障触发方\n        - [ ] 受影响方\n    - [ ] 否 ：****\n+ **发现后是否五分钟内响应**\n    - [x] 是\n    - [ ] 否，原因为：\n\n**〖问题总结〗**\n\n**〖改进点〗**\n\n#### 4.2.2 故障定位&恢复\n+ **故障涉及恢复方式：**\n    - [ ] 代码发布\n    - [x] 代码回滚\n    - [ ] 配置回滚\n    - [ ] 隔离\n    - [ ] 扩容\n    - [ ] 重启\n    - [ ] 限流\n    - [ ] 降级预案\n    - [ ] 自动恢复\n    - [ ] 其他\n\n## 六、故障Action\n| **ACTION** | **计划完成时间** | **Action负责人** |\n| --- | --- | --- |\n| f-ins-rec 应用配置第一批强制等待时间 | 6.9 | 栀芊 |\n| 推荐主流程里 order bugfix，排除潜在隐患 | 6.13 | 牧熵 |\n| 非核心应用 bu 维度加强卡点 | 已完成 | 龙幽 |\n| 与消息无关的应用，预发测试优先使用项目环境，操作指南与宣讲 | 6.15 | 栀芊 |\n| 非核心应用的核心场景加入自动化测试 | 0616 |  [@栀芊](undefined/hongxia.khx) |\n| 飞猪应用接入无人值守，核心应用检查是否有遗漏，各业务线统计需要接入到非核心场景 | 0630 | 马达 |\n| 故障场景目前已订阅到大群，需安排演练 | 0616 | 马达、徙南 |\n| 加强团队内部发布流程宣导 | | |",
    "chunk_order_index": 2,
    "full_doc_id": "doc-69f274dd6a03c16d94ecaaad88229b58"
  },
  "chunk-da4be0c3b2e83184f7c78ee46869103b": {
    "tokens": 1200,
    "content": "### 一、故障简述\n[_APM故障链接_](https://tr.alibaba-inc.com/ormFailure/workbench/failure/2023032800000001001?activeTabKey=timeline&__tenant__=alibabaGroup)\n\n【P2】【飞猪】0328零点飞猪运营配置焦点图更新，由于配置信息错误，其次Android保护不全发生崩溃，上午8:00人工反馈Android系统几个版本出现闪退，于8:30分配置回滚后首页崩溃问题解决；10:40分酒店首页配置回滚，10:50分回滚完成后故障止血。\n\n### 二、故障过程回顾\n#### 【1-5-10概览】\n![画板](https://intranetproxy.alipay.com/skylark/lark/0/2023/jpeg/49273/1679976705666-da9d6dd0-ac08-4c72-a190-45f4657cafd5.jpeg)\n\n#### 【故障处理时间线】\n开发文档：[https://yuque.alibaba-inc.com/fliggy_app/kvf1gg/honl3f72na0zka6b?singleDoc#ddwoj](https://yuque.alibaba-inc.com/fliggy_app/kvf1gg/honl3f72na0zka6b?singleDoc#ddwoj)\n\n【故障发生】2022-03-28 00:00，运营事先配置的定时策略上线，因策略配置了错误的模板，服务端下发不同于约定的数据格式，安卓端缺少对此类异常情况的兜底保护，崩溃发生。[_引起故障的配置链接_](https://magic-plan.alibaba-inc.com/#/trip-crm/plan/plan-detail?planId=15347&strategyId=44418&type=0)\n\n【故障发现】【业务响应】2022-03-28 07:56，基础线同学查看崩溃列表时发现问题，相关同学跟进。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/40556426/1679981225198-abb0516c-08bd-4f22-92d8-32f3562acbc3.png)\n\n【初因定位】2022-03-28 08:10，查看用户日志定位下发数据格式错误，联系crm服务端同学下线对应错误配置。\n\n【故障恢复】2022-03-28 08:27，下线配置后，crash次数下降90%。\n\n【影响消除】2022-03-28 10:52，根据剩余crash信息排查到酒店有相同crash，配置下线后影响基本消除。另外由于首页缓存，剩余少量长尾crash用户会逐渐正常。\n\n【故障通告】2022-03-28 11:13  GOC收到报警，并故障通告：飞猪无线崩溃影响设备率（单端）>2%，触发P2故障，请相关人员立即上线处理故障，故障相关详细信息GOC正在收集确认，稍后更新，请知晓。\n\n[报警监控链接](https://g-mobile.alibaba-inc.com/ormMonitor/configuration/AlarmInfo/edit/sunfire_59_36331)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/46649/1679986571039-070ebdb2-0ac8-48ce-b1a7-c66bd5fe7c08.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/46649/1679986604892-57738987-f66e-4fa3-9ec5-8762737e36bc.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/180091/1679995794752-427ddd50-191b-48e3-803a-092c4603b417.png)\n\n\n\n### 三、影响产品线及影响面\n    - [x] 是否影响可用性（可用性指标，可用性时长消耗）\n        * app打开crash\n    - [ ] 业务影响：（影响的业务线，业务功能，功能受损程度（成功量/率下跌多少%），持续多少时间）\n        * \n    - [x] 是否有客诉量：（在线，热线，排队量）\n        * 1个客诉  [https://qlive.alitrip.com/voice_detail.htm?id=10525475](https://qlive.alitrip.com/voice_detail.htm?id=10525475)\n        * 3个工单：[https://tickets.alibaba-inc.com/goc-ticket/ticket/2022102800000809104](https://tickets.alibaba-inc.com/goc-ticket/ticket/2022102800000809104?spm=goc-apm.goc-ticket_ticketManage.0.0.5d0021c5i4gVvo&page=1)\n\n### 四、故障原因\n#### 4.1【一句话原因】\n运营配置错误模板，Android客户端缺少保护，监控失效\n\n#### 4.2【背景说明】\n    - 【需求背景】故障涉及到的新需求背景介绍\n\n在疫情场景，飞猪DAU有限的背景下，尽可能通过细化人群维度及需求",
    "chunk_order_index": 0,
    "full_doc_id": "doc-8133b83a30f95abd34e27fdfdc9f3367"
  },
  "chunk-b46150c74fd153ae205f901c5bf59fcb": {
    "tokens": 1200,
    "content": ".0.5d0021c5i4gVvo&page=1)\n\n### 四、故障原因\n#### 4.1【一句话原因】\n运营配置错误模板，Android客户端缺少保护，监控失效\n\n#### 4.2【背景说明】\n    - 【需求背景】故障涉及到的新需求背景介绍\n\n在疫情场景，飞猪DAU有限的背景下，尽可能通过细化人群维度及需求场景，通过实现资源位的千人千面能力提升资源与用户匹配度，实现活动流量和转化的提升\n\n    - 【业务链路】以业务连图的形式体现故障整体的链路图及根因节点\n\n\n    - 【变更背景】故障涉及的变更背景及变更内容\n因需求新增字利益点需要，在飞猪首页轮播图上增加主副标题和logo，服务端下发对应字段。\n\n#### 4.3【根因分析】\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/40556426/1679977321583-60a3f4d0-ee49-4156-9704-47336fe120aa.png)\n\n客户端解析title和subTitle字段，但是getJSONObject这个方法在解析字段时，若下发的格式不是json map时，会抛出异常，端上代码缺少对此异常场景的保护，导致了崩溃。\n\n### 五、故障关注点【确保以后同类问题可以得到解决】\n**一、系统质量**\n\n**1.1、需求&设计评估**\n\n**〖关注点1〗是否涉及产品方案评估？评估是否充分？是否存在系统架构设计、产品设计缺陷等设计方面问题？**\n\n【原因分析】产品方案未考虑到错误模板配置问题，且发布缺少足够的测试和灰度流程。\n\n\n**〖关注点2〗接到产品需求到技术方案产出的过程中，产品、技术侧是否进行风险评估，以及技术实现有无保障的手段与方案？**\n\n【原因分析】端侧缺少对错误配置的保护\n\n**【****需求设计相关的改进点****】**\n\n1. **模板需要有选择限制**：增加对模板支持的域的配置，在配置首页资源时，只能透出首页支持的模板，不支持的不透出。场景模版要做到高有效性判断，做到资源位和模板的规则匹配，并及时淘汰废旧模板等。平台侧增加配置拦截和运营自验证卡口。[@故昀](undefined/guyun.wcx) [@怀光](undefined/huaiguang.wbb)。\n2. 增加端侧首页投放**异常数据测试case覆盖**，加强case评审机制。长期建立CRM重点资源位的投放场景基于稳定性和可用性的自动化测试 [@影剑](undefined/yuanli.xyl)\n\n\n\n**1.2、编码问题**\n\n**〖关注点3〗是否经过CodeReview？是否发现问题？为何没发现？**\n\n【原因分析】经过CR，但没有发现问题，对异常情况考虑不足，缺少异常情况的保护\n\n**〖关注点4〗是否引入第三方组件？是否存在代码Bug或漏洞？**\n\n【原因分析】未引入第三方组件\n\n**〖关注点5〗是否经过预发验证？是否经过测试验收或测试回归？为什么没有回归发现？测试同学是否有接手测试？自动化是否能发现问题？测试遗漏的原因是什么（未测试验证、测试遗漏）？**\n\n【原因分析】有发到预发，但只验证了iOS一端，没有验证Android端。测试同学没有接手相关发布的测试。且没有灰度流程。\n【改进点】预发需要做充分验证，不只验证一端，增加灰度流程。\n\n**【****编码相关的改进点****】**\n\n1. **技术安全兜底检查**：增加对客户端json以及其他可能的异常情况的全量检查与保护 [@羡仙](undefined/xianxian.hwj) [@驱影](undefined/jike.yjk)，强化json使用在新员工培训，CR场景的要求意识，在组建化隔离的基础上，通过异常保护将数据错误产生的影响降到最低。\n\n****\n\n**1.3、变更执行**\n\n**〖关注点6〗关联的应用名？变更类型（配置or运维类），是否接入ChangeFree？是否有灰度功能？变更者是否做了灰度？**\n\n【原因分析】配置类变更，接入了changefree，无灰度，无观测\n\n**〖关注点8〗变更影响是否通知上下游业务？通知是否到位？**\n\n【原因分析】运营变更，无通知   \n\n**【****变更相关的改进点****】**\n\n1. **运营配置发布流程优化**：运营配置上线前，测试提供场景case集合，由运营自测保证。[@影剑](undefined/yuanli.xyl)\n2. **流程验证上强卡点：**如ios和安卓均需经过测试； [@影剑](undefined/yuanli.xyl)\n3. **上线前自动化任务**\n\n**二、故障处置**\n\n**2.1 故障发现**\n\n**〖关注点9〗是否监控发现？没有发现的原因是什么（监控未部署、监控平台异常、报警未",
    "chunk_order_index": 1,
    "full_doc_id": "doc-8133b83a30f95abd34e27fdfdc9f3367"
  },
  "chunk-32fea17519d121aabc8bd9d9dc6bcb10": {
    "tokens": 1197,
    "content": "。[@影剑](undefined/yuanli.xyl)\n2. **流程验证上强卡点：**如ios和安卓均需经过测试； [@影剑](undefined/yuanli.xyl)\n3. **上线前自动化任务**\n\n**二、故障处置**\n\n**2.1 故障发现**\n\n**〖关注点9〗是否监控发现？没有发现的原因是什么（监控未部署、监控平台异常、报警未及时关注或处理、监控无效、其他）？**\n\n【原因分析】没有监控发现，因为监控失效。报警策略是使用最近3个版本的崩溃率，但是最近三个版本号取错了。\n【改进点】增加对最新版本的自动化验证\n\n**〖关注点10〗GOC为什么11点多才通告，监控报警晚的原因？**\n\n是根据最新3个版本的总量崩溃率达到标准， 最近mtl3的查询最近3个版本号的接口出了错误，我们拿到的3个版本不是最新的，导致没有算对崩溃率\n\n**【****故障发现的改进点****】**\n\n1. **监控**：监控版本**有效性验证**，如果出错，可以改为全量稳定性监控；goc核心监控处理人定期更新，若发生人员变动及时更新。[@忱浠](undefined/tengai.mta) \n2. **客户端稳定性日常监控和预警**, 针对客户端基础，和多业务场景，统一确认高可用的日常监控，和风险预警能力。[@立宝](undefined/libao.clb) [@旅鹤](undefined/lvhe.zc)\n3. **增加客户端首页重要资源位的业务监控**[@允迪](undefined/tingmeng.ytm)\n\n**2.3、故障恢复**\n\n下线引起故障的配置，配置回滚恢复\n\n\n\n**【****故障处置的改进点****】**\n\n**产品能力优化**\n\n1. **模板需要有选择限制**：增加对模板支持的域的配置，在配置首页资源时，只能透出首页支持的模板，不支持的不透出。场景模版要做到高有效性判断，做到资源位和模板的规则匹配，并及时淘汰废旧模板等。平台侧增加配置拦截和运营自验证卡口。[@故昀](undefined/guyun.wcx) [@怀光](undefined/huaiguang.wbb)。\n2. 增加端侧首页投放**异常数据测试case覆盖**，加强case评审机制。长期建立CRM重点资源位的投放场景基于稳定性和可用性的自动化测试。 [@影剑](undefined/yuanli.xyl)\n3. **客户端稳定性定期演练**，核心是app crash和核心可用性故障监控，监控体系升级到mtl4、大促前做有效性演练（包括报警触发、处理人 和 处理过程）[@忱浠](undefined/tengai.mta)\n\n**编码类：**\n\n4. **技术安全兜底检查**：增加对客户端json以及其他可能的异常情况的全量检查与保护 [@羡仙](undefined/xianxian.hwj) [@驱影](undefined/jike.yjk)，强化json使用在新员工培训，CR场景的要求意识，在组建化隔离的基础上，通过异常保护将数据错误产生的影响降到最低。\n5. **系统有效性检查：**在安全稳定性监控和发布领域，全面检查mtl3的接口遗留，使用mtl4进行替换。[@立宝](undefined/libao.clb) [@旅鹤](undefined/lvhe.zc) [@忱浠](undefined/tengai.mta)\n\n**变更类**\n\n6. **人员敏感度**：运营配置上线前，测试提供场景case集合，由运营自测保证。[@影剑](undefined/yuanli.xyl)\n7. **配置变更流程验证上强卡点：**如ios和安卓均需经过测试；331完成方案设计和排期，初步预计4.15完成 [@影剑](undefined/yuanli.xyl)\n8. **配置变更上线前自动化任务。**自动验证方案330已确认，初步预计415** **[@影剑](undefined/yuanli.xyl)\n\n**监控类**\n\n9. **监控类**：监控版本有效性验证，如果出错，可以改为全量稳定性监控；goc核心监控处理人定期更新，若发生人员变动及时更新。[@忱浠](undefined/tengai.mta)\n10. **客户端稳定性日常监控和预警**, 针对客户端基础，和多业务场景，统一确认高可用的日常监控，和风险预警能力。[@立宝](undefined/libao.clb) [@旅鹤](undefined/lvhe.zc)\n11. **增加客户端首页重要资源位的业务监控**[@允迪](undefined/tingmeng.ytm)\n\n**长期动作**\n\n12. **客户端全局安全模式**，架构和产品设计先行确认，在频繁Crash场景下，具备报警，自恢复能力建设。[@立宝](undefined/libao.clb) [@旅鹤](undefined/lvhe.zc)",
    "chunk_order_index": 2,
    "full_doc_id": "doc-8133b83a30f95abd34e27fdfdc9f3367"
  },
  "chunk-0f5e1233dcb78f6064bbcd8ebc91aadf": {
    "tokens": 97,
    "content": "旅鹤](undefined/lvhe.zc)\n11. **增加客户端首页重要资源位的业务监控**[@允迪](undefined/tingmeng.ytm)\n\n**长期动作**\n\n12. **客户端全局安全模式**，架构和产品设计先行确认，在频繁Crash场景下，具备报警，自恢复能力建设。[@立宝](undefined/libao.clb) [@旅鹤](undefined/lvhe.zc)",
    "chunk_order_index": 3,
    "full_doc_id": "doc-8133b83a30f95abd34e27fdfdc9f3367"
  },
  "chunk-4788352b6d6f828ec106c8d36d6eb75e": {
    "tokens": 1200,
    "content": "## 一、故障概述（含影响产品线及影响面）\n**故障概述：**\n\n2023-03-13 18:38 商旅/商旅首页/失败量最近10分钟最小值大于等于40且成功率最近10分钟最大值小于60%，触达P3故障等级。初步定位为飞书部门增量同步时查询企业全量部门到内存触发fullgc,且DB因慢sql性能下降，影响btms服务质量，导致前置选人页成功率下跌。sql限流后，于19:41故障恢复。\n\n**影响面：**\n\n    - 是否影响可用性**：****；**\n    - **业务影响：**\n    - 欢行跳转到商旅的搜索预订（酒店、机票）列表页无法展示\n    - 前置税费、导购等受到影响\n    - 问题反馈群有用户反馈。\n    - 是否有客诉量（在线，热线，排队量）：\n    - 是否有社会舆情：无\n    - 是否产生资损：无\n\n## 二、故障过程回顾【故障处理时间线】\n### 【1-5-10概览】\n![画板](https://intranetproxy.alipay.com/skylark/lark/0/2022/jpeg/3536/1664281997005-b98bc6b2-4078-4961-9951-eae343abe2ee.jpeg)\n\n### 【故障处理时间线】\n整体故障时间线。需要着重强调【故障注入】【故障发生】【故障发现】【业务响应】【故障定位】【恢复执行】【故障恢复】时间点。\n\n2023-03-13 18:38:49 飞书企业【组织机构（lark3ex8axjk2g0x230h）】开始增量同步部门【故障注入】\n\n2023-03-13 18:56:00 中间页成功率开始低于60%\n\n2023-03-13 18:58:00 商旅故障场景风险预警群 发出前置出行人和费控选择页 风险预警【故障发现】\n\n2023-03-13 19:01:00 兰摧重启机器（33.4.239.22 33.4.191.176 33.42.173.81），四台机器重启等了十分钟没反应\n\n2023-03-13 19:05:30 零卡执行SQL限流：\n\n限流规则：SELECT~AS~QUERYID~id~gmt_create~gmt_modified~org_depart_id~depart_id~depart_pid~depart_name~manager_ids~manager_names~corp_id~corp_name~status~level_relation_mask~out_depart_id~out_depart_pid~depart_level_relation~out_depart_level_relation~mask_update_status~FROM~btrip_department~WHERE~corp_id\n\n最大并发度：10\n\n开始时间&结束时间：2023年3月13日 19:05:30 ~ 2023年3月13日 19:07:08\n\n2023-03-13 19:06 中间页成功率开始低于60%持续10分钟【故障发生】\n\n2023年3月13日 19:07:11 零卡执行SQL限流：【恢复执行】【故障恢复】\n\n限流规则：SELECT~AS~QUERYID~id~gmt_create~gmt_modified~org_depart_id~depart_id~depart_pid~depart_name~manager_ids~manager_names~corp_id~corp_name~status~level_relation_mask~out_depart_id~out_depart_pid~depart_level_relation~out_depart_level_relation~mask_update_status~FROM~btrip_department~WHERE~corp_id\n\n最大并发度：2\n\n开始时间&结束时间：2023年3月13日 19:07:11 ~ 2023年3月13日 19:12:15\n\n## 三、故障影响面\n### 1.影响范围\n影响企业数：412\n\n### 2.影响时间\n2023-03-13 18:38 ~ 2023-03-13 19:41\n\n## 四、故障原因\n### 一句话原因\n飞书部门增量同步时查询企业全量部门到内存触发fullgc，且DB因慢sql性能下降，影响btms服务质量，导致前置选人页成功率下跌；\n\n### 背景\n飞书企业部门变更后会触发部门增量同步，为了计算部门关联关系，应用会把企业全量部门查询到内存中，飞书企业 组织机构（lark3ex8axjk2g0x230h）部门数量超过50万，这些部门查询到应用后触发fullgc，导致HSF服务质量下降，影响前置选人页成功率；\n\n### 故障原因\n飞书企业 组织机构（lark3ex8axjk2g0x230h）从 03-13 18:38:49 开始增量同步部门：\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/114897/1678786730899-7b055eb1-c4f5-44e0-8796-acfac8d73986.png)\n\n同步次数：\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/114897/1678932497287-167fd6",
    "chunk_order_index": 0,
    "full_doc_id": "doc-be8a53726240bd40d50ce6eacb5729dd"
  },
  "chunk-25403124c1984fc45b9acfc3fdfd693e": {
    "tokens": 1200,
    "content": "49 开始增量同步部门：\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/114897/1678786730899-7b055eb1-c4f5-44e0-8796-acfac8d73986.png)\n\n同步次数：\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/114897/1678932497287-167fd6a0-06b3-419b-85c7-e24b20f03a8e.png)\n\n\n\n每触发一次部门同步会把该企业全量部门查询到内存中（部门数量大于50万），执行同步逻辑的机器会发生fullgc：\n\n\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/114897/1678786932881-2cfdcd23-737f-406f-a570-d690b666def1.png)\n\n\n\nfullgc后hsf服务质量下降，rt增加，hsf线程池线程数量增加：\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/114897/1678787021202-b8e94e19-40e8-45e2-b6fe-190bedc3c71e.png)![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/114897/1678787034171-a3fb67c8-8f90-416d-8ee0-86a7b991c497.png)\n\n\n\n处理飞书部门增量同步次数越多的机器fullgc越严重：\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/114897/1678787616077-d9a2ec64-f66a-4340-86e1-727ba1ac0b45.png)\n\n\n\nbtriphome前置选人页依赖btms，btms HSF rt增加导致超时、部分机器HSF线程池满导致HSF调用失败，导致置选人页成功率下跌：\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/114897/1678787657038-e558afd0-0277-438f-a9f9-00438b41c92d.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/114897/1678787675160-123da824-50c5-40c7-a953-589e385a4132.png)\n\n\n\n\n\n## 四、故障关注点\n\n\n### 4.1【系统质量】\n#### 4.1.1 需求&设计评估\n**〖关注点1〗****是否涉及产品、技术方案评估？此核心的问题是什么，如何改进？**\n\n- [x] **是，涉及**\n    - [ ] 需求评估遗漏\n    - [ ] 产品设计缺陷\n    - [x] 系统架构设计缺陷\n        - [x] 容错性不足 \n\n\n\n**〖问题总结〗**\n\n**优化代码**\n\n#### 4.1.2  代码质量\n**〖关注点1〗是否代码自身存在漏洞或BUG、代码健壮性是否存在问题等?**\n\n**〖问题分析〗代码存在一次性查询企业所有部门的漏洞**\n\n**〖改进点〗飞书通讯录同步逻辑中一次性查询企业所有部门场景梳理，只查询必要的和同步数据关联的部门数据**\n\n****\n\n**〖关注点2〗****是否经过CodeReview？CodeReview阶段是否发现问题？为何没发现？**\n\n+ **是否经过CR**\n    - [x] 是\n    - [ ] 否\n    - [ ] 不涉及\n+ **是否设置合理的CR卡点**\n    - [x] 是\n    - [ ] 否\n    - [ ] 不涉及\n    - [CR卡点设置要求](https://ata.alibaba-inc.com/articles/225396?spm=ata.25287382.0.0.5e0c7536X43l05)\n+ **CR人员：**\n+ **CR时长：**\n+ **CodeReview阶段是否发现问题？为何没发现？后续如何发现？**\n    - [ ] 是\n    - [x] 否\n\n**〖问题分析〗**\n\n**〖改进点〗**\n\n#### 4.1.3 变更质量\n+ **是否涉及变更：**\n    - [x] 是\n    - [ ] 否\n+ **变更类型：**\n    - [ ] 代码发布\n    - [ ] 配置变更\n    - [x] 其他变更：飞书企业开通阿里商旅，变更通讯录，触发通讯录全量同步、部门增量同步\n    - [ ] 不涉及\n+ **变更平台是否接入ChangeFree：**\n    - [ ] 是，CF变更单链接：\n    - [x] 否\n+ **变更内容：**_****_\n    - [ ] 变更执行人: \n    - [ ] 变更系统：\n    - [x] 变更对象：飞书企业\n+ **测试未发现原因是什么？后续如何改进？**\n    - [x] 回归遗漏\n        - [ ] 手工回归case遗漏\n        - [ ] 自动化未建设",
    "chunk_order_index": 1,
    "full_doc_id": "doc-be8a53726240bd40d50ce6eacb5729dd"
  },
  "chunk-7c9fade049827627c1774e225c00665b": {
    "tokens": 472,
    "content": "单链接：\n    - [x] 否\n+ **变更内容：**_****_\n    - [ ] 变更执行人: \n    - [ ] 变更系统：\n    - [x] 变更对象：飞书企业\n+ **测试未发现原因是什么？后续如何改进？**\n    - [x] 回归遗漏\n        - [ ] 手工回归case遗漏\n        - [ ] 自动化未建设\n        - [ ] 自动化回归覆盖不足\n        - [x] 性能影响评估不足\n\n\n\n### 4.2【处置能力】\n#### 4.2.1 故障发现&响应\n+ **是否监控发现**\n    - [x] 是\n        - [x] 故障触发方\n        - [ ] 受影响方\n    - [ ] 否 ：****\n+ **发现后是否五分钟内响应**\n    - [x] 是\n\n#### 4.2.2 故障定位&恢复\n+ **故障涉及恢复方式：**\n    - [ ] 代码发布\n    - [ ] 代码回滚\n    - [ ] 配置回滚\n    - [x] 隔离\n    - [ ] 扩容\n    - [x] 重启\n    - [x] 限流\n    - [ ] 降级预案\n    - [ ] 自动恢复\n    - [ ] 其他\n\n## 五、故障Action\n| **ACTION** | **计划完成时间** | **Action负责人** |\n| --- | --- | --- |\n| 通讯录风险点优化[https://aliyuque.antfin.com/btrip/pgof4n/an30rsuov2umwnkk?singleDoc#](https://aliyuque.antfin.com/btrip/pgof4n/an30rsuov2umwnkk?singleDoc#) 《通讯录同步风险点优化方案》 | 已完成 |  |\n| 梳理故障场景依赖的btms HSF服务，对DB依赖降级 | 0331 | 汀夜 |\n| 长期方案：系统改造 | 0428 | 汀夜 |",
    "chunk_order_index": 2,
    "full_doc_id": "doc-be8a53726240bd40d50ce6eacb5729dd"
  },
  "chunk-0654799ec9f01c6bf2987eec91c19fd9": {
    "tokens": 1200,
    "content": "## 一、故障概述（含影响产品线及影响面）\n**故障概述：**\n\n2023-02-15 14:00开始，商旅/商旅首页/失败量最近10分钟最小值大于等于20，且成功率最近10分钟最大值小于80%，触达P4。原因初步判断为慢sql执行导致btms一台机器负载打满，sql限流后，于14:11恢复\n\n**影响面：**\n\n    - 是否影响可用性**：****；**\n    - **业务影响：**后台查询员工有差标，预订酒店时显示无差标\n        * ![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/39701/1676863838222-b769de2b-2836-48a7-a863-11fc2497c0dd.png)\n    - 是否有客诉量（在线，热线，排队量）：02月15日6个工单  + 02月16日6个工单 \n    - 是否有社会舆情：无\n    - 是否产生资损：无\n\n## 二、故障过程回顾【故障处理时间线】\n### 【1-5-10概览】\n![画板](https://intranetproxy.alipay.com/skylark/lark/0/2022/jpeg/3536/1664281997005-b98bc6b2-4078-4961-9951-eae343abe2ee.jpeg)\n\n### 【故障处理时间线】\n整体故障时间线。需要着重强调【故障注入】【故障发生】【故障发现】【业务响应】【故障定位】【恢复执行】【故障恢复】时间点。\n\n\n\n【故障注入】\n【故障发现】2023-02-15 14:03  接到风险预警，技术汀夜介入排查问题原因\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/39701/1676860996944-45657cb5-63bd-46ba-b6cb-4dade33b92d9.png)\n\n2023-02-15 14:09 零卡定位到tripicp应用数据库问题，执行阻塞会话kill操作\n\n【故障定位】2023-02-15 14:09 通过分析定位到问题原因是CPU飙升，导致RT上涨，导致应用链接池满，进而导致我们这边业务阻塞，hsf超时\n【故障发生】2023-02-15 14:10 触发高可用场景，GOC监控值班拉起应急。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/39701/1676865101846-abdb3493-bf03-459d-ad5e-c3703f18777f.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/39701/1676865022283-48ec8520-b8fa-43f8-be1e-f893b473c156.png)\n\n【业务响应】\n【恢复执行】2023-02-15 14:10 箩航发现btms应用有一台机器线程池满了，并对这台机器进行了服务下线。\n\n     同时零卡定位到tripicp应用数据库问题，执行阻塞会话kill操作，对高频慢SQL进行限流操作。\n\n【故障恢复】2023-02-15 14:11 故障恢复。\n\n\n\n详细处理过程：[https://aliyuque.antfin.com/btrip/nwgf51/cplfchbsfvw2zrq0?singleDoc#](https://aliyuque.antfin.com/btrip/nwgf51/cplfchbsfvw2zrq0?singleDoc#)\n\n## 三、故障影响面\n工单数：02月15日6个工单  + 02月16日6个工单  \n\n影响的企业：\n\n|  | 企业ID | 企业名称 | 备注 |\n| --- | --- | --- | --- |\n| 02-15 | isv_platformt81slugn0yf1i740 | 成都倍特药业股份有限公司 |  |\n| | isv_platformy39btzcqpccmgagv | 北京高思博乐教育科技股份有限公司 |  |\n| | isv_platformwddsr9g8w2ex7ovo | 中建投租赁股份有限公司 |  |\n| | ding8c82d04d16c4fd74 | 广东林氏家居股份有限公司 |  |\n| | ding5d65887c2597d26335c2f4657eb6378f | 深圳市博盛医疗科技有限公司 |  |\n| | ding1d40b3f60dc14118 | 北京航天泰坦科技股份有限公司 |  |\n| | isv_platformiftgfjj6esag3p89 | 深圳齐心好视通云计算有限公司 |  |\n| | ding0612920767699e26 | 申通快递有限公司 |  |\n| 02-16 | larkah5pfl803sinvwd8 | 瑞声光电科技（常州）有限公司 |  |\n| | ding8c82d04d16c4fd74 | 广东林氏家居股份有限公司 |  |\n| | ding2293f1a632df509635c2f4657eb",
    "chunk_order_index": 0,
    "full_doc_id": "doc-bdbcb4a7b7ada3f69673abb02e1b57e1"
  },
  "chunk-bac4b348a68ecb5c95068e9c8f2c082e": {
    "tokens": 1200,
    "content": "通云计算有限公司 |  |\n| | ding0612920767699e26 | 申通快递有限公司 |  |\n| 02-16 | larkah5pfl803sinvwd8 | 瑞声光电科技（常州）有限公司 |  |\n| | ding8c82d04d16c4fd74 | 广东林氏家居股份有限公司 |  |\n| | ding2293f1a632df509635c2f4657eb6378f | 上海朵艺家具有限公司 |  |\n| | ding352b5ea3c3fa0edff5bf40eda33b7ba0 | 励元科技(上海)有限公司 |  |\n| | ding4cc9e6e0a759855235c2f4657eb6378f  | 北京微步在线科技有限公司 |  |\n| | isv_platform22guv2ggh0r3nk9y | 上海合合信息科技股份有限公司 |  |\n| | dingd472b05babca489f | 南京天创电子技术有限公司 |  |\n| | ding1607db571c65fd49ee0f45d8e4f7c288 | 广州优谷信息技术有限公司 |  |\n\n\n# \n## 四、故障原因\n### 4.1【一句话原因】\n\n\n商旅前端流量增大，tripicp应用没有做限流控制，大量的SQL打到数据库层，最终导致DB的CPU跑满\n\n### 4.2【背景说明】\n_/* 根据实际情况，选择填写下面的内容 */_\n\n\n\n### 4.3【根因分析】\n+ 故障发生时商旅前端流量增大，tripicp应用没有做限流控制，服务com.alitrip.tripicp.service.SubjectTagServiceImpl#getSubjectTags被大量调用，大量的SQL打到数据库层，最终导致DB的CPU跑满\n\n:::color2\n酒店导购列表页对资源管控相关的模块通过标签进行管理，每次用户请求会发起6次getSubjectTags的调用，随着近期流量的不断增加，同时getSubjectTags的接口SQL是一个JOIN三张表的复杂SQL，即使主表走了索引，也带来了一次SQL扫描6000+行的数据，在高并发的情况下触发CPU100%\n\n:::\n\n+ 数据库CPU飙升，导致RT上涨，导致应用链接池满，进而导致我们这边业务阻塞，hsf超时\n\n**临时解决方案：**\n\n+ tripicp数据库增加sql模版限流\n+ 服务对应业务根据实际业务对数据的实效性要求对数据增加缓存，降低tripicp服务调用量\n\ncom.alitrip.tripicp.service.SubjectTagServiceImpl#getSubjectTags是一个简单的IO操作，主要压力堆积到数据库层，由于这个sql扫描的行数比较多（扫描行数>6000），当并发高的时候，对系统的影响比较大，数据库CPU飙升\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/47856365/1676700324282-a4c99724-7498-44bd-aebe-c714381ec40a.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/47856365/1676708232533-cf032386-c52c-4d5c-9759-f92d912c1b52.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/47856365/1676711212325-670467fb-eb04-4d0a-8406-cd713c04a0ce.png)\n\n**扫描行数计算公式 **\n\n> 总行数 = a表过滤数据条数 * b表过滤数据条数 + b表过滤数据条数*c表过滤数据条数+ b表过滤数据条数*d表过滤数据条数\n>\n\n## \n\n\n## 四、故障关注点\n\n\n1、**数据库查询语句不符合规范**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/47856365/1676711979541-cf4db7a3-6790-4a55-a554-6c92255f5994.png)\n\n\n\n**2 tripicp 应用监控(ateye监控和sunfire监控)**\n\ntripicp hsf服务异常监控到（ateye的异常大盘没有收集到tripicp的hsf异常，商旅业务线下所有应用都有hsf异常监控告警）\n\ntripicp磁盘使用率100%没有感知到\n\n\n\n**3 tripicp 应用日志打印不合理 **\n\n日志重复打印（同时写了application和控制台日志）\n\n大量打印参考意义不大的日志（对于没有业务逻辑查询可以有选择的打印日志）\n\nCatalina日志没有打印（不利于应用启动失败问题定位）\n\n\n\n**4 trip_icp数据库监控没有覆盖**\n\ntrip_icp库CPU飙升没有感知到\n\n\n\n**5 tripicp应用没有接入限流**\n\n流量飙升时没有办法触发应用的自我保护\n\n\n\n**6 变更分支上线操作不符合规范**\n\n预发验证时没有用例覆盖不全\n\n对当时的情况判断失误，上线发布时没有等待观察上线情况\n\n## 五、故障Action\n| **ACTION** | **计划完成时间**",
    "chunk_order_index": 1,
    "full_doc_id": "doc-bdbcb4a7b7ada3f69673abb02e1b57e1"
  },
  "chunk-623b8dd9c5da3cd614ee5b3200b198c9": {
    "tokens": 409,
    "content": "trip_icp库CPU飙升没有感知到\n\n\n\n**5 tripicp应用没有接入限流**\n\n流量飙升时没有办法触发应用的自我保护\n\n\n\n**6 变更分支上线操作不符合规范**\n\n预发验证时没有用例覆盖不全\n\n对当时的情况判断失误，上线发布时没有等待观察上线情况\n\n## 五、故障Action\n| **ACTION** | **计划完成时间** | **Action负责人** |\n| --- | --- | --- |\n| tripicp应用接入sentinel&评估我们自己的应用的可用范围，限流配置 | 2月16号已完成 | 伊莀 |\n| 酒店优化资源管理逻辑(新增缓存) | 已完成 | 恢宏/庐月 |\n| tripicp服务增加缓存 | 0221 | 伊莀 |\n| getSubjectTags接口SQL优化 | 0223 | 伊莀 |\n| 梳理完成tripicp相关被核心应用依赖的接口及场景，并完善监控配置 |  | 伊莀 |\n| tripicp应用日志优化（中间件、ateye的监控） | | 伊莀 |\n| 商旅选人中间页强弱依赖服务梳理，故障预案整理 | | 汀夜 |\n| 商旅应用接入sentinel | | 星奕、箩航 |\n| 数据库监控 | | 箩航、零卡 |\n\n\n前期由于回滚后更新了jar包依赖导致预发环境tripicp-client的jar包编译异常，同时预发和日常环境的构建机对正式版本的jar包(错误的包)进行了缓存，进而导致预发环境机器一直部署失败，最后更新tripicp-client的jar包版本后解决问题 [@徙南](undefined/kaibo.skb)",
    "chunk_order_index": 2,
    "full_doc_id": "doc-bdbcb4a7b7ada3f69673abb02e1b57e1"
  },
  "chunk-33dad50a029994fc8fdbda664d4c306f": {
    "tokens": 1200,
    "content": "## 一、故障概述（含影响产品线及影响面）\n**故障概述：**\n\n2023-01-26 22:45开始，飞猪支付成功消息成功量持续10分钟跌零，触达P3，初步判断故障原因为磁盘利用率过高导致load 过高，导致 jvm crash，重启服务机器后于23:05冲高恢复。本次故障涉及26笔订单履约，但后续均重试成功。\n\n**影响面：**\n\n    - 是否影响可用性**：**是**；**\n    - **业务影响：**\n        * ![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/39701/1675044762354-48b9e627-5981-450c-a366-a829a074eb95.png)\n    - 总计影响44次支付成功的履约处理，去重后涉及26笔订单。但因为支付成功履约处理会重试，通过数据分析发现，这26笔订单都通过重试成功了，**最终实际在支付成功阶段影响了0笔订单**。\n\n```sql\nSELECT \nSPLIT_PART(content, '|', 1) AS logTime,\nSPLIT_PART(content, '|', 4) AS orderId,\nSPLIT_PART(content, '|', 6) AS errMsg,\nSPLIT_PART(content, '|', 7) AS ret\nFROM \ntrip_vacation.s_tt_tfc_eticket_monitor_log_tt4\nWHERE \nds = '20230126'\nAND SPLIT_PART(content, '|', 3)= 'paiddone monitor'\nAND 'false' = SPLIT_PART(content, '|', 7)\nAND SPLIT_PART(content, '|', 1)  > '2023-01-26 22:40:00'\nAND SPLIT_PART(content, '|', 1)  < '2023-01-26 23:04:00'\nAND SPLIT_PART(content, '|', 6) = 'triptp查询订单异常'\n```\n\n\n\n影响支付成功履约处理的次数一共44次。\n\n| logtime | orderid | errmsg | ret |\n| --- | --- | --- | --- |\n| 2023-01-26 22:45:02 | 1802213616702768580 | triptp查询订单异常 | false |\n| 2023-01-26 22:45:29 | 3168006265910434135 | triptp查询订单异常 | false |\n| 2023-01-26 22:45:41 | 3167196372387581909 | triptp查询订单异常 | false |\n| 2023-01-26 22:47:07 | 3168008893044601147 | triptp查询订单异常 | false |\n| 2023-01-26 22:48:18 | 1802213616702768580 | triptp查询订单异常 | false |\n| 2023-01-26 22:48:44 | 3168006265910434135 | triptp查询订单异常 | false |\n| 2023-01-26 22:49:06 | 3167196372387581909 | triptp查询订单异常 | false |\n| 2023-01-26 22:52:40 | 3164409685601675418 | triptp查询订单异常 | false |\n| 2023-01-26 22:53:15 | 3163803516777734248 | triptp查询订单异常 | false |\n| 2023-01-26 22:56:12 | 3168007093397616437 | triptp查询订单异常 | false |\n| 2023-01-26 22:57:59 | 3168007093397616437 | triptp查询订单异常 | false |\n| 2023-01-26 22:59:26 | 3168006265910434135 | triptp查询订单异常 | false |\n| 2023-01-26 22:59:40 | 1802213616702768580 | triptp查询订单异常 | false |\n| 2023-01-26 23:00:58 | 1801521876554037086 | triptp查询订单异常 | false |\n| 2023-01-26 23:01:36 | 3168007093397616437 | triptp查询订单异常 | false |\n| 2023-01-26 23:01:39 | 3168007093399616437 | triptp查询订单异常 | false |\n| 2023-01-26 23:03:22 | 3167196372387581909 | triptp查询订单异常 | false |\n| 2023-01-26 23:03:45 | 3165617736280037301 | triptp查询订单异常 | false |\n| 2023-01-26 23:03:50 | 1802282774454152970 | triptp查询订单异常 | false |\n| 2023-01-26 23:03:49 | 1802240077547157870 | triptp查询订单异常 | false |\n| 2023-01-26 22:40:27 | 1802939667677462394 | triptp查询订单异常 | false |\n| 2023-01-26 22:41:10 | 1802955866928403677 | triptp查询订单异常 | false |\n| 2023-01-26 22:41:16 | 316854",
    "chunk_order_index": 0,
    "full_doc_id": "doc-8830c91c003c64367e425fa1d57786fd"
  },
  "chunk-055bdad7910d7a1de5ef4c571cd651dc": {
    "tokens": 1200,
    "content": "| 1802240077547157870 | triptp查询订单异常 | false |\n| 2023-01-26 22:40:27 | 1802939667677462394 | triptp查询订单异常 | false |\n| 2023-01-26 22:41:10 | 1802955866928403677 | triptp查询订单异常 | false |\n| 2023-01-26 22:41:16 | 3168543567740332556 | triptp查询订单异常 | false |\n| 2023-01-26 22:41:09 | 3168545691234908729 | triptp查询订单异常 | false |\n| 2023-01-26 22:41:13 | 3167196948112342701 | triptp查询订单异常 | false |\n| 2023-01-26 22:41:30 | 1802955866928403677 | triptp查询订单异常 | false |\n| 2023-01-26 22:41:39 | 3168008137047223755 | triptp查询订单异常 | false |\n| 2023-01-26 22:41:38 | 3168264530913676365 | triptp查询订单异常 | false |\n| 2023-01-26 22:42:06 | 3168008893044601147 | triptp查询订单异常 | false |\n| 2023-01-26 22:42:30 | 3168008893044601147 | triptp查询订单异常 | false |\n| 2023-01-26 22:42:31 | 3168266258605126815 | triptp查询订单异常 | false |\n| 2023-01-26 22:42:37 | 3168266366502821905 | triptp查询订单异常 | false |\n| 2023-01-26 22:42:37 | 1802957342585435469 | triptp查询订单异常 | false |\n| 2023-01-26 22:42:59 | 1802920297949938687 | triptp查询订单异常 | false |\n| 2023-01-26 22:43:15 | 1802213616702768580 | triptp查询订单异常 | false |\n| 2023-01-26 22:43:14 | 3168268742162312037 | triptp查询订单异常 | false |\n| 2023-01-26 22:43:17 | 3168266546619105313 | triptp查询订单异常 | false |\n| 2023-01-26 22:43:38 | 3168006265910434135 | triptp查询订单异常 | false |\n| 2023-01-26 22:43:40 | 3167196372387581909 | triptp查询订单异常 | false |\n| 2023-01-26 22:43:40 | 1802213616702768580 | triptp查询订单异常 | false |\n| 2023-01-26 22:43:56 | 3168008893044601147 | triptp查询订单异常 | false |\n| 2023-01-26 22:43:56 | 3168006265910434135 | triptp查询订单异常 | false |\n| 2023-01-26 22:44:05 | 3167196372387581909 | triptp查询订单异常 | false |\n| 2023-01-26 22:44:38 | 1802900101704629986 | triptp查询订单异常 | false |\n\n\n涉及订单发生退款的订单  \n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/132849/1674752025325-dc46de81-ccff-4076-afd6-39df467d2460.png)\n\n了这3笔产生了正常退款，其余订单都正向交易正常：\n\n1802213616702768580 ——用车——用户发起退款无影响\n\n3168268742162312037 ——玩乐——用户发起退款无影响\n\n1802939667677462394 ——非电子票——用户发起退款无影响\n\n    - 是否有客诉量（在线，热线，排队量）：\n    - 是否有社会舆情：无\n    - 是否产生资损：无\n\n## 二、故障过程回顾【故障处理时间线】\n### 【1-5-10概览】\n![画板](https://intranetproxy.alipay.com/skylark/lark/0/2022/jpeg/3536/1664281997005-b98bc6b2-4078-4961-9951-eae343abe2ee.jpeg)\n\n### 【故障处理时间线】\n整体故障时间线。需要着重强调【故障注入】【故障发生】【故障发现】【业务响应】【故障定位】【恢复执行】【故障恢复】时间点。\n\n2023-01-25 22:56 已有机器开始挂掉【故障注入】\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/39701/1675045739929-b1bff73a-bb7e-4ee1-a35d-96b296d58ec2.png)\n\n2023-01-26 22:47 飞猪风险预警信息同步群报警【故障发现】\n\n![](https://intranetproxy.alipay.com/skyl",
    "chunk_order_index": 1,
    "full_doc_id": "doc-8830c91c003c64367e425fa1d57786fd"
  },
  "chunk-2a6f6dd5bf7caee31ab90629940e247d": {
    "tokens": 1200,
    "content": "掉【故障注入】\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/39701/1675045739929-b1bff73a-bb7e-4ee1-a35d-96b296d58ec2.png)\n\n2023-01-26 22:47 飞猪风险预警信息同步群报警【故障发现】\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/39701/1675045294887-a4a69633-f123-4d99-b66f-011e8fcc3901.png)\n\n2023-01-26 22:51 平台定位到行业triptp，服务不可用\n\n2023-01-26 22:52 排查ateye ，全链路日志，没有报错信息\n\n2023-01-26 22:55 于22:45开始，支付成功消息成功量持续10分钟跌零，触达P3【故障发生】\n\n2023-01-26 23:00 回薄应急群中响应【业务响应】\n\n2023-01-26 23:01 唤酒分两批重启triptp机器【恢复执行】\n\n2023-01-26 23:05 机器重启后成功率冲高恢复【故障恢复】\n\n2023-01-26 23:26 定位到机器磁盘满load升高，jvm crash【故障定位】\n\n\n\n\n## \n## 三、故障影响面\n### 影响订单下单量分析(未去除用户重试次数)\n1.26日全天，预下单(290)和生行业单 (26 + 113 = 140)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/25156516/1674750734140-6abdf386-6c55-4070-a17e-5b47d27e3265.png)\n\n1.26日10点40-11点04，创建订单328，\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/25156516/1674750270438-8d9de4d9-c3b7-4a93-8d61-a018b6d49c14.png)\n\n### 去除重试数据后影响用户信息\n| 类型 | 业务身份 | 影响用户 | 恢复后用户成功数 | 实际影响 |\n| --- | --- | --- | --- | --- |\n| 门票 | ali.china.trip.vacation.enjoy.ticket  | 59```plain 809380422,67648710,745957348, 57210220,291048130,889845500,3494485137,690944988,63377571,2780370156,589149835,788395063, 3334346411,906065166,744321189,2452903616,1969741963,53316347,2841583624,76391810,2017883541, 842237507,798202637,1089130739,2214036469335,885925076,179323821,3151239873,1638566223,559154203, 2326748217,827140663,1060760758,1653493149,710074149,1987569966,2411236432,1013784757,2760853326,45195039, 53871900,207631473,3466211097,150505283,17753161,1081225891,55955748,502765587,2653210847,2226906596, 294639125,670807273,356913792,2878632607,785762352,2209033733823,2351593329,85660277,808706601 ```  | 29```plain 150505283 710074149 2017883541 2452903616 2841583624 3466211097 2214036469335 53871900 589149835 1089130739 2326748217 2780370156 3334346411 63377571 85660277 356913792 885925076 1013784757 2411236432 17753161 67648710 294639125 798202637 76391810 559154203 670807273 842237507 1081225891 1653493149 ```  | 30 |\n| 周边游 | ali.china.trip.vacation.enjoy.local | 7776864734, 114178651, 379500137, 836923121, 2823670593, 844719796, 292626885 | 4379500137   2823670593   836923121   292626885 | 3 |\n| 电话卡 | ali.china.trip.vacation.line.phonecard | 1 |  | |\n\n\n根据门票和线路定义的故障等级均未触发相关故障告警\n\n# ![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/2756660/1675056550576-61a16318-6819-4304-81bb-684c3113e34c.png)\n# ![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/2756660/1675056470240-9781",
    "chunk_order_index": 2,
    "full_doc_id": "doc-8830c91c003c64367e425fa1d57786fd"
  },
  "chunk-d1fb6dd554594f228f93f717a73347f8": {
    "tokens": 372,
    "content": "未触发相关故障告警\n\n# ![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/2756660/1675056550576-61a16318-6819-4304-81bb-684c3113e34c.png)\n# ![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/2756660/1675056470240-9781b93c-fe61-4ba2-b00c-b25c2c118476.png)\n## 四、故障原因\n### 4.1【一句话原因】\n磁盘利用率过高导致load 过高，导致 jvm crash\n\n### 4.2【背景说明】\n### 4.3【根因分析】\n\n\n   机器磁盘日常清理的频率为3天一次，由于近期出境游暴涨，导致trip-trace.log日志大量膨胀，没到清理时间就引发了磁盘利用率过高，导致JVM crash。\n\n关于风险预警：基础指标只配置了cpu load 磁盘，磁盘告警当时没有打开（历史交接系统，告警关闭原因不可考），[hs](#)[f](#)在线率未配置，导致未能及时报警，最终触发P3等级\n\n## 五、故障Action\n1. 将triptp 磁盘利用率告警打开\n2. triptp增加hsf的在线率报警\n3. 后续优化日志信息，将无用日志清除\n4. 同步check  tsc / tfc /travelbc 等系统告警配置 及 机器重启",
    "chunk_order_index": 3,
    "full_doc_id": "doc-8830c91c003c64367e425fa1d57786fd"
  },
  "chunk-4ff807d03c9dc628da9b3107ebb5312f": {
    "tokens": 1200,
    "content": "## 一、故障概述（含影响产品线及影响面）\n**故障概述：**\n\n2022-09-27 10:39开始，阿里商旅_查看用车订单详情 商旅/用车/成功率最近10分钟持续小于50%且失败量持续大于100，故障升级至P3。初步判定故障原因为代码问题--订单号超长后出现的截断，15:09 发版修复后，于15:30监控恢复.\n\n**影响面：**\n\n    - 是否影响可用性**：不影响飞猪可用性；**\n    - 业务影响：\n        * **影响商旅用车详情查看，用户创建订单成功后无法进入用车详情中查看车型、车牌、司机位置、司机联系方式、地图等信息，行程结束后无法进入详情进行费用确认、投诉等动作；**\n        * **暂不影响交易量，但服务体验受到严重影响，甚至无法取消订单和联系司机导致 无法乘车的理论资损**\n    - 是否有客诉量（在线，热线，排队量）：影响总订单5706单。在线量：253，热线量：287，总量：540\n    - 是否有社会舆情：无\n    - 是否产生资损：**产生1笔资损投诉，赔付25元；**\n\n## 二、故障过程回顾【故障处理时间线】\n### 【1-5-10概览】\n![画板](https://intranetproxy.alipay.com/skylark/lark/0/2022/jpeg/3536/1664281997005-b98bc6b2-4078-4961-9951-eae343abe2ee.jpeg)\n\n### 【故障处理时间线】\n整体故障时间线。需要着重强调【故障注入】【故障发生】【故障发现】【业务响应】【故障定位】【恢复执行】【故障恢复】时间点。\n\n请按格式【时间，内容】进行反馈，例如：2018-01-01 18:01，谁做了什么，如有监控、日志等相关信息截图，请补充。\n【故障注入 2022-09-27 10:34】开发在预发环境自测用车采销分离项目时，更新用车ht_taxi_main_order数据库的主键id(线上商旅用车核心order_id)为新业务定义下的销售单id，使原数据库的主键自增id基数由118157364 长度为9位，跳跃到长度为19位：1012105192620793008，即刻引起前端无法识别新订单号，获取不到详细订单详情，故障发生；\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/3536/1664281524356-7fdbb043-7cd6-461d-a71d-e8474de48b92.png)\n\n【故障发生 2022-09-27 10:34 】故障注入1s后，线上即产生一笔基于新id 自增下的订单，1分钟后查看订单详情的接口成功率开始下跌；\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/3536/1664281576421-ec7ba107-06e2-47bb-a220-d55961b03c21.png)\n\n【故障发现 2022-09-27 10:37】商旅日常预警群、飞猪风险预警信息同步群，同步告警；\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/3536/1664281636001-9a6d4fba-dac1-4747-bbd6-ae7ccffb2f4f.png)![](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/3536/1664281719399-c1485444-a6bf-4c5e-b8cd-f3d0b4a866ae.png)\n\n【业务响应 2022-09-27 10:40】@一枫接收风险预警，开始排查原因；\n\n【故障定位 2022-09-27 11:00】排查到订单号识别问题，群通知技术原因导致；\n\n【故障定位 2022-09-27 11:02】由于无法降级和还原，@翼高开始安排一枫尝试DB自增键回滚方案，并让@零卡联系DBA；\n\n【故障定位 2022-09-27 11:12】@一枫确认自助变更数据表结构无效。同时@零卡 联系到的DBA @莫居 请假了，联系到了值班DBA。\n\n【故障定位 2022-09-27 11:28】第二位响应的值班DBA @离白 尝试恢复主键，反馈结果同样无效，只能业务方改方案。\n\n【故障定位 2022-09-27 11:30】无法回滚，无法降级。开始考虑代码修复方案。现场确定两个紧急方案，同时进行紧急开发：\n\n方案一、为临时止血方案：把主键改为指定的短订单号，零卡和一枫开始写代码。 @零卡、@一枫\n\n方案二、",
    "chunk_order_index": 0,
    "full_doc_id": "doc-aa6566856785f6caa72e42f10c805683"
  },
  "chunk-9bc22a8d110ad01123794eed63d20f0c": {
    "tokens": 1200,
    "content": "，反馈结果同样无效，只能业务方改方案。\n\n【故障定位 2022-09-27 11:30】无法回滚，无法降级。开始考虑代码修复方案。现场确定两个紧急方案，同时进行紧急开发：\n\n方案一、为临时止血方案：把主键改为指定的短订单号，零卡和一枫开始写代码。 @零卡、@一枫\n\n方案二、为最终解决方案：梳理所有的前端交互接口里，将所有订单ID改为String类型。 @翼高\n\n【恢复执行 2022-09-27 14:58】临时止血方案验证通过，分支变更开始线上正式部署，新增的用车场景的主订单id恢复到长度16位：1012192620557001（是一笔测试订单）；\n\n【故障恢复 2022-09-27 15:08】线上环境部署完成，故障恢复；\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/3536/1664282261366-f36bac85-9360-44b4-9e21-86ae45108e57.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/3536/1664441616491-17525549-eb29-4cf3-846c-af82d6e0515f.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/3536/1664282391052-582fcedd-3bf3-401a-930f-a9a3c118575e.png)\n\n【消除影响 2022-09-27 16:08】最终修复方案测试完成，发布上线，针对已经创建的订单在行程中的场景，轮训查看未确认的订单仍存在报错问题清理，修复该影响的变更完成，故障影响消除；\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/3536/1664282501681-08dacd7c-ef44-4428-b325-54b44dd790a6.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/3536/1664441789826-f6feca5e-d2fa-47fd-900b-4bbaa26cca71.png)\n\n## 三、故障原因\n### 4.1【一句话原因】\n_/* 抽象简短总结故障原因 */_\n\n预发环境下执行新需求下的用车创建订单，订单号长度变更由原来的9位变更到19位，导致前端无法精确解析超长数字，进而获取不到订单详情数据，导致故障；\n\n### 4.2【背景说明】\n_/* 根据实际情况，选择填写下面的内容 */_\n\n+ 【需求背景】**商旅存在多个业务交易类目，每个行业的订单号不一致，有19位的tp长订单号，也有短的自增订单号。外部使用订单ID查询时，无法直接用订单号查询订单信息，必须指定类目，非常不便。为了解决该问题，发起了统一订单号的方案，并要求在各个类目交易改造中完成升级，提供的订单号生成逻辑和使用方案，没有考虑到原来链路仅支持短订单号的情况。**\n    - 预发环境下，用车交易升级时，开发商旅用车采销分离&用车场景加调价的需求时，需要进行自测调试，系统自动执行获取订单号并产生订单号了一笔测试交易单，直接影响了线上流量。\n    - 【业务链路】以业务链路图的形式体现故障整体的链路图及根因节点\n\n![画板](https://intranetproxy.alipay.com/skylark/lark/0/2022/jpeg/248804/1664287137903-3e98a7b3-541a-4ce8-b443-5dbe25fe7612.jpeg)\n\n    - 【变更背景】故障涉及的变更背景及变更内容\n\n未进行变更\n\n\n\n### 4.3【根因分析】\n1、根本原因\n用车采销分离技术方案：在梳理老的数据兼容方案中，又选择了需要双写新订单表和老订单表的方案；新的订单数据按照设计要求，使用新方案缺订单的统一id生成器生成的订单号，订单号长度为19位，会把新生成的长19位id替换原来的订单号（原来订单号为ht_taxi_main_order表的主键id）。\n        10:34 分，开发同学自测是预发触发生成了一条测试数据。因为原来的订单号字段是自增主键，直接把主键的起始值拉升到了19位，在这之后线上产生的新订单基于新产生的19位订单号自增；而之前系统的Long类型订单号作为结果返回给了前端，前端js处理Long类型订单号精度丢失，再把精度丢失的订单号传给后端接口时，会获取不到订单信息，最终导致订单详情页无法打开。\n引发问题的代码：\n\n+ orderId使用btriporder服务",
    "chunk_order_index": 1,
    "full_doc_id": "doc-aa6566856785f6caa72e42f10c805683"
  },
  "chunk-3b3eb4d2a5206fdfe4dfb96b6e4bd27a": {
    "tokens": 1200,
    "content": "起始值拉升到了19位，在这之后线上产生的新订单基于新产生的19位订单号自增；而之前系统的Long类型订单号作为结果返回给了前端，前端js处理Long类型订单号精度丢失，再把精度丢失的订单号传给后端接口时，会获取不到订单信息，最终导致订单详情页无法打开。\n引发问题的代码：\n\n+ orderId使用btriporder服务生成\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/248804/1664286038568-ef61b69b-d670-4e6b-bb84-c8d0c63bc396.png)\n\n+ 用车对象id指定未生成orderId\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/248804/1664285978468-7427d8c7-4d10-4b47-a08b-ffa2934d304b.png)\n\n2、修复时间过长引起故障升级\n\n+ 前50分钟：\n    - 现场指挥没有合理安排备用方案，全部人员都用在了不可恢复的方案上（恢复自增键），延误时间较长。\n+ 后3小时：\n    - 调整方案后，btripcar应用代码编译时间过长，需要16分钟编译。在尝试启动alimaven加速器时，需要增加一些依赖配置项，因为考虑修改无关内容是否可能带来影响，**现场否决了启用alimaven加速器的方案**。最终用编译16分钟的方案导致测试验证时间过长。\n    - 又因为预发环境存在跳过创单数据落库mock开关被开启，导致订单号数据没有落库，以为修复代码改出了新问题，**大约花费了1小时时间在定位预发无关问题**，加大了反复部署和验证的时间。\n\n## 四、故障关注点\n/* 根据故障实际情况可增删关注点，并提供详细内容分析*/\n\n### 4.1【系统质量】\n#### 4.1.1 需求&设计评估\n**〖关注点1〗****是否涉及产品、技术方案评估？此核心的问题是什么，如何改进？**\n\n- [x] **是，涉及**\n    - [ ] 需求评估遗漏\n    - [ ] 产品设计缺陷\n    - [x] 系统架构设计缺陷\n        - [x] 容错性不足 \n\n**〖问题总结〗**\n\n**在方案设计阶段，缺少对现有业务影响的梳理，未考虑到订单号长度变更对现有业务的影响。**\n\n### 4.2【处置能力】\n#### 4.2.1 故障发现&响应\n+ **是否监控发现**\n    - [x] 是\n        - [x] 故障触发方\n        - [x] 受影响方\n    - [ ] 否 ：****\n+ **发现后是否五分钟内响应**\n    - [x] 是\n    - [ ] 否，原因为：\n+ **应急协同组织是否存在问题**\n    - [x] 应急流程不明确（无流程或者流程不清晰、应急相关角色&职责不明确，缺失一号位等)\n    - [ ] 应急执行不到位（有流程，但未按流程执行，通告发送不及时，响应不及时等）\n\n**〖问题总结〗**多个问题全部关联到一个客诉故障分类中，如何保障故障分类更精准和及时？\n\n**〖改进点〗**\n\n#### 4.2.2 故障定位&恢复\n+ **故障涉及恢复方式：**\n    - [x] 代码发布\n    - [ ] 代码回滚\n    - [ ] 配置回滚\n    - [ ] 隔离\n    - [ ] 扩容\n    - [ ] 重启\n    - [ ] 限流\n    - [ ] 降级预案\n    - [ ] 自动恢复\n    - [ ] 其他：\n+ **是否达到10分钟快恢（**_**P1P2故障填写**_**）**\n    - [ ] 是\n    - [x] 否，原因：非代码发布导致，属于数据格式存储变化导致，无法在有效时间内通过配置、回滚、等其他手段恢复，需要变更代码，预发验证，安全生产发布、线上发布等发布流程解决；\n\n## 五、故障Action\n| **序号** | **ACTION** | **是否keyAction** | **计划完成时间** | **验收标准** | **Action负责人** |\n| --- | --- | --- | --- | --- | --- |\n| 1 | 制定前后端检查全类目预订链路上所有的MTOP接口订单id字段改为字符串的修复计划 | 是 | 10-14 | 测试验收 | 龙芒/零卡 |\n| 2 | 应急处理规范落地方案[https://yuque.antfin.com/docs/share/5e116cfd-46d9-44fa-b679-273cee5ebe6c?#](https://yuque.antfin.com/docs/share/5e116cfd-46d9-44fa-b679-273cee5ebe6c?#) 《商旅线上突发故障应急s",
    "chunk_order_index": 2,
    "full_doc_id": "doc-aa6566856785f6caa72e42f10c805683"
  },
  "chunk-96ce3cb4b8d32f2e7095125a6a3a0bb3": {
    "tokens": 238,
    "content": "试验收 | 龙芒/零卡 |\n| 2 | 应急处理规范落地方案[https://yuque.antfin.com/docs/share/5e116cfd-46d9-44fa-b679-273cee5ebe6c?#](https://yuque.antfin.com/docs/share/5e116cfd-46d9-44fa-b679-273cee5ebe6c?#) 《商旅线上突发故障应急sop》 | 是 | 10-14 | 演练验收 | 箩航 |\n| 3 | 应用编译和启动时长梳理及优化[商旅应用线上发布耗时](https://yuque.antfin-inc.com/docs/share/c4a71321-fed0-40d8-82cd-4be7e515b3db?#) | 是 | 10-21 | 预发耗时小于5min | 箩航/零卡 |\n| 4 | btripcar二套环境搭建 | 否 | 10-14 | 预发验收 | 藝行 |",
    "chunk_order_index": 3,
    "full_doc_id": "doc-aa6566856785f6caa72e42f10c805683"
  },
  "chunk-2c2e7a24e509a7f43a2e7983b8933d66": {
    "tokens": 1200,
    "content": "## 一、故障概述（含影响产品线及影响面）\n**故障概述：**\n\n2022-09-29  22:30开始，目的地&内容&榜单&频道/行业评价列表/失败量最近10分钟最小值大于100且成功率最近10分钟最大值小于等于80%，触达P4，原因初步定位为压测导致DB CPU被打满，压测停止后于22:40恢复正常。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/39701/1665474158338-593f046a-bced-40b2-bfb1-b88e12af86e7.png)\n\n**影响面：**飞猪/平台技术/用户产品&用增平台/用户产品/目的地&内容&榜单&频道/行业评价列表\n\n    - 是否影响可用性**：是**\n    - 业务影响：所有评价查询接口\n\n## 二、故障过程回顾【故障处理时间线】\n### 【1-5-10概览】\n![画板](https://intranetproxy.alipay.com/skylark/lark/0/2022/jpeg/41240/1662515841548-bf3696a8-c98c-485e-8829-3d4e9a0c53d2.jpeg)\n\n### 【故障处理时间线】\n整体故障时间线。需要着重强调【故障注入】【故障发生】【故障发现】【业务响应】【故障定位】【恢复执行】【故障恢复】时间点。\n\n请按格式【时间，内容】进行反馈，例如：2018-01-01 18:01，谁做了什么，如有监控、日志等相关信息截图，请补充。\n【故障注入】2022-09-29 22:30   DB打满\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/29156495/1665373813996-74e03c17-5f62-4903-a3b3-aaab4d28d422.png)\n\n【故障发生】2022-09-29 22:40  时间达到10分钟，触达P4故障\n\n[https://x.alibaba-inc.com/custom/59/product/preview/spm/1992?crossTenant=true](https://x.alibaba-inc.com/custom/59/product/preview/spm/1992?crossTenant=true)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/4644/1665473782732-5cd00b4d-72f9-418d-b004-cfff7453defc.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/7056542/1665369902065-f1ff4ab3-cf25-4bdc-ac0b-f94bfb575cc0.png)\n\n【故障发现】2022-09-29 22:33   风险预警群，告知风险，对应同学接手预警\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/7056542/1665369826858-52048609-c5e3-4f14-a567-ebf7453008e6.png)![](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/7056542/1665369879606-b3d1099b-e685-4ea2-aa23-774fecd15911.png)\n\n【业务响应】\n【故障定位】\n【恢复执行】2022-09-29 22:40  看到风险预警 并且收到相关同学信息后 停止压测\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/7056542/1665370053069-87c002ee-793b-4613-bd0a-810bc8c37b26.png)\n\n【故障恢复】\n2022-09-29 22:40  停止压测后故障恢复\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/7056542/1665370160858-7a7e4d2a-6f84-44fc-b70b-1030bb746490.png)\n\n\n\n## 三、故障原因\n### 4.1【一句话原因】\n_POI压测，未评估到对点评业务影响，导致点评DB 被打满。_\n\n\n\n### 4.2【背景说明】\n    - 【需求背景】针对国庆稳定性保障，对POI详情进行压测\n    - ![](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/39701/1665487556315-d2453135-5c0c-4f7b-a633-c3eb9b7d4368.png)\n    - 【业务链路】\n        * **未调用点评：**\n        * [https://h5api.m.taobao.com/h5/mtop.alitrip.tripmdd.querypoiinfo/5.1](https://h5api.m.taobao.com/h5/mtop.alitrip.tripmdd.querypoiinfo/5.1)\n        * [http://eagleeye.alibaba-inc.com/trace/callChain.htm?traceId=",
    "chunk_order_index": 0,
    "full_doc_id": "doc-fb7b0277a875def6e919b753df1af5aa"
  },
  "chunk-3491d58eee31bd8804db92f22941bd49": {
    "tokens": 1200,
    "content": "d4368.png)\n    - 【业务链路】\n        * **未调用点评：**\n        * [https://h5api.m.taobao.com/h5/mtop.alitrip.tripmdd.querypoiinfo/5.1](https://h5api.m.taobao.com/h5/mtop.alitrip.tripmdd.querypoiinfo/5.1)\n        * [http://eagleeye.alibaba-inc.com/trace/callChain.htm?traceId=0b1afaf016654757477884092e6ab6](http://eagleeye.alibaba-inc.com/trace/callChain.htm?traceId=0b1afaf016654757477884092e6ab6)\n        * ![](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/7056542/1665476096495-731ce8a4-261d-4bf2-a250-00911e373ced.png)\n    - \n        * **调用点评链路：**\n    - [https://h5api.m.taobao.com/h5/mtop.alitrip.tripmdd.querypoiinfo/5.1](https://h5api.m.taobao.com/h5/mtop.alitrip.tripmdd.querypoiinfo/5.1)\n    - [http://eagleeye.alibaba-inc.com/trace/callChain.htm?traceId=0b1afaf016654758717766209e6ab6](http://eagleeye.alibaba-inc.com/trace/callChain.htm?traceId=0b1afaf016654758717766209e6ab6)\n    - ![](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/7056542/1665476029071-45e1f6f9-2b41-4f62-a69a-184cf1c15273.png)\n    - 【变更背景】压测变更，针对国庆稳定性保障，对POI详情进行压测\n\n\n\n### 4.3【根因分析】\n慢sql\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/29156495/1664515957305-d695bbf7-79db-43ae-a69f-d215980afba0.png)\n\n```json\n/* 212ab1eb16644610593971769e7409/0.1.3.7.24//cee1252/// */\nSELECT `trip_wrate_media`.`id`, `trip_wrate_media`.`gmt_create`, `trip_wrate_media`.`gmt_modified`, `trip_wrate_media`.`travel_item_id`, `trip_wrate_media`.`item_rate_id`\n\t, `trip_wrate_media`.`url`, `trip_wrate_media`.`owner_id`, `trip_wrate_media`.`owner_nick`, `trip_wrate_media`.`tag_ids`, `trip_wrate_media`.`tag_info`\n\t, `trip_wrate_media`.`status`, `trip_wrate_media`.`type`, `trip_wrate_media`.`gps_info`, `trip_wrate_media`.`produce_time`, `trip_wrate_media`.`rate_id`\n\t, `trip_wrate_media`.`check_status`, `trip_wrate_media`.`extra_info`\nFROM `trip_wrate_media_096` `trip_wrate_media`\nWHERE `trip_wrate_media`.`travel_item_id` = 15968\n\tAND `trip_wrate_media`.`rate_id` = 200157682\n```\n\n联合索引只命中了第一层，扫描行数打到40000+。触发慢sql。\n\n其他sql，索引都是正常命中，猜测是受上面这条sql影响，其他的所有请求都变慢了。\n\n\n\n为啥6000qps就打满了？\n\n直接原因是上面这条慢sql拖垮了全部的请求。\n\n为啥日常峰值5000的qps，cpu也才25%左右。压测到6000就挂了。\n\n查看慢sql的travelItemId多为热门poi（如\t上海迪士尼度假区，广州长隆水上乐园，珠海长隆海洋王国等）这部分poi评价图片偏多，扫描行数偏大，导致CPU上升。\n\n## 四、故障关注点\n### 4.2【处置能力】\n#### 4.2.1 故障发现&响应\n+ **是否监控发现**\n    - [x] 是\n        - [ ] 故障触发方\n        - [x] 受影响方\n    - [ ] 否 ：****\n+ **发现后是否五分钟内响应**\n    - [x] 是\n    - [ ] 否，原因为：\n+ **应急协同组织是否存在问题**\n    - [x] 应急流程不明确（无流程或者流程不清晰、应急相关角色&职责不明确，缺失一号位等)\n    - [ ] 应急执行不到位（有流程，但未按流程执行，通告发送不及时，响应不及时等）\n\n**〖问题总结〗**多个问题全部关联到一个客诉故障分类中，如何保障故障分类更精准和及时？\n\n**〖改进点〗**\n\n#### 4.2.2 故障定位&恢复\n+ **故障涉及恢复方式：**\n    - [x] 其他：**停止压测**\n+ **是达到10分钟快恢（**_**P1P2故障填写**_**）**\n\n## 五、故障Action\n| **序号** | **ACTION",
    "chunk_order_index": 1,
    "full_doc_id": "doc-fb7b0277a875def6e919b753df1af5aa"
  },
  "chunk-99f7939c4faea799267d922917863679": {
    "tokens": 225,
    "content": "客诉故障分类中，如何保障故障分类更精准和及时？\n\n**〖改进点〗**\n\n#### 4.2.2 故障定位&恢复\n+ **故障涉及恢复方式：**\n    - [x] 其他：**停止压测**\n+ **是达到10分钟快恢（**_**P1P2故障填写**_**）**\n\n## 五、故障Action\n| **序号** | **ACTION** | **是否keyAction** | **计划完成时间** | **验收标准** | 验收人 | **Action负责人** |\n| --- | --- | --- | --- | --- | --- | --- |\n| 1 | 增加评价媒体信息索引 | 是 | 2022-09-30 | 查询扫描行数降低 | | 项前 |\n| 2 | 评价限流阈值摸底并调整 | 否 | 2022-10-31 | 确认更合理的阈值 | 蝶裳 | 项前 |",
    "chunk_order_index": 2,
    "full_doc_id": "doc-fb7b0277a875def6e919b753df1af5aa"
  },
  "chunk-63c5b4652a520cac81a9a704c4fbf6cd": {
    "tokens": 1200,
    "content": "## 一、故障概述（含影响产品线及影响面）\n**故障概述：**\n\n于10.12日16:07，国内机票/履约/成功量 最近 10 分钟与基线同比下跌大于 60%， 触达 P2。期间国内机票下单、辅营跌 0，保险也受到影响。故障原因：DB 内核版本升级切换过程中，源库被设置为了readonly，权重没有正常切换导致，DBA 手动关闭源库 readonly 后，于16:24恢复故障。\n\n**影响面：**\n\n    - 是否影响可用性**：**是****\n    - **业务影响：**\n        * 国内机票下单跌0**；**\n        * 国内机票搭售行业辅营下单量跌0，影响约2700单（同比环比取平均值）\n        * 保险、辅营业务受影响\n            + 保险：搭售+辅营共影响约670单，影响保险保额26620元\n    - 是否有客诉量（在线，热线，排队量）：\n    - 是否有社会舆情：无\n    - 是否产生资损：无\n\n## 二、故障过程回顾【故障处理时间线】\n### 【1-5-10概览】\n![画板](https://intranetproxy.alipay.com/skylark/lark/0/2022/jpeg/3536/1664281997005-b98bc6b2-4078-4961-9951-eae343abe2ee.jpeg)\n\n### 【故障处理时间线】\n整体故障时间线。需要着重强调【故障注入】【故障发生】【故障发现】【业务响应】【故障定位】【恢复执行】【故障恢复】时间点。\n\n2022-05-31 16:07，阿里云-叶北拉群沟通内核版本升级问题；\n\n2022-09-21 16:07，数据库侧发起二升三内核版本升级任务 ；\n\n2022-10-12 16:07，任务升级过程中主备切换,原主库被设置为 read_only,权重未正常切换到新主，导致节点禁写 【故障注入】\n\n2022-10-12 16:07，国内机票成功率开始下跌；\n\n2022-10-12 16:12，飞猪-陨冰根据错误日志定位是数据库不可写入导致，开始尝试联系DBA；\n\n2022-10-12 16:16，飞猪-慕恒完成数据库[工单](https://dbservice.alibaba-inc.com/orders/detail_check/20059)提交；\n\n2022-10-12 16:17，飞猪-音素进行变更flytp回滚，16:20第一批回滚完成（实际故障与此变更无关）\n\n2022-10-12 16:17，触发P2故障，GOC发出监控报警；【故障发生】\n\n2022-10-12 16:18，飞猪-雅净同步故障进展，正在回滚；【故障定位】【业务响应】\n\n2022-10-12 16:19，等待值班反馈同时，联系到之前帮忙处理过线上问题的DBA 叶北定位问题；\n\n2022-10-12 16:20，数据库工单反馈，技术支持同学分配对应技术同学许恺；\n\n2022-10-12 16:21，飞猪-陨冰电话告知数据库写入异常；\n\n2022-10-12 16:23，阿里云-叶北手动关闭数据库 read_only，故障恢复；【故障恢复】；\n\n## ![](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/19257009/1665565567268-7d093dc5-35ee-4ac6-8019-e59516f97481.png)\n## 三、故障原因\n### 4.1【一句话原因】\nDB内核版本升级工作流存在bug，导致任务异常，源库被设置为了readonly，业务访问失败。\n\n### 4.2【背景说明】\nATO_APP|ATO_APP_RO|TRIP_ATO_APP 内核版本过低，目前为 alisql 5.6，因不符合集团内核版本一致性要求，[@叶北](undefined/luocaiping.lcp) 于  05.31 拉群沟通内核版本升级问题，建议清理部分历史数据，因实例存在大表大字段导致升级一直失败。\n\n9.21号业务因云下两节点稳定性问题找到DBA ，希望能尽快升级到集团标准三节点内核版本。9.21 重新发起二升三内核版本升级任务，10.12 16:05' 进行到节点切换阶段，原主库被设置为 read_only, drc 反向链路启动异常，权重没法正常切到新主库。 \n\n### 4.3【根因分析】\nDB内核版本升级切换过程中，源库被设置为了readonly，DRC反向链路创建异常，权重不能正常切到新主库，导致 原数据库 实例持续只读，DBA手动关闭源库readonly后恢复。\n\n## 四、故障关注点\n### 4.1【系统质量】\n#### 4.1.1 需求&设计评估",
    "chunk_order_index": 0,
    "full_doc_id": "doc-14c33b0069fa0a1e9c0d0deef88a1343"
  },
  "chunk-fe116a6741fbed6e0ed4925cb467076f": {
    "tokens": 878,
    "content": "主库。 \n\n### 4.3【根因分析】\nDB内核版本升级切换过程中，源库被设置为了readonly，DRC反向链路创建异常，权重不能正常切到新主库，导致 原数据库 实例持续只读，DBA手动关闭源库readonly后恢复。\n\n## 四、故障关注点\n### 4.1【系统质量】\n#### 4.1.1 需求&设计评估\n**〖关注点1〗****是否涉及产品、技术方案评估？此核心的问题是什么，如何改进？**\n\n- [ ] **是，涉及**\n    - [ ] 需求评估遗漏\n    - [ ] 产品设计缺陷\n    - [ ] 系统架构设计缺陷\n        - [ ] 容错性不足 \n        - [ ] 单点，无冗余\n        - [ ] 缺乏自我保护\n        - [ ] 缓存设计不当\n        - [ ] 容量评估不足\n        - [ ] 非幂等设计\n        - [ ] 强弱依赖不合理\n        - [x] 其他：数据库主备切换过程失败\n- [ ] 否，不涉及\n\n**〖问题总结〗**\n\n**在方案设计阶段，缺少对现有业务影响的梳理，未考虑到订单号长度变更对现有业务的影响。**\n\n### 4.2【处置能力】\n#### 4.2.1 故障发现&响应\n+ **是否监控发现**\n    - [ ] 是\n        - [x] 故障触发方\n        - [x] 受影响方\n    - [ ] 否 ：****\n+ **发现后是否五分钟内响应**\n    - [x] 是\n    - [ ] 否，原因为：\n\n\n\n**Action1：**风险预警产品：透出数据库负责人名单。/机器人同步DBA值班名单；--拾里\n\n**Action2：**飞猪安全生产内部宣讲、演练，日常/故障态的数据库故障处理流程；--雅净\n\n**Action3：**消防群内邀请排查能力透传出来--拾里\n\n#### 4.2.2 故障定位&恢复\n+ **故障涉及恢复方式：**\n    - [ ] 代码发布\n    - [ ] 代码回滚\n    - [ ] 配置回滚\n    - [ ] 隔离\n    - [ ] 扩容\n    - [ ] 重启\n    - [ ] 限流\n    - [ ] 降级预案\n    - [ ] 自动恢复\n    - [x] 其他：DBA手动关闭源库readonly后恢复\n+ **是否达到10分钟快恢（**_**P1P2故障填写**_**）**\n    - [ ] 是\n    - [x] 否，原因：非代码发布导致，属于数据格式存储变化导致，无法在有效时间内通过配置、回滚、等其他手段恢复，需要变更代码，预发验证，安全生产发布、线上发布等发布流程解决；\n\n## 五、故障Action\n| **序号** | **ACTION** | **计划完成时间** | **Action负责人** |\n| --- | --- | --- | --- |\n| 1 | 提高权重告警发现率，以及告警效率 | 10.24 | 胜伦 |\n| 2 | 实例设置只读之后，任务失败需要超时回滚 | 10.24 | 越几 |\n| 3 | 数据库内核版本升级，数据迁移到新库 | 11.30 | 叶北 |\n| 4 | 飞猪快速联系dba，提交工单机制宣讲 | 10.24 | 鼎霖、GOC |\n| 5 | 针对可能触发P1P2故障的业务链路，进行分库分表，梳理迁移方案 | 1.1 | 龙幽 |",
    "chunk_order_index": 1,
    "full_doc_id": "doc-14c33b0069fa0a1e9c0d0deef88a1343"
  },
  "chunk-f6511276dfda12dde7c5d3c9a4e7b8f5": {
    "tokens": 1200,
    "content": "## 一、故障概述（含影响产品线及影响面）\n**故障概述：**\n\n于 2022-10-17 16:40开始，商旅/商旅首页/成功量最近10分钟与基线同比下跌大于等于70%，触达P4，因成功率持续10分钟跌零，故障升级至P3，故障原因为预发测试数据异常导致的慢sql将数据库内存打满，前置选人页查询行程使用同一sql模板被限流，导致接口整体失败。16:55经过技术同学限流后恢复。\n\n**影响面：**\n\n    - 是否影响可用性**：**是**；**\n    - **业务影响：**\n        * pv 7368 uv 793，共影响到367个企业\n    - 是否有客诉量（在线，热线，排队量）：统计共41个客诉，来自11个企业\n    - 是否有社会舆情：否\n    - 是否产生资损：否\n\n## 二、故障过程回顾【故障处理时间线】\n### 【1-5-10概览】\n![画板](https://intranetproxy.alipay.com/skylark/lark/0/2022/jpeg/3536/1664281997005-b98bc6b2-4078-4961-9951-eae343abe2ee.jpeg)\n\n### 【故障处理时间线】\n整体故障时间线。需要着重强调【故障注入】【故障发生】【故障发现】【业务响应】【故障定位】【恢复执行】【故障恢复】时间点。\n\n\n\n2022-10-17 16:29:56  [@蓝歌](undefined/lange.jp)在预发联调pc首页功能，用“错误的”(无sla和文档约定)applyId（applyId = 0）调用管控的服务端接口报错（调用8次），反馈给[@自先](undefined/huguobin.hgb)\n\n2022-10-17 16:38:54—16:41:45 [@自先](undefined/huguobin.hgb)为了验证报错原因，将请求在预发mse上重新测试了9遍，产生了慢sql --故障产生  \n\n2022-10-17 16:40:00—16:59:10  数据库sql模板被自动限流\n\n2022-10-17 16:40:00  中间页去预订接口（PreSelectCostService#save）成功率开始下跌，2022-10-17 16:45:00 中间页前置选人页面（PreSelectCostService#render）成功率开始下跌\n\n2022-10-17 16:43，商旅故障场景风险预警群发出预警卡片\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/46274/1666060133050-e7e35e9e-6a0a-411d-81a0-5cb94496fbba.png)\n\n2022-10-17 16:45:00  [@东雎](undefined/nick.cx)在**商旅故障场景风险预警群**接手风险，[@零卡](undefined/lingka.hym)[@东雎](undefined/nick.cx)[@箩航](undefined/cxy140446)开始排查问题--故障响应\n\n2022-10-17 16:46:00  [@汀夜](undefined/sjh167961) [@方玉](undefined/mengxuansun.smx)[@洒花](undefined/zhangwenzhe.zwz)等开始排查问题 \n\n2022-10-17 16:53:00 成功率下跌超过10分钟，触发P4故障，监控值班拉起故障应急 \n2022-10-17 16:56:00 [@零卡](undefined/lingka.hym)[@东雎](undefined/nick.cx)[@箩航](undefined/cxy140446)定位到btriphome的 JdbcException数量激增，通知dba，dba定位到具体的慢sql，进行操作限流和杀进程  【故障定位】【恢复执行】\n\n2022-10-17 16:57:00 成功率持续10分钟跌零，故障升级到P3\n\n2022-10-17 16:57，[@拾里](undefined/sywyawen.syw)拉起电话会议\n\n2022-10-17 17:00，dba操作限流执行完成，监控于17:00全量恢复\n\n## \n## 三、故障影响面\n\n\n+ 首页前置选人页面，以及中间页点击去预订\n\n[mtop.alitrip.btriphome.pre.select.render](https://max.m.taobao.com/mtop/managerapi/view?api=mtop.alitrip.btriphome.pre.select.render&v=1.0&version=6&biz_domain=ali)\n\n[mtop.alitrip.btriphome.pre.select.save](https://max.m.taobao.com/mtop/managerapi/view?api=mtop.alitrip.btriphome.pre.select.save&v=1.0&version=7&biz_domain=ali)\n\n+ 实际影响企业：\n\npv 7368 uv 793\n\n367个企业名单： [https://sheet.alibaba-inc.com/#/sheet/",
    "chunk_order_index": 0,
    "full_doc_id": "doc-64fb2c092d2b66546d3ac6087c542eff"
  },
  "chunk-f56cffc4dd3d8b6f0a2ae1b5a946e00a": {
    "tokens": 1200,
    "content": "1.0&version=6&biz_domain=ali)\n\n[mtop.alitrip.btriphome.pre.select.save](https://max.m.taobao.com/mtop/managerapi/view?api=mtop.alitrip.btriphome.pre.select.save&v=1.0&version=7&biz_domain=ali)\n\n+ 实际影响企业：\n\npv 7368 uv 793\n\n367个企业名单： [https://sheet.alibaba-inc.com/#/sheet/9aa092d0463d6505](https://sheet.alibaba-inc.com/#/sheet/9aa092d0463d6505)\n\n企业数量：\n\n+ 客诉：\n\n统计共41个客诉，来自11个企业[@黛媚](undefined/xc387486)\n\n2005021966075430 成都海得控制系统有限公司 \n\n2005021967175246 北京华佑科技有限公司\n\n2005021966318420  爱玛科技集团股份有限公司 \n\n2005021965746023 飞毛腿（福建）电子有限公司\n\n2005021965979131 国能思达科技有限公司 \n\n2005021966186119 纳图兹贸易(上海)有限公司 \n\n2005021966220346 凌云光技术股份有限公司 \n\n2005021965959312 杭州东箭实业集团有限公司 \n\n2005021966071811 宣城好彩头实业股份有限公司 \n\n2005021966412931 成都大公博创信息技术有限公司  \n\n2005021972592370 浙江乐檬信息技术有限公司 \n\n## 四、故障原因\n### 4.1【一句话原因】\n预发环境用错误的测试数据测试接口，产生了17次慢sql，触发了DB的限流规则，此类类型的所有正常查询sql都被拒绝访问。\n\n\n\n### 4.2【背景说明】\n商旅首页的前置选人以及去预订的功能，需要调用审批服务的查询行程单详情接口，校验行程单可用性。如果在这里查询行程单失败，前置选人和去预订功能就会失败 \n\n### 4.3【根因分析】\n蓝歌在预发联调pc首页功能，用“错误的”(无sla和文档约定)applyId（applyId = 0）调用管控的服务端接口报错（测试了8次），反馈给自先。自先为了验证报错原因，将请求在预发mse上重新测试了9遍，在这里引入了慢sql。\n\n```plain\nSELECT ? AS QUERYID, id, gmt_create, gmt_modified, itinerary_no\n\t, apply_id, corp_id, user_id, trip_way, traffic_type\n\t, dep_city_name, arr_city_name, dep_date, arr_date, cost_center_id\n\t, cost_center_title, btrip_invoice_id, invoice_title, snapshot_id, used\n\t, status, thirdpart_itinerary_id, dep_city_code, arr_city_code, type\n\t, project_title, travel_dep, travel_arr, project_id, project_code\n\t, duration, duration_unit, dep_city_region, arr_city_region, traffic_name\n\t, dep_area_type, arr_area_type, region\nFROM btrip_itinerary\nWHERE apply_id = 0\n\tAND status = 1\nORDER BY id DESC\n```\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/46274/1666009867087-53a245a7-4b46-4506-a6f0-65d82315bb87.png)\n\n这个sql返回的数据非常多（12971845条），将数据库内存打满了，该sql被标记为慢sql执行自动限流\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/46274/1666008540998-2251496c-5bbe-43f2-b6c0-212b9f7330bd.png)\n\n中间页前置选人和去预订也同时会查询 行程信息，由于数据库内存被打满，mysql将该sql标记为慢查询，该请求被限流，所有在自动限流模板中的sql总并发数不能超过16次，由于测试请求一共17次，所以慢sql一直没有处理完，所以正常的请求全部都无法执行（query was interrupted）。\n\n同时接口失败，用户会连续点击“去预订”（save接口），在16:40--16:50 左右 btripcontrol到btripapply  queryItineraryAndApplyDate 的流量翻了五倍。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/46274/1666010814446-ec86ea16-af29-495c-9384-3ee2c160b3c6.png)\n\n## 四、故障关注点\n### 4.1【系统质量】\n#### 4.1.1 需求&设计评估\n**〖关注点1〗****是否涉及产品、技术方案评估？此核心的问题是什么，如何改进？**\n\n- [ ] **是，涉及**\n    - [ ] 需求评估遗漏\n    - [ ] 产品设计缺陷\n    - [ ] 系统架构设计缺陷\n        - [ ] 容错性不足 \n        - [ ] 单点，无冗余\n        - [x] 缺乏自我保护\n        - [ ] 缓存设计不当\n        - [ ] 容量评估不足\n        - [ ] 非幂等设计\n        -",
    "chunk_order_index": 1,
    "full_doc_id": "doc-64fb2c092d2b66546d3ac6087c542eff"
  },
  "chunk-3dbe1d9098e17d5efac168f55b7ede71": {
    "tokens": 805,
    "content": "**\n    - [ ] 需求评估遗漏\n    - [ ] 产品设计缺陷\n    - [ ] 系统架构设计缺陷\n        - [ ] 容错性不足 \n        - [ ] 单点，无冗余\n        - [x] 缺乏自我保护\n        - [ ] 缓存设计不当\n        - [ ] 容量评估不足\n        - [ ] 非幂等设计\n        - [ ] 强弱依赖不合理\n        - [ ] 其他：\n- [ ] 否，不涉及\n\n**〖问题总结〗**\n\n**因为线上正常流量请求都是applyId大于零，所以接口并未设置applyId = 0的保护**\n\n#### 4.1.2  代码质量\n\n\n#### 4.1.3 变更质量\n### 4.2【处置能力】\n#### 4.2.1 故障发现&响应\n+ **是否监控发现**\n    - [x] 是\n        - [ ] 故障触发方\n        - [x] 受影响方\n    - [ ] 否 ：****\n+ **发现后是否五分钟内响应**\n    - [x] 是\n    - [ ] 否，原因为：\n+ **应急协同组织是否存在问题**\n    - [x] 应急流程不明确（无流程或者流程不清晰、应急相关角色&职责不明确，缺失一号位等) \n\n      两分钟后接手了风险，风险预警接手人@ 错了，另外这种预警和处理需要电话通知相关人，保证一分钟接手率\n\n    - [ ] 应急执行不到位（有流程，但未按流程执行，通告发送不及时，响应不及时等）\n\n**〖问题总结〗**\n\n**〖改进点〗**\n\n#### 4.2.2 故障定位&恢复\n+ **故障涉及恢复方式：**\n    - [ ] 代码发布\n    - [ ] 代码回滚\n    - [ ] 配置回滚\n    - [ ] 隔离\n    - [ ] 扩容\n    - [x] 重启\n    - [ ] 限流\n    - [ ] 降级预案\n    - [ ] 自动恢复\n    - [ ] 其他：\n+ **是否达到10分钟快恢（**_**P1P2故障填写**_**）**\n    - [ ] 是\n    - [x] 否，原因：\n\n## 五、故障Action\n| **序号** | **ACTION** | **是否keyAction** | **计划完成时间** | **验收标准** | **Action负责人** |\n| --- | --- | --- | --- | --- | --- |\n| 1 | btripapply查询行程接口新增对于applyId为0的请求拦截保护 | 是 | 1018 | applyId为0的请求会自动返回 | 方玉 |\n| 2 | 预警的报警人@错了  场景和负责人需要对应正确，预警由直接相关人接手，另外需要调整预警到电话  | 是 | 1024 | 场景和负责人对应正确，调整预警到电话通知到正确的人 | 东雎、徙南、拾里 |\n| 3 | 中间页以及依赖的上下游接口必须带 corpId，SQL 层面禁止，核心库的都要梳理  | 是 | 1024 |  | 方玉 |\n| 4 | 慢 SQL 和das平台的自治中心异常事件群里实时报警，跟进人待定，需要goc配合 | 是 | | | 龙幽 |",
    "chunk_order_index": 2,
    "full_doc_id": "doc-64fb2c092d2b66546d3ac6087c542eff"
  },
  "chunk-89fa875c51b7761995cd4ab1591861fd": {
    "tokens": 1200,
    "content": "## 一、故障简述\n##### 故障概述：\n2024年7月31日20:54开发在对价格基线拦截产生的错误价格进行修复测试的时候发现价格回刷错误，导致住宿国内酒店订单产生资损，故障原因初步确认是修复代码中价格单位错误导致，于8月1日00:55通过数据订正完成止血，故障恢复，期间未产生客诉，根据资损金额判定，达P4故障等级。\n\n## 二、影响产品线及影响面\n##### 影响面：\n- [x] 是否影响可用性：否\n- [x] 业务影响：\n\n影响范围：5000个rate价格回刷错误，有100倍的价差。\n受影响业务：住宿国内酒店\n\n异常订单总计98单，排除取消、退款和确认无房的62单，目前确认有房的36单 ，7.31已入住2单，8.1入住12笔订单\n\n- [x] 是否有客诉：否\n- [x] 是否有社会舆情_：_否\n- [x] 是否产生资损：\n\n截至8.1，理论资损金额RMB 23045.22，实际资损金额待确认，开发处理中。\n\n## 二、故障过程回顾\n2024-07-29 19:00，业务启动算法进行异常价格基线拦截，7月29日晚上基于业务给的黑名单以外的卖家进行配置，此刻黑名单以外的卖家全部走算法价格基线拦截逻辑，业务侧黑名单未包括自营卖家(淘酒店、菲住、喜乐等)\n2024-07-31 11:30，开始有BD反馈改价不生效，价格被改成99999999，不可售价格；开始介入排查\n2024-07-31 11:50，定位是走算法价格基线拦截逻辑导致，先止血关闭算法开关，11:50执行第一次算法回切中位数价格基线拦截开关推送操作，推的第一份配置有问题，没切回中位数算法\n2024-07-31 12:16，定位出问题后，二次推送开关配置成功后才彻底切回中位数\n2024-07-31 18:00，基于拦截异常case分析和回刷价格解决，算法侧价格拦截上下限计算有误杀，7.31关闭算法价格基线拦截后，18点开始启动进行拦截99999999的日历价格修复。\n\n+ 此时会议结论如下：\n    1. 历史改价全量恢复 —— 开发中，预计7.31  8:30可支持，具体恢复节奏以业务通知为准 @熊云长(汐云) @林勤立(勤励) @孙春艳(言慕) \t\n    2. 改价名单产出，评估明确异常数据，并通知业务线在指定日期前完成 @江雨航(麒玉) @贾云涛(半仙) \n    3. 算法逻辑重开发，使用数仓底表错误、计算最高价和最低价的逻辑需要计算单间夜 @肖文栋(寻潇) \n2024-07-31 20:32，异常价格拦截数据跑出，价格修复工具同步开发中，已明确需要修改至99999999前一次的价格，影响总量13218354(rate+checkin)\n2024-07-31 20:45，上游未触发hmq价格变更消息，进行hic的代码修改验证(mock hmq消息)，单case测试酒店验证多rate没问题，开始进行真实酒店商品消息发送limit 5小批量预发验证，此时下一个版本删除了limit限制，但是同步metaq消息还是用了price_line_check_fix_data的全量数据**【故障注入】**\n\n2024-07-31 20:54，hmq的消息触发来源于依赖的影响的数据表的ETL代码，Limit5的代码被误删除，但此时还没CR完成，没有意识到误删Limit操作，触发消息发送并同时开启hic预发的debug验证价格，此时晓枝、黎柯、勤励已发现价格相差100倍，但也发现消息量大，Limit没生效，触发了批量40w消息发送，累计消费处理Rate总数4341个(2022-07-31 20:54:57消费至 2024-07-31 21:10:08 截止) **【故障发生】【故障发现】【初因定位】【业务响应】**\n\n2024-07-31 20:55，开始同步进行问题代码修复、交易侧拦截低于10元价格功能上线，同时对影响订单进行处理。**【恢复执行】**\n\n2024-07-31 23:15，价格修改代码修改和测试完成，开始进行错误价格rate统计和订正修复\n\n2024-08-01 00:55，rate价格修复完成，全量止血完，操作shid和rid上线；统计影响订单和后续处理事项初对焦**【故障恢复】**\n\n## 三、故障原因\n### 3.1【背景说明】\n业务启动算法进行异常价格基线",
    "chunk_order_index": 0,
    "full_doc_id": "doc-2c09734d0015e1870e4cb34bd9c8965c"
  },
  "chunk-b685f3b530d7ccb655cf869c2a9d0542": {
    "tokens": 1200,
    "content": "-07-31 23:15，价格修改代码修改和测试完成，开始进行错误价格rate统计和订正修复\n\n2024-08-01 00:55，rate价格修复完成，全量止血完，操作shid和rid上线；统计影响订单和后续处理事项初对焦**【故障恢复】**\n\n## 三、故障原因\n### 3.1【背景说明】\n业务启动算法进行异常价格基线拦截，7月29日晚上基于业务给的黑名单以外的卖家进行配置，此刻黑名单以外的卖家全部走算法价格基线拦截逻辑，业务侧黑名单未包括自营卖家(淘酒店、菲住、喜乐等)。\n基于拦截异常case分析和回刷价格解决，算法侧价格拦截上下限计算有误杀，7.31关闭算法价格基线拦截后，18点开始启动拦截99999999的日历价格修复。\n\n### 3.2【原因分析】\n##### 一句话原因：\n1、价格基线拦截导致报价被修改为99999999(单位:分)，要修复为修改前报价的代码，代码存在bug，将价格基线拦截的报价(单位:元)直接更新到商品hic(单位:分)，商家价格在订正过程中被缩小100倍；\n\n2、预发提测验证环节，价格基线修复数据的消息发送ETL代码误修改去掉了limit5的限制，导致原本期望仅测试5条的数据被全量发送(102w总量消息发送了40w条消息)，预发2台服务器消费5182条消息，导致线上5182个Rate报价被修复错误缩小100倍；其中大部分Rate在修改后再次被中位数基线拦住，少量Rate由于价格拦截白名单&缩小100倍仍在价格基线区间范围的原因未被拦截。\n\n##### 根因分析：\n![画板](https://intranetproxy.alipay.com/skylark/lark/0/2024/jpeg/16548/1722479466963-302abcae-85c2-4bf7-813d-63fa8991d542.jpeg)\n\n1、有问题修复价格基线拦截导致修复代码：\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/16548/1722478402259-ee0b785d-57f4-42b5-9a7e-7f003b908fc6.png?x-oss-process=image%2Fformat%2Cwebp%2Fresize%2Cw_1125%2Climit_0)\n2、价格基线修复数据的消息发送依赖的底表ETL代码\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/16548/1722478159053-c43a41f0-3bc6-4793-8f6d-46a0c04fab39.png?x-oss-process=image%2Fformat%2Cwebp%2Fresize%2Cw_1125%2Climit_0)\n修改之前有limit限制的代码：\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/16548/1722479749517-ece55210-30f3-4f5e-b205-0742e26bf1ce.png?x-oss-process=image%2Fformat%2Cwebp%2Fresize%2Cw_685%2Climit_0)\n代码修复：  \n[https://code.alibaba-inc.com/hotel-supply/hiqc/commit/158fd5c5928f54befdf060ede15f8963ef58eb6d](https://code.alibaba-inc.com/hotel-supply/hiqc/commit/158fd5c5928f54befdf060ede15f8963ef58eb6d)\n\n## 四、关注点分析\n### 三层质量剖析\n#### 1、第一层：质量测试\n分析在测试阶段是否做过相关验证，是否发现了该问题？\n\n:::info\n开发自测，测试同学和开发一起Review逻辑进行验证，就是在测试阶段发现的问题，但发现的时候已经影响线上了。\n\n:::\n\n#### 2、第二层：监控\n分析是否可以通过监控有效的发现问题，监控平台能否快速触发告警\n\n:::info\n有监控，但是开发先于监控发现问题。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/58146/1722479000392-112f7a1d-1b4a-4462-bcdc-04dc752450b0.png)\n\n:::\n\n#### 3、第三层：应急\n发现问题之后有没有完善的应急方案，应急速度怎么样\n\n:::info\n发现问题后，1是第一时间修改代码，上线发布；2是手动取消可以取消的订单减少损失\n\n:::\n\n### 变更三板斧和CR检查\n#### 变更详情\n:::info\nlimit 5的限制可以变相看做是灰度，这个阶段就是在用线上数据做验证，但恰好出现了问题，limit5的限制被删除了，出现问题后也马上发现了",
    "chunk_order_index": 1,
    "full_doc_id": "doc-2c09734d0015e1870e4cb34bd9c8965c"
  },
  "chunk-eabfec7bac11ffa8698e96c93855815e": {
    "tokens": 928,
    "content": ":::info\n发现问题后，1是第一时间修改代码，上线发布；2是手动取消可以取消的订单减少损失\n\n:::\n\n### 变更三板斧和CR检查\n#### 变更详情\n:::info\nlimit 5的限制可以变相看做是灰度，这个阶段就是在用线上数据做验证，但恰好出现了问题，limit5的限制被删除了，出现问题后也马上发现了，所以还没有变更单。\n\n:::\n\n#### 可监控\n:::info\n1、是否监控发现？提供监控链接和截图。如果不是监控发现，请说明理由。\n\n有监控发现，但开发侧人工先发现\n\n2、本次故障是否是变更相关监控发现？\n\n不是，技术测试中发现\n\n3、是否有观察变更所属域对应的业务关键大盘？\n\n有\n\n4、变更后是否做了持续观察？变更是否符合预期？\n是\n\n:::\n\n#### 可灰度\n:::info\n1、是否做了灰度？提供灰度详情。\n\n是。\n\n2、灰度未发现故障的原因？\n\n灰度发现了，但实际上已产生了影响\n\n:::\n\n#### 可应急\n:::info\n1、是否可回滚/应急？ （原则上回滚方案/应急方案生效时长不超过10分钟，从开始执行计算。）\n\n不可回滚，当时在预发进行紧急价格修复逻辑验证，还未进行到应急方案部分\n\n2、本次故障是否是回滚恢复？如果不是，请说明理由。\n不是，数据订正，还没有批量回滚的能力\n\n:::\n\n#### Code Review \n:::info\n1、是否做了code review，负责人，review记录。（是/否/不涉及，说明理由）\n\n是，汐云，CR和测试联调同步进行，且CR未必能发现价格单位问题\n\n:::\n\n## 五、故障Action\n| **方案类型** | **Action类型** | **Action内容** | **计划完成时间****** | **Action负责人** |\n| :---: | :---: | --- | :---: | :---: |\n| 中期方案 | 产品类 | 将价格基线定位为平台的异常报价治理逻辑：价格基线的拦截能力基于不修改商家原始价库方案重新设计&落地 | 8.9 | 夙莘 |\n| | 技术类 | 价格基线拦截执行逻辑升级为不修改商家原始报价、(惩罚)库存；单独设立价格基线的拦截日历化开关，在铺货链路生效，更改商品的日历房房态；完成价格基线拦截操作可重跑、拦截数据可量化，拦截后对商家经营操作无感的能力建设 | 8.23 | 勤励 |\n| | 规范类 | 要求安全生产环境&预发要有测试卖家的线上真实数据的验证阶段，这个加入到安全生产规范中 | 8.30 | 雅净 |\n| 长期方案 | 产品类 | 1.基于新的拦截执行逻辑设计对应的商家触达、感知能力，在不侵入商家经营操作体验的前提下做到平台价格拦截有感2.价格拦截效果衡量产品化能力建设，量化出不同拦截策略(算法、中位线)的准确性，组织上有为拦截精准度的配套联动 | 8.9与业务侧确定方案，详细方案待定 | 夙莘 |\n|  | 技术类 | 完备拦截基线小二操作工具建设，包括现有小二操作工具的梳理、拦截基线白名单重跑(拦截过程明细埋点[原始报价，不做单位换算处理]&准实时数据回流整体建设) | 8.30方案设计完成，9.15线上发布完成； | 勤励 |\n|  | 产品/技术类 | 交易侧低价拦截下单逻辑，需要跟产品侧明确方案后落地 | 8.30 | 甁籽 |",
    "chunk_order_index": 2,
    "full_doc_id": "doc-2c09734d0015e1870e4cb34bd9c8965c"
  },
  "chunk-68e3a214ecad7c3569c7ebdc7227b529": {
    "tokens": 1200,
    "content": "## 一、故障简述\n##### 故障概述：\n2024年6月13日20:30开发对账发现退票不平账，导致飞猪垫资给用户退款后，123N6不退款产生资损，故障原因初步确认是新版退票所致，于21:00将退票切回老版退票完成止血，6月14日定位是端直连技术改造导致走到有缺陷的线下兜底方案的几率扩大，于当天修复完成并发布上线，影响消除。期间未收到客诉反馈，根据资损金额判定达P4故障等级。因本次故障为技术主动发现，所以故障降至P5。\n\n## 二、影响产品线及影响面\n##### 影响面：\n- [x] 是否影响可用性：否\n- [x] 业务影响：\n\n已取凭证的票在退票后，可能会给用户退款，但 123N6 不会退款，导致资损。\n\n![发布当天的监控，没有什么异常](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/188358/1719908223560-05ac3619-f25d-4690-9b60-b02ea555d40b.png)\n\n- [x] 是否有客诉：否\n- [x] 是否有社会舆情_：_否\n- [x] 是否产生资损：__\n\n理论资损：影响142单，共约RMB 24849.50 \n\n如需追回，需用户持票去火车站窗口操作，较难实现，因此目前视实际资损与理论资损一致。\n\n## 二、故障过程回顾\n2024-05-28 16:32，直连退票技术改造开始全量，监控数据正常。**【风险注入】**\n\n2024-06-13 20:30，服务端开发对账发现退票不平账。**【故障发现】【业务响应】**\n\n2024-06-13 21:00，[@王离](undefined/wangli.wy) 将退票切回老版退票，问题止血。**【恢复执行】【故障恢复】**\n\n2024-06-14 13:00，[@梵低](undefined/yinshubin.ysb) 找到直连，排查资损问题，[@对齐](undefined/tianqi.tq) 开始介入。\n\n2024-06-14 13:31，[@对齐](undefined/tianqi.tq) 发现是直连技术改造所致。**【根因定位】**\n\n2024-06-14 20:26，[@对齐](undefined/tianqi.tq) 修复了问题，并完成了直连发布。**【影响消除】**\n\n2024-06-21 12:52，[@王离](undefined/wangli.wy) 将退票全量切至新版退票，观察无误，问题修复。****\n\n## 三、故障原因\n### 3.1【背景说明】\n      用户申请退票时，飞猪向123N6发出请求申请退票，会查询 123N6 退票状态，若查询订单状态异常时，会有一个**兜底流程叫线下确认**：飞猪通知商家在票机上看票订单状态，商家再回调飞猪告知退票成功或失败。若退票成功，飞猪则会走垫退方式，把票款退给用户，123N6后续也会把钱退到飞猪账号里。 \n      商家回调接口的定义上，只定义了退票成功、退票失败 2 个状态，但其实还有 1 个退票场景是【已取发票，退票成功】，该场景是用户取了火车票纸质票后，来飞猪订单详情申请退票，票可以退成功，但是123N6不会把钱在线上退给飞猪，而是要用户去线下窗口把票给工作人员，工作人员才会操作把钱通过线上退回。 在这个场景下，代理商回调飞猪是【退票成功】，就导致飞猪把钱退给用户，但是没收到 123N6 的退款，产生资损。 \n      这是 21 年之前上线的项目，之前就有这个问题，但是问题订单数非常少，仅 20+ 单，但2024年5月开发做**纯代码层面优化**（即直连对退票进行技术重构，对退票的逻辑进行了任务队列方式的改造），预期对业务场景无影响，但端直连的改造将这个问题场景命中的几率扩大了。\n\n### 3.2【原因分析】\n##### 一句话原因：\n直连在做**纯代码层面优化**的过程中，简化了退票后查已完成数据的有效性检查，导致上报的无效订单几率扩大，服务端走**线下确认**兜底，此时的逻辑无法识别已取发票的订单，退钱给用户，导致资损。\n\n##### 根因分析：\n![](https://intranetproxy.alipay.com/skylark/lark/__puml/041e6b38a45076c5eb2cbac2370214fb.svg)\n\n**重构前的逻辑：**![](https://intranetproxy.alipay.com/skyl",
    "chunk_order_index": 0,
    "full_doc_id": "doc-635a32879b5417d0d97af19a6926f5a6"
  },
  "chunk-99e57e7c52d7d5c8f489e9cf922ea7d5": {
    "tokens": 1200,
    "content": "服务端走**线下确认**兜底，此时的逻辑无法识别已取发票的订单，退钱给用户，导致资损。\n\n##### 根因分析：\n![](https://intranetproxy.alipay.com/skylark/lark/__puml/041e6b38a45076c5eb2cbac2370214fb.svg)\n\n**重构前的逻辑：**![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/188358/1719905758616-3c441d8f-fdde-48f6-b102-3410f8f5e879.png)\n\n查已完成后，有一个 15s 的轮询逻辑，这里匹配了订单的状态，如果不是 c (已退票) 或y (已退票，未退款)，则重新查已完成。重构后这个逻辑没有了，导致订单状态为 a(已支付)的上报上升，服务端走线下**线下确认**兜底的情况上升。\n\n**重构后的逻辑：**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/188358/1719825144877-f3d5ae63-b4e8-4fef-bab7-00e5277e265d.png)\n\n**线下票机查询逻辑：**\n\n判断能否走供应商流程即进入兜底流程（消息盒子功能目前已下线）。\n\n一般是紧急情况会进入退票结果转待确认（如快要发车等），会有小二介入与用户进行沟通，协助用户完成退票流程（但不会关注是否已取发票），该路径在原有兜底流程下大概率也会造成资损。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2021/png/31856523/1635165213063-533c784c-cea2-4e6e-b52f-fbc5efbb013c.png)\n\n## 四、关注点分析\n**【系统质量-需求评估】**\n\n**关注点1：端直连改造的时候是否有评估到会影响到退票链路？是否知晓15秒轮询的背景？**\n\n问题总结：知道影响退票链路，但不知道15秒轮询背景，99%的订单大部分一次查询能成功，觉得没有必要做15秒轮询\n\n**关注点2：兜底流程是否识别到已退款且已取发票的场景？**\n\n问题总结：21年上线时票机不能识别到已取发票的状态，目前可以识别到该状态\n\n改进点：和商家联调，升级接口 [@朱厌](undefined/zuhe.zh) 7.16\n\n**【系统质量-代码质量】**\n\n**关注点1：CR阶段能否发现问题？**\n\n问题总结：CR阶段难以发现\n\n**关注点2：端直连改造测试阶段是否发现异常？是否覆盖了已取发票的场景？**\n\n问题总结：端直连测试阶段也无法发现这个异常\n\n改进点：票机新功能上线后会增加这个测试用例 [@双屿](undefined/songyujia.syj) 7.16\n\n**【系统质量-变更质量】**\n\n**关注点1：灰度验证及分批发布的时候是否有观测到异常？**\n\n问题总结：现有对账审计为T+1 , 无需新增监控\n\n### 4.1【系统质量】\n#### 4.1.1 需求&设计评估\n**〖关注点1〗****是否涉及产品、技术方案评估？此核心的问题是什么，如何改进？**\n\n- [x] **是，涉及**\n    - [x] 需求评估遗漏\n    - [ ] 产品设计缺陷\n    - [ ] 系统架构设计缺陷\n        - [ ] 容错性不足 \n        - [ ] 单点，无冗余\n        - [ ] 缺乏自我保护\n        - [ ] 缓存设计不当\n        - [ ] 容量评估不足\n        - [ ] 非幂等设计\n        - [ ] 强弱依赖不合理\n        - [ ] 其他：__________\n- [ ] 否，不涉及\n\n**〖问题总结〗**影响范围的评估遗漏\n\n**〖改进点〗**暂无\n\n#### 4.1.2 代码质量\n**〖关注点1〗****是否经过CodeReview？CodeReview阶段是否发现问题？为何没发现？**\n\n+ **是否经过CR**\n    - [x] 是\n    - [ ] 否\n    - [ ] 不涉及\n+ **是否设置合理的CR卡点**\n    - [x] 是\n    - [ ] 否\n    - [ ] 不涉及\n+ **CodeReview阶段是否发现问题？为何没发现？后续如何发现？**\n    - [ ] 是\n    - [x] 否\n    - [ ] 不涉及\n\n**〖问题分析〗**CR阶段无法发现\n\n\n\n**〖关注点3〗****测试阶段**\n\n+ **测试内容：**涉及的测试提交单、测试用例等\n+ **测试人员：**研发自测\n+ **是否经过测试验证**\n    - [x] 是，验证环境\n        - [x] 预发环境",
    "chunk_order_index": 1,
    "full_doc_id": "doc-635a32879b5417d0d97af19a6926f5a6"
  },
  "chunk-ba23bac74738cb9b7ae261fb587a7d55": {
    "tokens": 1200,
    "content": "发现？**\n    - [ ] 是\n    - [x] 否\n    - [ ] 不涉及\n\n**〖问题分析〗**CR阶段无法发现\n\n\n\n**〖关注点3〗****测试阶段**\n\n+ **测试内容：**涉及的测试提交单、测试用例等\n+ **测试人员：**研发自测\n+ **是否经过测试验证**\n    - [x] 是，验证环境\n        - [x] 预发环境\n        - [ ] 日常环境\n    - [x] 是，测试方法\n        - [ ] 单元测试\n        - [x] 功能回归测试\n        - [ ] 集成测试/链路测试\n        - [ ] 验收测试\n    - [ ] 否\n    - [ ] 不涉及\n+ **测试未发现原因是什么？后续如何改进？**\n    - [x] 回归测试遗漏\n        - [ ] 手工回归测试用例遗漏\n        - [ ] 自动化未建设\n        - [ ] 自动化回归覆盖不足\n        - [x] 其他：_手工回归测试用例遗漏，且该问题不是一个必现问题_\n    - [ ] 新场景测试遗漏\n        - [ ] 功能测试用例遗漏，包括正常分支和异常分支\n        - [ ] 容灾兜底测试遗漏\n        - [ ] 客户端兼容性测试遗漏\n        - [ ] 埋点测试遗漏\n        - [ ] 性能测试遗漏，影响评估不足\n        - [ ] 安全测试遗漏\n    - [ ] 其他：__________\n\n#### 4.1.3 变更质量\n+ **是否涉及变更：**\n    - [x] 是\n    - [ ] 否\n+ **变更类型：**\n    - [x] 代码发布\n    - [ ] 配置变更\n    - [ ] 其他变更：____________\n    - [ ] 不涉及\n+ **变更平台是否接入ChangeFree：**\n    - [x] 是，CF变更单链接：_[https://aicf.alibaba-inc.com/aicf/change/v2/detail/987244181](https://aicf.alibaba-inc.com/aicf/change/v2/detail/987244181?spm=goc-apm.aicf-_changeList.0.0.9cf72388r4USAU)，[https://aicf.alibaba-inc.com/aicf/change/v2/detail/987244760](https://aicf.alibaba-inc.com/aicf/change/v2/detail/987244760?spm=goc-apm.aicf-_changeList.0.0.9cf72388r4USAU)_\n    - [ ] 否\n+ **是否违反变更红线3.1**** **[链接](https://aliyuque.antfin.com/ngoc/fzg6dy/uar1k6)\n    - [ ] 是，违反哪条原则：\n    - [x] 否\n\n\n\n**〖关注点1〗****灰度阶段**\n\n+ **是否经过灰度：**\n    - [x] 是\n    - [ ] 否\n+ **观测了哪些监控**：\n    - [ ] 黑屏、白屏\n    - [ ] GOC监控：\n    - [x] 系统大盘：[https://arms.alibaba-inc.com/arms/api?apiFilters=%7B%22p1%22%3A%22submitRefundRequest%22%2C%22timeRange%22%3A%22thirty-minutes%22%7D&pid=train-direct-native](https://arms.alibaba-inc.com/arms/api?apiFilters=%7B%22p1%22%3A%22submitRefundRequest%22%2C%22timeRange%22%3A%22thirty-minutes%22%7D&pid=train-direct-native)  看提退整体的成功率![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/41240/1719910371826-c31ed526-ead4-4dd6-b21c-475c86c3a665.png)\n    - [ ] 其他：___________\n+ **是否灰度期间发现问题？**\n    - [ ] 是\n        - [ ] 是否灰度流量过大，导致故障\n        - [ ] 灰度发现但未有效或及时修复，导致故障\n        - [ ] 其他：___________\n    - [x] 否，后续如何灰度发现？_需要关注资损，目前的发布规范观测不到_\n+ **未灰度发现原因**\n    - [ ] 应用灰\n        - [ ] 灰度流量太小\n        - [ ] 灰度阶段无监控\n        - [ ] 灰度批次不合理\n        - [ ] 超长时间灰度才能发现\n    - [ ] 业务灰：策略不合理\n    - [x] 灰度无法发现\n    - [ ] 其他：_____________\n\n\n\n**〖关注点2〗****上线阶段**\n\n+ **是否有确定的监控观测指标**\n    - [x] 是，监控指标及监控链接：[https://arms.alibaba-inc.com/arms/api?apiFilters=%7B%22p1%22%3A%22submitRefundRequest%22%2C%22timeRange%22%3A%22thirty-minutes%22%7D&pid",
    "chunk_order_index": 2,
    "full_doc_id": "doc-635a32879b5417d0d97af19a6926f5a6"
  },
  "chunk-d9efd911517fc5859e998d629671f794": {
    "tokens": 884,
    "content": "其他：_____________\n\n\n\n**〖关注点2〗****上线阶段**\n\n+ **是否有确定的监控观测指标**\n    - [x] 是，监控指标及监控链接：[https://arms.alibaba-inc.com/arms/api?apiFilters=%7B%22p1%22%3A%22submitRefundRequest%22%2C%22timeRange%22%3A%22thirty-minutes%22%7D&pid=train-direct-native](https://arms.alibaba-inc.com/arms/api?apiFilters=%7B%22p1%22%3A%22submitRefundRequest%22%2C%22timeRange%22%3A%22thirty-minutes%22%7D&pid=train-direct-native)\n    - [ ] 否\n+ **是否在窗口期进行发布变更**\n    - [x] 是\n    - [ ] 否，原因：\n+ **变更是否影响上下游**\n    - [x] 是，是否有提前知会上下游评估及关注变更\n        - [x] 有提前知会\n        - [ ] 没有提前知会\n    - [ ] 否\n\n### 4.2【处置能力】\n#### 4.2.1 故障发现&响应\n+ **是否监控发现**\n    - [ ] 故障触发方 监控发现\n    - [x] 故障受影响方 监控发现\n    - [ ] 否，原因为：（监控无效/监控缺失）\n+ **是否5分钟内响应**\n    - [x] 是\n    - [ ] 否，原因为：\n+ **是否存在应急协同问题**\n    - [ ] 是\n        - [ ] 应急流程不明确（无流程或者流程不清晰、应急相关角色&职责不明确，缺失一号位等)\n        - [ ] 应急执行不到位（有流程，但未按流程执行，通告发送不及时，响应不及时等）\n    - [x] 否\n\n#### 4.2.2 故障定位&恢复\n+ **主要恢复方式：**\n    - [ ] 代码发布/回滚\n    - [x] 配置发布/回滚\n    - [ ] 数据订正\n    - [ ] 机器隔离/重启/扩容\n    - [ ] 配置限流\n    - [ ] 预案降级\n    - [ ] 自动恢复\n    - [ ] 其他：\n\n**〖关注点1〗定位&恢复阶段存在什么问题？是否可以增加预案，****有更快的恢复方式？****相关的优化改进？**\n\n**〖问题总结〗**暂无\n\n## 五、故障Action\n| **序号** | *******Action** | *******负责人** | *******计划完成时间** | **验收人** | **是否keyAction** |\n| :---: | --- | :---: | :---: | :---: | --- |\n| 1 | 短期：恢复直连上报前的正确性检查 | 对齐 | 6月14日 |  |  |\n| 2 | 短期：线下兜底确认需识别已取发票的情况 | 朱厌 | 7月16日 |  | 是 |\n| 3 | 短期：票机新功能上线后会增加这个测试用例 | 双屿 | 7月16日 |  |  |\n| 4 | 长期：所有的查已完成，都需要确保状态是正确的，然后再上报。同时也可考虑从框架层面进行约束 | 花莺（正向）/ 对齐（逆向） | 7月11日 |  |  |\n| 5 | 长期：后端可增加直连数据上报无有效订单过高的报警。这样在无效订单量上涨的时候，能更快的感知到 | 梵低 | 7月30日 |  |  |",
    "chunk_order_index": 3,
    "full_doc_id": "doc-635a32879b5417d0d97af19a6926f5a6"
  },
  "chunk-9099dd3a3631fcf8b4fad589cb7a70ed": {
    "tokens": 1200,
    "content": "## 一、故障简述\n##### 故障概述：\n2024年6月4日15:17收到工单反馈雅高直连下单价格错误，导致雅高税前价计算错误。故障原因初步确认是马来税项目改造时将国际落库的日历化的税丢掉导致，6月5日20:45通过分支发布完成止血，故障恢复。期间除雅高外未产生其它客诉，共计影响雅高侧206单，资损金额达P4故障等级。\n\n## 二、影响产品线及影响面\n##### 影响面：\n- [x] 是否影响可用性：否\n- [x] 业务影响：\n+ 国际直连落库场景，并且使用到了日历化税前价供应商，目前经直连技术同学确认，影响到了雅高，没有其他供应商受到影响。\n+ 影响透传给商家的金额，以及商家看到的应收金额，不影响正确的结算金额。具体来说：飞猪与门店的结算金额是正确的，但门店收到的金额比雅高系统中显示的应收金额低。雅高涉及到的门店较多，难以订正雅高系统数据，因此要求飞猪按之前提供给雅高的错误金额进行结算，产生资损。  \n- [x] 是否有客诉：否\n- [x] 是否有社会舆情_：_否\n- [x] 是否产生资损：是\n\n资损影响说明：影响206单，理论资损：25081.2744人民币，因雅高要求全部赔付，因此实际资损=理论资损。\n\n[新雅高.xlsx](https://yuque.antfin.com/attachments/lark/0/2024/xlsx/147156506/1731031190281-909f73aa-7c5f-40fe-b327-8bc8e96b42bf.xlsx)\n\n## 二、故障过程回顾\n2024-05-13 10:00，马来西亚旅游税放开全量**【风险注入】【故障发生】**\n\n2024-06-04 15:17，工单反馈雅高直连下单价格错误**【故障发现】**[工单链接](https://tickets.alibaba-inc.com/goc-ticket/workbench/ticket/2022102800005690534?page=1&spm=goc-apm.goc-ticket_tickets.0.0.12f32288sqS5Oc) \n\n2024-06-05 10:17，工单接手同学拉群处理**【业务响应】**\n\n2024-06-05 13:54，工单接手同学联系司博排查问题\n\n2024-06-05 14:17，[@司博](undefined/yy299213) 定位到问题，国际卖价模式没有把日历化的税加进去**【初因定位】**\n\n2024-06-05 18:58，修复分支开始发布**【恢复执行】**\n\n2024-06-05 20:45，修复分支发布完成，故障恢复**【故障恢复】**\n\n## 三、故障原因\n### 3.1【背景说明】\n**【需求背景】**\n\n+ 马来西亚政府在20230101开始征收的**10马币/每间夜的旅游税**，飞猪平台预定向用户代收，并按照要求向马来西亚税局缴纳。除马来西亚外，其他国家也有类似旅游税，技术方案设计上也要考虑扩展性。\n\n**【交易主要变更】**：交易底价模式和卖价模式拆分两个价格模型（用户视角和商家视角）\n\n![](https://intranetproxy.alipay.com/skylark/lark/__puml/3ec50a8eb032673f0556a6172fab208c.svg)\n\n\n\n### 3.2【原因分析】\n##### 一句话原因：\n雅高使用税前价下单，直连是通过税后价－税得出税前价，但是马来税项目改造过程中存在问题，将国际落库的日历化的税丢掉了，导致算出的税前价=税后价 - 0=税后价。\n\n雅高拿到的价格偏高，月末结算时雅高要求使用偏高的价格来跟飞猪进行结算。\n\n##### 根因分析：\n:::info\n+ 雅高和飞猪的合作模式是卖价模式（直销），商家推送至飞猪侧的房费价格是含税价（只含商品税），且飞猪不可修改商家推送价格。故之前系统实现卖价模式时，**卖家实收金额=商品总房费**，一个字段承载。\n+ 旅游税项目改造中，**马税由飞猪平台代收代缴**，商家侧无感知，卖价模式中出现了**卖价加价**场景，故之前的税费字段需要拆分成两个字段，即：1.旅游税+商品税（交易单）2.商品税(履约单)。\n\n:::\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/4256582/1718331802560-55f19236-c302-4d19-b847-3167ba3c1688.png)\n\n在hotel-buy项目中",
    "chunk_order_index": 0,
    "full_doc_id": "doc-7a2e7e2c99354e449fa9c40031352d43"
  },
  "chunk-860213a2c3a373db96e1feb080359ce4": {
    "tokens": 1200,
    "content": "价**场景，故之前的税费字段需要拆分成两个字段，即：1.旅游税+商品税（交易单）2.商品税(履约单)。\n\n:::\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/4256582/1718331802560-55f19236-c302-4d19-b847-3167ba3c1688.png)\n\n在hotel-buy项目中日历化价格模型中少设置了日历化的只含商品税的金额\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/4256582/1718346891712-78d9c9b9-bf33-4af4-8ff0-514ed5a9b4c3.png)\n\n导致hbs在落库调用第三方直连创单落地链路中没有将日历化的商品税设置到直连模型中。因为只有日历化价格有误，总的税的价格无误，且履约单上的价格也无错误，没有影响到结算。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/4256582/1718347445755-b93852ea-e246-4fcf-a0eb-22096e2989f8.png)\n\n直连系统是通过（税后价－商品税）计算得出税前价给到雅高，即总房费-商品税(0)=税前总房费，导致给到雅高的税前价=税后价-0=税后价，直连创单的价格偏高。\n\n## 四、关注点分析\n**【系统质量】**\n\n- [x] **方案评估**\n1. **方案评估的时候是否有评估到税费字段的修改？**\n\n**问题总结：**方案变更了较多次，中间方案评估的时候未评估到税费字段需要更改，开发过程中才评估到\n\n**改进点：**后续方案评估的时候尽量考虑全面，包括直连的落库和非落库场景。\n\n- [x] **代码质量：**\n1. **是否经过CR？CR阶段为何没有发现问题？**\n\n**问题总结：**有经过CR，但CR难以识别到细节字段漏传\n\n**改进点：**后续需求评估的时候应评估到位，才能尽量保证CR阶段Review更完整。\n\n2. **是否经过测试？测试阶段为何没有发现问题？自动化测试是否可以覆盖？**\n\n**问题总结：**因为是新需求，评估的时候遗漏了，所以这次发现不了，自动化测试可能录入的时候也是错的发现不了，但是后续如果该场景迭代，自动化测试可以发现。[@名龙](undefined/minghailong.mhl) 720 和国际税相关的自动化测试梳理完。KeyAction\n\n**改进点：**价格一致性比对，对生单的链路没有做，后续增加上监控。[@名龙](undefined/minghailong.mhl) 730 KeyAction\n\n- [x] **变更质量：**\n1. **是否经过灰度？灰度期间为何没有发现问题？**\n\n**问题总结：**有灰度，大盘监控没有异常，直连监控创单判断属于信息流，没有监控\n\n**改进点：**价格一致性比对监控，同上。\n\n2. **有没有分批发布，分批上线期间为何没有发现问题？**\n\n**问题总结：**同灰度期间问题，相关监控缺失\n\n**改进点：**价格一致性比对监控，同上。\n\n- [x] **处置能力-故障发现及响应：**\n1. **故障是通过工单反馈的，是否可以通过监控发现？**\n\n**问题总结：**相关监控缺失\n\n**改进点：**价格一致性比对监控，同上。\n\n2. **工单反馈1天后才开始拉群找人处理，是否满足工单处理SLA？若满足，SLA的时效要求是否需要调整？**\n\n**问题总结：**满足工单SLA，无需进行调整\n\n**改进点**：无\n\n- [x] **处置能力-故障定位及恢复：**\n1. **初因定位后4个多小时才修复上线，止血的速度是否还有提升空间？是否可以增加预案？**\n\n**问题总结：**当时判断未影响直连下单成功率，不会有资损，因此并未当做紧急场景处理。\n\n**改进点：**无\n\n### 4.1【系统质量】\n#### 4.1.1 需求&设计评估\n**〖关注点1〗****是否涉及产品、技术方案评估？此核心的问题是什么，如何改进？**\n\n- [x] **是，涉及**\n    - [x] 需求评估遗漏\n    - [ ] 产品设计缺陷\n    - [ ] 系统架构设计缺陷\n        - [ ] 容错性不足 \n        - [ ] 单点，无冗余\n        - [ ] 缺乏自我保护\n        - [ ] 缓存设计不当\n        - [ ] 容量评估不足\n        - [ ] 非幂等设计\n        - [ ] 强弱依赖不合理\n        - [ ]",
    "chunk_order_index": 1,
    "full_doc_id": "doc-7a2e7e2c99354e449fa9c40031352d43"
  },
  "chunk-4b5934b90a93a3efb7e1b2cd0a49191d": {
    "tokens": 1200,
    "content": "- [ ] 产品设计缺陷\n    - [ ] 系统架构设计缺陷\n        - [ ] 容错性不足 \n        - [ ] 单点，无冗余\n        - [ ] 缺乏自我保护\n        - [ ] 缓存设计不当\n        - [ ] 容量评估不足\n        - [ ] 非幂等设计\n        - [ ] 强弱依赖不合理\n        - [ ] 其他：__________\n- [ ] 否，不涉及\n\n**〖问题总结〗**方案评估的时候未评估税费字段需要更改，开发过程中才评估到\n\n**〖改进点〗**后续方案评估的时候尽量考虑全面，包括直连的落库和非落库场景。\n\n#### 4.1.2 代码质量\n**〖关注点2〗****是否经过CodeReview？CodeReview阶段是否发现问题？为何没发现？**\n\n+ **是否经过CR**\n    - [x] 是\n    - [ ] 否\n    - [ ] 不涉及\n+ **是否设置合理的CR卡点**\n    - [x] 是\n    - [ ] 否\n    - [ ] 不涉及\n+ **CodeReview阶段是否发现问题？为何没发现？后续如何发现？**\n    - [ ] 是\n    - [x] 否\n    - [ ] 不涉及\n\n**〖问题分析〗**CR难以识别到细节字段漏传。\n\n**〖改进点〗**后续需求评估的时候应评估到位，才能尽量保证CR阶段Review更完整。\n\n\n\n**〖关注点3〗****测试阶段**\n\n+ **测试内容：**涉及的测试提交单、测试用例等\n+ **测试人员：名龙**\n+ **是否经过测试验证**\n    - [x] 是，验证环境\n        - [x] 预发环境\n        - [ ] 日常环境\n    - [x] 是，测试方法\n        - [ ] 单元测试\n        - [x] 功能回归测试\n        - [ ] 集成测试/链路测试\n        - [ ] 验收测试\n    - [ ] 否\n    - [ ] 不涉及\n+ **测试未发现原因是什么？后续如何改进？**\n    - [ ] 回归测试遗漏\n        - [ ] 手工回归测试用例遗漏\n        - [x] 自动化未建设\n        - [x] 自动化回归覆盖不足\n        - [ ] 其他：__________\n    - [ ] 新场景测试遗漏\n        - [ ] 功能测试用例遗漏，包括正常分支和异常分支\n        - [ ] 容灾兜底测试遗漏\n        - [ ] 客户端兼容性测试遗漏\n        - [ ] 埋点测试遗漏\n        - [ ] 性能测试遗漏，影响评估不足\n        - [ ] 安全测试遗漏\n    - [x] 其他：评估不到位\n\n#### 4.1.3 变更质量\n+ **是否涉及变更：**\n    - [x] 是\n    - [ ] 否\n+ **变更类型：**\n    - [x] 代码发布\n    - [ ] 配置变更\n    - [ ] 其他变更：____________\n    - [ ] 不涉及\n+ **变更平台是否接入ChangeFree：**\n    - [x] 是，CF变更单链接：[https://aicf.alibaba-inc.com/aicf/approval/detail/7428674?spm=goc-apm.aicf-_myWorkbench_-mode?.0.0.577e2388Uej45y](https://aicf.alibaba-inc.com/aicf/approval/detail/7428674?spm=goc-apm.aicf-_myWorkbench_-mode?.0.0.577e2388Uej45y)\n    - [ ] 否\n+ **是否违反变更红线3.1**** **[链接](https://aliyuque.antfin.com/ngoc/fzg6dy/uar1k6)\n    - [ ] 是，违反哪条原则：\n    - [x] 否\n\n\n\n**〖关注点1〗****灰度阶段**\n\n+ **是否经过灰度：**\n    - [x] 是\n    - [ ] 否\n+ **观测了哪些监控**：\n    - [_https://ateye.trip.taobao.com/monitor/exceptionList.htm?app=hbs_](https://ateye.trip.taobao.com/monitor/exceptionList.htm?app=hbs)\n    - [_https://sunfire.alibaba-inc.com/custom/59/product/preview/cms/1250_](https://sunfire.alibaba-inc.com/custom/59/product/preview/cms/1250)\n    - [_https://s.alibaba-inc.com/#/publish/32961703_](https://s.alibaba-inc.com/#/publish/32961703)\n    - [_https://bcp.alibaba-inc.com/rules/newcountrules?isX=1&step=2&isAdd=0&id=malaysia_tourism_tax_](https://bcp.alibaba-inc.com/rules/newcountrules?isX=1&step=2&isAdd=0&id=malaysia_tourism_tax)\n    - [x] 黑屏、白屏\n    - [x] GOC监控：\n    - [x] 系统大盘：\n    - [ ] 其他：___________\n+ **是否灰",
    "chunk_order_index": 2,
    "full_doc_id": "doc-7a2e7e2c99354e449fa9c40031352d43"
  },
  "chunk-6a724e0515209ddccd9e65e78a7c6646": {
    "tokens": 930,
    "content": "step=2&isAdd=0&id=malaysia_tourism_tax_](https://bcp.alibaba-inc.com/rules/newcountrules?isX=1&step=2&isAdd=0&id=malaysia_tourism_tax)\n    - [x] 黑屏、白屏\n    - [x] GOC监控：\n    - [x] 系统大盘：\n    - [ ] 其他：___________\n+ **是否灰度期间发现问题？**\n    - [ ] 是\n        - [ ] 是否灰度流量过大，导致故障\n        - [ ] 灰度发现但未有效或及时修复，导致故障\n        - [ ] 其他：___________\n    - [x] 否，后续如何灰度发现？_____________\n+ **未灰度发现原因**\n    - [ ] 应用灰\n        - [ ] 灰度流量太小\n        - [ ] 灰度阶段无监控\n        - [ ] 灰度批次不合理\n        - [ ] 超长时间灰度才能发现\n    - [ ] 业务灰：策略不合理\n    - [ ] 灰度无法发现\n    - [x] 其他：灰度监控遗留\n\n**〖问题总结〗**直连监控创单没有监控（认为信息流），大盘监控无法发现\n\n**〖改进点〗**增加价格一致性比对监控\n\n\n\n**〖关注点2〗****上线阶段**\n\n+ **是否有确定的监控观测指标**\n    - [x] 是，监控指标及监控链接：[https://ateye.trip.taobao.com/monitor/exceptionList.htm?app=hbs](https://ateye.trip.taobao.com/monitor/exceptionList.htm?app=hbs)\n    - [ ] 否\n+ **是否在窗口期进行发布变更**\n    - [x] 是\n    - [ ] 否，原因：\n+ **变更是否影响上下游**\n    - [x] 是，是否有提前知会上下游评估及关注变更\n        - [x] 有提前知会\n        - [ ] 没有提前知会\n    - [ ] 否\n\n### 4.2【处置能力】\n#### 4.2.1 故障发现&响应\n+ **是否监控发现**\n    - [ ] 故障触发方 监控发现\n    - [ ] 故障受影响方 监控发现\n    - [x] 否，原因为：（监控缺失）\n+ **是否5分钟内响应**\n    - [ ] 是\n    - [x] 否，原因为：发布过程中无问题，切流过程中无问题，上线后监控未发现问题。月底结束打款雅高工单反馈发现。\n+ **是否存在应急协同问题**\n    - [ ] 是\n        - [ ] 应急流程不明确（无流程或者流程不清晰、应急相关角色&职责不明确，缺失一号位等)\n        - [ ] 应急执行不到位（有流程，但未按流程执行，通告发送不及时，响应不及时等）\n    - [x] 否\n\n#### 4.2.2 故障定位&恢复\n+ **主要恢复方式：**\n    - [x] 代码发布/回滚\n    - [ ] 配置发布/回滚\n    - [ ] 数据订正\n    - [ ] 机器隔离/重启/扩容\n    - [ ] 配置限流\n    - [ ] 预案降级\n    - [ ] 自动恢复\n    - [ ] 其他：\n\n## 五、故障Action\n| **序号** | *******Action** | *******负责人** | *******计划完成时间** | **是否keyAction** |\n| :---: | --- | :---: | :---: | --- |\n| 1 | 短期：建立交易金额价格相关监控（价格一致性比对监控） | 名龙 | 7.30 | 是 |\n| 2 | 短期：梳理和国际税相关的自动化测试用例 | 名龙 | 7.20 | 是 |",
    "chunk_order_index": 3,
    "full_doc_id": "doc-7a2e7e2c99354e449fa9c40031352d43"
  },
  "chunk-a357600c44e19690e6bbac62afbfbf07": {
    "tokens": 1200,
    "content": "## 一、故障简述\n故障简述：【p3】【火车票本人改签】2023年1月2日～2024年5月14日，线下订单的本人改签功能，在低改高场景下，部分改签出票失败订单，实际是出票成功的，造成资损。通过调整线上配置的方式恢复。\n\n\n\n行业背景：\n\n火车票供应能力分自营和线下，自营是通过爬取123x6接口实现出票等能力。飞猪自营实现了123x6的app/pc/zfb协议爬取能力，其中端直连、node、banama都是app协议。飞猪app主要使用端直连承接，node和banama兜底，手淘等h5渠道主要使用banama和node承接。\n\n\n\n## 二、影响产品线及影响面\n影响面：\n\n理论资损预计xxW，实际资损xxw+\n\n## 资损明细\n[改签资损订单](https://alidocs.dingtalk.com/i/nodes/MNDoBb60VLYDGNPytvR7AE9PJlemrZQ3?cid=41968708199&utm_scene=person_space&doc-mode=edit)\n\n## 追款明细\n[改签订单](https://alidocs.dingtalk.com/i/nodes/YMyQA2dXW7gYo6MzcKjdaXPOWzlwrZgb?doc-mode=edit&utm_scene=person_space&cid=59120580456)\n\n\n\n## 二、故障过程回顾\n### 2.1【故障处理时间线】\n_/* 填写说明：整体故障时间线参考_【故障引入】**【故障发生】【故障发现】**【故障响应】【故障定位】【恢复执行】**【故障恢复】**【影响消除】_时间点。*/_\n\n_如涉及跨BG协同处理，可分BG整理时间线。_\n\n\n\n故障时间线1：\n\n2022-09-07【故障引入】本人改签发布\n\n\n\n故障时间线2：\n\n2024-04-12【扩大影响】端直连净土上线\n\n2024-04-12 11:19**【故障发生】**出现第一笔资损\n\n2024-05-13 19:50**【故障发现】**高峰过后本人改出票成功率没有彻底恢复\n\n2024-05-14 21:46【故障定位】分析到安卓渠道上线端直连净土能力，定位到存在资损场景\n\n2024-05-14 21:47【恢复执行】【**故障恢复**】关闭端直连净土\n\n2024-05-21 17:15【影响消除】修复漏洞\n\n\n\n关键时间点：\n\n| 事件 | 时间 | 影响单（资金） |\n| --- | --- | --- |\n| 本人改签上线 | 2022年10月27日～2024年4月11日 | 202单（29121元） |\n| 端直连净土上线 | 2024年4月12日～2024年5月14日 | 675单（103858元） |\n\n\n![画板](https://intranetproxy.alipay.com/skylark/lark/0/2024/jpeg/3756480/1717039489097-265581c7-e477-4367-80f3-e75fedef7324.jpeg)\n\n\n\n## 三、故障原因\n### 3.1【背景说明】\n_/* 填写说明：根据实际情况，选择填写下面的内容 */_\n\n+ _【业务链路】以业务调用链路图的形式说明故障发生的具体场景_\n+ _【需求背景】故障涉及到的需求背景介绍，以及变更内容_\n\n背景：\n\n本人改签（资损基础）+ node切流（扩大影响面） + 端直连净土（扩大影响面）\n\n\n\n核心原因：\n\n| 引入需求 | 角色 | bug | 影响 |\n| --- | --- | --- | --- |\n| 本人改签 | 根因 | 端直连低改高场景下，用户支付成功后端直连没有查询飞猪支付结果，直接查询出票结果。 | 导致绝大部份端直连本人改签需要服务端兜底任务来保障履约。 |\n| 端直连净土 | 扩大影响 | 端直连净土和其他环境在设备上进行隔离，同一个用户在端直连用一个设备，在服务端banama/node用另一个设备。 | 因为123x6本人系列的接口，需要刷脸才能使用，刷脸的结果绑定在设备上，切换账号会导致刷脸结果失效，后续流程无法正常进行。 |\n\n\n![](https://intranetproxy.alipay.com/skylark/lark/__puml/d8fea7a3959a93cfe3a7aeb75118ec28.svg)\n\n\n\n\n\n### 3.2【原因分析】\n_/* 填写说明：先一句话简要概述原因，再具体根因分析，不限于业务代码逻辑说明、变更配置逻辑和日志分析等*/_\n\n+ _如编码/配置相关问题，可补充问题代码/配置截图_\n+ _如架构相关问题，可补充系统链路图_\n\n一句话原因：\n\n技术方案设计存在漏洞，端直连支付动作和查询出票结果存在并发。\n\n根因",
    "chunk_order_index": 0,
    "full_doc_id": "doc-5155c66d52855ae177ce3de5b0630aef"
  },
  "chunk-d7adc563fae06d54cf0dfcaca074c882": {
    "tokens": 1200,
    "content": "原因分析】\n_/* 填写说明：先一句话简要概述原因，再具体根因分析，不限于业务代码逻辑说明、变更配置逻辑和日志分析等*/_\n\n+ _如编码/配置相关问题，可补充问题代码/配置截图_\n+ _如架构相关问题，可补充系统链路图_\n\n一句话原因：\n\n技术方案设计存在漏洞，端直连支付动作和查询出票结果存在并发。\n\n根因分析：\n\n### 问题流程\n![](https://intranetproxy.alipay.com/skylark/lark/__puml/a9caa1a20f22782aec48db3e79afe17e.svg)\n\n### **正确流程**\n\n![](https://intranetproxy.alipay.com/skylark/lark/__puml/d3c0a6688cbed255efd8fedd2683dc70.svg)\n\n## \n\n\n## \n## 四、关注点分析\n_/* 填写说明：根据故障实际情况可增删关注点，并提供详细内容分析*/_\n\n### 4.1【系统质量】\n#### 4.1.1 需求&设计评估\n**〖关注点1〗****是否涉及产品、技术方案评估？此核心的问题是什么，如何改进？**\n\n- [x] **是，涉及**\n    - [ ] 需求评估遗漏\n    - [ ] 产品设计缺陷\n    - [x] 系统架构设计缺陷\n        - [x] 容错性不足 \n        - [ ] 单点，无冗余\n        - [ ] 缺乏自我保护\n        - [ ] 缓存设计不当\n        - [ ] 容量评估不足\n        - [ ] 非幂等设计\n        - [ ] 强弱依赖不合理\n        - [ ] 其他：__________\n- [ ] 否，不涉及\n\n**〖问题总结〗本人改签端直连场景下，低改高用户支付后的流程与标准流程不符****。**\n\n**〖改进点〗**_**需明确写明不同故障相关方的改进项（若有的话），下同。**_\n\n1、按照三端架构统一规范，梳理端直连正逆向功能，完成改造。\n\n\n\n#### 4.1.2 代码质量\n**〖关注点1〗是否代码自身存在漏洞或BUG、代码健壮性是否存在问题等?**\n\n**〖问题分析〗**\n\n**〖改进点〗**_**需明确写明不同故障相关方的改进项（若有的话），下同。**_\n\n**〖关注点2〗****是否经过CodeReview？CodeReview阶段是否发现问题？为何没发现？**\n\n+ **是否经过CR**\n    - [x] 是\n    - [ ] 否\n    - [ ] 不涉及\n+ **是否设置合理的CR卡点**\n    - [x] 是\n    - [ ] 否\n    - [ ] 不涉及\n+ **CodeReview阶段是否发现问题？为何没发现？后续如何发现？**\n    - [ ] 是\n    - [x] 否\n    - [ ] 不涉及\n\n**〖问题分析〗******\n\n**〖改进点〗**_**需明确写明不同故障相关方的改进项（若有的话），下同。**_\n\n\n\n\n\n**〖关注点3〗****测试阶段**\n\n+ **测试内容：**涉及的测试提交单、测试用例等\n+ **测试人员：双屿、语实**\n+ **是否经过测试验证**\n    - [x] 是，验证环境\n        - [x] 预发环境\n        - [ ] 日常环境\n    - [x] 是，测试方法\n        - [x] 单元测试\n        - [x] 功能回归测试\n        - [x] 集成测试/链路测试\n        - [x] 验收测试\n    - [ ] 否\n    - [ ] 不涉及\n+ **测试未发现原因是什么？后续如何改进？**\n    - [ ] 回归测试遗漏\n        - [ ] 手工回归测试用例遗漏\n        - [ ] 自动化未建设\n        - [ ] 自动化回归覆盖不足\n        - [ ] 其他：__________\n    - [ ] 新场景测试遗漏\n        - [ ] 功能测试用例遗漏，包括正常分支和异常分支\n        - [ ] 容灾兜底测试遗漏\n        - [ ] 客户端兼容性测试遗漏\n        - [ ] 埋点测试遗漏\n        - [ ] 性能测试遗漏，影响评估不足\n        - [ ] 安全测试遗漏\n    - [x] 其他：____极端异常场景，无法通过测试环节发现______\n\n**〖问题总结〗**\n\n**〖改进点〗**_**需明确写明不同故障相关方的改进项（若有的话），下同。**_\n\n1. \n\n#### 4.1.3 变更质量\n+ **是否涉及变更：**\n    - [x] 是\n    - [ ] 否\n+ **变更类型：**\n    - [x] 代码发布\n    - [x] 配置变更\n    - [ ] 其他变更：____________\n    - [ ] 不涉及\n+ **变更平台是否接入ChangeFree：**\n    - [x] 是，CF",
    "chunk_order_index": 1,
    "full_doc_id": "doc-5155c66d52855ae177ce3de5b0630aef"
  },
  "chunk-c7d4d0ff54a21787554f379611a985ae": {
    "tokens": 1200,
    "content": ". \n\n#### 4.1.3 变更质量\n+ **是否涉及变更：**\n    - [x] 是\n    - [ ] 否\n+ **变更类型：**\n    - [x] 代码发布\n    - [x] 配置变更\n    - [ ] 其他变更：____________\n    - [ ] 不涉及\n+ **变更平台是否接入ChangeFree：**\n    - [x] 是，CF变更单链接：________\n\n_/*要这样的链接_ [https://aicf.alibaba-inc.com/aicf/change/detail/1725370372](https://aicf.alibaba-inc.com/aicf/change/detail/1725370372) */\n\n    - [ ] 否\n+ **是否违反变更红线3.1**** **[链接](https://aliyuque.antfin.com/ngoc/fzg6dy/uar1k6)\n    - [ ] 是，违反哪条原则：\n    - [x] 否\n\n\n\n**〖关注点1〗****灰度阶段**\n\n+ **是否经过灰度：**\n    - [x] 是\n    - [ ] 否\n+ **观测了哪些监控**：_可以附链接_\n    - [ ] 黑屏、白屏\n    - [x] GOC监控：\n    - [x] 系统大盘：\n    - [ ] 其他：___________\n+ **是否灰度期间发现问题？**\n    - [ ] 是\n        - [ ] 是否灰度流量过大，导致故障\n        - [ ] 灰度发现但未有效或及时修复，导致故障\n        - [ ] 其他：___________\n    - [x] 否，后续如何灰度发现？______理论上很难通过灰度发现_______\n+ **未灰度发现原因**\n    - [ ] 应用灰\n        - [ ] 灰度流量太小\n        - [ ] 灰度阶段无监控\n        - [ ] 灰度批次不合理\n        - [ ] 超长时间灰度才能发现\n    - [ ] 业务灰：策略不合理\n    - [ ] 灰度无法发现\n    - [x] 其他：______自身指标无问题，业务指标受影响；处于高峰期指标波动剧烈______\n\n**〖问题总结〗监控不够细；审计能力覆盖不全**\n\n**〖改进点〗**_**需明确写明不同故障相关方的改进项（若有的话），下同。**_\n\n1、端直连增加用户来源渠道对比监控\n\n2、不同供给渠道的成功率对比监控报警（已有）\n\n3、[通用性资金审计](https://aliyuque.antfin.com/fuqaf0/ozkf1k/ikvd9mot90eqw3u9)（票务/交易、支付宝/票务、票务支付关单）\n\n\n\n**〖关注点2〗****上线阶段**\n\n+ **是否有确定的监控观测指标**\n    - [x] 是，监控指标及监控链接：\n    - [ ] 否\n+ **是否在窗口期进行发布变更**\n    - [x] 是\n    - [ ] 否，原因：\n+ **变更是否影响上下游**\n    - [x] 是，是否有提前知会上下游评估及关注变更\n        - [x] 有提前知会\n        - [ ] 没有提前知会\n    - [ ] 否\n\n**〖问题总结〗**\n\n**〖改进点〗**_**需明确写明不同故障相关方的改进项（若有的话），下同。**_\n\n\n\n### 4.2【处置能力】\n#### 4.2.1 故障发现&响应\n+ **是否监控发现**\n    - [x] 故障触发方 监控发现\n    - [ ] 故障受影响方 监控发现\n    - [ ] 否，原因为：\n+ **是否5分钟内响应**\n    - [x] 是\n    - [ ] 否，原因为：\n+ **是否存在应急协同问题**\n    - [ ] 是\n        - [ ] 应急流程不明确（无流程或者流程不清晰、应急相关角色&职责不明确，缺失一号位等)\n        - [ ] 应急执行不到位（有流程，但未按流程执行，通告发送不及时，响应不及时等）\n    - [x] 否\n\n**〖问题总结〗**\n\n**〖改进点〗**_**需明确写明不同故障相关方的改进项（若有的话），下同。**_\n\n\n\n#### 4.2.2 故障定位&恢复\n+ **主要恢复方式：**\n    - [x] 代码发布/回滚\n    - [x] 配置发布/回滚\n    - [ ] 数据订正\n    - [ ] 机器隔离/重启/扩容\n    - [ ] 配置限流\n    - [ ] 预案降级\n    - [ ] 自动恢复\n    - [ ] 其他：\n+ **是否10分钟内恢复**_/* P1P2故障填写*/_\n    - [ ] 是\n    - [ ] 否，原因：__________\n\n**〖关注点1〗定位&恢复阶段存在什么问题？是否可以增加",
    "chunk_order_index": 2,
    "full_doc_id": "doc-5155c66d52855ae177ce3de5b0630aef"
  },
  "chunk-00be6e2f858cd7966418c8bea3e1de69": {
    "tokens": 861,
    "content": "[ ] 机器隔离/重启/扩容\n    - [ ] 配置限流\n    - [ ] 预案降级\n    - [ ] 自动恢复\n    - [ ] 其他：\n+ **是否10分钟内恢复**_/* P1P2故障填写*/_\n    - [ ] 是\n    - [ ] 否，原因：__________\n\n**〖关注点1〗定位&恢复阶段存在什么问题？是否可以增加预案，****有更快的恢复方式？****相关的优化改进？**\n\n**〖问题总结〗**\n\n**〖改进点〗**\n\n\n\n**〖关注点2〗业务自身是否具备容灾逃逸能力？后续如何改进？**_/* 如涉及基础设施引发的故障，可填写*/_\n\n- [ ] 具备容灾能力\n    - [ ] 因未演练不敢执行\n    - [ ] 因有损评估决策不执行\n    - [ ] 无决策或者决策不当，未执行\n- [ ] 不具备容灾能力\n\n**〖问题总结〗**\n\n**〖改进点〗**\n\n\n\n## 五、故障总结反思\n_/* P1故障必填，主要用于总结分享和提炼分析*/_\n\n**【做得好的】**\n\n最佳实践\n\n**【经验教训】**\n\n1. 端直连供给渠道，仍存在不符合三端架构统一标准的模块，需要全部完成改造。\n2. 票务研发的工作更多是对于异常场景的处理，技术方案规范中需要增加对于异常场景流程处理设计的要求。\n3. 资金审计需要完成对支付宝<->票务<->交易全链路的覆盖。\n4. 监控能力在细分领域（来源渠道、供给渠道）仍存在覆盖上问题，需要补齐。\n\n## 六、故障Action\n| **序号** | *******Action标题** | *******负责人** | *******计划完成时间** | **验收标准** | **验收人** | **是否keyAction** | **是否回血Action** |\n| --- | --- | --- | --- | --- | --- | --- | --- |\n| 1 | 本人改签兜底查询失败时，1236非归库状态均转待确认处理 | 梵低 | 5.23 | 当非明确定义的改签失败场景时，支付后订单均转改签结果待确认 | 双屿 | | 是 |\n| 2 | 本人改签，端直连用户支付后增加查询查询支付结果逻辑 | 梵低、君仲 | 5.28 | 客户端改签订单，支付后查询12306信息前，均要请求接口确认是否给路局支付成功 | 双屿 | 是 | |\n| 3 | [资金审计](https://aliyuque.antfin.com/fuqaf0/ozkf1k/ikvd9mot90eqw3u9)(支付宝<->票务<->交易) | 勿痴 | 6.15 |  | 双屿 | | |\n| 4 | 分渠道对比监控 | 君仲 | 6.15 | 安卓/ios的所有业务指标可以做到对比监控报警 | 婉风 |  | |\n| 5 | 协议层/供给业务层新增错误码和错误码量突增，增加sunfire监控 | 君仲、梵低 | 7.30 |  | 婉风 |  | |\n| 6 | 三端架构统一完成全量改造 | 君仲、梵低 | 7.30 | 端直连业务层和服务端ao逻辑完全一致 | 婉风 |  | |\n| 7 | 票务供给技术方案规范-异常场景 | 梵低 | 6.15 |  | 明决 | | |",
    "chunk_order_index": 3,
    "full_doc_id": "doc-5155c66d52855ae177ce3de5b0630aef"
  },
  "chunk-4679a36f13846f8e6c68b83d5b307bb2": {
    "tokens": 1200,
    "content": "## 一、故障简述\n故障简述：3月20日ean订单大盘单量相对比日常翻了近6倍，技术侧开始针对单量上涨情况进行数据分析和排查潜在问题，21点在确认业务投放人群没问题后，发现ean在C端售卖没有带税费\n现象：htq不落库算价变更发布；部分供应商试单价格不含税，主要受影响供应商是ean\n\n**订单数：1638  间夜数：3383**\n\n总税费：XX元**\n**履约率：按照0.74计算**\n**理论资损：XX元\n\n\n### 2.1【故障处理时间线】\n故障时间线：\n\n2024-03-19 上午，算价主流程修复需求产研验收完成；计划3.19下午开始进行变更发布上线；\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/16548/1711113600518-4eac9250-e518-410b-a7f1-4f0ecf7055a6.png)\n\n2024-03-19 17:21， 南博操作hiqc不落库算价变更上线发布 【ean导购价格与交易价格，此时已经存在变价】\n\n2024-03-20 14:00， 南博操作htq不落库算价变更上线发布；ean下单价格未加上税；【故障发生】\n\n2024-03-20 22:04，汐云接到产品电话反馈ean故障发生；【故障发现】\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/16548/1710990690256-87f58268-96d2-4840-84f5-70c8c145916f.png)\n\n2024-03-21 22:12，针对该问题发起视频会议电话开始排查定位；\n\n2024-03-20 22:25，根据故障发生时间线开始对焦当天的应用变更发布时间线后，决策先将当天下午2点的htq应用发布进行回滚，后续讨论过程中决策将hiqc也一并进行回滚； \n\n2024-03-20 22:25，多多操作htq进行回滚；【执行操作】\n\n2024-03-20 22:33，南博操作hiqc进行回滚；【执行操作】\n\n2024-03-20 22:45，hiqc回滚操作完成；\n\n2024-03-20 22:48，htq回滚操作完成；\n\n2024-03-20 22:46，业务刘坤反馈线上有问题的报价已经重新刷新为含税报价，但PD凌翰、才夕反馈线上验证仍存在问题；\n\n2024-03-20 23:07，经直连技术排查定位，原因是试单缓存影响，故进行关闭试单缓存开关推送；【故障恢复】\n\n2024-03-20 23:40，经产研线上验证、直连日志比对确认，线上故障已恢复；\n\n## 三、故障原因\n### 3.1【背景说明】\n_/* 填写说明：根据实际情况，选择填写下面的内容 */_\n\n+ _【业务链路】以业务调用链路图的形式说明故障发生的具体场景_\n+ _【需求背景】故障涉及到的需求背景介绍，以及变更内容_\n\n**产品优化需求:**\n\n[**https://aliyuque.antfin.com/linghan.lx/pt54vb/xryni2gtgskcyag2?singleDoc#**](https://aliyuque.antfin.com/linghan.lx/pt54vb/xryni2gtgskcyag2?singleDoc#)\n\n### 3.2【原因分析】\n_/* 填写说明：先一句话简要概述原因，再具体根因分析，不限于业务代码逻辑说明、变更配置逻辑和日志分析等*/_\n\n+ _如编码/配置相关问题，可补充问题代码/配置截图_\n+ _如架构相关问题，可补充系统链路图_\n\n一句话原因：\n\n国际不落地的日历化报价模型中，dailyInfo->basePrice字段语义定义为含税报价，历史上全部供应商都应该以含税报价进行实现，且在技术方案设计前置调研过程中经产品、技术线下对焦确认该点后，最终使用basePrice字段；但历史ean的直连实现存在问题，basePrice赋值逻辑为不含税报价，导致资损故障；\n\n根因分析：\n\n#### 本变更发布背景【需求背景】：\n      国际代理商在给飞猪报价时，都会报给飞猪总报价（含税），而其中部分代理商会给飞猪总报价+日历化报价，飞猪日历化报价的历史计算逻辑是根据总报价平均后计算得出，并未使用到商家的日历化报价；导致部分退、协商退场景和商家结算时无法对齐日历化价格，同时给到消费者侧的日历化价格计算错误，导致客诉；故业务侧提出当代理商有给飞猪日历化报价时，需优先使用日历化报价进行售卖价格金额计算；\n\n      附：\n\n_      本",
    "chunk_order_index": 0,
    "full_doc_id": "doc-d6781f4845cd8ad644baeef161d0d830"
  },
  "chunk-47e348c50cd1b75605162275d6e108ae": {
    "tokens": 1200,
    "content": "逻辑是根据总报价平均后计算得出，并未使用到商家的日历化报价；导致部分退、协商退场景和商家结算时无法对齐日历化价格，同时给到消费者侧的日历化价格计算错误，导致客诉；故业务侧提出当代理商有给飞猪日历化报价时，需优先使用日历化报价进行售卖价格金额计算；\n\n      附：\n\n_      本变更需求PRD：_[_https://aone.alibaba-inc.com/v2/project/1170390/req/55137103#_](https://aone.alibaba-inc.com/v2/project/1170390/req/55137103#) 《【商品】价库计算现存逻辑优化(不落库算价向上取整+日历化算价逻辑优化)》_  \n__      _国际代理商：即国际供应商，对应住宿的国际不落地技术链路；不落地的日历化报价模型为hotel-model二方包工程的com.taobao.trip.hotel.model.DailyInfo类，其中的日历化报价字段basePrice为2016.04.06定义；\n\n\n\n#### 技术方案设计前置调研：\n(1)国际不落地商品模型语义定义：根据DailyInfo->taxPrice字段的注释信息，可以判断出日历化报价字段basePrice为含税报价；\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/16548/1711102976432-f84f638c-5950-4389-9e75-634765ba895d.png)\n\n(2)3.15 11:30~12:30，算价域产技（PD：凌翰，开发：南博、汐云）、直连技术（开发：多多、枭奇）线下对焦，结论明确basePrice是含税报价；\n\n_**后续故障发生后review直连代码发现仅ean的basePrice为不含税价，其余供应商为含税价；**_\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/16548/1711110068059-8029b02c-529b-4a19-bb6e-d048b8683e1d.png)\n\n\n\n#### 问题触发根因\n+ 直连对接侧（问题代码根因）\n\n（1）ean直连对接侧的赋值实现逻辑，dailyInfo中的basePrice是不含税的日历化报价\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/16548/1711112572857-8d5d5034-25af-463e-ab0b-95ceb45c632b.png)\n\n  （2）baseTotalPrice是含税总报价\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/16548/1711112667371-d4195c3b-ae3c-4157-b158-784e3d442fb4.png)\n\n\n\n+ 不落库算价链路本次需求改造点（本故障触发点）\n\n（1）修改后计算逻辑，如是有日历化 basePrice则使用日历化数据basePrice，出现问题；\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/111256390/1710951223291-5221b3c0-198f-4603-a6e4-d6fa48e2d4d1.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/111256390/1710951235380-089cdc24-fb43-4919-ad34-a786d276fbd0.png)\n\n（2）原来计算逻辑，将 baseTotalPrice平均到每一天作为日历化的 basePrice；\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/111256390/1710951081021-5eb1d6d6-6473-47c5-a81d-dfd5412c99fd.png)\n\n#### 历史直连产品需求review\n1. EAN接入报价prd：[https://aone.alibaba-inc.com/v2/project/862614/req/22344112](https://aone.alibaba-inc.com/v2/project/862614/req/22344112)\n\n2019.09.02“供应商EAN接口升级”的需求prd中，明确日历化报价的basePrice映射为ean的不含税报价；\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/16548/1711344033882-1dbe02b1-e6c8-49d8-bd2f-235ae0ce30b4.png)\n\n2. Agoda接入报价prd：[https://aone.alibaba-inc.com/v2/project/1170390/req/52538967](https://aone.alibaba-inc.com/v2/project/1170390/req/52538967)\n\n2023.10.09“Agoda报价取值逻辑优化”需求PRD中，明确日历化报价的basePrice为含税报价；**与EAN的需求冲突；**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/",
    "chunk_order_index": 1,
    "full_doc_id": "doc-d6781f4845cd8ad644baeef161d0d830"
  },
  "chunk-87a607cf93947624a05571a069b6a662": {
    "tokens": 1200,
    "content": "/v2/project/1170390/req/52538967](https://aone.alibaba-inc.com/v2/project/1170390/req/52538967)\n\n2023.10.09“Agoda报价取值逻辑优化”需求PRD中，明确日历化报价的basePrice为含税报价；**与EAN的需求冲突；**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/16548/1711344224930-a7645293-284c-4399-98eb-aba6deb1e6c2.png)\n\n## 四、关注点分析\n_/* 填写说明：根据故障实际情况可增删关注点，并提供详细内容分析*/_\n\n### 4.1【系统质量】\n#### 4.1.1 需求&设计评估\n**〖关注点1〗****是否涉及产品、技术方案评估？此核心的问题是什么，如何改进？**\n\n- [x] **是，涉及**\n    - [ ] 需求评估遗漏\n    - [ ] 产品设计缺陷\n    - [ ] 系统架构设计缺陷\n        - [ ] 容错性不足 \n        - [ ] 单点，无冗余\n        - [ ] 缺乏自我保护\n        - [ ] 缓存设计不当\n        - [ ] 容量评估不足\n        - [ ] 非幂等设计\n        - [ ] 强弱依赖不合理\n        - [ ] 其他：__________\n- [ ] 否，不涉及\n\n**〖问题总结〗**\n\n**〖改进点〗**_**需明确写明不同故障相关方的改进项（若有的话），下同。**_\n\naction：\n\n#### 4.1.2 代码质量\n**〖关注点1〗是否代码自身存在漏洞或BUG、代码健壮性是否存在问题等?**\n\n**〖问题分析〗**\n\n**〖改进点〗**_**需明确写明不同故障相关方的改进项（若有的话），下同。**_\n\n1、\n\n\n\n**〖关注点2〗****是否经过CodeReview？CodeReview阶段是否发现问题？为何没发现？**\n\n+ **是否经过CR**\n    - [ ] 是\n    - [ ] 否\n    - [ ] 不涉及\n+ **是否设置合理的CR卡点**\n    - [ ] 是\n    - [ ] 否\n    - [ ] 不涉及\n+ **CodeReview阶段是否发现问题？为何没发现？后续如何发现？**\n    - [ ] 是\n    - [ ] 否\n    - [ ] 不涉及\n\n**〖问题分析〗******\n\n**〖改进点〗**_**需明确写明不同故障相关方的改进项（若有的话），下同。**_\n\n1、\n\n\n\n**〖关注点3〗****测试阶段**\n\n+ **测试内容：**涉及的测试提交单、测试用例等\n+ **测试人员：**\n+ **是否经过测试验证**\n    - [x] 是，验证环境\n        - [ ] 预发环境\n        - [ ] 日常环境\n    - [ ] 是，测试方法\n        - [ ] 单元测试\n        - [ ] 功能回归测试\n        - [ ] 集成测试/链路测试\n        - [ ] 验收测试\n    - [ ] 否\n    - [ ] 不涉及\n+ **测试未发现原因是什么？后续如何改进？**\n    - [ ] 回归测试遗漏\n        - [ ] 手工回归测试用例遗漏\n        - [ ] 自动化未建设\n        - [ ] 自动化回归覆盖不足\n        - [ ] 其他：__________\n    - [ ] 新场景测试遗漏\n        - [ ] 功能测试用例遗漏，包括正常分支和异常分支\n        - [ ] 容灾兜底测试遗漏\n        - [ ] 客户端兼容性测试遗漏\n        - [ ] 埋点测试遗漏\n        - [ ] 性能测试遗漏，影响评估不足\n        - [ ] 安全测试遗漏\n    - [ ] 其他：__________\n\n**〖问题总结〗**\n\n**〖改进点〗**_**需明确写明不同故障相关方的改进项（若有的话），下同。**_\n\n1、日历化价格优化测试覆盖是覆盖了agoda、hotelbeds和ean，但是由于该字段是含税推入，在验证上主要是针对agoda进行价税分离确认没问题后，未对ean价税分离再做单独覆盖。另外，本次除测试数据外，使用线上供应商数据进行了验证，包括agoda、hotelbeds 等，同时将线上和预发的结果进行了比较。。\n\n测试报告：[https://aliyuque.antfin.com/alitripqa/lxxtgx/orpeh8s3p70xkiy0](https://aliyuque.antfin.com/alitripqa/lxxtgx/orpeh8s3p70xkiy0)\n\n#### 4.1.3 变更质量\n+ **是否涉及变更：**\n    - [x] 是\n    - [ ] 否\n+ **变更类型：**\n    - [x] 代码发布  6批  间隔30分钟\n    - [ ] 配置变更\n    - [ ] 其他变更：____________\n    - [ ]",
    "chunk_order_index": 2,
    "full_doc_id": "doc-d6781f4845cd8ad644baeef161d0d830"
  },
  "chunk-0a5eeb70a4959b077de896d98a18128c": {
    "tokens": 1200,
    "content": "xxtgx/orpeh8s3p70xkiy0)\n\n#### 4.1.3 变更质量\n+ **是否涉及变更：**\n    - [x] 是\n    - [ ] 否\n+ **变更类型：**\n    - [x] 代码发布  6批  间隔30分钟\n    - [ ] 配置变更\n    - [ ] 其他变更：____________\n    - [ ] 不涉及\n+ **变更平台是否接入ChangeFree：**\n    - [ ] 是，CF变更单链接：____[https://aicf.alibaba-inc.com/aicf/change/v2/detail/828085556?spm=goc-apm.aicf-_changeList.0.0.71a023885TjsnG](https://aicf.alibaba-inc.com/aicf/change/v2/detail/828085556?spm=goc-apm.aicf-_changeList.0.0.71a023885TjsnG)____\n\n_/*要这样的链接_ [https://aicf.alibaba-inc.com/aicf/change/detail/1725370372](https://aicf.alibaba-inc.com/aicf/change/detail/1725370372) */\n\n    - [ ] 否\n+ **是否违反变更红线3.1**** **[链接](https://aliyuque.antfin.com/ngoc/fzg6dy/uar1k6)\n    - [ ] 是，违反哪条原则：\n    - [x] 否\n\n\n\n**〖关注点1〗****灰度阶段**\n\n+ **是否经过灰度：**\n    - [ ] 是\n    - [x] 否\n\n**〖问题总结〗本次bug修复需求无 灰度切流 配置。**\n\n\n\n**〖关注点2〗****上线阶段**\n\n+ **是否有确定的监控观测指标**\n    - [x] 是，监控指标及监控链接：[https://sunfire.alibaba-inc.com/custom/59/product/preview/spm/10141](https://sunfire.alibaba-inc.com/custom/59/product/preview/spm/10141)； \n    - [ ] 否\n\n**〖问题总结〗1、订单量增加相关的预警未配置 2、**进行了系统观察，未进行业务or大盘观察。\n\n**〖改进点〗**_**需明确写明不同故障相关方的改进项（若有的话），下同。**_\n\n1、\n\n### 4.2【处置能力】\n#### 4.2.1 故障发现&响应\n+ **是否监控发现**\n    - [ ] 故障触发方 监控发现\n    - [ ] 故障受影响方 监控发现\n    - [x] 否，原因为：（监控无效/监控缺失）\n+ **是否5分钟内响应**\n    - [x] 是\n    - [ ] 否，原因为：\n+ **是否存在应急协同问题**\n    - [ ] 是\n        - [ ] 应急流程不明确（无流程或者流程不清晰、应急相关角色&职责不明确，缺失一号位等)\n        - [ ] 应急执行不到位（有流程，但未按流程执行，通告发送不及时，响应不及时等）\n    - [x] 否\n\n**〖问题总结〗**\n\n**〖改进点〗**_**需明确写明不同故障相关方的改进项（若有的话），下同。**_\n\n1、\n\n#### 4.2.2 故障定位&恢复\n+ **主要恢复方式：**\n    - [x] 代码发布/回滚\n    - [ ] 配置发布/回滚\n    - [ ] 数据订正\n    - [ ] 机器隔离/重启/扩容\n    - [ ] 配置限流\n    - [ ] 预案降级\n    - [ ] 自动恢复\n    - [ ] 其他：\n\n**〖关注点1〗定位&恢复阶段存在什么问题？是否可以增加预案，****有更快的恢复方式？****相关的优化改进？**\n\n**〖问题总结〗**\n\n**〖改进点〗**\n\n1、\n\n\n\n## 五、故障总结反思\n_/* P1故障必填，主要用于总结分享和提炼分析*/_\n\n**【做得好的】**\n\n最佳实践\n\n**【经验教训】**\n\n举一反三，学习，避免踩坑\n\n## 六、故障Action\n| **序号** | *******Action标题** | *******负责人** | *******计划完成时间** | **Action描述** | **验收标准** | **验收人** | **是否keyAction** | **是否回血Action** |\n| --- | --- | --- | :---: | --- | --- | :---: | --- | --- |\n| 1 | htq\\hiqc\\htc 代码梳理，by供应商维度进行价格字段及其含义的梳理 | 4.12 | | 汐云、枭奇、言慕、凌翰 |  | | | |\n| 2 | 价格中心基线用例梳理，包括国际不落库/国际落库/国内落库链路，同时区分直连与非直连场景自动化：KA供应商用例维护 | 4.19 | | 晓枝、重杨 | keyaction | |",
    "chunk_order_index": 3,
    "full_doc_id": "doc-d6781f4845cd8ad644baeef161d0d830"
  },
  "chunk-91e0cbbaba45aec5bf07e674225ab4e8": {
    "tokens": 281,
    "content": "义的梳理 | 4.12 | | 汐云、枭奇、言慕、凌翰 |  | | | |\n| 2 | 价格中心基线用例梳理，包括国际不落库/国际落库/国内落库链路，同时区分直连与非直连场景自动化：KA供应商用例维护 | 4.19 | | 晓枝、重杨 | keyaction | | | |\n| 3 | 监控：by供应商维度(KA: agoda, ean,hotelbeds,booking)建设算价监控。关注商家（报文）-对接（对接模型）-商品（商品模型）价格一致性。 | 4.19 | | 南博、重杨 | keyaction | | | |\n| 4 | 价格基线专项，区分国内国际建设；区分底价、卖价的商品报价、同一srid含税不含税的报价gap过大情况； | 4.30 | | 汐云 | 方案产出 | | | |\n| 5 | 供应商价格关于总价和日历化价格产品侧方案Action | 4.30 | | 凌翰 | 方案产出 | | | |",
    "chunk_order_index": 4,
    "full_doc_id": "doc-d6781f4845cd8ad644baeef161d0d830"
  },
  "chunk-1e4180e2cc49922557196210a6b3dd0e": {
    "tokens": 1200,
    "content": "## 一、故障概述（含影响产品线及影响面）\n**故障概述：**\n\n于 2022-10-20 16:18开始，酒店/行业履约/成功量 最近10分钟最小值大于等于20且成功量最近10分钟与基线同比下跌大于等于20%。触达p4，故障原因初步怀疑为下单渲染问题导致，于16:42恢复正常。\n\n## 二、故障过程回顾【故障处理时间线】\n### 【1-5-10概览】\n![画板](https://intranetproxy.alipay.com/skylark/lark/0/2022/jpeg/345666/1666523057980-9416845f-c9b3-4b13-a514-ff87bd729e80.jpeg)\n\n### 【故障处理时间线】\n整体故障时间线。需要着重强调【故障注入】【故障发生】【故障发现】【业务响应】【故障定位】【恢复执行】【故障恢复】时间点。\n\n\n\n【故障注入】\n 2022-10-20 16:03由于业务需求，需要在dii的shotel表上新增字段country，类型int64(long)，于16:03配置完成，同时触发表数据重新回流，回流后新增字段可在dii中查询到，计划在预发环境使用\n\n\n\n问题数据切换从16:12开始，16:14左右问题数据开始提供服务\n\n【故障发现】\n\n16:15报警群收到详情页有结果率下跌报警\n\n【故障发生】\n2022-10-20 16:24  监控值班发现从16:18开始，酒店/行业履约/成功量 最近10分钟最小值大于等于20且成功量最近10分钟与基线同比下跌大于等于20%\n【业务响应】\n2022-10-20 16:19列表页、详情页缓存预案自动开启，有结果率逐步恢复，但交易仍未恢复\n\n【故障定位】\n2022-10-20 16:28 正好看到业务提工单，显示商品因shotel被过滤，想到shotel的配置变更\n【恢复执行】\n2022-10-20 16:30回滚了shotel索引数据，16:45回滚了shotel表配置\n【故障恢复】\n2022-10-20 16:35数据回滚完成，16:40缓存关闭，16:42交易指标恢复\n\n\n\n## 三、故障影响面\n\n\n+ 飞猪导购：\n\n问题数据切换从16:12开始，16:14左右问题数据开始提供服务，16:17问题数据覆盖所有机器，此时实时查询酒店报价皆无返回，16:30执行数据回滚，16:35左右线上服务已无问题数据\n\n16:14详情页接口有结果率开始下跌，16:18触发详情页缓存预案，16:20详情页有结果率大致恢复，16:40缓存关闭\n\n+ 飞猪交易\n\n10.20提交订单：2084，影响订单约1100单（含高德等分销）\n\n10.19提交订单：3236\n\n10.13提交订单：3186\n\n+ 商旅\n\n非协议价企业下了协议价单，对接系统拦截报错\n\n影响订单：20+\n\n+ 高德\n\n高德创单影响：约550单\n\n高德询价成功率影响：16:14开始下跌，16:18跌至20%左右，16:30开始恢复，16:35恢复正常\n\n\n\n## 四、故障原因\n### 4.1【一句话原因】\n底层dii数据链路表配置错误导致数据丢失，导致线上数据有结果率下跌，出现故障后触发缓存预案，缓存数据不合理引起其他问题导致交易成功量未恢复至正常水位\n\n\n\n### 4.2【背景说明】\n_/* 根据实际情况，选择填写下面的内容 */_\n\n因业务需求，需要在dii shotel表新增countryCode字段，由于此字段在db中暂未启用，所以回流时赋默认值-99，新增字段生效需要重新回流表数据，所以触发了表回流，由于hse2的预发和线上共用一套底表数据，且共用最新的回流版本，所有集群在回流结束后自动触发重新构建shotel索引\n\n### 4.3【根因分析】\n+ dii配置错误\n\n此次问题出在新增字段的类型由于疏忽在dii里设置成了无符号数字（UINT64）\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/345666/1666339269243-8d8106c6-b31d-4074-94ef-f0042d16e95b.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/345666/1666263235219-f26a52b5-4096-4b1c-9fd6-415ee350c6ca.png)\n\n数据回流时并没有提示数据处理错误，此时认为回流成功\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/345666/1666339401488-6d6cb347-b9d8-4c1a-be82-4c457",
    "chunk_order_index": 0,
    "full_doc_id": "doc-4236d45a2d825e1edb878258a8c4412d"
  },
  "chunk-c76a92302fa159abe9ed67d446e14806": {
    "tokens": 1200,
    "content": "1666263235219-f26a52b5-4096-4b1c-9fd6-415ee350c6ca.png)\n\n数据回流时并没有提示数据处理错误，此时认为回流成功\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/345666/1666339401488-6d6cb347-b9d8-4c1a-be82-4c457be037ae.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/345666/1666263437415-e0abc2aa-30ce-4e37-98c9-1ef03792d6c9.png)\n\n结果在dii服务读取回流数据构建索引时由于country值类型不匹配未生成索引，导致酒店商品召回时都因为查不到shotel信息被过滤\n\n+ 详情页缓存数据问题\n\n详情页缓存存储机制目前较为简单，没有区分端（APP、h5）、渠道（小搜、商旅等），导致触发缓存预案后，触发以下的问题\n\n1、App用户请求详情页时获取到了H5的下单页链接，下单页链接中透传的字段触发了下单页老版本渲染新版营销表达的校验拦截\n\n2、商旅和小搜共用一套缓存数据，导致商旅侧透出了非商旅渠道的商品\n\n+ C端预加载白屏问题\n\n触发缓存预案后，预加载查询缓存无结果时，返回了空结果，前端未处理异常情况缓存了结果，导致了前端渲染白屏\n\n+ 高德下单页渲染失败问题\n\n高德下单页依赖导购详情页接口用于补充商品信息，问题发生后，详情页开启缓存，不在缓存中酒店无法获取商品信息，导致了高德下单页打开失败，进而导致了交易大幅下跌\n\n+ 预案平台自动开关问题\n\n部分机器详情页缓存预案启动失败，有几台机器未开启缓存，导致预案启动后详情页有结果率未完全恢复\n\n## 四、故障关注点\n### 4.2【处置能力】\n#### 4.2.1 故障发现&响应\n+ **是否监控发现**\n    - [x] 是\n        - [x] 故障触发方\n        - [ ] 受影响方\n    - [ ] 否 ：\n    - [ ] 1、监控发现，但预警平台存在未结单的记录，后续预警无法发出来。[@徙南](undefined/kaibo.skb)[@拾里](undefined/sywyawen.syw) 2、行业预警条件需要优化[@雅净](undefined/sunny.zyj)\n+ **发现后是否五分钟内响应**\n    - [x] 是\n    - [ ] 否，原因为：\n\n#### 4.2.2 故障定位&恢复\n+ **故障涉及恢复方式：**\n    - [ ] 代码发布\n    - [ ] 代码回滚\n    - [x] 配置回滚\n    - [ ] 隔离\n    - [ ] 扩容\n    - [ ] 重启\n    - [ ] 限流\n    - [ ] 降级预案\n    - [ ] 自动恢复\n    - [ ] 其他：\n\n## 五、故障Action\n| **ACTION** | **是否keyAction** | **计划完成时间** | **验收标准** | **Action负责人** |\n| --- | --- | --- | --- | --- |\n| 现有的dii表都复制一个pre环境专用表，使用独立的saro实例，每次dump变更都需要在pre环境使用的saro实例执行大全量，在dii预发表回流完成、索引构建成功、hse2pre功能验证通过后再发布上线 | 是 | 10.28 | saro和dii都有预发专用的实例和配置 | 令渊 |\n| dii日志采集归类分析 | 是 | 11.15 |  | 令渊 |\n| 缓存机制需要支持多端多渠道多场景的差异化存储，梳理核心链路上的端、渠道、场景差异对使用同一份缓存的影响。 | 是 | 11.30 |  | 致曲 |\n| 当缓存机制触发时，需要梳理哪些相对非核心的功能需要暂停提供，比如预加载 | | 11.30 | | 致曲、归玄 |\n| 目前下单过程中对下单页链接中的参数有很重的依赖，需要交易梳理下单依赖的核心参数，提供给导购作为详情页缓存的重点关注因子，非核心参数存在问题需有兜底机制保障，在此类问题出现时至少能保障下单页核心的信息渲染没问题 | 否 | 11.30 | | 致曲 |\n| 由于对高德来说无论询价、验价、商品查询都是分销，但是对飞猪来说不同接口的数据实时性、稳定性、重保程度都是有差异的，我们需要了解高德各接口的使用场景，去确认接口使用场景的合理性。就高德下单页依赖导购酒店详情接口获取",
    "chunk_order_index": 1,
    "full_doc_id": "doc-4236d45a2d825e1edb878258a8c4412d"
  },
  "chunk-20c40e7c74af5eea66271c6ca146f9d1": {
    "tokens": 175,
    "content": "页核心的信息渲染没问题 | 否 | 11.30 | | 致曲 |\n| 由于对高德来说无论询价、验价、商品查询都是分销，但是对飞猪来说不同接口的数据实时性、稳定性、重保程度都是有差异的，我们需要了解高德各接口的使用场景，去确认接口使用场景的合理性。就高德下单页依赖导购酒店详情接口获取商品信息来说，建议高德可从验价接口一起获取商品信息，而不需要单独调详情接口查询 | 否 | 11.30 | | 嘉厚、村牧、随喜 |\n| 配合预案平台同学一起排查预案没有覆盖所有机器的原因，由他们给出解决方案 | 是 | | | |",
    "chunk_order_index": 2,
    "full_doc_id": "doc-4236d45a2d825e1edb878258a8c4412d"
  },
  "chunk-63b10755f799d60f65c94c2b8f5d6dc0": {
    "tokens": 1200,
    "content": "## 一、故障简述\n0:16 触发飞猪客户端崩溃影响设备率异常报警，Crash率最近10分钟最小值大于1%，Crash量最近10分钟均值大于500 ，经排查问题初步的原因是互动平台配置的一个URL异常，导致crash，1:16修改里程中心任务URL配置后恢复\n\n## 二、故障过程回顾\n### 2.1故障链接\n[https://cofree.alibaba-inc.com/ormEmergency/workbench/emergency/202311060000000013001?__tenant__=alibabaGroup&activeTabKey=timeline](https://cofree.alibaba-inc.com/ormEmergency/workbench/emergency/202311060000000013001?__tenant__=alibabaGroup&activeTabKey=timeline)\n\n### 2.1【故障处理时间线】\n**【故障发现】**2023-11-06 00:16，监控触发报警，监控值班开始联系研发处理\n\n**【故障发生】**2023-11-06 00:18，Crash率最近10分钟最小值大于1%，Crash量最近10分钟均值大于500，达到P3故障\n【开发响应】2023-11-06 00:19，旅鹤接手风险预警单\n【故障通告】2023-11-06 00:31，发布故障通告，创建应急协同群。\n【初因定位】2023-11-06 00:50，初步排查为url中多了一个空格导致crash\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/80256373/1699238861319-4b78d0b8-7729-4f26-a539-68f69ead7fcc.png)\n\n【根因定位】2023-11-06 00:54，问题确定，里程福利中心内的任务配置有问题，全日航空店铺的URL不合法导致的crash，开始联系相关同学修改里程任务配置。\n【恢复执行】2023-11-06 01:16 步鲁修改里程任务中的关注店铺领取里程的店铺url后恢复\n【故障恢复】2023-11-06 01:17 监控恢复正常水位，故障恢复\n\n## 三、故障原因\n### 3.1【背景说明】\n运营通过互动平台投放在里程福利中心的定时任务（时间：11-06 00:00-23:59），用户做任务跳转到配置的店铺URL，由于URL不合法导致iOS端崩溃。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/275212/1699257518013-b420d4d7-4b8a-4501-918f-f4d160fe7e44.png)\n\n### 3.2【原因分析】\n**一句话原因**：\n\n运营同学在互动平台配置投放的店铺域名包含空格（[http://shop220306746.m.taobao.com](http://shop220306746.m.taobao.com/)%20），导致iOS容器URL对象实例化解析异常。\n\n**根因分析：**\n\n1. 运营同学在互动平台配置时未去掉URL末尾空格\n2. 互动平台URL配置校验没有去掉URL内的空格\n3. iOS容器加载时，未校验域名合法性，导致非法URL作为入参调用了系统API，进而触发App异常崩溃。由于URL配置错误，如果校验了将会导致页面白屏。\n\n## 四、关注点分析\n### 4.1【系统质量】\n#### 4.1.1 代码质量  \n**〖关注点1〗是否代码自身存在漏洞或BUG、****代码健壮性****是否存在问题等?**\n\n**〖问题分析〗客户端活动配置端对异常url处理不够健壮**\n\n**〖改进点〗**_****_增加对异常场景的兼容处理\n\n\n\n**〖关注点2〗****测试阶段**\n\n**〖问题分析〗**容灾兜底测试遗漏\n\n**〖改进点〗**增加对容器层的异常场景的用例覆盖\n\n\n\naction: 投放url要求携带spm相关参数 兆兆  潇琴  （互动玩法）  会场投发待确认\n\n## 五、故障Action\n| **序号** | *******Action标题** | *******负责人** | *******计划完成时间** | **Action描述** | **验收标准** | **验收人** | **是否keyAction** | **是否回血Action** |\n| --- | --- | --- | --- | --- | --- | :---: | --- | --- |\n| 1 | 短期：互动平台增加URL合法性校验 | 李文娟 | 已完成 | |  | | | |\n| 2 | 短期：容器增加URL合法性校验，对URL内的非法字符编码，不触发系统异常 | 中冉 | 11.12 |  |  | | | |\n| 3 | 长期：增加对容器层的异常场景的用例覆盖 | 昭元 | 11.30 | 加上 url兼容 |  | | | |",
    "chunk_order_index": 0,
    "full_doc_id": "doc-ffb4b38b4b899deaef264bac4627b57b"
  },
  "chunk-eaed989086a07b5b825353f2e2c4c2db": {
    "tokens": 358,
    "content": "文娟 | 已完成 | |  | | | |\n| 2 | 短期：容器增加URL合法性校验，对URL内的非法字符编码，不触发系统异常 | 中冉 | 11.12 |  |  | | | |\n| 3 | 长期：增加对容器层的异常场景的用例覆盖 | 昭元 | 11.30 | 加上 url兼容 |  | | | |\n| | 长期：互动、玩法、会员域前后台配置校验、定时巡检，互动任务发布增加自测预演环节作为强卡口 | 潇琴  | S2 | [互动域 action 拆分](https://aliyuque.antfin.com/guideqa/cf4p2e/rxk3uszsfknqqwid?singleDoc# 《1106[暂定]飞猪客户端崩溃影响设备率-链接带空格》) | | | | |\n\n\n\n\n## 六、影响产品线&影响面\n平均每分钟20台设备crash，影响1330个用户完成“浏览页面得里程”的任务 \n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/80256373/1699239059854-8515f26d-579f-4213-a9ac-198ba24c015f.png)![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/80256373/1699326009174-1e431935-9544-4fd9-adb0-938474c03e5b.png)\n\n##",
    "chunk_order_index": 1,
    "full_doc_id": "doc-ffb4b38b4b899deaef264bac4627b57b"
  },
  "chunk-f991a7af371ccbd1323d123c3f6f1142": {
    "tokens": 1200,
    "content": "## 一、故障简述\n故障简述：于15:10起，酒店_渲染订单_异常，成功量最近10分钟与基线同比下跌大于等于40%，成功量最近10分钟最小值大于等于55，已达到P3故障，于15:15打开兜底线上开始恢复，于15:23变更回退完成，故障恢复\n\n## 二、故障过程回顾\n### 2.1【故障处理时间线】\n故障时间线：\n\n2023-11-16 15:05:00 详情页无结果率开始持续下跌（dii索引一个集群的索引批次已切换完成）；![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/77256373/1700213818464-6eb32f9d-fc47-4714-86ed-db84b1c5d643.png)\n\n2023-11-16 15:09:00 导购报警群，详情页无结果率开始触发阈值报警；（dii索引所有集群索引批次全部切换结束，su nfire晚两分钟报警）【故障发现】\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/77256373/1700213972963-5b5e5741-193d-4d7a-91ed-b5eb1470bff7.png)\n\n2023-11-16 15:11:00，白柒、致曲开始关注，致曲开始为切换列表详情缓存开关作准备，弹定开始检查是否是下午dii索引变更引发的问题，同时令渊也来协助定位；【应急响应】\n\n2023-11-16 15:14:00，令渊、弹定确认是dii表索引变更时，新增了一个无符号类型字段，导致索引切换后，hse2经过dii4j插件处理时，因java不支持无符号类型导致获取不到shotel表数据引发问题；【初因定位】\n\n2023-11-16 15:14:38，弹定在令渊指导下开始点击「切换索引」手动切换每个集群的问题表的全量索引至上一个无问题版本；【执行操作】\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/77256373/1700395579322-afda8f04-f865-4726-8be1-f067b9640f59.png)\n\n2023-11-16 15:15，列表页、详情页缓存切换完成，有结果率开始回升【执行操作】\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/77256373/1700214193782-a22b0100-e1d0-43c5-a8da-c0cd915ac992.png)\n\n2023-11-16 15:17:35 高德缓存切换完成，有结果率回升8%(高德只缓存了一个大C账号的数据)【执行操作】\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/77256373/1700552275041-845780e5-b1a7-4186-ac39-4814938e5f71.png)\n\n2023-11-16 15:19，预警触发，生产预警事件\n2023-11-16 15:19，触发酒店渲染订单成功量下跌故障等级定义【故障发生】\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/80256373/1700536762308-83604aa0-32c4-4c40-9f6c-5aa40a1f0937.png)\n\n2023-11-16 15:23，所有集群全部切换成上一个版本索引后，致曲操作关闭详情和列表页缓存，有结果率GOC监控开始恢复正常，弹定开始选择spe环境，测试新构建索引可用性，后验证可用性过后，取消手动切换的止血索引并将索引切换模式更改为自动切换【故障恢复】\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/77256373/1700214379987-61511a01-bd58-4adc-955b-4b88e73a48bd.png)\n\n\n\n## 三、故障原因\n### 3.1【原因分析】\n一句话原因：\n\n新增dii的shotel表字段类型时，使用了无符号数据类型，dii4j没有支持无符号类型转换，导致最终标准酒店数据获取为空。  \n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/77256373/1700214685181-dbe91398-3ef6-43c5-b0e4-ef28b13247d8.png)\n\n根因分析：\n\n国际儿童价需求需要在shotel/rate_plan/sroomType新增字段判断是否支持儿童价，该表操作已在预发环境进行过验证，最终在发布上线shotel表时，新增",
    "chunk_order_index": 0,
    "full_doc_id": "doc-23d5818050db7171cf8eb22bd29ed08e"
  },
  "chunk-54208b0c192d9e3bf4d08197ba85d092": {
    "tokens": 1200,
    "content": "intranetproxy.alipay.com/skylark/lark/0/2023/png/77256373/1700214685181-dbe91398-3ef6-43c5-b0e4-ef28b13247d8.png)\n\n根因分析：\n\n国际儿童价需求需要在shotel/rate_plan/sroomType新增字段判断是否支持儿童价，该表操作已在预发环境进行过验证，最终在发布上线shotel表时，新增的字段选成无符号类型，因java不支持无符号数据类型导致数据转化失败，hse2获取不到shotel表数据，因为酒店商品的数据依托于标准酒店，标准酒店召回失败，所以导致无结果。\n\n## 四、关注点分析\n### 4.1【系统质量】\n#### 4.1.1 需求&设计评估  \n**〖关注点1〗****是否涉及产品、技术方案评估？此核心的问题是什么，如何改进？**\n\n- [ ] **是，涉及**\n    - [ ] 需求评估遗漏\n    - [ ] 产品设计缺陷\n    - [ ] 系统架构设计缺陷\n        - [ ] 容错性不足 \n        - [ ] 单点，无冗余\n        - [ ] 缺乏自我保护\n        - [ ] 缓存设计不当\n        - [ ] 容量评估不足\n        - [ ] 非幂等设计\n        - [ ] 强弱依赖不合理\n        - [ ] 其他：__________\n- [ ] 否，不涉及\n\n**〖问题总结〗**\n\n**〖改进点〗**_**需明确写明不同故障相关方的改进项（若有的话），下同。**_\n\n1、\n\n#### 4.1.2 代码质量  \n**〖关注点3〗****测试阶段**\n\n+ **测试内容：**在预发环境、预发表做过验证\n+ **测试人员：**\n+ **是否经过测试验证**\n    - [ ] 是，验证环境\n        - [x] 预发环境\n        - [ ] 日常环境\n    - [ ] 是，测试方法\n        - [ ] 单元测试\n        - [ ] 功能回归测试\n        - [ ] 集成测试/链路测试\n        - [ ] 验收测试\n    - [ ] 否\n    - [ ] 不涉及\n\n#### 4.1.3 变更质量  涉及\n+ **是否涉及变更：**\n    - [x] 是\n    - [ ] 否\n+ **变更类型：**\n    - [ ] 代码发布\n    - [x] 配置变更\n    - [ ] 其他变更：____________\n    - [ ] 不涉及\n+ **变更平台是否接入ChangeFree：**\n    - [ ] 是，CF变更单链接：________\n\n_/*要这样的链接_ [https://aicf.alibaba-inc.com/aicf/change/detail/1725370372](https://aicf.alibaba-inc.com/aicf/change/detail/1725370372) */\n\n    - [x] 否\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/77256373/1700445353097-995707f0-a528-4b3e-9eed-7870c7d87d47.png?x-oss-process=image%2Fresize%2Cw_1171%2Climit_0)\n\n变更时间：2023-11-16 14:11\n\n\n\n### 4.2【处置能力】\n#### 4.2.1 故障发现&响应\n+ **是否监控发现**\n    - [x] 故障触发方 监控发现 [https://x.alibaba-inc.com/custom/59/product/preview/spm/1506?crossTenant=true](https://x.alibaba-inc.com/custom/59/product/preview/spm/1506?crossTenant=true)\n    - [ ] 故障受影响方 监控发现\n    - [ ] 否，原因为：（监控无效/监控缺失）\n\n**〖问题总结〗**\n\n**〖改进点〗**_**需明确写明不同故障相关方的改进项（若有的话），下同。**_\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/77256373/1700445627529-896887e4-36ce-4230-99af-81e86e7a96a2.png?x-oss-process=image%2Fresize%2Cw_1171%2Climit_0)\n\n#### 4.2.2 故障定位&恢复\n+ **主要恢复方式：**\n    - [ ] 代码发布/回滚\n    - [x] 配置发布/回滚\n    - [ ] 数据订正\n    - [ ] 机器隔离/重启/扩容\n    - [ ] 配置限流\n    - [ ] 预案降级\n    - [ ] 自动恢复\n    - [ ] 其他：\n\n**〖关注点1〗定位&恢复阶段存在什么问题？是否可以增加预案，****有更快的恢复方式？****相关的优化改进？**\n\n**〖问题总结〗**\n\n**〖改进点〗**\n\n由于之前有发生类似问题，所以此次应急速度尚可，缓存止血索引回滚",
    "chunk_order_index": 1,
    "full_doc_id": "doc-23d5818050db7171cf8eb22bd29ed08e"
  },
  "chunk-238d0679c9ec14540546d0f13b951318": {
    "tokens": 1200,
    "content": "限流\n    - [ ] 预案降级\n    - [ ] 自动恢复\n    - [ ] 其他：\n\n**〖关注点1〗定位&恢复阶段存在什么问题？是否可以增加预案，****有更快的恢复方式？****相关的优化改进？**\n\n**〖问题总结〗**\n\n**〖改进点〗**\n\n由于之前有发生类似问题，所以此次应急速度尚可，缓存止血索引回滚止血操作耗时大概在3分钟左右。（缓存的止血操作，索引止血操作）发现故障及时性还有待提高。\n\n此次问题发生后新补充的应急方案：[https://aliyuque.antfin.com/fliggy-hotel/search/kwee0st6frfvhc17](https://aliyuque.antfin.com/fliggy-hotel/search/kwee0st6frfvhc17)\n\n## 六、故障Action\n| **序号** | *******Action标题** | *******负责人** | *******计划完成时间** | **Action描述** | **验收标准** | **验收人** | **是否keyAction** | **是否回血Action** |\n| --- | --- | --- | --- | --- | --- | :---: | --- | --- |\n| 1 | 短期：建立dii线上表可灰度发布方案（建议上线前，先暂停线上集群的索引切换，只切换spe机器，spe验证通过后，再将所有集群切换成自动切换）该方案不适用于rate/rate_plan/inventory这三张大表 | 弹定 | 11.28 |  异步低峰期，按集群灰度，严格要求时间间隔，做好内部宣传 |  | | | |\n| 2 | 短期：重建GOC电话报警 | 弹定 |  11.30 | 检查相关订阅组 | 写到新人师兄手册 | | | |\n| 4 | 短期：check预案平台自动开启缓存机制   | 预案ok | | | | | | |\n| 5 | 短期：建立轮班double check人员机制，所有dii表变更都需要走该同学验证 | 翼翾 | 11.28 | 短期运行 流程方案 |  | | | |\n| 6 | 短期：重建高德缓存机制，隔离大C账号缓存和小C账号缓存，大C/小C账号缓存互为补充 | 弹定 | 11.28 | |  | | | |\n| 7 | 长期：国际国内数据链路隔离 | 翼翾 | S2 | |  | | | |\n| 8 | action：缓存策略兜底优化 （方案 ）  | 弹定 | 11.28 | |  | | | |\n\n\n## 七、影响产品线&影响面\n    - [x] 业务影响：\n        * 影响的产品线，业务功能，功能受损程度（成功量/率下跌多少%），持续多少时\n\n| **产品影响**    | | **业务影响**    |\n| --- | --- | --- |\n| **故障时长:**18分钟    | **影响范围:**酒店链路用户搜索、预定到下单 | **受影响业务:**民宿、商旅、分销、c端日历房酒店交易    |\n| **产品异常:**（1）酒店列表页出现暂无报价 （2）详情页有结果率下跌，用户无法预定酒店      **产品优化需求:**国际酒店儿童价表达       | | **现象:**故障阶段，交易易提交订单总量下跌59%左右。         **业务侧影响:**理论资损，故障时间段，提交订单量下降约2336单（11.15号故障时间段3956单,11.16号故障时间段1620单）    |\n| | |\n\n\n### 导购\n酒店详情页页成功率下跌，2023-11-16 15:05:00——2023-11-16 15:23:00\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/77256373/1700128566474-8b9ad7fc-85a3-44bb-b24c-acabff55340e.png)\n\n### 民宿\n民宿列表页成功率下跌，2023-11-16 15:05:00——2023-11-16 15:23:00\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/77256373/1700447202441-3f48f31c-b95f-4c9d-ad39-69f563562fbe.png)\n\n### 商旅\n商旅详情页成功率下跌，2023-11-16 15:05:00——2023-11-16 15:23:00\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/77256373/1700447380395-a6620781-bd65-4c21-915c-3a1f6e6516d5.png)\n\n### 高德\n影响时间点： 15:09----15:25 飞猪同比昨天少了 1200单左右 总单量影响420左右（其他cp的品补上）（高",
    "chunk_order_index": 2,
    "full_doc_id": "doc-23d5818050db7171cf8eb22bd29ed08e"
  },
  "chunk-70c7d96760d517c2d90c9540ad1127da": {
    "tokens": 427,
    "content": "![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/77256373/1700447380395-a6620781-bd65-4c21-915c-3a1f6e6516d5.png)\n\n### 高德\n影响时间点： 15:09----15:25 飞猪同比昨天少了 1200单左右 总单量影响420左右（其他cp的品补上）（高德交易学祥统计出来）\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/77256373/1700551229610-f30206a5-769a-4061-b35e-62a706841013.png)\n\n### 交易\n提交订单确认有房成功量与昨日同时间段相比下跌，2023-11-16 15:05:00——2023-11-16 15:23:00\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/77256373/1700214468313-d81d178c-7969-441b-9ff4-748dfcf156d2.png)\n\n11月15号 15:05-11月15号 15:23号 提交订单总数3956单\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/77256373/1700546855212-a71c5d32-c5cb-4277-b6dc-454e43232e96.png)\n\n11月16号 15:05-11月16号 15:23号 提交订单总数1620单\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/77256373/1700546971397-ba0cd1ab-4afb-4935-9cb4-7cda32f10b76.png)",
    "chunk_order_index": 3,
    "full_doc_id": "doc-23d5818050db7171cf8eb22bd29ed08e"
  },
  "chunk-739d2c29c359f14c2eecfb9d56c1e1b5": {
    "tokens": 1200,
    "content": "## 一、故障简述\n故障简述：于13:15分开始有飞猪商家反馈工作台异常，13:30左右确认是批量问题，经排查为集团网络配置问题导致，回滚配置后于14:04分恢复\n\n## 二、故障过程回顾\n### 2.1【故障处理时间线】\n故障时间线：\n\n2023-12-04 12:39，会员侧执行pass.fliggy.com 的统一接入变更，cname记录切换到ingress 的alibaba-international 集群。该集群的vipserverkey配置错误(tbpass-web.vipserver 这个vipserverkey线上不存在，应该是tbpass.taobao.com )，会导致pass.fliggy.com域名访问报500错误【故障引入】\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/17583/1701856255499-f1ff4f41-04bb-4e49-a0c0-bb8950788894.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/17583/1701856294473-5812ea35-c3b2-4a9d-aa62-b4d66803c689.png)\n\n2023-12-04 13:15，首例飞猪商家反馈后台无法打开，报错404or500  [https://tickets.alibaba-inc.com/goc-ticket/workbench/ticket/2022102800003927623?page=1](https://tickets.alibaba-inc.com/goc-ticket/workbench/ticket/2022102800003927623?page=1)   【故障发生】\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/80256373/1701674682849-49d62cac-104e-48a4-92c7-c3355d18283e.png)\n\n2023-12-04 13:36，工单超过5例，确认是批量问题拉群处理\n\n2023-12-04 13:41，确认为集团域名解析变更问题【初因定位】\n\n2023-12-04 13:43，飞猪同学电话联系到会员技术相关同学\n\n2023-12-04 13:53，会员技术同学定位到相应变更并执行回滚操作【恢复执行】\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/17583/1701856534001-398229ea-d700-4b68-937a-6f7fecfa316c.png)\n\n2023-12-04 13:55，上一个回滚单审批人无法执行审批操作，会员技术同学重提回滚单\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/17583/1701856638518-d3ee155f-aafe-4214-883f-bf99e5c876a6.png)\n\n2023-12-04 14:02，回滚单审批完成，回滚开始生效\n\n2023-12-04 14:04，配置回滚完成，新dns cname记录开始生效，业务恢复**【故障恢复】**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/80256373/1701672256022-b73722ff-f8e5-4177-8442-7d00a9017ed5.png)\n\n## 三、故障原因\n### 3.1【背景说明】\n背景：业务方期望filggy.com 域名可以通过tbpass能力获取到taobao.com域名的登录态，开发同学评估pass.fliggy.com域名线上暂无业务使用（评估错误，实际上pass.fliggy.com已经在线上运行，无需新增接入），决定在ingress上新增pass.fliggy.com域名的统一接入规则，新增统一接入规则时ingress集群的vipserverkey配置错误（应该是 tbpass.taobao.com，配置成 tbpass-web.vipserver）；导致流量访问到ingress集群后无法路由到对应服务端，报错500\n\n### 3.2【原因分析】\n一句话原因：\n\npass.fliggy.com 域名统一接入配置变更，统一接入配置中vipserverkey 配置错误，导致线上流量访问到统一接入层之后，无法转发到对应后端tbpass-web的服务端，业务请求报错500影响线上业务。\n\n根因分析：\n\n![画板](https://intranetproxy.alipay.com/skylark/lark/0/2023/jpeg/17583/1701857313505-e13010bf-0f53-4e66-a862-4593b3451048.jpeg)\n\n## 四、关注点分析\n### 4.1【系统质量】\n#### 4.1.1 需求&设计评估  \n**〖关注点1〗****是否涉及产品、技术方案评估？此核心的问题是什么，如何改进？**\n\n- [x] **是，涉及**\n    - [x] 需求评估遗漏\n    - [ ] 产品设计缺陷\n    - [ ] 系统架构设计缺陷\n        - [ ] 容错性不足 \n        - [ ] 单点，无冗余\n        - [ ] 缺乏自",
    "chunk_order_index": 0,
    "full_doc_id": "doc-de759906facbbe5be89e3c0f884912b5"
  },
  "chunk-8ba9fce8dd1066aab6098f41f6e2cb2f": {
    "tokens": 1200,
    "content": "估  \n**〖关注点1〗****是否涉及产品、技术方案评估？此核心的问题是什么，如何改进？**\n\n- [x] **是，涉及**\n    - [x] 需求评估遗漏\n    - [ ] 产品设计缺陷\n    - [ ] 系统架构设计缺陷\n        - [ ] 容错性不足 \n        - [ ] 单点，无冗余\n        - [ ] 缺乏自我保护\n        - [ ] 缓存设计不当\n        - [ ] 容量评估不足\n        - [ ] 非幂等设计\n        - [ ] 强弱依赖不合理\n        - [ ] 其他：__________\n- [ ] 否，不涉及\n\n**〖问题总结〗评估流程以及**\n\n**〖改进点〗**_****_\n\n1、action：【流程规定】评估域名是否使用方式（登入机器查nginx日志）\n\n2、action：域名规范接入约定图楠收口，沉淀相关文档（账号+非账号）   \n\n3、action：域名变更时间约定   晨梓    12.14\n\n#### 4.1.3 变更质量 \n+ **是否涉及变更：**\n    - [x] 是\n    - [ ] 否\n+ **变更类型：**\n    - [ ] 代码发布\n    - [ ] 配置变更\n    - [x] 其他变更：__统一接入变更__________\n    - [ ] 不涉及\n+ **变更平台是否接入ChangeFree：**\n    - [x] 是，CF变更单链接：____[https://aicf.alibaba-inc.com/aicf/approval/detail/6828580?spm=goc-apm.aicf-_approvalList.0.0.639023881Im5gI](https://aicf.alibaba-inc.com/aicf/approval/detail/6828580?spm=goc-apm.aicf-_approvalList.0.0.639023881Im5gI)____\n\n[http://idns.alibaba-inc.com/domain_manage/domain_workorder_detail/?order_id=495867](http://idns.alibaba-inc.com/domain_manage/domain_workorder_detail/?order_id=495867)\n\n\n\n**〖关注点2〗****上线阶段**\n\n+ **是否在窗口期进行发布变更**\n    - [x] 是\n    - [ ] 否，原因：\n\n**〖改进点〗**_****_\n\n1、业务技术：监控阈值调整 （下跌50%评估是否调整，可联系相关同学 图楠 ） 晨梓    12.14 \n\n2、飞猪：商家后台首页相关监控梳理 （小程序、app、pass）（需要会员的监控）     图楠   晨梓  12.14   \n\n### 4.2【处置能力】\n#### 4.2.1 故障发现&响应\n+ **是否监控发现**\n    - [ ] 故障触发方 监控发现\n    - [ ] 故障受影响方 监控发现\n    - [x] 否，原因为：（监控无效/监控缺失） 客诉发现\n+ **是否5分钟内响应**\n    - [x] 是\n    - [ ] 否，原因为：\n+ **是否存在应急协同问题**\n    - [ ] 是\n        - [ ] 应急流程不明确（无流程或者流程不清晰、应急相关角色&职责不明确，缺失一号位等)\n        - [ ] 应急执行不到位（有流程，但未按流程执行，通告发送不及时，响应不及时等）\n    - [x] 否\n\n**〖问题总结〗**\n\n**〖改进点〗**_**需明确写明不同故障相关方的改进项（若有的话），下同。**_\n\n1、\n\n#### 4.2.2 故障定位&恢复\n+ **主要恢复方式：**\n    - [ ] 代码发布/回滚\n    - [x] 配置发布/回滚\n    - [ ] 数据订正\n    - [ ] 机器隔离/重启/扩容\n    - [ ] 配置限流\n    - [ ] 预案降级\n    - [ ] 自动恢复\n    - [ ] 其他：\n\n## 六、故障Action\n业务技术\n\naction：统一接入、vipserverkey变更等低频高危操作，后续再会员技术内部会收敛在几个比较熟悉的同学手中，避免工具、流程不熟悉导致的低级错误  晨梓  诺来 12.14\n\naction：tbpass-web.vipserver 这个vipserverKey，在线上各个vipserver环境（国内、新加坡VPC、美东、德国VPC、俄罗斯）同步创建，并保持跟tbpass.taobao.com配置一致。 诺来 晨梓 12.14\n\natcion：相关监控阈值调整 （下跌50%评估是否调整，可联系相关同学 图楠 ） 晨梓    12.14 \n\naction：域名变更时间约定   晨梓    12.14\n\n飞猪\n\naction：商家后台首页相关监控梳理 （小程序、app、pass）（需要会员的监控）     图楠   晨�",
    "chunk_order_index": 1,
    "full_doc_id": "doc-de759906facbbe5be89e3c0f884912b5"
  },
  "chunk-8211196c401f74ffb655410cdbd250b1": {
    "tokens": 392,
    "content": "12.14\n\natcion：相关监控阈值调整 （下跌50%评估是否调整，可联系相关同学 图楠 ） 晨梓    12.14 \n\naction：域名变更时间约定   晨梓    12.14\n\n飞猪\n\naction：商家后台首页相关监控梳理 （小程序、app、pass）（需要会员的监控）     图楠   晨梓  12.14\n\naction：iDS变更回滚能力 （PE没有权限问题等）  海遇     \n\n目前进展（乘黄）：阿里云侧产品答复不能从放开权限入手搞，跟进方案\n\naction：域名规范接入约定图楠收口，沉淀相关文档（账号+非账号）   \n\n## 七、影响产品线&影响面\n    - [ ] 是否影响可用性\n        * 可用性指标，可用性时长消耗\n    - [ ] 业务影响：\n        * 影响的产品线，业务功能，功能受损程度（成功量/率下跌多少%），持续多少时间\n    - [x] 是否有客诉量：\n        * 在线，热线，排队量\n    - [ ] 是否有社会舆情：\n        * 舆情ESU等级/未到E等级，舆情关键词，总声量，负声量\n    - [ ] 是否产生资损：\n        * 理论资损金额，实际资损金额\n\n_/* 可附相关故障等级定义的链接和截图]*/_\n\n链接：\n\n截图：\n\n酒店+度假+交通等域商家工作台平台打开异常，总计150左右投诉量（酒店商服收到85笔无法登录反馈+  商家反馈70+）",
    "chunk_order_index": 2,
    "full_doc_id": "doc-de759906facbbe5be89e3c0f884912b5"
  },
  "chunk-df98b39e373abd309e70064a3c91b612": {
    "tokens": 1200,
    "content": "## 一、故障简述\n故障简述：于15:00左右开始商旅新机票支付监控异常预警，同时有用户反馈飞猪商旅机票搜索不到航班 ，客诉进线量49，于15:44回滚机票圈品配置后恢复\n\n## 二、故障过程回顾\n### 2.1【故障处理时间线】\n故障时间线：\n\n2024-01-02 14:31，产品操作圈品规则修改 【故障引入】**【故障发生】**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256373/1704184165353-b7be5413-a37d-42bd-9060-8ba7e5d41bef.png)\n\n2024-01-02 15:04，商旅机票预定场景监控预警【故障发现】\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256373/1704184301328-e6d0ea9d-4489-4480-8e35-315806a208d5.png)\n\n2024-01-02 15:11，拉群后排查问题以及同步进展\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/113921/1704268429977-5b12c3d4-b759-427b-a504-98e8bd33f2f9.png)\n\n2024-01-02 15:11，服务同学单独拉群沟通\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256373/1704185199206-0c3525a8-323e-47a6-8fdd-a8e28f38d789.png)\n\n2024-01-02 15:19，商旅反馈给机票侧，导购和引擎同学进入排查，期间联系运营同学确认14:30左右是否有操作\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/113921/1704268390876-fd85d14d-7439-4ed6-969f-541114cd3b96.png)\n\n2024-01-02 15:41，筛选出可疑变更【初因定位】\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/113921/1704268577573-b938ef49-7457-44bd-9b83-5709949701b0.png)\n\n2024-01-02 15:44，回滚相关配置故障恢复 **【故障恢复】**【恢复执行】\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/113921/1704253320486-f7382fe0-0aca-4a14-910b-86b52f648c53.png)\n\n## 三、故障原因\n### 3.1【背景说明】\n背景：商旅客户投诉下单页经常变价和下单失败，小二提工单经各方排查确认，原因是商旅渠道不支持动态优惠商品下单。为尽快减少客诉，快速临时方案是屏蔽该类货品，长期方案是走需求在供给侧使用原销售价售卖。  \n工单链接：[https://tickets.alibaba-inc.com/ticket/2022102800004098895?page=1](https://tickets.alibaba-inc.com/ticket/2022102800004098895?page=1)\n\n工单排查结论：\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/113921/1704253935730-bbedf395-1b4e-46ba-aeb1-4915489326c7.png)\n\n  \n\n\n### 3.2【原因分析】\n一句话原因：临时方案使用不恰当的屏蔽配置工具和错误配置导致了商旅渠道几乎全部商品被拦截过滤。\n\n根因分析：\n\n##### 原因1：人为配置错误\n售卖规则是用来解决特殊商品（如：返现、旅行套餐）在某些渠道、航司、人群差异化售卖，随时响应航司的政策变化，并不是作为黑名单过滤使用。\n\n在10月份产品同样有商旅屏蔽特殊货品的临时紧急诉求，当时已经明确该配置的使用范围，且配置是在开发监督下进行尝试的，在圈品规则上同时配置了productCode和店铺id。此次同样是临时紧急屏蔽商品，产品侧再次使用了该工具但未通知开发同学，且圈品规则仅配置了productCode，导致误杀几乎所有报价。\n\n![10月份配置的拦截过滤圈品规则](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/113921/1704335122985-b90accf0-4750-4ca7-81bd-7ab85d941587.png)\n\n![10月份屏蔽](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/113921/1704348517885-da3b7a5a-700",
    "chunk_order_index": 0,
    "full_doc_id": "doc-ab0d320e393055c0bbfb9d2bb2f7d420"
  },
  "chunk-f49fb4e53aa663b909f1db2bf4fff03b": {
    "tokens": 1200,
    "content": "圈品规则](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/113921/1704335122985-b90accf0-4750-4ca7-81bd-7ab85d941587.png)\n\n![10月份屏蔽](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/113921/1704348517885-da3b7a5a-7004-4684-9a19-d6e687334c43.png)\n\n![售卖规则常见配置](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/113921/1704260426866-409508d9-ece5-4d2b-bbcb-33c59a6d38be.png)\n\n\n\n![旅行套餐售卖规则配置详情](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/113921/1704260553412-bef31bdb-3b1e-4593-afe1-4134a69abb6d.png)![航司政策变化屏蔽返现售卖](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/113921/1704260677389-9d6ec669-01eb-4cbe-bb54-036a816b7df3.png)\n\n\n\n售卖规则执行分成3个步骤：选品、渠道匹配、删除商品\n\n1. 选品：一个圈品规则可以有多个匹配条件，一舱多价productCode匹配条件仅旗舰店商品时的生效，规则里其他条件会正常匹配执行。分成2类商品看选品结果：\n    1. 旗舰店商品：该匹配条件生效，会根据商品里的productCode做条件匹配，匹配返选品结果为true，不匹配返回false；\n    2. 非旗舰店商品：该匹配条件不生效，由于本次圈品规则只有一个条件，所以圈品规则返回全是true；\n2. 匹配渠道：商旅搜索为钉钉渠道，命中渠道不可售黑名单；\n3. 删除商品：\n    1. 旗舰店商品：部分被圈中，所以部分商品被删除，部分商品未被删除；\n    2. 非旗舰店商品：全部被圈中，所以全部商品被删除；\n\n举例说明：\n\n圈品规则1：\n\n+ 条件a：productCode=abc\n+ 条件b：店铺id=4968\n\n圈品规则2：\n\n+ 条件a：productCode=abc\n\n商品1：店铺agentId=5046（非旗舰店），productCode为空\n\n+ 匹配圈品规则1：条件a跳过，条件b继续匹配店铺id不满足，不命中\n+ 匹配圈品规则2：条件a跳过，没有其他条件，命中\n\n商品2：店铺agentId=4968（旗舰店），productCode=abc\n\n+ 匹配圈品规则1：条件a执行并productCode匹配，继续匹配条件b并店铺id匹配，命中\n+ 匹配圈品规则2：条件a执行并productCode匹配，无其他条件，命中\n\n![新系统圈品规则](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/113921/1704260864615-c7d0b18c-91e3-4861-87ae-afb82f6f26f5.png)\n\n![商旅渠道动态优惠屏蔽售卖规则配置](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/113921/1704261138369-701efb77-0b88-43d6-99b6-aadf57c03f07.png)\n\nproductCode条件仅旗舰店生效说明：\n\n1. 供应链货品分为两大类平台报价和外部报价，外部报价中来自旗舰店的报价只能确认商品为年龄票，无法细分为学生/青年/老年，不能满足运营细分商品类型销售的诉求。（很久以前）导购侧通过配置特殊票属性方式统一识别所有报价的商品细分类型，短期看满足运营的诉求，长期看该方案是有一定缺陷的。\n2. 新系统迁移属性定义后延用老的技术方案，通过圈品定义特殊票属性；\n\n![新系统圈品青年特殊票](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/113921/1704261997567-2f9e6992-27fc-4b62-84f4-36f116a8671b.png)\n\n![老系统权益管理](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/113921/1704252899800-0caa3112-e331-4c39-a727-97d3e0178d73.png)\n\n![供给未告知细分类型时商品赋值所有细分类型](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/113921/1704262742785-a628c724-a142-47ff-b343-788fbe815a9d.png)\n\n\n\n##### 原因2：监控不全\n监控不全和报警不及时延",
    "chunk_order_index": 1,
    "full_doc_id": "doc-ab0d320e393055c0bbfb9d2bb2f7d420"
  },
  "chunk-794abd726424df7c2072ccecc3939f6f": {
    "tokens": 1200,
    "content": "39-a727-97d3e0178d73.png)\n\n![供给未告知细分类型时商品赋值所有细分类型](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/113921/1704262742785-a628c724-a142-47ff-b343-788fbe815a9d.png)\n\n\n\n##### 原因2：监控不全\n监控不全和报警不及时延后了问题的发现和处理。配置变更后搜索航班数量是立刻下降的，但是在半小时后商旅预定下跌报警该问题才被发现，将近1小时后反馈给机票侧。首先商旅侧作为业务方第一道防线，理应监控齐全和及时报警，其次导购侧有分渠道搜索成功率监控大盘，但报警重点面向2C的，无2B\\2G等其他小渠道的监控报警。\n\n\n\n![商旅预定监控](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/113921/1704263895236-b9cc22af-467b-4ff2-9eb0-3d20912372a7.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/113921/1704264799546-f57221a0-5120-43db-9721-e8ae106b0ec0.png)\n\n![导购侧forge分渠道成功率监控](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/113921/1704264812052-43fa368d-0c50-453f-8b38-6009d7cd7d2f.png)\n\n\n\naction：\n\n##### 原因3：配置缺失变更保护\n机票运营后台由于历史设计考虑不全，不支持小范围灰度，配置后是立即全量生效。灰度能力的补全需要更多时间做技术方案推演、长期投入解决。\n\n\n\naction：【监控】 聚合规则过滤无结果占比     北遥 容照    步铮    待定\n\naction：【排查】  排查能力打通     北遥   步铮      1.20\n\n## 四、关注点分析\n### 4.1【系统质量】\n#### 4.1.3 变更质量  \n+ **是否涉及变更：**\n    - [x] 是\n    - [ ] 否\n+ **变更类型：**\n    - [ ] 代码发布\n    - [x] 配置变更\n    - [ ] 其他变更：____________\n    - [ ] 不涉及\n+ **变更平台是否接入ChangeFree：**\n    - [x] 是，CF变更单链接：[https://aicf.alibaba-inc.com/aicf/change/v2/detail/692547058?spm=goc-apm.aicf-_changeList.0.0.616c2388ZR79Dn](https://aicf.alibaba-inc.com/aicf/change/v2/detail/692547058?spm=goc-apm.aicf-_changeList.0.0.616c2388ZR79Dn)\n    - [ ] 否\n+ **是否违反变更红线3.1**** **[链接](https://aliyuque.antfin.com/ngoc/fzg6dy/uar1k6)\n    - [ ] 是，违反哪条原则：\n    - [x] 否\n\n\n\n**〖关注点1〗****灰度阶段**\n\n+ **是否经过灰度：**\n    - [ ] 是\n    - [x] 否\n\n### 4.2【处置能力】\n#### 4.2.1 故障发现&响应\n+ **是否监控发现**\n    - [x] 故障触发方 监控发现\n    - [ ] 故障受影响方 监控发现\n    - [ ] 否，原因为：（监控无效/监控缺失）\n\n#### 4.2.2 故障定位&恢复\n+ **主要恢复方式：**\n    - [ ] 代码发布/回滚\n    - [x] 配置发布/回滚\n    - [ ] 数据订正\n    - [ ] 机器隔离/重启/扩容\n    - [ ] 配置限流\n    - [ ] 预案降级\n    - [ ] 自动恢复\n    - [ ] 其他：\n\n\n\n## 六、故障Action\n| **序号** | *******Action标题** | *******负责人** | *******计划完成时间** | **Action描述** | **验收标准** | **验收人** | **是否keyAction** | **是否回血Action** |\n| --- | --- | --- | --- | --- | --- | --- | --- | --- |\n| 1 | 短期：增加航班搜索无结果监控报警 | 步铮 | 2024-01-05 |  |  |  |  |  |\n| 2 | 短期：增加错误码环比升高监控报警  | 步铮 | 2024-01-05 |  |  |  |  |  |\n| 3 | 短期：增加端频道渠道搜索成功率和无结果率报警 | 容照 | 2024-01-05 |  |  |  |  |",
    "chunk_order_index": 2,
    "full_doc_id": "doc-ab0d320e393055c0bbfb9d2bb2f7d420"
  },
  "chunk-ba84fa17d3b84d8c5dba71c36a17ca3d": {
    "tokens": 492,
    "content": "-05 |  |  |  |  |  |\n| 2 | 短期：增加错误码环比升高监控报警  | 步铮 | 2024-01-05 |  |  |  |  |  |\n| 3 | 短期：增加端频道渠道搜索成功率和无结果率报警 | 容照 | 2024-01-05 |  |  |  |  |  |\n| 4 | 短期：增加圈品规则条件提示说明  | 容照 | 2024-01-11 |  |  |  |  |  |\n| 5 | 长期：配置变更增加灰度能力 | 容照 | 待讨论 |  |  |  |  |  |\n\n\naction：（商旅）机票搜索成功量监控  步铮   2024-01-09\n\naction：有可能引发错误的配置 平台（系统）要进行拦截 容照   2024-01-11\n\naction：【监控】（机票）聚合规则过滤无结果占比     北遥 容照    步铮    待定\n\naction：【排查】  排查能力打通      北遥   步铮      1.20  优先级最高\n\naction：flyop 系统关联机票产品线 （统一梳理检查下机票行业）   路衍   1.12 \n\n\n\n\n\n## 七、影响产品线&影响面\n    - [ ] 业务影响：\n        * 影响的产品线，业务功能，功能受损程度（成功量/率下跌多少%），持续多少时间\n    - [x] 是否有客诉量：\n        * 在线，热线，排队量\n\n用户进线量49\n\n_/* 可附相关故障等级定义的链接和截图]*/_\n\n链接：\n\n截图：\n\n商旅：搜索航班量跌零\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256373/1704184920581-3b86e71d-87dd-45f1-8f96-9d16840d06cd.png)",
    "chunk_order_index": 3,
    "full_doc_id": "doc-ab0d320e393055c0bbfb9d2bb2f7d420"
  },
  "chunk-3c90871aa3ffee78ef508d17640d89e4": {
    "tokens": 1200,
    "content": "## 一、故障简述\n故障简述：于19:16开始，飞猪商旅火车票订单详情接口监控异常，失败量最近10分钟最小值大于等于20，成功率最近10分钟最大值小于70%，已达到P4故障，原因为配置变更导致，于19:27回切配置后故障恢复\n\n## 二、故障过程回顾\n### 2.1【故障处理时间线】\n故障时间线：\n\n2024-01-08 19:16，调整配置【故障引入】  \n2024-01-08 19:19，发现订单详情产生告警 **【故障发现】**  \n2024-01-08 19:19，接手订单详情告警【业务响应】  \n2024-01-08 19:19，步实定位为订单详情的MTOP改造影响到的问题，立即寻找回滚方法，发布单页面无回滚按钮【故障定位】  \n2024-01-08 19:21，决定采用覆盖的方法解决发布问题  \n2024-01-08 19:22，修改接口版本，选择是否登录为是【恢复执行】  \n2024-01-08 19:23，修改完成，发现发布流程需要预发验证才能线上发布，立即选择预发发布  \n2024-01-08 19:25，预发发布完成，立刻进行线上发布  \n2024-01-08 19:25，等待源代码审核以及安全审核\n\n2024-01-08 19:26，故障触达故障等级定义【故障发生】\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256373/1704770064297-d01dc256-a3e4-4961-90fb-a7bbabb725ef.png)  \n2024-01-08 19:27，发布完成，监控指标恢复正常水位**【故障恢复】**\n\n## 三、故障原因\n### 3.1【背景说明】\n**【业务链路】**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/64356291/1704866852372-375135f0-92a1-40af-9f1b-7edfec147931.png)\n\n**【需求背景】**\n\n修复线上Session过期问题，该问题一周产生502次，一个月内转技术并无法解决的反馈共计2个。变更内容为mtop.btrip.train.orderDetailInfo这个Mtop的是否登录配置为否。\n\n\n\n### 3.2【原因分析】\n一句话原因：mtop.btrip.train.orderDetailInfo配置是否登录为“否”后影响订单详情接口获取登录态。订单详情接口存在登录态校验，当Mtop配置API是否登录为否后无法获取登录态，导致订单详情接口鉴权失败，直接拦截。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/64356291/1704776387369-7e428919-027a-4e3c-94a6-0807807a0954.png)\n\n根因分析：\n\n1. 技术方案上错误的认为可以修改mtop的是否登录为否\n2. 测试流程上，缺失对该异常场景的感知和覆盖。\n3. mtop相关变更方案 需明确无回滚机制\n\n\n\n\n\n## 四、关注点分析\n_/* 填写说明：根据故障实际情况可增删关注点，并提供详细内容分析*/_\n\n### 4.1【系统质量】\n#### 4.1.1 需求&设计评估\n**〖关注点1〗****是否涉及产品、技术方案评估？此核心的问题是什么，如何改进？**\n\n- [x] **是，涉及**\n    - [ ] 需求评估遗漏\n    - [ ] 产品设计缺陷\n    - [x] 系统架构设计缺陷\n        - [ ] 容错性不足 \n        - [ ] 单点，无冗余\n        - [ ] 缺乏自我保护\n        - [ ] 缓存设计不当\n        - [ ] 容量评估不足\n        - [ ] 非幂等设计\n        - [ ] 强弱依赖不合理\n        - [ ] 其他：__________\n- [ ] 否，不涉及\n\n**〖问题总结〗**\n\n**〖改进点〗**_**需明确写明不同故障相关方的改进项（若有的话），下同。**_\n\n1、\n\n#### 4.1.2 代码质量 \n**〖关注点3〗****测试阶段**\n\n+ **测试内容：**\n\n未清除登录态，从棱镜种登录态，进入各链路订单详情验证\n\n+ **测试人员：王雨晨**\n+ **是否经过测试验证**\n    - [x] 是，验证环境\n        - [x] 预发环境\n        - [ ] 日常环境\n    - [x] 是，测试方法\n        - [ ] 单元测试\n        - [x] 功能回归测试\n        - [ ] 集成测试/链路测试\n        - [ ] 验收测试\n+ **测试未发现原因是什么？后续如何改进？**\n    - [ ] 回归测试遗漏\n        - [ ] 手工回",
    "chunk_order_index": 0,
    "full_doc_id": "doc-0acfa567c80b0cc80992988792f6c65e"
  },
  "chunk-560942718e527be29a3319075bb1489e": {
    "tokens": 1200,
    "content": "- [x] 预发环境\n        - [ ] 日常环境\n    - [x] 是，测试方法\n        - [ ] 单元测试\n        - [x] 功能回归测试\n        - [ ] 集成测试/链路测试\n        - [ ] 验收测试\n+ **测试未发现原因是什么？后续如何改进？**\n    - [ ] 回归测试遗漏\n        - [ ] 手工回归测试用例遗漏\n        - [ ] 自动化未建设\n        - [ ] 自动化回归覆盖不足\n        - [ ] 其他：__________\n    - [ ] 新场景测试遗漏\n        - [x] 功能测试用例遗漏，包括正常分支和异常分支\n        - [ ] 容灾兜底测试遗漏\n        - [ ] 客户端兼容性测试遗漏\n        - [ ] 埋点测试遗漏\n        - [ ] 性能测试遗漏，影响评估不足\n        - [ ] 安全测试遗漏\n    - [x] 其他：必须要无痕浏览器或者第一次登录才能复现该问题\n\n**〖问题总结〗**\n\n  导致预发未发现问题的原因：\n\n1. 不知道什么流程上还存在去种老登录态的情况——导致在不手动清理cookie时，浏览器可能存在老登录态\n2. 订单详情取登录态的逻辑上有兜底，取不到新登录态会取老登录态——导致预发测试时有老登录态没发现问题\n\n**〖改进点〗  \n**测试action： \n\n1. 内部沟通：执行测试同学一定要问清楚改动点，评估测试范围和测试方法\n2. 测试规范：登录态相关测试一定要清理cookie后测试\n\n#### 4.1.3 变更质量   \n+ **是否涉及变更：**\n    - [x] 是\n    - [ ] 否\n+ **变更类型：**\n    - [ ] 代码发布\n    - [ ] 配置变更\n    - [x] 其他变更：_____Mtop变更_____\n    - [ ] 不涉及\n+ **变更平台是否接入ChangeFree：**\n    - [x] 是，CF变更单链接：_____[https://aicf.alibaba-inc.com/aicf/change/v2/detail/704117768?spm=goc-apm.aicf-_changeList.0.0.6eac2388PpUofi](https://aicf.alibaba-inc.com/aicf/change/v2/detail/704117768?spm=goc-apm.aicf-_changeList.0.0.6eac2388PpUofi)__\n\n_/*要这样的链接_ [https://aicf.alibaba-inc.com/aicf/change/detail/1725370372](https://aicf.alibaba-inc.com/aicf/change/detail/1725370372) */\n\n    - [ ] 否\n+ **是否违反变更红线3.1**** **[链接](https://aliyuque.antfin.com/ngoc/fzg6dy/uar1k6)\n    - [ ] 是，违反哪条原则：\n    - [ ] 否\n\n**〖关注点〗****上线阶段**\n\n+ **是否有确定的监控观测指标**\n    - [x] 是，监控指标及监控链接：\n    - [ ] 否\n+ **是否在窗口期进行发布变更**\n    - [ ] 是\n    - [ ] 否，原因：\n+ **变更是否影响上下游**\n    - [ ] 是，是否有提前知会上下游评估及关注变更\n        - [ ] 有提前知会\n        - [ ] 没有提前知会\n    - [x] 否\n\n### 4.2【处置能力】\n#### 4.2.1 故障发现&响应\n+ **是否监控发现**\n    - [x] 故障触发方 监控发现\n    - [ ] 故障受影响方 监控发现\n    - [ ] 否，原因为：（监控无效/监控缺失）\n+ **是否5分钟内响应**\n    - [x] 是\n    - [ ] 否，原因为：\n\n#### 4.2.2 故障定位&恢复\n+ **主要恢复方式：**\n    - [ ] 代码发布/回滚\n    - [x] 配置发布/回滚\n    - [ ] 数据订正\n    - [ ] 机器隔离/重启/扩容\n    - [ ] 配置限流\n    - [ ] 预案降级\n    - [ ] 自动恢复\n    - [ ] 其他：\n\n**〖关注点1〗定位&恢复阶段存在什么问题？是否可以增加预案，****有更快的恢复方式？****相关的优化改进？**\n\n**〖问题总结〗**\n\n1、mtop没有回滚操作。\n2、恢复阶段存在操作繁琐耗时问题，mtop的覆盖发布需要同时经过预发发布以及线上审核发布才能完成，导致恢复时长慢。\n\n**〖改进点〗**\n\n1、可以使用更快的恢复方式，mtop中的撤销修改功能，比覆盖修改方案节省大约1分钟\n\n\n**〖关注点2〗业务自身是否具备容灾逃逸能力？后续如何改进？**_/*",
    "chunk_order_index": 1,
    "full_doc_id": "doc-0acfa567c80b0cc80992988792f6c65e"
  },
  "chunk-5f0f9f64a1289acb795106055c4ab941": {
    "tokens": 590,
    "content": "2、恢复阶段存在操作繁琐耗时问题，mtop的覆盖发布需要同时经过预发发布以及线上审核发布才能完成，导致恢复时长慢。\n\n**〖改进点〗**\n\n1、可以使用更快的恢复方式，mtop中的撤销修改功能，比覆盖修改方案节省大约1分钟\n\n\n**〖关注点2〗业务自身是否具备容灾逃逸能力？后续如何改进？**_/* 如涉及基础设施引发的故障，可填写*/_\n\n- [ ] 具备容灾能力\n    - [ ] 因未演练不敢执行\n    - [ ] 因有损评估决策不执行\n    - [ ] 无决策或者决策不当，未执行\n- [x] 不具备容灾能力\n\n\n\n## 六、故障Action\n| **序号** | *******Action标题** | *******负责人** | *******计划完成时间** | **Action描述** | **验收标准** | **验收人** | **是否keyAction** | **是否回血Action** |\n| --- | --- | --- | --- | --- | --- | :---: | --- | --- |\n| 1 | 短期：登录态相关场景核心case梳理，落技术评审/测试评审模版 | 益徳 | 24/01/16 | |  | | | |\n| 2 | 短期：mtop 无回滚方案时的预案准备，发布过程中快恢应急检查 | 箩航/步实 |  1.26 | 各平台回滚能力情况，回滚方式文档  |  | | | |\n\n\nmtop变更记录同步到safe（已沟通）\n\n## 七、影响产品线&影响面\n    - [ ] 是否影响可用性\n        * 可用性指标，可用性时长消耗\n    - [x] 业务影响：\n        * 影响的产品线，业务功能，功能受损程度（成功量/率下跌多少%），持续多少时间\n    - [ ] 是否有客诉量：\n        * 在线，热线，排队量\n\n_/* 可附相关故障等级定义的链接和截图]*/_\n\n链接：\n\n截图：19:15-19:27  持续12分钟![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256373/1704770064297-d01dc256-a3e4-4961-90fb-a7bbabb725ef.png?x-oss-process=image%2Fresize%2Cw_1050%2Climit_0)\n\n500+订单渲染",
    "chunk_order_index": 2,
    "full_doc_id": "doc-0acfa567c80b0cc80992988792f6c65e"
  },
  "chunk-7afa5d6f1d5b36403a0fde44bdb0d734": {
    "tokens": 1200,
    "content": "## 一、故障简述\n故障简述： 于10:00点50个门票参与一元秒杀，渲染2400，生单2800，触发渲染、生单、热点商品限流。门票生单接口平均rt超过4s返回，wft应用机器负载过高，线程池满。门票生单成功率跌0，飞猪各个行业生单成功率下跌。10:08提交wft扩容10台，重启10台，10:13调低热点商品限流，10:14除去门票外其他行业生单成功率逐步恢复正常  。\n\n## 二、故障过程回顾\n### 2.1【故障处理时间线】\n故障时间线：\n\n2023-12-12 10:00，50个门票参与一元秒杀，渲染2400，生单2800，触发渲染、生单、热点商品限流，各行业创单成功率开始下跌\n\n2023-12-12 10:06，承平确认 门票自我游系统商超时严重  \n\n2023-12-12 10:08，wft异常，葵因开始扩容wft，馬达操作重启部分问题机器【恢复执行】\n\n2023-12-12 10:10，由于活动冲高触达交易大盘故障等级定义【故障发生】\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/80256373/1702352021436-796d95da-8587-44f2-8094-2f7a9ae7f414.png)\n\n2023-12-12 10:13，调低热点商品限流操作完成【恢复执行】\n\n2023-12-12 10:14，除门票外其他行业生单成功率逐步恢复正常**【故障恢复】**\n\n2023-12-12 11:04，门票创单成功率恢复正常【影响消除】****\n\n## 三、故障原因\n### 3.1【背景说明】\n背景：自营在搞门票“一元购”活动，出现秒杀和大量流场景，触发了多域应用限流和系统负载\n\n### 3.2【原因分析】\n一句话原因：\n\n门票日历品流量过大时wft cpu利用率过高，导致机器性能下降\n\n根因分析：单机压测还原故障场景发现，日历品和非日历品在同等流量下，日历品的cpu利用率98%，非日历品的cpu利用率53%。\n\n压测过程：\nbatchmini 20 限流 18  \nbuildorder 30 限流25  \ncreateorder 25 限流15\n结果：\n\n**日历品&&开启日志**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/1956458/1703231095202-9bf4c56c-3463-499c-baae-9ecaee163dd4.png)\n\n**日历品&不开启扩展点日志**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/1956458/1703232633026-d47c44e5-4de6-4936-8179-4e56dcb59cdb.png)\n\n**非日历品&开启日志（17:33）**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/1956458/1703238036041-724bbdf6-d5de-4df9-9f90-58384a46500f.png?x-oss-process=image%2Fresize%2Cw_2048%2Climit_0)\n\n线程池满原因无法确认，最终以后续保障为主\n\n## 四、关注点分析\n### 4.1【系统质量】\n#### 4.1.1 需求&设计评估\n**〖关注点1〗****是否涉及产品、技术方案评估？此核心的问题是什么，如何改进？**\n\n- [x] **是，涉及**\n    - [ ] 需求评估遗漏\n    - [ ] 产品设计缺陷\n    - [ ] 系统架构设计缺陷\n        - [ ] 容错性不足 \n        - [ ] 单点，无冗余\n        - [ ] 缺乏自我保护\n        - [ ] 缓存设计不当\n        - [ ] 容量评估不足\n        - [ ] 非幂等设计\n        - [ ] 强弱依赖不合理\n        - [x] 其他：______限流方案 缺乏自我保护__\n- [ ] 否，不涉及\n\n\n\n### 4.2【处置能力】\n#### 4.2.1 故障发现&响应\n+ **是否监控发现**\n    - [x] 故障触发方 监控发现\n    - [ ] 故障受影响方 监控发现\n    - [ ] 否，原因为：（监控无效/监控缺失）\n\n#### 4.2.2 故障定位&恢复\n+ **主要恢复方式：**\n    - [ ] 代码发布/回滚\n    - [ ] 配置发布/回滚\n    - [ ] 数据订正\n    - [",
    "chunk_order_index": 0,
    "full_doc_id": "doc-087e382b68de515799df9dc062523f03"
  },
  "chunk-2372cac54e4febbc095591d4bd5518e5": {
    "tokens": 1200,
    "content": "故障触发方 监控发现\n    - [ ] 故障受影响方 监控发现\n    - [ ] 否，原因为：（监控无效/监控缺失）\n\n#### 4.2.2 故障定位&恢复\n+ **主要恢复方式：**\n    - [ ] 代码发布/回滚\n    - [ ] 配置发布/回滚\n    - [ ] 数据订正\n    - [x] 机器隔离/重启/扩容\n    - [x] 配置限流\n    - [ ] 预案降级\n    - [ ] 自动恢复\n    - [ ] 其他：\n\n## 六、故障Action\n平台\n\n    - [x] 1、限流新增bizType和bizCode。[@葵因](undefined/kuiyin.wc)  已完成\n    - [x] 2、调整限流后，单机限流值较低，容易触发限流。应用升配，提高单机限流值[@回薄](undefined/huibo.hxy)  已完成\n    - [ ] 3、流量分组隔离，[方案](https://aliyuque.antfin.com/fplat/wyakc9/qc1f7ky56on9bfgb?singleDoc#)落地中 优先完成渲染 生单场景。[@葵因](undefined/kuiyin.wc)[@回薄](undefined/huibo.hxy)[@馬达](undefined/majingda.mjd)   3.15\n\n行业\n\n    1. 秒杀链路单独盘点，系统商异常预案措施：秒杀场景链路能力项建设，是否可以通过囤票+hold单+独立库存+纯限流， 或者通过服务保障的方式下收单，再出票保障[@知丘](undefined/qiuweijie.qwj)[@二虎](undefined/erhu.xjs)[@枫日](undefined/fengri.wl)[@长衿](undefined/jennie.zhangj)[@逍鸣](undefined/xiaoming.wz)   3.30   完成设计方案\n    2. 日常/大促sop构建+宣导，业务同步宣导[@知丘](undefined/qiuweijie.qwj)  已完成\n    3. 下单页预下单链路改造[@知丘](undefined/qiuweijie.qwj)[@二虎](undefined/erhu.xjs)[@枫日](undefined/fengri.wl)[@长衿](undefined/jennie.zhangj)[@逍鸣](undefined/xiaoming.wz)   已完成\n\n\n\n## 七、影响产品线&影响面\n    - [x] 业务影响：\n        * 影响的产品线，业务功能，功能受损程度（成功量/率下跌多少%），持续多少时间\n\n**受外部系统商影响：**\n\n门票成功率以及失败量：\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/80256373/1702459157503-d7e49d24-87ce-4aac-bd61-371774c171d9.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/80256373/1702459181056-74b4435c-4672-45cd-bf92-1190eed6a5ff.png)\n\n不分业务大盘监控：\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/80256373/1702459244887-36774b29-f0c1-49a2-80bf-c464f459fc88.png)\n\n\n\n**平台影响：**\n\n        * 机票渲染：\n        * ![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/11456394/1702361462550-93de0e3d-63a0-43b7-9fe4-b1d758352ea5.png)\n        * 机票生单：\n        * ![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/11456394/1702361504023-0266b51d-50fe-4180-88cb-b04334adadc6.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256373/1705644772520-401da30b-0507-4e7f-8a37-26dc026b8d5b.png)\n\n        * 酒店渲染：![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/11456394/1702361528799-004cf35b-e329-4753-9d95-993ac448a7bb.png)\n        * 酒店生单：![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/11456394/1702361538872-c189fae9-e081-495f-968e-2f19333269d4.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256373/1705644851842-e40df7f1-0c51-4fa2-",
    "chunk_order_index": 1,
    "full_doc_id": "doc-087e382b68de515799df9dc062523f03"
  },
  "chunk-4955360868e3838aa458241914892894": {
    "tokens": 180,
    "content": "![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/11456394/1702361538872-c189fae9-e081-495f-968e-2f19333269d4.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256373/1705644851842-e40df7f1-0c51-4fa2-9232-32167e6f64ff.png)\n\n\n\n        * 火车票生单：\n    - ![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/80256373/1702459382396-f14343e5-3e91-4a4c-b83c-b90cfc6a10da.png)",
    "chunk_order_index": 2,
    "full_doc_id": "doc-087e382b68de515799df9dc062523f03"
  },
  "chunk-9af8d989951f2e66a87f0f24d165651b": {
    "tokens": 1200,
    "content": "## 一、故障简述\n故障简述：于14:05开始，飞猪接送机_渲染订单异常，成功量最近10分钟持续跌0， 初步原因是守望者配置了id为空的异常数据，删除错误配置后于14:18监控恢复\n\n## 二、故障过程回顾\n### 2.1【故障处理时间线】\n故障时间线：\n\n2024-01-19 13:44，科帅在守望者新增id为空的商家配置**【故障引入】**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/107856337/1705915251478-6aed696a-412b-4f5d-bf64-f1c771985de9.png)\n\n2024-01-19 13:46，综合交通报警群开始出现ftaxi成功率下跌报警【发现】\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/107856337/1705927756070-2c075c34-fca1-4bee-a9d2-c03a60cd953a.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/107856337/1705927737359-c27c1758-967d-480b-a508-9c97a35987a4.png)\n\n2024-01-19 13:56，彦青发现报警，开始排查成功率下跌原因，parseException（干扰排查）\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/107856337/1705927616300-2e934a46-5ced-41db-9905-83f0f0e72a09.png)\n\n2024-01-19 14:00，慕凡收到合并支付链路成功率下跌短信告警，开始排查合并支付链路异常原因\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/107856337/1705929646822-f22fea25-af2e-4a0e-bcd7-a4f06b1959d4.png)\n\n2024-01-19 14:05，成功率持续下跌，彦青回滚上午发布的ftaxi发布单，涉及到beta和安全生产环境\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/107856337/1705928034199-fb00cdaf-909e-400e-9f52-b5dee3d8cfd8.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/107856337/1705915854554-b753e5e9-68fa-414a-a04d-f9c80c448738.png)\n\n2024-01-19 14:09，应急群拉起，研发响应排查**【故障响应】**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/107856337/1705915699927-f50f2816-1b14-43ff-b5fe-8224a45508ac.png)\n\n2024-01-19 14:09 ～ 14:18，道为、慕凡、彦青电话排查问题\n\n2024-01-19 14:14，触达P4成功量最近10分钟最小值等于0，成功量最近10分钟与基线同比下跌大于等于50%  **【故障发生】**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256373/1705652111892-06e956af-c3b5-45c8-b1bf-ffa98c1e755c.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256373/1705652147472-82f0b9ad-8b91-4a38-af23-96354dbfdbbd.png)\n\n2024-01-19 14:15，道为发现故障对应的错误日志和守望者配置脏数据**【故障定位】**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/107856337/1705922225959-d6601fd4-c87e-4f5c-891e-f758bc455865.png)\n\n2024-01-19 14:18，道为删除守望者配置脏数据**【恢复执行】**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/107856337/1705922281845-8b619e50-0e2e-4a8a-9948-c04bafd5bf13.png)\n\n2024-01-19 14:18，监控冲高恢复**【故障恢复】**\n\n## 三、故障原因\n### 3.1【背景说明】\n背景：\n\n1）目前不同商家渠道的报价结果，在ftaxi侧拿到数据后会查询守望者里的商家配置做处理\n\n2）守望者里的sellerId是字符串类型，ftaxi里的是Long类型，会涉及到一些转换操作",
    "chunk_order_index": 0,
    "full_doc_id": "doc-9bb3c544e714daffa66aebc0cda94928"
  },
  "chunk-8393600576ad063ae89ebfdcddbe0321": {
    "tokens": 1200,
    "content": "5bf13.png)\n\n2024-01-19 14:18，监控冲高恢复**【故障恢复】**\n\n## 三、故障原因\n### 3.1【背景说明】\n背景：\n\n1）目前不同商家渠道的报价结果，在ftaxi侧拿到数据后会查询守望者里的商家配置做处理\n\n2）守望者里的sellerId是字符串类型，ftaxi里的是Long类型，会涉及到一些转换操作\n\n### 3.2【原因分析】\n一句话原因：配置不正确且系统不健全 \n\n根因分析：\n\n\n\n1）守望者配置键值是非必填\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/107856337/1705922955028-84c1a7be-8a32-437d-8cc7-a06922dd06a9.png)\n\n\n\n2）运营操作线上环境不谨慎且操作后未验证\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/107856337/1705922916838-254c88d7-7cb4-4d37-96f0-0a7791d5099a.png)\n\n3）ftaxi应用层面未做判空等拦截操作，null字符串转long出错\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/107856337/1705922999789-d2ec2524-4349-4521-a10a-3765fa0a0d31.png)\n\n4）拿到tfgw返回的原始报价进行convert时出错，导致整条报价信息都异常，所以c端查不到报价\n\n## 四、关注点分析\n_ac__tion：守望者扫描检查键值（是否为空） 判断风险推送_\n\n_action：商家配置 渠道配置等 核心场景 接入守望者配置灰度能力   书植_\n\n### 4.1【系统质量】\n#### 4.1.1 需求&设计评估\n**〖关注点1〗****是否涉及产品、技术方案评估？此核心的问题是什么，如何改进？**\n\n- [ ] **是，涉及**\n    - [ ] 需求评估遗漏\n    - [ ] 产品设计缺陷\n    - [ ] 系统架构设计缺陷\n        - [ ] 容错性不足 \n        - [ ] 单点，无冗余\n        - [x] 缺乏自我保护\n        - [ ] 缓存设计不当\n        - [ ] 容量评估不足\n        - [ ] 非幂等设计\n        - [ ] 强弱依赖不合理\n        - [ ] 其他：__________\n- [ ] 否，不涉及\n\n#### 4.1.3 变更质量\n+ **是否涉及变更：**\n    - [x] 是\n    - [ ] 否\n+ **变更类型：**\n    - [ ] 代码发布\n    - [x] 配置变更\n    - [ ] 其他变更：____________\n    - [ ] 不涉及\n+ **变更平台是否接入ChangeFree：**\n    - [x] 是，CF变更单链接：__[https://aicf.alibaba-inc.com/aicf/change/v2/detail/723189564?spm=goc-apm.aicf-_changeList.0.0.682e2388SAAgkd](https://aicf.alibaba-inc.com/aicf/change/v2/detail/723189564?spm=goc-apm.aicf-_changeList.0.0.682e2388SAAgkd)______\n\n_/*要这样的链接_ [https://aicf.alibaba-inc.com/aicf/change/detail/1725370372](https://aicf.alibaba-inc.com/aicf/change/detail/1725370372) */\n\n    - [ ] 否\n+ **是否违反变更红线3.1**** **[链接](https://aliyuque.antfin.com/ngoc/fzg6dy/uar1k6)\n    - [ ] 是，违反哪条原则：\n    - [ ] 否\n\n\n\n**〖关注点1〗****灰度阶段**\n\n+ **是否经过灰度：**\n    - [ ] 是\n    - [ ] 否\n+ **观测了哪些监控**：_可以附链接_\n    - [ ] 黑屏、白屏\n    - [ ] GOC监控：\n    - [ ] 系统大盘：\n    - [ ] 其他：___________\n+ **是否灰度期间发现问题？**\n    - [ ] 是\n        - [ ] 是否灰度流量过大，导致故障\n        - [ ] 灰度发现但未有效或及时修复，导致故障\n        - [ ] 其他：___________\n    - [ ] 否，后续如何灰度发现？_____________\n+ **未灰度发现原因**\n    - [ ] 应用灰\n        - [ ] 灰度流量太小\n        - [ ] 灰度阶段无监控\n        - [ ] 灰度批次不合理\n        - [ ] 超长时间灰度才能发现\n    - [ ] 业务灰：策略不合理\n    - [ ] 灰度无法发现\n    - [ ] 其他：_____________\n\n**〖问题总结〗**\n\n**〖改进点〗",
    "chunk_order_index": 1,
    "full_doc_id": "doc-9bb3c544e714daffa66aebc0cda94928"
  },
  "chunk-c48f44f11d26f80eb7ff90aa6c5b0e53": {
    "tokens": 1200,
    "content": "- [ ] 应用灰\n        - [ ] 灰度流量太小\n        - [ ] 灰度阶段无监控\n        - [ ] 灰度批次不合理\n        - [ ] 超长时间灰度才能发现\n    - [ ] 业务灰：策略不合理\n    - [ ] 灰度无法发现\n    - [ ] 其他：_____________\n\n**〖问题总结〗**\n\n**〖改进点〗**_**需明确写明不同故障相关方的改进项（若有的话），下同。**_\n\n**1、还有哪些链路灰度能力 优先级较高需要建设**\n\n#### 4.2.1 故障发现&响应\n+ **是否监控发现**\n    - [x] 故障触发方 监控发现\n    - [ ] 故障受影响方 监控发现\n    - [ ] 否，原因为：（监控无效/监控缺失）\n+ **是否5分钟内响应**\n    - [x] 是\n    - [ ] 否，原因为：\n+ **是否存在应急协同问题**\n    - [ ] 是\n        - [ ] 应急流程不明确（无流程或者流程不清晰、应急相关角色&职责不明确，缺失一号位等)\n        - [ ] 应急执行不到位（有流程，但未按流程执行，通告发送不及时，响应不及时等）\n    - [x] 否\n\n**〖问题总结〗**\n\n**〖改进点〗**_**需明确写明不同故障相关方的改进项（若有的话），下同。**_\n\n1、\n\n#### 4.2.2 故障定位&恢复\n+ **主要恢复方式：**\n    - [ ] 代码发布/回滚\n    - [x] 配置发布/回滚\n    - [ ] 数据订正\n    - [ ] 机器隔离/重启/扩容\n    - [ ] 配置限流\n    - [ ] 预案降级\n    - [ ] 自动恢复\n    - [ ] 其他：\n\n## 六、故障Action\n| **序号** | *******Action标题** | *******负责人** | *******计划完成时间** | **Action描述** | **验收标准** | **验收人** | **是否keyAction** | **是否回血Action** |\n| --- | --- | --- | --- | --- | --- | --- | --- | --- |\n| 1 | 短期：修复事故涉及到的代码漏洞 | 慕凡 | 1.23 | 商家守望者配置接入增加脏数据的过滤逻辑 |  | 慕凡 | | |\n| 2 | 短期：list搜索sunfire监控增加urgent级别告警  | 彦青 | 1.22 | 完善监控报警，设置合理阈值 |  | 凝越 | | |\n| 3 | 短期：检查并补充核心链路的监控告警规则 | 彦青 | 1.30 | 检查并补充（租车、接送机）完善核心链路的监控告警，包含critical和urgent | | 凝越 | | |\n| 4 | 长期：检查ftaxi、tfrcs、tfsug等应用的接入守望者配置代码 | 彦青 | 2.7(年前) | 检查守望者接入代码以及使用场景，修复可能存在的问题 |  | 彦青 | | |\n| 5 | 守望者扫描检查键值（是否为空）  目前哪些键是可以非空的  配置异常的需要风险推送 音素    2.1  产出相关配置list | 音素 | 2.1 | 1. 会把新增配置时，键值是否可空的默认值改成“不可空”   2. 跑一下当前所有配置集里面键且可空的数据，对应的配置URL，，但是这也只能是邮件、或者大群里周知出来，具体谁用谁自查的方式来后续推进了   | 产出相关配置list | | | |\n| 6 | 综合交通）商家配置 渠道配置等 核心场景 接入守望者配置灰度能力 | 书植  | 1.26 | 先梳理一版需要接入灰度 | | | | |\n\n\n接送机搜索监控修改  今日完成  故障等级定义规则修改\n\n__\n\n__\n\n## 七、影响产品线&影响面\n    - [ ] 是否影响可用性\n        * 可用性指标，可用性时长消耗\n    - [x] 业务影响：\n        * 接送报价list页成功率为0，持续13分钟（成功量率下跌到0），持续13分钟\n    - [ ] 是否有客诉量：\n        * 在线，热线，排队量\n    - [ ] 是否有社会舆情：\n        * 舆情ESU等级/未到E等级，舆情关键词，总声量，负声量\n    - [ ] 是否产生资损：\n        * 理论资损金额，实际资损金额\n\n_/* 可附相关故障等级定义的链接和截图]*/_\n\n截图：![](https://intranetproxy.alipay.com/skylark/lark/0",
    "chunk_order_index": 2,
    "full_doc_id": "doc-9bb3c544e714daffa66aebc0cda94928"
  },
  "chunk-7636146a9ee584822918b1e83bdbc3e2": {
    "tokens": 138,
    "content": "热线，排队量\n    - [ ] 是否有社会舆情：\n        * 舆情ESU等级/未到E等级，舆情关键词，总声量，负声量\n    - [ ] 是否产生资损：\n        * 理论资损金额，实际资损金额\n\n_/* 可附相关故障等级定义的链接和截图]*/_\n\n截图：![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/107856337/1705928604266-dd448b0c-a8cd-41ef-afda-22d3ac8f3039.png)",
    "chunk_order_index": 3,
    "full_doc_id": "doc-9bb3c544e714daffa66aebc0cda94928"
  },
  "chunk-ee1f86eb369ac13b8d542da0d14819a2": {
    "tokens": 1200,
    "content": "## 一、故障简述\n故障简述： 于11:29开始汽车票订单链路强依赖下游的一台机器报错hsf pool full，11:44重启扩容后飞猪汽车票下单异常，初步判断故障原因为下游机器连接TDDL失败导致，数据库同学协助调用接口重新授权后故障于12:25机器重启后恢复\n\n## 二、故障过程回顾\n### 2.1【故障处理时间线】\n故障时间线：\n\n2024-02-16 11:29，汽车票线上票创建订单成功率下降，此时成功量级没有下降。\n\n2024-02-16 11:32，接到预警电话后，开始定位问题原因，初步排查后创建订单链路强依赖下游机器有问题，hsf pool full，并且只有一台机器报警。【故障响应】**【故障发现】**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/113411/1708305965177-7bf2c2ce-16e4-4bc7-a68d-20acfcba8b16.png)\n\n2024-02-16 11:44，研发执行机器重启，重启过程中同时对busbasic应用进行扩容。观察监控，从11：45创建成功量级开始下跌逐渐跌零，应用开始报错，大量的hsf服务找不到。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/113411/1708308259919-1139fc2e-93ac-444f-a5d7-07f430ebc6b0.png)\n\n2024-02-16 11:45，排查重启的机器，登录机器后发现，重启过程中系统有报错，提示tddl db无授权，新扩容的机器也无法正常启动，当时线上一共有3台机器（33.63.229.83 33.5.42.210 33.39.198.37），只重启一台33.63.229.83后，系统全部挂掉【故障定位】\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/113411/1708306524137-0584bdf6-6d2f-4b82-9c0c-49d2440b37b9.png)\n\n2024-02-16 11:55，最近10分钟与基线同比下跌大于等于50%**【故障发生】**\n\n2024-02-16 12:07，根据文档对应用访问的db进行授权。[TDDL-7001 ERR_AUTH_AKSK_FAIL 访问Diamond无权限，ERR_AUTH_AKSK_FAIL、Validate permission failed](https://aliyuque.antfin.com/coronadb/ydgmzl/tddl-7001)\n\n2024-02-16 12:09，提交审批单后找人审批，因为假期原因，审批单流转较慢。\n\n2024-02-16 12:20，数据库同学协助调用接口进行授权\n\n2024-02-16 12:25，机器重启后，系统恢复正常【恢复执行】**【故障恢复】**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256373/1708334731903-4f6f643f-8482-449d-bc21-eb2880107b5e.png)\n\n## 三、故障原因\n### 3.1【背景说明】\n背景：\n\n老的数据库trust平台集团进行了tddl授权管理，db的app只要任何一个应用申请过权限，其余连接此db的应用必须进行申请，否者重启或者重新部署都无法成功。BUSSEARCH_APP在09.18有其他应用申请过权限，busbasic因为一直无发布，一直未申请过系统权限\n\n### 3.2【原因分析】\n当时有3台机器，只是重启了一台理论上系统不应该全部挂掉。\n\n    1. 线索1：发现挂掉的是na610机房的机器，发现busbasic开启了同机房的规则，怀疑是同机房规则的问题，继续查阅文档，发现此逻辑不符合，同机房的规则同时生效于服务提供方和消费方，结论是此思路错误。\n    2. 登录实际存在却未生效的机器上查看日志，发现两台机器都无法正常启动，每日凌晨都有一次启动的报错日志，此时真相明了，解释了为何两台存活的机器没有生效。![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/113411/1708307663656-b9abbb87-f1d6-4b3e-81a8-264864601a37.png)\n\n## 四、关注点分析\n_/* 填写说明：根据故障实际情况可增删关注点，并提供详细内容分析*/_\n\n_1、查看历史的busbasic应用的扩容和缩容记录，发现存在工单执行成功，但是机器未成功启动的情况，需要与诺曼底同学确认是否有相关的通知，如无，后续每次缩容和扩容需要相关同学严格确认最后申请单的成功结果。诺曼底同",
    "chunk_order_index": 0,
    "full_doc_id": "doc-495ef51eb2b80758797b1af4b91c3b23"
  },
  "chunk-9068fdebbd81658b67e2236d20c39e84": {
    "tokens": 999,
    "content": "关注点分析\n_/* 填写说明：根据故障实际情况可增删关注点，并提供详细内容分析*/_\n\n_1、查看历史的busbasic应用的扩容和缩容记录，发现存在工单执行成功，但是机器未成功启动的情况，需要与诺曼底同学确认是否有相关的通知，如无，后续每次缩容和扩容需要相关同学严格确认最后申请单的成功结果。诺曼底同学答复__：_工单执行成功，但是机器未成功启动的情况下不会进行通知，同时扩容场景下会在应用启动失败(重试时间&次数由aone同学确认)+顺延30分钟后对新增的容器进行回收。\n\n\n2、异常的两台机器每日都在进行重启原因，与集团容器集群沟通后，通过查看asi相关日志[https://asi-console.alibaba-inc.com/instances/events?uid=01e9aaee-cc07-4973-8053-d0e51780ec77&name=busbasic--83844504-ba9b-41e6-9240-b7029fdf007e](https://asi-console.alibaba-inc.com/instances/events?uid=01e9aaee-cc07-4973-8053-d0e51780ec77&name=busbasic--83844504-ba9b-41e6-9240-b7029fdf007e)，Exec lifecycle hook 是机器的探活机制，如果检测失败的话会重启应用\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256373/1708668474797-9f0b3d01-9e52-4b8e-a10f-c6e19ff0e839.png)\n\n### 4.2【处置能力】\n#### 4.2.1 故障发现&响应\n+ **是否监控发现**\n    - [x] 故障触发方 监控发现\n    - [ ] 故障受影响方 监控发现\n    - [ ] 否，原因为：（监控无效/监控缺失）\n+ **是否存在应急协同问题**\n    - [ ] 是\n        - [ ] 应急流程不明确（无流程或者流程不清晰、应急相关角色&职责不明确，缺失一号位等)\n        - [ ] 应急执行不到位（有流程，但未按流程执行，通告发送不及时，响应不及时等）\n    - [x] 否\n\n**〖问题总结〗**\n\n**〖改进点〗**_**需明确写明不同故障相关方的改进项（若有的话），下同。**_\n\n1、\n\n#### 4.2.2 故障定位&恢复\n+ **主要恢复方式：**\n    - [ ] 代码发布/回滚\n    - [ ] 配置发布/回滚\n    - [ ] 数据订正\n    - [ ] 机器隔离/重启/扩容\n    - [ ] 配置限流\n    - [ ] 预案降级\n    - [ ] 自动恢复\n    - [x] 其他：数据库授权后重启机器\n\n## 六、故障Action\n1. 汽车票存在很多应用连接同一个db的情况，需要进行详细梳理，同时针对db进行授权申请。  行勉 已完成\n2. 调研单机预警相关的监控，是否有监控机器是否存活的规则，进行配置&预警。  行勉   已完成  （HSF在线率）   keyaction\n\nCRO集团安全dbname授权管理名单  海遇  （trust）\n\n## 七、影响产品线&影响面\n    - [ ] 是否影响可用性\n        * 可用性指标，可用性时长消耗\n    - [x] 业务影响：\n        * 影响的产品线，业务功能，功能受损程度（成功量/率下跌多少%），持续多少时间\n    - [ ] 是否有客诉量：\n        * 在线，热线，排队量\n\n_/* 可附相关故障等级定义的链接和截图]*/_\n\n链接：\n\n截图：11:44-12:27持续43分钟期间成功量从80+跌至10+左右\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256373/1708658144159-ffd4675a-98ef-464a-9ecd-cd3093826a07.png)",
    "chunk_order_index": 1,
    "full_doc_id": "doc-495ef51eb2b80758797b1af4b91c3b23"
  },
  "chunk-b61146a07fe2b97eceaa0e11c7992ac2": {
    "tokens": 1200,
    "content": "## 一、故障简述\n故障简述：于11:10起，酒店日历房交易开始下跌（包含创建、下单）失败量上涨，成功率跌至75%左右，故障原因为商品库字符集变更导致，通过停止数据库任务和重启主库，于11:23相关监控恢复日常水平\n\n## 二、故障过程回顾\n### 2.1【故障处理时间线】\n故障时间线：\n\n2024-03-06 11:08，收到hotel_supplier_ic数据库报警**【故障发现】**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/308211/1709719087938-bbb04cbd-2230-488e-9bbf-357b46dda7df.png)\n\n2024-03-06 11:10:29，开发停止数据库变更任务【初因定位】【**故障响应**】\n\n2024-03-06 11:11，酒店渲染订单预警触发****\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256373/1709696309935-634d1a3d-6afb-4892-acec-68741b2b8d1a.png)\n\n2024-03-06 11:15，拉通应急群后同步为DB变更引起\n\n2024-03-06 11:20，触达故障等级定义【故障发生】\n\n2024-03-06 11:22，DBA同学协助重启主库【恢复执行】\n\n2024-03-06 11:23，监控恢复正常水平**【故障恢复】**\n\n## 三、故障原因\n### 3.1【背景说明】\n+ 【需求背景】：\n    - 由于阿里体系内使用mysql数据库，varchar 类型字段默认为大小写不敏感;导致酒店部分商家(系统商)无法接入；\n    - 技术方案：[《外部库&商品库 外部id(code) 数据库大小写不敏感》](https://aliyuque.antfin.com/fliggy-hotel/switch/mqt3qa9gkyigg7pg?singleDoc# )；通过dms [onlineDDL](https://aliyuque.antfin.com/db_service_lark/magkb7/rao0wi)无锁操作，修改字段字符集为 `utf8_bin` 、 `utf8mb4_bin`以支持大小写敏感;\n+ 涉及数据库：\t\n    - 外部库：HOTELDC_APP, 7 * 64(分表) = 448 张表\n    - 商品库：HOTEL_SUPPLIER_IC_APP，5 * 32(分库) * 128(分表)  = 20480 张表\n+ 评估过程\n    - 解决方案：通过咨询 DBA ，DBA给出解决方案；以及风险评估；\n        * [修改数据字段大小写不敏感问题咨询 · Aone](https://aone.alibaba-inc.com/v2/project/959292/bug/55306915)\n        * 结论：通过dms [onlineDDL](https://aliyuque.antfin.com/db_service_lark/magkb7/rao0wi)无锁操作，无明显风险\n    - 执行过程分析：外部库数据单向流入IC库且无线上操作依赖，先操作外部库验证操作后操作商品库\n        * 外部库流程\n            + 03.04 17:30 提交工单(31015139)；发布量  5 * 64 = 320 张表；\n            + 03.04 18:09 发现由于数据库 dms tps 过高部分表执行失败；寻求DBA(张鹏、莫居)帮助，所有现有手段都无法保证不影响线上，可以通过减少dms操作来规避问题\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/7075/1709705207613-0ce89912-00c5-4467-8cef-9156dc96bbc1.png)\t ![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/7075/1709706040155-31239865-918b-45aa-9e75-3dfde983aba8.png)\t\n\n            + 03.05 分析执行失败表，主要集中在含有 华住旗舰店(不合作，但有链路数据未停止) 以及 帮订房 业务的数据表中；结合外部数据写入情况，停止了华住旗舰店、暂停帮订房数据写入10分钟；\n            + 03.05 22:00 工单整体执行完成；无异常情况；单表最长执行时间 1小时，整体花费两天;\n        * 商品库执行流程\n            + 基于外部库执行成功的经验，无锁操作、由于商品库分表4064张单表dms流量明显比外部库要小、20320张表操作耗时长无法只能在业务低峰期间操作完成，故还是选择白天；\n            + 03.05 11:00 提交执行，11:10 观察到，b_hotel 表 32个执行计划，31个成功且无明显异常，故继续执行\n\n### 3",
    "chunk_order_index": 0,
    "full_doc_id": "doc-209a63f5fdf3768708efe1050013a3cb"
  },
  "chunk-e6c8a33cdf8b874ae880a6d47e3928cc": {
    "tokens": 1200,
    "content": "执行成功的经验，无锁操作、由于商品库分表4064张单表dms流量明显比外部库要小、20320张表操作耗时长无法只能在业务低峰期间操作完成，故还是选择白天；\n            + 03.05 11:00 提交执行，11:10 观察到，b_hotel 表 32个执行计划，31个成功且无明显异常，故继续执行\n\n### 3.2【原因分析】\n**一句话原因：**\n\n通过dms [onlineDDL](https://aliyuque.antfin.com/db_service_lark/magkb7/rao0wi) 无锁操作修改表字段字符集为utf8_bin 以支持大小写，HOTEL_SUPPLIER_IC_APP 分32个库其中一个库(hotel_supplier_ic_0012) [onlineDDL](https://aliyuque.antfin.com/db_service_lark/magkb7/rao0wi)  处于被关闭状态(研发无法查看此配置)，任务自动被退化为有锁操作，导致被锁表后数据库连接池被打爆\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/308211/1709706987887-62311bf9-bc62-4a78-8f1b-da00bfbcd480.png)\n\n**根因分析：**\n\n+ 2023-05-21 :  DMS工单号：27881622(速8/恭胜 ACM覆盖(ebk查询商品acm父rp方式优化)) ；商品库同学操作RP库重建索引，失败后，求助DBA(应情) ，DBA 关闭 `hotel_supplier_ic_0012` 库 `onlineDDL`，后未重新开启\n\n```sql\nALTER TABLE `b_rate_plan_[0000-0127]`\n\tADD COLUMN `base_rp_flag` tinyint NULL COMMENT '是否为父RP，0：否，1：是',\n\tDROP KEY `idx_supplier_id_out_hid`,\n\tADD KEY `idx_supplier_id_out_hid` (`supplier_id`,`hid`,`base_rp_flag`) COMMENT '编辑索引 idx_supplier_id_out_hid 新增 base_rp_flag';\n```\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/7075/1709729166666-5a86326b-8f36-40e7-ae84-0eba8682ddfa.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/7075/1709729383258-3c5fb648-ad80-416a-bab2-cad200753931.png)\n\n+ 24-03-06 枭奇操作，因大小写问题操作DDL，执行到 `hotel_supplier_ic_0012` 库时，由于之前的 `onlineDDL`被关闭，DMS 任务自动被退化为有锁操作，导致被锁表后数据库连接池被打爆\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/7075/1709777899634-fc1f4fdf-6b7d-46b2-8c56-6c3da6008a80.png)\n\n\n\n## 四、关注点分析\n_/* 填写说明：根据故障实际情况可增删关注点，并提供详细内容分析*/_\n\n### 4.1【系统质量】\n#### 4.1.1 需求&设计评估\n**〖关注点1〗****是否涉及产品、技术方案评估？此核心的问题是什么，如何改进？**\n\n- [x] **是，涉及**\n    - [ ] 需求评估遗漏\n    - [ ] 产品设计缺陷\n    - [ ] 系统架构设计缺陷\n        - [x] 容错性不足 \n        - [ ] 单点，无冗余\n        - [ ] 缺乏自我保护\n        - [ ] 缓存设计不当\n        - [ ] 容量评估不足\n        - [ ] 非幂等设计\n        - [ ] 强弱依赖不合理\n        - [ ] 其他：__________\n- [ ] 否，不涉及\n\n**〖问题总结〗**\n\n**〖改进点〗**_**需明确写明不同故障相关方的改进项（若有的话），下同。**_\n\n1、\n\n#### 4.1.2 代码质量  不涉及\n**〖关注点1〗是否代码自身存在漏洞或BUG、代码健壮性是否存在问题等?**\n\n**〖问题分析〗**\n\n**〖改进点〗**_**需明确写明不同故障相关方的改进项（若有的话），下同。**_\n\n1、\n\n\n\n**〖关注点2〗****是否经过CodeReview？CodeReview阶段是否发现问题？为何没发现？**\n\n+ **是否经过CR**\n    - [ ] 是\n    - [ ] 否\n    - [ ] 不涉及\n+ **是否设置合理的CR卡点**\n    - [ ] 是\n    - [ ] 否\n    - [ ] 不涉及\n+ **CodeReview阶段是否发现问题？为何没发现？后续如何发现？**\n    - [ ] 是\n    - [ ] 否\n    - [ ] 不涉及\n\n**〖问题分析〗******\n\n**〖改进点〗**",
    "chunk_order_index": 1,
    "full_doc_id": "doc-209a63f5fdf3768708efe1050013a3cb"
  },
  "chunk-382d18829468f39cbf762958e789a876": {
    "tokens": 1200,
    "content": "- [ ] 否\n    - [ ] 不涉及\n+ **是否设置合理的CR卡点**\n    - [ ] 是\n    - [ ] 否\n    - [ ] 不涉及\n+ **CodeReview阶段是否发现问题？为何没发现？后续如何发现？**\n    - [ ] 是\n    - [ ] 否\n    - [ ] 不涉及\n\n**〖问题分析〗******\n\n**〖改进点〗**_**需明确写明不同故障相关方的改进项（若有的话），下同。**_\n\n1、\n\n\n\n**〖关注点3〗****测试阶段**\n\n+ **测试内容：**涉及的测试提交单、测试用例等\n+ **测试人员：**\n+ **是否经过测试验证**\n    - [ ] 是，验证环境\n        - [ ] 预发环境\n        - [ ] 日常环境\n    - [ ] 是，测试方法\n        - [ ] 单元测试\n        - [ ] 功能回归测试\n        - [ ] 集成测试/链路测试\n        - [ ] 验收测试\n    - [ ] 否\n    - [ ] 不涉及\n+ **测试未发现原因是什么？后续如何改进？**\n    - [ ] 回归测试遗漏\n        - [ ] 手工回归测试用例遗漏\n        - [ ] 自动化未建设\n        - [ ] 自动化回归覆盖不足\n        - [ ] 其他：__________\n    - [ ] 新场景测试遗漏\n        - [ ] 功能测试用例遗漏，包括正常分支和异常分支\n        - [ ] 容灾兜底测试遗漏\n        - [ ] 客户端兼容性测试遗漏\n        - [ ] 埋点测试遗漏\n        - [ ] 性能测试遗漏，影响评估不足\n        - [ ] 安全测试遗漏\n    - [ ] 其他：__________\n\n**〖问题总结〗**\n\n**〖改进点〗**_**需明确写明不同故障相关方的改进项（若有的话），下同。**_\n\n1、\n\n#### 4.1.3 变更质量\n+ **是否涉及变更：**\n    - [x] 是\n    - [ ] 否\n+ **变更类型：**\n    - [ ] 代码发布\n    - [ ] 配置变更\n    - [x] 其他变更：______DMS 数据库变更_（待更新）_____\n    - [ ] 不涉及\n+ **变更平台是否接入ChangeFree：**\n    - [x] 是，CF变更单链接：_____[https://aicf.alibaba-inc.com/aicf/change/v2/detail/800828135?spm=goc-apm.aicf-_changeList.0.0.21e52388blyfe1](https://aicf.alibaba-inc.com/aicf/change/v2/detail/800828135?spm=goc-apm.aicf-_changeList.0.0.21e52388blyfe1)___\n\n_/*要这样的链接_ [https://aicf.alibaba-inc.com/aicf/change/detail/1725370372](https://aicf.alibaba-inc.com/aicf/change/detail/1725370372) */\n\n    - [ ] 否\n+ **是否违反变更红线3.1**** **[链接](https://aliyuque.antfin.com/ngoc/fzg6dy/uar1k6)\n    - [ ] 是，违反哪条原则：\n    - [x] 否\n\n\n\n### 4.2【处置能力】\n#### 4.2.1 故障发现&响应\n+ **是否监控发现**\n    - [x] 故障触发方 监控发现\n    - [ ] 故障受影响方 监控发现\n    - [ ] 否，原因为：（监控无效/监控缺失）\n+ **是否5分钟内响应**\n    - [x] 是\n    - [ ] 否，原因为：\n+ **是否存在应急协同问题**\n    - [ ] 是\n        - [ ] 应急流程不明确（无流程或者流程不清晰、应急相关角色&职责不明确，缺失一号位等)\n        - [ ] 应急执行不到位（有流程，但未按流程执行，通告发送不及时，响应不及时等）\n    - [x] 否\n\n**〖问题总结〗**\n\n**〖改进点〗**_**需明确写明不同故障相关方的改进项（若有的话），下同。**_\n\n1、\n\n#### 4.2.2 故障定位&恢复\n+ **主要恢复方式：**\n    - [x] 其他： 停止任务后DBA同学协助切换备库，重启主库\n\n\n\n## 六、故障Action\naction：校验全库后给出强提示（可二次操作） 为知      3.29    keyaction\n\naction：online ddl将无锁开关开放给用户侧（出方案）    为知    3.29\n\naction：后续表变更风险评估和online ddl 开关确认  枭奇  为知（协助）   3.20\n\n## 七、影响产品线&影响面\n    - [ ] 是否影响可用性\n        * 可用性指标，可用性时长消耗\n    - [x] 业务影响",
    "chunk_order_index": 2,
    "full_doc_id": "doc-209a63f5fdf3768708efe1050013a3cb"
  },
  "chunk-4f4d59845bcc97eb1a3a1a1dfd004352": {
    "tokens": 384,
    "content": "：online ddl将无锁开关开放给用户侧（出方案）    为知    3.29\n\naction：后续表变更风险评估和online ddl 开关确认  枭奇  为知（协助）   3.20\n\n## 七、影响产品线&影响面\n    - [ ] 是否影响可用性\n        * 可用性指标，可用性时长消耗\n    - [x] 业务影响：\n        * 影响的产品线，业务功能，功能受损程度（成功量/率下跌多少%），持续多少时间\n    - [ ] 是否有客诉量：\n        * 在线，热线，排队量\n    - [ ] 是否有社会舆情：\n        * 舆情ESU等级/未到E等级，舆情关键词，总声量，负声量\n\n_/* 可附相关故障等级定义的链接和截图]*/_\n\n_11:09-11:22期间_\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256373/1709707239057-d5b8b2f9-1c58-4565-bf85-d701684ad2da.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256373/1709707303597-2d6496a6-a251-4222-9cbd-b272aa9ce3b9.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256373/1709707331059-86d770be-2385-42c1-a500-3274cd5f6f0e.png)",
    "chunk_order_index": 3,
    "full_doc_id": "doc-209a63f5fdf3768708efe1050013a3cb"
  },
  "chunk-9ba373a64a1cc628b503b9f5b1cc3fd2": {
    "tokens": 1200,
    "content": "## 一、故障简述\n故障简述：于2024-03-22 16:30开始，小蜜首页接口总成功率异常下跌，原因定位为账号应用依赖的中心TDDL库缺少权限，而小蜜首页应用依赖账号应用，用于用户登录信息验证，而账号应用机器实例因集团驱逐任务被驱逐，新实例无法正常启动，导致小蜜首页找不到HSF服务报错，TDDL授权后机器重启，于17:07监控恢复正常\n\n\n\n## 二、故障过程回顾\n### 2.1【故障处理时间线】\n故障时间线：\n\n2024-03-13 09:52，业务进行缩容，此时副本数为1\n\n[https://login.alibaba-inc.com/ssoLogin.htm?APP_NAME=asi-console-ultra&BACK_URL=https%3A%2F%2Fasi-console.alibaba-inc.com%2Fdiagnosis%2Fworkload%3Fspm%3Da1znbf.index.upgradeOrder.1.290b7d30KYNsJF%26workloadName%3Dfliggy-me-account-a4ca2cb1-d86e-4180-8df1--n3&RQ_SUFFIX=.htm](https://login.alibaba-inc.com/ssoLogin.htm?APP_NAME=asi-console-ultra&BACK_URL=https%3A%2F%2Fasi-console.alibaba-inc.com%2Fdiagnosis%2Fworkload%3Fspm%3Da1znbf.index.upgradeOrder.1.290b7d30KYNsJF%26workloadName%3Dfliggy-me-account-a4ca2cb1-d86e-4180-8df1--n3&RQ_SUFFIX=.htm)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256373/1711442545368-f865ed8a-e844-467c-b022-9a9be4ee2ff1.png)\n\n2024-03-22 16:30，[集群资源管理]资源碎片整理，应用实例被重调度，会摘除流量并新建实例，驱逐fliggy-me-account最后一台实例33.102.82.175，触发所有fliggy-me-account实例HSF服务下线【故障引入】\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/111256600/1711123315447-6cd7bcdc-0703-4c98-a562-201e41e145a5.png)\n\n2024-03-22 16:31，[首页接口总成功率](https://x.alibaba-inc.com/custom/59/product/preview/spm/14310?crossTenant=true)监控指标异常，收到服务预警电话报警**【故障发现】**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/4640/1711100362856-3e007f57-ee8c-4daf-a86c-a73edd1fff3e.png)![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/111256600/1711124827632-4f2c3f72-d28e-4ad5-ab8b-1d51239e2524.png?x-oss-process=image%2Fformat%2Cwebp%2Fresize%2Cw_1406%2Climit_0)\n\n2024-03-22 16:32，东晖接手告警，开始排查；\n2024-03-22 16:33，GOC拉群并拉起电话会议，同时研发反馈服务所有入口无法进入小蜜：\n2024-03-22 16:39，东晖排查到fliggy-alime-foreground应用找不到fliggy-me-account应用HSF服务，开始重启fliggy-me-account应用；【初因定位】\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/111256600/1711124575009-7f12d339-f1ad-455f-b8e8-1684b36e1707.png)\n\n2024-03-22 16:44，东晖电话会议里反馈fliggy-me-account应用重启失败，排查到重启失败原因是数据库连接异常导致\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/111256600/1711351241740-7a5edd7c-d945-4e11-b7ae-733e9bb4f4ca.png)\n\n2024-03-22 16:46，小蜜首页接口总成功率下跌异常，总量当前时间值大于等于80，成功率最近15分钟最大值小于等于20%，已达到P4故障；【故障发生】\n2024-03-22 16:49，东晖开始对fliggy-me-account进行扩容；\n2024-03-22 16:51，青宸定位到可能是中心TDDL库权限对飞猪单元取消授权导致，并且定位到是ALICARE_APP库权限；【原因定位】\n2024-03-22 16:52，东晖开始拉于臻、信定加入群聊；\n2024-03-22",
    "chunk_order_index": 0,
    "full_doc_id": "doc-ca9aed4140ccbaf23584b699a995de50"
  },
  "chunk-30a21d4186079f8b14a3e1e1bc07caf8": {
    "tokens": 1200,
    "content": "22 16:49，东晖开始对fliggy-me-account进行扩容；\n2024-03-22 16:51，青宸定位到可能是中心TDDL库权限对飞猪单元取消授权导致，并且定位到是ALICARE_APP库权限；【原因定位】\n2024-03-22 16:52，东晖开始拉于臻、信定加入群聊；\n2024-03-22 16:58，信定群聊反馈在trust平台me-account应用下没有入口添加ALICARE_APP库权限\n2024-03-22 17:00，子威提供在dms后台直接添加权限的方案，青宸联系于臻、信定操作添加权限\n2024-03-22 17:01，总量当前时间值大于等于80且成功率最近30分钟最大值小于等于20%，故障升级至P3；【故障升级】\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/111256600/1711126215517-683ca3b0-f0f1-4ad7-83e4-5f43a4772db6.png)\n\n2024-03-22 17:03，dba林顿协助后台操作，给fliggy-me-account应用添加ALICARE_APP库的授权；\n2024-03-22 17:03，东晖重新对应用进行重启；【恢复执行】\n2024-03-22 17:06，扩容机器启动成功，17:07监控恢复正常；【故障恢复】\n\n\n\n## 三、故障原因\n### 3.1【原因分析】\n一句话原因：\n\nfliggy-me-account应用缺少中心ALICARE_APP库权限，01.30之后trust平台自动开启了校验，之后部署或者重启会失败。最近一个月集团驱逐任务不定期自动执行（会同时执行老实例的下线和新实例的扩容），每驱逐一台实例会导致本应用因权限问题导致启动失败减少线上一台实例，03.22驱逐了最后一台可用实例，最终导致fliggy-me-account无可用服务。\n\n\n\n【背景】：\n\n1、独立部署飞猪单元fork完CCO的代码后，因db的squence一直获取的是中心db的asequece，需要在fork完代码后**先抬高单元的sequece后再切回单元**，然后在单元应用下掉中心的db配置代码。因sequence的切换不影响业务真正使用，再加上目前人力不足，当时约定放在3月进行排期完成；\n\n2、集团驱逐任务会对老的实例开始发起删除操作(支持优雅下线且会摘流)，同时新的应用实例开始创建(同扩容操作)并启动应用；\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/111256600/1711336241364-22bf9bd4-b7ab-4341-ac7a-5643d0dddd1d.png)\n\n3、fliggy-me-account应用，连接ALICARE_APP库，1.25发布成功，3.22重启时，报没权限，启动失败；\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/111256600/1711336950899-d9ec28fb-022b-4f4e-9877-ff52656fb2bd.png)\n\n 从dbservice申请的数据库默认全开放，不做权限授权卡点，有需要的业务自己在trust上进行授权控制；  \n已有的数据库如果没有做过授权，那就是全开放；如果中途做了授权，那除了被授权的应用，其他都无法访问，已经访问该数据库的应用在重启后会出现没有权限的问题  \n\n【原因】\n\n1、fliggy-me-account应用缺少中心ALICARE_APP库权限，01.30之后trust平台自动开启了校验，之后部署或者重启会失败\n\n2、集团驱逐任务自动执行，驱逐任务会同步删除老实例和创建新实例，但新实例部署会失败，导致fliggy-me-account应用的机器实例逐台不可用，16:30驱逐完最后一台，最终导致fliggy-me-account无可用服务\n\n3、健康检查监控未能提前发现问题，配置不准确，配置了三台机器才报警（原线上四台机器，由于成本问题于03.13缩容一台机器，未及时调整健康检查的阈值）\n\n\n\n## 四、关注点分析\n#### 4.3.1 为什么之前ALICARE_APP库没有给fliggy-me-account应用授权？\n1. 在部署测试上线阶段是可以正常启动并通过验证正常上线，已经在线上正常运行两个月左右；\n2. 本次出现问题的fliggy-me-account应用（以及对应中心的me-account应用）并没有开启trust平台tddl鉴权的功能，实际ALICARE_APP库的tddl鉴权功能是配置在speech-robot-support应用上，所以无法直观的了解到fliggy-me-account应用是否开启了tddl鉴权功能；\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/111256600/1711454238976-43278106-64e2-42cc-8753",
    "chunk_order_index": 1,
    "full_doc_id": "doc-ca9aed4140ccbaf23584b699a995de50"
  },
  "chunk-071a1419dfb44c1f78553d824e8f124d": {
    "tokens": 1200,
    "content": "）并没有开启trust平台tddl鉴权的功能，实际ALICARE_APP库的tddl鉴权功能是配置在speech-robot-support应用上，所以无法直观的了解到fliggy-me-account应用是否开启了tddl鉴权功能；\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/111256600/1711454238976-43278106-64e2-42cc-8753-1acf66f66898.png)\n\n#### 4.3.2 为什么之前能部署起来，突然报权限问题，中途是否有人更改？\n1. ALICARE_APP库预发的拦截状态是观察，即不拦截，所以预发是无法发现启动问题；\n2. ALICARE_APP库线上在独立部署项目之前就已开启了权限校验，配置在speech-robot-support应用上（[trust链接](https://trust.alibaba-inc.com/#/speech-robot-support/tddl/detail/ALICARE_APP?type=0&env=sh)），trust平台的鉴权逻辑对新应用（没有dauth身份）会有兜底的定制：\n    - 1月25号 fliggy-me-account新应用首次发布，由于线上没有dauth身份，走了兜底逻辑，直接通过鉴权\n    - 发布的5天后（1月30号） fliggy-me-account应用的aone状态自动变更为已上线，同时自动注册dauth身份，接下去如果执行鉴权都会鉴权失败（预发）\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/33849/1711359690264-352a3060-9a64-4713-a9a5-a68e0032012b.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/33849/1711359744876-44692c76-5329-49ce-939d-c263df12dd2a.png)\n\naction：aone注册dauth身份机制  海遇  龙幽\n\n#### 4.3.3 为什么应用还连着cco中心的库\n1. 不少独立部署的应用（包括本应用）线上切sequence的子项目还没有完成，所以该应用启动时还是会继续连cco中心的库\n\n\n\n#### 4.3.4 为什么线上所有的机器逐渐都挂了\n1. 集团的基础设施会因为一些原因对不定期自动的对应用的机器实例做驱逐；\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/111256600/1711456158397-cd36ffac-aeaa-4fbe-94ea-71050d7cd170.png)\n\n2. 最近一个月fliggy-me-account应用陆续触发了三次驱逐任务（线上一共3台实例），故障的开始时间点就是第三次驱逐任务\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/111256600/1711455402885-90379b2a-66bb-40e2-85ec-1368d0953ba9.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/111256600/1711455450439-10e6a973-3040-4561-96cb-5746daffcc66.png)\n\n3. 驱逐的过程是删除老实例和启动新实例是同时进行的，触发驱逐任务对上层业务是有通知的，但是**新实例启动失败是没有通知的**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/111256600/1711123315447-6cd7bcdc-0703-4c98-a562-201e41e145a5.png)\n\naction：针对应用实例数 驱逐机制优化（先扩容） 已开发完成 烛坤\n\naction：新实例启动失败通知  子伟  （线上应用启动失败）\n\n\n\n集团驱逐任务原理见：[泛电商业务实例被驱逐问题解答](https://aliyuque.antfin.com/sigmahost/av6hf2/pi6g0ushw9giooql)\n\n4.原实例未正常启动，什么条件下会把最后一台实例驱逐 \n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256373/1711442545368-f865ed8a-e844-467c-b022-9a9be4ee2ff1.png?x-oss-process=image%2Fformat%2Cwebp%2Fresize%2Cw_1406%2Climit_0)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256373/1711509290414-34b36c5a-1cbd-40ea-8ba8-1a5ea1426fb3.png)\n\n#### 4.3.5 为什么健康检查没有报出来？\n1. 健康检查设置的是3台机器出现探测失败进行告警的，fliggy-me-account实例个数一开始是4个，后面由于成本考虑下线了一台机器，所以自始至终没有报出来。\n\n### 4.1",
    "chunk_order_index": 2,
    "full_doc_id": "doc-ca9aed4140ccbaf23584b699a995de50"
  },
  "chunk-d598ffe9052da846e1a4857a0f7ec069": {
    "tokens": 1200,
    "content": "34b36c5a-1cbd-40ea-8ba8-1a5ea1426fb3.png)\n\n#### 4.3.5 为什么健康检查没有报出来？\n1. 健康检查设置的是3台机器出现探测失败进行告警的，fliggy-me-account实例个数一开始是4个，后面由于成本考虑下线了一台机器，所以自始至终没有报出来。\n\n### 4.1【系统质量】\n#### 4.1.1 需求&设计评估\n**〖关注点1〗****是否涉及产品、技术方案评估？此核心的问题是什么，如何改进？**\n\n- [ ] **是，涉及**\n    - [ ] 需求评估遗漏\n    - [ ] 产品设计缺陷\n    - [x] 系统架构设计缺陷\n        - [x] 容错性不足 \n        - [ ] 单点，无冗余\n        - [ ] 缺乏自我保护\n        - [ ] 缓存设计不当\n        - [ ] 容量评估不足\n        - [ ] 非幂等设计\n        - [ ] 强弱依赖不合理\n        - [ ] 其他：__________\n- [ ] 否，不涉及\n\n**〖问题总结1〗****切库的方案是双库连接，即使单元切换到了单元库，在启动的过程中也会因依赖中心库而启动失败；目前所有fork过来的代码中，还保留了切库的代码，理论在整体的方案中，没有注明谁要干，或者在fork前就把这部分代码去掉**\n\n**〖改进点〗**1、需要安排时间fork回来所有应用涉及切库部分把这部分代码去掉\naction：fork回来所有应用涉及切库部分把这部分代码去掉（评估）息衍 kayaction\n\n\n**〖问题总结2〗****开启了库鉴权的owner，应该扫描一下对应的应用未授权的情况，做相关通知（因为连接方无法预先知道对应的库开启了鉴权）**\n\n**〖改进点〗**1、参考汽车票的故障：[https://aliyuque.antfin.com/error/share/nzz056mws8td50tx](https://aliyuque.antfin.com/error/share/nzz056mws8td50tx)，是由DB的owner对口的：[https://fbi.alibaba-inc.com/dashboard/view/page.htm?spm=a2o1z.8190073.0.0.d7a0543f70Tt5r&id=1403524](https://fbi.alibaba-inc.com/dashboard/view/page.htm?spm=a2o1z.8190073.0.0.d7a0543f70Tt5r&id=1403524)\n\n对应飞猪服务这里，把我们连接的库都扫一遍，看谁开启了鉴权，然后逐个通知对应DB owner给自己的应用授权。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/4640/1711438481953-090fe66b-e048-442b-a81d-26274ad9da3e.png)\n\n对应CCO这里，可以让库owner看看哪些做了部分授权，需要警示出来，主动赋权上（以防我们自己扫得不全，以及别的BU也有这样的坑）\naction：tddl权限校验检查通知 （访问应用级别）  祈灵   kayaction\naction：将账号注册校验前置（预发赋予全权限） 祈灵 \n\n\n**〖问题总结3〗****ASI删除老实例和启动新实例是同时进行的；新实例启动失败没有报警目前ASI是没有做的，对应的应用无法感知自己线上的机器已经启动不起来了**\n\n**〖改进点〗**建议新实例启动失败通知对应的应用owner\n\n\n\n**〖问题总结4〗****trust系统在进行授权时操作很繁琐，尝试了几次都不成功，最后还是联系DBA用一些后门方法解决**\n\n**〖改进点〗**\n\n\n\n\n\n#### 4.1.2 代码质量  不涉及\n**〖关注点〗****测试阶段**\n\n+ **测试内容：**涉及的测试提交单、测试用例等\n+ **测试人员：**\n+ **是否经过测试验证**\n    - [x] 是，验证环境\n        - [ ] 预发环境\n        - [ ] 日常环境\n    - [x] 是，测试方法\n        - [ ] 单元测试\n        - [x] 功能回归测试\n        - [ ] 集成测试/链路测试\n        - [ ] 验收测试\n    - [ ] 否\n    - [x] 不涉及\n+ **测试未发现原因是什么？后续如何改进？**\n    - [ ] 回归测试遗漏\n        - [ ] 手工回归测试用例遗漏\n        - [ ] 自动化未建设\n        - [ ] 自动化回归覆盖不足\n        - [ ] 其他：__________\n    - [ ] 新场景测试遗漏\n        - [ ] 功能测试用例遗漏，包括正常分支和异常分支\n        - [ ] 容灾兜底测试遗漏\n        - [ ] 客户端兼容性测试遗漏\n        - [ ] 埋点测试遗漏\n        - [ ] 性能测试遗漏，影响评估不足\n        - [",
    "chunk_order_index": 3,
    "full_doc_id": "doc-ca9aed4140ccbaf23584b699a995de50"
  },
  "chunk-10d5d54d96bf7b777102fe2e5291950c": {
    "tokens": 1200,
    "content": "[ ] 自动化回归覆盖不足\n        - [ ] 其他：__________\n    - [ ] 新场景测试遗漏\n        - [ ] 功能测试用例遗漏，包括正常分支和异常分支\n        - [ ] 容灾兜底测试遗漏\n        - [ ] 客户端兼容性测试遗漏\n        - [ ] 埋点测试遗漏\n        - [ ] 性能测试遗漏，影响评估不足\n        - [ ] 安全测试遗漏\n    - [ ] 其他：__________\n\n**〖问题总结〗****预发环境未发现问题的原因是因为预发没有配置拦截，无法发现；线上启动第一次也是不校验的，无法发现**\n\n**〖改进点〗**_****_\n\n1、可以考虑预发针对鉴权统一开启拦截，这个需要数据库挂载的应用来开启配置，CCO这里看看是否需要统一扫描\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/tif/4640/1711442156819-84563549-544e-447c-880d-f753a0c575dc.tif?x-oss-process=image/format,png)\n\n### 4.2【处置能力】\n#### 4.2.1 故障发现&响应\n+ **是否监控发现**\n    - [x] 故障触发方 监控发现\n    - [ ] 故障受影响方 监控发现\n    - [ ] 否，原因为：（监控无效/监控缺失）\n+ **是否存在应急协同问题**\n    - [ ] 是\n        - [ ] 应急流程不明确（无流程或者流程不清晰、应急相关角色&职责不明确，缺失一号位等)\n        - [ ] 应急执行不到位（有流程，但未按流程执行，通告发送不及时，响应不及时等）\n    - [x] 否\n\n**〖问题总结1〗****应用健康检查设置的是3台机器出现探测失败进行告警的，fliggy-me-account实例个数一开始是4个，后面由于成本缩容到了3台，没有调整监控报警了，所以自始至终没有报出来。**\n\n**〖改进点〗**\n\naction：健康检查报警设置检查：1.触发比例1台就报警2.报警等级配置critical短信报警，urgent电话报警3.应用订阅：应用owner和对应测试 \n2.缩容操作需要通告给团队，否则负责安全生产相关的人无法有相应的检查动作\n\n#### 4.2.2 故障定位&恢复\n+ **主要恢复方式：**\n    - [ ] 代码发布/回滚\n    - [ ] 配置发布/回滚\n    - [ ] 数据订正\n    - [x] 机器隔离/重启/扩容\n    - [ ] 配置限流\n    - [ ] 预案降级\n    - [ ] 自动恢复\n    - [ ] 其他：\n\n**〖关注点1〗定位&恢复阶段存在什么问题？是否可以增加预案，****有更快的恢复方式？****相关的优化改进？**\n\n**〖问题总结〗**\n\n**〖改进点〗**\n\n1、\n\n## \n## 六、故障Action\n【飞猪】action：健康检查报警设置检查：1.触发比例1台就报警2.报警等级配置critical短信报警，urgent电话报警3.应用订阅：应用owner和对应测试   4.3\naction：tddl权限校验检查通知 （访问应用级别）  祈灵   kayaction  4.15\naction：将账号注册校验前置（预发赋予全权限） 祈灵 4.15\n【飞猪】action：fork回来所有应用涉及切库部分把这部分代码去掉（评估）息衍     kayaction   4.12  \naction：针对应用实例数 驱逐机制优化（先扩容） 已开发完成 烛坤   待上线\n【飞猪】：新实例启动失败通知  子伟  （线上应用启动失败  【 楚墨 龙幽 已与子伟沟通】\n【飞猪】action：aone注册dauth身份机制  海遇  龙幽\n\n## 七、影响产品线&影响面\n    - [ ] 是否影响可用性\n        * 可用性指标，可用性时长消耗\n    - [x] 业务影响：\n        * 影响的产品线，业务功能，功能受损程度（成功量/率下跌多少%），持续多少时间\n    - [ ] 是否有客诉量：\n        * 在线，热线，排队量\n\n_/* 可附相关故障等级定义的链接和截图]*/_\n\n\n\n2024-03-22 16:30:00 ～ 17:06:00 小蜜全部流量首页白屏，预计影响5000次访问\n\n（[故障场景定义](https://tr.alibaba-inc.com/orm/config/emergency-scene/list/online?children=true&nodeId=44513&depth=1&refId=3d052038b588228a&scenarioTypes%5B0%5D=FAULT_RISK&scenarioTypes%5B1%5D=FAULT)）\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/802563",
    "chunk_order_index": 4,
    "full_doc_id": "doc-ca9aed4140ccbaf23584b699a995de50"
  },
  "chunk-001c6b870620d961a83b2eb4e5169a7d": {
    "tokens": 191,
    "content": "[故障场景定义](https://tr.alibaba-inc.com/orm/config/emergency-scene/list/online?children=true&nodeId=44513&depth=1&refId=3d052038b588228a&scenarioTypes%5B0%5D=FAULT_RISK&scenarioTypes%5B1%5D=FAULT)）\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256373/1711520510926-344154e6-8054-49c0-ab55-7c0af8eca3e9.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256373/1711520746947-86a6e830-1b28-4fb1-90c6-ffcff158dd20.png)\n\n\n\n###",
    "chunk_order_index": 5,
    "full_doc_id": "doc-ca9aed4140ccbaf23584b699a995de50"
  },
  "chunk-88209a649c305a93be953ef6d97efa9d": {
    "tokens": 1200,
    "content": "## 一、故障简述\n##### 故障概述：\n2024年8月8日17:19&21:18两次收到产品同学反馈，国内出票大量积压，引发出票资损，故障原因初步确认是由于自营获取黑屏配置失败导致，于21:41通过修改ateye配置完成止血，故障恢复，期间影响订单量：999，客服进线量增加400，实际资损金额达P3故障等级。\n\n## 二、影响产品线及影响面\n##### 影响面：\n- [x] 是否影响可用性：否\n- [x] 业务影响：\n\n影响国内机票1E渠道出票部分业务，出票成功率跌0，从2024年8月8日04:01分开始到2024年8月8日21:41分为止，持续17h40m时间。【[国内出票大盘](https://sunfire.alibaba-inc.com/custom/59/product/preview/dashboard/31756?from=now-1h&to=now)】【[黑屏服务DAWN_SERVICE监控](https://x.alibaba-inc.com/custom/59/product/preview/generalComp/132)】\n\n- [x] 是否有客诉：\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/4505/1723598321210-130470ae-a3c3-4633-bdaa-f0373aa415ff.png)\n\n- [x] 是否有社会舆情_：_否\n- [x] 是否产生资损：__\n\n故障产生期间，**影响单量：999，理论/实际资损: RMB 216740元**。\n\n注：筛选条件：故障期间（08.08 04:00-21:41） & 黑屏渠道出票（政策EI项 包含PAT:A*） & 出票处理时长 > 10分钟 & 盈亏原因=航信故障 & 盈亏金额<0   \n\naction：财务目前口径在60W左右，资损金额和财务再对焦 [@亚云](undefined/taoyayun.tyy) [@西秦](undefined/taowang.wt) \n--8.21西秦同步，已和财务对焦完毕，口径按技术提供的为准。\n\n## 二、故障过程回顾\n2024-08-01到2024-08-07，\n\n    1. **【背景】**为切实贯彻《网络安全法》、《数据安全法》、《个人信息保护法》、《关键信息基础设施安全保护条例》和《互联网用户账号信息管理规定》的相关要求，保证数据安全，航信将于8月1日起，分批次对CRS系统个人使用工作号开启登录短信验证功能。从8月1号开始，黑屏侧可用配置逐渐减少，期间产研及业务同学尝试各种手段在应对，期间晚上可用配置数量最低时只有1个，白天可用配置数约150个。对自营自动化出票以及人工小太阳出票持续造成影响。\n    2. 8号之前服务侧人工出票一直存在积压，自营和服务同学按照标准流程应对。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/59956279/1723603003447-677bc10a-e512-4422-8d58-9a5bd019583b.png)\n\n2024-08-08 02:27，黑屏系统（dawn应用）单台机器CPU使用率超过85%告警\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/59956279/1723354997973-a0891568-7e81-4d6d-abed-d1b887a60d33.png)\n\n2024-08-08 03:44，黑屏系统（dawn应用）多台机器CPU使用率超过90%告警\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/59956279/1723355034734-457bd96a-c786-464a-8f95-e59ae736a2cd.png)\n\n2024-08-08 04:01，**【关键时间点】**通过cpu告警定位，发现是GDP下发的凌晨定时NFD运价任务下载导致数据库连接池并发超出限制，引发系统异常增多和cpu利用率超过阈值；考虑到航信近期SI验证码问题导致夜间可用配置数量过低影响正常业务，此时开发紧急执行ateye开关，关闭了GDP运价任务下发的逻辑，在2024-08-08 04:01:28修改了ateye开关，停止了GDP运价任务的入库。同时2024-08-08 04:04分在群里同步了已知道影响点。**【风险注入】【故障发生】**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/59956279/1723355199765-01c59449-4122-4197-a849-1303baa23d3b.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/59956279/1723355298766-d5495255-121b-4b94-a0a2-4eaa",
    "chunk_order_index": 0,
    "full_doc_id": "doc-b0d1bb723d8ed816472947fdc2a4998c"
  },
  "chunk-2c9b3914d4163ea6ca3f679b88996ef5": {
    "tokens": 1200,
    "content": "intranetproxy.alipay.com/skylark/lark/0/2024/png/59956279/1723355199765-01c59449-4122-4197-a849-1303baa23d3b.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/59956279/1723355298766-d5495255-121b-4b94-a0a2-4eaa61477377.png)\n\n2024-08-08 07:58，【黑屏有效配置数低】：系统告警，技术开始定位问题****\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/59956279/1723550987593-bd9a212d-b9f9-460a-9e6e-2925bf3ef421.png)\n\n2024-08-08 09:00，**【出票积压发现】**袁硕发现自营系统有1000+无票号，袁硕和秒亿电话沟通了解情况并继续等待黑屏配置。\n\n自营获取黑屏配置成功率跌0，但是观察出票成功率大盘未下跌；使用了BOP出票备份。\n\n1. BSP出票成功率下跌（原因：黑屏配置问题导致BSP自动上票号失败）\n2. BOP出票备份，成功率大盘未下跌，运营准备充足的BOP资金\n\n2024-08-08 10:15，【黑屏有效配置数低】瀚渺排查后定位有效配置量降低与前一日发布代理无关（统一对航信的出口IP降低验证码触发频率）， 同时发现其他问题，判断可能和黑屏无配置有关系（配置假死、后台打不开），开始处理。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/59956279/1723551048686-2797cb91-fdea-4973-9609-9e4a9983e97a.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/59956279/1723551057126-1449b5c0-f762-4655-9752-c692f2326a48.png)\n\n2024-08-08 10:19，****【黑屏有效配置数低】明确处理策略，增加补充恢复机制尝试快速恢复假死配置（背景：航信增加验证码后， 出现较多执行指令4分后返回响应数据，服务端稳定性降低）\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/59956279/1723551169603-602fa1b6-9bd4-4fb2-83c8-b4a04c9ef820.png):\n\n    1. 最终分支于15:49开始发布， 增加配置识别恢复机制，解决大量配置工作中 ，指令卡死【配置假死】![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/115858/1723445935663-c0d557d2-1bc2-44c3-865c-f74096da69e0.png)\n    2. 发布上线后，17:35后开启配置恢复任务，WORKING状态配置数量降低至个位数【恢复正常， 正常情况WORKING状态的配置不多， 只有当时出现假死情况，才会出现100+个WORKING状态的配置】![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/115858/1723455662552-1480f5fc-6c8d-4347-a063-17135dbcd07f.png)\n\n2024-08-08 10:22，****【管理后台无法打开】解决黑屏管理后台无法打开问题，影响产品管理黑屏配置会造成可用配置不够，定位发现dawn tair问题以及fullgc问题，开始解决\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/115858/1723443696384-467c46b1-cb93-42dc-a75a-04d1594d0f32.png)\n\n2024-08-08 10:30，线上黑屏机器fullgc严重， Javadump失败\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/115858/1723443952845-12fdace2-670b-4044-a4eb-8465c16248db.png)\n\n2024-08-08 10:33，尝试重启一台机器， 并发现近期新增DA指令存在系统漏洞， 单机重启后系统恢复![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/115858/1723444279861-4d3a320b-b31c-4363-b44f-4df3d6bec62d.png)\n\n2024-08-08 10:48，应用全量重启， 11:36全部重启完成，观察整体集群流量，各项系统指标，恢复正常；\n\n[https://cd.aone.alibaba-inc.com/unite/micro/ops/app/12145/RESTART/detail?changeOrderId=356741287",
    "chunk_order_index": 1,
    "full_doc_id": "doc-b0d1bb723d8ed816472947fdc2a4998c"
  },
  "chunk-81c454321b8299cdd07f7c5d7492a612": {
    "tokens": 1200,
    "content": "9861-4d3a320b-b31c-4363-b44f-4df3d6bec62d.png)\n\n2024-08-08 10:48，应用全量重启， 11:36全部重启完成，观察整体集群流量，各项系统指标，恢复正常；\n\n[https://cd.aone.alibaba-inc.com/unite/micro/ops/app/12145/RESTART/detail?changeOrderId=356741287000031](https://cd.aone.alibaba-inc.com/unite/micro/ops/app/12145/RESTART/detail?changeOrderId=356741287000031)\n\n2024-08-08 14:12，**【关键时间点】【出票积压发现】**袁硕侧从出票成功率看比较正常，无票号积压2166。\n\n2024-08-08 14:54，航段奖励使用预订换货结果降级方案验证完成发布。效果：恢复提货成功率到70%左右，降低了黑屏流量调用。但是降低流量无调用对恢复黑屏成功率无效\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/178512/1723450604026-20919246-2205-44f9-a68f-89f4c4e5532b.png)\n\n2024-08-08 15:00，服务侧开始拉群处理（包括希储和夙锦）![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/51243/1723451464729-1fb65865-6a54-478d-99e4-35120dea4052.png)\n\n2024-08-08 15:25，袁硕和秒亿沟通后决策无票号启用批量换渠道，阈值-100，开始执行批量换渠道出票，过程中发现2个问题导致无法通过批量换渠道解决积压。此时大家判断还是和黑屏无配置有关系，决定一边人工处理一边继续等待黑屏恢复（反馈给夙锦）；另外有一段时间小太阳系统也无法获取配置影响人工出票效率。\n\n1. CA无法批量换渠道（很多票是星花码运价），无法批量换渠道的只能转人工（人工出票走小太阳系统）；\n2. 批量换渠道出票能力不支持特殊票换特殊票\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/4505/1723514300118-3dd28512-d1b1-4231-863d-31eb8381cca7.png)\n\n2024-08-08 17:19，开发同学收到产品同学反馈，国内国际出票都出现了积压，开发同学通过排查发现：国际出票积压是由于打票机无可用票号导致；国内出票链路的打票机号建控和上票号流程正常；故开发同学反馈产品同学dawn侧出票业务正常。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/59956279/1723440762955-b83ab261-8522-4640-8fb6-4120cb07d084.png)\n\n2024-08-08 18:32，****产品同学与出票护航同学反馈，国际出票是由于2号打票机没票号导致积压，需要联系游保解决\n\n注：国际的打票机配置在小太阳侧，可能存在2种情况：1、配置不可用，导致无法人工上票号。2、配置可用，人工上票号不及时。本次是无配置可用，后续找dawn借用的配置\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/59956279/1723541172840-15878a79-5718-4ff7-a78a-e72c2633cda7.png)\n\n2024-08-08 19:20，产品同学联系自营技术同学，咨询出票报错信息，自营技术回复自开BSP出票成功率在恢复（包含了人工和换渠道成功的订单，实际问题还没解决）\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/59956279/1723541011586-2d7db459-1474-499a-804d-8328cc665a8f.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/59956279/1723541019509-3e063a11-50e1-46f7-9d88-c5533e7272b9.png)\n\n2024-08-08 19:41，****自营技术反馈BSP自动化又降低，同时产品同学检查配置及打票机后，又再次咨询报错原因\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/59956279/1723541124986-4f8150c7-5c47-4838-a057-c8291c53b23b.png)\n\n2024-08-08 21:18，又收到产品同学反馈，国内出票大量积压，建议与自营的开发同学一起沟通沟通，于21",
    "chunk_order_index": 2,
    "full_doc_id": "doc-b0d1bb723d8ed816472947fdc2a4998c"
  },
  "chunk-80248704e22637194e5448085d19e394": {
    "tokens": 1200,
    "content": "咨询报错原因\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/59956279/1723541124986-4f8150c7-5c47-4838-a057-c8291c53b23b.png)\n\n2024-08-08 21:18，又收到产品同学反馈，国内出票大量积压，建议与自营的开发同学一起沟通沟通，于21:20产品同学拉会与自营同学沟通**【故障发现】【业务响应】**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/59956279/1723429281012-f3965980-c814-4840-a982-4c8c8d86ddaf.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/59956279/1723355679442-b23d8d73-ef7d-4178-9654-c591898a8925.png)\n\n2024-08-08 21:39，自营开发同学反馈国内1E渠道出票阻塞点，通过定位后发现，是由于自营侧获取黑屏配置失败，导致出票流程受阻。**【初因定位】**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/59956279/1723355746002-36726adc-4894-4f56-b5b2-49aefbd3799d.png)\n\n2024-08-08 21:41，通过定位发现是由于ateye开关被修改，导致自营侧获取黑屏配置失败。**【根因定位】**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/59956279/1723355987771-cad4ac17-d9c5-48b4-a1d9-560e73117f96.png)\n\n2024-08-08 21:41，修改ateye开关，恢复获取配置的业务。**【恢复执行】【故障恢复】**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/59956279/1723355930353-6e073dde-2904-4517-9d9a-7dfa60b90fa9.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/59956279/1723356080946-650908d0-138a-4d48-a565-7f88f9cb44df.png)2024-08-08 21:41，**【**批量重试】秒忆和袁硕开始执行批量换渠道重试出票。****\n\n2024-08-08 22:30，存量国航PAT*黑屏出票批量重试完成\n\n2024-08-08 23:19，存量儿童单批量重试+忽略利润阈值\n\n2024-08-08 23:54，执行批量换渠道，利润阈值-100\n\n2024-08-09 00:00，0点后批量重试结束，准备执行批量换渠道，利润阈值-100。发现没有效果，定位问题：\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/4505/1723449863425-b41f6a43-0374-464b-8cb5-73513e1dc76d.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/4505/1723449908400-54a92488-ba21-4f4f-99d8-d996735042fe.png)\n\na、22:20发现积压的CA大部分为星花码政策（批量无效，国航这部分至少占了无法出票的40%），现有换渠道只能换到普通货，无法走系统只能转人工\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/4505/1723449794469-6b7181f1-2f6d-4625-951a-74d8d7bb44a4.png)\n\nb、08-09 0点左右，发现另一个问题，进单超过6H的票无法通过批量换渠道重试。原因是依赖引擎的offer缓存（6H），失效后无法获取\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/4505/1723450064114-86ba12f0-7368-42d0-8a6b-f41e9f0bc413.png)\n\n2024-08-09 01:21，清理积压电话会议决策，执行操作：询价成功，利润校验失败，或者出票失败。忽略利润阈值，执行批量重试\n\n2024-08-09 02:00，国内积压剩余1500左右。决策第二天：①出票客服加人 ②批量换渠道offer 6小时限制方案\n\n2024-08-09 09:50，****希储和西秦对焦出票积压问题，提到6H无法重试问题，西秦组织自营侧�",
    "chunk_order_index": 3,
    "full_doc_id": "doc-b0d1bb723d8ed816472947fdc2a4998c"
  },
  "chunk-09c95ef691280c05b6a31a5985143b54": {
    "tokens": 1200,
    "content": "或者出票失败。忽略利润阈值，执行批量重试\n\n2024-08-09 02:00，国内积压剩余1500左右。决策第二天：①出票客服加人 ②批量换渠道offer 6小时限制方案\n\n2024-08-09 09:50，****希储和西秦对焦出票积压问题，提到6H无法重试问题，西秦组织自营侧澄羽袁硕开会对焦解决方案\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/4505/1723450295171-a38521bf-b3b6-49a5-a256-985eab712253.png)\n\n2024-08-09 15:42，翱速发布完成（取行业平台持久化的offer）开始通知秒忆批量重试 \n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/4505/1723450328753-edbe7e86-d32b-4d34-8575-22abbd5bfbc2.png)\n\n2024-08-09 21:10，08-09 要处理8号积压订单****\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/4505/1723450181299-e45f95d2-c7d4-4f22-aec9-b92eca1129fd.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/4505/1723450200941-e8eb4cc1-789a-4243-96dd-edc59353ad7a.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/4505/1723450397135-cc7ca29b-d765-4590-8db3-91c135b39b30.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/4505/1723450420493-6d361175-d266-46b3-beea-98e1d84449b7.png)\n\n2024-08-09 23:57，基本消除故障带来的影响**【影响消除】**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/59956279/1723356327681-3ee4e5e7-7182-4f8d-9807-348e7754b084.png)\n\n## 三、故障原因\n### 3.1【背景说明】\n![](https://intranetproxy.alipay.com/skylark/lark/__puml/58908239fdff9a3efa444fa65b977bbe.svg)\n\n### 3.2【原因分析】\n##### 一句话原因：\n由于技术凌晨4点修改了生产环境的ateye开关，导致自营国内1E渠道出票部分业务(星花码、大客户编码、折扣码(TC码))受阻(影响999张），同时叠加小太阳等航信验证码影响最终造成小二人工出票积压，引发出票资损。\n\n##### 根因分析：\n1、为什么会出现故障？\n\n由于修改了生产环境的ateye开关，接口默认返回false，导致国内1E渠道出票业务受阻，产生了故障。\n\n2、为什么要修改ateye配置？\n\n由于凌晨应用机器多次告警，经过定位后发现是数据库连接池超过限制，产生大量异常，接口RT增加，cpu利用率超过告警阈值，同时黑屏有效配置量过低，为减少数据库连接，决定关闭运价下载任务。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/59956279/1723358025376-fa7bccac-737a-4f66-a29a-73a8cef83952.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/59956279/1723603265466-0030648e-7d9c-4ac6-994c-6f322d35dcc9.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/59956279/1723358127647-5723b7d4-2a33-46bb-b185-3010e0a21657.png)\n\n3、为什么没有及时发现？\n\n    1. 业务链路不熟悉：自营国内1E出票，以office：SHA384为例，国内出票是自营系统调用行业平台系统进行出票，开发同学不了解星花码、大客户编码、折扣码(TC码)业务是调用黑屏获取配置后，在黑屏侧的gdsti渠道（技术链路）出票。\n    2. 代码命名不规范及没有进一步确认开关使用情况：开发同学在凌晨4点修改的ateye开关所属的类名是:NfdConstants，看类名是与nfd任务相关的常量类，没有进一步想到自营获取黑屏侧配置也是用的这个开关。同时开发同学也没有进一步确认ateye开关的使用范围，导致故障发生。\n    3. 业务同学首次反馈出票积压时，开发同学根据业务经验，首先看了国际",
    "chunk_order_index": 4,
    "full_doc_id": "doc-b0d1bb723d8ed816472947fdc2a4998c"
  },
  "chunk-d76cc04f3b463327c1bf0a0c68aa8722": {
    "tokens": 1200,
    "content": "使用情况：开发同学在凌晨4点修改的ateye开关所属的类名是:NfdConstants，看类名是与nfd任务相关的常量类，没有进一步想到自营获取黑屏侧配置也是用的这个开关。同时开发同学也没有进一步确认ateye开关的使用范围，导致故障发生。\n    3. 业务同学首次反馈出票积压时，开发同学根据业务经验，首先看了国际出票接口，发现国际出票接口由于打票机号没有票号（需要人工上票号非系统问题），导致系统出票失败；然后再检查了国内出票业务的打票机号建控及上票号情况，发现打票机号建控正常，且票池票号充足。最后开发同学跟产品同学反馈dawn侧国内国际出票业务正常。\n\n4、为什么系统没有告警？\n\n由于修改了ateye开关，导致业务接口的埋点没有生效，进而系统没有产生业务告警。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/59956279/1723359011687-08d8c1db-d5f7-4637-8cee-6d4d0d76f30f.png)\n\n注：以SHA384为例，出现故障时，调用量基本为0，没有触发已有的告警规则（告警规则跟调用量有关）。\n调用量监控如下：\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/59956279/1723627935052-ef6ae5ae-b8f9-4dc5-83ac-3dd97b036cae.png)\n\n\n\n接口成功率监控如下：\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/59956279/1723627911853-8e6f14be-f3e0-4c7a-9887-b83fe9bb895c.png)\n\n## 四、关注点分析\n**1、修改ateye开关就是一个变更，是否有按照正常的变更流程进行操作，评估变更影响面，通知上下游？**\n\n**问题总结：**未评估到对getEterm接口的影响，误以为只影响运价下载，所以没有做信息同步\n\n**改进点：**详见关注点3\n\n**2、关闭ateye开关后总量应该有下跌，但是为什么没有发现？**\n\n**问题总结：**总量的监控没有配置预警\n\n**3、产品及自营开发多次反馈积压问题，为何迟迟未发现风险？且最后是由产品同学推动发起联合排查会议，出票积压问题是否有明确的SOP流程及紧急问题上升机制？**\n\n**问题总结：**17点后才触达到平台开发，之前聚焦在解决黑屏可用配置数量问题上。\n\n本次出票积压业务问题，一直未引起关注，核心原因：黑屏系统的产技对自营直接使用黑屏通道的内容不够熟悉，导致第一时间并未及时暴露系统问题，且应急过程中缺少一号位\n\n**改进点：**\n\n+ 梳理黑屏开放服务（gdsti/gdsti_tri），当前涉及指令内容&业务范围，具体调用链路&使用场景 [@瀚渺](undefined/hanmiao.lx)[@祁宇](undefined/sl374540) 830\n+ 补齐监控场景（如跌零等），自营出票监控补齐黑屏出票监控\n+ 后续出票业务积压问题袁硕是一号位，思异：服务一号位；星陈：运营一号位\n\n### 4.1【系统质量】\n#### 4.1.1 需求&设计评估\n**〖关注点1〗****是否涉及产品、技术方案评估？此核心的问题是什么，如何改进？**\n\n- [x] **是，涉及**\n    - [ ] 需求评估遗漏\n    - [ ] 产品设计缺陷\n    - [ ] 系统架构设计缺陷\n        - [ ] 容错性不足 \n        - [ ] 单点，无冗余\n        - [ ] 缺乏自我保护\n        - [ ] 缓存设计不当\n        - [ ] 容量评估不足\n        - [ ] 非幂等设计\n        - [x] 强弱依赖不合理\n        - [x] 其他：_________\n- [ ] 否，不涉及\n\n**〖问题总结〗**代码的业务埋点位置和ateye开关的使用不合理：不同的业务共用同一个ateye开关，且业务接口的数据埋点没有在入口时生效。\n\n**〖改进点〗**\n\n1. 不同的业务使用不同的ateye开关 或 尽量减少ateye开关的使用\n2. 所有的业务监控埋点都放到接口入口处\n3. 代码分层：基础的获取配置服务和具体的业务执行服务分开，做好分层监控\n\n#### 4.1.2 代码质量--不涉及\n**〖关注点1〗****是否经过CodeReview？CodeReview阶段是否发现问题？为何没发现？**\n\n+ **是否经过CR**\n    - [",
    "chunk_order_index": 5,
    "full_doc_id": "doc-b0d1bb723d8ed816472947fdc2a4998c"
  },
  "chunk-2878b504a7a41b6e1d7efa75e32d65b0": {
    "tokens": 1200,
    "content": "ateye开关的使用\n2. 所有的业务监控埋点都放到接口入口处\n3. 代码分层：基础的获取配置服务和具体的业务执行服务分开，做好分层监控\n\n#### 4.1.2 代码质量--不涉及\n**〖关注点1〗****是否经过CodeReview？CodeReview阶段是否发现问题？为何没发现？**\n\n+ **是否经过CR**\n    - [ ] 是\n    - [ ] 否\n    - [x] 不涉及\n+ **是否设置合理的CR卡点**\n    - [ ] 是\n    - [ ] 否\n    - [x] 不涉及\n+ **CodeReview阶段是否发现问题？为何没发现？后续如何发现？**\n    - [ ] 是\n    - [ ] 否\n    - [x] 不涉及\n\n\n\n**〖关注点2〗****测试阶段**\n\n+ **测试内容：**涉及的测试提交单、测试用例等\n+ **测试人员：**\n+ **是否经过测试验证**\n    - [ ] 是，验证环境\n        - [ ] 预发环境\n        - [ ] 日常环境\n    - [ ] 是，测试方法\n        - [ ] 单元测试\n        - [ ] 功能回归测试\n        - [ ] 集成测试/链路测试\n        - [ ] 验收测试\n    - [ ] 否\n    - [x] 不涉及\n+ **测试未发现原因是什么？后续如何改进？**\n    - [ ] 回归测试遗漏\n        - [ ] 手工回归测试用例遗漏\n        - [ ] 自动化未建设\n        - [ ] 自动化回归覆盖不足\n        - [ ] 其他：__________\n    - [ ] 新场景测试遗漏\n        - [ ] 功能测试用例遗漏，包括正常分支和异常分支\n        - [ ] 容灾兜底测试遗漏\n        - [ ] 客户端兼容性测试遗漏\n        - [ ] 埋点测试遗漏\n        - [ ] 性能测试遗漏，影响评估不足\n        - [ ] 安全测试遗漏\n    - [ ] 其他：__________\n\n#### 4.1.3 变更质量\n+ **是否涉及变更：**\n    - [x] 是\n    - [ ] 否\n+ **变更类型：**\n    - [ ] 代码发布\n    - [ ] 配置变更\n    - [x] 其他变更：ateye开关修改\n    - [ ] 不涉及\n+ **变更平台是否接入ChangeFree：**\n    - [ ] 是，CF变更单链接：________\n    - [x] 否\n+ **是否违反变更红线3.1**** **[链接](https://aliyuque.antfin.com/trecs/fzg6dy/uar1k6)\n    - [ ] 是，违反哪条原则：\n    - [x] 否\n\n\n\n**〖关注点1〗****灰度阶段**\n\n+ **是否经过灰度：**\n    - [ ] 是\n    - [x] 否\n+ **观测了哪些监控**：_可以附链接_\n    - [ ] 黑屏、白屏\n    - [ ] GOC监控：\n    - [ ] 系统大盘：\n    - [x] 其他：ateye异常监控\n+ **是否灰度期间发现问题？**\n    - [ ] 是\n        - [ ] 是否灰度流量过大，导致故障\n        - [ ] 灰度发现但未有效或及时修复，导致故障\n        - [ ] 其他：___________\n    - [x] 否，后续如何灰度发现？__ateye开关批量执行，后续通过完善监控发现__\n+ **未灰度发现原因**\n    - [ ] 应用灰\n        - [ ] 灰度流量太小\n        - [ ] 灰度阶段无监控\n        - [ ] 灰度批次不合理\n        - [ ] 超长时间灰度才能发现\n    - [ ] 业务灰：策略不合理\n    - [x] 灰度无法发现\n    - [ ] 其他：_____________\n\n### 4.2【处置能力】\n#### 4.2.1 故障发现&响应\n+ **是否监控发现**\n    - [ ] 故障触发方 监控发现\n    - [ ] 故障受影响方 监控发现\n    - [x] 否，原因为：监控无效，由人工发现业务积压进行反馈\n+ **是否5分钟内响应**\n    - [ ] 是\n    - [x] 否，原因为：业务反馈信息不充分、开发链路不熟悉\n+ **是否存在应急协同问题**\n    - [ ] 是\n        - [x] 应急流程不明确（无流程或者流程不清晰、应急相关角色&职责不明确，缺失一号位等)\n        - [ ] 应急执行不到位（有流程，但未按流程执行，通告发送不及时，响应不及时等）\n    - [ ] 否\n\n**〖问题总结〗**故障响应不及时，缺少应急相关角色(开发同学），故障发生前期，只有服务小二及业务同学进行跟踪，无开发沟通\n\n**〖改进点〗**_****",
    "chunk_order_index": 6,
    "full_doc_id": "doc-b0d1bb723d8ed816472947fdc2a4998c"
  },
  "chunk-f107c117af7694e97cfe39036dc5fdbd": {
    "tokens": 1188,
    "content": "，缺失一号位等)\n        - [ ] 应急执行不到位（有流程，但未按流程执行，通告发送不及时，响应不及时等）\n    - [ ] 否\n\n**〖问题总结〗**故障响应不及时，缺少应急相关角色(开发同学），故障发生前期，只有服务小二及业务同学进行跟踪，无开发沟通\n\n**〖改进点〗**_****_\n\n1、如果有问题，需要及时反馈相关信息，特别是具体的问题订单\n\n2、出现问题后，及时拉群沟通，并找到相关负责同学（业务、运营、产品、开发、服务同学）进一步定位，明确出现问题的原因。\n\n#### 4.2.2 故障定位&恢复\n+ **主要恢复方式：**\n    - [ ] 代码发布/回滚\n    - [ ] 配置发布/回滚\n    - [ ] 数据订正\n    - [ ] 机器隔离/重启/扩容\n    - [ ] 配置限流\n    - [ ] 预案降级\n    - [ ] 自动恢复\n    - [x] 其他：ateye开关修改\n\n**〖关注点1〗定位&恢复阶段存在什么问题？是否可以增加预案，****有更快的恢复方式？****相关的优化改进？**\n\n**〖问题总结〗**在定位阶段，缺少具体的case进行定位，同时也缺少相关同学进行沟通\n\n**〖改进点〗**\n\n1、收到问题反馈时，进一步咨询问题现象及问题订单，方便进一步定位\n2、涉及多域时，及时拉群沟通\n\n## 五、故障Action\n| **序号** | *******Action** | *******负责人** | *******计划完成时间** | **验收人** | **是否keyAction** |\n| :---: | --- | --- | :---: | --- | :---: |\n| 1 | 短期：和财务[@亚云](undefined/taoyayun.tyy)对焦具体的资金金额--8.21结论：已和财务对焦，按技术的口径为准。 | [@西秦](undefined/taowang.wt)done | 08.23 | **** | **** |\n| 2 | 短期：梳理黑屏开放服务（gdsti/gdsti_tri），当前涉及指令内容&业务范围，具体调用链路&使用场景 | [@瀚渺](undefined/hanmiao.lx)[@祁宇](undefined/sl374540) | 08.30 | [@路衍](undefined/luyan.cl) |  |\n| 3 | 短期：梳理现有黑屏系统监控埋点逻辑，避免后续代码改动，导致监控埋点缺失，不能有效预警。同时也需要做好分层监控：基础的配置管理监控和具体业务监控。(本次线上开关改动，影响代码分支流程，导致埋点失效，该服务预警完全失效) | [@瀚渺](undefined/hanmiao.lx)[@祁宇](undefined/sl374540) | 08.30 | [@路衍](undefined/luyan.cl) |  |\n| 4 | 短期：行业平台：扩展监控预警能力，增加新增错误码预警机制(本次线上开关改动，会导致服务出现新错误码， 增加新错误码预警机制，能够有效发现此类问题)自营：+ 增加出票积压单量监控和预警+ 明确出票积压单量的故障预警和GOC故障等级 | [@瀚渺](undefined/hanmiao.lx)[@祁宇](undefined/sl374540)[@石页](undefined/shiye.ys) | 08.30 | [@路衍](undefined/luyan.cl) | 是 |\n| 5 | 长期：PATA*等特殊政策是否只能通过黑屏出票，IBE+目前无法支持自动出票，需要推动航信![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/4505/1723518611904-1b09d6ed-ba9c-441b-8a5d-d264c13c58e6.png) | [@希储](undefined/nathaniel.pk) | 8.23完成沟通 | [@路衍](undefined/luyan.cl) |  |\n| 6 | 和客服、运营、产品技术一起明确一套清晰可执行的SOP预案+ 明确的积压量/资损对应的action（故障预案）+ 在执行批量换渠道后，给出明确的亏损预估，以供运营决策。（故障中资损评估）+ 自营批量换渠道功能日常演练机制（日常需求的核心case回归；换渠道测试场景覆盖；批量换渠道、人工换渠道、商家兜底换渠道场景统一；定期故障预演） | [@希储](undefined/nathaniel.pk)[@石页](undefined/shiye.ys)[@西秦](undefined/taowang.wt) | 08.30 |  | 是 |",
    "chunk_order_index": 7,
    "full_doc_id": "doc-b0d1bb723d8ed816472947fdc2a4998c"
  },
  "chunk-05baf3e943c897fb41e4619fed3b8d96": {
    "tokens": 88,
    "content": "（日常需求的核心case回归；换渠道测试场景覆盖；批量换渠道、人工换渠道、商家兜底换渠道场景统一；定期故障预演） | [@希储](undefined/nathaniel.pk)[@石页](undefined/shiye.ys)[@西秦](undefined/taowang.wt) | 08.30 |  | 是 |",
    "chunk_order_index": 8,
    "full_doc_id": "doc-b0d1bb723d8ed816472947fdc2a4998c"
  },
  "chunk-f21bbe2f9897350aca042276b884a1e4": {
    "tokens": 1200,
    "content": "## 一、故障概述（含影响产品线及影响面）\n##### 故障概述：\n2024年6月2日 17:12开始，飞猪度假线路商品(785314463603)渲染订单异常，失败量最近10分钟最小值大于等于10，成功率最近10分钟最大值小于等于70%，影响用户下单。故障原因初步确认是单品被拦截导致，于17:49分通过添加解禁标后完成止血，故障恢复。\n\n##### 影响面：\n- [x] 是否影响可用性：_**否  **_\n- [x] 业务影响：\n+ 该商品785314463603，所有订单615单，退款成功574\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/31070/1717581746878-da0490fa-bb48-4be1-accc-439e8115dae9.png)![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/31070/1717581757073-122e725f-5c69-475b-a6a7-20841e831b19.png)\n\n+ 当天的渲染失败数据，总量的失败数和单品的失败数一致，\n\n单品报错：[https://x.alibaba-inc.com/custom/59/product/preview/multiMinute/4401?customStartTime=1717319460000&customEndTime=1717319940000](https://x.alibaba-inc.com/custom/59/product/preview/multiMinute/4401?customStartTime=1717319460000&customEndTime=1717319940000)\n\n总量及失败总数：[https://x.alibaba-inc.com/custom/59/product/preview/spm/7480?customStartTime=1717319340000&customEndTime=1717319760000](https://x.alibaba-inc.com/custom/59/product/preview/spm/7480?customStartTime=1717319340000&customEndTime=1717319760000)\n\n问题单品失败量：\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/104956325/1717572408951-7b9a6ba2-b9e1-4436-aa4c-43e2ac32e701.png)\n\n失败总量：\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/104956325/1717572416321-6096b0c1-2509-43e4-a843-aec41fd8d6a7.png)\n\n+ ![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/31070/1717416751222-3f4513cd-f786-4af2-bcd1-cf632ca8476c.png)\n- [x] 是否有客诉：_**否  **_\n- [x] 是否有社会舆情_：__**否 **___\n- [x] 是否产生资损：_**否 **___\n\n## 二、故障过程回顾\n##### 故障时间线：\n2024-06-02 17:12，17:12开始，交易成功率开始下跌，低于70%。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/41240/1717666928352-d344bacd-912c-4230-ba6a-00f4892316c6.png)\n\n2024-06-02 17:16，【**故障发现**】_** **_飞猪度假线路_渲染订单异常场景触发风险预警单_**，**_goc拉[@葵因](undefined/kuiyin.wc)排查。\n\n2024-06-02 17:18，【**拉起钉钉视频会议**】[@葵因](undefined/kuiyin.wc)拉[@枫日](undefined/fengri.wl)处理，枫日联系产品吴宣处理。\n\n2024-06-02 17:21，【**故障发生**】**【初因定位】**初步判断单品拦截，正在联系业务同学确认是否为正常拦截，同时由于失败量最近10分钟最小值大于等于10，成功率最近10分钟最大值小于等于70%，满足P3故障等级定义，触发故障通告。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/31070/1717408296293-db115e79-2923-49fe-8f64-7019c235c435.png)\n\n2024-06-02 17:35，**【初步处理】**决定先止损，联系[@止之](undefined/jiangshuhua.jiangs)下架。由于系统拦截，下架失败；联系翕川定位原因\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/112656370/1717415676469-eca679cc-f8b3-482d-a803-22c556995d88.png)\n\n2024-06-02 17:39，**【定位问题】**[@葵因](undefined/kuiyin.wc)与新西兰785082319594正常品对比",
    "chunk_order_index": 0,
    "full_doc_id": "doc-9e38b4d8b24db12bad4fee1c728ac8be"
  },
  "chunk-8b440510fe2af1232730369e83a4da72": {
    "tokens": 1200,
    "content": "翕川定位原因\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/112656370/1717415676469-eca679cc-f8b3-482d-a803-22c556995d88.png)\n\n2024-06-02 17:39，**【定位问题】**[@葵因](undefined/kuiyin.wc)与新西兰785082319594正常品对比，判断为缺失解禁标：2512962\n\n2024-06-02 17:49，**【故障恢复】**泥洹打上2512962标，问题恢复\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/112656370/1717415910965-1a2d62f5-c878-45aa-88d5-bb5f290ee580.png)\n\n## 三、故障原因\n### 3.1【背景说明】\n**【需求背景】**\n\n[出境线路商品分目的地解除交易拦截](https://aliyuque.antfin.com/lebiic/mxuh6n/os46mzp8tdxwv1cr?singleDoc#)\n\n**【调用链路图】**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/202005/1717736237707-d416ca48-cc6f-4a59-9954-f02930062595.png)\n\n### 3.2【原因分析】\n##### 一句话原因：\n按规则原本应打解禁标（2512962）的可正常售卖商品（785314463603）未打标，导致其下单渲染异常。\n\n##### 根因分析：\n1、调用travelitems打标，遇到IC锁冲突导致打标失败；\n2、问题商品（785314463603）4.18新发时即无解禁标（有问题），因618直播导致访问量加大，触发监控报警；\n\n3、sop流程的问题：问题商品没有报直播保障流程，技术未参与保障。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/112656370/1717418089180-de15c7ca-fadc-47ee-9424-04ec3b053fde.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/112656370/1717418003670-d243efbd-740d-42f2-b703-ce49f195cf72.png)\n\nvacation-pricecenter 与 travelitems 并发编辑时，造成了写ic的锁竞争，导致打标失败；具体打标代码如下图：\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/112656370/1717418356923-1913c923-785d-46a6-99ec-a16283afeb66.png)\n\n## 四、关注点分析\n### 4.1【系统质量】\n#### 4.1.1 需求&设计评估\n**〖关注点1〗****是否涉及产品、技术方案评估？此核心的问题是什么，如何改进？**\n\n- [x] **是，涉及**\n    - [ ] 需求评估遗漏\n    - [ ] 产品设计缺陷\n    - [x] 系统架构设计缺陷\n        - [ ] 容错性不足 \n        - [ ] 单点，无冗余\n        - [ ] 缺乏自我保护\n        - [ ] 缓存设计不当\n        - [ ] 容量评估不足\n        - [ ] 非幂等设计\n        - [ ] 强弱依赖不合理\n        - [x] 其他：IC锁冲突\n- [ ] 否，不涉及\n\n**〖问题总结〗 **\n\n【方案设计】  \n关注点1：需求看是2023年疫情放开政策，当前业务和产品上是否仍然需要白名单解禁标？---带回去和业务方讨论。  \n【系统架构】  \n关注点2：travelitems和vacation-pricecenter并发编辑出现ic锁竞争，travelitems和vacation-pricecenter的写入ic是否都需要补充重试机制？\n\n**〖改进点〗**\n\n1. 锁的颗粒度和长度的问题容易导致冲突，目前已在进行分析，期望可以降低锁冲突的概率。[@翕川](undefined/shixinghui.sxh)_** **_[@幸胡](undefined/xinghu.hxw)_** **_6.20\n2. 解禁标相关接口成功率报警细化 [@翕川](undefined/shixinghui.sxh)_** **_[@幸胡](undefined/xinghu.hxw)_** **_6.20\n3. 调用方打标重试逻辑 + 告警配置 [@止之](undefined/jiangshuhua.jiangs) 6.3 done\n\n#### 4.1.2 代码质量\n**〖关注点1〗是否代码自身存在漏洞或BUG、代码健壮性是否存在问题等?**\n\n**〖问题分析〗**代码存在问题，但上线很久了非现任维护团队所写，已无法追溯\n\n\n\n**〖关注点2〗****是否经过CodeReview？CodeReview阶段是否发现问题？为何没发现？**\n\n+ **是否经过",
    "chunk_order_index": 1,
    "full_doc_id": "doc-9e38b4d8b24db12bad4fee1c728ac8be"
  },
  "chunk-216e874ab81d323409c98890bb885dbb": {
    "tokens": 1200,
    "content": "6.3 done\n\n#### 4.1.2 代码质量\n**〖关注点1〗是否代码自身存在漏洞或BUG、代码健壮性是否存在问题等?**\n\n**〖问题分析〗**代码存在问题，但上线很久了非现任维护团队所写，已无法追溯\n\n\n\n**〖关注点2〗****是否经过CodeReview？CodeReview阶段是否发现问题？为何没发现？**\n\n+ **是否经过CR**\n    - [ ] 是\n    - [ ] 否\n    - [ ] 不涉及\n+ **是否设置合理的CR卡点**\n    - [ ] 是\n    - [ ] 否\n    - [ ] 不涉及\n+ **CodeReview阶段是否发现问题？为何没发现？后续如何发现？**\n    - [ ] 是\n    - [ ] 否\n    - [ ] 不涉及\n\n**〖问题分析〗**代码存在问题，但上线很久了非现任维护团队所写，已无法追溯\n\n\n\n**〖关注点3〗****测试阶段**\n\n+ **测试内容：**2023年01月份的需求，当时的测试人员：文须已离职，能找到具体的测试文档。\n1. PRD：[https://aliyuque.antfin.com/lebiic/mxuh6n/os46mzp8tdxwv1cr?singleDoc#](https://aliyuque.antfin.com/lebiic/mxuh6n/os46mzp8tdxwv1cr?singleDoc#)\n2. 测试文档：[https://aliyuque.antfin.com/aone629225/tw36a9/fi6fwqaqkh5mbaep?singleDoc#](https://aliyuque.antfin.com/lebiic/mxuh6n/os46mzp8tdxwv1cr?singleDoc#) 《2023-01-21 境外开放需求》。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/31070/1717419091408-e52b1f8e-3b77-4d3f-a80a-4ab96d810d01.png)\n\n+ [https://itemtools.taobao.com/item/search?itemId=695094963194&qryText=&searchFrom=0](https://itemtools.taobao.com/item/search?itemId=695094963194&qryText=&searchFrom=0)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/31070/1717419129147-c7109053-b731-438d-a268-e2b520a1c3a3.png)\n\n+ **测试人员：**文须\n+ **是否经过测试验证**\n    - [x] 是，验证环境\n        - [x] 预发环境\n        - [ ] 日常环境\n    - [x] 是，测试方法\n        - [ ] 单元测试\n        - [x] 功能回归测试\n        - [x] 集成测试/链路测试\n        - [x] 验收测试\n    - [ ] 否\n    - [ ] 不涉及\n+ **测试未发现原因是什么？后续如何改进？**\n    - [ ] 回归测试遗漏\n        - [ ] 手工回归测试用例遗漏\n        - [ ] 自动化未建设\n        - [ ] 自动化回归覆盖不足\n        - [ ] 其他：__________\n    - [ ] 新场景测试遗漏\n        - [ ] 功能测试用例遗漏，包括正常分支和异常分支\n        - [ ] 容灾兜底测试遗漏\n        - [ ] 客户端兼容性测试遗漏\n        - [ ] 埋点测试遗漏\n        - [ ] 性能测试遗漏，影响评估不足\n        - [ ] 安全测试遗漏\n    - [x] 其他：_这个属于偶现问题，代码逻辑中发布完商品再打ictag“2512962”，没有处理打标失败的逻辑。理论上从技术方案设计和代码CR上更能发现问题。__\n\n**〖问题总结〗**\n\n+ 直播商品保障SOP阶段：未严格按照直播商品保障的SOP流程处理\n+ 技术方案评审阶段：未考虑到异常失败逻辑的处理，是否有兜底逻辑\n+ 代码CR阶段：未关注异常失败逻辑的处理，是否严谨\n+ 测试方案/测试用例设计阶段：未考虑异常场景，去增加异常场景的用例，并考虑商品标的巡检监控\n\n**〖改进点〗**_****_\n\n+ **直播商品的质量保障已有SOP流程，业务需按照**[**SOP流程**](https://aliyuque.antfin.com/aone629225/qkozc5/ozuvupgax4n7srqk?singleDoc#)**提报直播商品，联合研发、测试共同保障，目前已加强向业务方的宣导。**\n+ 技术方案评审时，需要重点关注异常失败逻辑的处理，是否有兜底逻辑\n+ 代码CR时，需要重点关注异常失败逻辑的处理，是否严谨\n+ 测试方案/测试用例设计时，考虑异常场景，去增加异常场景的用例\n+ 针对本次问题标【2512962】实施商品巡检监控（存量已巡检），截止时间630 [@",
    "chunk_order_index": 2,
    "full_doc_id": "doc-9e38b4d8b24db12bad4fee1c728ac8be"
  },
  "chunk-92da7a643e85e14108d533cd62133d8b": {
    "tokens": 1200,
    "content": "技术方案评审时，需要重点关注异常失败逻辑的处理，是否有兜底逻辑\n+ 代码CR时，需要重点关注异常失败逻辑的处理，是否严谨\n+ 测试方案/测试用例设计时，考虑异常场景，去增加异常场景的用例\n+ 针对本次问题标【2512962】实施商品巡检监控（存量已巡检），截止时间630 [@慎守](undefined/chetao.ct)\n\n#### 4.1.3 变更质量--上线很久了已无法追溯\n+ **是否涉及变更：**\n    - [ ] 是\n    - [x] 否\n+ **变更类型：**\n    - [ ] 代码发布\n    - [ ] 配置变更\n    - [ ] 其他变更：____________\n    - [x] 不涉及\n+ **变更平台是否接入ChangeFree：**\n    - [ ] 是，CF变更单链接：________\n\n_/*要这样的链接_ [https://aicf.alibaba-inc.com/aicf/change/detail/1725370372](https://aicf.alibaba-inc.com/aicf/change/detail/1725370372) */\n\n    - [x] 否\n+ **是否违反变更红线3.1**** **[链接](https://aliyuque.antfin.com/ngoc/fzg6dy/uar1k6)\n    - [ ] 是，违反哪条原则：\n    - [x] 否\n\n\n\n**〖关注点1〗****灰度阶段**\n\n+ **是否经过灰度：**\n    - [ ] 是\n    - [ ] 否\n+ **观测了哪些监控**：_可以附链接_\n    - [ ] 黑屏、白屏\n    - [ ] GOC监控：\n    - [ ] 系统大盘：\n    - [ ] 其他：___________\n+ **是否灰度期间发现问题？**\n    - [ ] 是\n        - [ ] 是否灰度流量过大，导致故障\n        - [ ] 灰度发现但未有效或及时修复，导致故障\n        - [ ] 其他：___________\n    - [ ] 否，后续如何灰度发现？_____________\n+ **未灰度发现原因**\n    - [ ] 应用灰\n        - [ ] 灰度流量太小\n        - [ ] 灰度阶段无监控\n        - [ ] 灰度批次不合理\n        - [ ] 超长时间灰度才能发现\n    - [ ] 业务灰：策略不合理\n    - [ ] 灰度无法发现\t\n    - [ ] 其他：_____________\n\n**〖问题总结〗**\n\n**〖改进点〗**_**需明确写明不同故障相关方的改进项（若有的话），下同。**_\n\n\n\n**〖关注点2〗****上线阶段**\n\n+ **是否有确定的监控观测指标**\n    - [ ] 是，监控指标及监控链接：\n    - [ ] 否\n+ **是否在窗口期进行发布变更**\n    - [ ] 是\n    - [ ] 否，原因：\n+ **变更是否影响上下游**\n    - [ ] 是，是否有提前知会上下游评估及关注变更\n        - [ ] 有提前知会\n        - [ ] 没有提前知会\n    - [ ] 否\n\n**〖问题总结〗**\n\n**〖改进点〗**_**需明确写明不同故障相关方的改进项（若有的话），下同。**_\n\n### 4.2【处置能力】\n#### 4.2.1 故障发现&响应\n+ **是否监控发现**\n    - [ ] 故障触发方 监控发现\n    - [x] 故障受影响方 监控发现\n    - [ ] 否，原因为：（监控无效/监控缺失）\n+ **是否5分钟内响应**\n    - [x] 是\n    - [ ] 否，原因为：\n+ **是否存在应急协同问题**\n    - [ ] 是\n        - [ ] 应急流程不明确（无流程或者流程不清晰、应急相关角色&职责不明确，缺失一号位等)\n        - [ ] 应急执行不到位（有流程，但未按流程执行，通告发送不及时，响应不及时等）\n    - [x] 否\n\n**〖问题总结〗**\n\n关注点1：商品上线到故障当日线上一直存在订单渲染的异常，现在看有什么办法提前发现？订单渲染的错误是否可按错误码分析处理，以及是否有日常此类异常的处理流程？（如将监控结果接入风险预警或接入工单）  \n关注点2：本次需要补充或者优化的监控有哪些？\n\n**〖改进点〗**\n\n①订单渲染错误码监控：度假行业细分，带回去和交易同学讨论。[@奇虎](undefined/qianming.mqm) 6.30 给出结论  \n②ic写入接口监控：  \n③vacation-pricecenter调用ic接口监控：  \n④travelitems调用ic接口监控：  \n\n_**②-④放到长期治理计划里去。**_\n\n#### 4.2.2 故障定位&恢复\n+ **",
    "chunk_order_index": 3,
    "full_doc_id": "doc-9e38b4d8b24db12bad4fee1c728ac8be"
  },
  "chunk-a70f68881b7042355bcc9252a13a4cab": {
    "tokens": 837,
    "content": "监控：度假行业细分，带回去和交易同学讨论。[@奇虎](undefined/qianming.mqm) 6.30 给出结论  \n②ic写入接口监控：  \n③vacation-pricecenter调用ic接口监控：  \n④travelitems调用ic接口监控：  \n\n_**②-④放到长期治理计划里去。**_\n\n#### 4.2.2 故障定位&恢复\n+ **主要恢复方式：**\n    - [ ] 代码发布/回滚\n    - [ ] 配置发布/回滚\n    - [ ] 数据订正\n    - [ ] 机器隔离/重启/扩容\n    - [ ] 配置限流\n    - [ ] 预案降级\n    - [ ] 自动恢复\n    - [x] 其他：加解禁标\n\n**〖关注点1〗定位&恢复阶段存在什么问题？是否可以增加预案，****有更快的恢复方式？****相关的优化改进？**\n\n**〖问题总结〗**定位时长18分钟，应急沟通时有gap，如果能第一时间知道商品拦截页面的文案，可以加快定位的速度。\n\n**〖改进点〗**在不知道拦截原因的情况下定位速度符合预期，恢复阶段需要有打标的权限，目前打标权限已收回到对应团队，QA需要权限的把名单提供给[@翕川](undefined/shixinghui.sxh)。\n\n## 五、故障Action\n| **序号** | *******Action** | *******负责人** | *******计划完成时间** | **验收标准** | **验收人** | **是否keyAction** |\n| :---: | --- | --- | :---: | :---: | :---: | --- |\n| 1 | 短期：打标重试逻辑 + 报警 | [@止之](undefined/jiangshuhua.jiangs) | 6.3 | 代码上线 | 大改 |  |\n| 2 | 短期：针对影响面覆盖的类目已经在架的商品，进行人工数据订正（手工加上解禁标） | [@启年](undefined/caidawei.cdw) | 6.3 | 数据订正 |  |  |\n| 3 | 针对本次问题标【2512962】实施商品巡检监控 | [@慎守](undefined/chetao.ct) | 6.30 |  |  |  |\n| 4 | 短期：解禁标相关接口成功率报警细化 | [@翕川](undefined/shixinghui.sxh)[@幸胡](undefined/xinghu.hxw) | 6.20 |  |  |  |\n| 5 | 短期：商品侧解决ic锁冲突（主要是协调调用方调整调用时序，尽量不要并发调用） | [@星移](undefined/xuefei.zhangxf)[@翕川](undefined/shixinghui.sxh)[@幸胡](undefined/xinghu.hxw) | 6.20 |  |  | 是 |\n| 6 | 度假行业订单渲染错误码监控细分 | [@奇虎](undefined/qianming.mqm) | 6.30 |  |  |  |\n\n\n## 六、故障定级&定责\n**【故障等级】P5**\n\n定级原因：业务未走直播保障SOP流程，且出问题的当下是直播试跑阶段，业务判断真实流量极少，实际基本无业务影响。\n\n**【故障责任方】**飞猪技术部-度假行业研发中心-行业平台-商品平台\n\n**【故障责任人】**星移",
    "chunk_order_index": 4,
    "full_doc_id": "doc-9e38b4d8b24db12bad4fee1c728ac8be"
  },
  "chunk-44ebf0b92a8eb3980cd5b248071b48d1": {
    "tokens": 1200,
    "content": "## 一、故障概述（含影响产品线及影响面）\n##### 故障概述：\n2024年6月4日10:59开始，人群匹配接口异常成功率下跌，成功率最近10分钟最大值<=80%，失败量最近10分钟最小值>=140000，影响批量人群匹配结果，故障原因初步确认是单个人群圈人规则为空，导致线上匹配接口报错，于11:29分恢复人群圈人规则后故障恢复，期间无C端客诉，酒店确认有房订单量下跌，达P4故障等级。\n\n##### 影响面：\n- [x] 是否影响可用性：_**否  **_\n- [x] 业务影响：\n\n原本应该享有优住会和出行特惠的用户在酒店详情页看不到相关优惠信息，从而导致酒店下单量减少，确认有房订单量同比前一日下跌28.73%，同时引发BD集中反馈70+。\n\n问题从10:40开始，10:59发现，11:29恢复。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/41240/1717757579593-b5423455-577f-491d-a22b-ebf9f5c585a6.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/17675/1717504918404-69806739-c096-453b-96b6-73b0fbf85d46.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/17675/1717504936612-b99e7065-dc41-448d-a0fe-ee540985381d.png)![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/17675/1717504956518-22d2165a-b2e2-4e6a-b10d-f8bd2ec118b1.png)\n\n- [x] 是否有客诉：_**  否**_\n- [x] 是否有社会舆情_：__**否 **___\n- [x] 是否产生资损：_**否 **___\n\n## 二、故障过程回顾\n2024-06-04 10:38，业务针对人群103581进行转交人群创建人**【风险注入】**\n\n2024-06-04 10:40，诸葛批量匹配接口成功率开始下跌****\n\n2024-06-04 10:48，飞猪酒店订单确认有房异常触发风险预警\n\n2024-06-04 11:01，人群匹配接口异常触发风险预警**【故障发现】**\n\n2024-06-04 11:06，tripps和hse1调用量上涨，初步排查怀疑是限流导致，更新限流配置和应用实施机器扩容操作****\n\n2024-06-04 11:09，10:59-11:09人群匹配接口成功率持续<80%**【故障发生】**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/41240/1717657842323-73469382-f23b-4571-9335-7e3b5cb5cc91.png)\n\n2024-06-04 11:10，报错从错误采样日志中发现问题原因，某个人群的圈人规则异常**【初因定位】**![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/17675/1717502413090-749c4205-41ee-4164-8311-6f84caef0ce7.png)\n2024-06-04 11:25，遍历了告警的人群未发现异常，继续向上寻找组合圈人中参与组合的人群，定位到错误人群id-103581**【根因定位】**\n\n2024-06-04 11:28，过期人群103581**【恢复执行】**\n\n2024-06-04 11:29，恢复人群103581的圈人规则和人群生效时间**【故障恢复】**\n\n## 三、故障原因\n### 3.1【背景说明】\n为了平台稳定性开发了一个预案功能，支持将人群的匹配方式从规则匹配调整为快照匹配\n\n+ 规则匹配：在线查询人群的圈人规则、用户的标签值，进行逻辑运算\n+ 快照匹配：将人群规则离线计算后转为一组人群id(snapshot)，并上传到lindorm用于判断某个id是否在snapshot中\n\n规则匹配在某些标签值查询异常(如用户画像为空)时会出现大面积匹配失败(接口返回成功，但因为查不到用户标签值导致匹配不到)，此时如果转换人群匹配方式重新执行一轮圈选逻辑后可快速恢复该人群的匹配\n\n### 3.2【原因分析】\n**一句话原因：**后台转交操作会导致圈人规则丢失，批量人群匹配时单人群异常导致整个批量匹配失败\n\n**根因分析：**\n\n1、后台人群转交功能，没有正确处理",
    "chunk_order_index": 0,
    "full_doc_id": "doc-93cbe3ce9ba3f9151b2f0a8889d08e20"
  },
  "chunk-fb2998373a2bef8a6bdfcf04a1374a7a": {
    "tokens": 1200,
    "content": "用户标签值导致匹配不到)，此时如果转换人群匹配方式重新执行一轮圈选逻辑后可快速恢复该人群的匹配\n\n### 3.2【原因分析】\n**一句话原因：**后台转交操作会导致圈人规则丢失，批量人群匹配时单人群异常导致整个批量匹配失败\n\n**根因分析：**\n\n1、后台人群转交功能，没有正确处理null值的DB更新逻辑(应该不更新，实际写了null)，导致人群规则丢失\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/17675/1717568116348-8e069356-aeb2-40b3-8c0f-8353b07770a5.png)\n\n2、批量匹配时，某个人群处理异常，整体匹配抛异常\n\n    - 根据匹配类型进行人群分组：![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/17675/1717578413796-45bd8b93-c372-4318-b2c0-bfd729ebd307.png)![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/17675/1717578293686-590e75c5-1635-4c2a-8f1c-6af7facbb92e.png)\n\n问题人群：99677-人群组合，它由103581、101248两个人群取并集组成\n\n103581是一个实时规则判断人群，此时需要对103581做一次规则匹配\n\n查询用户标签做逻辑判断\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/17675/1717578678214-d10ef639-db5b-4c86-8e7c-9d845189b615.png)\n\n103581因为后台转交bug，人群逻辑为空，找不到标签信息，上抛异常，触发错误\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/17675/1717578202056-540e81ec-4860-4afb-a770-eed1188dfbf5.png)\n\n## 四、关注点分析\n### 4.1【系统质量】\n#### 4.1.1 需求&设计评估\n**〖关注点1〗****是否涉及产品、技术方案评估？此核心的问题是什么，如何改进？**\n\n- [x] **是，涉及**\n    - [ ] 需求评估遗漏\n    - [ ] 产品设计缺陷\n    - [ ] 系统架构设计缺陷\n        - [x] 容错性不足 \n        - [ ] 单点，无冗余\n        - [ ] 缺乏自我保护\n        - [ ] 缓存设计不当\n        - [ ] 容量评估不足\n        - [ ] 非幂等设计\n        - [ ] 强弱依赖不合理\n        - [ ] 其他：__________\n- [ ] 否，不涉及\n\n**〖问题总结〗**代码容错性不足，批量匹配接口单人群处理逻辑报错异常未catch导致整个匹配服务失败。\n\n**〖改进点〗**修改代码逻辑，批量匹配时，单个人群的匹配异常不应该导致整个匹配服务失败。\n\n批量匹配中，单个人群配置异常只影响部分人群；单个人群异常打印日志，单独监控；异常人群打印人群id\n\n[@优比](undefined/zhouxiaoshu.zxs) 6.13\n\n#### 4.1.2 代码质量\n**〖关注点1〗是否代码自身存在漏洞或BUG、代码健壮性是否存在问题等?**\n\n**〖问题分析〗**后台转交代码存在BUG，未正确处理null值不更新\n\n**〖改进点〗**向DB进行值更新时，null值应该不更新。如果确实要更新为null，不应修改通用的update方法对应sql，可以单独列一个方法，从命名上可以明确知道方法的能力。Bug修复已完成  6.6\n\n\n\n**〖关注点2〗****是否经过CodeReview？CodeReview阶段是否发现问题？为何没发现？**\n\n+ **是否经过CR**\n    - [x] 是\n    - [ ] 否\n    - [ ] 不涉及\n+ **是否设置合理的CR卡点**\n    - [x] 是\n    - [ ] 否\n    - [ ] 不涉及\n+ **CodeReview阶段是否发现问题？为何没发现？后续如何发现？**\n    - [ ] 是\n    - [x] 否\n    - [ ] 不涉及\n\n**〖问题分析〗**涉及代码为诸葛后台应用，Review不够细致。\n\n**〖改进点〗**对于每次代码改动应根据改动范围进行评估，底层通用方法变更应在review前说明。后续进行内部案例宣导。\n\n\n\n**〖关注点3〗****测试阶段**\n\n+ **测试内容：**涉及的测试提交单、测试用例等\n+ **测试人员：**\n+ **是否经过测试验证**\n    - [x] 是，验证环境\n        - [x] 预",
    "chunk_order_index": 1,
    "full_doc_id": "doc-93cbe3ce9ba3f9151b2f0a8889d08e20"
  },
  "chunk-3672d65c6e28cd91eefa18c92c377a75": {
    "tokens": 1200,
    "content": "改进点〗**对于每次代码改动应根据改动范围进行评估，底层通用方法变更应在review前说明。后续进行内部案例宣导。\n\n\n\n**〖关注点3〗****测试阶段**\n\n+ **测试内容：**涉及的测试提交单、测试用例等\n+ **测试人员：**\n+ **是否经过测试验证**\n    - [x] 是，验证环境\n        - [x] 预发环境\n        - [ ] 日常环境\n    - [ ] 是，测试方法\n        - [ ] 单元测试\n        - [ ] 功能回归测试\n        - [ ] 集成测试/链路测试\n        - [ ] 验收测试\n    - [ ] 否\n    - [ ] 不涉及\n+ **测试未发现原因是什么？后续如何改进？**\n    - [x] 回归测试遗漏\n        - [x] 手工回归测试用例遗漏\n        - [ ] 自动化未建设\n        - [ ] 自动化回归覆盖不足\n        - [ ] 其他：__________\n    - [ ] 新场景测试遗漏\n        - [ ] 功能测试用例遗漏，包括正常分支和异常分支\n        - [ ] 容灾兜底测试遗漏\n        - [ ] 客户端兼容性测试遗漏\n        - [ ] 埋点测试遗漏\n        - [ ] 性能测试遗漏，影响评估不足\n        - [ ] 安全测试遗漏\n    - [ ] 其他：___\n\n**〖问题总结〗**\n\n+ 诸葛监控升级需求点包含多项内容，详细见：[https://aliyuque.antfin.com/qnwrq9/gkkliw/bsep0shupzbd96tr](https://aliyuque.antfin.com/qnwrq9/gkkliw/bsep0shupzbd96tr)，测试时和开发重点对焦了主链路上的画像调度巡检、圈选波动报警、重点人群紧急恢复功能，未评估到会影响到转交功能\n\n**〖改进点〗**\n\n+ 底层链路改动较大时，测试环节可在测试开始前组织整体cr，重点关注改动的底层方法，根据cr来调整测试覆盖范围。\n+ 后续后台核心链路操作对应的case梳理沉淀对应的自动化用例。[@夙鸢](undefined/suyan.ssy)  6.14\n\n#### 4.1.3 变更质量\n+ **是否涉及变更：**\n    - [x] 是\n    - [ ] 否\n+ **变更类型：**\n    - [x] 代码发布\n    - [ ] 配置变更\n    - [ ] 其他变更：____________\n    - [ ] 不涉及\n+ **变更平台是否接入ChangeFree：**\n    - [x] 是，CF变更单链接：[https://aicf.alibaba-inc.com/aicf/change/v2/detail/903543219?spm=goc-apm.aicf-_changeList.0.0.7c7123887xGGws](https://aicf.alibaba-inc.com/aicf/change/v2/detail/903543219?spm=goc-apm.aicf-_changeList.0.0.7c7123887xGGws)\n    - [ ] 否\n+ **是否违反变更红线3.1**** **[链接](https://aliyuque.antfin.com/ngoc/fzg6dy/uar1k6)\n    - [ ] 是，违反哪条原则：\n    - [x] 否\n\n\n\n**〖关注点1〗****灰度阶段**\n\n+ **是否经过灰度：**\n    - [x] 是\n    - [ ] 否\n+ **观测了哪些监控**：_可以附链接_\n    - [ ] 黑屏、白屏\n    - [ ] GOC监控：\n    - [ ] 系统大盘：\n    - [x] 其他：___常用的圈人操作、圈人执行、线上匹配服务________\n+ **是否灰度期间发现问题？**\n    - [ ] 是\n        - [ ] 是否灰度流量过大，导致故障\n        - [ ] 灰度发现但未有效或及时修复，导致故障\n        - [ ] 其他：___________\n    - [x] 否，后续如何灰度发现？_____________\n+ **未灰度发现原因**\n    - [ ] 应用灰\n        - [ ] 灰度流量太小\n        - [ ] 灰度阶段无监控\n        - [ ] 灰度批次不合理\n        - [ ] 超长时间灰度才能发现\n    - [ ] 业务灰：策略不合理\n    - [x] 灰度无法发现\t\n    - [ ] 其他：_____________\n\n**〖问题总结〗**灰度过程中未使用转交功能无法发现\n\n\n\n**〖关注点2〗****上线阶段**\n\n+ **是否有确定的监控观测指标**\n    - [x] 是，监控指标及监控链接：\n    - [ ] 否\n+ **是否在窗口期进行发布变更**\n    - [x] 是\n    - [ ] 否，原因：\n+ **变更是否影响上下游**\n    - [ ] 是，是否有提前知会上下游评估及关注变",
    "chunk_order_index": 2,
    "full_doc_id": "doc-93cbe3ce9ba3f9151b2f0a8889d08e20"
  },
  "chunk-db422dfdca0a7eb0c9f2720397dd14bf": {
    "tokens": 1200,
    "content": "**〖关注点2〗****上线阶段**\n\n+ **是否有确定的监控观测指标**\n    - [x] 是，监控指标及监控链接：\n    - [ ] 否\n+ **是否在窗口期进行发布变更**\n    - [x] 是\n    - [ ] 否，原因：\n+ **变更是否影响上下游**\n    - [ ] 是，是否有提前知会上下游评估及关注变更\n        - [ ] 有提前知会\n        - [ ] 没有提前知会\n    - [x] 否\n\n**〖问题总结〗**\n\n+ 5.27线上曾收到有批量人群接口报错的反馈，后初步排查定位到单个人群匹配异常批量接口报错bug导致，但单个人群匹配异常的原因当时评估是因为使用了下线标签bug导致，未定位到是因为上述update代码bug导致圈人规则为空，因未找到根因且下线标签本身是一个低频操作，对问题的影响面评估不足，没有及时修复上线，导致了这个故障的发生（[527问题记录文档](https://aliyuque.antfin.com/g/qnwrq9/gkkliw/fbpeg57cwgs2g7kv/collaborator/join?token=kanoxnrITVrgjs4K&source=doc_collaborator# 《2024-05-27-诸葛人群匹配错误》)）。\n\n**〖改进点〗**\n\n+ 组内去制定线上问题分级及定位和修复进度规范，避免此类问题的发生。[@凤栖](undefined/tongxin.ltx) 6.14\n\n### 4.2【处置能力】\n#### 4.2.1 故障发现&响应\n+ **是否监控发现**\n    - [x] 故障触发方 监控发现\n    - [ ] 故障受影响方 监控发现\n    - [ ] 否，原因为：（监控无效/监控缺失）\n+ **是否5分钟内响应**\n    - [x] 是\n    - [ ] 否，原因为：\n+ **是否存在应急协同问题**\n    - [ ] 是\n        - [ ] 应急流程不明确（无流程或者流程不清晰、应急相关角色&职责不明确，缺失一号位等)\n        - [ ] 应急执行不到位（有流程，但未按流程执行，通告发送不及时，响应不及时等）\n    - [x] 否\n\n**〖问题总结〗**\n\n1. 人群标签数据丢失是否可监控？  ---可以监控，制定巡检机制  [@夙鸢](undefined/suyan.ssy)  6.14\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/jpeg/41240/1717725804048-7cd1a8eb-592a-4bc7-a08d-a6cf34944d95.jpeg)\n\n2）故障响应：各监控开始异常到应急响应花费较长时间，触发预警或者通知的规则是否可优化？\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/41240/1717725858180-a3acbd38-80ac-4614-9383-d40762d9e1f0.png)\n\n故障预警在5分钟内响应，但因sunfire监控配置采集时间10分钟一次，持续10分钟告警，导致41分发生的转交操作，一直到11点才故障预警（实际43分成功率就已经跌到90以下）\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/226004/1717588023712-38003c59-01ef-4f4b-9f19-e8f6b616bc39.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/226004/1717588038344-0e4a9290-316b-45fa-b07a-841759a96407.png)\n\n**〖改进点〗**_****_\n\n1. 修改sunfire监控告警配置（检测频次、报警规则：成功率<98%，持续3分钟即预警） [@夙鸢](undefined/suyan.ssy) done  \n2. 日常攻防演练关注告警时效和失败trace采样的问题 [@凤栖](undefined/tongxin.ltx) 6.14\n3. 优惠侧补充关于诸葛接口成功率的告警配置及缓存优化 [@木霄](undefined/zhazhihua.zzh) 6.14\n4. 安全生产团队把故障场景相关的告警规则再排查一遍 [@馬达](undefined/majingda.mjd)  6.14\n\n#### 4.2.2 故障定位&恢复\n+ **主要恢复方式：**\n    - [ ] 代码发布/回滚\n    - [ ] 配置发布/回滚\n    - [x] 数据订正\n    - [ ] 机器隔离/重启/扩容\n    - [ ] 配置限流\n    - [ ] 预案降级",
    "chunk_order_index": 3,
    "full_doc_id": "doc-93cbe3ce9ba3f9151b2f0a8889d08e20"
  },
  "chunk-8c9132ce93737954ced95c26a0445431": {
    "tokens": 990,
    "content": "undefined/majingda.mjd)  6.14\n\n#### 4.2.2 故障定位&恢复\n+ **主要恢复方式：**\n    - [ ] 代码发布/回滚\n    - [ ] 配置发布/回滚\n    - [x] 数据订正\n    - [ ] 机器隔离/重启/扩容\n    - [ ] 配置限流\n    - [ ] 预案降级\n    - [ ] 自动恢复\n    - [ ] 其他：\n\n**〖关注点1〗定位&恢复阶段存在什么问题？是否可以增加预案，****有更快的恢复方式？****相关的优化改进？**\n\n**〖问题总结〗**问题排查效率不够，定位问题耗时偏长，日志信息需要优化。本次定位到问题人群花了15分钟左右，异常人群并非被直接调用，而是某个组合圈人的一部分，现有日志信息中未打印出异常人群id，导致排查难度较大\n\n**〖改进点〗**\n\n1、优化日志打印：\n\n    1. 日志打印包含trace信息，方便在预警单中采集失败trace，从而快速定位问题\n    2. 优化日志打印内容，将出现异常的人群信息打印到日志中。\n\n2、给研发、测试同学加上超管权限，凤栖已加上。 done\n\n## 五、故障Action\n| **序号** | *******Action** | *******负责人** | *******计划完成时间** | **验收人** | **是否keyAction** |\n| :---: | --- | :---: | :---: | --- | --- |\n| 1 | bug修复：后台操作清空圈人规则配置 | 优比 | 6.5 | 夙鸢 |  |\n| 2 | bug修复：批量匹配中，单个人群配置异常只影响部分人群；单个人群异常打印日志，单独监控；异常人群打印人群id | 优比 | 6.13 | 夙鸢 | 是 |\n| 3 | 后台核心链路操作对应的case梳理沉淀对应的自动化用例。 | 夙鸢 | 6.14 |  |  |\n| 4 | 制定线上问题分级、定位和修复进度规范 | 凤栖 | 6.14 |  |  |\n| 5 | 人群标签制定巡检机制 | 夙鸢 | 6.14 |  |  |\n| 6 | 监控：sunfire监控调整，调整检测频率和播报关键信息 | 夙鸢 | 6.7 |  |  |\n| 7 | 失败trace采样 | 凤栖 | 6.14 |  |  |\n| 8 | 优惠侧补充诸葛接口成功率的告警配置及缓存优化 | 木霄 | 6.14 |  |  |\n| 9 | 故障相关告警规则排查 | 馬达 | 6.14 |  |  |\n\n\n## 六、故障总结反思\n**【经验教训】**举一反三，学习，避免踩坑\n\n![画板](https://intranetproxy.alipay.com/skylark/lark/0/2024/jpeg/17675/1717580486206-fa388397-0afb-4ea4-a6ae-5e4075b556a3.jpeg)\n\n故障发生时，系统中其实已经存在很多孔，任何一个孔的解决都能避免故障的发生。就像一个常见的故障例子：上游、业务服务端、客户端都未对某个属性判空导致故障，每个环节都可以给自己不判空做狡辩，但业务损失是实实在在的。\n\n总结：\n\n+ 系统已经存在了许多孔洞：可能还没有出现故障，不代表系统没有孔；不管是前任遗留、还是新引入，只要在自己手上，就要熟悉它并负责到底；\n+ 问题的产生分很多阶段，越靠前解决代价越低，开发应该是一个先紧张后轻松的过程；如果前置阶段没有完成，不要仓促上线。\n+ 最终是技术态度问题：对事情、代码的认真细致程度；对线上问题深挖以及不能容忍的态度；",
    "chunk_order_index": 4,
    "full_doc_id": "doc-93cbe3ce9ba3f9151b2f0a8889d08e20"
  },
  "chunk-09e147285745965eecb5876029a8a389": {
    "tokens": 1200,
    "content": "## 一、故障简述（含影响产品线及影响面）\n##### 故障概述：\n2024年6月20日21:01监控发现商旅_搜索酒店详情接口成功率异常，失败量最近10分钟最小值>=40，成功率最近10分钟最大值<50%，导致阿里商旅_酒店详情页无报价，故障原因初步确认是筛选项配置发布导致，21:12通过配置回滚完成止血，故障恢复。期间未收到客诉，根据监控下跌幅度判定，达P3故障等级。\n\n##### 影响面：\n- [x] 是否影响可用性：否\n- [x] 业务影响：\n+ 系统指标：商旅酒店详情页、api报价详情不可用，成功率下跌至30%，持续12分钟\n+ 用户影响：内部用户使用欢行/外部用户使用阿里商旅-酒店预订进入酒店详情页无报价，预定链路被阻塞\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/75352/1719392556402-7c81d577-0d99-4602-a8ee-9cf5f6d86846.png)\n\n- [x] 是否有客诉：否\n- [x] 是否有社会舆情_：_否\n- [x] 是否产生资损：否\n\n## 二、故障过程回顾\n2024-06-20 21:00，**【风险注入】**[@臻人](undefined/xumingchi.xmc)** **推送diamond配置到线上\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/78656360/1718937894459-4be7b281-8661-44cb-8c67-68b797c931f5.png)\n\n2024-06-20 21:03，**【故障发现】**21:01商旅_搜索酒店详情接口异常情况满足预警规则，21:03 触发风险预警单推送，GOC监控值班拉起风险预警群\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/65956558/1718938752112-d0dbed43-f461-4a80-9f9f-8e0b2da5f328.png)\n\n2024-06-20 21:04，**【业务响应】【初因定位】**[@季绫](undefined/huojiakun.hjk) 定位到 hwsearch应用报错\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/65956558/1718938334704-422a7bad-1eeb-4bf5-a1ac-a343648b73e6.png)\n\n2024-06-20 21:05，商旅侧拉供应链同学[@灵御](undefined/xuchengcheng.cc) 一起定位行业问题\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/65956558/1718938992774-a2b265b4-afa6-436d-9063-8e77c73ca1a4.png)\n\n2024-06-20 21:08，[@恢宏](undefined/allen.hzw)在行业的导购报警群内咨询，是否有人处理接手相关预警\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/65956558/1718938563926-0f76b71d-207c-4cbc-a338-9ede449cacb6.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/65956558/1718938448784-cf4ce80d-4d3f-4786-bd2e-415f7ac71e98.png)\n\n2024-06-20 21:09，**【根因定位】**[@臻人](undefined/xumingchi.xmc) 查看报错，观察到筛选项代码报错，21:00刚好推了筛选项相关的配置，时间吻合，初步认定是配置导致的\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/78656360/1719196205706-ddc85a43-376b-44a5-987e-d14a0f9d4dcb.png)\n\n2024-06-20 21:10，**【故障发生】**故障持续时间（21:01-21:10）达10分钟，触发P3。\n\n2024-06-20 21:10，**【恢复执行】**[@臻人](undefined/xumingchi.xmc)** **回滚diamond配置\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/78656360/1718937996291-cbb784a4-73b5-42e8-81a1-27676218713b.png)\n\n2024-06-20 21:12，**【故障恢复】**监控恢复至正常水位，故障恢复。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/41240/",
    "chunk_order_index": 0,
    "full_doc_id": "doc-a6b6488abdf496b081b0fc389ae4b86b"
  },
  "chunk-a3da3b43c9fb85c1ee456b9bf357646f": {
    "tokens": 1200,
    "content": "ylark/lark/0/2024/png/78656360/1718937996291-cbb784a4-73b5-42e8-81a1-27676218713b.png)\n\n2024-06-20 21:12，**【故障恢复】**监控恢复至正常水位，故障恢复。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/41240/1719388656006-582d3cb0-b065-4d39-8602-12d7990829a7.png)\n\n## 三、故障原因\n### 3.1【背景说明】\n**【需求背景】**\n\n1. 产品反馈发现线上酒店详情页权益组件展示有问题，但预发无问题，排查后定位到是由于线上、预发配置不一致，列表页选中fx专享筛选项后未带入详情页导致。所以将预发配置中fx专享相关的配置同步到线上来解决这个问题。\n2. 酒店于5月进行了详情页筛选的大改版，并逐步切流，目前已切流50%至新版本，经沟通商旅暂时不切换至新版本。\n\n**【业务链路】**\n\n用户访问商旅酒店详情页时，权益组件会调用酒店提供的详情页C端接口（即hwsearch），进行商品召回和特征的聚合，根据商品特征和配置生成需要展示的筛选项，同时会给筛选项填充埋点信息。**  **\n\n![画板](https://intranetproxy.alipay.com/skylark/lark/0/2024/jpeg/78656360/1719406737073-c9d73a1c-3312-4b69-8c51-9c928b01ff58.jpeg)\n\n### 3.2【原因分析】\n##### 一句话原因：\n推送配置上线后存在重复数据，且历史代码存在安全隐患，导致对同一对象执行操作时，会触发空指针异常。\n\n##### 根因分析：\n1. 预发和线上配置中存在部分的数据重复，当把预发配置推到线上的时候，是一个新增数据的行为非覆盖，这时就会出现数据重复的现象。\n2. sortOptionArray\u0000 : 对应上述配置中的一部分数据（筛选项ID等参数信息）。\n\n当sortOptionArray中存在重复数据时，在循环中会对同一对象执行操作。操作的内容主要是填充业务埋点信息。![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/78656360/1718941633790-531734a1-c8ed-4581-88d1-d828c746917d.png)\n\n3. 但在填充埋点的结束操作buildTrackInfo()方法中，存在对埋点属性置空的操作。导致对同一对象执行操作时，会触发空指针异常。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/78656360/1718941704456-1ce51e89-09c5-40d8-97b5-8d38c87640d3.png)\n\n\n\n## 四、关注点分析\n**【系统质量】**\n\n- [x] **代码质量：**\n1. **当底层抛异常的时候页面显示无报价，缺少容错性？**\n\n**改进点：**梳理5个系统辅助代码质量，并进行修正。[@白柒](undefined/baiqi.zy) 7.31\n\n- [x] **变更质量：**\n1. **发布上线的配置是否有经过review？为何没有发现数据重复的现象？**\n\n**问题总结：**有经过review，只看了新增部分的代码，历史部分太多无法全部看完。\n\n**改进点：**针对高频使用的配置增加配置的合法性校验  [@白柒](undefined/baiqi.zy)  7.31\n\n2. **本次配置上线经过开发自测，为何没有发现问题？是否需要测试介入？**\n\n**问题总结：**配置发布时，使用了已切流至新版本的账号进行验证，但问题是老版本代码才会触发，所以在安全生产未发现到问题。\n\n**改进点：**后续所有影响线上的变更（高频高危的场景），都需要通知到测试评估是否需要介入，同时测试覆盖的场景需要和测试同学对焦清楚。这个内容写入到开发变更规范中，6.28完成内部宣导，是否可以通过工具实现7.15给出结论 [@翼翾](undefined/hardy.lwj)\n\n3. **灰度及上线过程中为何没有发现异常？上线的时候是否有分批发布？**\n\n**问题总结：**在灰度环境进行功能验证无问题后，进行了分批发布，未观察监控数据。灰度验证时间过短。\n\n**改进点：**商旅核心报警接入导购的预警群 [@北诗](undefined/perry.py) 6.28；核心action：diamond灰度验证时长是否需要调整给出结论 [@龙幽](undefined/longyou.lh)[@雅净](undefined/sunny.zyj)  7.3   \n\n- [x] **处置能力-故障发现及响应：**\n1. �",
    "chunk_order_index": 1,
    "full_doc_id": "doc-a6b6488abdf496b081b0fc389ae4b86b"
  },
  "chunk-8823f523aac62d4f0eac2c54152dc7fd": {
    "tokens": 1200,
    "content": "过短。\n\n**改进点：**商旅核心报警接入导购的预警群 [@北诗](undefined/perry.py) 6.28；核心action：diamond灰度验证时长是否需要调整给出结论 [@龙幽](undefined/longyou.lh)[@雅净](undefined/sunny.zyj)  7.3   \n\n- [x] **处置能力-故障发现及响应：**\n1. 故障是受影响方监控优先报出的，触发方是否有监控预警，预警后是否及时响应？\n\n**问题总结：**故障受影响方第一时间查看到报警、开始着手处理，21:08分联系到故障触发方，故障触发方开始处理。\n\n配置上线后故障触发方在和产品、测试对齐问题，没有第一时间观察到报警群内的报警。\n\n**改进点：**商旅核心报警接入导购的预警群，行业统一标准应急保障。\n\n2. **风险预警群拉起后，21:05已经定位是行业问题，拉灵御处理，但21:08的时候恢宏在另一个群询问是否有人接手预警，信息透传是否不够及时？导购群21:02已有预警，6分钟还未有人接手，是否告警通知模式上要调整？**\n\n**问题总结：**没有第一时间找到对的人来处理，导购群的对应故障场景告警未触达阈值，普通告警有触发，考虑到噪音问题，告警模式暂时不调整，后续会将商旅核心报警接入导购预警群。\n\n**改进点**：应急处理流程商旅内部重新宣导 [@恢宏](undefined/allen.hzw) 7.2  \n\n             后续行业的线上故障应急处理可以第一时间艾特[@白柒](undefined/baiqi.zy)[@翼翾](undefined/hardy.lwj) ,日常找值班同学即可。\n\n### 4.1【系统质量】\n#### 4.1.1 需求&设计评估\n**〖关注点1〗****是否涉及产品、技术方案评估？此核心的问题是什么，如何改进？**\n\n- [ ] **是，涉及**\n    - [ ] 需求评估遗漏\n    - [ ] 产品设计缺陷\n    - [ ] 系统架构设计缺陷\n        - [ ] 容错性不足 \n        - [ ] 单点，无冗余\n        - [ ] 缺乏自我保护\n        - [ ] 缓存设计不当\n        - [ ] 容量评估不足\n        - [ ] 非幂等设计\n        - [ ] 强弱依赖不合理\n        - [ ] 其他：__________\n- [x] 否，不涉及\n\n#### 4.1.2 代码质量\n**〖关注点1〗是否代码自身存在漏洞或BUG、代码健壮性是否存在问题等?**\n\n**〖问题分析〗**埋点代码存在健壮性问题，缺少容错性\n\n**〖改进点〗**梳理5个系统辅助代码质量，并进行修正\n\n\n\n**〖关注点2〗****是否经过CodeReview？CodeReview阶段是否发现问题？为何没发现？**\n\n+ **是否经过CR**\n    - [x] 是\n    - [ ] 否\n    - [ ] 不涉及\n+ **是否设置合理的CR卡点**\n    - [x] 是\n    - [ ] 否\n    - [ ] 不涉及\n+ **CodeReview阶段是否发现问题？为何没发现？后续如何发现？**\n    - [ ] 是\n    - [x] 否\n    - [ ] 不涉及\n\n**〖问题分析〗**配置review时没有注意到数据的重复\n\n**〖改进点〗**针对高频使用的配置增加配置的合法性校验\n\n\n\n**〖关注点3〗****测试阶段**\n\n+ **测试内容：**线上复现bug出现的路径，在安全生产环境看推送配置效果\n+ **测试人员：**臻人\n+ **是否经过测试验证**\n    - [x] 是，验证环境\n        - [x] 预发环境\n        - [ ] 日常环境\n        - [x] 线上环境\n    - [ ] 是，测试方法\n        - [ ] 单元测试\n        - [ ] 功能回归测试\n        - [ ] 集成测试/链路测试\n        - [ ] 验收测试\n    - [ ] 否\n    - [ ] 不涉及\n+ **测试未发现原因是什么？后续如何改进？**\n    - [ ] 回归测试遗漏\n        - [ ] 手工回归测试用例遗漏\n        - [ ] 自动化未建设\n        - [ ] 自动化回归覆盖不足\n        - [ ] 其他：__________\n    - [ ] 新场景测试遗漏\n        - [ ] 功能测试用例遗漏，包括正常分支和异常分支\n        - [ ] 容灾兜底测试遗漏\n        - [ ] 客户端兼容性测试遗漏\n        - [ ] 埋点测试遗漏\n        - [ ] 性能测试遗漏，影响评估不足\n        - [ ] 安全测试遗漏\n    - [x] 其他：__未使用老版本测试________",
    "chunk_order_index": 2,
    "full_doc_id": "doc-a6b6488abdf496b081b0fc389ae4b86b"
  },
  "chunk-da98e51d120dd0a9ec2ca82108c9b835": {
    "tokens": 1200,
    "content": "] 新场景测试遗漏\n        - [ ] 功能测试用例遗漏，包括正常分支和异常分支\n        - [ ] 容灾兜底测试遗漏\n        - [ ] 客户端兼容性测试遗漏\n        - [ ] 埋点测试遗漏\n        - [ ] 性能测试遗漏，影响评估不足\n        - [ ] 安全测试遗漏\n    - [x] 其他：__未使用老版本测试________\n\n**〖问题总结〗**使用了命中新版本的账号进行验证，未使用命中老版本的账号进行验证\n\n**〖改进点〗**后续所有影响线上的变更（高频高危的场景），都需要通知到测试评估是否需要介入，同时测试覆盖的场景需要和测试同学对焦清楚。\n\n#### 4.1.3 变更质量\n+ **是否涉及变更：**\n    - [x] 是\n    - [ ] 否\n+ **变更类型：**\n    - [ ] 代码发布\n    - [x] 配置变更\n    - [ ] 其他变更：____________\n    - [ ] 不涉及\n+ **变更平台是否接入ChangeFree：**\n    - [x] 是，CF变更单链接：[https://aicf.alibaba-inc.com/aicf/change/v2/detail/1043362618](https://aicf.alibaba-inc.com/aicf/change/v2/detail/1043362618)\n    - [ ] 否\n+ **是否违反变更红线3.1**** **[链接](https://aliyuque.antfin.com/ngoc/fzg6dy/uar1k6)\n    - [ ] 是，违反哪条原则：\n    - [x] 否\n\n\n\n**〖关注点1〗****灰度阶段**\n\n+ **是否经过灰度：**\n    - [x] 是\n    - [ ] 否\n+ **观测了哪些监控**：_可以附链接_\n    - [ ] 黑屏、白屏\n    - [ ] GOC监控：\n    - [ ] 系统大盘：\n    - [x] 其他：安全生产环境进入列表页、详情页正常，相关功能验证正常\n+ **是否灰度期间发现问题？**\n    - [ ] 是\n        - [ ] 是否灰度流量过大，导致故障\n        - [ ] 灰度发现但未有效或及时修复，导致故障\n        - [ ] 其他：___________\n    - [x] 否，后续如何灰度发现？\n+ **未灰度发现原因**\n    - [ ] 应用灰\n        - [ ] 灰度流量太小\n        - [ ] 灰度阶段无监控\n        - [ ] 灰度批次不合理\n        - [ ] 超长时间灰度才能发现\n    - [ ] 业务灰：策略不合理\n    - [ ] 灰度无法发现\n    - [x] 其他：使用了命中新版本的测试账号进行灰度验证、但新版本无问题\n\n**〖问题总结〗**在灰度环境进行功能验证无问题后，进行了发布，未观察监控数据，且灰度验证时间过短\n\n**〖改进点〗**后续在进行了功能验证后，需要观察监控数据；商旅核心报警接入导购的预警群；diamond灰度验证时长是否需要调整待定。\n\n\n\n**〖关注点2〗****上线阶段**\n\n+ **是否有确定的监控观测指标**\n    - [x] 是，监控指标及监控链接：[https://x.alibaba-inc.com/custom/59/product/preview/spm/15096?crossTenant=true](https://x.alibaba-inc.com/custom/59/product/preview/spm/15096?crossTenant=true)\n    - [ ] 否\n+ **是否在窗口期进行发布变更**\n    - [ ] 是\n    - [x] 否，原因：线上发现问题，发布配置来解决线上问题。\n+ **变更是否影响上下游**\n    - [x] 是，是否有提前知会上下游评估及关注变更\n        - [ ] 有提前知会\n        - [x] 没有提前知会\n    - [ ] 否\n\n### 4.2【处置能力】\n#### 4.2.1 故障发现&响应\n+ **是否监控发现**\n    - [ ] 故障触发方 \n    - [x] 故障受影响方 监控发现 \n    - [ ] 否，原因为：（监控无效/监控缺失）\n+ **是否5分钟内响应**\n    - [x] 是\n    - [ ] 否，原因为：\n+ **是否存在应急协同问题**\n    - [x] 是\n        - [ ] 应急流程不明确（无流程或者流程不清晰、应急相关角色&职责不明确，缺失一号位等)\n        - [x] 应急执行不到位（有流程，但未按流程执行，通告发送不及时，响应不及时等）\n    - [ ] 否\n\n**〖问题总结〗**没有第一时间找到对应的人\n\n**〖改进点〗**应急处理流程商旅内部重新宣导\n\n#### 4.2.2 故障定位&恢复\n+ **主要恢复方式：**\n    - [ ] 代码发布/回滚",
    "chunk_order_index": 3,
    "full_doc_id": "doc-a6b6488abdf496b081b0fc389ae4b86b"
  },
  "chunk-30818c7ea2155961b8a80be15af02466": {
    "tokens": 621,
    "content": "[x] 应急执行不到位（有流程，但未按流程执行，通告发送不及时，响应不及时等）\n    - [ ] 否\n\n**〖问题总结〗**没有第一时间找到对应的人\n\n**〖改进点〗**应急处理流程商旅内部重新宣导\n\n#### 4.2.2 故障定位&恢复\n+ **主要恢复方式：**\n    - [ ] 代码发布/回滚\n    - [x] 配置发布/回滚\n    - [ ] 数据订正\n    - [ ] 机器隔离/重启/扩容\n    - [ ] 配置限流\n    - [ ] 预案降级\n    - [ ] 自动恢复\n    - [ ] 其他：\n\n**〖关注点1〗定位&恢复阶段存在什么问题？是否可以增加预案，****有更快的恢复方式？****相关的优化改进？**\n\n**〖问题总结〗**暂无\n\n## 五、故障Action\n| **序号** | *******Action** | *******负责人** | *******计划完成时间** | **是否keyAction** |\n| :---: | --- | --- | --- | --- |\n| 1 | 短期：梳理5个系统辅助代码质量，并进行修正 | 白柒 | 7.31 |  |\n| 2 | 短期：针对高频使用的配置增加配置的合法性校验 | 白柒 | 7.31 |  |\n| 3 | 短期：开发变更规范优化（测试部分） | 翼翾 | 6.28 |  |\n| 4 | 短期：商旅核心报警接入导购的预警群 | 北诗 | 6.28 |  |\n| 5 | 短期：diamond灰度验证时长是否需要调整给出结论 | 龙幽、雅净 | 7.3 | 是 |\n| 6 | 短期：应急处理流程商旅内部重新宣导 | 恢宏 | 7.2 |  |\n| 7 | 短期：商旅梳理域内对导购侧的强依赖，导购侧最好场景回归与自动化验证 | 浪哈 | 7.3 |  |\n| 8 | 长期：商旅&行业技术架构问题优化 | 恢宏，白柒，夺魁 | 8月底产出方案 |  |\n\n\n## 六、故障总结反思\n后续使用diamond配置时，增加配置合法性校验，虽然diamond配置基本由开发配置，但仍会存在配置不符合预期的情况，一定要在开发时做好校验。\n\n不论是发布代码还是发布配置，验证发布后，都应观察2-3分钟报警。",
    "chunk_order_index": 4,
    "full_doc_id": "doc-a6b6488abdf496b081b0fc389ae4b86b"
  },
  "chunk-62d3f9889fcd760de93232c5a886ffcd": {
    "tokens": 1200,
    "content": "## 一、故障简述\n故障简述：15:10至17:20期间成功率多次抖动，期间都是通过屏蔽机器监控恢复，17:08开始成功率低于80%，持续十分钟后触达故障\n\n## 二、故障过程回顾\n### 2.1【故障处理时间线】\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/4078/1715580994876-4ef3de64-4bb7-45a7-8485-d854f8e26167.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/4078/1715582272612-e902f8d6-00c7-4d0e-bb04-8c90f7f1c88d.png)\n\n故障时间线：\n\n2024-05-10 13:59，hsc正式第一批发布（共4批）\n\n2024-05-10 15:09，hsc正式环境第3批发布完成\n\n2024-05-10 15:13，下单页顺畅率报警【首次报警】\n\n2024-05-10 15:16，惜言屏蔽有问题的机器（共一台33.49.32.90）\n\n2024-05-10 15:17，下单页顺畅率恢复\n2024-05-10 15:27，下单页顺畅率再次报警\n\n2024-05-10 15:29，惜言屏蔽有问题的机器（共两台33.84.114.19、33.102.201.209 核心）\n\n2024-05-10 15:32，下单页顺畅率恢复\n\n2024-05-10 15:32，hsc开始回滚\n\n2024-05-10 15:33，hsc核心集群开始扩容20台\n\n2024-05-10 15:35，恢复被屏蔽机器\n\n2024-05-10 15:55，hsc前3批回滚完\n\n2024-05-10 16:42，惜言主动发现又有单机cpu过高，对单机（共一台）进行屏蔽 (33.49.32.90 非核心)\n\n2024-05-10 16:44，行业商家平台反馈有单机线程池满，对单机（共一台）进行屏蔽(33.42.180.147 非核心)\n\n2024-05-10 16:53，下单页顺畅率再次报警\n\n2024-05-10 16:53，屏蔽有问题的机器（共一台）(33.63.47.202 非核心)\n\n2024-05-10 16:55，下单页顺畅率恢复\n\n2024-05-10 17:01，导购查询时效标签关闭，非核心服务时间接口调用恢复常态\n\n2024-05-10 17:03，下单页顺畅率再次报警\n\n2024-05-10 17:06，hsc非核心集群开始扩容30台\n\n2024-05-10 17:10，hsc非核心集群开始继续扩容30台\n\n2024-05-10 17:15，恢复被屏蔽机器\n\n2024-05-10 17:16，成功率持续十分钟低于80%触达故障等级定义【故障发生】\n\n2024-05-10 17:20，异常机器重启后下单页顺畅率恢复 【故障恢复】\n\n## 三、故障原因\n### 3.1【背景说明】\n### 问题说明：\n_说明_\n\n1. 与hsc的发布无关，只是时间点比较吻合\n2. 与导购查询时效标签接口无关，只是时间点比较吻合\n\n#### 【表象】hsc集群cpu、load升高普遍升高，问题单机尤为明显\n集群：\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/4078/1715408042667-829bac30-a39b-42fc-8454-7867c4ae1c90.png)\n\n问题单机：33.49.32.90 \n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/4078/1715408274231-ed579c3c-3a59-4010-9053-ac3c0c2bf200.png)\n\n\n\n#### 【表象】单机数据库连接池满\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/4078/1715410087845-f4c0c1d9-42ea-4af8-ac84-1fb77ec3ca0c.png)\n\n\n\n\n\n#### 【表象】tair缓存命中率下降\nhsc缓存tair namespace=100， 查询卖家，卖家服务时间会先走缓存\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/68421/1715408602089-5ebca439-1592-454a-b5df-bbbdbc20c851.png)\n\n### 3.2【原因分析】\n+ **一句话原因：**\n\n15点第一次顺畅率下跌",
    "chunk_order_index": 0,
    "full_doc_id": "doc-b14d7b687b39ef74f8ec42dee9097a24"
  },
  "chunk-e9e42a0bc247d28eaf5bdcfa77eea2c5": {
    "tokens": 1200,
    "content": "下降\nhsc缓存tair namespace=100， 查询卖家，卖家服务时间会先走缓存\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/68421/1715408602089-5ebca439-1592-454a-b5df-bbbdbc20c851.png)\n\n### 3.2【原因分析】\n+ **一句话原因：**\n\n15点第一次顺畅率下跌是因为hsc单机日志序列化时发生死锁，大量线程持有锁&等待锁，导致CPU\\LOAD升高，服务挂掉。\n\n17点第二次下跌是因为hsc接口流量不均，接口SellerService#getSellerById卖家缓存热点key（淘1站酒店专营店、帮订房酒店专营店）被tair客户端限流，导致查询流量击穿到数据库，单机数据库（hotel_seller_app）连接池链满了，大量线程等待（如下图），cpu和load上升，hsf线程池打满，最后上游请求大量报错，下单页顺畅率下跌。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/4078/1715582869838-3df19b41-4c63-41fe-8db5-31c7a06b31b0.png)\n\n\n\n+ **根因分析：**\n\n**故障根因：**\n\n    - **15点顺畅率第一次下跌是单机大量线程卡在日志写入，发生死锁，单机cpu、load升高，服务挂掉**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/4078/1716270971466-4dcb3f3e-3fcc-4d2a-af26-af006f0b20dc.png)\n\n所有hsf线程都是持有锁，然后等待锁![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/4078/1716271310337-77b14f97-61ca-4553-a9b0-640abc5f3795.png)\n\n下午15点异常机器线程栈， 60%线程卡在日志写入\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/68421/1715410505261-05b286af-c36a-4414-88fa-76f09eef13f1.png)\n\n\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/4078/1716270990144-ec759d93-25ff-4dd8-bb15-88d8246d819e.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/4078/1716270990339-0e7f561d-2371-4fd1-8db5-c36fc0b43109.png)\n\n后续确认单机流量异常原因\n\n\n\n    - **17点第二次下跌是因为单机流量不均，导致tair-client本地限流，查询流量击穿到数据库，单机数据库连接池满了，大量的线程在等待DB连接池的锁。SellerService@getSellerById日常整个接口的QPS均值在12000左右，单机平均600，接口单机限流5000。但33.63.47.202 这台机器17:18时直接打到5000限流.流量来自于上游hic，再上游是hmatch、hcomparison**\n    - ****\n        * \n        * ![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/4078/1716273452001-c04b0535-aa6c-43ff-a8c1-9bff41dea0da.png)\n\n\n\n单机接口流量直接打满5000\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/4078/1715407626077-4ec09588-2f6a-420f-9ce3-d1a3dc608873.png)\n\n\n\nhsc缓存热点key（淘1站、帮订房酒店专营店）\n\n15:10 ~ 15:18\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/4078/1716258876069-bbbdc1bf-06f8-4e5d-ae5c-9e62c8ba05c6.png)\n\n15:25 ~ 15:30\n\n## ![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/4078/1715409427051-78f9ded2-44b8-4700-91a5-bc7523e3d5c1.png)\n16:50 ~ 16:59\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/4078/1715409452316-00f78836-2f76-4c74-8edf-dd20241248cd.png)\n\n17:06 ~ 17:16\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/4078/1715412629869-7d8b3486-3",
    "chunk_order_index": 1,
    "full_doc_id": "doc-b14d7b687b39ef74f8ec42dee9097a24"
  },
  "chunk-ee182994a738b06c428e0663b0cea83f": {
    "tokens": 1200,
    "content": "[](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/4078/1715409452316-00f78836-2f76-4c74-8edf-dd20241248cd.png)\n\n17:06 ~ 17:16\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/4078/1715412629869-7d8b3486-3fc1-4553-8e44-ef0ee897c169.png)\n\n\n\n## 四、关注点分析\n_/* 填写说明：根据故障实际情况可增删关注点，并提供详细内容分析*/_\n\n### 4.1【系统质量】\n#### 4.1.1 需求&设计评估\n**〖关注点1〗****是否涉及产品、技术方案评估？此核心的问题是什么，如何改进？**\n\n- [ ] **是，涉及**\n    - [ ] 需求评估遗漏\n    - [ ] 产品设计缺陷\n    - [ ] 系统架构设计缺陷\n        - [ ] 容错性不足 \n        - [ ] 单点，无冗余\n        - [ ] 缺乏自我保护\n        - [ ] 缓存设计不当\n        - [ ] 容量评估不足\n        - [ ] 非幂等设计\n        - [ ] 强弱依赖不合理\n        - [ ] 其他：__________\n- [x] 否，不涉及\n\n**〖问题总结〗**\n\n**〖改进点〗**_**需明确写明不同故障相关方的改进项（若有的话），下同。**_\n\n1、\n\n#### 4.1.2 代码质量 否\n**〖关注点1〗是否代码自身存在漏洞或BUG、代码健壮性是否存在问题等?**\n\n**〖问题分析〗**\n\n**〖改进点〗**_**需明确写明不同故障相关方的改进项（若有的话），下同。**_\n\n1、\n\n\n\n**〖关注点2〗****是否经过CodeReview？CodeReview阶段是否发现问题？为何没发现？**\n\n+ **是否经过CR**\n    - [ ] 是\n    - [ ] 否\n    - [ ] 不涉及\n+ **是否设置合理的CR卡点**\n    - [ ] 是\n    - [ ] 否\n    - [ ] 不涉及\n+ **CodeReview阶段是否发现问题？为何没发现？后续如何发现？**\n    - [ ] 是\n    - [ ] 否\n    - [ ] 不涉及\n\n**〖问题分析〗******\n\n**〖改进点〗**_**需明确写明不同故障相关方的改进项（若有的话），下同。**_\n\n1、\n\n\n\n**〖关注点3〗****测试阶段**\n\n+ **测试内容：**涉及的测试提交单、测试用例等\n+ **测试人员：**\n+ **是否经过测试验证**\n    - [ ] 是，验证环境\n        - [ ] 预发环境\n        - [ ] 日常环境\n    - [ ] 是，测试方法\n        - [ ] 单元测试\n        - [ ] 功能回归测试\n        - [ ] 集成测试/链路测试\n        - [ ] 验收测试\n    - [ ] 否\n    - [ ] 不涉及\n+ **测试未发现原因是什么？后续如何改进？**\n    - [ ] 回归测试遗漏\n        - [ ] 手工回归测试用例遗漏\n        - [ ] 自动化未建设\n        - [ ] 自动化回归覆盖不足\n        - [ ] 其他：__________\n    - [ ] 新场景测试遗漏\n        - [ ] 功能测试用例遗漏，包括正常分支和异常分支\n        - [ ] 容灾兜底测试遗漏\n        - [ ] 客户端兼容性测试遗漏\n        - [ ] 埋点测试遗漏\n        - [ ] 性能测试遗漏，影响评估不足\n        - [ ] 安全测试遗漏\n    - [ ] 其他：__________\n\n**〖问题总结〗**\n\n**〖改进点〗**_**需明确写明不同故障相关方的改进项（若有的话），下同。**_\n\n1、\n\n#### 4.1.3 变更质量 否\n+ **是否涉及变更：**\n    - [ ] 是\n    - [ ] 否\n+ **变更类型：**\n    - [ ] 代码发布\n    - [ ] 配置变更\n    - [ ] 其他变更：____________\n    - [ ] 不涉及\n+ **变更平台是否接入ChangeFree：**\n    - [ ] 是，CF变更单链接：________\n\n_/*要这样的链接_ [https://aicf.alibaba-inc.com/aicf/change/detail/1725370372](https://aicf.alibaba-inc.com/aicf/change/detail/1725370372) */\n\n    - [ ] 否\n+ **是否违反变更红线3.1**** **[链接](https://aliyuque.antfin.com/ngoc/fzg6dy/uar1k6)\n    - [ ] 是，违反哪条原则：\n    - [ ] 否\n\n\n\n**〖关注点1〗****灰度阶段**\n\n+ **是否经过灰度：**\n    - [ ] 是\n    - [ ] 否\n+ **观测",
    "chunk_order_index": 2,
    "full_doc_id": "doc-b14d7b687b39ef74f8ec42dee9097a24"
  },
  "chunk-a430c78a319634bcdca848048db5418a": {
    "tokens": 1200,
    "content": ") */\n\n    - [ ] 否\n+ **是否违反变更红线3.1**** **[链接](https://aliyuque.antfin.com/ngoc/fzg6dy/uar1k6)\n    - [ ] 是，违反哪条原则：\n    - [ ] 否\n\n\n\n**〖关注点1〗****灰度阶段**\n\n+ **是否经过灰度：**\n    - [ ] 是\n    - [ ] 否\n+ **观测了哪些监控**：_可以附链接_\n    - [ ] 黑屏、白屏\n    - [ ] GOC监控：\n    - [ ] 系统大盘：\n    - [ ] 其他：___________\n+ **是否灰度期间发现问题？**\n    - [ ] 是\n        - [ ] 是否灰度流量过大，导致故障\n        - [ ] 灰度发现但未有效或及时修复，导致故障\n        - [ ] 其他：___________\n    - [ ] 否，后续如何灰度发现？_____________\n+ **未灰度发现原因**\n    - [ ] 应用灰\n        - [ ] 灰度流量太小\n        - [ ] 灰度阶段无监控\n        - [ ] 灰度批次不合理\n        - [ ] 超长时间灰度才能发现\n    - [ ] 业务灰：策略不合理\n    - [ ] 灰度无法发现\n    - [ ] 其他：_____________\n\n**〖问题总结〗**\n\n**〖改进点〗**_**需明确写明不同故障相关方的改进项（若有的话），下同。**_\n\n1、\n\n\n\n**〖关注点2〗****上线阶段**\n\n+ **是否有确定的监控观测指标**\n    - [ ] 是，监控指标及监控链接：\n    - [ ] 否\n+ **是否在窗口期进行发布变更**\n    - [ ] 是\n    - [ ] 否，原因：\n+ **变更是否影响上下游**\n    - [ ] 是，是否有提前知会上下游评估及关注变更\n        - [ ] 有提前知会\n        - [ ] 没有提前知会\n    - [ ] 否\n\n**〖问题总结〗**\n\n**〖改进点〗**_**需明确写明不同故障相关方的改进项（若有的话），下同。**_\n\n1、\n\n### 4.2【处置能力】\n#### 4.2.1 故障发现&响应\n+ **是否监控发现**\n    - [ ] 故障触发方 监控发现\n    - [ ] 故障受影响方 监控发现\n    - [ ] 否，原因为：（监控无效/监控缺失）\n+ **是否5分钟内响应**\n    - [ ] 是\n    - [ ] 否，原因为：\n+ **是否存在应急协同问题**\n    - [ ] 是\n        - [ ] 应急流程不明确（无流程或者流程不清晰、应急相关角色&职责不明确，缺失一号位等)\n        - [ ] 应急执行不到位（有流程，但未按流程执行，通告发送不及时，响应不及时等）\n    - [ ] 否\n\n**〖问题总结〗**\n\n**〖改进点〗**_**需明确写明不同故障相关方的改进项（若有的话），下同。**_\n\n1、\n\n#### 4.2.2 故障定位&恢复\n+ **主要恢复方式：**\n    - [ ] 代码发布/回滚\n    - [ ] 配置发布/回滚\n    - [ ] 数据订正\n    - [ ] 机器隔离/重启/扩容\n    - [ ] 配置限流\n    - [ ] 预案降级\n    - [ ] 自动恢复\n    - [ ] 其他：\n+ **是否10分钟内恢复**_/* P1P2故障填写*/_\n    - [ ] 是\n    - [ ] 否，原因：__________\n\n**〖关注点1〗定位&恢复阶段存在什么问题？是否可以增加预案，****有更快的恢复方式？****相关的优化改进？**\n\n**〖问题总结〗**\n\n**〖改进点〗**\n\n1、\n\n\n**〖关注点2〗业务自身是否具备容灾逃逸能力？后续如何改进？**_/* 如涉及基础设施引发的故障，可填写*/_\n\n- [ ] 具备容灾能力\n    - [ ] 因未演练不敢执行\n    - [ ] 因有损评估决策不执行\n    - [ ] 无决策或者决策不当，未执行\n- [ ] 不具备容灾能力\n\n**〖问题总结〗**\n\n**〖改进点〗**\n\n1、\n\n## 五、故障总结反思\n_/* P1故障必填，主要用于总结分享和提炼分析*/_\n\n**【做得好的】**\n\n最佳实践\n\n**【经验教训】**\n\n举一反三，学习，避免踩坑\n\n## 六、故障Action\n_/* 填写说明：Action制定原则*/_\n\n> _机制流程建议不超过总数的20%；_\n>\n> _Action数量建议不超过10条；_\n>\n> _短期Action建议1-2周内完成，并内部验收（如缺陷修复",
    "chunk_order_index": 3,
    "full_doc_id": "doc-b14d7b687b39ef74f8ec42dee9097a24"
  },
  "chunk-e7c95abd08292202eda8ae9b5e394bb7": {
    "tokens": 874,
    "content": "提炼分析*/_\n\n**【做得好的】**\n\n最佳实践\n\n**【经验教训】**\n\n举一反三，学习，避免踩坑\n\n## 六、故障Action\n_/* 填写说明：Action制定原则*/_\n\n> _机制流程建议不超过总数的20%；_\n>\n> _Action数量建议不超过10条；_\n>\n> _短期Action建议1-2周内完成，并内部验收（如缺陷修复、监控等避免故障再发的的措施需列为短期Action）；_\n>\n> _P1P2需至少有1个keyAction（治本Action，从根源上避免类似重大故障再发生/控制爆炸半径）；_\n>\n> _Action描述须完整、语言简洁，一目了然。_\n>\n\n| **序号** | *******Action标题** | *******负责人** | *******计划完成时间** | **Action描述** | **验收标准** | **验收人** | **是否keyAction** | **是否回血Action** |\n| --- | --- | --- | --- | --- | --- | :---: | --- | --- |\n| 1 | 长期：hsc tair缓存改造，从公有示例换成hsc单独实例，当前namespace=100属于公用的 (待定) | 雷正 | 6.7号 | keyaction |  | | | |\n| 2 | 强弱依赖改造，部分hic核心接口调用了hsc、hpc非核心接口梳理和依赖改造 | 凭阑、芷薇 | 6.14 | 交易相关核心现有链路梳理 | keyaction | | | |\n| 3 | 短期：解决Tair热点key限流问题，使用tair localcahe或其他本地缓存并进行压测验证 | 雷正、毅盛 | 6.7号 |  |  | | | |\n| 4 | 强弱依赖改造，部分hic核心接口调用了hsc、hpc非核心接口梳理和依赖改造 | 皇策、重杨 | 6.30 | 架构升级后链路 |  | | | |\n| 5 | 长期：商品中心的缓存池(接近用满)使用实例、容量和应用场景梳理和优化改造 | 皇策、各应用owner配合 | 6.30 | 先梳理和改造方案产出 |  | | | |\n\n\n5、action：拉上hsf同学确认单机流量异常原因  雷正\n\n6、【中间件】确认tair监控有效性，后续考虑是否推广配置相关预警  芷薇\n\n## 七、影响产品线&影响面\n    - [ ] 是否影响可用性\n        * 可用性指标，可用性时长消耗\n    - [x] 业务影响：\n        * 影响的产品线，业务功能，功能受损程度（成功量/率下跌多少%），持续多少时间\n    - [ ] 是否有客诉量：\n        * 在线，热线，排队量\n    - [ ] 是否有社会舆情：\n        * 舆情ESU等级/未到E等级，舆情关键词，总声量，负声量\n    - [ ] 是否产生资损：\n        * 理论资损金额，实际资损金额\n\n_/* 可附相关故障等级定义的链接和截图]*/_\n\n链接：\n\n截图：17:07-17:18成功量持续低于80%\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/4078/1715580994876-4ef3de64-4bb7-45a7-8485-d854f8e26167.png?x-oss-process=image%2Fformat%2Cwebp%2Fresize%2Cw_1589%2Climit_0)",
    "chunk_order_index": 4,
    "full_doc_id": "doc-b14d7b687b39ef74f8ec42dee9097a24"
  },
  "chunk-099be7d5f1b4e1fc9372bc551aa79e7d": {
    "tokens": 1200,
    "content": "## 一、故障简述\n【暂定P4】【飞猪】2022-08-24 11:30左右，用户购买机票时搭售平台辅营和保险，支付时只能支付机票商品，平台辅营和保险无法支付只能超时关闭。经飞猪机票交易侧同学信志排查，初步定位为在获取平台搭售商品支付流水号时，因系统抛异常异常导致获取失败，最终用户未支付对应的搭售商品。2022-08-24 11:40回滚代码，故障于2022-08-24 11:45恢复。\n\n**APM故障链接：**\n\n[https://g.alibaba-inc.com/ormFailure/workbench/failure/2022083000000003001?spm=a2o1z.12531199.0.0.305b3c5aEHvOsg&__tenant__=alibabaGroup](https://g.alibaba-inc.com/ormFailure/workbench/failure/2022083000000003001?spm=a2o1z.12531199.0.0.305b3c5aEHvOsg&__tenant__=alibabaGroup)\n\n## 二、故障过程回顾\n### 【1-5-10概览】\n![画板](https://intranetproxy.alipay.com/skylark/lark/0/2022/jpeg/39701/1661915122888-161f7177-1987-4b05-889a-850b5529fb3d.jpeg)\n\n### 【故障处理时间线】\n【故障注入】2022-08-24 10:18 [儿童买成人票](https://yuque.antfin-inc.com/docs/share/eaeb2d5b-f2f4-4aa3-951c-992a84ee0172?# 《【国内机票】儿童买成人票》)项目中搭车修复线上问题 信志开始发布正式环境\n\n【故障发生】2022-08-24 11:08\t信志 完成发布，[正式环境发布完成](https://cd.aone.alibaba-inc.com/ec/app/70656/deploy/order?spm=a2o8d.mix_deploy_order.page.249.6a937368l3tEkN&id=65996231&envId=379308)\n\n【故障发现】2022-08-24 11:30 信志 发现ateye异常监控存在明显波动，开始排查问题\n\n【业务响应】\n【初因定位】2022-08-24 11:40  \t信志 定位问题原因，并开始准备回滚。\n\n【恢复执行】2022-08-24 11:40  \t信志 问题定位并开始回滚代码\n\n【故障恢复】2022-08-24 11:45\t回滚完成，监控恢复。\n\n【影响消除】\n\n\n\n## 三、影响面故障级别\n    - [x] 业务影响：\n        * 飞猪机票2696单保险未能支付\n    - [x] 是否有客诉量：\n\n                  10+工单量\n\n    - [x] 故障级别\n\n                待定。\n\n## 四、故障原因\n### 4.1【一句话原因】\n在获取平台搭售商品支付流水号时，因系统抛异常导致获取失败，最终用户未支付对应的搭售商品\n\n### 4.2【背景说明】\n[儿童买成人票](https://yuque.antfin-inc.com/docs/share/eaeb2d5b-f2f4-4aa3-951c-992a84ee0172?# 《【国内机票】儿童买成人票》)项目中搭车修复线上问题，代码有问题，在导致拉起收银台出现异常。\n\n### 4.3【根因分析】\n根本原因：json反序列化时发生泛型擦除，后续逻辑中在使用值时，发生类型不匹配异常，导致流程中断；\n\n\n\n+ 数据库中数据（noStandardBaby）情况如下，quantity/payAmount/unitAmount/advancePurchase/xItemType是int类型，mainTpOrderId/tpOrderId是long类型；\n+ noStandardBaby在系统中没有对应的class做承接，使用时反序列化成List> 参与逻辑处理；\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/39701/1662089694301-7794eb12-e475-48bc-957d-aa206783c1ed.png)\n\n+ List> outerCreateOrderInfoList4= new Gson().fromJson(outerOrderInfo, new TypeToken>>() {}.getType()); 反序列化时，int/long类型会转成Double类型\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/347597/1661410454887-19a382fc-a9a4-48ab-9b2d-88d893a615ae.png)\n\n+ List> outerCreateOrderInfoList3 = new Gson().fromJson(outerOrderInfo, new TypeToken>>(){}.getType());反序列化时，所有字段均转换成String类型\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/347597/1661411156687-4b919381-3429-497b-a86d-38d5c",
    "chunk_order_index": 0,
    "full_doc_id": "doc-953224bb1d53aa44b96ccc92613719c0"
  },
  "chunk-d1524737eb7397c8c73ef09ba0113897": {
    "tokens": 1200,
    "content": "-88d893a615ae.png)\n\n+ List> outerCreateOrderInfoList3 = new Gson().fromJson(outerOrderInfo, new TypeToken>>(){}.getType());反序列化时，所有字段均转换成String类型\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/347597/1661411156687-4b919381-3429-497b-a86d-38d5c25f0929.png)\n\n+ List> outerCreateOrderInfoList1 = JSONObject.parseObject(outerOrderInfo, List.class); 反序列化后，outerCreateOrderInfoList1中对应的value是原始类型，不是期望的String\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/347597/1661412020890-5d44588c-40fd-423f-a96c-a716dc3a1fc2.png)\n\n+ List> outerCreateOrderInfoList2 = JSONObject.parseObject(outerOrderInfo, new TypeReference>>(){});反序列化后，outerCreateOrderInfoList2中对应的value是期望的数据类型String\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/347597/1661412119511-b1ae9816-ebac-4d77-b78d-b6abfcf04148.png)\n\n### 改动代码\n![](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/347597/1661412359793-4dd49490-b66b-4541-91ce-60dea82924ed.png)\n\n+ 无忧礼包商品生单时，保险信息存入noStandardBaby；\n+ 当无忧礼包商品中券生单失败时要整体失败，需将保险信息从noStandardBaby字段中过滤掉，过滤时noStandardBaby中value字段类型强转为String，而flyorder/flyrp等系统一直默认noStandardBaby中value字段类型是Object，此处过滤后会导致后续链路异常；\n+ new Gson().fromJson指定Object类型反序列化时，字段类型错乱（见前文说明），故改用JSONObject.parseObject处理；\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/347597/1661412878406-17a7cc34-ece5-4765-b957-aaaf4e8d11fd.png)\n\n+ 考虑到其他地方对noStandardBaby的处理都是使用fastjson，故这里也废弃了gson，没有注意到里面的坑；\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/347597/1661428032461-d1225b78-bcfb-45b9-9d4b-1b60869cab33.png)\n\n+ isBlank方法入参必须是CharSequence，long强转失败，异常终止\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/347597/1661428901165-99b909f7-26aa-4750-a10a-e60eb23fd34c.png)\n\n### 4.4【原因分析】\n#### 背景\n[儿童买成人票](https://yuque.antfin-inc.com/docs/share/eaeb2d5b-f2f4-4aa3-951c-992a84ee0172?# 《【国内机票】儿童买成人票》)项目中搭车修复线上问题，代码有问题，在导致拉起收银台时：\n\n+ 在获取平台搭售商品支付流水号时，因系统抛异常异常导致获取失败，最终用户未支付对应的搭售商品；\n+ 现有链路中搭售商品获取支付流水失败时，不阻塞不提示，导致在测试时未关注到这个问题；\n\n#### 逻辑\n根本原因：json反序列化时发生泛型擦除，后续逻辑中在使用值时，发生类型不匹配异常，导致流程中断；\n\n## 五、故障关注点\n**1、引入阶段**\n**〖关注点1〗****从接到需求到技术方案产出的过程中，技术侧是否进行风险评估，评估遗漏 or 未评估到？是否可以支持预发链路？**\n**〖关注点2〗****是否有经过测试？是否有经过CR？为何未发现？**\n**〖关注点3〗****是否有灰度？灰度过程中为何未发现问题**？  \n**2、应急阶段**\n**〖关注点4〗****是****否有监控发现？若没有，为什么？（监控缺失/报警太多未及时处理/。。）**** 变更后是否做了持续观察？**\n**〖关注点5〗**相关角色的应急响应是否有改进空间？主要恢复方式是什么，是否支持一键回滚？\n\n\n\n## 六、故障Action \n#### 【action制定原则】\n> 机制流程不能超过总数的20%；\n>\n> 故障ACTION的数量建议不超过10条；\n>\n> 短期ACTION建议于1-2周内完结，并内部验收（如缺陷修复、监控等避免故障再发的的措施需列为短期action）；\n>\n> P1P2 ACTION需至少有1个keyAction（治本Action",
    "chunk_order_index": 1,
    "full_doc_id": "doc-953224bb1d53aa44b96ccc92613719c0"
  },
  "chunk-b36f89b06f0fb01d61c984b57ef0a25b": {
    "tokens": 636,
    "content": "故障Action \n#### 【action制定原则】\n> 机制流程不能超过总数的20%；\n>\n> 故障ACTION的数量建议不超过10条；\n>\n> 短期ACTION建议于1-2周内完结，并内部验收（如缺陷修复、监控等避免故障再发的的措施需列为短期action）；\n>\n> P1P2 ACTION需至少有1个keyAction（治本Action，从根源上避免类似重大故障再发生/控制爆炸半径）；\n>\n> ACTION描述须完整、语言简洁，让ACTION指派人一目了然。\n>\n\n| **序号** | **描述** | **是否keyAction** | **是否回血Action** | **计划完成时间** | **Action负责人** |\n| --- | --- | --- | --- | --- | --- |\n| 1 | 系统异常报警机制（调研电话报警） | 否 | 否 | 2022-09-07 23:59:59 | 信志 |\n| 2 | 平台&行业沟通群，拉入接口人和TL，涉及导购/正向/逆向/保险/交易/优惠/.. | 否 | 否 | 2022-09-07 23:59:59    | 信志 |\n| 3 | 【审计】辅营审计中增加对平台搭售辅营（含保险）的订单支付状态审计：接收机票支付完成消息做延迟审计，搭售商品支付状态需是支付完成； | 否 | 否 | 2022-09-07 23:59:59 | 信志 |\n| 4 | 【监控】行业交易大盘整合平台辅营（含保险）生单/支付/转交易的监控：总量/成功量/成功率；收集整合 | 否 | 否 | 2022-09-09 23:59:59 | 信志 |\n| 5 | 【系统异常】团队内制定机制，定期清理系统异常，保证ateye异常监控的干净度； | 否 | 否 | 2022-09-07 23:59:59 | 信志 |\n| 6 | 补充机票+平台辅营搭售合并支付的天启用例 | 否 | 否 | 2022-09-14 23:59:59 | 古悦 |\n| 7 | noStandardBaby数据定义具体类做承接 | 否 | 否 | 2022-09-30 23:59:59 | 信志 |\n| 8 | 【链路优化】搭售商品获取支付流水缺失时，弹框提示用户部分支付（待与产品沟通），搭售支持二次支付问题； | 否 | 否 | 2022-09-02 23:59:59 | 信志 |",
    "chunk_order_index": 2,
    "full_doc_id": "doc-953224bb1d53aa44b96ccc92613719c0"
  },
  "chunk-c698baa6fecee66096641d90a13de957": {
    "tokens": 1200,
    "content": "**一、问题现象描述**  \n用户下完单后，在飞猪订单列表查看不到订单，在主站订单列表中能看到订单，但是部分订单跳转详情时，报404的错误；  \n  \n**二、故障实际影响**  \ntrip-order-center-dump应用从20点开始到20:30左右fullgc时间过长，导致精卫任务同步延迟,用户看不订单，从淘宝订单列表页打开订单详情报404错误。持续21分钟左右。扩容成功后，20：00到20：21左右生成的订单由于精卫任务策略设置，大部分丢失，该部分订单最终在23：40分左右全部可见。  \n●影响时间超过20分钟的订单75638单，影响时间超过1小时的订单57954单，影响时间超过2小时的订单14423单，影响时间超过2.5小时的订单4072单，全部为20：00到20：25分的订单，前25分钟共生成183572笔订单；  \n●从来电用户来看，实际来电去重人数291个。  \n  \n\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/257726/1666671925505-bac92391-ca4b-4de3-a0de-a83fb490ad54.png?x-oss-process=image%2Fresize%2Cw_1500%2Climit_0)\n\n  \n**三、真实完整的故障过程回顾**  \n**20:03 发现订单列表订单不可见**  \n20:03 左右发现订单下单后在飞猪订单中心不可见  \n**20:12 收到精卫报警**  \n20:12 左右开始收到精卫的报警  \n**20:12开始扩容**  \n20:12 开始进行扩容处理，20：21从20台机器扩到90台  \n  \n**20:21 扩容完成，部分订单依然不可见**  \n20:21 扩容完成后，增量订单逐渐恢复可见，但是20：00预售开始时生成的订单由于精卫任务处理策略问题导致部分订单依然不可见；  \n**20:45左右 开始回溯度假sub_travel_order表的精卫任务**  \n20:50 左右开始回溯sub travel order表的精卫任务，由于sql中使用了gmt modified条件，该字段未设置索引，导致回溯较慢，约22:20才回溯完成，但是回溯完成后仍然有部分订单在订单中心看不到；  \n**21:27 订单列表banner切图挂类似小黄条**  \n21:27 左右订单列表在banner处，通过图片的形式挂上小黄条，提示用户流量过大，订单展示有延迟  \n**21:49 发布****f-tm-sc应用，淘系列表进商详，展示友好提示**  \n21:49 发布f-tm-sc应用，打开订详不再报错404，给用户较为友好的提示;  \n**21:50 开始回溯交通ttp_order表的精卫任务**  \n21:50 开始回溯ttp order表的精卫任务，22:08 左右回溯完成后机票宝贝订单在订单中心恢复可见；  \n**21:55 开始回溯tccp的tccp_order表的精卫任务**  \n回溯tccp的订单表。  \n**22:00 飞猪订单列表前端发版，挂小黄条，切图下线**  \n22:00 前端挂上小黄条，给用户更友好和显眼的提示，banner处的图片小黄条下线  \n**22:08 完成ttp_order表精卫任务回溯，机票订单可见恢复**  \nttp order表的精卫任务回溯完成，机票完全恢复。  \n**22:20 完成度假sub_travel_order表的精卫任务回溯**  \n部分订单依旧不可见  \n**22:30 开始回溯fg_tc_order精卫任务非度假部分**  \n22:30 由于部分订单还未展示，22:30左右开始继续通过gmt create条件回溯fg tc order的第一个精卫任务，23:00回溯完成后依然有部分订单未展示；  \n**23:00 完成fg_tc_order精卫任务回溯**  \n回溯完成后依然有部分订单未展示  \n**23:00 开始回溯fg_tc_order精卫任务度假部分**  \n23:00 左右check代码发现还有一个fg tc order的精卫任务，继续进行回溯，于23:40左右回溯完成后基本所有订单都可见；  \n**23:10 开始回溯酒店n_hotel_order精卫任务**  \n回溯酒店订单数据  \n**23:40 订单都可见**  \n通过odps比对，数据补齐。  \nload：  \n  \n  \n  \n**四、故障一句话根因+详细原因**  \n**一句话原因：**  \ndump机器过少（16台），且未压测，hsf流量飙升8倍，导致应用load过高，rt飙高，线程中临时对象不能被回收，发生fgc，fullgc时间过长，导致精卫任务处理超时，同时精卫任务对处理失败的策略设置的有问题，精卫我们使用的是tar",
    "chunk_order_index": 0,
    "full_doc_id": "doc-3b8f099597bcb3e4abca79d8efe54200"
  },
  "chunk-a984548210cfcb34febe4f1b07950bc2": {
    "tokens": 1200,
    "content": "、故障一句话根因+详细原因**  \n**一句话原因：**  \ndump机器过少（16台），且未压测，hsf流量飙升8倍，导致应用load过高，rt飙高，线程中临时对象不能被回收，发生fgc，fullgc时间过长，导致精卫任务处理超时，同时精卫任务对处理失败的策略设置的有问题，精卫我们使用的是tar上传消费的方式。内部处理失败，会try catch。然后返回retry，但是精卫目前不支持retry的重试方式，导致历史数据丢掉。  \n淘宝订单列表页打开订单详情时，依赖了订单中心的订单查询接口，订单数据由于没有落到订单中心库中，打开报404错误。  \n  \n精卫代码：  \n  \n订单中心代码：  \n  \n**系统表现：**  \n**五、舆情和重大风险预防及快恢【确保以后同类问题可以得到解决】**  \n**1、是否经过****codereview？**  \n已review  \n**2、****是否经过测试回归？为什么没有回归发现？测试同学是否有接手测试？自动化是否能发现问题？**  \n已回归  \n**3、关联的应用名？是否经过灰度？灰度了多久？****为什么灰度没有发现问题？**  \ntrip-order-center-dump, 灰度  \n**4、****是否变更触发？对应变更单链接？有问题的代码截图**  \n否  \n**5、****为什么没有监控发现（提前发现）？（基本要求：****1****分钟感知）**  \n  \n**6、****为什么没有快速响应处理？（基本要求：****5****分钟定位、****10****分钟恢复）**  \n  \n**7、如何确保不再出现类似问题？**  \n  \n  \n**8、****故障主要恢复方式**  \n  \n**9、****故障是否是重复发生的？**  \n否  \n**10、****能否沉淀场景演练**  \n  \n11、**是否触发变更红线--**  \n  \n12、**是否触发可用性：**  \n  \n**六、Action**  \n（备注：Action必须可实施，需明确完成时间和责任人）  \n●针对订单中心的action  \n○短期方案，核心应用评估和保障  \nⅰ增加人力资源投入   \nⅱ订单中心相关核心链路check，相关应用扩容，保障后续直播、尾款时稳定性  10.25  \nⅲtocd应用修改为核心应用  10.25  \nⅳ增加精卫限流   \n○中期方案，稳定性和工具建设  \nⅴ大促前压测，做好容量评估，并扩容机器。11月底完成dump应用压测摸底。  \nⅵ精卫任务重试逻辑改造  11.15  \nⅶ增加订单审计，行业/主站订单与订单中心订单（fg_tc_order、fg_biz_order）对比报警  11.25  \nⅷ增加订单对比工具和订单订正处理工具，通过云梯对比出差异订单后直接通过工具订正  11.25  \nⅸ增加预案，支持按照时间、精卫点位回溯任务   \n○长期方案，系统复杂度降低  \nⅰ考虑重构，减少多级、长链路的精卫任务依赖   \nⅱ订单详情链接统一规则  \n●针对飞猪横向稳定性action  \n○各业务线toC页面应急能力收集，[https://yuque.antfin.com/fliggy-campaign/bgpth7/wgashr](https://yuque.antfin.com/fliggy-campaign/bgpth7/wgashr)，订单中心、列表、详情等页面支持小黄条/提示文案等，10.30   \n○大促稳定性专项中，新增非核心应用、核心应用定级评估。 @稳定性负责人  \n○增加应急预案，通过push、短信、小黄条等手段安抚用户  \n**七、故障等级及责任人**  \n  \n  \n**附录：订单中心数据同步链路**  \n**订单同步**  \n核心同步两大块数据：同步tp的订单和行业的订单信息,merge为订单中心数据。  \n通过精卫任务订阅业务系统数据库INSERT,UPDATE, DELTE事件和消息, 来实现订单信息的同步。   \n**数据流转图**  \n  \n  \n相关精卫任务  \n\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/257726/1666672298851-127ba774-3084-4534-8c7d-868185371855.png?x-oss-process=image%2Fresize%2Cw_1474%2Climit_0)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/10145/1666680312163-efe5e310-2792-4a59-aa9c-be9903c20866.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/257726/1666767649904-e8c30252-83fb-4233-8033-32b86d56e50d.png?x-oss-process=image%2Fresize%2Cw_592%2Climit_0)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/",
    "chunk_order_index": 1,
    "full_doc_id": "doc-3b8f099597bcb3e4abca79d8efe54200"
  },
  "chunk-54a590aca9c6a89dc7f67b6f324932a0": {
    "tokens": 1200,
    "content": ")\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/257726/1666767649904-e8c30252-83fb-4233-8033-32b86d56e50d.png?x-oss-process=image%2Fresize%2Cw_592%2Climit_0)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/257726/1666768229496-3c0fa51d-f769-4640-853b-6901003f4518.png?x-oss-process=image%2Fresize%2Cw_1500%2Climit_0)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/10145/1666680950281-e8e2a4d5-e1e3-4a16-bdd2-8a1a4e7890da.png?x-oss-process=image%2Fresize%2Cw_776%2Climit_0)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/257726/1666672632467-445f78e5-dc8a-4dc5-aa93-eaf20b6add40.png?x-oss-process=image%2Fresize%2Cw_1500%2Climit_0)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/257726/1666672726407-66586120-0deb-4a52-a65d-0f588e90893c.png?x-oss-process=image%2Fresize%2Cw_1500%2Climit_0)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/257726/1666673232605-78345359-82f1-4a30-8646-f1882582fcfe.png?x-oss-process=image%2Fresize%2Cw_1500%2Climit_0)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/10145/1666678741810-91223f68-1353-429f-add8-edc743dfe671.png?x-oss-process=image%2Fresize%2Cw_1500%2Climit_0)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/10145/1666680110456-26bcf47a-c49f-44ba-a487-daf7bdb2d09a.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/10145/1666925086121-7b6effa5-1b4e-43d8-b304-112fa6b1f840.png?x-oss-process=image%2Fresize%2Cw_1500%2Climit_0)\n\n|    ![](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/257726/1666676670826-35e994d8-d1ad-4de4-bf22-819485627dde.png?x-oss-process=image%2Fresize%2Cw_1500%2Climit_0) |    ![](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/257726/1666676708157-8b7d27b9-8408-4418-984c-8436c7bbe586.png?x-oss-process=image%2Fresize%2Cw_1500%2Climit_0) |\n| --- | --- |\n|    ![](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/257726/1666676738489-7d003554-d885-4817-b2ba-19c8712b965a.png?x-oss-process=image%2Fresize%2Cw_1500%2Climit_0) |    ![](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/257726/1666676774601-b67db67b-9b8a-49f6-845d-76109431b0d7.png?x-oss-process=image%2Fresize%2Cw_1500%2Climit_0) |\n\n\n| 安全生产红线确认：   **a) ****是否违反变更红线****3.0****？**   变更红线V3.0链接（[https://safe.alibaba-inc.com/mechanism/26986042acb7f1580270703450?spm=goc-safe._.0.0.3cd11d55L7YEsb](https://safe.alibaba-inc.com/mechanism/26986042acb7f1580270703450?spm=goc-safe._.0.0.3cd11d55L7YEsb)）    | | | |\n| --- | --- | --- | --- |\n| 变更红线v3.0    | | 是否违规    | 是否有待改进项    |\n| **面向变更执行人**    | | | |\n| 禁止封网期、非变更窗口",
    "chunk_order_index": 2,
    "full_doc_id": "doc-3b8f099597bcb3e4abca79d8efe54200"
  },
  "chunk-99811d565375fb4bd51a6a1b4e558877": {
    "tokens": 1200,
    "content": "26986042acb7f1580270703450?spm=goc-safe._.0.0.3cd11d55L7YEsb)）    | | | |\n| --- | --- | --- | --- |\n| 变更红线v3.0    | | 是否违规    | 是否有待改进项    |\n| **面向变更执行人**    | | | |\n| 禁止封网期、非变更窗口期进行除紧急变更外的变更    | | 否    |     |\n| 禁止未经测试验证、未经预发、未经灰度的线上变更    | | 否    |     |\n| 禁止一切未通过变更管理平台申请或报备的变更操作，紧急故障处理，可事后补填申请。    | | 否    |     |\n| 禁止无影响面说明、操作步骤、验证方案、应急预案的变更（标准变更除外）。应急预案（如回滚方案）必须具备可操作性。    | | 否    |     |\n| 禁止一切与变更方案计划内容、线上问题排查无关的生产环境变更操作    | | 否    |     |\n\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2020/png/55649/1602769314257-5a51596e-17e3-404c-b905-7dff9b149ab0.png?x-oss-process=image%2Fresize%2Cw_1500%2Climit_0)\n\n[@知常](https://yuque.antfin.com/dongzhen.dz)\n\n[@带剑](https://yuque.antfin.com/daijian.cyc)\n\n[@知常](https://yuque.antfin.com/dongzhen.dz)\n\n[@带剑](https://yuque.antfin.com/daijian.cyc)\n\n[@带剑](https://yuque.antfin.com/daijian.cyc)\n\n[@馬达](https://yuque.antfin.com/majingda.mjd)\n\n[@带剑](https://yuque.antfin.com/daijian.cyc)\n\n[@知常](https://yuque.antfin.com/dongzhen.dz)\n\n[@带剑](https://yuque.antfin.com/daijian.cyc)\n\n[@知常](https://yuque.antfin.com/dongzhen.dz)\n\n[@带剑](https://yuque.antfin.com/daijian.cyc)\n\n[@知常](https://yuque.antfin.com/dongzhen.dz)\n\n[@带剑](https://yuque.antfin.com/daijian.cyc)\n\n[@知常](https://yuque.antfin.com/dongzhen.dz)\n\n[@云燕](https://yuque.antfin.com/yunyan)\n\n[@回薄](https://yuque.antfin.com/huibo.hxy)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/63772/1666871570596-db457d37-378a-488b-9633-34449352db87.png?x-oss-process=image%2Fresize%2Cw_1500%2Climit_0)\n\n| 业务    | **任务编号**    | 原表    | **任务描述**    |\n| --- | --- | --- | --- |\n| 订单中心自转    | [O_S_DDC_373938](http://jingwei.alibaba-inc.com:9999/jingwei3/nodeDetail.htm?env=online&nodeId=373020)    | fg_biz_order    | 监听订单中心库状态变动    |\n| 营销    | [O_S_DDC_400156](http://jingwei.alibaba-inc.com:9999/jingwei3/nodeDetail.htm?env=online&nodeId=400046)    | coupon_stock    | 营销侧券状态变动监听同步    |\n| 二次预约    | [O_S_DDC_421072](http://jingwei.alibaba-inc.com:9999/jingwei3/nodeDetail.htm?env=online&nodeId=423148)    | book_order    | book_order数据同步    |\n| 度假行业    | [O_S_DDC_421763](http://jingwei.alibaba-inc.com:9999/jingwei3/nodeDetail.htm?env=online&nodeId=423885)    | wifi_order_ext    | 飞猪订单中心-度假业务-WIFI到FG【DRC增量】    |\n| | [O_S_DDC_421800](http://jingwei.alibaba-inc.com:9999/jingwei3/nodeDetail.htm?env=online&nodeId=423921)    | visa_order_ext    | 飞猪订单中心-度假业务-签证到FG【DRC增量】    |\n| | [O_S_DDC_421836](http://jingwei.alibaba-inc.com:9999/jingwei3/nodeDetail.htm?env=online&nodeId=423957)    | phonecard_order   电话卡    | 飞猪订单中心-度假业务-电话卡到FG【DRC增量】    |\n| | [O_S_DDC_421845](http://jingwei.alibaba-inc.com:9999/jingwei3/nodeDetail.htm?env=online&nodeId=423966)    | recharge_order_ext   流量充值    | 飞猪订单中心-度假业务-流量冲值到FG【DRC增",
    "chunk_order_index": 3,
    "full_doc_id": "doc-3b8f099597bcb3e4abca79d8efe54200"
  },
  "chunk-05dd184b99bf6e43ce96eb9185fa1bd7": {
    "tokens": 1200,
    "content": "| phonecard_order   电话卡    | 飞猪订单中心-度假业务-电话卡到FG【DRC增量】    |\n| | [O_S_DDC_421845](http://jingwei.alibaba-inc.com:9999/jingwei3/nodeDetail.htm?env=online&nodeId=423966)    | recharge_order_ext   流量充值    | 飞猪订单中心-度假业务-流量冲值到FG【DRC增量】    |\n| | [O_S_DDC_421852](http://jingwei.alibaba-inc.com:9999/jingwei3/nodeDetail.htm?env=online&nodeId=423973)    | travel_ins_order   度假老保险    | 飞猪订单中心-度假业务-保险表到FG【DRC增量】    |\n| | [O_S_DDC_422218](http://jingwei.alibaba-inc.com:9999/jingwei3/nodeDetail.htm?env=online&nodeId=424337)    | itinerary_order_ext   线路    | 飞猪订单中心-度假业务-线路到FG【DRC增量】    |\n| | [O_S_DDC_422223](http://jingwei.alibaba-inc.com:9999/jingwei3/nodeDetail.htm?env=online&nodeId=424342)    | ticket_order_ext   门票    | 飞猪订单中心-度假业务-门票到FG【DRC增量】    |\n| | [O_S_DDC_422267](http://jingwei.alibaba-inc.com:9999/jingwei3/nodeDetail.htm?env=online&nodeId=424386)    | car_order_ext   用车    | 飞猪订单中心-度假业务-用车直连到FG(DRC增量）    |\n| 度假基础    | [O_S_DDC_422262](http://jingwei.alibaba-inc.com:9999/jingwei3/nodeDetail.htm?env=online&nodeId=424381)    | sub_travel_order    | 飞猪订单中心-度假业务-交易子表到FG(DRC增量)    |\n| 机火汽基础    | [O_S_DDC_422992](http://jingwei.alibaba-inc.com:9999/jingwei3/nodeDetail.htm?env=online&nodeId=425116)    | ttp_order    | 飞猪订单中心-机票业务-ttp_order到FG【DRC增量】    |\n| 机火汽       | [O_S_DDC_423001](http://jingwei.alibaba-inc.com:9999/jingwei3/nodeDetail.htm?env=online&nodeId=425125)    | ttp_order_segment   机火汽航段    | 飞猪订单中心-机票业务-ttp_order_segment到FG【DRC增量】    |\n| | [O_S_DDC_423069](http://jingwei.alibaba-inc.com:9999/jingwei3/nodeDetail.htm?env=online&nodeId=425177)    | trp_apply   机火汽逆向    | 飞猪订单中心-机火汽业务-trp_apply到fg【增量】    |\n| | [O_S_DDC_449244](http://jingwei.alibaba-inc.com:9999/jingwei3/nodeDetail.htm?env=online&nodeId=451370)    | ttp_order_detail   机火汽detail    | 飞猪订单中心-机火汽业务-ttp_order_detail到fg    |\n| 酒店    | [O_S_DDC_423666](http://jingwei.alibaba-inc.com:9999/jingwei3/nodeDetail.htm?env=online&nodeId=425780)    | hotel_order_package   套餐    | 飞猪订单中心-酒店-套餐表-【DRC增量】    |\n| | [O_S_DDC_423668](http://jingwei.alibaba-inc.com:9999/jingwei3/nodeDetail.htm?env=online&nodeId=425782)    | order_guest   入住人    | 飞猪订单中心-酒店-入住人表-【DRC增量】    |\n| | [O_S_DDC_423670](http://jingwei.alibaba-inc.com:9999/jingwei3/nodeDetail.htm?env=online&nodeId=425784)    | insurance_order   酒店保险    | 飞猪订单中心-酒店-保险表-【DRC增量】    |\n| | [O_S_DDC_442524](http://jingwei.alibaba-inc.com:9999/jingwei3/nodeDetail.htm?env=online&nodeId=444653)    | n_hotel_order_attributes   酒店垂直表    | 飞猪订单中心-酒店-垂直表-【DRC增量】    |\n| 度假TP链路    | [O_S_DDC_426713](http://jingwei.alibaba-inc.com:9999/jingwei3/nodeDetail.htm?env=online&nodeId=428806)    | fg_tc_order    | 飞猪订单中心-度假业务-增量消息到FG(TC)【DRC直连】 度假    |\n| 非度假TP链路    | [O_S_DDC_426730](http://jingwei.alibaba-inc.com:9999/jingwei3/nodeDetail.htm?env=online&nodeId=428823)    | fg_tc_order    | 飞猪订单中心-接收TC数据-通用TC任务【DRC增量】，火车票，机票，酒店",
    "chunk_order_index": 4,
    "full_doc_id": "doc-3b8f099597bcb3e4abca79d8efe54200"
  },
  "chunk-c48dd2a7523ea1d801232dca1a871e03": {
    "tokens": 470,
    "content": "增量消息到FG(TC)【DRC直连】 度假    |\n| 非度假TP链路    | [O_S_DDC_426730](http://jingwei.alibaba-inc.com:9999/jingwei3/nodeDetail.htm?env=online&nodeId=428823)    | fg_tc_order    | 飞猪订单中心-接收TC数据-通用TC任务【DRC增量】，火车票，机票，酒店...非度假    |\n| 订单中心TCdump补偿    | [O_S_DDC_436830](http://jingwei.alibaba-inc.com:9999/jingwei3/nodeDetail.htm?env=online&nodeId=439010)    | fg_biz_order    | 订单中心TCdump补偿    |\n| 酒店基础    | [O_S_DDC_439027](http://jingwei.alibaba-inc.com:9999/jingwei3/nodeDetail.htm?env=online&nodeId=441175)    | n_hotel_order    | 飞猪订单中心-酒店-n_hotel_order到fg【DRC增量】    |\n| 平台    | [O_S_ITD_451647](http://jingwei.alibaba-inc.com:9999/jingwei3/nodeDetail.htm?env=online&nodeId=453772)    | fg_biz_order    | 飞猪订单中心-缓存失效精卫任务    |\n| 机票宝贝、保险    | [O_S_DDC_512675](http://jingwei.alibaba-inc.com:9999/jingwei3/customService.htm?env=online&nodeId=516759&serviceId=81930)    | tccp_order    | 同步tccp交易数据到订单中心，目前涉及独立售卖保险业务    |\n| 测试    | [O_S_DDC_519069](http://jingwei.alibaba-inc.com:9999/jingwei3/customService.htm?env=online&nodeId=523154&serviceId=83070)    | tccp_order    | 同步tccp交易数据到订单中心-添加预发测试功能    |\n\n\n若有收获，就点个赞吧",
    "chunk_order_index": 5,
    "full_doc_id": "doc-3b8f099597bcb3e4abca79d8efe54200"
  },
  "chunk-048392de89d0da73c8606e42dbb2bb09": {
    "tokens": 1200,
    "content": "## 一、故障概述（含影响产品线及影响面）\n**故障概述：**\n\n于 2022-11-22 09:40开始，机票/虚拟商品（保险等）/成功量最近10分钟与基线同比下跌大于40%，初步定位为运营配置失误，导致触发技术缺陷(NPE预防保护不足)。通过回滚配置，于10:01故障恢复。\n\n**影响面：**\n\n    - 是否影响可用性**：**是**；**\n    - **业务影响：**\n        * 保险这边大约影响230单保险，保费约7600元\n    - 是否有客诉量（在线，热线，排队量）：\n    - 是否有社会舆情：\n    - 是否产生资损：保费约7600元--收益资损\n\n## 二、故障过程回顾【故障处理时间线】\n### 【1-5-10概览】\n![画板](https://intranetproxy.alipay.com/skylark/lark/0/2022/jpeg/3536/1664281997005-b98bc6b2-4078-4961-9951-eae343abe2ee.jpeg)\n\n### 【故障处理时间线】\n整体故障时间线。需要着重强调【故障注入】【故障发生】【故障发现】【业务响应】【故障定位】【恢复执行】【故障恢复】时间点。\n\n\n\n【故障注入】 **2022-11-22 09:41** 运营**星陈**在锻造者平台新增产品权益配置（注：这里的权益只与OTA坑位配置相关，不涉及交易履约，纯导购搜索内部逻辑）\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/39701/1669170524378-feb9b8c5-b236-4066-b59b-2520ba7991b5.png)\n\n【故障发现】**2022-11-22 09:42 **大量搜索无结果，触发线上GOC报警 \n\n发现线上有大量NPE，主要发生在权益处理流程中\n\n[https://ateye.trip.taobao.com/monitor/exceptionInfo.htm?app=forge:forge_innerhost.=ONEH&type=NullP&beginTime=2022-11-22%2009:00](https://ateye.trip.taobao.com/monitor/exceptionInfo.htm?app=forge:forge_innerhost.=ONEH&type=NullP&beginTime=2022-11-22%2009:00)\n\n由于权益处理当前是核心流程，一旦发生异常，会触发整个搜索异常阻断，从而导致搜索无结果\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/39701/1669170860605-052fa594-b382-4563-8851-ecd7ae103aef.png)![](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/39701/1669170885863-025f017b-3eac-45db-a8b1-83b7f18b6a34.png)\n\n【业务响应】**2022-11-22 09:48 **导购开发紧急线上会议。\n\n@北遥 决策先关闭权益处理逻辑，会影响所有搜索OTA权益，主要包括辅营、Hooper、低价/溢价套餐包装等\n\n@谷语 执行渠道模版中的开关，涉及APP、手淘、支付宝三端，操作时间在09:48:57、09:49:04、09:49:10\n\n之后搜索成功率恢复，9:41~9:49 持续8分钟，没有触发故障。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/39701/1669171045157-f45a1de2-7b7b-4c6c-95fe-7dffd5ee7ecd.png)\n\n【故障发生】**2022-11-22 09:50 **机票/虚拟商品（保险等）/成功量最近10分钟与基线同比下跌大于40%，触发P3** **![](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/39701/1669171327790-a9537547-9326-46b3-be05-40553ca4ccc7.png)\n\n【初因定位】**2022-11-22 09:51 **@北遥 定位到运营配置变更问题，@谷语 执行配置删除操作， 同步运营\n\n【恢复执行】**2022-11-22 09:57 **搜索技术北遥排查明确不会再有NPE，@谷语 重新打开权益开关** **\n\n【故障恢复】**2022-11-22 10:01 **OTA辅营包装恢复，故障恢复。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/39701/1669171457335-f9538c43-4938-4b7f-a3d1-80d03b5c1118.png)** **\n\n## 三、故障影响面\n+ 保险这边大约影响230单保险，保费约7600元\n\n## 四、故障原因\n### 4.1",
    "chunk_order_index": 0,
    "full_doc_id": "doc-33ed9817f1d32164bdb61466331e27f7"
  },
  "chunk-786f1cff2c1e2384beab177725ff19a7": {
    "tokens": 1200,
    "content": "。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/39701/1669171457335-f9538c43-4938-4b7f-a3d1-80d03b5c1118.png)** **\n\n## 三、故障影响面\n+ 保险这边大约影响230单保险，保费约7600元\n\n## 四、故障原因\n### 4.1【一句话原因】\n由于运营变更配置触发技术缺陷，引发搜索异常 (NPE预防保护不足)。\n\n\n\n### 4.2【背景说明】\n业务侧旗舰店的一仓多价要展示，需要在锻造者配置PRODUCTCODE\n\n### 4.3【根因分析】\n\n\n## 为什么辅营会下跌？\n机票搜索是机票主链路流量来源，机票搜索一旦无结果流量跌0，会导致后续交易、辅营没有下单量，最高会引发P2故障，影响范围最大。紧急判断时，需要先保障机票可用性，8分钟内优先恢复了机票搜索。虽然当时机票搜索恢复，但机票OTA无权益包装，辅营下单量依然受影响，但影响范围较小。\n\n## 为什么搜索会下跌？\n运营原本意图是配置两条product相关权益规则\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/7736/1669086071653-59ac21a0-b0f2-40dd-a538-01b7a0b098de.png)\n\n但在第二配置时，配置失误，导致配置在了farebasis字段上\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/7736/1669086039585-d15be7ad-fabe-4ad8-8032-8b0cdd09aff8.png)\n\n由于目前搜索域在做供销切流，100%的用户会调用新报价，新的报价流程里，缺少fareBasis依赖的数据模型\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/7736/1669086183608-85e960c6-ad6d-4065-b933-7673d825cda7.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/7736/1669086202994-f777eba1-26e5-48b7-9cd9-2d0c7adc55ce.png)  \n\n\n\n\n## 四、故障关注点\n### 4.1【系统质量】\n#### 4.1.1 需求&设计评估\n**〖关注点1〗****是否涉及产品、技术方案评估？此核心的问题是什么，如何改进？**\n\n- [ ] **是，涉及**\n    - [ ] 需求评估遗漏\n    - [ ] 产品设计缺陷\n    - [x] 系统架构设计缺陷\n        - [ ] 容错性不足 \n        - [ ] 单点，无冗余\n        - [ ] 缺乏自我保护\n        - [ ] 缓存设计不当\n        - [ ] 容量评估不足\n        - [ ] 非幂等设计\n        - [x] 强弱依赖不合理\n        - [ ] 其他：\n- [ ] 否，不涉及\n\n### 4.2【处置能力】\n#### 4.2.1 故障发现&响应\n+ **是否监控发现**\n    - [x] 是\n        - [x] 故障触发方\n        - [x] 受影响方\n    - [ ] 否 ：****\n+ **发现后是否五分钟内响应**\n    - [x] 是\n    - [ ] 否，原因为\n\n#### 4.2.2 故障定位&恢复\n+ **故障涉及恢复方式：**\n    - [ ] 代码发布\n    - [ ] 代码回滚\n    - [x] 配置回滚\n    - [ ] 隔离\n    - [ ] 扩容\n    - [ ] 重启\n    - [ ] 限流\n    - [ ] 降级预案\n    - [ ] 自动恢复\n    - [ ] 其他：\n+ **是否达到10分钟快恢（**_**P1P2故障填写**_**）**\n    - [x] 是\n    - [ ] 否，原因：\n\n## 五、故障Action\n| **序号** | **ACTION** | **是否keyAction** | **计划完成时间** | **验收标准** | **Action负责人** |\n| --- | --- | --- | --- | --- | --- |\n| 1 | 运营变更时间管控&1、接入CF，保障变更有记录2、判断是否做管控 | 是 | 12.30 |  | 谷语 |\n| 2 | 交通类对接CF规范怎么落地运营系统梳理核心场景，判断接入CF和运营变更审批流程 | 是 | 23.01.31 |  | 音素 |\n\n\n事项与优先级\n\n1.代码优化-P0：代码细节不够严谨，外部输入没有做好判空容错，导致主流程堵塞，[@谷语](undefined/yu.gj",
    "chunk_order_index": 1,
    "full_doc_id": "doc-33ed9817f1d32164bdb61466331e27f7"
  },
  "chunk-cd63e9984975bef5e0d657aae86b05eb": {
    "tokens": 285,
    "content": "谷语 |\n| 2 | 交通类对接CF规范怎么落地运营系统梳理核心场景，判断接入CF和运营变更审批流程 | 是 | 23.01.31 |  | 音素 |\n\n\n事项与优先级\n\n1.代码优化-P0：代码细节不够严谨，外部输入没有做好判空容错，导致主流程堵塞，[@谷语](undefined/yu.gjyu) 已完成\n\n2.变更管控-P0：后台配置的历史变更内容难追溯，尤其是删除操作，如何解决？建议先简单接CF?[@谷语](undefined/yu.gjyu)\n\n3.红线标准-P1：可能触发搜索成交下跌的运营系统，首先要明确飞猪对接CF的红线要求 [@音素](undefined/xiayu.xy) [@鼎霖](undefined/dinglin.cj)\n\n酒店\n\n[飞猪变更平台规范性梳理 @雅净](https://yuque.antfin-inc.com/docs/share/b48515fd-0420-49c4-a00d-451636409c7c?#)\n\n4.系统变更验证-P2：如何做灰度验证能力？后台配置在生效前是否可以做合法性检查？",
    "chunk_order_index": 2,
    "full_doc_id": "doc-33ed9817f1d32164bdb61466331e27f7"
  },
  "chunk-dce2dd645943167ad83a87ff2ca3ee00": {
    "tokens": 1200,
    "content": "![](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/9827/1659103353652-0274c8cd-7318-4cd9-b730-0d66221680b6.png)\n\n**内容涉及公司B3级别以上机密数据，请注意保密！**\n\n| **复盘参与人员** | **飞猪技术（酒店抄送：**范屹**）：**安全生产：业务方：希艳、杭苏技术：二恒\\恒修\\奇虎测试：大改**集团：**GOC：徙南 |\n| --- | --- |\n| **地点** | 11-2-N悬壶楼 |\n| **会议时间** | 1月16日, 周一 16:28 - 18:22 |\n| **复盘持人** | 徙南 |\n| **APM故障链接** |  |\n\n\n## 一、故障概述（含影响产品线及影响面）\n**故障概述：**\n\n 2023-01-13 13:55发布分销商品分层和算法定价一期需求，引起核心服务报错，且因分销佣金规则数据匹配出错导致7%（应该给分销商返佣5%）佣金订单生成，引发既定资损。2023-01-13 22:45 开始操作fsc-product-centre回滚，2023-01-13 22:56 系统恢复正常\n\n**影响面：**\n\n    - 是否影响可用性**：**否**；**\n    - **业务影响：**\n        * 影响业务收益\n    - 是否有客诉量（在线，热线，排队量）：否\n    - 是否有社会舆情：否\n    - 是否产生资损：否\n\n## 二、故障过程回顾【故障处理时间线】\n### 【1-5-10概览】\n![画板](https://intranetproxy.alipay.com/skylark/lark/0/2023/jpeg/23456487/1673350669536-6ab8071a-8863-46bc-a02f-a79858e46815.jpeg)\n\n### 【故障处理时间线】\n整体故障时间线。需要着重强调【故障注入】【故障发生】【故障发现】【业务响应】【故障定位】【恢复执行】【故障恢复】时间点。\n\n 2023-01-13 13:55 二恒发布分销商品分层和算法定价一期需求，引起核心服务报错【故障注入】\n 2023-01-13 16:32 沟通群中提醒业务同学开始配置分销规则和分销价格\n\n2023-01-13 16:32:45 第一单7%佣金生成 【故障发生】\n\n2023-01-13 20:52 接到创单报警，立即回滚fsc-purchase发布完的第一批【故障发现】\n\n2023-01-13 21:53 接到业务反馈收到7%佣金订单，查看报表发现是历史订单数据(报表是T-1数据未展示新进数据)，未进行重点排查【业务响应】\n\n2023-01-13 22:29 开始接收到fsc-rac线程数报警和一系列报价、试单、创单报警【故障发生】\n【故障定位】 \n\n2023-01-14 00:45 fsc-supply-platform回滚完成\n\n2023-01-14 01:45数据订正完成，运营平台页面恢复【恢复执行】\n\n2023-01-14 00:47:24 操作7%佣金规则失效，后续无7%佣金订单生成【故障恢复】\n\n## 三、故障影响面\n+  **1、产生7%佣金订单，引起既定资损**\n\n共产生 **1938**笔，总计GMV **336513.24 **元\n\n其中已支付未退款完成订单数 **1657**笔，合计GMV **283538.77** 元（2023-01-16 09:00统计）\n\n理论最大资损为 **283538.77 * （7% - 5%）= 5670.78**元\n\n**分销商维度(15个)**\n\n| 分销商id | 分销商昵称 | 订单数量 | 订单总金额 |\n| --- | --- | --- | --- |\n| 2213040934521 | 广州绿橙 | 38971.01 | 779.42 |\n| 2213068612034 | 湖南乐旅旅游有限公司 | 16287.73 | 325.75 |\n| 2212929881738 | axinchangsuo(上海畅梭营销策划中心) | 38192.71 | 763.85 |\n| 2221720844 | wylfeitian(西安壹修如新科技有限公司) | 1379.11 | 27.58 |\n| 2213136176445 | 佳宜国际旅行社 | 777.4 | 15.55 |\n| 2091216302 | 喜玩旅游旗舰店 | 13203.01 | 264.06 |\n| 3648953531 | 深圳酷你酒店专营店 | 11679.87 | 233.6 |\n| 4241264954 | 北京美大国际旅行社专营店 | 23124.58 | 462.49 |",
    "chunk_order_index": 0,
    "full_doc_id": "doc-e0c5dc73ab5512c36389b5e7fc0034af"
  },
  "chunk-cef5dfd48b241a243589595f9423812f": {
    "tokens": 1200,
    "content": "3136176445 | 佳宜国际旅行社 | 777.4 | 15.55 |\n| 2091216302 | 喜玩旅游旗舰店 | 13203.01 | 264.06 |\n| 3648953531 | 深圳酷你酒店专营店 | 11679.87 | 233.6 |\n| 4241264954 | 北京美大国际旅行社专营店 | 23124.58 | 462.49 |\n| 1735363294 | 九十多个奥特曼(深圳市幸游国际旅行社有限公司) | 21108.07 | 422.16 |\n| 2886032188 | 港捷旅旅游专营店 | 17804.25 | 356.08 |\n| 2200604637067 | 北京悦途天下旅行社专营店 | 6174.11 | 123.48 |\n| 2212993133164 | 广州票亿 | 46.01 | 0.92 |\n| 2200763063092 | 上海乐客旅行社专营店 | 91262.89 | 1825.26 |\n| 2213092661782 | 河南众客网络技术有限公司 | 756.69 | 15.13 |\n| 2212932904229 | 深圳百纳国际旅行社 | 2771.33 | 55.43 |\n\n\n**2、试单、创单成功率下跌，多家分销商反馈问题（乐旅、乐客、百纳、喜玩、嘉多宝）**\n\n\n\n## 四、故障原因\n### 4.1【一句话原因】\n     2023-01-13发布分销商品分层和算法定价一期需求以支持对部分特殊商品进行分销规则配置和分销价格佣金配置，发布过程中引起核心服务报错，且因分销佣金规则数据匹配出错导致7%（应该给分销商返佣5%）佣金订单生成\n\n\n\n### 4.2【背景说明】\n_ _  分销商品分层和算法定价一期需求以支持对部分特殊商品进行分销规则配置和分销价格佣金配置\n\n### 4.3【根因分析】\n       \n\n    - **1、匹配到7%佣金规则原因**\n\nfsc-product-center服务发布需求新增了字段sellTypeList来替换原有的sellType字段，在数据兼容时默认设置了sell_type字段为sellTypeList字段的第一条数据，在fsc-rac系统未发布情况下，在价格匹配时读取不到新增的sellTypeList字段，导致此高优先级的价格规则匹配命中\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/6656508/1673674796464-eb14c5f6-bcbc-4a12-afe2-e9d02db96ee9.png)\n\n应用简单依赖\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/svg/6656508/1673840779320-e4aac52f-2026-4e3f-a132-11b7a49fd1b7.svg)\n\n**2、fsc-rac系统线程池报警问题原因**\n\n当分销规则缓存失效时，会请求fsc-product-centre服务重新拉取分销规则，fsc-product-centre已发布新代码，MerchantCooperateTagDTO字段中sellType字段有新增枚举值引起fsc-rac侧序列化报错，在有大量请求时造成hsf线程池打满，引起后续的一系列报价、试单、创单报错\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/6656508/1673675879394-d131c25a-a9d3-4065-bd09-cf11514303ce.png)\n\n**3、fsc-purchase发布时创单报警问题原因**\n\n代码判断逻辑有误\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/6656508/1673675314304-861068b8-f917-4a3f-bd33-229749f21969.png)\n\n## \n\n\n\n\n## 四、故障关注点\n/* 根据故障实际情况可增删关注点，并提供详细内容分析*/\n\n### 4.1【系统质量】\n#### 4.1.2  代码质量\n**〖关注点1〗是否代码自身存在漏洞或BUG、代码健壮性是否存在问题等?**\n\n****\n\n**〖问题分析〗**\n\n****\n\n**〖改进点〗**\n\n****\n\n**〖关注点2〗****是否经过CodeReview？CodeReview阶段是否发现问题？为何没发现？**\n\n+ **是否经过CR**\n    - [x] 是\n    - [ ] 否\n    - [ ] 不涉及\n+ **是否设置合理的CR卡点**\n    - [x] 是\n    - [ ] 否\n    - [ ] 不涉及\n    - [CR卡点设置要求](https://ata.alibaba-inc.com/articles/225396?spm=ata.25287382.0.0.5e0c7536X43l05)\n+ **CR人员：**\n+ **CR时长：**\n+ **CodeReview阶段是否发现问题？为何没发现？后续如何发现？**\n    - [ ] 是\n    - [x] 否\n\n**〖问题分析〗多次迭",
    "chunk_order_index": 1,
    "full_doc_id": "doc-e0c5dc73ab5512c36389b5e7fc0034af"
  },
  "chunk-c8f78dc1d7687654256951aadfba377c": {
    "tokens": 872,
    "content": "- [CR卡点设置要求](https://ata.alibaba-inc.com/articles/225396?spm=ata.25287382.0.0.5e0c7536X43l05)\n+ **CR人员：**\n+ **CR时长：**\n+ **CodeReview阶段是否发现问题？为何没发现？后续如何发现？**\n    - [ ] 是\n    - [x] 否\n\n**〖问题分析〗多次迭代，无法在单一CR过程中发现**\n\n**〖改进点〗**\n\n#### 4.1.3 变更质量\n+ **是否涉及变更：**\n    - [x] 是\n    - [ ] 否\n+ **变更类型：**\n    - [ ] 代码发布\n    - [ ] 配置变更\n    - [x] 其他变更：ateye开关\n    - [ ] 不涉及\n+ **变更平台是否接入ChangeFree：**\n    - [ ] 是，CF变更单链接：\n    - [x] 否\n+ **变更内容：**_****_\n    - [x] 变更执行人: \n    - [ ] 变更系统：\n    - [ ] 变更对象：\n\n**〖关注点1〗****测试阶段**\n\n+ **测试内容：**\n+ **测试人员：**\n+ **是否经过测试验证**\n    - [ ] 是，验证环境\n        - [ ] 预发环境\n        - [ ] 日常环境\n    - [x] 是，测试方法\n        - [x] 回归测试\n        - [ ] 单元测试\n        - [ ] 集成测试\n        - [ ] 链路测试\n        - [ ] 验收测试\n    - [ ] 否\n    - [ ] 不涉及\n+ **测试未发现原因是什么？后续如何改进？**\n    - [x] 回归遗漏\n        - [ ] 手工回归case遗漏\n        - [ ] 自动化未建设\n        - [ ] 自动化回归覆盖不足\n        - [ ] 性能影响评估不足\n    - [ ] 新场景遗漏\n        - [ ] 新增功能case遗漏\n        - [ ] 性能影响评估不足\n        - [ ] 无线端稳定性评估/测试不足（如：crash）\n        - [ ] 无线端兼容性测试不足\n        - [ ] 安全问题\n        - [ ] 异常场景评估/测试遗漏\n    - [ ] 其他原因说明：\n\n**〖问题总结〗**\n\n**〖改进点〗**--梳理核心场景，补全自动化测试案例 yeqin\n\n\n\n**〖关注点2〗****灰度阶段**\n\n+ **是否经过灰度：**\n    - [ ] 是\n    - [x] 否\n+ **未灰度发现原因**\n    - [ ] 应用灰：灰度流量太小\n    - [ ] 应用灰：灰度阶段无监控\n    - [ ] 应用灰：灰度批次不合理\n    - [ ] 应用灰：超长时间灰度才能发现\n    - [ ] 业务灰：策略不合理\n    - [x] 灰度无法发现\n    - [ ] 其他：_________\n\n## 五、故障Action\n| **ACTION** | **计划完成时间** | **Action负责人** |\n| --- | --- | --- |\n| 针对召回参数做好对应功能场景做好测试用例覆盖 | 0131 | yeqin |\n| 区分监控的维度针对京杭询价场景做好有结果率的监控，增加每个航司有结果率指标报表 | 0120 | 时阳 |\n| 切流后自营关注一下近两天收益 |  |  |\n| 补充航班询价过程的日志 | 已完成 | 时阳 |\n| 切流过程中技术关注收益 | 0210 | chengyu |",
    "chunk_order_index": 2,
    "full_doc_id": "doc-e0c5dc73ab5512c36389b5e7fc0034af"
  },
  "chunk-742ed821eaa284f4a95936eda268742a": {
    "tokens": 1200,
    "content": "## 一、故障概述（含影响产品线及影响面）\n**故障概述：**\n\n 2023-01-27 14:06 收到运维小蜜报警：解决方案常用服务指标监控异常，小二工作台数据无法加载，后续工单页面无法打开，订单报错，提交赔付受影响，经dump分析为单接口的内存泄露，接口流量比较高导致机器fullgc。通过机器扩容，故障于2023-01-27 18:45恢复。\n\n\n**影响面：**\n\n    - 是否影响可用性**：**是**；**\n    - **业务影响：**\n\n故障对工作台的影响点\n\n影响小二在订单下查询关联工单失败，但是不影响小二正常操作盾冬。正常情况下能够看到的信息如下：\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/75130/1675166813606-5842a5b0-9dbb-446f-b4dd-40bdc6125c86.png)\n\n异常时候的报错提示：\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/75130/1675166836122-a7460b48-71e9-43ec-aee7-48ab4ed14d87.png)\n\n如果调用超时则提示：请求服务故障，如下：\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/75130/1675166853443-73a98aab-18a1-4e1b-94f4-e1505533b816.png)\n\n影响会员标签的展示，正常情况下会员标签的展示：\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/75130/1675166863845-04e44bdc-344c-40a7-abd8-5aa5cc26ead2.png)\n\n异常情况下会员标签的展示：\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/75130/1675166874370-05969b03-bd0f-45cf-8431-496790ab7735.png)\n\n影响小二提交赔付和赔付出账。\n\n影响质检结果的上报（对小二操作不影响）\n\n    - \n    - 是否有客诉量（在线，热线，排队量）：\n    - 是否有社会舆情：\n    - 是否产生资损：\n\n## 二、故障过程回顾【故障处理时间线】\n### \n### 【故障处理时间线】\n整体故障时间线。需要着重强调【故障注入】【故障发生】【故障发现】【业务响应】【故障定位】【恢复执行】【故障恢复】时间点。\n\n\n\n【故障注入】2023-01-26 已经有机器fullGC\n【故障发现】2023-01-27 14:02 开始收到系统报警电话 （累计收到16个报警电话）\n【业务响应】2023-01-27 14:04 少坤反馈已经在排查，直到故障发生，开发一直在排查处置\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/39701/1675930478069-76d89b7c-7463-439a-849a-de0c3a942bf4.png)\n\n2023-01-19 14:28  少坤查到原因为net工单超时，修复网络接口问题，但未注意到部分机器挂掉，未重视\n【故障定位】2023-01-27 18:00左右，定位到部分机器因fullgc挂掉\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/39701/1675931256242-c46a422a-b099-43ca-bd2a-5bb01609805e.png)\n\n【故障发生】2023-01-27 18:10 小二工作台异常持续10分钟，触发P4故障\n\n【恢复执行】2023-01-27 18:15 左右将7台机器扩容到14台\n\n【故障恢复】2023-01-27 18:45 扩容完成，故障恢复\n\n## 三、故障影响面\n飞猪小二工作台数据无法加载，后续工单页面无法打开，订单报错，提交赔付受影响\n\n\n## 四、故障原因\n### 4.1【一句话原因】\n单接口的内存泄露，接口流量比较高导致机器fullgc\n\n\n### 4.2【背景说明】\n26号到27号一直有fullgc并有机器挂掉，直到五点多，所有机器fullgc都挂掉，导致接起大盘，订单卡片等不可用\n\n告警只有核心接口rt的告警，不能很明显的判断机器挂掉\n\n### 4.3【根因分析】\n直接原因：机器metaspace fullgc导致挂掉\n多因子查询的接口，qps最近从200多涨到将近400\n\nmetaspace fullgc，原因是多因子接口内部使用了之前本藏写的ots查询框架（一般单次查询有10个左右的因子，影响会扩大10倍），内部使用了",
    "chunk_order_index": 0,
    "full_doc_id": "doc-5394c6ba1d44d58c568757016e173551"
  },
  "chunk-196c135d6b13fcdd4c6e74710c9982a6": {
    "tokens": 529,
    "content": "告警，不能很明显的判断机器挂掉\n\n### 4.3【根因分析】\n直接原因：机器metaspace fullgc导致挂掉\n多因子查询的接口，qps最近从200多涨到将近400\n\nmetaspace fullgc，原因是多因子接口内部使用了之前本藏写的ots查询框架（一般单次查询有10个左右的因子，影响会扩大10倍），内部使用了动态脚本生成，当qps过高时会产生比较多的临时类不断被加载，加载的速度>回收速度（无法回收），最终导致metaspace OOM\n\n## 五、故障Action\n| **ACTION** | **是否keyAction** | **计划完成时间** | **Action负责人** |\n| --- | --- | --- | --- |\n| zesus-data-center系统压力排查&治理参考点：1. 需要系统化压测各接口的综合qps，之前的压测是单接口且入参较为简单，接口qps评估不准确，评估准确后合理设置限流值2. 梳理各模块的被依赖场景，同步上游做好弱依赖降级，比如订单卡片，赔付模块，小蜜模块，[https://yuque.antfin.com/fliggy-service/datacenter/ei3s4peiglykpgzl](https://yuque.antfin.com/fliggy-service/datacenter/ei3s4peiglykpgzl) 各模块梳理持续完善3. 整理xp及星舰对zesus系统依赖的接口及服务，提供给到zesus系统owner，进行专项保障：1、对应应用及接口监控报警到消防群，2、对应应用稳定性建设 | 是 | 0305 | 息衍 |\n| 扩大B端服务应用基础设施监控检查[https://aliyuque.antfin.com/alitripqa/pb7icn/yc5ilg](https://aliyuque.antfin.com/alitripqa/pb7icn/yc5ilg)《应用基础监控+预发可用覆盖率》（需要开发确定应用扩大范围）增加包括不限于推空保护等 | P1 | 2.28 | 苏英 |\n| 扩大B端服务应用beta或安全生产回归卡口检查（需要开发确定应用扩大范围） |  | 2.28 | 苏英 |",
    "chunk_order_index": 1,
    "full_doc_id": "doc-5394c6ba1d44d58c568757016e173551"
  },
  "chunk-2a659dbb76a88d260a847ad7e3d3c574": {
    "tokens": 1200,
    "content": "## 一、故障概述（含影响产品线及影响面）\n**故障概述：**\n\n** 2023-01-19 10:50 应用**发布引发机器找不到，影响整个应用，21:17分新申请的机器又出现流量尖刺，出现磁盘IO打满，线程池打满。导致订单模块崩溃，工单续播接口异常，核身接口请求报错，无法跳转星舰页面，影响整个飞猪BU的小二，22:49恢复。\n\n**影响面：**\n\n    - 是否影响可用性**：**是**；**\n    - **业务影响：**订单模块崩溃，工单续播接口异常，核身接口请求报错，无法跳转星舰页面，影响整个飞猪BU的小二\n    - ![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/39701/1675922844766-60df6a2b-dc55-4fd2-b48c-88a1c0db9636.png)\n    - ![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/39701/1675922822711-fe19ebe1-bfef-4cb0-a529-09045ab76de0.png)\n    - 是否有客诉量（在线，热线，排队量）：\n    - 是否有社会舆情：\n    - 是否产生资损：\n\n## 二、故障过程回顾【故障处理时间线】\n### 【1-5-10概览】\n![画板](https://intranetproxy.alipay.com/skylark/lark/0/2022/jpeg/3536/1664281997005-b98bc6b2-4078-4961-9951-eae343abe2ee.jpeg)\n\n### 【故障处理时间线】\n整体故障时间线。需要着重强调【故障注入】【故障发生】【故障发现】【业务响应】【故障定位】【恢复执行】【故障恢复】时间点。\n\n\n\n【故障注入】2023-01-19 10:48 早上有1台机器被linux自动 kill了。线上只剩下2台机器\n  2023-01-19 10:59 有个bugfix，发布单：[https://aicf.alibaba-inc.com/aicf/grayscale/hm?spm=a2o8d.mix_deploy_snapshot_detail.page.15.77e51346IHi4KA&publishInfoDownId=224739180](https://aicf.alibaba-inc.com/aicf/grayscale/hm?spm=a2o8d.mix_deploy_snapshot_detail.page.15.77e51346IHi4KA&publishInfoDownId=224739180)自动把剩余的那2台做为一个批次重起了，导致HSF找不到。\n2023-01-19 11:05 申请扩容5台新机器问题恢复。\n【故障发现】2023-01-19 21:17 接到小二反馈工作台报错\n\n【业务响应】2023-01-19 21:17 业务反馈异常\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/39701/1675926004104-73152d14-da89-4ba8-9c7e-66f6bbde0f37.png)\n\n【故障发生】2023-01-19 21:27 持续10分钟打不开行程助手，触发P4故障\n\n【故障定位】2023-01-19 21:30  sunfire提示local thread pool full 定位为单机线程池满\n【恢复执行】2023-01-19 21:59 下线有问题的新机器\n\n【故障恢复】2023-01-19 21:59 下线后故障恢复\n\n【影响消除】2023-01-19 22:49 下线线程池满的机器，并紧急调整日志输出级别，降低输出量，减少磁盘IO占用\n\n## 三、故障影响面\n订单模块崩溃，工单续播接口异常，核身接口请求报错，无法跳转星舰页面，影响整个飞猪BU的小二\n\n上午2023-01-19 10:50 至 2023-01-19 11:05 机器重启，影响持续15分钟\n晚上2023-01-19 21:17 至 2023-01-19 21:59 单机线程池满，影响持续42分钟\n\n## 四、故障原因\n### 4.1【一句话原因】\n大C账号访问，导致单机QPS突增，线程池打满，单机消费hsfQPS被放大，磁盘IO带宽打满 引发故障\n\n\n### 4.2【背景说明】\n2023-01-19 11:05 申请扩容5台新机器，其中一台因大C账号访问线程池被打满\n\n### 4.3【根因分析】\n1、2023-01-19 10:48 有1台机器被linux自动 kill了。线上只剩下2台机器，bugfix发布单自动把剩余的那2台做为一个批次重起了，导致HSF找不到。\n\n2、因大C账号访问导致突发性流量尖刺，",
    "chunk_order_index": 0,
    "full_doc_id": "doc-5de5b4921098e2d9dc0a97096d8f25be"
  },
  "chunk-8f8882056f8048d5c58ef772ce7cc741": {
    "tokens": 688,
    "content": "台新机器，其中一台因大C账号访问线程池被打满\n\n### 4.3【根因分析】\n1、2023-01-19 10:48 有1台机器被linux自动 kill了。线上只剩下2台机器，bugfix发布单自动把剩余的那2台做为一个批次重起了，导致HSF找不到。\n\n2、因大C账号访问导致突发性流量尖刺，单机hsf consumer 300+QPS，造成磁盘IO打满。新申请的5台机器中有一台线程池一直满，重启后会机器立刻打满。\n\n### 【XP】线程池打满&磁盘IO问题\n**原因：**\n\n> 有1个接口，给xp的SOP调用，查询会员的所有已存在的所有赔付单，会做并发查询。\n其中阿信中心账号下，会有大量的赔付单，1次请求，线程放大了150-300倍。\n然后磁盘IO被打满后，造成HSF的provider的线程无法提供正常服务。\n所以看到的现象是，扩容后，还是有某个机器打满。\n>\n> ![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/29745/1674872123831-70bdb3c3-1d81-4e0b-8e27-94c22b747c08.png)\n>\n> ![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/29745/1674872146729-ca237173-e126-4ebe-b522-fdc7f1198453.png)\n>\n\n## 五、故障Action\n| **ACTION** | **是否keyAction** | **计划完成时间** | **Action负责人** |\n| --- | --- | --- | --- |\n| B端服务应用机器发布批次自检查参考点：1.核心应用可以按3批发布，既最少6台机器分布在2个张北机房；2.低于5台机器的应用默认发布批次为一批一台、超过5台机机器，发布批次默认3次or以上） | 是 | 2.10 | 连炸 |\n| 梳理GOC场景链路调用，阻碍GOC场景正常使用接口梳理，添加到监控中  |  | 2.28 | 连炸 |\n| 系统挂了之后的预案 -系统改造 -当xp不能使用之后，星舰提供一套backup（跳过核身） |  | 时间待定 | 连炸 |\n| 大c账号全局场景梳理治理，对应线程放大问题。参考点：1. 检查review启用多线程技术的代码，判断是否存在起用过多线程的可能，并排期进行修改。[@欧阳](undefined/chuzhaojin.czj) （本周）2. 检查查询用户下所有订单的代码场景，判断大C账号下是否有影响，输出评估结论 |  | 2.17 | 连炸 |",
    "chunk_order_index": 1,
    "full_doc_id": "doc-5de5b4921098e2d9dc0a97096d8f25be"
  },
  "chunk-a1bf63667658a78a9af56af71b9bfae9": {
    "tokens": 1200,
    "content": "## 一、故障简述\n故障简述：于21:52开始，飞猪火车票_提交订单异常，失败量最近10分钟最小值大于等于10，成功率最近10分钟最大值小于等于80%，达到P4故障，判断为压测导致，重启机器后于22:05监控恢复至日常水位\n\n## 二、故障过程回顾\n### 2.1【故障处理时间线】\n故障时间线：\n\n【故障引入】搜索压测：  \n2024-04-11 20:32，赤桐、逍潞开始执行搜索接口的压测：火车票搜索listing接口、搜索首页接口、直达ota接口 三个接口\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256373/1713151786456-1d7a5883-d0f5-4964-953a-8b667f17dd56.png)\n\n2024-04-11 21:40，train-product 3台机器报磁盘满了，因此赤桐、逍潞调整压测流量\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/2742/1712919873964-1f9349c8-ba92-483a-8394-c7c5782a8c09.png)\n\n2024-04-11 21:42，直达ota接口 停止压测，火车票搜索listing接口 、搜索首页接口看报警内容不相关没有停止压测，把压测流量调到很小\n2024-04-11 21:48，火车票搜索listing接口 、搜索首页接口 停止压测\n\n交易压测：  \n2024-04-11 21:36：巧蓓开始压测交易生单接口，qps持续为15\n2024-04-11 21:48：巧蓓停止压测交易生单接口停止压测\n2024-04-11 21:50：traindc开始报警tair rt升高（明明是预警时间是48，为什么钉钉是50才发出来）\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/2742/1712920197779-f7078485-411b-479c-903f-f76ac88153d3.png)\n\n2024-04-11 21:54：traindc开始报警FullGC\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/2742/1712920090407-44eaee9b-8a44-4ffa-a8db-6f33e9d336df.png)\n\n**【故障发生】**\n\n2024-04-11 21:53开始触发**多个预警单：**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/2742/1712920444622-6eb2dd20-37b8-4dab-b5c1-0c589f3133c7.png)![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/2742/1712920465304-202e564c-d1a7-42e7-a88d-b6805300be7e.png)\n\n2024-04-11 22:01 成功率低于80%持续10分钟，触发P4故障。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/2742/1712920546135-05992b51-5105-406c-ae31-7fa9643270f6.png)\n\n【故障响应】&【故障定位】&【恢复执行】\n2024-04-11 21:53 博鸣看到trs报警，重启trs机器，按分组分两批进行重启\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/60309/1712922811634-f084ab84-5bc9-4984-8686-39e582dc0f9a.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/60309/1712922834515-a0cee395-e146-4dd7-b48b-5f94cf211558.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/60309/1712922849168-118e25d5-c970-43e8-a66e-b80fc65b7c5e.png)\n\n2024-04-11 21:54 恒磊看到报警，重启traindc一台机器33.54.111.151\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/2742/1712919180397-1cf1bf97-db25-492e-b961-a2a6b6d40cc2.png)\n\n\n\n毅恺也尝试重启traindc，但是发现有1个流程中的重启单（即上面恒磊发起的重启单），因此毅恺没有提重启申请单。\n\n2024-04-11 22:00重启",
    "chunk_order_index": 0,
    "full_doc_id": "doc-ec769d2711a9fb7402a020cb426ab88d"
  },
  "chunk-0415c2cd83fb6272df77ac72c310da72": {
    "tokens": 1200,
    "content": "/lark/0/2024/png/2742/1712919180397-1cf1bf97-db25-492e-b961-a2a6b6d40cc2.png)\n\n\n\n毅恺也尝试重启traindc，但是发现有1个流程中的重启单（即上面恒磊发起的重启单），因此毅恺没有提重启申请单。\n\n2024-04-11 22:00重启后发现线上并没有恢复，毅恺重新提重启申请，完全重启结束时22:17。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/2742/1712919524571-9aa548b5-9a66-493c-8334-c559125a8da9.png)\n\n2024-04-11 22:03 成功率升至80%以上；\n\n****\n\n**【故障恢复】**\n\n2024-04-11 22:05 成功率升至98%，故障恢复。****\n\n\n\n## 三、故障原因\n### 3.1【背景说明】\n背景：主要是应对五一，高德、火车票导购、火车票交易进行压测，及时发现系统潜在问题。\n\n### 3.2【原因分析】\n**一句话原因：**\n\n压测结束后,服务负载过高,未能快速恢复常态,个别机器（其中3台机器 <占比10%，traindc当时30台机器>）已经达到临近状态，系统load过高会引起 Tair 调用超时, 命中率下降，穿透到DB，DB 连接池用尽, 引发HSF 线程池 打满, 由于traindc被交易、票务级联依赖，导致影响面扩大，交易提单服务下跌至80%以下。\n\n\n\n**详细分析：**\n\n\n\n【问题1】 问题的根因是什么？\n\n\n\n引发问题的接口：com.taobao.trip.train.service.TrainCityStationService#getStationCityInfo 该接口流量调用较大。\n\ntraindc当时线上机器30台，集群日常水位40%左右，压测的时候最高达到80%，当时出问题机器的负载更高：时间点为21：46。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/2118/1713152521498-05d12d74-ac52-4765-b592-dec51961c9a9.png)\n\n引发load上升的原因：\n\ntraindc承担了2块功能，一块是123X6数据同步，一块是相关基础数据查询。在大流量搜索的情况下会引发123X6数据同步，同步会频繁有一些序列化动作，会拉高load，同时同步会写tair，当load高的时候tair读写会性能下降，tair是写、读共享连接池，整体会引起tair命中率降低。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/2118/1713164414109-777c8508-5692-41ad-bcdb-6ed3ee763468.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/2118/1713163641637-b1cdb6f9-8251-4e41-be64-2a4f11f95326.png)\n\n引发HSF线程池满的原因：\n\n从堆栈看：系统线程blocked在数据库获取连接池。 方法阻塞在 com.taobao.trip.train.service.TrainCityStationService#getStationCityInfo\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/2118/1713153567708-6cdedc5c-a634-4201-a4e0-e4b9ebe60440.png)\n\n\n\n当tair命中率低的情况下，流量由db承接，当时db无法承接，db连接池满，发生阻塞，进而引起HSF线程池满。\n\n代码上：\n\n    - 缓存穿透\n        * ![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/110556326/1713100664157-9e867d33-3257-4581-8db9-5e8fff74652f.png)\n        * 此处代码逻辑有问题,获取到无站点的缓存数据,还是查了 DB ,相当于这个空缓存是无效的,并未起到缓存屏障的作用\n        * ![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/110556326/1713101120903-be17c3e0-25b6-4cc1-bec3-8a8bf509d913.png)\n        * 21:50 左右,空站点 明显增多,导致大量调用直达 DB,导致 DB 连接池耗尽\n        * ![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/110556326/1713100873625-c45c93a7-e9d6-4503-a0cb-1eb15381cfa6.png)\n\n\n\n整体发生的顺序：load上升->tair发生限流->db连接池阻塞->HSF",
    "chunk_order_index": 1,
    "full_doc_id": "doc-ec769d2711a9fb7402a020cb426ab88d"
  },
  "chunk-326a8e30ccfc08e4a7b3d7a38ad6bf02": {
    "tokens": 1200,
    "content": "多,导致大量调用直达 DB,导致 DB 连接池耗尽\n        * ![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/110556326/1713100873625-c45c93a7-e9d6-4503-a0cb-1eb15381cfa6.png)\n\n\n\n整体发生的顺序：load上升->tair发生限流->db连接池阻塞->HSF线程池满\n\nHSF线程池满后，票务部分核心接口在traindc，导致无法对交易提供服务，引发故障。\n\n\n\n【问题2】 问什么只有3台机器异常，影响面确这么大？\n\n依赖的传递性：\n\n\n\n![画板](https://intranetproxy.alipay.com/skylark/lark/0/2024/jpeg/2118/1713251203344-5885acbf-ec89-44d5-b257-02f36dab49b6.jpeg)\n\ntraidc 有10%机器异常，会叠加影响tro 20%。\n\n\n\n【问题3】 为什么3月份清明的压测没问题，这次压测有问题了。 \n\n4月9号，上游系统trans一个变更（并发从8 ->200），会对getStationCityInfo接口调用量上涨，trans应用tair单机连接池满后单机qps会发生限流，限流后的流量会全部打到traindc，压测的时候该接口调用量分钟级200w。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/2118/1713252988440-bab22566-c498-4773-b375-29a8aeb77a93.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/2118/1713249066454-650aadbd-49ff-4c57-97c0-5a69669d5836.png)\n\n\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/2118/1713244562807-1f9d1b54-30a3-4bb9-ae7c-ac52767cfeaa.png)\n\n## 四、关注点分析\n_/* 填写说明：根据故障实际情况可增删关注点，并提供详细内容分析*/_\n\n### 4.1【系统质量】\n#### 4.1.1 需求&设计评估\n**〖关注点1〗****是否涉及产品、技术方案评估？此核心的问题是什么，如何改进？**\n\n- [x] **是，涉及**\n    - [ ] 需求评估遗漏\n    - [ ] 产品设计缺陷\n    - [ ] 系统架构设计缺陷\n        - [ ] 容错性不足 \n        - [ ] 单点，无冗余\n        - [ ] 缺乏自我保护\n        - [ ] 缓存设计不当\n        - [ ] 容量评估不足\n        - [ ] 非幂等设计\n        - [ ] 强弱依赖不合理\n        - [ ] 其他：__________\n- [ ] 否，不涉及\n\n**〖问题总结〗**\n\n**〖改进点〗**_**需明确写明不同故障相关方的改进项（若有的话），下同。**_\n\n1、\n\n#### 4.1.2 代码质量  不涉及\n**〖关注点1〗是否代码自身存在漏洞或BUG、代码健壮性是否存在问题等?**\n\n**〖问题分析〗**\n\n**〖改进点〗**_**需明确写明不同故障相关方的改进项（若有的话），下同。**_\n\n1、\n\n\n\n**〖关注点2〗****是否经过CodeReview？CodeReview阶段是否发现问题？为何没发现？**\n\n+ **是否经过CR**\n    - [ ] 是\n    - [ ] 否\n    - [ ] 不涉及\n+ **是否设置合理的CR卡点**\n    - [ ] 是\n    - [ ] 否\n    - [ ] 不涉及\n+ **CodeReview阶段是否发现问题？为何没发现？后续如何发现？**\n    - [ ] 是\n    - [ ] 否\n    - [ ] 不涉及\n\n**〖问题分析〗******\n\n**〖改进点〗**_**需明确写明不同故障相关方的改进项（若有的话），下同。**_\n\n1、\n\n\n\n**〖关注点3〗****测试阶段**\n\n+ **测试内容：**涉及的测试提交单、测试用例等\n+ **测试人员：**\n+ **是否经过测试验证**\n    - [ ] 是，验证环境\n        - [ ] 预发环境\n        - [ ] 日常环境\n    - [ ] 是，测试方法\n        - [ ] 单元测试\n        - [ ] 功能回归测试\n        - [ ] 集成测试/链路测试\n        - [ ] 验收测试\n    - [ ] 否\n    - [ ] 不涉及\n+ **测试未发现原因是什么？后续如何改进？**\n    - [ ] 回归测试遗漏\n        - [ ] 手工回归测试用例遗漏\n        - [ ] 自动化未建设\n        - [ ] 自动化回归覆盖不足\n        - [ ] 其他：__________\n    - [ ] 新场景测试",
    "chunk_order_index": 2,
    "full_doc_id": "doc-ec769d2711a9fb7402a020cb426ab88d"
  },
  "chunk-969bdd55748d09f2e4be44c38c0d3b99": {
    "tokens": 1200,
    "content": "路测试\n        - [ ] 验收测试\n    - [ ] 否\n    - [ ] 不涉及\n+ **测试未发现原因是什么？后续如何改进？**\n    - [ ] 回归测试遗漏\n        - [ ] 手工回归测试用例遗漏\n        - [ ] 自动化未建设\n        - [ ] 自动化回归覆盖不足\n        - [ ] 其他：__________\n    - [ ] 新场景测试遗漏\n        - [ ] 功能测试用例遗漏，包括正常分支和异常分支\n        - [ ] 容灾兜底测试遗漏\n        - [ ] 客户端兼容性测试遗漏\n        - [ ] 埋点测试遗漏\n        - [ ] 性能测试遗漏，影响评估不足\n        - [ ] 安全测试遗漏\n    - [ ] 其他：__________\n\n**〖问题总结〗**\n\n**〖改进点〗**_**需明确写明不同故障相关方的改进项（若有的话），下同。**_\n\n1、\n\n#### 4.1.3 变更质量  不涉及\n+ **是否涉及变更：**\n    - [ ] 是\n    - [ ] 否\n+ **变更类型：**\n    - [ ] 代码发布\n    - [ ] 配置变更\n    - [ ] 其他变更：____________\n    - [ ] 不涉及\n+ **变更平台是否接入ChangeFree：**\n    - [ ] 是，CF变更单链接：________\n\n_/*要这样的链接_ [https://aicf.alibaba-inc.com/aicf/change/detail/1725370372](https://aicf.alibaba-inc.com/aicf/change/detail/1725370372) */\n\n    - [ ] 否\n+ **是否违反变更红线3.1**** **[链接](https://aliyuque.antfin.com/ngoc/fzg6dy/uar1k6)\n    - [ ] 是，违反哪条原则：\n    - [ ] 否\n\n\n\n**〖关注点1〗****灰度阶段**\n\n+ **是否经过灰度：**\n    - [ ] 是\n    - [ ] 否\n+ **观测了哪些监控**：_可以附链接_\n    - [ ] 黑屏、白屏\n    - [ ] GOC监控：\n    - [ ] 系统大盘：\n    - [ ] 其他：___________\n+ **是否灰度期间发现问题？**\n    - [ ] 是\n        - [ ] 是否灰度流量过大，导致故障\n        - [ ] 灰度发现但未有效或及时修复，导致故障\n        - [ ] 其他：___________\n    - [ ] 否，后续如何灰度发现？_____________\n+ **未灰度发现原因**\n    - [ ] 应用灰\n        - [ ] 灰度流量太小\n        - [ ] 灰度阶段无监控\n        - [ ] 灰度批次不合理\n        - [ ] 超长时间灰度才能发现\n    - [ ] 业务灰：策略不合理\n    - [ ] 灰度无法发现\n    - [ ] 其他：_____________\n\n**〖问题总结〗**\n\n**〖改进点〗**_**需明确写明不同故障相关方的改进项（若有的话），下同。**_\n\n1、\n\n\n\n**〖关注点2〗****上线阶段**\n\n+ **是否有确定的监控观测指标**\n    - [ ] 是，监控指标及监控链接：\n    - [ ] 否\n+ **是否在窗口期进行发布变更**\n    - [ ] 是\n    - [ ] 否，原因：\n+ **变更是否影响上下游**\n    - [ ] 是，是否有提前知会上下游评估及关注变更\n        - [ ] 有提前知会\n        - [ ] 没有提前知会\n    - [ ] 否\n\n**〖问题总结〗**\n\n**〖改进点〗**_**需明确写明不同故障相关方的改进项（若有的话），下同。**_\n\n1、\n\n### 4.2【处置能力】\n#### 4.2.1 故障发现&响应\n+ **是否监控发现**\n    - [x] 故障触发方 监控发现\n    - [ ] 故障受影响方 监控发现\n    - [ ] 否，原因为：（监控无效/监控缺失）\n+ **是否5分钟内响应**\n    - [x] 是\n    - [ ] 否，原因为：\n+ **是否存在应急协同问题**\n    - [ ] 是\n        - [ ] 应急流程不明确（无流程或者流程不清晰、应急相关角色&职责不明确，缺失一号位等)\n        - [x] 应急执行不到位（有流程，但未按流程执行，通告发送不及时，响应不及时等）\n    - [ ] 否\n\n**〖问题总结〗**\n\n**〖改进点〗**_**需明确写明不同故障相关方的改进项（若有的话），下同。**_\n\n\n\n\n\n#### 4.2.2 故障定位&恢复\n+ **主要恢复方式：**\n    - [ ] 代码发布/回滚\n    - [ ] 配置发布/回滚\n    - [ ] 数据订正\n    -",
    "chunk_order_index": 3,
    "full_doc_id": "doc-ec769d2711a9fb7402a020cb426ab88d"
  },
  "chunk-b8591c168be7faa4e4f694894663b91f": {
    "tokens": 1200,
    "content": "- [ ] 否\n\n**〖问题总结〗**\n\n**〖改进点〗**_**需明确写明不同故障相关方的改进项（若有的话），下同。**_\n\n\n\n\n\n#### 4.2.2 故障定位&恢复\n+ **主要恢复方式：**\n    - [ ] 代码发布/回滚\n    - [ ] 配置发布/回滚\n    - [ ] 数据订正\n    - [ ] 机器隔离/重启/扩容\n    - [ ] 配置限流\n    - [ ] 预案降级\n    - [ ] 自动恢复\n    - [ ] 其他：\n+ **是否10分钟内恢复**_/* P1P2故障填写*/_\n    - [ ] 是\n    - [ ] 否，原因：__________\n\n**〖关注点1〗定位&恢复阶段存在什么问题？是否可以增加预案，****有更快的恢复方式？****相关的优化改进？**\n\n**〖问题总结〗**\n\n\n\n+ 定位问题存在一定偏差，执行措施流程不果断。故障报警是21：53报出，其实异常从21：48左右tro，trainplatform、trs等应用已经开始大量报异常，处置流程不够决断，大家比较慌乱，如果采取摘除异常机器恢复应该更快，暴漏了同学处理故障经验少。\n+ ![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/2118/1713153466373-2066cd98-c616-4121-b9d0-2cdb63a92bbc.png)\n\n\n\n\n\n**〖改进点〗**\n\n1、更快的恢复方式：首先定位故障面，如果只是个别机器，可以直接摘除异常机器，同时执行重启，恢复更快。\n\n\n**〖关注点2〗业务自身是否具备容灾逃逸能力？后续如何改进？**_/* 如涉及基础设施引发的故障，可填写*/_\n\n- [ ] 具备容灾能力\n    - [ ] 因未演练不敢执行\n    - [ ] 因有损评估决策不执行\n    - [ ] 无决策或者决策不当，未执行\n- [ ] 不具备容灾能力\n\n**〖问题总结〗**\n\n\n\n**〖改进点〗**\n\n**action：**\n\n1、traindc 对依赖方提供富客户端，对于调用量非常大的接口提供本地降级能力。\n2、梳理交易提单、票务等链路对下游的核心依赖，对于非核心依赖做到自降级。\n\n## 五、故障总结反思\n_/* P1故障必填，主要用于总结分享和提炼分析*/_\n\n**【做得好的】**\n\n最佳实践\n\n**【经验教训】**\n\n举一反三，学习，避免踩坑\n\n\n\n1、处理流程的规范性\n\n故障处理日常化，演练日常化等，新老同学能够熟悉故障处理流程，而不是慌乱。\n\n2、tair击穿、限流的提前预防\n\n火车票应该很多对tair依赖比较强，针对tair未命中，打到db，命中率低的接口进行监控和预警，通过人工梳理和工具化建设等方式提前规避。\n\n3、压测相关\n\n对压测的依赖链路梳理不够到位，同时压测的时候需要根据预期目标，机器应该扩容到位；同时后续需要梳理可能引发的故障和链路，做好提前的预案措施。\n\n压测属于一个有损行为，尤其是摸高、多场景混压，后续尽量选在业务低峰期，降低产生故障的可能。\n\n## 六、故障Action\n_/* 填写说明：Action制定原则*/_\n\n> _机制流程建议不超过总数的20%；_\n>\n> _Action数量建议不超过10条；_\n>\n> _短期Action建议1-2周内完成，并内部验收（如缺陷修复、监控等避免故障再发的的措施需列为短期Action）；_\n>\n> _P1P2需至少有1个keyAction（治本Action，从根源上避免类似重大故障再发生/控制爆炸半径）；_\n>\n> _Action描述须完整、语言简洁，一目了然。_\n>\n\n| **序号** | *******Action标题** | *******负责人** | *******计划完成时间** | **Action描述** | **验收标准** | **验收人** | **是否keyAction** | **是否回血Action** |\n| --- | --- | --- | --- | --- | --- | --- | --- | --- |\n| 1 | 短期：traindc getStationCityInfo接口修复缓存兜底bug，同时对上游提供富客户端。 | 叔鱼 | 4.16 | getStationCityInfo接口修复缓存兜底bug；对调用量巨大的上游提供富客户端，增加本地缓存。 | keyaction |  |  |  |\n| 2 | 压测SOP | （马达/路衍） | 4.19 | 压测前动作以及，压测后系统检查 |  |  |  |  |\n| 3 | 梳理交易提单等链路对下游的核心",
    "chunk_order_index": 4,
    "full_doc_id": "doc-ec769d2711a9fb7402a020cb426ab88d"
  },
  "chunk-ad151f27c87b0a74513ed730ae43b789": {
    "tokens": 612,
    "content": "CityInfo接口修复缓存兜底bug；对调用量巨大的上游提供富客户端，增加本地缓存。 | keyaction |  |  |  |\n| 2 | 压测SOP | （马达/路衍） | 4.19 | 压测前动作以及，压测后系统检查 |  |  |  |  |\n| 3 | 梳理交易提单等链路对下游的核心依赖，对于非核心依赖做到自降级。 | 毅恺 | 5.30 | 1、强依赖数据，从商品信息带到交易生单链路，不走二次查询2、非强依赖数据，增加自降级 | keyaction |  |  |  |\n| 4 | 长期：火车票tair穿透、限流类监控 | 恒磊 | 4.23 | 安全生产：针对tair限流类增加监控预警 |  |  |  |  |\n| 5 | 火车票压测大盘建设  | 恒磊、（交易： 勿痴  ） | 4.26 | 建立业务，核心接口/性能大盘 |  |  |  |  |\n| 6 | tair限流作为基础监控 |  |  | 带到安全生产做下 |  |  |  |  |\n| 7 | 长期：故障演练，提升大家故障处理的流程规范度 | 鼎霖 | 组织攻防演练 | 预发等环境进行故障演练，提升相关同学故障处理流程熟悉度 |  |  |  |  |\n| 8 | 短期：压测流程完善 | 恒磊、婉风 | 带回规范 | 压测流程规范化；压测相关同学提升熟悉度和跟进力度 |  |  |  |  |\n| 9 | 缓存策略机制架构优化 |  | 基础稳定性建设 | 静态数据本地缓存建设  （带回看一下） |  |  |  |  |\n\n\n## 七、影响产品线&影响面\n    - [ ] 业务影响：\n        * 影响的产品线，业务功能，功能受损程度（成功量/率下跌多少%），持续多少时间\n\n_/* 可附相关故障等级定义的链接和截图]*/_\n\n链接：\n\n截图：火车票提交订单21:51-22:03持续13分钟低于80%![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256373/1713237474466-322b6652-1158-4a2d-bd23-001fafd0fb55.png)",
    "chunk_order_index": 5,
    "full_doc_id": "doc-ec769d2711a9fb7402a020cb426ab88d"
  },
  "chunk-935a86ff25e698adb7306ab9ecc4a7d3": {
    "tokens": 1200,
    "content": "## 一、故障概述（含影响产品线及影响面）\n**故障概述：**\n\n2023-04-06 18:11开始，成功量最近10分钟最小值等于0，用户接送机、用车页面报错，跌零超过10分钟。初步排查为脏数据导致traveldata应用异常，删除脏数据后于18:34恢复。\n\n## 二、故障过程回顾【故障处理时间线】\n### 【1-5-10概览】\n![画板](https://intranetproxy.alipay.com/skylark/lark/0/2022/jpeg/3536/1664281997005-b98bc6b2-4078-4961-9951-eae343abe2ee.jpeg)\n\n### 【故障处理时间线】\n整体故障时间线。需要着重强调【故障注入】【故障发生】【故障发现】【业务响应】【故障定位】【恢复执行】【故障恢复】时间点。\n\n\n\n【故障注入】2023-04-06 17:37 刘忠和通过调用traveldata ateye方法“fixRule”操作更新数据库里一条数据，但字符串格式存在问题，引入脏数据。\n\n预发环境直接更新数据，影响线上，短期先把变更的方法禁掉。长期方法待讨论。--马达、徙南\n\n\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/2742/1680833397125-6e0156f1-43ef-4c7b-9d79-ab4d83ef4e33.png)\n\n【故障发现】2023-04-06 17:58 tfgw服务发布出现批量的NPE提示，接送机的渲染页面开始出现异常告警，开发幕凡发现报警问题，立即跟进排查\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/2742/1680834179368-fec15006-146d-4ead-b23e-473a5cb88808.png)\n\n\n\n2023-04-06 17:59幕凡结合ateye异常重试和自己的手动验证发现，下单详情页无法正常渲染打开\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/2742/1680835572768-003b969c-578c-4a6e-aaf1-db9593e1ec21.png)\n\n【业务响应】2023-04-06  18:01告警内容是提示缓存异常，幕凡判断是缓存出现问题，立即操作降级：手动关闭缓存使用开关，用直接读取的商家数据。但降级并未生效。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/4856574/1680836260782-463c983d-2acf-4b3d-a004-6393ddd5db1d.png)\n\n\n\n2023-04-06  18:02:00 查看缓存写入任务发现源数据提供方traveldata提供的结果为空，正常流程此处需要api的全部直连规则（此为影响范围）\n\n2023-04-06  18:05:00 tfgw全量发布完后执行了回滚，异常未恢复。继续排查\n\n2023-04-06  18:11:00 重启了源数据服务 发现问题未恢复。\n\n2023-04-06  18:17 怀疑源数据底表出现问题.拉取了近期修改记录，开始分析数据内容\n\n【故障发生】2023-04-06 18:21 故障场景指标下跌超过10分钟，触发P4\n\n2023-04-06 18:33 分析后发现一条测试数据的修改时间和问题产生时间匹配一致，提了数据修改工单删除该数据\n\n【故障定位】2023-04-06 18:34手动触发tfgw的规则拉取任务，内存写入成功\n\n后续排查结果发现实际是同时有同学删除了另外一条脏数据，该数据是使用了ateye修改引入 所以数据库没有记录修改时间，第一时间的排查没有发现这条数据\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/2742/1680833432308-6579349e-59e0-453c-9e3c-a5914e3a5959.png)\n\n【恢复执行】删除垃圾数据\n\n【故障恢复】2023-04-06 18:34 18:34 线上指标恢复正常\n\n处理：走了紧急发布 屏蔽该ateye的修改功能，并将规则异常隔离 不会因为个别脏数据导致再全量丢失\n\n## 三、故障影响面\n\n\n**影响面：**\n\n    - 是否影响可用性**：**下单页渲染失败，无法下单**；**预估影响订单150单\n    - **业务影响：**\n        * ![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/39701/1680835578031-39761a84-a099-49cc-b889-6aba95d6551a.png)\n    - 是否有客",
    "chunk_order_index": 0,
    "full_doc_id": "doc-46ff73c09bb7bb5bb13b31cd0b329a6e"
  },
  "chunk-897a99863d94e5e725826cb57bef4624": {
    "tokens": 1200,
    "content": "面：**\n\n    - 是否影响可用性**：**下单页渲染失败，无法下单**；**预估影响订单150单\n    - **业务影响：**\n        * ![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/39701/1680835578031-39761a84-a099-49cc-b889-6aba95d6551a.png)\n    - 是否有客诉量（在线，热线，排队量）：暂无\n    - 是否有社会舆情：\n    - 是否产生资损：\n\n## 四、故障原因\n### 4.1【一句话原因】\n测试脏数据无法JSON解析，代码容错性不足，导致服务不可用\n\n### 4.2【背景说明】\n### 4.3【根因分析】\n1、批量获取规则时没有做隔离导致一个脏数据把全量直连商家的规则污染了\n\n修改前 方法没有异常处理，直接全量失败\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/4856574/1681179614571-72cb92d9-2a2d-4140-80b3-f636421655db.png)\n\n## ![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/4856574/1681179669688-4d102945-127a-46e1-8fba-a85777bd2831.png)\n\n\n2、为什么没有第一时间恢复线上规则数据的可用性\n\n     2.1 降级方案没有直接跨过异常部分逻辑，也失效了。--\n\n     2.2 异常的堆栈信息不完整，引入脏数据的入口没有更新表中的修改时间属性 导致没有及时定位到脏数据的准确信息\n\n\n\n## 四、故障关注点\n### 4.1【系统质量】\n#### 4.1.1 需求&设计评估\n**〖关注点1〗****是否涉及产品、技术方案评估？此核心的问题是什么，如何改进？**\n\n- [ ] **是，涉及**\n    - [ ] 需求评估遗漏\n    - [ ] 产品设计缺陷\n    - [x] 系统架构设计缺陷\n        - [x] 容错性不足 \n        - [ ] 单点，无冗余\n        - [ ] 缺乏自我保护\n        - [x] 缓存设计不当\n        - [ ] 容量评估不足\n        - [ ] 非幂等设计\n        - [x] 强弱依赖不合理\n        - [ ] 其他：\n- [ ] 否，不涉及\n\n**〖问题总结〗**\n\n**优化代码**\n\n#### 4.1.2  代码质量\n**〖关注点1〗是否代码自身存在漏洞或BUG、代码健壮性是否存在问题等?**\n\n**〖问题分析〗历史代码**\n\n**〖改进点〗做异常处理**\n\n****\n\n**〖关注点2〗****是否经过CodeReview？CodeReview阶段是否发现问题？为何没发现？**\n\n+ **是否经过CR**\n    - [ ] 是\n    - [x] 否\n    - [ ] 不涉及\n+ **是否设置合理的CR卡点**\n    - [ ] 是\n    - [ ] 否\n    - [x] 不涉及\n    - [CR卡点设置要求](https://ata.alibaba-inc.com/articles/225396?spm=ata.25287382.0.0.5e0c7536X43l05)\n+ **CR人员：**\n+ **CR时长：**\n+ **CodeReview阶段是否发现问题？为何没发现？后续如何发现？**\n    - [ ] 是\n    - [x] 否\n\n**〖问题分析〗**\n\n**〖改进点〗**\n\n#### 4.1.3 变更质量\n+ **是否涉及变更：**\n    - [x] 否\n\n**〖关注点1〗****测试阶段**\n\n+ **测试内容：商品策略管理需求相关内容**\n+ **测试人员：郝宝成、光白、方宇豪**\n+ **没有经过测试验证**\n\n\n\n**〖关注点2〗****灰度阶段**\n\n+ **是否经过灰度：**\n    - [ ] 是\n    - [x] 否\n\n**〖关注点3〗****上线阶段**\n\n+ **未分批发布**\n\n### 4.2【处置能力】\n#### 4.2.1 故障发现&响应\n+ **是否监控发现**\n    - [x] 是\n        - [x] 故障触发方\n        - [x] 受影响方\n    - [ ] 否 ：****\n+ **发现后是否五分钟内响应**\n    - [x] 是\n    - [ ] 否，原因为：\n\n#### 4.2.2 故障定位&恢复\n## 五、故障Action\n| **序号** | **ACTION** | **是否keyAction** | **计划完成时间** | **验收标准** | **Action负责人** |\n| --- | --- | --- | --- | --- | --- |\n| 1 | 关闭数据修改入口ateye |  | 2023-04-07 | 不能再操作数据变更 | 幕凡 |\n| 2 | 隔离规则数据",
    "chunk_order_index": 1,
    "full_doc_id": "doc-46ff73c09bb7bb5bb13b31cd0b329a6e"
  },
  "chunk-3efb37dc663058176870997cc2e879f8": {
    "tokens": 241,
    "content": "定位&恢复\n## 五、故障Action\n| **序号** | **ACTION** | **是否keyAction** | **计划完成时间** | **验收标准** | **Action负责人** |\n| --- | --- | --- | --- | --- | --- |\n| 1 | 关闭数据修改入口ateye |  | 2023-04-07 | 不能再操作数据变更 | 幕凡 |\n| 2 | 隔离规则数据异常影响 | 是 | 2023-04-07 | 脏数据只影响自身透出 | 幕凡 |\n| 3 | 降级方案优化： | 是 | 2023-05-19 |  | 幕凡 |\n| 4 | ftaxi查询规则方案修改 | 是 | 2023-05-19 | 规则数据不再查tfgw缓存，改成ftaxi直接查询数据库；核心逻辑迁移到核心应用 | 幕凡 |\n| 5 | 综合交通ateye和safe变更（包括非核心应用）通知 | | 2023-04-21 | | 侠乐 |",
    "chunk_order_index": 2,
    "full_doc_id": "doc-46ff73c09bb7bb5bb13b31cd0b329a6e"
  },
  "chunk-a1bd93ea601131f8ea9184072d03d868": {
    "tokens": 1200,
    "content": "## 一、故障简述（含影响产品线及影响面）\n##### 故障概述：\n2024年6月30日09:15收到商家上报飞猪微信小程序在车站自助机扫码无法打开页面，影响用户购票，故障原因确认是页面基础包更新引入循环依赖导致该页面mtop初始化问题，于10:00通过回滚微信小程序止血，故障恢复。期间无消费者客诉，商家反馈1例。\n\n##### 影响面：\n- [x] 是否影响可用性：否\n- [x] 业务影响：\n+ 线下票扫码生成订单报错 (t.default.request is not a function)，影响线下购买汽车票。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/41240/1720147914265-dd50c4b7-2b90-49e4-8cf4-7c8ec5048fe0.png)\n\n+ **影响用户数**：464 （[链接](https://fbi.alibaba-inc.com/dashboard/view/page.htm?spm=a2o1z.8190076.0.0.378c543fcwA20y&id=1171224&query_spmab=181.20917217)），预计影响票数 464*1.2(每单票量)=556张，无理论资损（该场景售票不盈利）\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/151522/1720422223118-86e6fc45-ab86-41e6-9587-54de17bc7528.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/151522/1720422072843-2daba595-bafe-415f-b38a-5dae8391d711.png)\n\n- [x] 是否有客诉：1例商家反馈\n- [x] 是否有社会舆情_：_否\n- [x] 是否产生资损：否\n\n## 二、故障过程回顾\n2024-06-27 17:43，**【风险注入】**rxpi-user-tracker发布[2.11.36](https://anpm.alibaba-inc.com/package/@ali/rxpi-user-tracker/v/2.11.36)版本\n\n2024-06-27 18:16，**【风险注入】**rxpi-user-tracker发布[2.11.37](https://anpm.alibaba-inc.com/package/@ali/rxpi-user-tracker/v/2.11.37)版本\n\n2024-06-29 13:06，**【故障发生】**飞猪微信小程序 v4.3.29 外灰10%，16:16外灰30%，19:11外灰50%，22:17全量发布\n2024-06-30 09:15，**【故障发现】**商家【广东力保】在商家群反馈问题\n2024-06-30 09:18，**【故障响应】**技术判断问题影响面及复现场景\n2024-06-30 09:40，**【初因定位】**技术判断为新版本引入问题，评估回滚可能性\n\n2024-06-30 10:00，**【恢复执行】【故障恢复】**飞猪微信小程序回滚\n\n2024-06-30 18:00，**【迭代发布】**通过固定rxpi-user-tracker版本，实现原迭代重新发布\n\n## 三、故障原因\n### 3.1【背景说明】\n6.27微信每周迭代，该迭代汽车票页面无修改。\n\n迭代发布后，汽车票相关订单生成页面无法渲染，阻塞用户购票（业务场景为：用户在汽车站购票使用飞猪微信小程序生成订单，完成支付）\n\n### 3.2【原因分析】\n##### 一句话原因：\n页面依赖包循环引用导致页面mtop初始化异常\n\n##### 根因分析：\n+ rxpi-user-tracker 发布新版本 2.11.37，依赖了[rxpi-fz-cps-access](https://code.alibaba-inc.com/rxpi/fz-cps-access/blob/master/src/index.ts#L127)，[代码](https://code.alibaba-inc.com/rxpi/user-tracker/compare?from=daily/2.11.35&to=daily/2.11.37&mergeBase=true)，导致独立分包下mtop循环引，独立分包下mtop初始化存在问题（非独立分包无问题）。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/151522/1719907576192-e646cfcd-901f-45a5-9309-7dd42d6e85aa.png)\n\n相关依赖为：\n\nrxpi-mtop <- rxpi-weixin-mtop <- mpi-biz-flow-feature <- rxpi-user-tracker <- rxpi-fz-cps-access <- rxpi-mtop，这一个循环依赖导致独立分包下发起mtop请求时，rxpi-weixin-mtop还未初始化完成，所以首次发起请求报mtop.request找不到；\n\n普通页面没有问题是因为普通页面依赖的mtop是在vendors.js就打平初始化好的，没有循环依赖问题  \n![](https",
    "chunk_order_index": 0,
    "full_doc_id": "doc-096209d1b232a99998fecfc8885e84a9"
  },
  "chunk-7e8a18f2c3378e95e867aec9e47b44dc": {
    "tokens": 1200,
    "content": "pi-weixin-mtop <- mpi-biz-flow-feature <- rxpi-user-tracker <- rxpi-fz-cps-access <- rxpi-mtop，这一个循环依赖导致独立分包下发起mtop请求时，rxpi-weixin-mtop还未初始化完成，所以首次发起请求报mtop.request找不到；\n\n普通页面没有问题是因为普通页面依赖的mtop是在vendors.js就打平初始化好的，没有循环依赖问题  \n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/162244/1719802845663-f0d38548-c688-4f41-b22d-add7c7e1abec.png)\n\n独立分包依赖自己分包内的npm  \n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/162244/1719802888355-4f12e6c4-8297-4dc1-910f-fb67e16dbab0.png)\n\n导致使用的时候再初始化，循环依赖导致首次初始化还没拿到\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/162244/1719802941949-4e26969c-4f4c-42d9-9495-b91349a1b491.png)\n\n## 四、关注点分析\n### 4.1【系统质量】\n#### 4.1.1 需求&设计评估\n**〖关注点1〗****是否涉及产品、技术方案评估？此核心的问题是什么，如何改进？**\n\n- [ ] **是，涉及**\n    - [ ] 需求评估遗漏\n    - [ ] 产品设计缺陷\n    - [ ] 系统架构设计缺陷\n        - [ ] 容错性不足 \n        - [ ] 单点，无冗余\n        - [ ] 缺乏自我保护\n        - [ ] 缓存设计不当\n        - [ ] 容量评估不足\n        - [ ] 非幂等设计\n        - [ ] 强弱依赖不合理\n        - [ ] 其他：__________\n- [x] 否，不涉及\n\n#### 4.1.2 代码质量\n**〖关注点1〗是否代码自身存在漏洞或BUG、代码健壮性是否存在问题等?**\n\n**〖问题分析〗**存在相关库引用循环依赖问题\n\n**〖改进点〗**修改rxpi-user-tracker的循环引用的写法，断掉循环引用链 done\n\n\n\n**〖关注点2〗****是否经过CodeReview？CodeReview阶段是否发现问题？为何没发现？**\n\n+ **是否经过CR**\n    - [x] 是\n    - [ ] 否\n    - [ ] 不涉及\n+ **是否设置合理的CR卡点**\n    - [x] 是\n    - [ ] 否\n    - [ ] 不涉及\n+ **CodeReview阶段是否发现问题？为何没发现？后续如何发现？**\n    - [ ] 是\n    - [x] 否\n    - [ ] 不涉及\n\n**〖问题分析〗**只有微信小程序编译时独立分包会受到这个影响，CR时无法发现循环依赖\n\n**〖改进点〗**\n\n+ 线下票下单页迁回主包编译时调研---**确定做普通分包，可能性能上会有一点损耗，200毫秒左右  **[@溪童](undefined/kehan.skh)** 7.30**\n    - 线下票下单页采用独立分包形式(飞猪内唯一场景)，线下链路目前处于维护状态\n    - 飞猪微信发布比较频繁，汽车票该场景已经半年未发布，如果每次都回归，负担比较重\n    - 独立分包有登陆逻辑，无法套壳，转化成分包编译时需要改造成本\n    - 目前该场景每日票量2000+\n\n\n\n**〖关注点3〗****测试阶段**\n\n+ **测试内容：**涉及的测试提交单、测试用例等\n+ **测试人员：**\n+ **是否经过测试验证**\n    - [ ] 是，验证环境\n        - [ ] 预发环境\n        - [ ] 日常环境\n    - [ ] 是，测试方法\n        - [ ] 单元测试\n        - [ ] 功能回归测试\n        - [ ] 集成测试/链路测试\n        - [ ] 验收测试\n    - [x] 否\n    - [ ] 不涉及\n+ **测试未发现原因是什么？后续如何改进？**\n    - [ ] 回归测试遗漏\n        - [ ] 手工回归测试用例遗漏\n        - [ ] 自动化未建设\n        - [ ] 自动化回归覆盖不足\n        - [ ] 其他：__________\n    - [ ] 新场景测试遗漏\n        - [ ] 功能测试用例遗漏，包括正常分支和异常分支\n        - [ ] 容灾兜底测试遗漏\n        - [ ] 客户端兼容性测试遗漏\n        - [ ] 埋点测试遗漏\n        - [ ] 性能测试遗漏，影响评估不足\n        - [ ] 安全测试遗漏\n    - [x] 其他：正常发版回归不覆盖该场景，行业侧未涉及功能",
    "chunk_order_index": 1,
    "full_doc_id": "doc-096209d1b232a99998fecfc8885e84a9"
  },
  "chunk-8343dcfde97e1ac1416b23aafaa9f4a7": {
    "tokens": 1200,
    "content": "[ ] 功能测试用例遗漏，包括正常分支和异常分支\n        - [ ] 容灾兜底测试遗漏\n        - [ ] 客户端兼容性测试遗漏\n        - [ ] 埋点测试遗漏\n        - [ ] 性能测试遗漏，影响评估不足\n        - [ ] 安全测试遗漏\n    - [x] 其他：正常发版回归不覆盖该场景，行业侧未涉及功能迭代也未回归\n\n**〖问题总结〗**正常发版回归是仅回归核心链路场景，不涵盖汽车票线下票场景。\n\n**〖改进点〗**无论是否涉及行业功能迭代，建议业务QA针对行业核心链路进行测试回归，建立自动化测试用例 [@凝越](undefined/joy.cxy)  7月底人工回归，8月中旬完成自动化测试用例\n\n#### 4.1.3 变更质量\n+ **是否涉及变更：**\n    - [x] 是\n    - [ ] 否\n+ **变更类型：**\n    - [x] 代码发布\n    - [ ] 配置变更\n    - [ ] 其他变更：____________\n    - [ ] 不涉及\n+ **变更平台是否接入ChangeFree：**\n    - [ ] 是，CF变更单链接：________\n    - [x] 否：[https://fl-miniwork.fc.alibaba-inc.com/#/iter/detail?iterId=729](https://fl-miniwork.fc.alibaba-inc.com/#/iter/detail?iterId=729)\n+ **是否违反变更红线3.1**** **[链接](https://aliyuque.antfin.com/ngoc/fzg6dy/uar1k6)\n    - [ ] 是，违反哪条原则：\n    - [x] 否\n\n\n\n**〖关注点1〗****灰度阶段**\n\n+ **是否经过灰度：**\n    - [x] 是\n    - [ ] 否\n+ **观测了哪些监控**：\n    - [ ] 黑屏、白屏\n    - [ ] GOC监控：\n    - [ ] 系统大盘：\n    - [x] 其他：[_https://wedata.weixin.qq.com/mp2/js-error-list_](https://wedata.weixin.qq.com/mp2/js-error-list)_  微信后台链接_\n+ **是否灰度期间发现问题？**\n    - [ ] 是\n        - [ ] 是否灰度流量过大，导致故障\n        - [ ] 灰度发现但未有效或及时修复，导致故障\n        - [ ] 其他：___________\n    - [x] 否，后续如何灰度发现？____________\n+ **未灰度发现原因**\n    - [ ] 应用灰\n        - [ ] 灰度流量太小\n        - [ ] 灰度阶段无监控\n        - [ ] 灰度批次不合理\n        - [ ] 超长时间灰度才能发现\n    - [ ] 业务灰：策略不合理\n    - [ ] 灰度无法发现\n    - [x] 其他：____行业侧阈值不合理，平台侧未收到错误上报_________\n\n**〖问题总结〗**报错被catch住了，后台看不到报错信息；行业侧的量级太小，未触发阈值报警\n\n**〖改进点〗**\n\n1. 行业前端上报js错误并监控 [@溪童](undefined/kehan.skh) 7.19\n2. 改进订单创建成功量监控阈值 done 后续仍需继续观察，看是否需要把时间调长来看\n\n[https://x.alibaba-inc.com/custom/59/product/preview/spm/15505](https://x.alibaba-inc.com/custom/59/product/preview/spm/15505)\n\n\n\n**〖关注点2〗****上线阶段**\n\n+ **是否有确定的监控观测指标**\n    - [x] 是，监控指标及监控链接：[https://wedata.weixin.qq.com/mp2/js-error-list](https://wedata.weixin.qq.com/mp2/js-error-list)\n    - [ ] 否\n+ **是否在窗口期进行发布变更**\n    - [ ] 是\n    - [x] 否，原因：原迭代相关问题回归修改延至629下午发布\n+ **变更是否影响上下游**\n    - [x] 是，是否有提前知会上下游评估及关注变更\n        - [x] 有提前知会\n        - [ ] 没有提前知会\n    - [ ] 否\n\n**〖问题总结〗**周四集成，正常周五推流\n\n**〖改进点〗**暂无\n\n### 4.2【处置能力】\n#### 4.2.1 故障发现&响应\n+ **是否监控发现**\n    - [ ] 故障触发方 监控发现\n    - [ ] 故障受影响方 监控发现\n    - [x] 否，原因为：（监控无效/监控缺失）\n+ **是否5分钟内响应**\n    - [x] 是\n    - [ ] 否，原因为：\n+ **是否存在应急协同问题**\n    - [ ] 是\n        - [ ] 应急流程不明确（无流程或者流程不清晰、应急相关",
    "chunk_order_index": 2,
    "full_doc_id": "doc-096209d1b232a99998fecfc8885e84a9"
  },
  "chunk-3bde69cf149f81f689d7c9a76bedc2ae": {
    "tokens": 888,
    "content": "发现\n    - [ ] 故障受影响方 监控发现\n    - [x] 否，原因为：（监控无效/监控缺失）\n+ **是否5分钟内响应**\n    - [x] 是\n    - [ ] 否，原因为：\n+ **是否存在应急协同问题**\n    - [ ] 是\n        - [ ] 应急流程不明确（无流程或者流程不清晰、应急相关角色&职责不明确，缺失一号位等)\n        - [ ] 应急执行不到位（有流程，但未按流程执行，通告发送不及时，响应不及时等）\n    - [x] 否\n\n**〖问题总结〗**报错被catch住了，后台看不到报错信息；行业侧的量级太小，未触发阈值报警\n\n**〖改进点〗**_****_\n\n1. 前端业务页面js报错预警  [@溪童](undefined/kehan.skh) 7.19\n2. 订单创建量监控阈值需要修改，提高主动发现问题的能力  done\n\n**      **服务端监控链路：[**https://x.alibaba-inc.com/custom/59/product/preview/spm/15505**](https://x.alibaba-inc.com/custom/59/product/preview/spm/15505)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/154706/1720406459101-5d06a157-0659-44a9-b8ff-43f7773c9dcc.png)\n\n#### 4.2.2 故障定位&恢复\n+ **主要恢复方式：**\n    - [x] 代码发布/回滚\n    - [ ] 配置发布/回滚\n    - [ ] 数据订正\n    - [ ] 机器隔离/重启/扩容\n    - [ ] 配置限流\n    - [ ] 预案降级\n    - [ ] 自动恢复\n    - [ ] 其他：\n\n**〖关注点1〗定位&恢复阶段存在什么问题？是否可以增加预案，****有更快的恢复方式？****相关的优化改进？**\n\n**〖问题总结〗**暂无\n\n## 五、故障Action\n| **序号** | *******Action** | *******负责人** | *******计划完成时间** | **是否keyAction** | **备注** |\n| :---: | --- | :---: | :---: | --- | --- |\n| 1 | ~~短期：线下票下单页微信小程序做普通分包~~ | [@溪童](undefined/kehan.skh) | ~~7.30~~ | ~~是~~ | ~~进行时发现是无关因素，本action取消，weixn-mtop初始化问题因历史原因改动量成本较高，故增加循环依赖报警action~~ |\n| 2 | 短期：汽车票行业建立自动化测试用例 | [@凝越](undefined/joy.cxy) |   7月底人工回归，8月中旬完成自动化测试用例 | 是 |  |\n| 3 | 短期：小程序发布的测试环节SLA说明什么时候由行业自行决定是否回归，什么情况下平台告知要回归 | [@桑陆](undefined/yangjinfeng.yjf)[@桥延](undefined/qiaoyan.yf) | 7.30 |  |  |\n| 4 | 短期：前端业务页面js报错预警 | [@溪童](undefined/kehan.skh) | 7.19 |  |  |\n| 5 | 短期：平台侧检查行业自动化测试case是否有遗漏 | [@桥延](undefined/qiaoyan.yf) | 7.30 |  |  |\n| 6 | 长期：循环依赖报警 | [@阿劭](undefined/tianjie.stj) | S2进行 |  |  |",
    "chunk_order_index": 3,
    "full_doc_id": "doc-096209d1b232a99998fecfc8885e84a9"
  },
  "chunk-492a36783f29ee43c5522389200baf58": {
    "tokens": 1200,
    "content": "## 一、故障简述（含影响产品线及影响面）\n##### 故障概述：\n2024年7月3日12:05监控预警四海通推广发券成功率下跌，影响渠道方给用户发券，调用诸葛接口的业务也受到相应影响，故障原因初步确认是tripcrowd系统（诸葛）导致，于12:18 device_utdid_mapping表请求量下降之后，故障恢复，期间无客诉，根据故障场景定义，监控下跌幅度达P4故障等级。\n\n##### 影响面：\n- [x] 是否影响可用性：否\n- [x] 业务影响：\n+ 四海通：发券接口报错，渠道方调用给用户发券失败。\n+ 四海通推广发券成功率低于85%，最低下跌至36%，持续11分钟\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/312832/1720097927250-dddd842f-c97a-4a8e-83d5-879fd1861655.png)\n\n+ 诸葛：飞猪域接入人群匹配、特征值查询、设备匹配的平台以及业务，调用诸葛接口成功率下跌。\n+ 人群判定、特征值查询服务成功率下跌25%，持续12分钟。![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/17675/1720083098658-06976da1-88fa-4041-ba4e-5c94ce110b11.png)\n- [x] 是否有客诉：否\n- [x] 是否有社会舆情_：_否\n- [x] 是否产生资损：否\n\n## 二、故障过程回顾\n2024-06-28 15:35，设备新判断功能上线，问题代码发布，实时更新逻辑上线（业务场景未上线，线上实际没有调用量）**【风险注入】**\n\n2024-07-01 00:00，暑期退改保障活动上线（业务场景上线，umid为String[null] 与大量utdid的问题关联脏数据开始写入），活动上线后报出存在误判问题，业务暂停投放，后排查初步发现有较多误更新\n\n2024-07-01 04:43：关闭实时更新设备功能（问题关联数据停止写入），线上数据回写，但主键为null的数据没有被覆盖\n\n2024-07-03 12:05,  因为表优先级低，odps资源不足，设备新底层lindorm表device_utdid_mapping延时到中午开始dump，索引表构建产生大量读，lindorm查询rt升高，诸葛25%的机器hsf线程池满以及提供的服务失败\n2024-07-03 12:07，四海通推广发券成功率下跌预警，GOC拉起风险预警群**【故障发现】**\n\n2024-07-03 12:08，诸葛sunfire hsf成功率下跌告警![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/17675/1720420632402-79ac3f94-df06-4827-b92c-b04b81579d55.png)\n\n2024-07-03 12:10，四海通发现是玩法平台失败，玩法发现是诸葛平台失败，诸葛开始处理**【业务响应】**\n\n2024-07-03 12:10，部分机器线程池满，初步判断系统负载高导致**【初因定位】**\n\n2024-07-03 12:10，操作扩容50台，12:14第一批扩容完成，成功率上升但故障未恢复，12:16提交第二批扩容60台**【恢复执行】**\n\n扩容有效果，但本质上不是扩容修复的问题\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/17675/1720083454665-0385a168-86ce-4475-a0c2-adbbaab84914.png)![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/17675/1720083098658-06976da1-88fa-4041-ba4e-5c94ce110b11.png)lindorm同步完成，性能提升\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/17675/1720087793820-df1b8358-8de1-47e4-92e1-2e72c0b87de8.png)\n\n2024-07-03 12:14,  四海通发券接口成功率持续10分钟小于80%（12:05-12:14），触发P4**【故障发生】**\n\n2024-07-03 12:18，四海通侧判断接口异常恢复，监控恢复至正常水位，故障恢复**【故障恢复】**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/41240/1720405927933-a6dc2812-1d44-4ab7-beed-54353",
    "chunk_order_index": 0,
    "full_doc_id": "doc-ef5fe5282428a5de0719bf54a1ccfdcf"
  },
  "chunk-3340137edefa8e916dcc3985812cb05b": {
    "tokens": 1200,
    "content": ":14），触发P4**【故障发生】**\n\n2024-07-03 12:18，四海通侧判断接口异常恢复，监控恢复至正常水位，故障恢复**【故障恢复】**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/41240/1720405927933-a6dc2812-1d44-4ab7-beed-54353ae0b501.png)\n\n2024-07-03 17:00，定位到是因为代码Bug，写入了大量 umid=String[null] 与utdid的关联关系，入参umid为null时过量请求utdid信息，当lindorm性能抖动时系统崩溃导致故障发生**【根因定位】**\n\n2024-07-03 18:00，更新lindorm表中异常数据**【影响消除】**\n\n## 三、故障原因\n### 3.1【背景说明】\n[https://aliyuque.antfin.com/qnwrq9/gkkliw/limh30vg83dlsogx](https://aliyuque.antfin.com/qnwrq9/gkkliw/limh30vg83dlsogx)，暑促10亿退改保障项目，通过诸葛提供设备下载新判定服务\n\n+ 业务链路：\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/17675/1720413159265-e715f235-16db-43bd-a7e6-d66b68a6c3dd.png)\n\n\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/226004/1720169361716-4f612e8a-447f-477c-a3b5-b91f7cd84f60.png)\n\n### 3.2【原因分析】\n##### 一句话原因：\n设备下载新实时写入了大量脏数据：umid=String[null] 与utdid的关联关系；入参umid为null时过量请求utdid信息；当lindorm性能抖动时系统崩溃\n\n##### 根因分析：\n业务代码逻辑：\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/17675/1720416540030-7fb2b165-9c62-4731-8124-6372ba37c014.png)\n\n1. 在查询1的过程中，当业务入参umid=null时，诸葛会将其解析成一个null字符串入参，作为key查lindorm来获取关联utdid，而后续业务逻辑处理设备新判断umid和utdid没有关联关系时，向umid追加一个utdid关联，因此代码上线时，向lindorm中写入大量null与真实utdid的关联关系，核心问题代码：\n\n![上游参数](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/17675/1720418877546-4d2691dd-2dd5-4c37-8dcd-338006b55375.png)\n\n![null字符串注入](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/17675/1720085186293-f22edcb4-a63f-4f16-bf0d-0772f72027ec.png)\n\n实际写入umid对应utdid列表：\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/17675/1720418947999-0d91b301-c8b6-4de1-a572-d0520bd820b4.png)\n\nnull脏数据\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/17675/1720084960267-b644be03-b6c0-4216-a7ab-141e65c91861.png)\n\n2. 查询2代码逻辑会使用查询出的utdid列表（代码限制最多200个）查lindorm获取对应utdid的详细信息，for循环查\n\n正常lindorm查询rt 2ms，整体rt达400ms+。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/17675/1720085500382-382839f6-b65a-46f4-ac67-dcc7f5885346.png)\n\n而诸葛的标签查询默认使用CompletableFuture.supplyAsync，默认分配核数(4)-1=3个线程，JVM级别共用\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/17675/1720085885907-63c8953b-459c-4978-bb61-69e020098b5b.png)\n\nlindorm数据12点开始dump，性能抖动，大量hsf调用堵塞在标签查询，机器线程池满，引发故障\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/17675/1720056456202-e75b304c-05e9-4543-afd7-833f719b6fd8.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/17675/172008773825",
    "chunk_order_index": 1,
    "full_doc_id": "doc-ef5fe5282428a5de0719bf54a1ccfdcf"
  },
  "chunk-6810beccbdb398789be2fe25ca94bc9a": {
    "tokens": 1200,
    "content": "调用堵塞在标签查询，机器线程池满，引发故障\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/17675/1720056456202-e75b304c-05e9-4543-afd7-833f719b6fd8.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/17675/1720087738256-e94b678d-5606-4e1b-b75b-871599c20e1d.png)\n\n## 四、关注点分析\n### 4.1【系统质量】\n#### 4.1.1 需求&设计评估\n**〖关注点1〗****是否涉及产品、技术方案评估？此核心的问题是什么，如何改进？**\n\n- [ ] **是，涉及**\n    - [ ] 需求评估遗漏\n    - [ ] 产品设计缺陷\n    - [ ] 系统架构设计缺陷\n        - [ ] 容错性不足 \n        - [ ] 单点，无冗余\n        - [ ] 缺乏自我保护\n        - [ ] 缓存设计不当\n        - [ ] 容量评估不足\n        - [ ] 非幂等设计\n        - [ ] 强弱依赖不合理\n        - [ ] 其他：__________\n- [x] 否，不涉及\n\n#### 4.1.2 代码质量\n**〖关注点1〗是否代码自身存在漏洞或BUG、代码健壮性是否存在问题等?**\n\n**〖问题分析〗**6.28新设备判定功能存在Bug，传入为null时不应该更新、查询lindorm\n\n**〖改进点〗**\n\n1、对接入入参进行校验，过滤不符合业务规则的参数，不符合业务规则的参数不应该更新到lindorm。线上异常数据已删除，代码Bug已修复待发布 [@见羽](undefined/jianxiang.hjx) 7.11\n\n2、IO密集型操作分配线程数不足，吞吐能力不够，后续需增加线程：min24 - max360 [@见羽](undefined/jianxiang.hjx) 7.11\n\n\n\n**〖关注点2〗****是否经过CodeReview？CodeReview阶段是否发现问题？为何没发现？**\n\n+ **是否经过CR**\n    - [x] 是\n    - [ ] 否\n    - [ ] 不涉及\n+ **是否设置合理的CR卡点**\n    - [x] 是\n    - [ ] 否\n    - [ ] 不涉及\n+ **CodeReview阶段是否发现问题？为何没发现？后续如何发现？**\n    - [ ] 是\n    - [x] 否\n    - [ ] 不涉及\n\n**〖问题分析〗**null注入是之前项目提交，当前项目没有CR到；之前项目提交时，CR不够细致未判断到未来影响。\n\n**〖改进点〗**_****_\n\n诸葛后续需求均组织正式CR，有CR记录，CR同学 \n\n+ 理解需求逻辑\n+ 对所有代码：以各种异常case判断代码健壮程度；如果代码层次比较基础，评估对未来、整体性能影响\n+ 需要单测覆盖逻辑，开发同学提供单测工具\n\n\n\n**〖关注点3〗****测试阶段**\n\n+ **测试内容：**[https://aliyuque.antfin.com/guideqa/dz0yge/mzi7dd0pkl3wlaqh](https://aliyuque.antfin.com/guideqa/dz0yge/mzi7dd0pkl3wlaqh)\n+ **测试人员：**夙鸢\n+ **是否经过测试验证**\n    - [x] 是，验证环境\n        - [x] 预发环境\n        - [ ] 日常环境\n    - [ ] 是，测试方法\n        - [ ] 单元测试\n        - [ ] 功能回归测试\n        - [ ] 集成测试/链路测试\n        - [ ] 验收测试\n    - [ ] 否\n    - [ ] 不涉及\n+ **测试未发现原因是什么？后续如何改进？**\n    - [ ] 回归测试遗漏\n        - [ ] 手工回归测试用例遗漏\n        - [ ] 自动化未建设\n        - [ ] 自动化回归覆盖不足\n        - [ ] 其他：__________\n    - [ ] 新场景测试遗漏\n        - [x] 功能测试用例遗漏，包括正常分支和异常分支\n        - [ ] 容灾兜底测试遗漏\n        - [ ] 客户端兼容性测试遗漏\n        - [ ] 埋点测试遗漏\n        - [ ] 性能测试遗漏，影响评估不足\n        - [ ] 安全测试遗漏\n    - [ ] 其他：__________\n\n**〖问题总结〗**测试用例有包括无umid的情况，但是入参需要覆盖两个场景，一种是umid：null，另一种是参数无umid的情况，仅测试了无umid参数的情况，未覆盖umid：null的情况。\n\n**〖改进点〗**_****_\n\n1、诸葛系统对外暴露接口压测，确认单机性能，确认线上单机限流配置正确 [@夙鸢](undefined/suyan.s",
    "chunk_order_index": 2,
    "full_doc_id": "doc-ef5fe5282428a5de0719bf54a1ccfdcf"
  },
  "chunk-699e046e0ff4a4a72ec1fcd8df400d59": {
    "tokens": 1200,
    "content": "例有包括无umid的情况，但是入参需要覆盖两个场景，一种是umid：null，另一种是参数无umid的情况，仅测试了无umid参数的情况，未覆盖umid：null的情况。\n\n**〖改进点〗**_****_\n\n1、诸葛系统对外暴露接口压测，确认单机性能，确认线上单机限流配置正确 [@夙鸢](undefined/suyan.ssy) 7.12\n\n2、非新增接口也需要对异常入参进行测试，针对诸葛接口异常入参进行梳理并check人群匹配接口和match接口 [@夙鸢](undefined/suyan.ssy) 7.17\n\n#### 4.1.3 变更质量\n+ **是否涉及变更：**\n    - [x] 是\n    - [ ] 否\n+ **变更类型：**\n    - [x] 代码发布\n    - [ ] 配置变更\n    - [ ] 其他变更：____________\n    - [ ] 不涉及\n+ **变更平台是否接入ChangeFree：**\n    - [x] 是，CF变更单链接：_[https://aicf.alibaba-inc.com/aicf/change/v2/detail/1059960614?spm=goc-apm.aicf-_changeList.0.0.7e3c23883Osush](https://aicf.alibaba-inc.com/aicf/change/v2/detail/1059960614?spm=goc-apm.aicf-_changeList.0.0.7e3c23883Osush)\n    - [ ] 否\n+ **是否违反变更红线3.1**** **[链接](https://aliyuque.antfin.com/ngoc/fzg6dy/uar1k6)\n    - [ ] 是，违反哪条原则：\n    - [x] 否\n\n\n\n**〖关注点1〗****灰度阶段**\n\n+ **是否经过灰度：**\n    - [x] 是\n    - [ ] 否\n+ **观测了哪些监控**：__\n    - [ ] 黑屏、白屏\n    - [ ] GOC监控：\n    - [ ] 系统大盘：\n    - [x] 其他：业务大盘 [https://xflush.alibaba-inc.com/custom/59/product/preview/multiMinute/9886](https://xflush.alibaba-inc.com/custom/59/product/preview/multiMinute/9886)\n+ **是否灰度期间发现问题？**\n    - [ ] 是\n        - [ ] 是否灰度流量过大，导致故障\n        - [ ] 灰度发现但未有效或及时修复，导致故障\n        - [ ] 其他：___________\n    - [x] 否，后续如何灰度发现？_____________\n+ **未灰度发现原因**\n    - [ ] 应用灰\n        - [ ] 灰度流量太小\n        - [ ] 灰度阶段无监控\n        - [ ] 灰度批次不合理\n        - [ ] 超长时间灰度才能发现\n    - [ ] 业务灰：策略不合理\n    - [ ] 灰度无法发现\n    - [x] 其他：灰度期间lindorm系统正常未发现\n\n**〖问题总结〗**灰度中无流量，未发现此异常数据\n\n\n\n**〖关注点2〗****上线阶段**\n\n+ **是否有确定的监控观测指标**\n    - [x] 是，监控指标及监控链接：[https://xflush.alibaba-inc.com/custom/59/product/preview/multiMinute/9886](https://xflush.alibaba-inc.com/custom/59/product/preview/multiMinute/9886)\n    - [ ] 否\n+ **是否在窗口期进行发布变更**\n    - [ ] 是\n    - [x] 否，原因：630大促需求时间紧，在周五6.28发布\n+ **变更是否影响上下游**\n    - [x] 是，是否有提前知会上下游评估及关注变更\n        - [x] 有提前知会\n        - [ ] 没有提前知会\n    - [ ] 否\n\n### 4.2【处置能力】\n#### 4.2.1 故障发现&响应\n+ **是否监控发现**\n    - [ ] 故障触发方 监控发现\n    - [x] 故障受影响方 监控发现\n    - [ ] 否，原因为：（监控无效/监控缺失）\n+ **是否5分钟内响应**\n    - [x] 是\n    - [ ] 否，原因为：\n+ **是否存在应急协同问题**\n    - [ ] 是\n        - [ ] 应急流程不明确（无流程或者流程不清晰、应急相关角色&职责不明确，缺失一号位等)\n        - [ ] 应急执行不到位（有流程，但未按流程执行，通告发送不及时，响应不及时等）\n    - [x] 否\n\n**〖问题总结〗**故障触发方未第一时间发现，四海通的预警12:07，诸葛的监控预警12:08报出\n\n**〖改进点〗**_****_\n\n1、hsf线程池满接口日志不能及时采集并报警：增加预警：10%机器",
    "chunk_order_index": 3,
    "full_doc_id": "doc-ef5fe5282428a5de0719bf54a1ccfdcf"
  },
  "chunk-6939fccc0f963b911072a81c445852c8": {
    "tokens": 1200,
    "content": "流程，但未按流程执行，通告发送不及时，响应不及时等）\n    - [x] 否\n\n**〖问题总结〗**故障触发方未第一时间发现，四海通的预警12:07，诸葛的监控预警12:08报出\n\n**〖改进点〗**_****_\n\n1、hsf线程池满接口日志不能及时采集并报警：增加预警：10%机器hsf线程池高于200、10%机器hsf成功率低于90% 且增加电话通知的方式 [@见羽](undefined/jianxiang.hjx) 7.11\n\n2、四海通发券错误日志不完善，补充sls错误信息以及对应出入参，便于更快定位问题 done 7.3\n\n#### 4.2.2 故障定位&恢复\n+ **主要恢复方式：**\n    - [ ] 代码发布/回滚\n    - [ ] 配置发布/回滚\n    - [x] 数据订正\n    - [x] 机器隔离/重启/扩容\n    - [ ] 配置限流\n    - [ ] 预案降级\n    - [ ] 自动恢复\n    - [ ] 其他：\n\n**〖关注点1〗定位&恢复阶段存在什么问题？是否可以增加预案，****有更快的恢复方式？****相关的优化改进？**\n\n**〖问题总结〗**缺乏干预手段，发券依赖于下游发放，目前没有预案\n\n**〖改进点〗**详见关注点2\n\n\n**〖关注点2〗业务自身是否具备容灾逃逸能力？后续如何改进？**__\n\n- [ ] 具备容灾能力\n    - [ ] 因未演练不敢执行\n    - [ ] 因有损评估决策不执行\n    - [ ] 无决策或者决策不当，未执行\n- [x] 不具备容灾能力\n\n**〖问题总结〗**缺乏容灾、降级能力\n\n**〖改进点〗**\n\n诸葛系统：[@见羽](undefined/jianxiang.hjx) \n1、诸葛建立预案降级能力：来源应用分级，非重点人群统一限流预案 7.31  keyaction\n2、按照人群申请重保，非重保人群查询缓存降级 7.31\n3、三方依赖熔断机制：lindorm、三方服务高rt熔断能力建设（系统维度熔断） 8.20 keyaction\n4、指定人群、标签快速失败（应用维度熔断）7.31\n四海通：[@琦诺](undefined/zhangxinzhe.zxz)[@及明](undefined/wgj267254)[@皆非](undefined/hewenyong.hwy)\n\n1、四海通补充发券降级预案，当下游报错时，返回提示文案，提醒用户稍后领取 7.31\n2、top接口限流是已有能力，需制定预案 7.31\n\n## 五、故障Action\n| **序号** | *******Action** | *******负责人** | *******计划完成时间** | **是否keyAction** |\n| :---: | --- | :---: | :---: | --- |\n| 1 | 短期：代码Bug修复 | [@见羽](undefined/jianxiang.hjx) | 7.11 | 否 |\n| 2 | 短期：增加线程 | [@见羽](undefined/jianxiang.hjx) | 7.11 | 否 |\n| 3 | 短期：诸葛系统对外暴露接口压测 | [@夙鸢](undefined/suyan.ssy) | 7.12 | 否 |\n| 4 | 短期：增加测试用例 | [@夙鸢](undefined/suyan.ssy) | 7.17 | 否 |\n| 5 | 短期：增加hsf线程池电话告警 | [@见羽](undefined/jianxiang.hjx) | 7.11 | 否 |\n| 6 | 短期：诸葛建立预案：非重点人群统一限流 | [@见羽](undefined/jianxiang.hjx) | 7.31 | 是 |\n| 7 | 短期：诸葛非重保人群查询缓存降级 | [@见羽](undefined/jianxiang.hjx) | 7.31 | 否 |\n| 8 | 短期：建立诸葛应用维度熔断机制：指定人群，标签快速失败 | [@见羽](undefined/jianxiang.hjx) | 7.31 | 否 |\n| 9 | 短期：四海通建立发券降级预案 | [@琦诺](undefined/zhangxinzhe.zxz)[@及明](undefined/wgj267254)[@皆非](undefined/hewenyong.hwy) | 7.31 | 否 |\n| 10 | 短期：四海通建立top接口限流预案 | [@琦诺](undefined/zhangxinzhe.zxz)[@及明](undefined/wgj267254)[@皆非](undefined/hewenyong.hwy",
    "chunk_order_index": 4,
    "full_doc_id": "doc-ef5fe5282428a5de0719bf54a1ccfdcf"
  },
  "chunk-89f8db061f0453ed19f4a8f0bbe3c39f": {
    "tokens": 148,
    "content": "诺](undefined/zhangxinzhe.zxz)[@及明](undefined/wgj267254)[@皆非](undefined/hewenyong.hwy) | 7.31 | 否 |\n| 10 | 短期：四海通建立top接口限流预案 | [@琦诺](undefined/zhangxinzhe.zxz)[@及明](undefined/wgj267254)[@皆非](undefined/hewenyong.hwy) | 7.31 | 否 |\n| 11 | 长期：建立诸葛系统维度熔断机制 | [@见羽](undefined/jianxiang.hjx) | 8.20 | 是 |",
    "chunk_order_index": 5,
    "full_doc_id": "doc-ef5fe5282428a5de0719bf54a1ccfdcf"
  },
  "chunk-d4251c7777d55dc8ffbd5a4b34e802ad": {
    "tokens": 1200,
    "content": "## 一、故障简述（含影响产品线及影响面）\n##### 故障概述：\n2024年7月17日20:12监控预警飞猪_互动玩法兑换成功率异常，同时签到发奖、小蜜转人工、用户进线均受到影响，故障原因确认是tair异常导致，于20:36tair剔除异常机器后完成止血，监控基本恢复至tair异常前水平，故障恢复，期间暂未收到集中客诉，根据监控下跌幅度判定，达P4故障等级。\n\n##### 影响面：\n- [x] 是否影响可用性：否\n- [x] 业务影响：\n1. **飞猪_互动玩法兑换成功率异常**：[https://tr.alibaba-inc.com/ormEmergency/workbench/dashboard/202407170000002717001?__tenant__=alibabaGroup&activeTabKey=summaryDetail&dutyGroupId=6696&entrance=STARE&parentId=-1&statusCodes=1%2C2](https://tr.alibaba-inc.com/ormEmergency/workbench/dashboard/202407170000002717001?__tenant__=alibabaGroup&activeTabKey=summaryDetail&dutyGroupId=6696&entrance=STARE&parentId=-1&statusCodes=1%2C2)  [@翊霖](undefined/yilin.yy)\n\n业务影响：兑换成功率日常在90%左右，受影响时段：8:11-8:35，持续25分钟，最低跌至2%左右**（8:12-8:35均在60%以下，触发P4）**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/41240/1721701448798-68f6be21-aeeb-494f-b10a-9a5d136c05d9.png)\n\n2. **飞猪签到动作接口总量异常**：[https://tr.alibaba-inc.com/ormEmergency/workbench/dashboard/202407170000002716001?__tenant__=alibabaGroup&activeTabKey=summaryDetail&dutyGroupId=6696&entrance=STARE&parentId=-1&statusCodes=1%2C2](https://tr.alibaba-inc.com/ormEmergency/workbench/dashboard/202407170000002716001?__tenant__=alibabaGroup&activeTabKey=summaryDetail&dutyGroupId=6696&entrance=STARE&parentId=-1&statusCodes=1%2C2) [@林幽](undefined/zijian.gzj)\n\n业务功能影响：签到发奖成功率从8:11-8:35下跌到90%以下，最低89%，持续25分钟，未触发故障\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/61442/1721702180473-9136b4ff-00f0-4e4c-9b0c-b8853545b197.png)\n\n3. **阿里小蜜转人工**成功率监控（排除钉钉）_集群维度：[https://tr.alibaba-inc.com/ormEmergency/workbench/dashboard/202407170000002757001?__tenant__=alibabaGroup&activeTabKey=summaryDetail&dutyGroupId=6696&entrance=STARE&parentId=-1&statusCodes=1%2C2](https://tr.alibaba-inc.com/ormEmergency/workbench/dashboard/202407170000002757001?__tenant__=alibabaGroup&activeTabKey=summaryDetail&dutyGroupId=6696&entrance=STARE&parentId=-1&statusCodes=1%2C2) [@筱和](undefined/heyuru.hyr)\n\n业务功能影响：小蜜转人工，20:13-20:35成功率最低跌至82%，持续23分钟，总共失败36个，未触发故障\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/10556352/1721285758452-98e3a4ec-e0be-4fed-9291-d96577da1d68.png)\n\n4. **进线异常（飞猪）**：[https://tr.alibaba-inc.com/ormEmergency/workbench/dashboard/202407170000002752001?__tenant__=alibabaGroup&activeTabKey=summaryDetail&dutyGroupId=6696&entrance=STARE&parentId=-1&statusCodes=1%2C2](https://tr.alibaba-inc.com/ormEmergency/workbench/dashboard/202407170000002752001?__tenant__=alibabaGroup&activeTabKey=summaryDetail&dutyGroupId=6696&entrance=STARE&parentId=-1&statusCodes=1%2C2)  [@筱和](undefined/heyuru.hyr)\n\n业务功能影响：用户进线，20:13-20:35成功率最低跌至80%，持续23分钟，总共失败44个，和小蜜转人工是同一个场景，未触发故障\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/10556352/1721285830492-6624a2fa-49f1-46c7-adfc-42cc9a4ccaef.png)\n\n- [x] 是否有客诉：未有集中",
    "chunk_order_index": 0,
    "full_doc_id": "doc-b99ffa97f10cf7921cbcb6398cd9724c"
  },
  "chunk-7eb7b95aa337a80ebcf1c51bd62f504b": {
    "tokens": 1200,
    "content": "最低跌至80%，持续23分钟，总共失败44个，和小蜜转人工是同一个场景，未触发故障\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/10556352/1721285830492-6624a2fa-49f1-46c7-adfc-42cc9a4ccaef.png)\n\n- [x] 是否有客诉：未有集中客诉\n- [x] 是否有社会舆情_：_否\n- [x] 是否产生资损：否\n\n## 二、故障过程回顾\n2024-07-17 20:14，飞猪风险预警群内推出预警卡片：飞猪签到动作接口总量异常**【飞猪侧故障发现】** \n\n2024-07-17 20:15，飞猪风险预警群内推出预警卡片：飞猪_互动玩法兑换成功率异常，同时飞猪签到动作接口总量异常已拉起风险预警群**【飞猪侧业务响应】**\n\n2024-07-17 20:16，tair单机出现compact报警\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/16378/1721221482724-dfc19641-2936-4625-a441-908fdfc8b16c.png)\n\n2024-07-17 20:21，飞猪_互动玩法兑换成功率异常升级为故障，持续10分钟成功率<=60%，失败量>50（20:12-20:21），触发P4**【故障发生】**\n\n2024-07-17 20:23，飞猪同学在tair用户群反馈tair rt升高，同时GOC监控值班发起电话会议拉相关人员入会排查**【Tair侧业务响应】**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/16378/1721221582587-e6345fa5-e3d4-4aff-9952-06e9ed2fa304.png)\n\n2024-07-17 20:25，飞猪同学推了降级开关，对四海通链路用户来访上报做了降级（这是另一个对权益中心有调用的链路），减少对底层权益中心的调用，防止上游重试造成雪崩  \n2024-07-17 20:30，飞猪风险预警群内推出预警卡片：飞猪进线异常  \n\n2024-07-17 20:32，tair侧定位到异常的一台机器 **【****Tair侧****初因定位】** \n\n2024-07-17 20:35，tair侧剔除异常机器**【****Tair侧****恢复执行】**\n\n2024-07-17 20:36，飞猪风险预警群内推出预警卡片：阿里小蜜转人工成功率监控（排除钉钉）_集群维度  \n\n2024-07-17 20:36，监控基本恢复至tair异常前的水平**【故障恢复】**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/16378/1721221188954-ca897fd7-89f2-49ac-911a-77bba66401f8.png)\n\n## 三、故障原因\n### 3.1【背景说明】\n**飞猪业务背景：**\n\n为打造飞猪暑促心智券：用户在各渠道点领券包凭证，若用户符合规则获得高价值券包，否则获得兜底券包，领取的所有券用抽屉的展示方式聚拢。\n\n业务上线时间：6.22\n\n**业务调用链路：**\n\n用户点领后触发飞猪玩法做规则校验，校验通过后查询(扣减)活动权益组库存，库存由tair实现。\n\n### 3.2【原因分析】\n##### 一句话原因：\n未知原因导致一台Tair服务器的机器CPU、Load异常，直接导致sst不断堆积，恰巧该集群来了一波异常remove流量(来源ns: 1816, [tair实例](http://tiddo.alibaba-inc.com/saas-tair/#/InstanceDetail?username=67494bcd912a4370))，倾斜最明显的流量恰好打到该机器上，造成单机雪崩，用户的异常倾斜流量是造成雪崩的直接原因。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/16378/1721221316432-c71ad983-6a94-47e7-81e7-c9f0583a2229.png)\n\n同时业务的访问模式是一次读出16张优惠券的信息，串行读，读到任何一张卡住就整体卡住了。这个时候，有一张优惠券落到问题ds，就会造成很多卡住的情况。\n\n:::info\n**--排查下是16个key全部跌0，还是某个key跌0引发全部失败，群内同步进展 **[@翊霖](undefined/yilin.yy)** **\n\n7.23群内同步结论： 只有一个库存key有问题，但是在故",
    "chunk_order_index": 1,
    "full_doc_id": "doc-b99ffa97f10cf7921cbcb6398cd9724c"
  },
  "chunk-78af52f6f114e2917925eedbf701d6dc": {
    "tokens": 1200,
    "content": "读，读到任何一张卡住就整体卡住了。这个时候，有一张优惠券落到问题ds，就会造成很多卡住的情况。\n\n:::info\n**--排查下是16个key全部跌0，还是某个key跌0引发全部失败，群内同步进展 **[@翊霖](undefined/yilin.yy)** **\n\n7.23群内同步结论： 只有一个库存key有问题，但是在故障期间，用户的16张券没有一张到账的，因为我们有逻辑，只要有一个权益组的库存存在问题，整个活动都不发(玩法底层有按优先级兑换的逻辑，所以一个失败，可能发了一个低优先级的权益给用户)  \n\n:::\n\n##### 根因分析：\n飞猪 ldb 集群 trip_dtair_na62_center 单台机器的 rt 飙高，引发业务方访问 tair 的成功率下降，剔除(11.177.204.64)异常机器后业务恢复。\n\n1. ds有明显的cpu分层，出问题的那台机器在恶化之前Load和CPU水位都已经比较高了。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/16378/1721221202015-ca4725cd-91c7-40bb-ab5b-e610998042b0.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/16378/1721221254551-afd152aa-4dce-4fa1-9ce0-e5a732e47f74.png)\n\n由于容器已经被下线，只能从物理机角度以及监控角度进行分析。\n\n**物理机角度：**\n\n由相关同学确认问题时刻前后无硬件故障。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/135556484/1721357713732-86b0bf84-afbb-4d49-a696-bdc37a41e3fb.png)\n\n**监控角度**：\n\n单机流量正常，后台的compact任务可能会导致Load和CPU上涨。相关指标当前缺失，后续会加入inst级别的compact读写吞吐监控以辅助排查。\n\n**action1：增加容器维度监控（rt\\cpu\\Load） 8.2 **[@谷川](undefined/jilong.yjl)\n\n**action2：增加实例维度监控，飞猪可自行配置使用  8.31 **[@谷川](undefined/jilong.yjl)\n\n2. 单机的异常看起来会引发其他 ds 的 put latency的上涨\n\n除11.177.204.64外，多台机器的remove qps都有上升，所以多台ds的put latency上涨是符合预期的\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/135556484/1721274965415-e51bb0fa-408d-4055-843f-4ab5c2b8f23d.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/135556484/1721275325536-ec5b5605-f004-450a-9803-23aa2c12cd94.png)\n\n至于为什么11.177.204.64表现最明显，那是由于在出问题（20:11）之前，单机本身就有level0层sst堆积的情况出现了，看监控大概有200+（常态下正常在30左右），这是第一Load、CPU异常上涨导致的。\n\n根据leveldb的原理，level0层sst的数据范围是存在重叠的（内存dump到level0层再到level 1层，以此类推，除level0层以外其它层的数据是不重叠的），一次读需要扫描所有sst，固数目过多会极大影响get的效率（也即读放大过大）。因此本身sst数目异常 + 正好单机突发流量最高，导致了雪崩。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/135556484/1721275459698-5635ccfb-6304-4dce-af56-42238a163f98.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/135556484/1721275097251-ced93915-68ce-412b-b86c-99fea55010c2.png)\n\n3. 用户用的get接口，为什么tair只有一台异常就会让用户流量跌0\n业务的访问模式是一次读出16张优惠券的信息，串行读，读到任何一张卡住就整体卡住。\n这个时候，有一张优惠券落到问题ds，就会造成很多卡住的情况。\n\n## 四、关注点分析\n### 4.2【处置能力】\n#### 4.2.1 故障发现&响应\n+ **是否监控发现**\n    - [ ] 故障触发方 监控发现\n    - [x] 故障受影响方 监控发现\n    - [ ] 否，原因为：（监控无效/监控缺失）\n+ **是否5分钟内响应**",
    "chunk_order_index": 2,
    "full_doc_id": "doc-b99ffa97f10cf7921cbcb6398cd9724c"
  },
  "chunk-3ce6a225714972d242b152e8554d39eb": {
    "tokens": 647,
    "content": "情况。\n\n## 四、关注点分析\n### 4.2【处置能力】\n#### 4.2.1 故障发现&响应\n+ **是否监控发现**\n    - [ ] 故障触发方 监控发现\n    - [x] 故障受影响方 监控发现\n    - [ ] 否，原因为：（监控无效/监控缺失）\n+ **是否5分钟内响应**\n    - [x] 是\n    - [ ] 否，原因为：\n+ **是否存在应急协同问题**\n    - [ ] 是\n        - [ ] 应急流程不明确（无流程或者流程不清晰、应急相关角色&职责不明确，缺失一号位等)\n        - [ ] 应急执行不到位（有流程，但未按流程执行，通告发送不及时，响应不及时等）\n    - [x] 否\n\n**〖问题总结〗**电话会议中拉到正确的tair处理同学花费了一些时间\n\n**〖改进点〗**后续可通过邀请排查拉人，万一没有联系上，可拉好奇/北飞。\n\n#### 4.2.2 故障定位&恢复\n+ **主要恢复方式：**\n    - [ ] 代码发布/回滚\n    - [ ] 配置发布/回滚\n    - [ ] 数据订正\n    - [x] 机器隔离/重启/扩容\n    - [ ] 配置限流\n    - [ ] 预案降级\n    - [ ] 自动恢复\n    - [ ] 其他：\n\n**〖关注点1〗定位&恢复阶段存在什么问题？是否可以增加预案，****有更快的恢复方式？****相关的优化改进？**\n\n**〖问题总结〗**无\n\n\n**〖关注点2〗业务自身是否具备容灾逃逸能力？后续如何改进？**__\n\n- [ ] 具备容灾能力\n    - [ ] 因未演练不敢执行\n    - [ ] 因有损评估决策不执行\n    - [ ] 无决策或者决策不当，未执行\n- [x] 不具备容灾能力\n\n**〖问题总结〗**涉及成本问题，暂时无法解决对tair的强依赖。\n\n## 五、故障Action\n| **序号** | *******Action** | *******负责人** | *******计划完成时间** | **是否keyAction** |\n| :---: | --- | :---: | :---: | --- |\n| 1 | 短期：Tair增加容器维度监控（rt\\cpu\\Load） | 谷川 | 2024.8.2 | 是 |\n| 2 | 长期：增加实例维度监控，飞猪可自行配置使用 | 谷川 | 2024.8.31 | 是 |",
    "chunk_order_index": 3,
    "full_doc_id": "doc-b99ffa97f10cf7921cbcb6398cd9724c"
  },
  "chunk-e90842a62b7dcb01764592f5b8c2d47c": {
    "tokens": 1200,
    "content": "## 一、故障概述（含影响产品线及影响面）\n**故障概述：**\n\n 2023年1月5日11点左右 收到工单反馈AQ京杭询价无代理报价,经排查报价由于2022年12月9号 15:35打开了航班校验开关(无平台航班/9C/AQ无旗舰店航班报价过滤)，导致京杭链路9C/AQ无报价,2023年1月5日16:25分关闭航班检验开关后故障恢复。\n\n**影响面：**\n\n    - 是否影响可用性**：**否**；**\n    - **业务影响：**\n        * 影响业务收益\n    - 是否有客诉量（在线，热线，排队量）：否\n    - 是否有社会舆情：否\n    - 是否产生资损：否\n\n## 二、故障过程回顾【故障处理时间线】\n### 【1-5-10概览】\n![画板](https://intranetproxy.alipay.com/skylark/lark/0/2023/jpeg/23456487/1673350669536-6ab8071a-8863-46bc-a02f-a79858e46815.jpeg)\n\n### 【故障处理时间线】\n整体故障时间线。需要着重强调【故障注入】【故障发生】【故障发现】【业务响应】【故障定位】【恢复执行】【故障恢复】时间点。\n\n\n【故障注入】\n\n **2022-12-09 15:35 **打开了航班校验开关(无平台航班/9C/AQ无旗舰店航班报价过滤)\n\n       经回顾2022年11月28日17:14收到过类似反馈自营9C京杭询价时候没有代理的报价。于11月29号发布修复。\n11月29号修复openPurchaseApiSupply参数功能->(裸旗舰店需求)补全openPurchaseFlagshipSupply参数功能->（bug修复） 修复航班信息替换问题 -> 增加航班校验-> 打开校验开关12月9号-> 京杭链路9C/AQ（12月9号-1月05号）无报价。\n\n**2023-01-05 10:41**  运营同学子千通过工单提交，反馈近期整体九元旗舰店的分单量从之前日均700下降到最近一周日均10张，抽昨天一天的旗舰店未分单商家的订单来看，有66%显示为“询价无备货”，抽查例子在导航者看能看到商家有投放低价 [https://tickets.alibaba-inc.com/goc-ticket/ticket/2022102800000382442?spm=goc-apm.goc-ticket_tickets.0.0.178c21c5zBMXjy&page=1](https://tickets.alibaba-inc.com/goc-ticket/ticket/2022102800000382442?spm=goc-apm.goc-ticket_tickets.0.0.178c21c5zBMXjy&page=1) 【故障发现】【业务响应】\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/39701/1673407123354-04828501-e2a3-4a4c-9e5f-b11bb58e461e.png)\n\n**2023-01-05 16:25** 焱火确定问题产生的原因为航班信息替换的一个bug引起【故障定位】 \n--补充缺失日志 \n\n**2023-01-05 16:25**  时阳操作ateye开关关闭航班检验过滤【恢复执行】\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/39701/1673404319204-7d02af89-5f9c-46f0-b7fa-7e05fd235453.png)\n\n**2023-01-05 16:25**** **  开关关闭后立刻恢复【故障恢复】\n\n\n\n## 三、故障影响面\n+  京杭内采AQ /9C 预计影响收益共9万左右\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/39701/1673404508295-39c0bc50-1585-465d-b082-71a44d8c7d0d.png)\n\n## 四、故障原因\n### 4.1【一句话原因】\n     在需求迭代和bug修复的过程中由于改动点评估不到位引入的问题,长时间未被发现影响了业务的收益。\n\n\n\n### 4.2【背景说明】\n_ _   2022年1月5日收到反馈AQ京杭询价无代理的报价经排查报价由于12月9号 15:35打开了航班校验开关(无平台航班/9c/AQ无旗舰店航班过滤)；导致京杭链路9C/AQ无报价,打开航班检验开关后初步恢复。\n\n经回顾2022年11月28日17:14收到过类似反馈自营9C京杭询价时候没有代理的报价于11月29号发布修复(openPurchaseApiSupply(是否打开采购大卖家,经排查报价控制请求参数功能属性有问题 open",
    "chunk_order_index": 0,
    "full_doc_id": "doc-8f893e284ad8bf3dbb2dba2743f1ec0b"
  },
  "chunk-5d029d9baa14158d5e17e88a1b137169": {
    "tokens": 1200,
    "content": "班/9c/AQ无旗舰店航班过滤)；导致京杭链路9C/AQ无报价,打开航班检验开关后初步恢复。\n\n经回顾2022年11月28日17:14收到过类似反馈自营9C京杭询价时候没有代理的报价于11月29号发布修复(openPurchaseApiSupply(是否打开采购大卖家,经排查报价控制请求参数功能属性有问题 openPurchaseApiSupply(是否打开采购大卖家)\u0000 配置为false 影响裸api报价召回)\n\n### 4.3【根因分析】\n       \n\n    -  openPurchaseApiSupply参数属性功能有缺, fase 是否打开采购大卖家，在请求获取外部报价前false即对应代理商不请求ierc去获取大卖家报价影响裸价漏出。\n\n       ![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/23456487/1673188177096-bc449f34-e4c0-4283-8212-e201d6346821.png)\n\n          ![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/23456487/1673190124235-3d978655-46a3-4e4c-b9c8-d0e6ed576d7b.png)\n\n    - 12月9号 15:35打开了航班校验开关,获取不到航班（平台+旗舰店的9C,AQ）被过滤 ![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/23456487/1673188743617-f8498920-2da8-429d-b8a7-6fd536c45d9c.png)\n    - 9C,AQ获取不到旗舰店航班->原始报价\u0000为空-> 9C,AQ旗舰店报价未与平台航班合并在一起\n    - ![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/23456487/1673188892512-1477fb42-6585-48c5-9973-faeab67942db.png)\n    - 原始报价\u0000为空-> 补充过 openPurchaseFlagshipSupply\u0000 是否打开采购旗舰店\u0000参数功能\n\n           ![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/23456487/1673189137779-d06f1aaf-be45-4c7b-93f7-095fc303ecca.png)    \n\n## 四、故障关注点\n### 4.1【系统质量】\n#### 4.1.2  代码质量\n**〖关注点2〗****是否经过CodeReview？CodeReview阶段是否发现问题？为何没发现？**\n\n+ **是否经过CR**\n    - [x] 是\n    - [ ] 否\n    - [ ] 不涉及\n+ **是否设置合理的CR卡点**\n    - [x] 是\n    - [ ] 否\n    - [ ] 不涉及\n    - [CR卡点设置要求](https://ata.alibaba-inc.com/articles/225396?spm=ata.25287382.0.0.5e0c7536X43l05)\n+ **CR人员：**\n+ **CR时长：**\n+ **CodeReview阶段是否发现问题？为何没发现？后续如何发现？**\n    - [ ] 是\n    - [x] 否\n\n**〖问题分析〗多次迭代，无法在单一CR过程中发现**\n\n**〖改进点〗**\n\n#### 4.1.3 变更质量\n+ **是否涉及变更：**\n    - [x] 是\n    - [ ] 否\n+ **变更类型：**\n    - [ ] 代码发布\n    - [ ] 配置变更\n    - [x] 其他变更：ateye开关\n    - [ ] 不涉及\n+ **变更平台是否接入ChangeFree：**\n    - [ ] 是，CF变更单链接：\n    - [x] 否\n+ **变更内容：**_****_\n    - [x] 变更执行人: \n    - [ ] 变更系统：\n    - [ ] 变更对象：\n\n**〖关注点1〗****测试阶段**\n\n+ **是否经过测试验证**\n    - [ ] 是，验证环境\n        - [ ] 预发环境\n        - [ ] 日常环境\n    - [x] 是，测试方法\n        - [x] 回归测试\n        - [ ] 单元测试\n        - [ ] 集成测试\n        - [ ] 链路测试\n        - [ ] 验收测试\n    - [ ] 否\n    - [ ] 不涉及\n+ **测试未发现原因是什么？后续如何改进？**\n    - [x] 回归遗漏\n        - [ ] 手工回归case遗漏\n        - [ ] 自动化未建设\n        - [ ] 自动化回归覆盖不足\n        - [ ] 性能影响评估不足\n    - [ ] 新场景遗漏\n        - [ ] 新增功能case遗漏\n        - [ ] 性能影响评估不足\n        - [ ] 无线端稳定性评估/测试不足（如：crash）\n        - [ ] 无线端兼容性测试不足\n        - [ ] 安全",
    "chunk_order_index": 1,
    "full_doc_id": "doc-8f893e284ad8bf3dbb2dba2743f1ec0b"
  },
  "chunk-8ff46cb0abf9e483502edd065b36006d": {
    "tokens": 452,
    "content": "- [ ] 自动化未建设\n        - [ ] 自动化回归覆盖不足\n        - [ ] 性能影响评估不足\n    - [ ] 新场景遗漏\n        - [ ] 新增功能case遗漏\n        - [ ] 性能影响评估不足\n        - [ ] 无线端稳定性评估/测试不足（如：crash）\n        - [ ] 无线端兼容性测试不足\n        - [ ] 安全问题\n        - [ ] 异常场景评估/测试遗漏\n    - [ ] 其他原因说明：\n\n**〖问题总结〗**\n\n**〖改进点〗**--梳理核心场景，补全自动化测试案例 yeqin\n\n\n\n**〖关注点2〗****灰度阶段**\n\n+ **未经过灰度：**\n+ **未灰度发现原因**\n    - [ ] 应用灰：灰度流量太小\n    - [ ] 应用灰：灰度阶段无监控\n    - [ ] 应用灰：灰度批次不合理\n    - [ ] 应用灰：超长时间灰度才能发现\n    - [ ] 业务灰：策略不合理\n    - [x] 灰度无法发现\n    - [ ] 其他：__________\n\n## 五、故障Action\n| **序号** | **ACTION** | **计划完成时间** | **Action负责人** |\n| --- | --- | --- | --- |\n| 1 | 针对召回参数做好对应功能场景做好测试用例覆盖 | 0131 | yeqin |\n| 2 | 区分监控的维度针对京杭询价场景做好有结果率的监控，增加每个航司有结果率指标报表 | 0120 | 时阳 |\n| 3 | 切流后自营关注一下近两天收益 |  |  |\n| 4 | 补充航班询价过程的日志 | 已完成 | 时阳 |\n| 5 | 切流过程中技术关注收益 | 0210 | chengyu |",
    "chunk_order_index": 2,
    "full_doc_id": "doc-8f893e284ad8bf3dbb2dba2743f1ec0b"
  },
  "chunk-e57616b300e2d5ac56906bece1e87235": {
    "tokens": 1200,
    "content": "## 一、故障简述\n故障简述：于20:02国际ota成功率下跌和flywhell应用hsf线程异常，20:09分flywheel应用提交扩容成功并开始扩容，扩容过程中成功率逐步提升，持续十分钟后触发P4故障，于20:12分恢复正常水位\n\n## 二、故障过程回顾\n### 2.1【故障处理时间线】\n故障时间线看这个：[https://aliyuque.antfin.com/g/ngoc/review/gwzzo9705pi6cz3k/collaborator/join?token=w0lkGVAXF7DCGfTF&source=doc_collaborator#](https://aliyuque.antfin.com/g/ngoc/review/gwzzo9705pi6cz3k/collaborator/join?token=w0lkGVAXF7DCGfTF&source=doc_collaborator#) 《时间线》\n\n###### 时间线\n2024-04-10 20:04，收到flywheel hsf线程池使用率报警，同时收到成功率下跌通知**【故障发现】**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/3756496/1712752496793-7bb604c7-b5ba-4e4e-84c3-5699155ac526.png)![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/107356377/1712752631890-ddb4181d-b9eb-466c-a040-f1876b768fe1.png?x-oss-process=image%2Fformat%2Cwebp%2Fresize%2Cw_557%2Climit_0)\n\n2024-04-10 20:04，同时**查看相关监控进行排查【业务响应】**\n\n+ **查看flux ateye，发现大量线程池满异常**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/3756496/1712752905736-690e90ac-0872-45df-9038-acff5daa74ba.png)\n\n+ **tair读写RT和成功率波动**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/3756496/1712753089824-4c350802-65e7-4a6e-8956-c8cf116a85f0.png)\n\n+ **flux变更**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/3756496/1712753747509-5d262d8e-9406-4ecc-bb38-e7645f90c4aa.png)\n\n2024-04-10 20:04，开启多线处理\n\n+ **flywheel 扩容处理**\n\n| **20:09 flywheel开启扩容** | ![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/107356377/1712753236095-5f5be118-542b-44bb-9a1d-f43e5470b549.png) |\n| --- | --- |\n| **20:15 flywheel第一批执行完成** | ![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/107356377/1712753325214-039d95df-111a-49c8-be0d-73ce6f1361e8.png) |\n| **20:09 ～ 20:15 扩容期间，成功率逐渐回升** | ![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/3756496/1712755437742-390e6f4c-9d80-4e2e-a196-3a89d6340329.png)![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/3756496/1712755482991-1f1f93db-2626-4f8d-b369-ff1567368f10.png) |\n\n\n+ **flux变更发布回滚**\n\n| **20:10 flux提交回滚** | ![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/3756496/1712753800223-a5078242-99fb-4492-b778-04165d0f5fb4.png) |\n| --- | --- |\n\n\n+ **flux开关处理**\n\n| **20:15 关闭flux人群调用开关** | ![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/3756496/1712754608109-153c16c9-5696-47d3-8662-4dc74d1bc460.png) |\n| --- | --- |\n\n\n+ **故障拉群处理**\n\n2024-04-10 20:11，故障持续10分钟【故障发生】\n\n2024-04-10 20:15，监控恢复正常水位【故障恢复】\n\n| **20:09 拉起故障群** | ![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/3756496/1712754035161-540ee3e2-cb2b-40",
    "chunk_order_index": 0,
    "full_doc_id": "doc-7cca8a033593f5e6a1aeb3c3f79b86b0"
  },
  "chunk-4e7a045a8a328b4bbf4959eef3b669bf": {
    "tokens": 1200,
    "content": "处理**\n\n2024-04-10 20:11，故障持续10分钟【故障发生】\n\n2024-04-10 20:15，监控恢复正常水位【故障恢复】\n\n| **20:09 拉起故障群** | ![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/3756496/1712754035161-540ee3e2-cb2b-40e2-aacf-4aeb39a75f9e.png) |\n| --- | --- |\n| **20:18 tair回复tair****客户端链接过多** | ![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/3756496/1712754678647-54cb420b-c9d2-4c93-a58d-2b4e526625fc.png) |\n\n\n## 三、故障原因\n### 【原因分析】\n一句话原因：\n\n**流量突增，Tair 限流后导致击穿，同时线程池使用不合理，导致CPU、HSF线程池打满，无法处理请求，flux调用人群出现HSF异常，查询人群出现异常会导致匹配策略失败，从而导致OTA搜索因匹配不到排序模版而导致OTA搜索失败**\n\n根因分析：\n\n![画板](https://intranetproxy.alipay.com/skylark/lark/0/2024/jpeg/3756496/1712839813683-b9af05d2-cdb3-407f-8e41-6bf05c9ca0f6.jpeg)\n\n## flux部分\n**通过搜索失败日志结论：出现成功率下跌的原因是搜索出现异常**\n\n[https://flyeye.fliggy.com/#/log/query?endDate=1712750967839&orderId=215045b417127508867587797e9abf&queryType=eagleEyeId&startDate=1712664567839](https://flyeye.fliggy.com/#/log/query?endDate=1712750967839&orderId=215045b417127508867587797e9abf&queryType=eagleEyeId&startDate=1712664567839)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/9675/1712754027784-0850dd3b-a004-4990-b80b-495965bfd795.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/9675/1712754145532-31a11212-007c-4197-bee7-68e4a505c2ed.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/9675/1712754301216-f916ba62-f72e-4547-aeb2-c02eae301187.png)\n\n**调用人群出现HSF异常，查看代码可知，查询人群出现异常会导致匹配策略失败，从而导致OTA搜索因匹配不到排序模版而导致OTA搜索失败**\n\n## flywheel部分\n**20:00开始进入flywheel的流量陡增，通过溯源，流量来源为搜索APP渠道，收藏入口，瞬时QPS 88**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/3756496/1712756730068-47be34b1-81e1-4d3c-a318-0d69499e7c65.png)\n\n**atsuggest调用forge，forge 流量突增**\n\n| ![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/3756496/1712756336407-c635cff3-398f-4f97-abab-b913a616ea4d.png) | ![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/3756496/1712756318094-7bc05ee8-f2a8-4786-b6b3-16e79cf1732e.png) |\n| --- | --- |\n| ![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/3756496/1712756438677-5c668055-1b7c-4e7b-bcc8-4199ae28fe5d.png) | ![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/3756496/1712756419839-b18f7a76-f212-4223-9020-d4f7ef0d1e8d.png) |\n\n\n**forge中调用flywheel，forge调用xsp，xsp调用flywheel，flywheel 人群接口流量突增**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/107356377/1712801798057-ddb8c52e-3560-4d01-aedb-307b13cd9976.png)\n\n**flywheel CPU load 升高**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/3756496/1712806685717-3c964dc2-5acd-42f0-a197-b337e570d40a.png)\n\n![](https://intranetproxy.alipay.com/sk",
    "chunk_order_index": 1,
    "full_doc_id": "doc-7cca8a033593f5e6a1aeb3c3f79b86b0"
  },
  "chunk-c3288fb09c0addd6aa3bb92cf69c9b65": {
    "tokens": 1200,
    "content": "-ddb8c52e-3560-4d01-aedb-307b13cd9976.png)\n\n**flywheel CPU load 升高**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/3756496/1712806685717-3c964dc2-5acd-42f0-a197-b337e570d40a.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/3756496/1712806711895-2ae1c31f-cd2f-4983-b05f-5b8d653c3f9f.png)\n\n**HSF 线程数突增，Tair 限流 RPC_OVERFLOW增多**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/107356377/1712801906961-a4185c01-0ea0-4932-821a-f4dadd18db22.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/107356377/1712803043202-d5c2b9c8-24e2-41ea-b7ea-cb3f9107e960.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/3756496/1712819858181-a9287e64-959a-4486-8393-6194454fb6e0.png)**Tair 限流后，Tair 并不会抛出异常，会返回限流错误码，根据代码逻辑，走到了未命中缓存的逻辑，导致击穿**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/107356377/1712833052490-22a46599-e4b3-4bc2-8b3f-010fe01866e2.png)\n\n**命中缓存的人群请求量突然下跌，未命中缓存的人群请求量突增**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/107356377/1712834491349-ad02ad4c-b644-47cd-bd3f-97f93706a0a7.png)![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/107356377/1712834515513-bf7270ff-6372-4d04-addf-1cad8d923744.png)\n\n\n\n**HSF线程池占用分析 大量线程处于Waiting状态**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/107356377/1712820402933-440122c1-ba84-4300-8859-8525bb02f1c9.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/107356377/1712820507053-e19b172c-337c-4682-b19f-5846e3f5f3f5.png)\n\n**定位到人群接口中多次使用parallelStream\u0000，使用的是JVM的ForkJoinPool，并且没有超时时间，导致大量线程处于Waiting状态，HSF线程池打满**\n\n![画板](https://intranetproxy.alipay.com/skylark/lark/0/2024/jpeg/107356377/1712841190265-28a778eb-1467-4be9-a542-7d1c4a45be70.jpeg)\n\n**具体的代码**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/107356377/1712820825521-03714111-9555-42bb-93f3-a8177e1f756c.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/107356377/1712820895131-38946654-4c91-42f5-8626-173abb0dfceb.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/107356377/1712820987400-800e2ca4-ed37-4896-b5dd-ee440759b21f.png)**流量突增，Tair 限流后导致击穿，同时线程池使用不合理，导致CPU、HSF线程池打满，无法处理请求**\n\n## tair部分\n+ **configId: tair.ldb.trip1a namespace:1024**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/3756496/1713150249430-bc4c0d40-df9a-4328-a1e7-bd21044a33a6.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/3756496/1713153341279-9d9b04cc-1316-4837-95fb-51cb7c81db98.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/3756496/1713153326146-11e7ed90-0088-403a-bbb9-e709a11f1601.png)\n\n+ 限流监",
    "chunk_order_index": 2,
    "full_doc_id": "doc-7cca8a033593f5e6a1aeb3c3f79b86b0"
  },
  "chunk-11cb7526a05b7ee1c270adb81932a829": {
    "tokens": 1200,
    "content": "/2024/png/3756496/1713153341279-9d9b04cc-1316-4837-95fb-51cb7c81db98.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/3756496/1713153326146-11e7ed90-0088-403a-bbb9-e709a11f1601.png)\n\n+ 限流监控\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/3756496/1713153407278-655f3fc0-ecdf-42d4-b50e-90d211525788.png)\n\n+  应用间共用\n\n![画板](https://intranetproxy.alipay.com/skylark/lark/0/2024/jpeg/3756496/1713161482040-bb5148b9-2d65-4723-a702-a557114a95d5.jpeg)\n\n    - QPS统计区间：一天范围内 tair QPS\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/3756496/1713178658685-e937b52c-8590-4a91-a922-2e7da0f26ef1.png)\n\n    - 应用读写QPS详情\n\n| **应用** | **读QPS** | **写存储量** | **概览** |\n| --- | --- | --- | --- |\n| flywheel | 183833.06 | 19694.25 | ![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/3756496/1713179844478-f20e3471-6531-4d53-9d2e-0b43d22b047f.png) |\n| forge | 5791.75 | 1111.86\t | ![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/3756496/1713179732194-ec0618d2-d0d2-4305-82ab-22ceb61a333e.png) |\n| flybuy | 4425.26 | 485.21 | ![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/3756496/1713178917021-fc9c27c9-4add-4222-bd8e-58ee0fe4f40d.png) |\n| oneroute | 1909.43 | 156.92 | ![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/3756496/1713178846220-c2806147-c2e6-41d3-8f30-bcf4dd800cc4.png) |\n| flux | 1623.54 | 203.1 | ![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/3756496/1713179885167-d9b8eb04-6277-4a88-a13e-895eb9f2c40f.png) |\n| flytp | 1218.01 | 8.82 | ![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/3756496/1713180228933-21bee8fb-c294-4c0e-9dc8-3fd421c63e6e.png) |\n| iesfo | 645.73 | 201.16 | ![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/3756496/1713179800468-d82be02a-8a01-4534-bb39-83c11fe39ae4.png) |\n| bluekingfisher | 395.4 | 361.04 | ![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/3756496/1713180068223-46cb8bc9-e367-4d41-baa2-d9b320364b9e.png) |\n| magnet | 267.7 | 5.77 | ![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/3756496/1713179217017-765f9218-9108-4066-a6e0-f2305a7d693f.png) |\n| flyorder | 167.28 | 35.86 | ![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/3756496/1713180303952-c983d9e8-8888-4c9b-a35f-e528c328b330.png) |\n| tto | 129.69 | 13.62\t | ![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/3756496/1713179292347-0dfcfb3b-e636-45ce-8bda-d1efba24cdfd.png) |\n| atic | 69.66 | 19.56 | ![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/3756496/1713178754988-e8c08e61-9e58-4d7a-b84b-",
    "chunk_order_index": 3,
    "full_doc_id": "doc-7cca8a033593f5e6a1aeb3c3f79b86b0"
  },
  "chunk-7cb1b5fea2fabdd58f4c5b9c9857e527": {
    "tokens": 1200,
    "content": "/3756496/1713179292347-0dfcfb3b-e636-45ce-8bda-d1efba24cdfd.png) |\n| atic | 69.66 | 19.56 | ![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/3756496/1713178754988-e8c08e61-9e58-4d7a-b84b-83b440d62520.png) |\n| ieagl | 36.84 | 0.18 | ![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/3756496/1713180118728-f2ed5559-9ed0-4e3e-abb7-a4175caa775c.png) |\n| wflight | 18.81 | / | ![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/3756496/1713180445062-0edd4edc-4a90-4d7e-8c2f-a09878070b25.png) |\n| ato | 7.28 | 0.25 | ![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/3756496/1713180016231-05d105b5-ab5a-4a33-8024-5b38f8e31f90.png) |\n| iebuy | 3.8 | 1.11 | ![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/3756496/1713180172261-66def576-f228-47ca-90d3-f13d4ac5cf26.png) |\n| flyxrp | 0.53 | 0.63 | ![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/3756496/1713179959250-cebef4a1-726b-4a8e-9e07-7e7f131980bd.png) |\n| atpcrd | 0.07 | / | ![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/3756496/1713180626831-3a805c8c-a43a-40d3-ae58-b10df82fa024.png) |\n| itemcenter2 | / | 0.02 | ![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/3756496/1713179490619-e6e0da10-a8db-414b-ab30-1be11b50d2ef.png) |\n| glaucus | / | / | / |\n| flimmy | / | 0.48 | ![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/3756496/1713180482150-eacfb6f7-9b8a-404b-8e40-26145d22ef9e.png) |\n| prod-dsc-na-cluster | / | / | / |\n\n\n**flywheel的QPS太高，共用可能会给其他共用应用造成稳定性影响**\n\n最近频繁遇到的tair问题：tair rt上涨导致人群接口耗时涨，影响整体的性能指标，后续建议升级tair QPS\n\n\n\n## 四、关注点分析\n### 4.2【处置能力】\n#### 4.2.1 故障发现&响应\n+ **是否监控发现**\n    - [x] 故障触发方 监控发现\n    - [ ] 故障受影响方 监控发现\n    - [ ] 否，原因为：（监控无效/监控缺失）\n\n#### 4.2.2 故障定位&恢复\n+ **主要恢复方式：**\n    - [ ] 代码发布/回滚\n    - [ ] 配置发布/回滚\n    - [ ] 数据订正\n    - [x] 机器隔离/重启/扩容\n    - [ ] 配置限流\n    - [ ] 预案降级\n    - [ ] 自动恢复\n    - [ ] 其他：\n+ **是否10分钟内恢复**_/* P1P2故障填写*/_\n    - [ ] 是\n    - [ ] 否，原因：__________\n\n## 六、故障Action\n| **序号** | *******Action标题** | *******负责人** | *******计划完成时间** | **Action描述** | **验收标准** | **验收人** | **是否keyAction** | **是否回血Action** |\n| --- | --- | --- | --- | --- | --- | --- | --- | --- |\n| 1 | flux强弱依赖优化 | 蜂茗 | 已完成 |  | ![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/3756496/1713149104176-48fb694b-2057-4a01-8607-7963c397321c.png?x-oss-process=image%2Fformat%2Cwebp%2Fresize%2Cw_1031%2Climit_0) |  | 是 |  |\n| 2 | 收藏定时任务削峰与限流 | 蜂�",
    "chunk_order_index": 4,
    "full_doc_id": "doc-7cca8a033593f5e6a1aeb3c3f79b86b0"
  },
  "chunk-913f24db153de41e650cc576d5ba5cbf": {
    "tokens": 828,
    "content": "ylark/lark/0/2024/png/3756496/1713149104176-48fb694b-2057-4a01-8607-7963c397321c.png?x-oss-process=image%2Fformat%2Cwebp%2Fresize%2Cw_1031%2Climit_0) |  | 是 |  |\n| 2 | 收藏定时任务削峰与限流 | 蜂茗 | 已完成 | + 限流（文档支持非整数配置，但实际验证不支持，故QPS已都改为1）+ 待观察峰值 | ![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/3756496/1712823111850-d9aef697-64d2-4770-aa8d-a2f98267ebd1.png)![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256373/1713168050660-4f5ca626-4e6a-4d6c-854b-1551bcdd16ec.png) |  |  |  |\n| 3 | flywheel 规范线程池 | 林渡 | 4.19 | 取消parallelStream的使用，统一使用自定义线程池 | ![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/107356377/1712820825521-03714111-9555-42bb-93f3-a8177e1f756c.png?x-oss-process=image%2Fformat%2Cwebp%2Fresize%2Cw_1031%2Climit_0) |  |  |  |\n| 4 | ### tair拆分 | 林渡 | 5.10 | 内部讨论落地方案先做 flywheel  |  |  | 是 |  |\n| 5 | 预警调整（listing和OTA） | 蜂茗 | （已完成） | + 白天：由10分钟预警调整为5分钟预警 |  |  |  |  |\n| 6 | 低价 收藏老链路架构改造 | 鸿泽 | 5.10 | 带回讨论，给结论 |  |  |  |  |\n| 7 | 国际内搜索链路 人群强弱依赖梳理 | 蜂茗 | 5.10 | 后续通过断流或者其它方案验证 |  |  |  |  |\n| 9 | ~~有损开关执行，梳理相关规范~~ |  |  | ~~出现什么场景可以执行开关（紧急预案）~~ |  |  |  |  |\n| 10 | ~~线程池相关风险  规范~~ | ~~~~ | ~~~~ | ~~确认是否有埋点监控，以及相关风险~~ |  |  |  |  |\n\n\n## 七、影响产品线&影响面\n    - [x] 业务影响：\n        * 影响的产品线，业务功能，功能受损程度（成功量/率下跌多少%），持续多少时间\n\nOTA页面成功率20:00-20:15持续15分钟【P4】![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256373/1713168881677-b06ab41b-a5f3-4978-b848-447ef92e6c6b.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256373/1713168952801-3dacca83-d086-40b6-b6f5-8d5af8fc923e.png)",
    "chunk_order_index": 5,
    "full_doc_id": "doc-7cca8a033593f5e6a1aeb3c3f79b86b0"
  },
  "chunk-54b7d501e7d9a817a29aa7b7f1978dc6": {
    "tokens": 1200,
    "content": "## 一、故障简述\n【P5】于2024-08-27 17:56开始，Sunfire出现监控漏报的情况，18:15报警漏报问题不再产生，18:18通过缩容报警预发机器和减少查询DB流量，于18:35问题彻底恢复。\n\n## 二、故障过程回顾\n### 【故障处理时间线】\n2024-08-27 17:50，报警上线一个新鹰眼，预发扩容机器，验证新的代码逻辑[link](https://cd.aone.alibaba-inc.com/ec/app/258419/deploy/order?id=110287610&envId=5045789)【故障引入】\n2024-08-27 17:56，群‘sunfire自监控’出现报警丢失【故障发现】【故障发生】【故障响应】\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/7919/1724754216951-b8b070a8-2dfd-4af1-9779-d52fce45902e.png?x-oss-process=image%2Fformat%2Cwebp%2Fresize%2Cw_750%2Climit_0)\n\n2024-08-27 18:02，触发GOC风险预警\n2024-08-27 18:06，残墨确认 monitor-meta DB出现CPU打满情况【故障定位】\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/7919/1724754276500-a963d935-2c23-4342-806e-02a3a5e843d6.png)\n\n2024-08-27 18:15，报警漏报问题恢复【故障恢复】\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/7919/1724754397143-b5524787-8e02-405d-82fe-0f10d0516641.png)\n\n2024-08-27 18:18，通过缩容报警预发机器和减少查询DB流量【恢复执行】\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/7919/1724813952960-730cccaa-cdcd-48c3-b758-32abe375fd2c.png)\n\n2024-08-27 18:21，执行完成缩容操作\n2024-08-27 18:35，Sunfire-compute完全恢复【影响消除】\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/7919/1724814412704-f28cfcad-a69d-46ba-9f99-3bb550f24c1c.png)\n\n\n\n### 【过程概览】\n![画板](https://intranetproxy.alipay.com/skylark/lark/0/2024/jpeg/149256407/1725005275129-e82ce0a2-6802-43c6-9a70-db6f0b04001b.jpeg)\n\n\n\n## 三、故障原因\n### 3.1【背景说明】\n#### 【需求背景】\n:::tips\n搭建应用监控告警规则新集群，该集群将按照应用派发任务\n\n:::\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/149256407/1724983469393-5e7b6b5e-ef10-4881-9032-de401503764b.png)\n\n#### 【业务链路】\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/149256407/1725262009557-dcd08cff-b066-4381-afe0-05a772d9df2a.png)\n\n\n\n### 3.2【原因分析】\n**一句话原因：  \n**monitor-meta数据库CPU100%，导致报警无法拉取数据库的数据元信息，报警产生漏报。\n下游都有影响。\n\n****\n\n**根因分析：**\n\n应用监控新集群（sunfire-alert）提了CR是把应用集群的brain（角色）按应用派发，这个CR本来应该不做部署的，同步的还有一个下游按应用拉取规则的改造CR（准备同步提的）。提完CR后，为了确认下部署配置没问题，所以在预发上又部署了一下，这就导致了sunfire-alert预发按应用进行派发，但是下游还没兼容按应用拉取规则的逻辑。所以相当于brain派发了5万个appmonitor的任务到boss（db拉取数据的作用）上，boss在1分钟内拉取了5万次的全量应用规则(约3万条规则)\n\n\n**相关链接：**[**https://aliyuque.antfin.com/lhubic/nh7ozc/origeiykcrlys560**](https://aliyuque.antfin.com/lhubic/nh7ozc/origeiykcrlys560)\n\n\n\n## 四、故障关注点\n### 〖关注点1〗代码发布流程？代码是否经过CodeReview、是否发现问题？\n:::info\n〖问题分析〗\n1、代码发布流程？\n预发->线上\n2、代码是否经过CodeReview、是否发现问题？\n预发未经过CR、未发现问题\n\n3、预发环境",
    "chunk_order_index": 0,
    "full_doc_id": "doc-e605f7000e7d078886470e8188b88418"
  },
  "chunk-b9dd2a7121232c6c0068497dd2d1824c": {
    "tokens": 1200,
    "content": "://aliyuque.antfin.com/lhubic/nh7ozc/origeiykcrlys560)\n\n\n\n## 四、故障关注点\n### 〖关注点1〗代码发布流程？代码是否经过CodeReview、是否发现问题？\n:::info\n〖问题分析〗\n1、代码发布流程？\n预发->线上\n2、代码是否经过CodeReview、是否发现问题？\n预发未经过CR、未发现问题\n\n3、预发环境是否能够作为测试环境部署\n\n代码配置误发线上数据库，应该先发到预发数据库\n\n预发和线上隔离，预发未正常使用\n\n:::\n\n+ Action：\n\n1、报警、web、计算 代码改造待验证[@御岚](undefined/zheshun.wzs)\t09.19   验收： [@隐元](undefined/shili.sl)\n\n\n\n### 〖关注点2〗监控报警是否缺失？\n:::info\n**〖问题分析〗**\n\n1、是否需要针对DB 、Sunfire 查询monitor meta 数据库配置报警？ [@隐元](undefined/shili.sl)[@俊飞](undefined/ouyangjunfei.oyjf)  已完成\n2、无法查询到monitor-meta 写入链路是否可以配置报警？ 已配置\n3、报警是否可以避免直连DB/避免大规模查询DB？[@泽诚](undefined/zelin.qzl)[@景悟](undefined/jiayu.ojy)  无法避免、监控补充报警\n\n4、断图告警有吗？ 有\n\n:::\n\n+ Action：\n\n短期：\n\n强弱依赖规则确认是否需要改变[@景悟](undefined/jiayu.ojy)   09.13\n\n\n\n长期：\n\n报警文档梳理[@隐元](undefined/shili.sl)\t0930\t  验证：oncall同学\n\n故障场景保鲜[@乐尽](undefined/cuirongcheng.crc)      0930\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/20857115/1725244171255-ed690233-2d30-4af7-805c-861311183cba.png)\n\n异常错误出现时间最早但没有配置告警\n\n[https://x.alibaba-inc.com/application/appmonitor/monitor-meta-task/monitor/exception?from=1724751155923&to=1724754398784&v=2](https://x.alibaba-inc.com/application/appmonitor/monitor-meta-task/monitor/exception?from=1724751155923&to=1724754398784&v=2)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/20857115/1725243654855-d816df69-29e6-4718-ab6e-896d540e44f0.png)\n\nTDDL报警只配置了warning级别并且在饭点前没有重视。\n\n### 〖关注点3〗monitor meta数据库没有相关保护措施吗？为何会出现CPU100%的情况？\n:::info\n**〖问题分析〗**\n\n1、针对CPU100%的情况有没有做风险评估或切流预案\n2、强弱依赖梳理、meta数据库会影响全部业务\n\n:::\n\n+ Action：\n\n1、CPU60%报警监控[@隐元](undefined/shili.sl) 已完成\n\n2、oncall文档保护措施预案补充[@残墨](undefined/airan.lar) \t09.06\n\n\n\n### 〖关注点4〗数据链路是否合理？\n:::info\n**〖问题分析〗**\n\n1、数据写入链路会拉取机器的IP 目前判断如果拉取失败，则认为机器全量IP为空 需要进行修改[@致羽](undefined/hezhifeng.hzf)[@御岚](undefined/zheshun.wzs)\n\n\n\n:::\n\n+ Action：\n\n1、强弱依赖需要梳理、[@御岚](undefined/zheshun.wzs)\t09.13\n\n2、一月或两月一次风险演练，验证强依赖和验证监控是否缺失，梳理配置  待评估\n\n## 五、故障Action\n| **序号** | *******Action** | *******负责人** | *******计划完成时间** | **验收标准** | **验收人** | **是否keyAction** | **是否回血Action** |\n| --- | --- | --- | --- | --- | --- | --- | --- |\n| 1 | 短期：报警、web、计算 代码改造待验证 | [@御岚](undefined/zheshun.wzs) | 09.19 |  | [@隐元](undefined/shili.sl) | | |\n| 2 | 短期：强弱依赖规则确认是否需要改变 | [@景悟](undefined/jiayu.ojy) | 09.13 |  | [@隐元](undefined/shili.sl) | | |\n| 3 | 短期：CPU60%报警监控 | [@隐元](undefined/shili.sl) | 已完成 |  | | | |\n| 4 | 短期：oncall文档保护措施预案补充 | [@残墨](undefined/airan.lar) | 09.06 |  | oncall同学[@残墨](undefined/airan.lar)[@原茂](undefined/zh383316)[@俊飞](undefined/ouyangjunfei.",
    "chunk_order_index": 1,
    "full_doc_id": "doc-e605f7000e7d078886470e8188b88418"
  },
  "chunk-d63c1ed5865e2926046c28f080202149": {
    "tokens": 320,
    "content": "%报警监控 | [@隐元](undefined/shili.sl) | 已完成 |  | | | |\n| 4 | 短期：oncall文档保护措施预案补充 | [@残墨](undefined/airan.lar) | 09.06 |  | oncall同学[@残墨](undefined/airan.lar)[@原茂](undefined/zh383316)[@俊飞](undefined/ouyangjunfei.oyjf) | | |\n| 5 | 短期：强弱依赖需要梳理 | [@御岚](undefined/zheshun.wzs) | 09.13 |  | [@隐元](undefined/shili.sl) | | |\n| 6 | 长期：报警文档梳理 | [@隐元](undefined/shili.sl) | 09.30 |  | oncall同学[@残墨](undefined/airan.lar)[@原茂](undefined/zh383316)[@俊飞](undefined/ouyangjunfei.oyjf) | | |\n| 7 | 长期：故障场景保鲜 |  [@乐尽](undefined/cuirongcheng.crc) | 09.30 |  | [@御岚](undefined/zheshun.wzs) | | |\n| 8 |  |  |  |  | | | |\n| 9 |  |  |  |  | | | |\n\n\n### \n####",
    "chunk_order_index": 2,
    "full_doc_id": "doc-e605f7000e7d078886470e8188b88418"
  },
  "chunk-8abf70e246def2e74a38d0971d55fec7": {
    "tokens": 1200,
    "content": "## 一、故障简述（含影响产品线及影响面）\n##### 故障概述：\n2024年7月25日23:53监控预警火车票创建订单成功量下跌，影响建单量，故障原因初步确认是wtrs直达ota接口渲染异常导致，于00:14通过代码回滚完成止血，故障恢复，期间未收到客诉，根据监控下跌幅度判定，达P3故障等级。\n\n##### 影响面：\n- [x] 是否影响可用性：否\n- [x] 业务影响：\n+ 火车票直达ota（车次详情）渲染下跌，直达ota不可用，ota页面报错\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/jpeg/41240/1722326721717-3ca439f2-2e5d-47e1-afdb-4947a79ba5b1.jpeg)\n\n+ 建单下跌超过40%，最低下跌59%，持续25分钟（7月25日 23:47-7月26日 00:11）\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/114856514/1722228020205-3aa7ad0f-1d29-459c-baa7-5006506fb5db.png?x-oss-process=image%2Fformat%2Cwebp%2Fresize%2Cw_1500%2Climit_0)\n\n- [x] 是否有客诉：否\n- [x] 是否有社会舆情_：_否\n- [x] 是否产生资损：否\n\n## 二、故障过程回顾\n2024-07-25 17:05，[@擎锋](undefined/zhangrikang.zrk)在train-product-model中修改了部分枚举，并重新打包向Maven仓库推送1.0.0-SNAPSHOT版本**【故障注入】**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/114356292/1721992621440-d2fcd500-c9c3-46ab-8257-43ea38780584.png)\n\n2024-07-25 21:32，[@臾阳](undefined/xiongjieteng.xjt)部署主预发进行自测\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/114856514/1722050264423-663f8605-51a7-4da9-8a58-5bf509df4371.png)\n\n2024-07-25 21:33，[@臾阳](undefined/xiongjieteng.xjt)提交wtrs代码CR\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/114856514/1722071500758-222090ac-85d4-4f53-9324-f81cb9de6418.png)\n\n2024-07-25 21:43，wtrs发布安全生产\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/114856514/1721955117951-0143e5f5-0190-4e2b-ad3f-fa04afa1a1b1.png)\n\n2024-07-25 22:03，观察ateye安全生产异常日志，无明显异常日志（后发现发布期间ateye异常统计存在20分钟左右的延迟）\n\n2024-07-25 22:24，wtrs正式发布线上，分四批上线。第一批在22:27:13发布完成。第二批：23:26:00 发布完成；第三批：23:29:25 发布完成；第四批：23:47:39 发布完成\n\n2024-07-25 22:30，观察ateye异常日志，无异常日志（后发现ateye异常统计存在20分钟左右的延迟）\n\n2024-07-25 23:24，火车票车次详情成功率小于80%，因未主动订阅所以未收到预警，同时故障场景监控项未替换为新接口监控，也未触发GOC预警\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/114856514/1722079604965-ef77abf2-da8b-4147-8e48-3049f14778b5.png)\n\n2024-07-25 23:45，火车票渲染订单下跌大于20%（配置的夜间预警值要下跌达到60%才预警，因此未触发GOC告警）\n\n监控地址：[https://x.alibaba-inc.com/custom/59/product/preview/spm/4086](https://x.alibaba-inc.com/custom/59/product/preview/spm/4086)![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/114856514/1722326180936-1c828211-f587-4916-8f3c-c32142f21aa2.png)\n\n2024-07-25 23:50，交易侧[@云鸿](undefined/yunhong.cb)发现告警，并进入排查**【业务响应】**\n\n![](https://intranetproxy.al",
    "chunk_order_index": 0,
    "full_doc_id": "doc-71403fb4f621ba19bdb722ab1b586797"
  },
  "chunk-10dd6f715713da4edf1f2c2c21684251": {
    "tokens": 1200,
    "content": "6)![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/114856514/1722326180936-1c828211-f587-4916-8f3c-c32142f21aa2.png)\n\n2024-07-25 23:50，交易侧[@云鸿](undefined/yunhong.cb)发现告警，并进入排查**【业务响应】**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/114856514/1722228843524-285fc89d-ac2d-4495-98c1-f125063bdad8.png)\n\n2024-07-25 23:53，飞猪风险预警信息同步群出现第一次风险预警**【故障发现】**\n\n| 保险推荐告警 | 建单成功率告警 |\n| --- | --- |\n| ![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/114856514/1722072071658-e48edc9d-3f28-4ab8-aa35-e3097b1febb5.png) | ![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/114856514/1722072054314-47b4875e-a71d-44fc-a03a-2cb0897b39ee.png) |\n\n\n2024-07-25 23:54，保险侧同学排查问题，是行业问题****\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/114856514/1722072311744-c930f795-c291-4c9e-a5ac-3e5395bf013f.png)\n\n2024-07-25 23:55，城木电话，通知说线上故障，建单量下跌，ota成功率下跌\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/114856514/1722050317347-00b3a3c3-766e-432f-b36d-cea458bf15b4.png)\n\n2024-07-25 23:56，火车票创建订单成功量最近10分钟与基线同比下跌大于20%，成功量最近10分钟最小值大于30（23:47-23:56），触发P4**【故障发生】**\n\n2024-07-25 23:57，交易同学发现线上建单量下跌，群里进行周知\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/114856514/1722073962739-af9ac32b-7675-4ca9-b9fa-8048788fb8c8.png)\n\n2024-07-25 23:58，通过异常日志已经定位到是依赖的二方包中的枚举缺失导致二方包中的isMatch方法异常**【初因定位】**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/114856514/1722050663923-5e3bce52-1d3d-4843-b83b-307d31c83633.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/114356292/1722060509514-e89ddbad-d06e-417b-b734-6279db979420.png)\n\n2024-07-25 23:59，由于判断错误，误以为回滚无用，需要重新打包再重启才能解决问题，所以同时联系擎锋重新打包\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/114856514/1722050785599-3305c8ba-e34e-4a87-a147-ed57e6db3d4e.png)\n\n2024-07-26 00:04，[@城木](undefined/fengwenbo.fwb)操作重启\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/114856514/1721955521604-ba6b5742-aa1e-4f0a-b812-5cd3aaa493cd.png)\n\n2024-07-26 00:06，成功量持续十分钟下跌40%（23:57-00:06），故障升级至P3。\n\n2024-07-26 00:07，第一批重启成功，但是成功量未恢复\n\n2024-07-26 00:09，臾阳操作回滚，分三批。第一批：2024-07-26 00:11:40  回滚成功；第二批：2024-07-26 00:14:50 回滚成功；第三批：2024-07-26 00:17:59 回滚结束**【恢复执行】**\n\n2024-07-26 00:12，监控恢复至基线水准\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/114856514/1722083235546-5e403896-6a36-4407-9ca1-4c2743acfc57.png)\n\n2024-07-26 00:14，第二批回滚完成，故障完全",
    "chunk_order_index": 1,
    "full_doc_id": "doc-71403fb4f621ba19bdb722ab1b586797"
  },
  "chunk-483af1603632b92b8933430c075ceda0": {
    "tokens": 1200,
    "content": "执行】**\n\n2024-07-26 00:12，监控恢复至基线水准\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/114856514/1722083235546-5e403896-6a36-4407-9ca1-4c2743acfc57.png)\n\n2024-07-26 00:14，第二批回滚完成，故障完全恢复**【故障恢复】**\n\n## 三、故障原因\n### 3.1【背景说明】\n**wtrs变更背景：**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/114856514/1722071500758-222090ac-85d4-4f53-9324-f81cb9de6418.png?x-oss-process=image%2Fformat%2Cwebp%2Fresize%2Cw_1500%2Climit_0)\n\n7月份暑运上线了较多需求，产品和业务迫切需要知道线上效果数据，方便对业务做一些调整，同时评估代码改动小，影响范围可控，且周四能发完周五是一天真实完整的数据（数据T+1才能看到）\n\n代码改动目的：修改埋点的结构，BI同学解析埋点数据的时候得是逗号拼接的才可以，代码修改是为了将数组格式的数据改成逗号拼接的。\n\n**删除二方包枚举的背景：**\n\n由于新场景的增加，之前已有的枚举已经不能满足多场景需求，需要对枚举进行扩充，同时考虑到老的枚举不能见明知意，所以进行修改，考虑到该枚举未在client包中直接对外提供，误以为修改无影响，没考虑到对外提供的二方包中的间接引用。\n\n**业务依赖关系：**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/114856514/1722327683664-0eff8f73-4071-4bdd-8066-b8e1d1e57b6d.png)\n\n### 3.2【原因分析】\n#### 一句话原因：\n线上间接引用了快照版本的二方包，预发分支删除了部分枚举并deploy到maven仓库，导致线上重新构建时拉取到了缺陷二方包，在运行时二方包方法调用时候发生异常。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/114856514/1722083875314-e302fb4a-54dc-4d39-9384-9daac44f1b07.png)\n\n**二方包依赖结构：**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/114856514/1722056407065-2f782276-f546-4ed9-a7d9-e57e61d0115f.png)\n\n#### 根因分析：\n##### 项目结构：\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/114856514/1722175441236-62d59d34-fce2-4a07-acd5-55c7a01a5893.png)\n\n##### 故障引入过程：\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/114856514/1722228597730-83d72be5-dbb7-4aa0-a6c6-5bb1966482d0.png)\n\n打包的时候，只把train-product-client和train-product-model进行了打包，未对train-product进行打包，导致线上依赖的还是1.0.0-SNAPSHOT版本的train-product-model包，改动内部的枚举值后，直接将远程仓库的快照包覆盖，从而导致二方包提供的方法异常。\n\n##### 详细描述：\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/114356292/1721973404741-aba04aad-78c7-49c1-8e0f-d4a0f680d963.png?x-oss-process=image%2Fformat%2Cwebp%2Fresize%2Cw_726%2Climit_0)  \n在6月25日的上线需求中，按照DDD的思想对项目结构进行了调整，新增了一个名为 `train-product-model` 的模块，用于存储client和领域层共用的枚举。在client和领域层的 `pom.xml` 文件中，添加了对该模块的依赖，试图通过父pom的版本管理来统一版本。\n\n `train-product-client`的pom： \n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/114356292/1721974667779-b3713e5c-8a3c-4dba-ad89-7416e8023b07.png?x-oss-process=image%2Fformat%2Cwebp%2Fresize%2Cw_1352%2Climit_0)\n\n项目代码中父pom的内容如下，以为可以依赖 `train-product-model` 的正式版本：\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024",
    "chunk_order_index": 2,
    "full_doc_id": "doc-71403fb4f621ba19bdb722ab1b586797"
  },
  "chunk-1ec82f50ef91f3334523eaba88f3f155": {
    "tokens": 1200,
    "content": "3713e5c-8a3c-4dba-ad89-7416e8023b07.png?x-oss-process=image%2Fformat%2Cwebp%2Fresize%2Cw_1352%2Climit_0)\n\n项目代码中父pom的内容如下，以为可以依赖 `train-product-model` 的正式版本：\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/114356292/1721974724507-92a3ae95-bc48-42d9-9f4e-3bd0b93b1733.png?x-oss-process=image%2Fformat%2Cwebp%2Fresize%2Cw_1186%2Climit_0)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/114356292/1721974708149-853448c1-d091-4928-bf29-5d855270f4a8.png?x-oss-process=image%2Fformat%2Cwebp%2Fresize%2Cw_1252%2Climit_0)\n\n**但实际情况是**： `train-product-client` 是依赖的 `1.0.0-SNAPSHOT`快照版本的父pom，在项目代码中的父pom跟这个快照父pom内容不一致。在开发阶段已经对快照父pom进行了deploy，之后便一直没有deploy过，而快照父pom中 `train-product-model` 的版本为 `1.0.0-SNAPSHOT`。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/114356292/1721978307980-607513ce-253b-47e9-87cd-22f7e1dfa6cc.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/114356292/1721978554015-af9ec2b0-181a-4871-84ae-cf81c3a3c1d4.png)\n\n此后即便在项目中更新了父pom中`train-product-model`的版本号（仅在项目代码中将1.0.0-SNAPSHOT，更新为1.0.1是无效的，必须重新deploy父pom），**Maven 远程仓库中父pom中的版本管理仍然保持不变**。因此，线上环境始终使用的是快照版本而非正式版本。\n\n这导致在预发分支中deploy了`train-product-model`的快照版本之后，线上如果重新构建则会拉取到新代码，从而导致运行到修改的位置时，发现枚举找不到报错。\n\n**问题解决方式：**\n\n1. 在`train-product-client`中指定`train-product-model`版本号，将版本写死，不能使用占位符形式指定\n2. 父pom使用正式版本号管理，不要使用快照，通过二方库打正式包的管控来杜绝父pom中出现快照版本\n\n## 四、关注点分析\n**【系统质量】**\n\n**1、若本次二方包的引用方式是正常合规的话，如何避免后续该类情况发生？**\n\n**问题总结**：SNAPSHOT依赖的卡点功能有，建议单应用维度打开，需要团队内部评估，但是整体层面上不会去推这个事情，风险太高。\n\n**【故障发现&响应】**\n\n**1、本次故障是建单下跌预警发现，搜索为何未触发预警？**\n\n**问题总结**：\n\n+ 搜索详情无结果故障场景（[链接](https://tr.alibaba-inc.com/orm/config/emergency-scene/list/online?children=true&nodeId=46117&depth=1&__tenant__=alibabaGroup&buId=17713&description=&includeRule=true&scenarioTypes%5B0%5D=FAULT_RISK&scenarioTypes%5B1%5D=FAULT&name=%E6%90%9C%E7%B4%A2&refId=fd9654bf673004ef)）关联的接口项是老接口监控，未替换为新接口监控（行业车次详情-GOC监控：[https://x.alibaba-inc.com/custom/59/product/preview/spm/15450](https://x.alibaba-inc.com/custom/59/product/preview/spm/15450)），因此未触发风险预警卡片\n+ 新接口监控（行业分渠道监控：[https://x.alibaba-inc.com/custom/59/product/preview/spm/16440](https://x.alibaba-inc.com/custom/59/product/preview/spm/16440)）未配置订阅，所以未收到任何告警\n\n**action：**\n\n+ 故障场景关联监控替换  7.26 done [@边遥](undefined/jing.zengj)\n+ 飞猪故障场景及关联监控再次进行核查，确保监控项为最新链接 [@边遥](undefined/jing.zengj) 8.5\n+ 行业监控配置新增订阅，确保可以正常告警    7.26 done [@臾阳](undefined/xiongjieteng.xjt)\n+ 搜索侧safe异常梳理 [@恒磊](undefined/henglei.zhl) 8.10\n\n### 4.1【系统质量】\n#### 4.1.2",
    "chunk_order_index": 3,
    "full_doc_id": "doc-71403fb4f621ba19bdb722ab1b586797"
  },
  "chunk-89ee18302616024618ee189d179f3944": {
    "tokens": 1200,
    "content": "项为最新链接 [@边遥](undefined/jing.zengj) 8.5\n+ 行业监控配置新增订阅，确保可以正常告警    7.26 done [@臾阳](undefined/xiongjieteng.xjt)\n+ 搜索侧safe异常梳理 [@恒磊](undefined/henglei.zhl) 8.10\n\n### 4.1【系统质量】\n#### 4.1.2 代码质量\n**〖关注点1〗是否代码自身存在漏洞或BUG、代码健壮性是否存在问题等?**\n\n**〖问题分析〗**不涉及\n\n****\n\n**〖关注点2〗****是否经过CodeReview？CodeReview阶段是否发现问题？为何没发现？**\n\n+ **是否经过CR**\n    - [x] 是\n    - [ ] 否\n    - [ ] 不涉及\n\nCR链接：[https://code.alibaba-inc.com/alitriptraffic/wtrs/codereview/17676156](https://code.alibaba-inc.com/alitriptraffic/wtrs/codereview/17676156)\n\n+ **是否设置合理的CR卡点**\n    - [x] 是\n    - [ ] 否\n    - [ ] 不涉及\n+ **CodeReview阶段是否发现问题？为何没发现？后续如何发现？**\n    - [ ] 是\n    - [x] 否，此次改动代码和引起故障代码没有任何交集\n    - [ ] 不涉及\n\n\n\n**〖关注点3〗****测试阶段**\n\n+ **测试内容：**预发和安全生产验证是通过登陆机器、观察对应的埋点数据是否包含对应的字段和数据格式是否正确\n+ **测试人员：**开发自测\n+ **是否经过测试验证**\n    - [x] 是，验证环境\n        - [x] 预发环境\n        - [ ] 日常环境\n    - [ ] 是，测试方法\n        - [ ] 单元测试\n        - [ ] 功能回归测试\n        - [ ] 集成测试/链路测试\n        - [ ] 验收测试\n    - [ ] 否\n    - [ ] 不涉及\n+ **测试未发现原因是什么？后续如何改进？**\n    - [ ] 回归测试遗漏\n        - [ ] 手工回归测试用例遗漏\n        - [ ] 自动化未建设\n        - [ ] 自动化回归覆盖不足\n        - [ ] 其他：\n    - [ ] 新场景测试遗漏\n        - [ ] 功能测试用例遗漏，包括正常分支和异常分支\n        - [ ] 容灾兜底测试遗漏\n        - [ ] 客户端兼容性测试遗漏\n        - [ ] 埋点测试遗漏\n        - [ ] 性能测试遗漏，影响评估不足\n        - [ ] 安全测试遗漏\n    - [x] 其他：由于改动影响的只有埋点，所以在测试时仅在机器上查看了对应的日志信息，没有对业务流程进行测试\n\n**〖问题总结〗**测试过程中仅对代码改动进行测试，没有对现有的业务流程进行回归\n\n**〖改进点〗**_****_\n\n1、测试过程中需要对现有主流程进行回归，确保变更后主流程没问题\n\n2、keyaction：完善自动化case卡点，对主流程接口做硬性校验拦截，wtrs自动化case核心接口覆盖率达到100%  [@婉风](undefined/weili.fwl) 8.10 \n\n#### 4.1.3 变更质量\n+ **是否涉及变更：**\n    - [x] 是\n    - [ ] 否\n+ **变更类型：**\n    - [x] 代码发布\n    - [ ] 配置变更\n    - [ ] 其他变更：____________\n    - [ ] 不涉及\n+ **变更平台是否接入ChangeFree：**\n    - [x] 是，CF变更单链接：[https://aicf.alibaba-inc.com/aicf/approval/detail/7788881](https://aicf.alibaba-inc.com/aicf/approval/detail/7788881)\n    - [ ] 否\n+ **是否违反变更红线3.1**** **[链接](https://aliyuque.antfin.com/ngoc/fzg6dy/uar1k6)\n    - [ ] 是，违反哪条原则：\n    - [x] 否\n\n\n\n**〖关注点1〗****灰度阶段**\n\n+ **是否经过灰度：**\n    - [x] 是\n    - [ ] 否\n+ **观测了哪些监控**：_可以附链接_\n    - [ ] 黑屏、白屏\n    - [ ] GOC监控：\n    - [ ] 系统大盘：\n    - [x] 其他：ateye异常监控 [https://ateye.trip.taobao.com/monitor/exceptionList.htm?app=wtrs](https://ateye.trip.taobao.com/monitor/exceptionList.htm?app=wtrs)\n+ **是否灰度期间发现问题？**\n    - [ ] 是\n        - [ ] 是否灰度流量过大，导致故障\n        - [ ] 灰度发现但未有效或及时修复，导致故障\n        - [ ] 其他：___________\n    - [x] 否，后续如何灰度发现？\n+ **未灰度发现原因**\n    - [",
    "chunk_order_index": 4,
    "full_doc_id": "doc-71403fb4f621ba19bdb722ab1b586797"
  },
  "chunk-4e60c3cdf2d394b4de6b20c9ec2c0bc7": {
    "tokens": 1200,
    "content": ".com/monitor/exceptionList.htm?app=wtrs)\n+ **是否灰度期间发现问题？**\n    - [ ] 是\n        - [ ] 是否灰度流量过大，导致故障\n        - [ ] 灰度发现但未有效或及时修复，导致故障\n        - [ ] 其他：___________\n    - [x] 否，后续如何灰度发现？\n+ **未灰度发现原因**\n    - [ ] 应用灰\n        - [ ] 灰度流量太小\n        - [ ] 灰度阶段无监控\n        - [ ] 灰度批次不合理\n        - [ ] 超长时间灰度才能发现\n    - [ ] 业务灰：策略不合理\n    - [ ] 灰度无法发现\n    - [x] 其他：导购侧没有报警，有监控，无订阅，没有主动去看监控（问题接口为新接口，线上监控未配置订阅）\n\n**〖问题总结〗**\n\n1、无报警、监控不完善、无订阅\n2、未主动去查看监控，未第一时间发现问题\n\n**〖改进点〗**_****_\n\n1、完善新接口监控，配置合理阈值以及配置相关的订阅\n\n2、第一批灰度时间尽量长一些，观察ateye异常的同时，需要关注监控和交易大盘等\n\n3、在安全生产发布之后，线上对主链路进行测试，看从商品渲染到下单是否存在问题\n\n4、搜索监控区分夜间和非夜间版本，要和对应交易侧的预警指标相匹配 [@婉风](undefined/weili.fwl) 8.2 \n\n\n\n**〖关注点2〗****上线阶段**\n\n+ **是否有确定的监控观测指标**\n    - [x] 是，监控指标及监控链接：[https://ateye.trip.taobao.com/monitor/exceptionList.htm?app=wtrs](https://ateye.trip.taobao.com/monitor/exceptionList.htm?app=wtrs)\n    - [ ] 否\n+ **是否在窗口期进行发布变更**\n    - [ ] 是\n    - [x] 否，原因：产品和业务要效果数据比较急，同时评估代码改动小，影响范围可控\n+ **变更是否影响上下游**\n    - [ ] 是，是否有提前知会上下游评估及关注变更\n        - [ ] 有提前知会\n        - [ ] 没有提前知会\n    - [x] 否，变更为埋点变更，不影响业务逻辑和上下游\n\n**〖问题总结〗**\n\n1、非窗口期发布\n2、未主动看监控，监控无订阅、无告警\n\n**〖改进点〗**_****_\n\n1、上线发布的同时需要密切关注监控和告警，即使改动很小，也需要确保主链路不受影响\n\n2、应该避免非窗口期发布\n\n### 4.2【处置能力】\n#### 4.2.1 故障发现&响应\n+ **是否监控发现**\n    - [ ] 故障触发方 监控发现\n    - [x] 故障受影响方 监控发现\n    - [ ] 否，原因为：（监控无效/监控缺失）\n+ **是否5分钟内响应**\n    - [x] 是\n    - [ ] 否，原因为：\n+ **是否存在应急协同问题**\n    - [x] 是\n        - [x] 应急流程不明确（无流程或者流程不清晰、应急相关角色&职责不明确，缺失一号位等)\n        - [ ] 应急执行不到位（有流程，但未按流程执行，通告发送不及时，响应不及时等）\n    - [ ] 否\n\n**〖问题总结〗**\n\n1、夜间应急流程不完善\n\n2、应急策略有误，没有第一时间执行回滚\n\n**〖改进点〗**_****_\n\n1、完善应急处理流程，并在预发或者安全生产进行演练\n\n2、遇到代码处理异常类问题，且涉及到发布的，第一时间回滚\n\n#### 4.2.2 故障定位&恢复\n+ **主要恢复方式：**\n    - [x] 代码发布/回滚\n    - [ ] 配置发布/回滚\n    - [ ] 数据订正\n    - [ ] 机器隔离/重启/扩容\n    - [ ] 配置限流\n    - [ ] 预案降级\n    - [ ] 自动恢复\n    - [ ] 其他：\n\n**〖关注点1〗定位&恢复阶段存在什么问题？是否可以增加预案，****有更快的恢复方式？****相关的优化改进？**\n\n**〖问题总结〗**恢复阶段存在判断失误，认为回滚不能解决问题，需要重新打包后才能解决，故在过程中耽误部分时间，造成故障持续时间有所增加。回滚为当时最优的恢复方式。\n\n**〖改进点〗**\n\n1、加强安全生产意识，即使一行代码也要时刻观察监控以及告警\n\n2、完善监控配置，做到有监控必有订阅\n\n3、遇到发布问题，第一时间回滚\n\n## 五、故",
    "chunk_order_index": 5,
    "full_doc_id": "doc-71403fb4f621ba19bdb722ab1b586797"
  },
  "chunk-07d1e14cc67663deed4cea993a0fbba8": {
    "tokens": 490,
    "content": "解决问题，需要重新打包后才能解决，故在过程中耽误部分时间，造成故障持续时间有所增加。回滚为当时最优的恢复方式。\n\n**〖改进点〗**\n\n1、加强安全生产意识，即使一行代码也要时刻观察监控以及告警\n\n2、完善监控配置，做到有监控必有订阅\n\n3、遇到发布问题，第一时间回滚\n\n## 五、故障Action\n| **序号** | *******Action** | *******负责人** | *******计划完成时间** | **是否keyAction** |\n| :---: | --- | :---: | :---: | --- |\n| 1 | 短期：将train-product应用maven版本管理进行优化 | 臾阳 | 7.26已完成 | 否 |\n| 2 | 短期：火车票导购侧货架相关新接口监控增加订阅 | 臾阳 | 7.26已完成 | 否 |\n| 3 | 短期：火车票相关GOC预警二次check | 臾阳 | 7.26已完成 | 否 |\n| 4 | 短期：火车票导购侧业务监控大盘完善 | 叔鱼 | 7.26已完成 | 否 |\n| 5 | 短期：故障场景关联监控替换 | 边遥 | 7.26已完成 | 否 |\n| 6 | 短期：搜索监控区分夜间和非夜间版本，要和对应交易侧的预警指标相匹配 | 婉风 | 8.2 | 否 |\n| 7 | 短期：飞猪故障场景及关联监控再次进行核查，确保监控项为最新链接 | 边遥 | 8.5 | 否 |\n| 8 | 短期：搜索侧safe异常梳理 | 恒磊 | 8.10 | 否 |\n| 9 | 长期：梳理自动化case，补全缺失接口的自动化case，做到主链路case覆盖100% | 婉风 | 8.10 | 是 |",
    "chunk_order_index": 6,
    "full_doc_id": "doc-71403fb4f621ba19bdb722ab1b586797"
  },
  "chunk-cc3197696f1d63a17f7d81a0ac4754dc": {
    "tokens": 1200,
    "content": "## 一、故障简述（含影响产品线及影响面）\n##### 故障概述：\n2024年8月8日10:49监控发现商品库存写入流量异常增加多倍，用户端现象是：Rate在搜索能够透出，但是从detail到下单页，商品返回库存不足，下单顺畅率下跌和部分价格更新延时，故障原因确认来自套餐转售铺货规则批量更新，目前在该转售场景上铺货系统设计实现层面存在数据更新放大问题，会针对转售房型下面的150w rate执行商品库存的重新计算，生产了2700w消息量，是平时消息量的2700倍，触发货商选dii整个链路数据延迟，后通过问题消息TOPIC重置、代码发布和数据链路扩容等多个手段，故障止血，链路在8月9日00:05恢复至正常水位。基于业务影响及警示维度考虑，由飞猪稳定性决策委员会决策，本次故障定级为P3。\n\n##### 影响面：\n- [x] 是否影响可用性：否\n- [x] 业务影响：\n\n业务影响说明：8.8相对8.7订单量下跌2w间夜(主要在分销侧)，同比上周下跌6571间夜，总持续13小时。\n\n| 间夜 | 同比昨天间夜涨跌 | 同比上周间夜涨跌 | 8月8号 | 8月7号 | 8月1号 |\n| --- | --- | --- | --- | --- | --- |\n| 飞猪大盘间夜 | -20141 | -6571 | 343115 | 363256 | 349686 |\n| 直销间夜 | -7231 | -6010 | 173606 | 180837 | 179616 |\n| 分销间夜-整体 | -12910 | -558 | 169509 | 182419 | 170067 |\n| 分销间夜-高德 | -2217 | +5350 | 92810 | 95027 | 87460 |\n| 分销间夜-阿信 | -6201 | -2291 | 67448 | 73649 | 69739 |\n| 分销间夜-快跑 | -4331 | -3683 | 6468 | 10799 | 10151 |\n\n\n- [x] 是否有客诉：\n\n分销端顺畅率下跌投诉、商家/BD改价改库延迟\n\n- [x] 是否有社会舆情：否\n- [x] 是否产生资损：__\n\n资损影响说明：这里因价格同步延迟，会影响主端价格延迟生效，过程价格资损难以汇总统计，目前反馈来看免房侧因商品和导购侧价格不一致，部分订单价格定低售出，总定低涉及到的订单12单，金额1153。\n\n## 二、故障过程回顾\n**2024-08-08 10:38:00**，小二操作转售，核心动作包括：剔除宝贝、新增铺货规则、新增大通兑宝贝**【风险注入】**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/224991/1723116377629-fe66560e-d654-4818-b0ab-4b242c4a21fa.png)\n\n+ 2024-08-08 10:38:00 triptuan开始调用规则更新接口，**下线规则，总调用次数7037，QPS 40左右，持续时间5分钟,同时，调用创建铺货规则接口，调用量6930次，峰值QPS 20左右，持续时间16分钟，注意，新建逻辑里重新铺货会生成新的虚拟hid、rid、rate、rp**\n\n2024-08-08 10:48，**【故障发生】**\n\n+ 收到货品库hotel_supplier_ic、商品库hotel_ic_goods数据库告警，开始介入排查\n2024-08-08 10:49，**【故障发现】**\n\n+ 根据货商同步流量监控，基本上商品库写入流量大的卖家主要是经济连锁：速8、锦江、尚客优、首旅如家，从监控上发现商品库存写入流量翻了很多倍，如下图：速8酒店旗舰店和尚客优旗舰店流量趋势图\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/233807/1723177929982-d4d82cfb-e4ec-4564-ab12-8c519652bf86.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/233807/1723178163534-2edca535-992c-4fbf-aa19-c583758480da.png)\n\n2024-08-08 10:53，**【业务响应】**\n\n+ 2024-08-08 10:53 联系连锁业务，确认是否是商家在推送价库信息；\n+ 2024-08-08 10:58 操作TOP推送限流；\n+ 2024-08-08 11:01 又出现库存更新流量上涨的告警，这次是锦江：\n\n![](https://intranetproxy.alipay.com",
    "chunk_order_index": 0,
    "full_doc_id": "doc-d3800a7a16dd7ede07c377739da7c530"
  },
  "chunk-206aef5b2ea1f44e2a2256745a87a4f7": {
    "tokens": 1200,
    "content": "-08 10:53，**【业务响应】**\n\n+ 2024-08-08 10:53 联系连锁业务，确认是否是商家在推送价库信息；\n+ 2024-08-08 10:58 操作TOP推送限流；\n+ 2024-08-08 11:01 又出现库存更新流量上涨的告警，这次是锦江：\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/233807/1723183154785-f0dc1951-cac9-4856-acc8-6fd91e97aa59.png)\n\n2024-08-08 11:03 通过排查，可以确定流量不是来自直连对接，而是来自铺货；\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/233807/1723183263480-6ed8617f-c530-4f33-aecf-3a300f2ba33c.png)\n\n2024-08-08 11:11，**【初因定位】【根因定位】**\n\n+ 最后排查下来，流量是来自于metaq消息，对应TOPIC：HOTEL_SHOPPING_ITEM_TOPIC，联系业务停止操作任何转售规则，套餐侧定时更新转售规则任务停掉。\n2024-08-08 11:17，**【恢复执行】**\n\n+ 2024-08-08 11:17 【货商同步链路】- 发现【精卫-货商同步-非高产】任务延迟，排查延迟影响\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/114856462/1723190925377-832d90c5-d0b1-4874-9506-e38a883b5c7f.png)\n\n+ **2024-08-08 11:25 **【铺货中心】- **针对铺货规则更新接口，铺货中心设置sentinel限流**【执行操作】\n+ 2024-08-08 11:28 【货商同步链路】- 联系精卫同学，执行【精卫-货商同步-非高产】任务扩容【执行操作】\n+ **2024-08-08 11:34 **【货商同步链路】- **货商同步精卫链路，进行高产卖家持续切流**【执行操作】\n+ **2024-08-08 11:38 **【库存中心】- **库存中心非核心分组扩容 **【执行操作】\n+ 2024-08-08 11:42 【货商同步链路】- 发现【精卫-货商同步-高产】**任务延迟，联系扩容**【执行操作】\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/114856462/1723195695315-535495e3-1cc6-4241-b833-7dab0f81616c.png)\n\n+ **2024-08-08 11:54 **【铺货中心】- **铺货中心扩容，高产卖家分组 24 -> 44 **【执行操作】\n+ **2024-08-08 12:08 **【货商同步链路】- **【精卫-货商同步-高产】切流后任务rt升高，持续观察一段时间后，切回老链路 **【执行操作】\n+ 2024-08-08 12:14 【铺货中心】- 铺货中心优化代码，增加metaq消息的消费限流、有效子itemId过滤逻辑【执行操作】\n+ **2024-08-08 12:19 **【铺货中心】- **铺货中心扩容，非高产卖家分组 169 -> 214 **【执行操作】\n+ **2024-08-08 12:53 **【铺货中心】- **铺货**中心开始发布【执行操作】\n+ **2024-08-08 14:02 **【铺货中心】- **经确认影响后，HOTEL_SHOPPING_ITEM_TOPIC消息开始丢弃 **【执行操作】\n+ 2024-08-08 14:03 【铺货中心】- 铺货中心优化代码，优化metaq消息的消费限流，套餐转售-同步Item消息发生限流，直接丢弃【执行操作\n+ **2024-08-08 14:10 **【铺货中心】- **铺货**中心开始发布【执行操作】\n+ **2024-08-08 14:15 **【铺货中心】- HOTEL_SHOPPING_ITEM_TOPIC消息仍然在生产，发现安全生产机器（33.58.205.39、33.60.107.44）存在问题，机器执行下线，消息不再生产 【执行操作】\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/114856462/1723198214047-eac7966b-12e3-4432-a136-706005dbf118.png)\n\n\n\n+ **2024-08-08 14:22 **【货商同步链路】- **经电话会议讨论后，操作如下：**\n    - **决定进行继续【精卫-货商同步-高产】任务切流 **【执行操作】\n    - **重置精卫位点，丢弃延",
    "chunk_order_index": 1,
    "full_doc_id": "doc-d3800a7a16dd7ede07c377739da7c530"
  },
  "chunk-3b93eaafe10dc5af8346c523d9a05437": {
    "tokens": 1200,
    "content": "856462/1723198214047-eac7966b-12e3-4432-a136-706005dbf118.png)\n\n\n\n+ **2024-08-08 14:22 **【货商同步链路】- **经电话会议讨论后，操作如下：**\n    - **决定进行继续【精卫-货商同步-高产】任务切流 **【执行操作】\n    - **重置精卫位点，丢弃延迟的增量消息 **【执行操作】\n    - **补高产卖家的全量数据（inventory、rate）**【执行操作】\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/114856462/1723201850757-5cbb6c1a-d1b6-421a-9acb-0d5a64129210.png)\n\n+ 2024-08-08 15:09 【商选同步链路】- 【精卫-商选同步-1】【精卫-商选同步-2】**任务延迟，修改处理配置，联系扩容**【执行操作】\n+ 2024-08-08 15:16 【商选同步链路】- 【精卫-商品库同步OTS-inv】**任务延迟，联系扩容**【执行操作】\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/114856462/1723198654339-879e0e1d-446a-4e32-8cff-f0c970da907e.png)\n\n+ 2024-08-08 15:30 【导购】- 数据延迟高，写入量增大\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/114856462/1723212109870-1b39e571-6b0e-4ff1-b739-30d44c58b03d.png)\n\n+ 2024-08-08 15:32 【选品库】- HOTEL_IC_SELECTION_APP选品库开始扩容【执行操作】\n+ 2024-08-08 15:49 【货商同步链路】- 【精卫-货商同步-非高产】延迟恢复，执行缩容【执行操作】【货商一致率恢复到99%以上，到正常水位】\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/114856462/1723202530898-39fa178a-6702-4f50-a136-9167d64b789a.png)\n\n\n\n+ 2024-08-08 16:22 【商选同步链路】- 高产卖家链路，【精卫-商选同步-1】【精卫-商选同步-2】延迟过高，执行重置位点操作，并针对部分高产卖家数据全量补全【执行操作】\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/114856462/1723204322520-a5a6e45e-cb5f-49e1-8d8a-1c996450a27f.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/114856462/1723204389818-6b7e81fb-5338-4fa8-a286-99b7bd85a7a8.png)\n\n\n\n+ 2024-08-08 16:23 导购侧sora开始跑全量任务，开始基于4点的全量选品库变更，导购进行大全量同步\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/114856462/1723212613772-8c2edf63-fd9b-4693-82c3-bcacea35d3ea.png)\n\n\n\n+ 2024-08-08 16:50 【初筛选品-blink】- summary任务堆积，反压100%，为避免blink任务挂掉，执行重启【执行操作】\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/114856462/1723260018821-2c1aef0b-5a57-47f5-806c-f5d3783a9b48.png)\n\n+ 2024-08-08 17:48 【选品侧】商选高产买家链路，因为精卫全量同步任务机制和存量任务机制存在差距，导致垃圾数据被写入选品库。经电话会议，执行如下操作：\n    - 【商选同步链路】- 停止数据补全【执行操作】\n    - 【商选同步链路】- 开发定时任务：根据卖家循环捞出过选品的rate(OTS中间结果)，将对应的商品库存更新至选品库库存【执行操作】\n    - 【货商同步链路】- 新建货商同步全量任务，货品rate和商品rate价格进行同步【执行操作】\n+ 2024-08-08 17:53【导购侧】过程中因为选品库hotel_ic_selection基于选品精卫任务扩容后需要扩容选品库，扩容过程中存在主备切换，导致导购dii全量任务失败，联系相关技术进行排查并继续执行全量",
    "chunk_order_index": 2,
    "full_doc_id": "doc-d3800a7a16dd7ede07c377739da7c530"
  },
  "chunk-39ccd1ed8cd37e07d642f66fc2f2cbd3": {
    "tokens": 1200,
    "content": "货商同步链路】- 新建货商同步全量任务，货品rate和商品rate价格进行同步【执行操作】\n+ 2024-08-08 17:53【导购侧】过程中因为选品库hotel_ic_selection基于选品精卫任务扩容后需要扩容选品库，扩容过程中存在主备切换，导致导购dii全量任务失败，联系相关技术进行排查并继续执行全量任务【执行操作】【导购和商品数据不一致率仍然在，顺畅率持续在70%上下】\n+ 2024-08-08 17:59【导购侧】联系相关技术进行排查并继续执行全量任务，此时全量任务的位点因dii操作问题还是16:00，不是从最新的18:00开始\n+ 2024-08-08 19:14 【导购侧】- Sora大全量任务完成，开始切换。延迟上升，因为要追3小时（16点-19点）增量，更本追不上。决定：dii开始废弃大全量任务，增量任务继续在原来基础上追【执行操作】\n+ 2024-08-08 19:27   顺畅率恢复到85%，这里顺畅率没有恢复至90%以上主要是因为导购大全量同步位点是16点，16点之后的增量部分还在追一致性。\n+ 2024-08-08 19:38 【商选同步链路】- 导购侧大全量之后，性能可以支持商选全量补数据，库存数据补全任务开发完成，执行测试验证\n+ 2024-08-08 20:24 【商选同步链路】- 库存数据补全任务开始执行【执行操作】\n+ 2024-08-08 20:30   导购侧再次执行切大全量，导购侧消息堆积，顺畅率开始下跌趋势。\n+ 2024-08-08 20:35   导购侧停止大全量，开始追增量数据\n+ 2024-08-08 22:05 【货商同步链路、商选同步链路】- 扩容的精卫任务开始缩容【执行操作】\n2024-08-09 00:05 ，**【故障恢复】**\n\n+ 【导购侧】- 增量任务任务执行完毕，顺畅率恢复至90%以上，持续观察至00:40，保持平稳恢复到93%\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/58146/1723271736296-55490438-ace7-464b-a3ad-a7dbb0f975dc.png)\n\n2024-08-09 12:00 ，**【影响消除】**\n\n+ 【选品侧】- 商选全量同步写入选品脏数据清理完成\n+ 【商品侧】-清除点位期间，货删除商还在rate数据清理\n\n## 三、故障原因\n### 3.1【背景说明】\n套餐转售业务基于大通兑的品，要扩展多渠道售卖，一个rate涉及到多个渠道和售卖时段的铺货，因此生成多个铺货规则，10:38业务侧把经济连锁大通兑的品加入到转售白名单里，进行转售规则调整，这里涉及到铺货规则的更新和新增。\n\n### 3.2【原因分析】\n#### 一句话原因：\n_套餐转售场景下，创建和更新转售铺货规则，铺货规则更新发送更新消息，铺货中心接收规则更新重新执行铺货，套餐转售场景下铺货会__更新Room上configContent__字段，因为影响商品库存的因子除了Rate、库存，还有Room的信息，__Room更新会触发room下的所有rate执行商品库存同步计算，商品库存计算__**流量放大9倍**__，导致货商同步精卫任务处理延时，最后导致搜索和商品库存不一致，Rate在搜索能够透出，但是从detail到下单页，库存是实时计算的，商品返回库存不足，下单顺畅率下跌；_\n\n\n\n_流量放大计算公式：_\n\n_从2024-08-08 10:30到15:30之前，套餐转售规则发生：20989次变更，涉及规则数量：21065，这些规则铺出了31524个房型，对应的主房型：14809，涉及到150w rate，过程因铺货主room config_content更新后触发商品更新9倍流量放大，因实体标签查询触发hic接口限流后，限流异常实体更新有消息retry机制，整体流量在9倍的基础上继续被被放大9*X倍（实际上按照消息retry机制，最大可放大16倍）。流量放大步骤计算如下：_\n\n1. 铺货规则变更时，会触发14809个主房型下关联的150w rate的商品库存中间聚合表的更新(系统设计缺陷)，因此会触发商品的库存重计算\n    1. 更新规则触发v_room的生成，同时会同步主站生成v_item_id(因sqlmap bug，每次都会去重新生成)，会把v_item_id反向更新到主room的config_content里，一个房型创建3个规则更新6次主room  configContent，触发商品",
    "chunk_order_index": 3,
    "full_doc_id": "doc-d3800a7a16dd7ede07c377739da7c530"
  },
  "chunk-068b78fb1d3a48c7245f9a263cf4aaaa": {
    "tokens": 1200,
    "content": "型下关联的150w rate的商品库存中间聚合表的更新(系统设计缺陷)，因此会触发商品的库存重计算\n    1. 更新规则触发v_room的生成，同时会同步主站生成v_item_id(因sqlmap bug，每次都会去重新生成)，会把v_item_id反向更新到主room的config_content里，一个房型创建3个规则更新6次主room  configContent，触发商品的库存重计算也是等比例放大，此时流量放大6倍。\n    2. 触发规则更新后，当前系统同时会进行货商数据同步，流量放大3倍\n2. _因实体标签查询触发hic接口限流后，限流异常实体更新有消息retry机制，整体流量在9倍的基础上继续被被放大9*X倍（实际上按照消息retry机制，最大可放大16倍）_\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/58146/1723460403324-197b5bed-045a-492d-ac69-4678283d4132.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/58146/1723440570645-5c46cd68-3be6-4165-a33d-07d45ab606e7.png)\n\n#### 根因分析：\n##### 4.2.1 流程介绍说明\n###### 4.2.1.1 商品数据链路流程\n在讲具体原因说明之前，先给大家简单讲一下商品模型、商品流转生命周期和铺货以及货商同步流程：\n\n当前的商品模型分货和商两套模型，存储上物理分开的\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/233807/1720978020945-b8b9ea53-d53d-415c-bd2d-8dc0be8846af.png)\n\n如上图所示，商家通过直连系统或者EBK将货供给到飞猪酒店商品中心：先进到货品库，再由货商同步计算生成商品，商品经过初筛排序后，落到初筛选品库，搜索通过dump选品库数据到Dii引擎构建索引；另外初筛选品只是选出有优势的商品，但是当已选出的商品其他信息发生变更时，数据一致性是由另外一条精卫任务保障的，包括货到商的计算也是通过精卫接受数据库Binlog执行计算，因此整个数据链路一致性、可用性都依赖精卫：\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/233807/1723191236833-27db2628-c5ae-4cfa-b56c-064f4f834150.png)\n\n+ 货到商精卫任务出现延迟，就会导致初筛选品数据一致性出问题，从而导致搜索的数据和商品数据不一致；从detail预订到交易下单选品，交易依赖商品实时数据(当前依赖的还是货品，根据货品实时计算商品)，这个时候就会出现下单渲染失败或者变价等；\n+ 货到商数据一致了，但是如果商品数据到初筛选品数据精卫任务出现延迟了，同样也会导致搜索的数据和商品数据不一致，从而影响顺畅率；\n+ 当前国内分销数据出口是从搜索出的，因此只要前面任何一个环节数据一致性出问题，都是导致分销顺畅率下跌。\n\n另外，在说一下货商同步商品库存计算流程，参考库存计算部分：\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2021/png/4201/1623239045222-37fe78df-7c30-4479-a1e3-a3d0bdcaad0c.png)\n\n因此room发生变更(标签、房态、库存、configContent)就会触发Room下的所有Rate重新计算商品库存；\n\n###### 4.2.1.2 套餐转售铺货介绍\n酒店商家单独供给套餐商品，为提升套餐核销，将套餐商品(根据支付类型来区分，paymentType=7)通过铺货的方式，铺出普通日历房商品(paymentType=1)到平台自营卖家新售卖。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/233807/1721179766552-8559a311-49bd-47ee-8930-dcc718e0fb77.png)\n\n在转售场景下，因为是将一个卖家下的套餐商品，作为日历房商品到另外一个卖家下销售，区别于普通铺货，套餐转售除了会铺出RP、RATE、库存外，还会铺出对应的酒店和房型：\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/233807/1723297673574-b761e5d9-6f2b-48f1-a4c7-71d5e8f2e01a.png)\n\n##### 4.2.2 具体原因说明\n前面介绍了商品数据生命周期链路，下面分析具体的原因：下单顺畅率下跌",
    "chunk_order_index": 4,
    "full_doc_id": "doc-d3800a7a16dd7ede07c377739da7c530"
  },
  "chunk-e33a1e4fc339b3b7bfc0bb92a38b82f9": {
    "tokens": 1200,
    "content": "房型：\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/233807/1723297673574-b761e5d9-6f2b-48f1-a4c7-71d5e8f2e01a.png)\n\n##### 4.2.2 具体原因说明\n前面介绍了商品数据生命周期链路，下面分析具体的原因：下单顺畅率下跌主要表象是：本地库存不足和价格为空\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/233807/1723194875745-eb634c49-6900-49ba-be6f-b23660c5a5b9.png)\n\n导致本地用户下单预订本地库存不足是搜索的数据和商品库存数据不一致，原因：货商同步和商品同步选品精卫都出现了延迟，精卫延迟是因为计算流量过大，计算流量大原因是套餐转售创建/更新转售铺货规则，\n\n铺货规则更新全流程处理时序：\n\n![](https://intranetproxy.alipay.com/skylark/lark/__puml/810debb17d16a7e4dde871b1570abb5e.svg)\n\n###### 4.2.2.1 规则创建\n一个房型会被创建出三个转售规则，在创建时会更新三次Room的configContent，创建成功后，发送同步主站消息，生成淘宝itemId，再更新到VRoom和Room的ConfigContent，在生成ItemId更新完成之后主动调用货商同步计算，总的货商同步计算：3+3+3\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/233807/1723267816637-2a9f539d-43fc-4822-ba63-b1dfed08b631.png)\n\n创建转售规则的时候同样也会发主站IC同步消息，套餐转售一个主房型对应三个规则，执行铺货的时候，会更新三次Room上的ConfigContent，同步主站成功后，又回分别更新三次Room上的ConfigContent，同时会主动调用货商同步计算服务，因此会到3+3+1=7次房型变更货商同步计算；\n\n###### 4.2.2.2 规则更新\n规则更新不会导致流量翻倍，流量被放大的主要原因是因为规则更新消息执行过程触发hic标签查询限流，限流抛出异常后，消息有重新消费，重新执行更新铺货；\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/233807/1723268337578-869e4991-1e0b-46b4-96b7-2a43216f71e2.png)\n\n套餐转售当前操作了“创建2个规则”+“下线一个规则”的操作。\n\n+ 走创建转售规则，不会走“getDomainTag”方法、“查询vItemID”动作、分页查询动作。不会受到任何影响。\n+ 走下线转售规则，相当于更新操作。且此次下线转售规则，套餐侧做了自动优化：\n    - 之前是必须选择对应的宝贝、对应rate来手动一个一个操作。不会进行分页查询，会直接调用取消铺货接口，也不会触发getDomainTag限流。故之前一直没发现【流量较小】\n    - 【半个月前优化的】这次是直接输入大通兑宝贝ID，且输入了4个，操作下线【一个规则下关联了多个rate】。商品侧执行铺货更新时会**分页查询**该规则下所有rate及对应房型，分页更新铺货过程中，在进行数据保存时会调用“getDomainTag”触发限流，导致消息消费失败，会重试分页查询，再来一遍。又**因查询vItemID查询不到**【SQL映射bug】导致重新发送主站同步消息\n\n**在“重新执行铺货”->“发送主站同步消息”中，会操作查询+更新操作，下述代码为更新操作里时会“查询getDomainTag” 以及“发送主站同步”动作**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/349901/1723433114938-557fc04a-eae3-4be4-8009-906e212ab5f7.png)\n\n+ **铺货中心hshoppingcenter自产自消【铺货规则更新消息】，过滤逻辑中不会过滤套餐转售的消息，所以会执行套餐转售铺货更新**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/114856462/1723176330771-faea6fbf-3a0f-431d-beb1-80a60a67c615.png)\n\n+ **更新铺货逻辑中会查询各个实体组装聚合根**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/114856462/1723176428534-261c9dc4-aca5-429d-be53-f51475dfd264.png?x-oss-process=image%2Fformat%2Cwebp%2Fresize%2Cw_1500%2Climit_0)\n\n+ **bug的位置：因为sql",
    "chunk_order_index": 5,
    "full_doc_id": "doc-d3800a7a16dd7ede07c377739da7c530"
  },
  "chunk-a820d05c664ac03dc972173c65df078c": {
    "tokens": 1200,
    "content": "个实体组装聚合根**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/114856462/1723176428534-261c9dc4-aca5-429d-be53-f51475dfd264.png?x-oss-process=image%2Fformat%2Cwebp%2Fresize%2Cw_1500%2Climit_0)\n\n+ **bug的位置：因为sqlMap的映射问题，导致v_item_id字段未能查出，只要规则更新，触发铺货更新，就会重新做主站IC同步，生成新的主站itemId，因限流会触发重新更新，有循环放大**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/114856462/1723176486970-66982336-5181-4691-a221-0a9816427bfc.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/114856462/1723176519678-0500ac41-ee32-4c37-9cec-9b68b0e9a93f.png)\n\n+ 因为字段映射不上，更新铺货的时候查询返回VItemId为null\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/114856462/1723176729931-1791114e-05a0-482d-b065-b94c45f7bc3b.png?x-oss-process=image%2Fformat%2Cwebp%2Fresize%2Cw_1500%2Climit_0)\n\n+ 因为有2700W的消息，因此存在不停的同步主站生成新的itemId，更新room上的configContent，为什么这么大的消息量，看下面数据分析；\n\n##### 4.2.3 数据统计分析\n从2024-08-08 10:30到15:30之前，套餐转售规则发生：[43919](https://ateye.trip.taobao.com/hubmonitor/history3.htm?groupby=day&appName=hshoppingcenter&keys=HSF-Provider-Total%255Ecom.alibaba.trip.hotel.shopping.center.client.shoppingrule.IShoppingRuleService%253A1.0.0%255Eupdate%257ES&valueType=v1&startDate=2024-08-08&endDate=2024-08-09β=false)次变更(接口调用次数)，涉及规则数量：21065，这些规则铺出了31524个房型，对应的主房型：14809，其中部分规则关联房型多的上百至上千个；\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/233807/1723276251407-2f81d70d-7f9a-4eb0-9e56-31f7e00a72df.png)\n\n规则更新(包含创建)TOPIC：HOTEL_SHOPPING_RULE_EVENT_TOPIC 86836，因为转售场景下，存在一个房型对应多个铺货规则(大部分是3个)；\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/233807/1723256535936-caf1eaf2-ad36-4ab4-b2b4-6a84781846d0.png)\n\nTOPIC：HOTEL_SHOPPING_ITEM_TOPIC消息量如下：\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/233807/1723205138505-c88999ea-5078-4c40-b172-eeee5adb2bd6.png)\n\n同步主站服务调用流量，基本上和消息量是一致的：\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/233807/1723205184189-988d6d73-3a3e-4d6b-96ee-4259a6c99822.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/233807/1723205247988-ecd389b5-53ab-4970-b4e3-4dafdb6692b5.png)\n\n###### 为什么货商同步库存计算流量会被放大？\n参考前面铺货创建和更新\n\n###### 为什么会有2700W+的消息量？\n因为出现重复消息消费了，规则更新触发移步铺货更新的时候：\n\n```java\npublic abstract class AbstractMetaqEventListener implements MessageListenerConcurrently {\n    @Override\n    public ConsumeConcurrentlyStatus consumeMessage(List list,\n                                                    ConsumeConcurrentlyContext consumeConcurrentlyContext) {\n        return this.processMessage(list) ? ConsumeConcurrentlyStatus.CONSUME_SUCCESS\n        : ConsumeConcurrentlyStatus.RECONSUME_LATER;\n    }\n    /**\n     * process message\n     *\n     * @param list\n     * @return\n     */\n    public boolean processMessage(List list) {\n        try {\n            List> eventProcessors = this.getEventProcessor();\n            for (MessageExt messageExt : list) {\n                for (EventProcessor eEventProcessor : eventProcessors) {\n                    if (null == eEventProcessor) {\n                        continue;\n                    }\n                    E event = eEventProcessor.createEvent(messageExt);\n                    if (eEventProcessor.needProcess(event)) {\n                        eEventProcessor.onEvent(event);\n                    }\n                }\n            }\n            return true",
    "chunk_order_index": 6,
    "full_doc_id": "doc-d3800a7a16dd7ede07c377739da7c530"
  },
  "chunk-30c6f0251d907c11f7b6e1ec40bfbd40": {
    "tokens": 1200,
    "content": "boolean processMessage(List list) {\n        try {\n            List> eventProcessors = this.getEventProcessor();\n            for (MessageExt messageExt : list) {\n                for (EventProcessor eEventProcessor : eventProcessors) {\n                    if (null == eEventProcessor) {\n                        continue;\n                    }\n                    E event = eEventProcessor.createEvent(messageExt);\n                    if (eEventProcessor.needProcess(event)) {\n                        eEventProcessor.onEvent(event);\n                    }\n                }\n            }\n            return true;\n        } catch (Exception e) {\n            log.error(\"process message exception.\", e);\n            return false;\n        }\n    }\n}\n\n```\n\n使用了观察者模式，在处理消息过程中，如果onEvent执行出现异常，则catch捕获异常后，return false，consumeMessage方法里，processMessage如果是FALSE，则**ConsumeConcurrentlyStatus.RECONSUME_LATER，消息重投递。**\n\n同一个房型同一个规则出现4次(不止)消息：\n\n```sql\n{\"gid\":2430025804676,\"hid\":579426153676,\"rid\":2947918853676,\"ruleId\":68503001676,\"ruleName\":\"套餐转售\",\"sellerId\":2214242132908,\"supplierId\":2214640657676,\"vGid\":2614092039908,\"vHid\":632968006908,\"vRid\":3150171039908}\n{\"gid\":2430025804676,\"hid\":579426153676,\"rid\":2947918853676,\"ruleId\":68503001676,\"ruleName\":\"套餐转售\",\"sellerId\":2214242132908,\"supplierId\":2214640657676,\"vGid\":2614092039908,\"vHid\":632968006908,\"vRid\":3150171039908}\n{\"gid\":2430025804676,\"hid\":579426153676,\"rid\":2947918853676,\"ruleId\":68503001676,\"ruleName\":\"套餐转售\",\"sellerId\":2214242132908,\"supplierId\":2214640657676,\"vGid\":2614092039908,\"vHid\":632968006908,\"vRid\":3150171039908}\n{\"gid\":2430025804676,\"hid\":579426153676,\"rid\":2947918853676,\"ruleId\":68503001676,\"ruleName\":\"套餐转售\",\"sellerId\":2214242132908,\"supplierId\":2214640657676,\"vGid\":2614092039908,\"vHid\":632968006908,\"vRid\":3150171039908}\n```\n\n从当时的异常信息来看，在更新铺货过程中，触发了hic的**TagReadNXService:getDomainTags**限流，**15841303次限流**，消息重新投递。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/233807/1723269267189-dc7b54e4-46e6-4d00-bbac-b4e327ba07e7.png)\n\n##### 4.2.4 为什么恢复周期这么长\n+ 从10点48收到告警到明确问题原因耗时比较长，第一次收到告警，只是一个卖家速8旗舰店(经济连锁)流量翻了很多倍，首先想到的是TOP推送，但是做了TOP限流后，发现还是没有效果，紧接着锦江、尚客优流量又出现上涨，最后明确流量来源以及是11点12分了。\n+ 影响面大\n    - 本次延迟涉及全量数据：10亿+rate、20亿+RP、1亿+房型\n+ 数据链路长\n    - 而且中间处理节点不能随便扩容，否则会对下游节点造成影响：比如货商同步扩容了，流量和并发就会上升，从而影响第二节点：精卫、数据库、OTS、Blink，如果第二节点扩容，则会影响搜索；我们在整个处理过程中就出现因为扩容，导致搜索流量上涨，DII出现积压。\n    - 在这次故障过程中，第一节点和第二节点精卫大部分节点延迟达到了2个小时，通过精卫扩容解决不了问题了\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/233807/1723387786191-598e023f-333a-485e-90f2-b6e2b9dc5f5f.png)\n\n+ 第一次铺货中心对消息增加限流发布完后，是可以止血了的，但是因为发布的过程中doom机器和spe机器没有执行发布，\n\n## 四、关注点分析\n### 4.1【系统质量】\n#### 4.1.1 需求&设计评估\n**〖关注点1〗****是否涉及产品、技术方案评估？此核心的问题是什么，如何改进？**\n\n- [x] **是，涉及**\n    - [ ] 需求评估遗漏\n    - [ ] 产品设计缺陷\n    - [ ] 系统架构设计缺陷\n        - [x] 容错性不足 \n        - [ ] 单点，无冗余\n        - [x] 缺乏自我保护\n        - [ ] 缓存设计不当\n        - [ ] 容量评估不足\n        - [ ] 非幂等设计\n        - [ ] 强弱依赖不合理\n        - [ ] 其他：__________\n- [ ] 否，不涉及\n\n**〖改进点〗",
    "chunk_order_index": 7,
    "full_doc_id": "doc-d3800a7a16dd7ede07c377739da7c530"
  },
  "chunk-120c2a54f235bc30206d1a2305a207a9": {
    "tokens": 629,
    "content": "[x] 容错性不足 \n        - [ ] 单点，无冗余\n        - [x] 缺乏自我保护\n        - [ ] 缓存设计不当\n        - [ ] 容量评估不足\n        - [ ] 非幂等设计\n        - [ ] 强弱依赖不合理\n        - [ ] 其他：__________\n- [ ] 否，不涉及\n\n**〖改进点〗**2023.2历史实现，跨店场景的问题在故障过程中已进行修复(限流新增和重试机制优化)，长期走架构优化\n\n### 4.2【处置能力】\n#### 4.2.1 故障发现&响应\n+ **是否监控发现**\n    - [x] 故障触发方 监控发现\n    - [x] 故障受影响方 监控发现\n    - [ ] 否，原因为：（监控无效/监控缺失）\n+ **是否5分钟内响应**\n    - [x] 是\n    - [ ] 否，原因为：\n+ **是否存在应急协同问题**\n    - [ ] 是\n        - [ ] 应急流程不明确（无流程或者流程不清晰、应急相关角色&职责不明确，缺失一号位等)\n        - [ ] 应急执行不到位（有流程，但未按流程执行，通告发送不及时，响应不及时等）\n    - [x] 否\n\n#### 4.2.2 故障定位&恢复\n+ **主要恢复方式：**\n    - [ ] 代码发布/回滚\n    - [ ] 配置发布/回滚\n    - [x] 数据订正\n    - [x] 机器隔离/重启/扩容\n    - [x] 配置限流\n    - [x] 预案降级\n    - [ ] 自动恢复\n    - [ ] 其他：\n+ **是否10分钟内恢复**__\n    - [ ] 是\n    - [x] 否，原因：涉及到货->商->选->导购dii整个数据链路的数据同步恢复，串行影响，依次恢复时间较长\n\n## 五、故障Action\n| **序号** | *******Action** | *******负责人** | *******计划完成时间** | **验收人** | **是否keyAction** |\n| :---: | --- | :---: | :---: | :---: | --- |\n| 1 | 短期：铺货中心SqlMap问题修复（已发布） | 禾羲 | 8.12 | 毅盛 | 是 |\n| 2 | 长期：商品数据链路数据快恢机制&SLA方案产出 | 玉铮 | 8.30 | 言慕 | 是 |",
    "chunk_order_index": 8,
    "full_doc_id": "doc-d3800a7a16dd7ede07c377739da7c530"
  },
  "chunk-ca9e2d17b0a27b85fb98a3de188fdddd": {
    "tokens": 1200,
    "content": "## 一、故障简述\n2024年9月2日16:28监控预警TRIP_BTMS_APP数据库活跃线程数超30，同时数据库CPU达到100%，影响酒店搜索详情接口，故障原因初步确认是线上企业通过开放平台API同步成本中心发票抬头导致，于16:58通过SQL限流完成止血，故障恢复，期间暂未产生集中性客诉，根据监控下跌幅度判定达P4故障等级。\n\n## 二、影响产品线及影响面\n- [x] 是否影响可用性：否\n- [x] 业务影响：\n\n商旅-酒店：\n\n+ 系统指标：商旅酒店详情页不可用\n+ 用户影响：用户使用阿里商旅-酒店预订进入酒店详情页无报价，预定链路被阻塞\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/65956558/1725437321298-1e3b80ae-9abd-45bd-a4cd-ae352c93d658.png)![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/65956558/1725439028883-bd9b393a-cfe2-4c78-9d60-ecd738a4cfd2.png)\n\n商旅-机票：\n\n+ 系统指标：机票搜索页不可用\n+ 用户影响：用户进入阿里商旅-机票进行搜索，列表不展示\n\n| **产品线** | **场景名称** | **是否触发故障** | **影响时段** |\n| --- | --- | :---: | :---: |\n| 集团/飞猪/商旅/酒店预订 | 【商旅】酒店搜索无结果或异常+ 商旅_搜索酒店详情接口（16:42-16:56成功率持续低于70%）   + 商旅_酒店列表页搜索接口（16:43-16:53成功率持续低于70%）   | P4 | 16:42-16:56 |\n| 集团/飞猪/商旅/机票预订 | 【商旅】机票搜索无结果或异常+ 商旅_预订-国内机票导购链路（16:42-16:56成功率持续低于70%）     | P4 | 16:27-16:56 |\n| 集团/飞猪/商旅/机票预订 | 【商旅】机票创单失败 | 未触发 | 16:29-16:57 |\n| 集团/飞猪/商旅/酒店预订 | 【商旅】酒店创单失败 | 未触发 | 16:27-16:56 |\n| 集团/飞猪/商旅/用车 | 【商旅】用车导购搜索异常 | 未触发 | 16:29-16:56 |\n| 集团/飞猪/商旅/火车票 | 【商旅】火车票创单失败 | 未触发 | 16:27-16:57 |\n| 集团/飞猪/商旅/火车票 | 【商旅】火车票搜索无结果或异常 | 未触发 | 16:27-16:56 |\n\n\n- [x] 是否有客诉：否\n- [x] 是否有社会舆情：否\n- [x] 是否产生资损：否\n\n## 三、故障过程回顾\n2024-09-02 16:24，开放平台应用(appkey=hsh80lklbg00)调开放平台接口，更新圆通速递有限公司（isv_platform53yc17086sfbffq9）成本中心、发票抬头数据关注点1**【风险注入】**\n\n2024-09-02 16:28，btms数据库报警**【故障发现】**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/65956558/1725437620130-c0a48c68-69ec-450d-b6be-b86070d2086a.png)\n\n2024-09-02 16:28，[@宝媛](undefined/lifuzhang.lfz)同步开发进行排查**【业务响应】**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/65956558/1725437633133-9a176dad-ad70-47b2-98f6-c4c57e03f3e5.png)\n\n2024-09-02 16:30，商旅_搜索酒店详情接口、商旅_酒店列表页搜索接口监控发出预警，随后多个业务场景，如商旅-火车票、机票等相继出现异常预警\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/41240/1725504165319-d4a42610-b11c-4dea-b913-c95645131972.png)![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/41240/1725525289300-6584c1cf-65ff-45b8-9fc6-827a3bf27044.png)\n\n2024-09-02 16:30，select btrip_rule慢SQL导致**【初因定位】**\n\n**企业：**isv_platform53",
    "chunk_order_index": 0,
    "full_doc_id": "doc-80f566593a0e323363e218e73a94c92f"
  },
  "chunk-75e1c84a459a873b34aac20f6e10144b": {
    "tokens": 1200,
    "content": "-4dea-b913-c95645131972.png)![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/41240/1725525289300-6584c1cf-65ff-45b8-9fc6-827a3bf27044.png)\n\n2024-09-02 16:30，select btrip_rule慢SQL导致**【初因定位】**\n\n**企业：**isv_platform53yc17086sfbffq9（圆通）**  \n****慢sql：**\n\n```java\n/* 2150461817252657762018359e3d7f/0.1.1.1.3.7//1d3a5aa7/// */select id, gmt_create, gmt_modified, corp_id, rule_code, entity_type, entity_id from btrip_rule where corp_id = 'isv_platform53yc17086sfbffq9' AND rule_code = 300487268\u0001\n```\n\n2024-09-02 16:35，发现第二条慢SQL\n\n**企业：**btripmu97952nzt6qy608（飞猪用车）**  \n****慢sql：**\n\n```java\n/* 213e384617252661992196128e94d9/0.1.2.23.5//5d2302b1/// */select COUNT(*) as `count(*)` from `user_0001` `user` WHERE ((`user`.`leave_status` = 0) AND (`user`.`corp_id` = 'btripmu97952nzt6qy608'))\n```\n\n2024-09-02 16:35，针对飞猪用车SQL限流，通过SQL_ID限流：/5d2302b1/ （时间范围2024年9月2日 16:35:17~2024年9月2日 17:05:35）\n\n```sql\nSELECT COUNT(*) AS `count(*)`\nFROM `user_0004` `user`\nWHERE `user`.`leave_status` = ?\n\tAND `user`.`corp_id` = ?\n```\n\n2024-09-02 16:39，针对圆通限流，SQL模板：/1d3a5aa7/~ isv_platform53yc17086sfbffq9 （2024年9月2日 16:39:23~2024年9月2日 16:54:44）\n\n```sql\nSELECT id, gmt_create, gmt_modified, corp_id, rule_code\n\t, entity_type, entity_id\nFROM btrip_rule\nWHERE corp_id = ?\n\tAND rule_code = ?\n```\n\n2024-09-02 16:41，再次针对飞猪用车SQL限流，SQL模板：/5d2302b1/~`corp_id` = 'btripmu97952nzt6qy608'（2024年9月2日 16:41:28~2024年9月2日 17:05:35）\n\n```sql\nSELECT COUNT(*) AS `count(*)`\nFROM `user_0004` `user`\nWHERE `user`.`leave_status` = ?\n\tAND `user`.`corp_id` = ?\n```\n\n2024-09-02 16:42，DBA限流，对整个企业进行限流，SQL模板：select~btrip_rule_scope~where~corp_id~scope（2024年9月2日 16:42:24~2024年9月2日 16:58:32）**【恢复执行】**\n\n2024-09-02 16:43，DBA对第二条企业SQL模板进行限流：select~btrip_rule~where~corp_id~rule_code（2024年9月2日 16:42:24~2024年9月2日 16:58:32），所有企业受影响\n\n2024-09-02 16:51，商旅_搜索酒店详情接口持续10分钟成功率<70%（16:42-16:56），触发P4。**【故障发生】**\n\n2024-09-02 16:55，[@岁盈](undefined/suiying.xr) 反馈限流影响管控查询差标了  \n\n2024-09-02 16:58，DBA取消限流任务，限流结束，同时企业请求量下降，监控恢复正常水位**【故障恢复】**\n\n2024-09-02 17:01，洒花在商旅开放平台针对圆通速递这个企业做限流**【影响消除】**\n\n## 四、故障原因\n### 4.1【背景说明】\n**① 同步成本中心和发票抬头背景：**\n\n员工预定前企业需要为员工配置成本中心发票抬头等费用归属项，阿里商旅开放平台通过API（[https://open.alibtrip.com/#/document/server/faq-2?handbookId=development-support](https://open.alibtrip.com/#/document/server/faq-2?handbookId=development-support)）透出\n\n维护成本中心、发票抬头能力；企业通过API新增/修改/删除成本中心发票抬头，维护成本中心发票抬头关联的部门、员工、角色等；\n\n**② 查询企业员工数背景：**\n\n飞猪用车下单依赖btms提供的查企业信息的服务（#findAuthCorpByCorpId），内部包含查询企业员工数（通过count user表实现，目前飞猪用车员工数接近",
    "chunk_order_index": 1,
    "full_doc_id": "doc-80f566593a0e323363e218e73a94c92f"
  },
  "chunk-115bb1b1150a2c19fc2eb2f950d95a21": {
    "tokens": 1200,
    "content": "维护成本中心、发票抬头能力；企业通过API新增/修改/删除成本中心发票抬头，维护成本中心发票抬头关联的部门、员工、角色等；\n\n**② 查询企业员工数背景：**\n\n飞猪用车下单依赖btms提供的查企业信息的服务（#findAuthCorpByCorpId），内部包含查询企业员工数（通过count user表实现，目前飞猪用车员工数接近100w）\n\n**③ 应用依赖关系：**\n\n+ 成本中心发票抬头API：开放平台 -> btripinvoice(发票抬头逻辑)/bcmc(成本中心逻辑) -> btms(圈选人逻辑) -> **btms数据库**\n+ 查询企业信息：btbs（飞猪用车下单） -> **btms**（查企业信息、包含员工数）\n+ 搜索酒店详情接口：btrip-demeter -> **btms**（查询员工、企业等信息）\n\n### 4.2【原因分析】\n##### 一句话原因：\n企业通过开放平台API同步成本中心发票抬头的异常流量产生大量慢查询，叠加飞猪用车查询企业信息时count user产生大量逻辑读，导致btms数据库CPU满，影响搜索酒店详情接口成功率\n\n##### 根因分析：\n开放平台应用（appKey：hsh80lklbg00）通过开放平台API为企业 圆通速递有限公司（appKey：hsh80lklbg00，isv_platform53yc17086sfbffq9）同步成本中心、发票抬头：\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/114897/1725279631360-bfb24e7e-af25-4458-9890-739c3b48c430.png)\n\n同步成本中心发票抬头接口最后依赖btms的BtripRuleService#addRule、#delRule这两个方法，这两个方法整体调用量翻了100倍左右关注点2：\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/114897/1725281453628-2c16ee2f-97af-4209-b365-cc705d5872e1.png)\n\n其中BtripRuleService#addRule、#delRule这两个服务的内部方法依赖关系：\n\nBtripRuleManager#operateRule\n\nBtripRuleManager#calcChangedRules\n\nbtripRuleDAO.getRuleByRuleCode \n\n每调用一次上面的两个方法都会先把成本中心、发票抬头关联的人（btrip_rule这个表记录了成本中心发票抬头ID和员工ID关联关系）全部查到内存中，对比增删改数据再操作DB insert/delete关注点3；\n\n\n\n圆通速递这个企业成本中心发票抬头和对应圈选人数、请求数，问题期间总共select btrip_rule 20w次，select btrip_rule数据10kw行到btms应用中：\n\n```xml\nrule_code（300开头发票、500开头成本中心）\t\tcnt（圈选人数）\t\tinvoke_count（请求数）\t\t*（select btrip_rule行数）\n300487268\t\t2414\t\t23128\t\t55830992\n5002100955\t\t776\t\t22973\t\t17827048\n300492004\t\t73\t\t436\t\t31828\n300486703\t\t1252\t\t148\t\t185296\n300486691\t\t654\t\t145\t\t94830\n5001824533\t\t1059\t\t141\t\t149319\n300491894\t\t1100\t\t116\t\t127600\n5001824484\t\t905\t\t116\t\t104980\n300486714\t\t776\t\t108\t\t83808\n300486710\t\t2320\t\t89\t\t206480\n5001823771\t\t4344\t\t87\t\t377928\n5001824547\t\t1890\t\t80\t\t151200\n300486728\t\t473\t\t73\t\t34529\n300490307\t\t1072\t\t72\t\t77184\n5001824512\t\t390\t\t71\t\t27690\n5001824603\t\t887\t\t69\t\t61203\n300487149\t\t406\t\t67\t\t27202\n5001824473\t\t331\t\t62\t\t20522\n300492023\t\t889\t\t61\t\t54229\n300486748\t\t379\t\t61\t\t23119\n300486734\t\t531\t\t56\t\t29736\n5001762706\t\t486\t\t56\t\t27216\n300486711\t\t1397\t\t52\t\t72644\n5001824604\t\t812\t\t52\t\t42224\n5001745880\t\t328\t\t51\t\t16728\n300486697\t\t1582\t\t50\t\t79100\n300490414\t\t1938\t\t49\t\t94962\n300486693\t\t966\t\t49\t\t47334\n300486736\t\t935\t\t48\t\t44880\n300486724\t\t518\t\t45\t\t23310\n300490279\t\t1556\t\t44\t\t68464\n5001931121\t\t1368\t\t41\t\t56088\n300486702\t\t1097\t\t39",
    "chunk_order_index": 2,
    "full_doc_id": "doc-80f566593a0e323363e218e73a94c92f"
  },
  "chunk-a84138f9fac125a2cea008e53c92fc18": {
    "tokens": 1200,
    "content": "300490414\t\t1938\t\t49\t\t94962\n300486693\t\t966\t\t49\t\t47334\n300486736\t\t935\t\t48\t\t44880\n300486724\t\t518\t\t45\t\t23310\n300490279\t\t1556\t\t44\t\t68464\n5001931121\t\t1368\t\t41\t\t56088\n300486702\t\t1097\t\t39\t\t42783\n300486733\t\t783\t\t39\t\t30537\n300486741\t\t314\t\t38\t\t11932\n5001824475\t\t814\t\t37\t\t30118\n300486715\t\t1100\t\t35\t\t38500\n300486745\t\t341\t\t34\t\t11594\n5001824462\t\t245\t\t34\t\t8330\n5001824605\t\t1409\t\t34\t\t47906\n5001824620\t\t1075\t\t34\t\t36550\n5001745697\t\t452\t\t34\t\t15368\n300490448\t\t519\t\t34\t\t17646\n5001824468\t\t699\t\t33\t\t23067\n300486719\t\t1085\t\t32\t\t34720\n300490297\t\t382\t\t30\t\t11460\n5001824594\t\t775\t\t30\t\t23250\n300486701\t\t896\t\t30\t\t26880\n5001819881\t\t294\t\t30\t\t8820\n5001745780\t\t338\t\t28\t\t9464\n5001824614\t\t454\t\t28\t\t12712\n300488401\t\t508\t\t28\t\t14224\n300486717\t\t1338\t\t28\t\t37464\n5001755476\t\t767\t\t27\t\t20709\n300492320\t\t1263\t\t26\t\t32838\n5001824613\t\t607\t\t26\t\t15782\n5001931137\t\t882\t\t25\t\t22050\n300657532\t\t233\t\t25\t\t5825\n300486700\t\t1042\t\t24\t\t25008\n300486721\t\t913\t\t24\t\t21912\n5001745799\t\t120\t\t24\t\t2880\n300486718\t\t1701\t\t24\t\t40824\n300486720\t\t346\t\t24\t\t8304\n300513609\t\t213\t\t23\t\t4899\n300490284\t\t867\t\t23\t\t19941\n300486750\t\t556\t\t23\t\t12788\n300486744\t\t384\t\t22\t\t8448\n5001824489\t\t1015\t\t22\t\t22330\n300486737\t\t686\t\t22\t\t15092\n300486695\t\t814\t\t22\t\t17908\n5001881541\t\t1092\t\t21\t\t22932\n300492057\t\t1400\t\t21\t\t29400\n300487152\t\t684\t\t20\t\t13680\n5001824466\t\t487\t\t20\t\t9740\n5001931184\t\t648\t\t20\t\t12960\n300486706\t\t1080\t\t20\t\t21600\n5001824480\t\t1062\t\t19\t\t20178\n300486725\t\t176\t\t18\t\t3168\n300486729\t\t935\t\t18\t\t16830\n5001824598\t\t821\t\t18\t\t14778\n5001824511\t\t740\t\t17\t\t12580\n300486704\t\t1721\t\t17\t\t29257\n5001824607\t\t861\t\t17\t\t14637\n300486709\t\t450\t\t17\t\t7650\n5001931120\t\t830\t\t17\t\t14110\n5001745669\t\t304\t\t16\t\t4864\n300486739\t\t576\t\t16\t\t9216\n300486726\t\t711\t\t16\t\t11376\n300486705\t\t1086\t\t16\t\t17376\n300486698\t\t927\t\t15\t\t13905\n5001923933\t\t187\t\t15\t\t2805\n5001824467\t\t519\t\t14\t\t7266\n300486690\t\t861\t\t14\t\t12054\n5001824556\t\t624\t\t14\t\t8736\n5001745765\t\t473\t\t14\t\t6622\n5001879590\t\t2\t\t14\t\t28\n5001824465\t\t577\t\t14\t\t8078\n300487153\t\t293\t\t14\t\t4102\n5001824597\t\t736\t\t14\t\t10304\n300486722\t\t690\t\t14\t\t9660\n300491982\t\t488\t\t13\t\t6344\n5001745920\t\t341\t\t13\t\t4433\n300486713\t\t1621\t\t13\t\t21073\n300486743\t\t523\t\t13\t\t6799\n5001824599\t\t907\t\t13\t\t11791\n5001931170\t\t353\t\t13\t\t4589\n300516295\t\t1092\t\t13\t\t14196\n300487234\t\t289\t\t12",
    "chunk_order_index": 3,
    "full_doc_id": "doc-80f566593a0e323363e218e73a94c92f"
  },
  "chunk-5f43a60f01d77d28ff7f1da546fc8b84": {
    "tokens": 1200,
    "content": "5001745920\t\t341\t\t13\t\t4433\n300486713\t\t1621\t\t13\t\t21073\n300486743\t\t523\t\t13\t\t6799\n5001824599\t\t907\t\t13\t\t11791\n5001931170\t\t353\t\t13\t\t4589\n300516295\t\t1092\t\t13\t\t14196\n300487234\t\t289\t\t12\t\t3468\n5001824609\t\t254\t\t12\t\t3048\n5001824593\t\t446\t\t12\t\t5352\n5001824608\t\t783\t\t12\t\t9396\n300486712\t\t369\t\t12\t\t4428\n5001824621\t\t1111\t\t12\t\t13332\n5001821373\t\t79\t\t12\t\t948\n5001824623\t\t1074\t\t12\t\t12888\n300486738\t\t580\t\t12\t\t6960\n5001824469\t\t823\t\t12\t\t9876\n300492058\t\t588\t\t10\t\t5880\n5001778683\t\t22\t\t10\t\t220\n5001837993\t\t23\t\t9\t\t207\n5001961713\t\t11\t\t8\t\t88\n5001823759\t\t3\t\t8\t\t24\n5001824617\t\t601\t\t8\t\t4808\n5001824595\t\t612\t\t7\t\t4284\n300486699\t\t386\t\t7\t\t2702\n5001824464\t\t1567\t\t7\t\t10969\n5001824478\t\t745\t\t7\t\t5215\n300486694\t\t987\t\t7\t\t6909\n5001824587\t\t506\t\t7\t\t3542\n5001824579\t\t520\t\t7\t\t3640\n5001824584\t\t308\t\t6\t\t1848\n5001842371\t\t42\t\t6\t\t252\n5001820202\t\t86\t\t6\t\t516\n5001842372\t\t14\t\t6\t\t84\n5001745717\t\t38\t\t5\t\t190\n5002021034\t\t1\t\t5\t\t5\n5001745682\t\t21\t\t5\t\t105\n300486731\t\t425\t\t5\t\t2125\n5001745665\t\t291\t\t5\t\t1455\n5001745821\t\t479\t\t5\t\t2395\n5001824601\t\t963\t\t5\t\t4815\n5001745902\t\t11\t\t5\t\t55\n5001804401\t\t144\t\t5\t\t720\n5001823808\t\t78\t\t5\t\t390\n300486716\t\t161\t\t5\t\t805\n5001751913\t\t10\t\t5\t\t50\n300494745\t\t16\t\t5\t\t80\n5001798213\t\t4\t\t5\t\t20\n5001909896\t\t12\t\t5\t\t60\n300486735\t\t502\t\t4\t\t2008\n5002229177\t\t3\t\t4\t\t12\n5001757296\t\t12\t\t4\t\t48\n5001745776\t\t452\t\t4\t\t1808\n5001745751\t\t385\t\t4\t\t1540\n300486707\t\t423\t\t4\t\t1692\n5001879586\t\t2\t\t4\t\t8\n5001796513\t\t81\t\t4\t\t324\n5001782276\t\t10\t\t4\t\t40\n300487326\t\t120\t\t4\t\t480\n300635162\t\t857\t\t4\t\t3428\n5001824622\t\t1437\t\t4\t\t5748\n5001745825\t\t23\t\t4\t\t92\n5001961711\t\t89\t\t3\t\t267\n5001820147\t\t9\t\t3\t\t27\n5001745792\t\t120\t\t3\t\t360\n5001745870\t\t6\t\t3\t\t18\n300635363\t\t38\t\t3\t\t114\n5001821422\t\t30\t\t3\t\t90\n5001968609\t\t10\t\t3\t\t30\n5001802841\t\t12\t\t3\t\t36\n300486978\t\t28\t\t3\t\t84\n5001796533\t\t6\t\t3\t\t18\n5001960577\t\t2\t\t3\t\t6\n300491990\t\t78\t\t3\t\t234\n5001821421\t\t8\t\t3\t\t24\n300486692\t\t38\t\t3\t\t114\n300662068\t\t5\t\t2\t\t10\n5001794452\t\t14\t\t2\t\t28\n5001898612\t\t28\t\t2\t\t56\n5001821405\t\t14\t\t2\t\t28\n5001745866\t\t359\t\t2\t\t718\n300486742\t\t36\t\t2\t\t72\n5001796543\t\t22\t\t2\t\t44\n5001752144\t\t6\t\t2\t\t12\n300490449\t\t429\t\t2\t\t858\n300491961",
    "chunk_order_index": 4,
    "full_doc_id": "doc-80f566593a0e323363e218e73a94c92f"
  },
  "chunk-47eac8a415312510eb7f7daf344c69c2": {
    "tokens": 1200,
    "content": "1898612\t\t28\t\t2\t\t56\n5001821405\t\t14\t\t2\t\t28\n5001745866\t\t359\t\t2\t\t718\n300486742\t\t36\t\t2\t\t72\n5001796543\t\t22\t\t2\t\t44\n5001752144\t\t6\t\t2\t\t12\n300490449\t\t429\t\t2\t\t858\n300491961\t\t227\t\t2\t\t454\n5001942869\t\t49\t\t2\t\t98\n5002229121\t\t4\t\t2\t\t8\n5001745674\t\t26\t\t2\t\t52\n5001780450\t\t29\t\t2\t\t58\n5001745853\t\t6\t\t2\t\t12\n300490830\t\t113\t\t2\t\t226\n5001887564\t\t4\t\t2\t\t8\n5001745680\t\t76\t\t2\t\t152\n300486687\t\t27\t\t2\t\t54\n300490283\t\t1071\t\t1\t\t1071\n5001751817\t\t21\t\t1\t\t21\n5001980943\t\t73\t\t1\t\t73\n5001823800\t\t4\t\t1\t\t4\n5001753705\t\t14\t\t1\t\t14\n\t\t\t\t\t\t\n  \t\t\t\t\t\t55831006\n```\n\n\n\n#delRule方法请求数、select btrip_rule行数：\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/114897/1725441693456-bee454d1-7be2-457d-a410-2b16d898f6e6.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/114897/1725441725563-540324b7-39a6-47fd-8903-c868810b7140.png)\n\n\n\n#addRule方法请求数、select btrip_rule行数：\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/114897/1725441774209-1b625e9b-40ab-4365-9edf-98de120923b5.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/114897/1725441811910-2b475af1-e28e-4dcb-9ad4-8549f450c565.png)\n\n\n\n对应DB指标：\n\nread行数增加50%：\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/114897/1725286428178-3ae29071-4168-4e7e-b795-dad14a2e131f.png)\n\n\n\nDB发送给客户端流量翻了两倍：\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/114897/1725286232250-35f576ec-d4fd-4ece-9f09-9e1e1f06218c.png)\n\n\n\nCPU利用率：\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/114897/1725289769920-ae1aa365-e2d0-4492-a080-5eba2335f142.png)\n\n\n\n#delRule、#addRule和DB CPU利用率对应关系：\n\n#delRule：\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/114897/1725443194839-6bae2c2a-2413-46b8-819a-f1f75adcf393.png)\n\n#addRule：\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/114897/1725443761713-f243d029-e057-4247-9ec5-87796591c373.png)\n\n整体select btrip_rule qps：\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/114897/1725448235929-8a030a40-a66c-4a2e-9275-ea73b9d14da9.png)\n\n数据库CPU：\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/114897/1725443637228-7b062e68-bba6-476c-9999-e45e72ee878a.png)\n\n\n\n#findAuthCorpByCorpId的请求、耗时、数据库逻辑读关系，16:27 select btrip_rule导致CPU满，同时count user大量逻辑读导致CPU持续满关注点4：\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/114897/1725445443235-630698df-ce97-4f67-8c47-09212bbe0637.png)\n\nDB逻辑读数：\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/114897/1725445155269-7ee0c0e1-71c1-4efe-ba5d-01e5e89ae46f.png)\n\nDB CPU：\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/114897/1725443637228-",
    "chunk_order_index": 5,
    "full_doc_id": "doc-80f566593a0e323363e218e73a94c92f"
  },
  "chunk-b3a76212b44b914c14425d76375d3114": {
    "tokens": 1200,
    "content": ")\n\nDB逻辑读数：\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/114897/1725445155269-7ee0c0e1-71c1-4efe-ba5d-01e5e89ae46f.png)\n\nDB CPU：\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/114897/1725443637228-7b062e68-bba6-476c-9999-e45e72ee878a.png?x-oss-process=image%2Fformat%2Cwebp%2Fresize%2Cw_1349%2Climit_0)\n\n## 五、关注点分析\n###### 【关注点1】企业通过开放平台API同步成本中心发票抬头的频率如何？除去同步发票抬头外，是否还有其他通过API同步数据的大流量行为？\n【问题总结】企业之前没有周期性tpm上千请求开放平台API同步成本中心发票抬头的情况，除成本中心发票抬头外，组织关系、审批也会有类似大流量风险\n\n【改进点】之前主要是case by case解决，比如组织关系发生过类似问题，仅针对组织关系做相关的优化，后续对于企业接口有基础限流。详见action 3。\n\n###### 【关注点2】同步成本中心发票抬头的调用量为什么会翻了100倍？\n【问题总结】圆通近期在改组织架构，可能导致异常流量。\n\n【改进点】外部三方行为，飞猪无法做管控，后续主要做好异常流量检测及限流能力优化。详见action 3。\n\n###### 【关注点3】调用时把成本中心、发票抬头关联的人先查到内存中，对比增删改数据再操作DB insert/delete的这个流程是否容易导致占用数据库CPU，有优化空间吗？\n【问题总结】目前实现是先查产本中心发票抬头关联的所有员工ID到内存，再对比请求的员工ID，看删除和新增的员工ID，再delete或insert关联的员工ID：\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/114897/1725540269985-3bd3df90-41b6-4c9e-9bda-f0e59de8e2d0.png)\n\n【改进点】去掉先查到内存再操作DB的逻辑，避免成本中心/发票抬头圈选的员工数多时select大量数据到内存 [@汀夜](undefined/sjh167961) 9.13\n\n###### 【关注点4】飞猪用车下单为何会依赖查企业信息服务的接口？count user为何会产生大量逻辑读？\n【问题总结】btbs用车下单依赖btms findAuthCorpByCorpId这个HSF方法获取企业是否开通阿里商旅（isAuth）这个属性做风控逻辑，其他属性（企业员工数等）没用到，飞猪用车这个企业员工数接近100w，一次count逻辑读接近100w，16:27开始DB CPU满有重试请求导致这条SQL执行次数变多，导致CPU持续满\n\n【改进点】用车有一套老的风控逻辑依赖findAuthCorpByCorpId，后续查企业信息服务统一切换到opensearch，不再通过DB。btms 所有count梳理一遍 [@瓶籽](undefined/yuping.jyp) 9.13\n\n###### 【关注点5】16:30定位到了慢SQL，为什么前3次限流都生效了但是没有有效降低故障影响？\n【问题总结】前3次限流没有找到核心影响的表scope，仅限制了rule&count。\n\n【改进点】**DBA建议：通过执行时间再看下平均扫描行数，根据扫描行数排倒序，扫描行数高且执行次数多的优先处理。**\n\ndbservice上提交限流任务时，提交按钮是禁用的，有个结束时间大于当前时间10分钟以上的限制没有提示出来，目前[@航威](undefined/wanghangwei.whw) 已经和前端提了改进需求，默认时间是20分钟，若提交不了会有提示，近期会上线。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/114897/1725538556818-9896ed85-f3cd-406b-a95a-c7b4bfee8c40.png)\n\n### 5.1【系统质量】\n#### 5.1.1 需求&设计评估--不涉及\n:::info\n本次故障为三方异常流量触发，主要是未做好限流保护。\n\n:::\n\n#### 5.1.2 代码质量--不涉及\n:::info\n本次故障为三方异常流量触发，非飞猪自身代码问题导致。\n\n:::\n\n#### 5.1.3 变更质量--不涉及\n:::info\n本次故障非变更触发。\n\n:::\n\n### 5.2【处置能力】\n#### 5.2.1 故障发现&响应\n+ **是否监控发现**\n    - [x] 故障触发方",
    "chunk_order_index": 6,
    "full_doc_id": "doc-80f566593a0e323363e218e73a94c92f"
  },
  "chunk-83c5484f6bfee43d639fe3ea9093a495": {
    "tokens": 891,
    "content": ":::info\n本次故障为三方异常流量触发，非飞猪自身代码问题导致。\n\n:::\n\n#### 5.1.3 变更质量--不涉及\n:::info\n本次故障非变更触发。\n\n:::\n\n### 5.2【处置能力】\n#### 5.2.1 故障发现&响应\n+ **是否监控发现**\n    - [x] 故障触发方 监控发现\n    - [x] 故障受影响方 监控发现\n    - [ ] 否，原因为：（监控无效/监控缺失）\n+ **是否5分钟内响应**\n    - [x] 是\n    - [ ] 否，原因为：\n+ **是否存在应急协同问题**\n    - [ ] 是\n        - [ ] 应急流程不明确（无流程或者流程不清晰、应急相关角色&职责不明确，缺失一号位等)\n        - [ ] 应急执行不到位（有流程，但未按流程执行，通告发送不及时，响应不及时等）\n    - [x] 否\n\n**〖问题总结〗**异常流量调用未被发现。\n\n**〖改进点〗**_** **_开放平台入口：应用、企业异常调用流量检测 [@洒花](undefined/zhangwenzhe.zwz) 9.13出初步方案 \n\n#### 5.2.2 故障定位&恢复\n+ **主要恢复方式：**\n    - [ ] 代码发布/回滚\n    - [ ] 配置发布/回滚\n    - [ ] 数据订正\n    - [ ] 机器隔离/重启/扩容\n    - [ ] 配置限流\n    - [ ] 预案降级\n    - [ ] 自动恢复\n    - [x] 其他：慢SQL限流\n\n**〖关注点1〗定位&恢复阶段存在什么问题？是否可以增加预案，****有更快的恢复方式？****相关的优化改进？**\n\n**〖问题总结〗**定位到具体企业耗时较长，且前3次限流未能有效降低故障影响。\n\n**〖改进点〗 **企业调用接口异常流量监测，可帮助快速定位导致数据库异常企业。详见action 3。\n\n## 六、故障Action\n| **序号** | *******Action** | *******负责人** | *******计划完成时间** | **是否keyAction** |\n| :---: | --- | :---: | :---: | :---: |\n| 1 | 短期：开放平台成本中心发票抬头API对企业限流 | 洒花 | 0902 |  |\n| 2 | 短期：btms count user优化  |  瓶籽  | 0902 |  |\n| 3 | 短期：去除查到内存再操作DB的逻辑 | 汀夜 | 0913 |  |\n| 4 | 短期：btms 所有count 梳理一遍 | 瓶籽 | 0913 |  |\n| 5 | 短期：btms慢SQL排查优化 | 瓶籽 | 0906 |  |\n| 6 | 短期：新企业对接方案中明确限流逻辑（如限流标准等） | 凡伯 | 0910 |  |\n| 7 | 长期： 开放平台入口：   ○ 应用、企业异常调用流量检测   ○ 按应用、企业限流能力优化完成后通过压测演练验证效果（如限流值是否合理，by企业维度的限流值不一样） | 洒花 | 0913 | 是 |\n| 8 | 长期：底层应用btms：不加limit、扫全表SQL排查优化 | 汀夜、枢璇 | 0913 梳理完毕出具方案 |  |",
    "chunk_order_index": 7,
    "full_doc_id": "doc-80f566593a0e323363e218e73a94c92f"
  },
  "chunk-376abc3883524f616c7234a9a2a7606e": {
    "tokens": 1200,
    "content": "## 一、故障简述\n08.29 16:04监控发现dida function应用SG机房渲染服务RT大幅上涨，平均从500ms上涨到3500ms，渲染成功率下降至80%，确认是新加坡机房diamond存在异常，偶发会跨单元去拉配置导致超时。后续diamond侧初步排查确认是SG单元缩容导致node客户端未更新server ip，影响到了node应用的获取diamond逻辑，于17:41自动恢复。\n\n## 二、故障过程回顾Incident Process Review\n### 【故障处理时间线|Incident handling process】\n2024-08-29 16:03，diamond侧在KubeNest平台对新加坡机房开始执行缩容【故障引入】\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/116556437/1725524085122-7d7e7721-92df-48fc-9ab7-224a8dd269ea.png)\n\n2024-08-29 16:07，AE侧收到 Sunfire 告警,发现fn- Gateway网关应用（dida-function前端应用的下游，间接受到影响）成功率降低,RT变高；收到故障后开始分析，判断仅影响新加坡机房。【故障发现】【业务响应】\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/14617/1724932952401-43e110f9-c97e-4b2d-bb43-cb23a935b617.png)\n\n2024-08-29 16:18，联系开发、迷六、加沐、果老，并到会议室统一处理。\n\n2024-08-29 16:40，因 dida-function 近期无发布，所以先通过 SLS 筛选出异常机器并进行置换、扩容操作【恢复执行】\t![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/14617/1724933342852-3fb2629b-c418-41ca-bac2-ebcd11a9b078.png)\n\n2024-08-29 17:20左右，置换机器过程中，并未发现有恢复迹象，开始通过日志排查问题：\n\n    1. 发现日志中出现较多diamond timeout 的请求，其中包含 `33.51.134.11`\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/14617/1724986878638-94ad7ebc-6b38-4129-ba76-b55255f992a7.png)\n\n    2. 并且查询该服务器已不存在\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/14617/1724986925487-3d0a3c4f-2856-4301-bdbd-b880c605d50e.png)\n\n    3. 此时加沐反馈 `diamond_aliyun_vpc_sghost`分组还有这台机器 ![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/14617/1724986967953-1c891863-bcfa-4450-8254-66ef94130278.png)\n\n2024-08-29 17:34 左右，发现该问题后，联系 Diamond 同学Diamond 同学反馈开始恢复\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/14617/1724933909592-f53b01fb-a5da-4e33-a6a6-d88a8f778e0a.png)\n\n2024-08-29 17:41左右，dida-function 完全恢复【故障恢复】\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/14617/1724934041565-0b4ae356-7537-4f9d-a308-b98e47ebe0e5.png)\n\n2024-08-29 18:05，Diamond 同学反馈新加坡单元有做缩容操作【初因定位】\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/14617/1724933956284-1a186e8c-876c-432f-a5d2-97ec0eb97031.png)\n\n## 三、故障影响面|Bussiness Impmact\n    - [x] 业务影响：首页、频道、会场有兜底逻辑，且兜底为实时写入，所以线上无影响。端外搜索新加坡机房预计有 20% 的渲染失败率\n    - [ ] 可用性影响：\n    - [ ] 资损影响：无\n    - [ ] 社会舆情和客诉影响：无\n\n## 四、故障原因|Cause Analysis\n### 4.1【一句话原因|Cause summary】\ndiamond_aliyun_vpc_sghost 分组缩容，kubeNest 未把缩容机器从地址服务器摘除，地址服务器未执行定时同步任务，应用使用的diamond获取配置方式非最优方式 ，导致缩容机器被访问\n\n### 4.2【背景说明|Background introduction】\n![](https://intranetproxy.alipay.com/skylark",
    "chunk_order_index": 0,
    "full_doc_id": "doc-aae44745a49ab7a60836042c1b094978"
  },
  "chunk-146a4466341e9599ab1b71b76c62ef81": {
    "tokens": 1200,
    "content": "故障原因|Cause Analysis\n### 4.1【一句话原因|Cause summary】\ndiamond_aliyun_vpc_sghost 分组缩容，kubeNest 未把缩容机器从地址服务器摘除，地址服务器未执行定时同步任务，应用使用的diamond获取配置方式非最优方式 ，导致缩容机器被访问\n\n### 4.2【背景说明|Background introduction】\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/116556437/1725248890084-515b4a41-3d4c-4b46-9041-1c086ac84aa7.png)\n\n### 4.3【根因分析|Root cause analysis】\n#### NODE 应用内分析\n1. dida-function 使用了 [diamond-client@9.6.1](https://anpm.alibaba-inc.com/package/diamond-client/v/9.6.1) 版本，并使用 `getConfig`进行获取 diamond 配置\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/14617/1724936947296-2ca53c42-f3d0-4f2d-b166-fef4c8a6ab12.png)\n\n    1. 判断内存缓存中是否有配置项(缓存时间2分钟)，无配置时走 `getConfig`进行获取；\n2. diamond.getConfig 的完整执行流程如下\n\n![画板](https://intranetproxy.alipay.com/skylark/lark/0/2024/jpeg/14617/1725333946092-5b52790a-e570-4915-b40c-43273bfebb8f.jpeg)\n\n3. 现因为通过 `/diamond-server/diamond`获取服务器时返回了已下线的服务器，导致后续无法正常获取配置而出现异常\n\n#### diamond地址服务根因分析\n地址服务器每隔20分钟会从 cmdb 同步应用分组下的机器。7.4 号断网演练，负责应用分组同步的线程执行抛异常退出，导致后续没有执行应用分组同步\n\n#### KubeNest根因分析\nKubeNest（中间件应用集群发布部署管理平台）上发起的应用集群缩容工单，未将缩容pod同步地址服务的根本原因：由于KubeNest在集群部署的地址服务同步组件执行逻辑时，对pod创建时的status可能出现值判断不够严谨，最终会出现少添加一个finalizer，这个finalizer有无会直接影响pod缩容场景是否再次同步地址服务。\n部署在asi集群内地址服务器同步组件代码逻辑，会在判断完pod ip存在后进行phase!=pending判断（pod状态判断），进行finalizer的添加。这里代码逻辑这样写应该是之前同学对pod创建调度时status中podIp、phase值出现时机相互关系理解不够清晰。\n当前逻辑仅对diamond产品有影响，其他三个（Vipserver、configserver、nameserver）需要注册地址服务器的没这个问题。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/8415/1725417967449-5f2ae70b-577e-4039-8a59-c92646d49254.png)\n\n实际当时pod的yaml数据：\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/8415/1725418162972-05214e50-0e81-42c1-be1c-f79ce81398e4.png)\n\n### 4.4【核心关注点】\n【关注点1】问题发生当天确认是于17:41自动恢复，是如何自动恢复的？\n\n:::tips\n17:40 diamond有做手动同步；业务侧node客户端访问 diamond 中间有一个node的diamond sdk，30秒会重新调用 /diamond-server-/diamond 获取最新的服务ip，所以是能自动恢复的。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/116556437/1725443352171-62fe0cbd-1b31-46d6-a2e2-65772be59467.png)\n\n:::\n\n【关注点2】地址服务器应用分组同步线程异常问题，后续是否可以通过监控观测到？\n\n:::tips\n可以，后面加上监控，并且修复这个异常问题\n\n:::\n\n【关注点3】diamond getConfig改成订阅方式后，后续是否能够避免该问题？\n\n:::tips\n地址服务异常其实 node、java应用都会有影响，只是java应用走到兜底的策略了。后续改成 getConfigStateless 订阅方式后就没问题了。\n\n:::\n\n## 五、关注点分析\n### 5.1 常规关注点｜Normal checkpoint\n#### 5.1.1 需求&设计评估\n- [ ] 需要改进｜Need improve\n    - Action：\n- [x] 符合预期或不涉及 | No need for improvement\n\n#### 5.1.2 代码&变更质量|Release and code quality\n- [x] 需要改进｜Need improve\n    - Action：\n- [ ] 符合预期或不涉及 | No need for improvement\n\n#### 5.1.3 故障发现&响应｜failure detection and **reponse**\n- [x] 需要",
    "chunk_order_index": 1,
    "full_doc_id": "doc-aae44745a49ab7a60836042c1b094978"
  },
  "chunk-f2c79ffc573722d60810f075c833f564": {
    "tokens": 630,
    "content": "：\n- [x] 符合预期或不涉及 | No need for improvement\n\n#### 5.1.2 代码&变更质量|Release and code quality\n- [x] 需要改进｜Need improve\n    - Action：\n- [ ] 符合预期或不涉及 | No need for improvement\n\n#### 5.1.3 故障发现&响应｜failure detection and **reponse**\n- [x] 需要改进｜Need improve\n    - Action：地址服务器应用分组同步任务加上监控\n- [ ] 符合预期或不涉及 | No need for improvement\n\n#### 5.1.4 故障定位&恢复｜failure location and recovery\n- [x] 需要改进｜Need improve\n    - Action：\n- [ ] 符合预期或不涉及 | No need for improvement\n\n#### 5.1.5 红线检查｜Safety Production Red Line confirmation\n- [ ] 需要改进｜Need improve\n    - Action：\n- [x] 符合预期或不涉及 | No need for improvement\n\n### 5.2 补充关注点｜Additional checkpoint\n[【重要】Node.js 应用 @ali/diamond-client 正确使用 getConfig 改造通知](https://aliyuque.antfin.com/midwayjs/blcz2i/yqk6su?singleDoc#)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/116556437/1725347286514-32c20e6f-22d9-4cba-b666-dc8e48b5cfb5.png)\n\n## 六、故障Action| follow-up improvements\n| **序号** | **ACTION** | **是否keyAction** | **计划完成时间** | **Action负责人** | **Action验收人** |\n| --- | --- | --- | --- | --- | --- |\n| 1 | dida-function 的 diamond配置获取方式由 getConfig 修改为 getConfigStateless |  | 9/12 | 玄道 | 来德 |\n| 2 | KubeNest对diamond-server存量开启地址服务器同步的应用集群pod yaml数据做finalizer扫描，给出缺失的pod列表，并对缺失的pod做手动数据订正 |  | 9/11 | 睿封 | 曲怪 |\n| 3 | KubeNest修复地址服务器组件执行逻辑，灰度asi集群验证（930），并对所有集群推平 | 是 | 11/30 | 睿封 | 修竺 |\n| 4 | 地址服务器应用分组同步任务加上监控 |  | 9/11 | 修竺 | 曲怪 |\n| 5 | 地址服务器修复应用分组同步线程执行逻辑 | 是 | 11/20 | 修竺 | |",
    "chunk_order_index": 2,
    "full_doc_id": "doc-aae44745a49ab7a60836042c1b094978"
  },
  "chunk-1488870246af6a70977c0196ac0dd5cc": {
    "tokens": 1200,
    "content": "## 一、故障概述（含影响产品线及影响面）\n**故障概述：**\n\n2022-08-03 21:48上线了火车票抢票加速包多档位功能，于8月18日开量，因代扣订单在支付时无法自动扣除一搭加速包辅营订单的款项，最终导致该部分订单出票后加速包收入减少。\n\n2022-09-06 17:40 关闭线上加速包多档位，恢复原有固定的4个档位。\n\n2022-09-06 22:56 订正线上历史数据。  \n\n\n**影响面：**\n\n    - [x] 业务影响：影响的业务线，业务功能，功能受损程度（成功量/率下跌多少%），持续多少时间\n        * 从整体数据来看，因单量有周期性波动，且受暑期结束影响，整体单量回落，使用周总单量进行对比，排除自然回落比例影响，实际影响单量占比19%左右。 \n            + 0804~0810：总单量9901 0811~0817：总单量8857，周同比自然降低(9901-8857)/9901 = 10.5% \n            + 8月18，故障发生\n            + 0818~0824：总单量6254，周同比降低(8857-6254)/8857 = 29.4%，故障影响下降比例为（排除自然降低）：29.4% - 10.5% = 18.9%\n\n## 二、故障过程回顾【故障处理时间线】\n### 【1-5-10概览】\n![画板](https://intranetproxy.alipay.com/skylark/lark/0/2022/jpeg/39701/1663206928355-e6708002-7af0-47a5-a2ff-d75e45fafb6b.jpeg)\n\n### 【故障处理时间线】\n整体故障时间线。需要着重强调【故障注入】【故障发生】【故障发现】【业务响应】【故障定位】【恢复执行】【故障恢复】时间点。\n\n请按格式【时间，内容】进行反馈，例如：2018-01-01 18:01，谁做了什么，如有监控、日志等相关信息截图，请补充。\n\n【故障注入】2022-08-03 21:48 ，10元档加速包需求上线\n\n【故障发生】2022-08-18 10:48，开量\n\n【故障发现】【业务响应】2022-09-06 17:35，发现辅营加速包代扣失败问题\n\n【故障恢复】2022-09-06 17:40，关闭10元档加速包流量开关，故障恢复\n\n【数据订正】2022-09-06 22:56，订正线上数据\n\n【问题修复】2022-09-07 00:58，代扣逻辑修复并上线完成\n\n\n\n## 三、故障原因（具体原因描述）\n### 4.1【一句话原因】\n新加速包不支持老加速包的模式，导致代扣订单支付时，辅营商品被过滤未支付。\n\n### 4.2【背景说明】\n原加速包设计模式是固定的，不支持灵活配置，在10元档加速包需求中将加速包做成动态的组合，将每笔订单的加速包配置存放在订单详情的扩展字段当中。\n\n老加速包是通过商品的skuType区分加速包种类skuType是写死在代码中的一个枚举类，而新加速包不在使用这个字段进行区分，所以在一搭下单新加速包商品代扣时根据新的skuType找不到相应的枚举值，无法走代扣逻辑，造成加速包未触发扣款。\n\n### 4.3【根因分析】\n1.代扣逻辑会从filterOrderXItem这个方法中过滤出一搭加速包商品\n\n\u0000![](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/56056618/1662991830989-880990b4-c178-4729-8d75-e54283bb6db2.png)\n\n2.用新商品的skuType获取枚举时为null，导致返回false，商品被过滤掉\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/56056618/1662991801604-62e359dd-60a4-4e09-bde9-d38d455def97.png)\n\n3.一搭商品被过滤掉导致orderDomain为null，不走辅营代扣\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/56056618/1662991969890-4b20f98b-5c7f-44b6-8786-eb0323b851d8.png)\n\n## 四、故障关注点（每一项都需要仔细填写，会上要逐条过一下，重点写改进action）\n/* 根据故障实际情况可增删关注点，并提供详细内容分析*/\n\n### 4.1【系统质量】\n#### 4.1.1 需求&设计评估\n**〖关注点1",
    "chunk_order_index": 0,
    "full_doc_id": "doc-82a8c4d08219962ae43f6b669afb715c"
  },
  "chunk-451715745d341ca6baf4db9793899654": {
    "tokens": 1200,
    "content": "f98b-5c7f-44b6-8786-eb0323b851d8.png)\n\n## 四、故障关注点（每一项都需要仔细填写，会上要逐条过一下，重点写改进action）\n/* 根据故障实际情况可增删关注点，并提供详细内容分析*/\n\n### 4.1【系统质量】\n#### 4.1.1 需求&设计评估\n**〖关注点1〗**是否涉及产品方案评估？评估是否充分？\n\n**【原因分析】在评估过程中遗漏代扣场景的评估**\n\n**【改进点】后续涉及抢票订单资金的改动，开发进行方案评估时，需覆盖先付、代扣、一搭&二搭、修改抢票单、智能推荐、改签抢场景。**\n\n#### 4.1.2  代码质量\n**〖关注点2〗**是否经过codereview？\n\n**【原因分析】做了。未根据场景进行独立codereview。**\n\n**【改进点】在前置设计评估中考虑涉及的场景。**\n\n**〖关注点3〗**发布时有没有经过测试验收？是否经过测试回归？为什么没有回归发现？测试同学是否有接手测试？自动化是否能发现问题？测试遗漏的原因是什么（未测试验证、测试遗漏）？\n\n**【原因分析】**\n\n在发布前，与产品一起进行了测试验收。\n发布时在安全生产和线上都有进行测试回归，但是代扣场景没有覆盖到。\n测试遗漏的原因为：对业务了解不清晰，导致设计用例相应的场景丢失，没有覆盖代扣的场景。\n\n**【改进点】**\n\n1. **后续涉及抢票订单资金的改动，QA撰写case和测试过程中，需覆盖先付、代扣、一搭&二搭、修改抢票单、智能推荐、改签抢场景。**\n\n#### 4.1.3 变更质量\n**〖关注点4〗**关联的应用名？变更系统是否接入changefree？是否经过灰度？灰度了多久？为什么灰度没有发现问题？\n\n**【原因分析】灰度做了，没有发现的原因是线上的2个相关bcp****审计被关闭了。**\n\n**【改进点】**\n\n1. **恢复关闭的bcp审计——已完成**\n2. **对长时间未报警或已关闭的bcp审计进行review，避免审计场景遗漏或审计无效；——进行中，羽其负责。**\n3. **火车票审计场景二次review，需要开发、测试参加——未开始**\n4. **加速包辅营支付量（先付、代扣）增加埋点、报警——进行中，玉垒负责** \n\n### 4.2【处置能力】\n#### 4.2.1 故障发现&响应\n+ **是否监控发现**\n    - [x] 是\n        - [x] 故障触发方\n        - [ ] 受影响方\n    - [ ] 否\n\n\n\n+ **发现后是否五分钟内响应**\n    - [x] 是\n    - [ ] 否，原因为：\n\n\n\n#### 4.2.2 故障定位&恢复\n+ **故障涉及恢复方式：**\n    - [ ] 代码发布\n    - [ ] 代码回滚\n    - [x] 配置回滚\n    - [ ] 隔离\n    - [ ] 扩容\n    - [ ] 重启\n    - [ ] 限流\n    - [ ] 降级预案\n    - [ ] 自动恢复\n    - [ ] 其他：\n\n\n\n## 五、故障Action\n| **序号** | **ACTION** | **是否keyAction** | **计划完成时间** | **验收标准** | **Action负责人** |\n| --- | --- | --- | --- | --- | --- |\n| 1 | 代扣问题修复 | 是 | 9.6（已完成） | QA同学逍潞验证 | 玉垒 |\n| 2 | 异常数据订正 | 是 | 9.6（已完成） | 测试单订正后并验证后续流程 | 勿痴、毅恺 |\n| 3 | 梳理现有BCP审计 | 是 | 9.7（已完成）参考[文档](https://yuque.antfin.com/docs/share/b42e700d-4357-4668-9773-7032d54bfa9b?# 《FY23 火车票资金安全审计实施计划》) |  | 勿痴 |\n| 4 | 增加加速包辅营支付数据埋点、报警 | 是 | 9.16（现有埋点、已加上细化报警） 已完成 | | 玉垒 |\n|   5 | 业务域主干场景测试明细 | 是 | 9.21 | QA评审通过 | 凝越 |\n|   6 | 订单状态校验工具 | 否 | 9.30 | 输出主订单与辅营单在行业、平台、中台状态是否一致性结果 | 凝越 |\n| | sunfire 加细化场景监控 | 是 | 9.23（已完成） | 地址：[https://",
    "chunk_order_index": 1,
    "full_doc_id": "doc-82a8c4d08219962ae43f6b669afb715c"
  },
  "chunk-1327f7077fb01583709ea42e115f9b9a": {
    "tokens": 147,
    "content": "5 | 业务域主干场景测试明细 | 是 | 9.21 | QA评审通过 | 凝越 |\n|   6 | 订单状态校验工具 | 否 | 9.30 | 输出主订单与辅营单在行业、平台、中台状态是否一致性结果 | 凝越 |\n| | sunfire 加细化场景监控 | 是 | 9.23（已完成） | 地址：[https://x.alibaba-inc.com/custom/59/product/preview/multiMinute/5449?v=2](https://x.alibaba-inc.com/custom/59/product/preview/multiMinute/5449?v=2) | 玉垒 |",
    "chunk_order_index": 2,
    "full_doc_id": "doc-82a8c4d08219962ae43f6b669afb715c"
  },
  "chunk-e0ea0abb9db18792576d65ee64be363d": {
    "tokens": 1200,
    "content": "## 一、故障简述\n【P4】2024-08-20 13:46开始，陆续有用户反馈进入超值换购页面后无商品内容，客诉统计触达P4，初步定位；使用一休平台进行实验放量，ios对url转义2次，导致访问了错误的换购页面链接，仅影响部分苹果手机用户，14:00通过预案降级止血，14:39通过修复转义、关闭预案降级消除影响。\n\n**APM故障链接：**[**https://tr.alibaba-inc.com/ormEmergency/workbench/emergency/202408210000000651001**](https://tr.alibaba-inc.com/ormEmergency/workbench/emergency/202408210000000651001)\n\n## 二、故障过程回顾\n### 【故障处理时间线】\n----应急过程----\n2024-08-20 13:13，自营技术前端开发 朝南 发布换购一休实验，问题引入线上；【故障引入】\n2024-08-20 13:20，承接页feeds的监控成功量开始逐步下跌至13:30 达到35%，未达到阈值触发告警关注点1，地址：[Link](https://x.alibaba-inc.com/custom/42/product/preview/spm/4554) ；\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/5156405/1724155610331-49c79ade-1305-45c4-b3f1-e3f54c909b2a.png)\n\n2024-08-20 13:25，前端监控告警发现该问题；【故障发现】\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/66856475/1724925745142-06f8d100-ff2b-4a74-9387-ff842eec7f7c.png)\n\n2024-08-20 13:41，事后统计，该时间点客诉量级达到20例，触发自营技术的P4；【故障发生】\n2024-08-20 13:47，一线客服小二在业务群内反馈异常现象，体验同学 宰梦 意识到是个批量事件，进行了拉铃GOC，风险预警告警并拉群；【业务响应】\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/5156405/1724142002021-448c28a4-02f0-4784-b4d5-1ae073ca8a8b.png)\n\n2024-08-20 13:50，自营技术前端开发 朝南 开始回滚换购一休实验的发布，但**回滚无效****关注点2**(原因：下线功能存在延时，一休配置在IOS端上缓存)，**线上故障未消除**；\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/5156405/1724142225628-adbbfcf6-8c98-4c1f-be3b-fe8da5041e0a.png)\n\n2024-08-20 13:58，自营技术导购开发 仲为、林栎 定位是换购链接错误；【初因定位】\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/5156405/1724143197935-8b26ccb8-3b63-490b-8e6f-6bcbf773aacc.png)\n\n2024-08-20 14:00， 线上会议决策，购物车入口降级，线上问题消除；【故障恢复】\n2024-08-20 14:07， 降级后流量跌 0 触发风险预警告警；【监控告警】\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/5156405/1724142791651-1903eac1-48bc-40db-857a-c28f6a49c450.png)\n\n2024-08-20 14:08，自营技术前端开发 皎芓和仲为确认到原因：原始url被转义2次导致了异常；【根因定位】\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/5156405/1724143367952-8274cd8d-656c-4ddc-a919-19f03f26fbaa.png)\n\n2024-08-20 14:14，VOC相关预警出现关注点3；\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/66856475/1724896561134-f6b0c025-071b-4faa-aaf1-3ba0dda78c6e.png)\n\n2024-08-20 14:30， 给出新的换购地址可避免转义问题；\n2024-08-20 14:39， 购物车入口替换新链接完成，换购入口恢复；【消除影响】\n\n### 【过程概览】\n![画板](https://intranetproxy.alipay.com/skylark/lark/0/2024/jpeg",
    "chunk_order_index": 0,
    "full_doc_id": "doc-6c184c63fe43d58ec12e4c6f70108768"
  },
  "chunk-ea5c4feab9794bd7581f9987f4ebb0f0": {
    "tokens": 1200,
    "content": "-4faa-aaf1-3ba0dda78c6e.png)\n\n2024-08-20 14:30， 给出新的换购地址可避免转义问题；\n2024-08-20 14:39， 购物车入口替换新链接完成，换购入口恢复；【消除影响】\n\n### 【过程概览】\n![画板](https://intranetproxy.alipay.com/skylark/lark/0/2024/jpeg/66856475/1724925907866-0b7d5486-fb72-42d9-a6b0-c1d43801847f.jpeg)\n\n## 三、影响产品线及影响面\n    - [x] 业务影响：\n        * 部分IOS用户（IOS占比40%，桶比例98%，13:13分开始切流，逐步下发配置生效，最高影响39.2%）换购入口点击后进入异常URL的页面，13:13-14:00，持续47分钟，共计影响7,349个用户；\n        * 降级后，超值换购频道入口下线，14:00-14:39，持续了39分钟；\n    - [x] 是否有客诉量：\n        * 【客诉原声】 13:13~14:00，关键词：换购 and (空白 or 打不开），咨询量：52条客户原声（其中在线人工 52 条），表格如下\n\n[0820换购页面打不开.xlsx](https://yuque.antfin.com/attachments/lark/0/2024/xlsx/147156506/1731031184696-ca74c815-5335-42f4-a17d-49affd31b1ef.xlsx)\n\n    - [x] 是否有社会舆情：\n        * 无\n    - [x] 是否产生资损：\n        * 无\n\n## 四、故障原因\n### 4.1【一句话原因】\n换购需求使用一休平台进行放量灰度，页面链接被转义为错误链接，进入空白页。\n\n### 4.2【背景说明】\n    - 【需求背景】故障涉及到的新需求背景介绍\n        * 集团飞燕3期要求猫超重点导购页面进行性能改造，超补由于SSR改造带来日均45万GMV增量，换购频道也需要改造SSR性能升级，带GMV增量。换购频道功能点、样式不改变，仅做性能升级。\n        * [https://aone.alibaba-inc.com/v2/project/2083439/req#viewIdentifier=adad70f589d8e1416e6483f5&openWorkitemIdentifier=59339675](https://aone.alibaba-inc.com/v2/project/2083439/req#viewIdentifier=adad70f589d8e1416e6483f5&openWorkitemIdentifier=59339675)\n    - 【业务链路】\n\n![画板](https://intranetproxy.alipay.com/skylark/lark/0/2024/jpeg/275740/1724727737079-5635e1e8-25a0-448c-ade7-f71bc1c75277.jpeg)\n\n### 4.3【根因分析】\n苹果23年9月份更新了iOS17系统，摩天轮支持Xcode15.1打包。xcode15 + iOS 17，iOS 17上URL的[解析规则发生变化](https://developer.apple.com/documentation/xcode-release-notes/xcode-15-release-notes#Resolved-Issues)，有非常高的业务参数丢失、数据出错的风险。\n\n| 变化的规则 | 异常表现（iOS 17与 iOS 16的差异） | 异常原因、风险及解法 |\n| :--- | :--- | :--- |\n| 1，percent encoding异常 | %会被encode成%25![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/19617/1704337080444-8cf78ec2-2969-4247-b28d-751ad9c4f74a.png) | **原因**：url中包含%和其他non-URLAllowedCharacters时（如[]等），%会被encode成%25**风险**：参数析解后传到服务端导致计算异常**建议解法**：URL中不要使用non-URLAllowedCharacters，或服务端兼容 |\n\n\n+ iOS 17系统会对特殊字符encode，一休SDK本身不会进行二次encode，无法做完整兜底（会产生更多问题）；\n+ 相关GOC关注点5：[https://tr.alibaba-inc.com/orm/announcement/23095](https://tr.alibaba-inc.com/orm/announcement/23095)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/65086/1724658620216-cf599e94-2416-4ea5-be7f-9f77f0048f53.png)\n\n\n\n\n\n##### 〖关注点1〗一休实验逐步下发配置生效，线上流量有波动，为什么没有故障场景报警，如何改进？\n监控地址：[Link](https://x.alibaba-inc.com/custom/42/product/preview/spm/4554) ；\n\n:::info\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/668",
    "chunk_order_index": 1,
    "full_doc_id": "doc-6c184c63fe43d58ec12e4c6f70108768"
  },
  "chunk-0332c5bfe4752357494430bc1ce2e0fa": {
    "tokens": 1200,
    "content": "f77f0048f53.png)\n\n\n\n\n\n##### 〖关注点1〗一休实验逐步下发配置生效，线上流量有波动，为什么没有故障场景报警，如何改进？\n监控地址：[Link](https://x.alibaba-inc.com/custom/42/product/preview/spm/4554) ；\n\n:::info\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/66856475/1724895848409-1673d270-a02e-4916-9959-d6ca1ce13cce.png)\n\n**〖问题分析〗**\n\n1、服务端有监控&告警，这次的故障未达到告警阈值同比下降35%且环比下降 30%；\n2、前端有相关告警，不知晓变更内容；\n\n3、历史上有做过噪声治理的时候，调高阈值（前 5 分钟下降 20%或 同比昨日下降 30%）；\n\n**〖改进项〗**\n\n1、服务端告警阈值调整，修改为环比前 5 分钟下降 25%或 同比昨日下降 30%；done，zhongwei\n\n:::\n\n##### 〖关注点2〗一休实验的发布回滚操作业务表象无效，是什么原因，有什么改进点？\n:::info\n**〖问题分析〗**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/26102/1724897989960-d77f5987-7a95-4b6a-9a22-eaf334c2cd03.png)\n\n非问题或Bug，简述而言现在端侧实验配置下发/回滚触发的流程为：\n\n**异步实验回滚 -> DTS定时任务批量聚合 变更 -> Orange推送到端侧 -> 端设备实验缓存刷新**\n\n故对于端侧实验下发存在的Cache及设备拉取机制，平台恢复速度无法做到服务端那样迅速止血**（**[**见一休SLA故障恢复**](https://aliyuque.antfin.com/ikkuy/gw2n3b/kvzx39?singleDoc# 《【重要❗️必读❗️】一休平台服务等级协议(SLA)》)**，**[**Orange数据验证**](https://aliyuque.antfin.com/wireless-orange/wiki/osnetm#OIIrn)**）**\n\n****\n\n**〖改进项〗**\n\n1、回滚流程的的定时任务间隔适当调整，IOS逐渐放量开启一休7月新迭代的SDK版本，支持从服务端mtop加速拉取配置，(安卓已全量，10min到达率90%)需要做IOS的能力上线、IOS能力的效果反馈；[@明樵](undefined/tongqi.ltq)，0930\n2、%等保留字符出现在URL实验定向配置时，根据端侧能长期兼容看是否直接禁止，端侧的保留字符配置阻断；[@明樵](undefined/tongqi.ltq)，0910\n3、SLA在实验发布页面强调透出，另外补充【使用规范】：建议URL类型实验补充入口降级预案，恢复时间由业务自行控制；使用规范在产品内的透出；[@明樵](undefined/tongqi.ltq)，0910\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/26102/1724898791795-55bf42a2-b995-4ecc-8f9f-52c6c623ebcf.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/26102/1724898971139-cf988bcf-7345-4a37-8224-cca595b740ec.png)\n\n:::\n\n##### 〖关注点3〗VOC在此次事件中为什么没有上报预警单据？\n:::info\n**〖问题分析〗**\n\n1、VOC的算法在近60分钟内的热词聚类，并未触发阈值；\n\n2、VOC在预案关闭后，有报警出来，是全量用户咨询才触发该阈值；\n\n**〖改进项〗**\n\n1、自营技术调整产品线节点，融合淘宝买菜、天猫超市VOC洞察能力，同时联动体验平台的开发：宾阳，检查VOC洞察链路，[@晓与](undefined/zxy382343)0910验收\n\n:::\n\n##### 〖关注点4〗故障应急时并未做故障通知，以风险单应急，事后补发的故障，原因是什么？\n:::info\n**〖问题分析〗**\n\n应急语音会上，体验同学有提到客诉粗略量级，因没有拿到详细客诉量级，且大家均已在应急，预案止血也较快，并未升级处理，待第二天确认了T+1离线客诉明细表后，才做的补发；\n\n**〖改进项〗**\n\n未来严格按应急流程，以CCO体验同学的反馈口径快速升级故障，不做客诉细节筛查；@晓与同步7*24值班，做好应急SOP。\n\n:::\n\n##### 〖关注点5〗关于G",
    "chunk_order_index": 2,
    "full_doc_id": "doc-6c184c63fe43d58ec12e4c6f70108768"
  },
  "chunk-8b9e07d3b55eae18e5e990efc0a93b7b": {
    "tokens": 1200,
    "content": "预案止血也较快，并未升级处理，待第二天确认了T+1离线客诉明细表后，才做的补发；\n\n**〖改进项〗**\n\n未来严格按应急流程，以CCO体验同学的反馈口径快速升级故障，不做客诉细节筛查；@晓与同步7*24值班，做好应急SOP。\n\n:::\n\n##### 〖关注点5〗关于GOC公告：[XCode15升级NSURL解码规则变更通知](https://tr.alibaba-inc.com/orm/announcement/23095)，讨论一下通知范围，评估是否扩大通知范围？\n:::info\n**〖问题分析〗**\n\n1、GOC公告已覆盖手淘版本相关的研发与测试所有人；\n\n**〖改进项〗**\n\n1、可以考虑扩大通知范围到业务技术全员 + 二方业务；@jiayuan，通告模版的调整，0907\n\n:::\n\n##### 〖关注点6**〗**关于一休平台服务等级协议（SLA）的细则，及现阶段的GOC公示、收录情况如何？\nSLA：[链接](https://aliyuque.antfin.com/ikkuy/gw2n3b/kvzx39)；GOC公告：[链接](https://tr.alibaba-inc.com/orm/announcement/20013)；\n\n:::info\n**〖问题分析〗**\n\n1、下线延迟15min，SLA里面描述的是服务不可用的恢复时间，这次并不是服务不可用场景；SLA建议使用的是encode后的url，猫超同学使用的是encode后的；\n2、GOC应推进研发同学对SLA的重视，对SLA的公示和更新流程明确，养成使用对方平台或研发系统共建时，掌握服务承诺事项，避免采坑。\n\n**〖改进项〗**\n\n1、关于GOC收录情况，今然在跟进，晓与带回同卓越工程团队，评估SLA平台的搭建@晓与 0930\n2、一休平台服务等级协议的修订，完善服务标准；[参考资料](https://aws.amazon.com/cn/what-is/service-level-agreement/)[@明樵](undefined/tongqi.ltq)1115\n\n:::\n\n\n\n\n\n## 五、故障关注点\n### 5.1【系统质量】\n#### 5.1.1 需求&设计评估\n##### 〖关注点〗是否涉及产品、技术方案评估？此核心的问题是什么，如何改进？\n:::info\n- [x] 否，不涉及\n\n:::\n\n#### 5.1.2  代码质量\n##### 〖关注点〗是否代码自身存在漏洞或BUG、代码健壮性是否存在问题等?\n:::info\n- [x] 否，不涉及\n\n:::\n\n\n\n##### 〖关注点〗是否经过CodeReview？CodeReview阶段是否发现问题？为何没发现？\n:::info\n+ **是否经过CR**\n    - [x] 是\n+ **是否设置合理的CR卡点**\n    - [x] 是\n+ **CR人员：朝南**\n+ **CodeReview阶段是否发现问题？为何没发现？后续如何发现？**\n    - [x] 否\n\n:::\n\n****\n\n##### 〖关注点〗测试阶段\n:::info\n+ **测试人员：齐奘、朝南**\n+ **是否经过测试验证**\n    - [x] 是，验证环境\n        - [x] 内网环境，白名单验证通过\n\n一休实验地址(97%、1%、1%、1%)：[https://abtest.alibaba-inc.com/v2/l/url/detail.html?antId=226452&augeEnv=](https://abtest.alibaba-inc.com/v2/l/url/detail.html?antId=226452&augeEnv=)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/5156405/1724156917807-8de92379-e080-4720-8d89-d91fc29443f9.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/5156405/1724156804117-abbd184e-e1dc-4c65-9cb6-f7ad67103cab.png)\n\n+ **测试未发现原因是什么？后续如何改进？**\n    - [x] 其他原因说明：考虑是否白名单未命中场景；一休平台建议提供测试SOP，可视化日志检查手段。\n\n**〖问题总结〗**\n\n1、增强客户端实验，联调测试二维码能力[@明樵](undefined/tongqi.ltq)0920\n\n:::\n\n#### 5.1.3 变更质量\n##### 〖关注点〗变更阶段\n:::info\n+ **是否涉及变更：**\n    - [x] 是\n+ **变更类型：**\n    - [x] 其他变更：____一休实验发布________\n+ **变更平台是否接入ChangeFree：**\n    - [x] 是，CF变更单链接：[https://aicf.alibaba-inc.com/aicf/approval/detail/7904690](https://aicf.alibaba-inc.com/aicf/approval/detail/7904690)\n+ **是否违反变更红线3.1**** **\n    - [x] 否\n\n:::\n\n##### 〖关注点〗灰度阶段\n:::info\n+ **",
    "chunk_order_index": 3,
    "full_doc_id": "doc-6c184c63fe43d58ec12e4c6f70108768"
  },
  "chunk-5158f402a52403c5ea10e55d263cd655": {
    "tokens": 1200,
    "content": "变更平台是否接入ChangeFree：**\n    - [x] 是，CF变更单链接：[https://aicf.alibaba-inc.com/aicf/approval/detail/7904690](https://aicf.alibaba-inc.com/aicf/approval/detail/7904690)\n+ **是否违反变更红线3.1**** **\n    - [x] 否\n\n:::\n\n##### 〖关注点〗灰度阶段\n:::info\n+ **是否经过灰度：**\n    - [x] 是\n\n**〖问题总结〗**\n\n一休实验的变更内容也是灰度的一种方式之一，此次变更也是分批。\n\n:::\n\n##### 〖关注点〗上线阶段\n:::info\n+ **是否有确定的监控观测指标**[@仲为](undefined/lw231756)\n    - [x] 是\n        * _附链接_：[https://xflush.alibaba-inc.com/custom/42/product/preview/cms/1546](https://xflush.alibaba-inc.com/custom/42/product/preview/cms/1546)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/66856475/1724917063094-738d87aa-9712-4584-a69d-6865b6df0a5e.png)\n\n+ **是否在窗口期进行发布变更**\n    - [x] 是\n\n:::\n\n\n\n### 5.2【处置能力】\n#### 5.2.1 故障发现&响应\n:::info\n+ **是否监控发现**\n    - [x] 否，原因为：VOC、sunfire监控均为触发阈值\n+ **发现后是否五分钟内响应**\n    - [x] 是\n+ **应急协同组织是否存在问题，如何改进？**\n    - [x] 是\n        - [ ] 应急流程不明确（无流程或者流程不清晰、应急相关角色&职责不明确，缺失一号位等)\n        - [x] 应急执行不到位（有流程，但未按流程执行，通告发送不及时，响应不及时等）\n\n**〖问题总结〗**\n\n应急语音会上，体验同学有提到客诉粗略40例，因没有拿到详细客诉量级，且大家均已在应急，预案止血也较快，并未升级处理，待第二天确认了T+1离线客诉明细表后，才做的补发；\n\n**〖改进项〗**\n\n未来严格按应急流程，以CCO体验同学的反馈口径快速升级故障，不做客诉细节筛查；\n\n:::\n\n#### 5.2.2 故障定位&恢复\n:::info\n+ **故障涉及恢复方式：**\n    - [x] 降级预案，关闭换购入口\n\n:::\n\n##### 〖关注点〗是否有更快恢复的方式？如何优化改进？\n:::info\n**〖问题总结〗**\n\n1、第一时间不能业务有损降级（还需业务同学进行确认），所以第一时间选择回滚；\n2、发现回滚无效后，立刻拉动业务同学决策入口下线，预案执行；\n目前看当时操作决策无误；\n\n**〖改进点〗**\n\n评估：一休具备切流至0%的恢复手段，可以比下线实验的方式更快止血。\n\n:::\n\n#### 5.2.3 SRE应急参与（淘天业务技术参考）\n+ **SRE工程师应急参与**\n    - 是否响应\n        - [ ] 是\n    - 是否帮助定位\n        - [ ] 是\n    - 是否操作恢复/提出有效恢复方案\n        - [ ] 是\n+ **SRE专家是否有效指挥**\n        - [ ] 是\n\n## 六、故障Action\n| **序号** | **ACTION** | **计划完成时间** | **验收标准** | **Action负责人** | **Action验收人** |\n| --- | --- | --- | --- | --- | :---: |\n| 1 | 评估灰度方案:一休平台的灰度放量方式，调整； | 0930 | 评估灰度方案 | 明樵 | |\n| 2 | 服务端告警阈值调整，修改为环比前 5 分钟下降 25%或 同比昨日下降 30%； | 0908 |  | 仲为 | |\n| 3 | 回滚流程的的定时任务间隔适当调整，IOS逐渐放量开启一休7月新迭代的SDK版本，支持从服务端mtop加速拉取配置，(安卓已全量，10min到达率90%)需要做IOS的能力上线、IOS能力的效果反馈； | 0930 |  | 明樵 | |\n| 4 | %等保留字符出现在URL实验定向配置时，根据端侧能长期兼容看是否直接禁止，端侧的保留字符配置阻断； | 0910 |  | 明樵 | |\n| 5 | SLA在实验发布页面强调透出，另外补充【使用规范】：建议URL类型实验补充入口降级预案，恢复时间由业务自行控制；使用规范在产品内的透出； | 0910 |  | 明樵 | |\n| 6 | 自营技术调整产品线节点，融合淘宝买",
    "chunk_order_index": 4,
    "full_doc_id": "doc-6c184c63fe43d58ec12e4c6f70108768"
  },
  "chunk-bd6a927ee89ba8d66beb86df5363d991": {
    "tokens": 633,
    "content": "直接禁止，端侧的保留字符配置阻断； | 0910 |  | 明樵 | |\n| 5 | SLA在实验发布页面强调透出，另外补充【使用规范】：建议URL类型实验补充入口降级预案，恢复时间由业务自行控制；使用规范在产品内的透出； | 0910 |  | 明樵 | |\n| 6 | 自营技术调整产品线节点，融合淘宝买菜、天猫超市VOC洞察能力，同时联动体验平台的开发，检查VOC洞察链路； | 0910 |  | 晓与 | |\n| 7 | 关于GOC收录情况，今然在跟进，晓与带回同卓越工程团队，评估SLA平台的搭建； | 0930 |  | 晓与 | |\n| 8 | 一休平台服务等级协议的修订，完善服务标准； | 1115 |  | 明樵 | |\n| 9 | 增强客户端实验，联调测试二维码能力 | 0920 |  | 明樵 | |\n\n\n## 七、故障分计算\n| **  系统质量（30%）** | | | | | **处置能力（70%）** |\n| :---: | --- | --- | --- | --- | --- |\n| **相关方** | **需求&设计** | **代码质量** | **变更质量** | **自定义项** | **发生时间** | **发现时间（30%）** | **恢复时间（40%）** |\n| 淘天集团-业务技术-自营技术-泛端技术-消费前端 | 否 | 否 | 否 | -- | 2024-08-20 13:41 | 2024-08-20 13:25（但开发并未第一时间介入） | 不涉及，正常立即决策走正常一休平台回滚，平台有缓存延时，后决策降级故障完全恢复 |\n| 淘天集团-业务技术-用户&内容技术-用户运营-人群&AB平台 | 不涉及 | 不涉及 | 不涉及 | -- | 2024-08-20 13:41 | 不涉及，一休侧具备实时流量监控能力，但无法感知业务指标下降导致的故障 | 不涉及，一休侧具备实验调整及下线能力，但受限于客户端设备推送到达率，推送恢复会有15min延迟 |\n| 淘天集团-业务技术-终端平台-应用平台-应用服务技术 | 不涉及 | 不涉及 | 不涉及 | -- | 2024-08-20 13:41 | 不涉及，端侧提供的是基本内容接收与透传能力，这些能力本身服务正常 | 不涉及，端侧提供的是基本内容接收与透传能力，这些能力本身服务正常 |",
    "chunk_order_index": 5,
    "full_doc_id": "doc-6c184c63fe43d58ec12e4c6f70108768"
  },
  "chunk-a933bbcb0270e77747caef2272687d74": {
    "tokens": 1200,
    "content": "## 一、故障简述\n【P5】2024-08-29于10:35，线上 5+ 用户反馈无法部署，触达 P5 故障，经确认故障原因是，底层 disp 调度集群中的一台 ECS 存在异常，该机器中的容器任务均无法启动，上层流水线中的质量检测节点一直处于等待中状态，流水线任务大量堆积后导致 redis 日志无法短时间内清理，使内存接近满负荷，造成部署无法正常发起，于10:45 扩容成功后恢复，请知晓。\n\n**APM故障链接：**[**https://g-mobile.alibaba-inc.com/ormFailure/workbench/failure/202408290000000398001**](https://g-mobile.alibaba-inc.com/ormFailure/workbench/failure/202408290000000398001)\n\n## 二、故障过程回顾\n### 【故障处理时间线】\n----背景过程----\n2024-08-29 09:38， 内存达到 80%；\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/66856475/1725432887626-aa1ec5b8-bdda-4d30-b3cb-1773bffa79b2.png)\n\n2024-08-29 09:57， 内存达到 90%；\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/66856475/1725432887614-62250d1f-dbb4-49fb-98a8-223c0e704515.png)\n\n2024-08-29 10:35， 底层 disp 调度集群中的一台 ECS 存在异常，该机器中的容器任务均无法启动，上层流水线中的质量检测节点一直处于等待中状态，流水线任务大量堆积后导致 redis 日志无法短时间内清理，内存接近满负荷；【故障引入】\n\n\n----应急过程----\n2024-08-29 10:21， O2开发 月侠 发现 flow redis 内存告警长期处于高位，开始扩容；【恢复执行】\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/66856475/1725432887667-f4fc6ba4-ebf8-4eda-9ca0-6a1bd5229722.png)\n\n2024-08-29 10:34， 一线答疑拉群，反馈有 7 例用户提到“质量检测一直运行中”， “无法发起部署任务”；【故障发生】【故障发现】【业务响应】\n2024-08-29 10:40， 语音会上，redis 扩容仍未完成，扩容任务卡住，联系阿里云DBA 楚玉 推进；\n2024-08-29 10:45，redis 扩容完成，部署任务可正常发起 ；【故障恢复】\n\n### 【过程概览】\n![画板](https://intranetproxy.alipay.com/skylark/lark/0/2024/jpeg/66856475/1725440795166-ec21614b-5391-477d-8cb9-a8678d19931a.jpeg)\n\n## 三、影响产品线及影响面\n    - [x] 业务影响：\n        * 质量检测一直运行中，无法发起部署任务，10:00-10:45，持续 45分钟左右；\n    - [x] 是否有客诉量：\n        * 10:35 -10:45，进入在线反馈人数：7例；\n    - [ ] 是否有社会舆情：\n        * 否\n    - [ ] 是否产生资损：\n        * 否\n\n## 四、故障原因\n### 4.1【一句话原因】\n__底层 disp 调度集群中的一台 ECS 存在异常，该机器中的容器任务均无法启动，上层流水线中的质量检测节点一直处于等待中状态，流水线任务大量堆积后导致 redis 日志无法短时间内清理，使内存接近满负荷，造成部署无法正常发起。\n\n### 4.2【背景说明】\n+ 【业务链路】以业务连图的形式体现故障整体的链路图及根因节点\n\n![画板](https://intranetproxy.alipay.com/skylark/lark/0/2024/jpeg/66856475/1725440244782-80ca6d75-1b85-4086-bbfd-806ae8b8766c.jpeg)\n\n### 4.3【根因分析】\n+ ECS 机器的 docker 创建容器失败，具体原因暂未定位到。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/268020/1725436674232-bf11d76b-cf61-4186-bfd4-7b9fb3113fa5.png)\n\n\n\n\n\n#### 〖关注点1〗ECS异常后，有相关告警么？集群是否能自动化摘除异常机器？\n:::info\n**〖问题总结〗**\n\n1、没有告警；\n\n2、有相关能力，但此次属于pod卡在创建容器任务环节中，现有能力不感知此类异常；\n\n**〖改进点〗**\n\n1、已列action列表\n\n:::\n\n#### 〖",
    "chunk_order_index": 0,
    "full_doc_id": "doc-d413f96d413eeaa17a5111b0c4d88ce5"
  },
  "chunk-331bfad904bd2053655d7df3124fbd5f": {
    "tokens": 1200,
    "content": "3113fa5.png)\n\n\n\n\n\n#### 〖关注点1〗ECS异常后，有相关告警么？集群是否能自动化摘除异常机器？\n:::info\n**〖问题总结〗**\n\n1、没有告警；\n\n2、有相关能力，但此次属于pod卡在创建容器任务环节中，现有能力不感知此类异常；\n\n**〖改进点〗**\n\n1、已列action列表\n\n:::\n\n#### 〖关注点2〗该业务特性中的机器情况是什么？收集到机器存在大CPU的情况，迁移至类似构建容器化的能力是否存在挑战？\n:::info\n**〖问题总结〗**\n\n1、原有业务建设中，历史原因无类似构建容器化的能力，flow服务端存在大CPU的ECS情况；\n\n2、已经计划迁移Taskline；\n\n3、业务改造成本、机器性能保障、用户体验至少保持一致等风险，均存在挑战，需要各方的支持；\n\n**〖改进点〗**\n\n1、短期：人工运维处理；\n\n2、中期：评估迁移方案，包含flow的迁移内容、里程碑等信息；0930、乾杯\n\n:::\n\n#### 〖关注点2〗质量检测节点是否能做跳过？\n:::info\n**〖问题总结〗**\n\n1、目前没有能力做该卡点的跳过，已开始评估做跳过能力\n\n**〖改进点〗**\n\n1、action中已列\n\n:::\n\n## 五、故障关注点\n### 5.1【系统质量】\n#### 5.1.1 需求&设计评估\n##### 〖关注点〗是否涉及产品、技术方案评估？此核心的问题是什么，如何改进？\n:::info\n- [x] 否，不涉及\n\n:::\n\n#### 5.1.2  代码质量\n##### 〖关注点〗是否代码自身存在漏洞或BUG、代码健壮性是否存在问题等?\n:::info\n- [x] 否，不涉及\n\n:::\n\n#### 5.1.3 变更质量\n##### 〖关注点〗变更阶段\n:::info\n+ **是否涉及变更：**\n    - [x] \n\n:::\n\n### 5.2【处置能力】\n#### 5.2.1 故障发现&响应\n:::info\n+ **是否监控发现**\n    - [x] 否\n+ **发现后是否五分钟内响应**\n    - [x] 是\n+ **应急协同组织是否存在问题，如何改进？**\n    - [x] 否\n    - [ ] 是\n        - [ ] 应急流程不明确（无流程或者流程不清晰、应急相关角色&职责不明确，缺失一号位等)\n        - [ ] 应急执行不到位（有流程，但未按流程执行，通告发送不及时，响应不及时等）\n\n**〖问题总结〗**\n\n扩容时，也是第一时间拉了（扩容应急）粟裕、（数据库应急）许恺，路由至楚玉后，也是帮忙后台查看扩容情况，应急上没有太大问题。\n\n**〖改进〗**\n\n晓与带回关于应急路由人员匹配表做更新，0906，晓与\n\n:::\n\n#### 5.2.2 故障定位&恢复\n:::info\n+ **故障涉及恢复方式：**\n    - [x] 扩容\n\n:::\n\n##### 〖关注点〗是否有更快恢复的方式？如何优化改进？\n:::info\n**〖问题总结〗**\n\n手动清理redis日志可能更快，但目前依赖具体同学，并无预案能力，事后看，当时具体同学请假状态，无法评估及执行清理，所以扩容是当前处理团队最优选；\n\n:::\n\n## 六、故障Action\n| **序号** | **ACTION** | **计划完成时间** | **验收标准** | **Action负责人** | **Action验收人** |\n| --- | --- | --- | --- | --- | :---: |\n| 1 | disp 增加 callback 接口，容器启动失败时能通知上层服务 | 2024-09-24 | 上层流程任务能被动感知到容器是否启动成功 | @杨能康(远浪) | |\n| 2 | 增加流水线实例的运行时长、发起成功率的监控，加成TR上的风险场景 | 2024-09-17 | 1. 当超过 30min 运行中任务达到 50 例时，触发告警（数值为举例，将按实际设置，下同）2. flow 任务创建成功率低于 90% 时，触发告警3. 提供TR风险场景链接 | @胡麒阳(乾杯) | |\n| 3 | 增加上层流水线服务对 disp 容器任务健康度的主动检测，如超时，超时后主动清理 reids 日志 | 2024-09-10 | 容器超时后主动清理流程任务的 reids 日志 | @胡麒阳(乾杯) | |\n| 4 | 支持用户主动取消质量检测任务 | 2024-09-13 | 质量检测任务长时间运行时，用户可主动取消 | @孔祥鹏(栖邀) |",
    "chunk_order_index": 1,
    "full_doc_id": "doc-d413f96d413eeaa17a5111b0c4d88ce5"
  },
  "chunk-18a9569e392c442905744fa630262dfd": {
    "tokens": 242,
    "content": "度的主动检测，如超时，超时后主动清理 reids 日志 | 2024-09-10 | 容器超时后主动清理流程任务的 reids 日志 | @胡麒阳(乾杯) | |\n| 4 | 支持用户主动取消质量检测任务 | 2024-09-13 | 质量检测任务长时间运行时，用户可主动取消 | @孔祥鹏(栖邀) | |\n| 5 | 提供快速清理无效 redis 日志及异常任务的能力 | 2024-09-24 | 支持一键清理无效 redis 日志及异常任务 | @胡麒阳(乾杯) | |\n| 6 | disp集群容器创建成功率的监控 | 2024-10-24 | 提供监控链接 | @杨能康(远浪) | |\n| 7 | 中期：评估迁移方案，包含flow的迁移内容、里程碑等信息；0930、乾杯 | 2024-09-30 |  | 乾杯 | |",
    "chunk_order_index": 2,
    "full_doc_id": "doc-d413f96d413eeaa17a5111b0c4d88ce5"
  },
  "chunk-ec1c143b3792c2b477c063c89fda1b57": {
    "tokens": 1200,
    "content": "## 一、故障简述\n_【P5】_2024-08-19 于17:24，线上5+用户反馈镜像推送失败及权限异常，触达P5故障，经确认故障原因为安全侧对zeus仓的镜像推送账号进行了权限限制，于17:31异常恢复，故障恢复，请知晓。\n\n**APM故障链接：**[**https://tr.alibaba-inc.com/ormEmergency/workbench/emergency/202408190000000992001**](https://tr.alibaba-inc.com/ormEmergency/workbench/emergency/202408190000000992001)\n\n## 二、故障过程回顾\n### 【故障处理时间线】\n----背景过程----\n2024-08-19 16:50， 宙斯开发 审配 分批治理大账号高危子账号（总计600+子账号）首批治理50+子账号，首批中存在子账号aonebaseimage_admin ，该账号AKSK禁用3年多 ，同时权限审计Beta展示最近没有访问 且子账号无责任人，所以判断该子账号可以去掉AliyunContainerRegistryFullAccess权限。去掉后故障引入。【故障引入】\n----应急过程----\n2024-08-19 17:18， 一线答疑拉群，反馈有3例镜像推送失败；【故障发现】【业务响应】\n2024-08-19 17:19，aone开发 得雷 查看问题构建链接，发现镜像推送失败的case都是zeus仓的。怀疑跟仓库侧变更有关。语音拉邓隽入会咨询。\n2024-08-19 17:24， 容器镜像开发 邓隽 初步判断后，拉zeus仓相关同学入会，确认问题。【初因定位】\n2024-08-19 17:26， 技术支持拉铃P5，反馈有6例镜像推送失败；【故障发生】\n2024-08-19 17:29， 宙斯开发 浏柊 被拉会议说镜像推送失败，宙斯开发 审配 认识到可能与子账号治理相关主动入会确认并立刻登陆官网大账号控制台将aonebaseimage_admin子账号的权限AliyunContainerRegistryFullAccess恢复，恢复后，故障恢复。【故障恢复】\n\n### 【过程概览】\n![画板](https://intranetproxy.alipay.com/skylark/lark/0/2024/jpeg/66856475/1724723316080-3b1e3cfc-d786-4d1f-bf23-0cf86e201ddc.jpeg)\n\n## 三、影响产品线及影响面\n    - [x] 业务影响：\n        * 拉取宙斯仓镜像失败，16:50-17:29，持续39分钟左右；\n    - [x] 是否有客诉量：\n        * 16:45-17:30，进入在线反馈人数：12例\n\n[0819-镜像推送失败-客诉量级.xlsx](https://yuque.antfin.com/attachments/lark/0/2024/xlsx/147156506/1731031184384-9b297d9d-22ee-48a2-86dd-0ca82ad262bd.xlsx)\n\n## 四、故障原因\n### 4.1【一句话原因】\n安全工单治理导致子账号（aonebaseimage_admin）的权限（_AliyunContainerRegistryFullAccess）_被移除导致。\n\n### 4.2【背景说明】\n+ 【需求背景】治理背景\n\n宙斯是云智能的云管平台，负责云只能所有的账号全生命周期和资源全生命周期的运维管理。FY25云智能高危组件治理战役，宙斯的大账号高危AKSK收敛和子账号权限收敛是治理目标之一。同时安全侧实时发送安全分工单治理高危子账号权限。\n\n+ 【业务链路】以业务连图的形式体现故障整体的链路图及根因节点\n\n![画板](https://intranetproxy.alipay.com/skylark/lark/0/2024/jpeg/66856475/1724739727747-9383a629-951d-431d-9174-53adde3e8039.jpeg)\n\n### 4.3【根因分析】\naone推送拉取镜像的方式采用了固定账密形式没有使用标准的aksk方式且子账号无责任人，导致大账号管理者无法识别隐藏的风险； （需改进）\n安全工单治理导致子账号aonebaseimage_admin的权限[AliyunContainerRegistryFullAccess](https://ram.console.aliyun.com/policies/AliyunContainerRegistryFullAccess/System/content)被移除；\n控制台权限审计功能不准确误导实际大账号管理者。（需改进）\n\n#### 〖关注点1〗标准的aksk方式是什么样子？子账号为什么无责任人？是否针对这个场景全局通知、治理？\n:::info\n**〖问题总结〗**\n\n1、使用现状：AOne这边将环境侧透传下来的docker_region配置（配置了zeus仓的固定账密），写入镜像构建链路中的docker/config.json [@得雷](undefined/zouqiang.zou)\n\n2、标准方式？差异原因？[@审配](undefined/sh",
    "chunk_order_index": 0,
    "full_doc_id": "doc-9fb4ee43517234e7ad6794edf4536f07"
  },
  "chunk-3f70b94cedc8f2b8d26cf829549d72bf": {
    "tokens": 1200,
    "content": "？子账号为什么无责任人？是否针对这个场景全局通知、治理？\n:::info\n**〖问题总结〗**\n\n1、使用现状：AOne这边将环境侧透传下来的docker_region配置（配置了zeus仓的固定账密），写入镜像构建链路中的docker/config.json [@得雷](undefined/zouqiang.zou)\n\n2、标准方式？差异原因？[@审配](undefined/shenpei)\n\n通过子账号固定AKSK的方式访问ACREE推送和拉取镜像，（更安全的方式则是接无aksk用临时AKSK的有限全权限的方式拉取和推送镜像达到大账号不越权）\n\n固定账号密码的方式本身是通过ACREE那边设置一个账号密码 然后去拉取 ，但是该账号又和子账号的权限强相关（这是一个隐藏逻辑 非常容易出现问题且公共云客户也会有这个坑），个人建议ACREE取消这种方式，即使采用固定账号也不应该和子账号有强相关（参照ECS的账密）\n\n3、子账号无责任人原因：[@审配](undefined/shenpei)\n\n历史上宙斯的售卖区大账号开出去很多高危AKSK和子账号，都不是通过宙斯和诺曼底申请开出去的都是直接在控制台开的子账号。这些是历史问题相关的人员都已经离职无从追溯，这也是我们治理大账号子账号的原因之一。\n\n**〖改进点〗**\n\n   1.宙斯梳理大账号下所有有镜像推送和拉取权限的子账号找到责任人并登记在文档在团队内部同步，同时推动其采用个人独立账号实现ACREE仓库能力，不走大账号。实在短期无法实现改成子账号无AKSK或固定AKSK有限权限访问大账号ACREE的方式，[@审配](undefined/shenpei)，0930\n1.1 先整理aone使用的大账号所有范围，做好这些账号影响面控制；aone使用的宙斯仓库的场景，评估无AKSK或固定AKSK的系统能力改进；[@得雷](undefined/zouqiang.zou)，0930\n\n  2.大账号不会再新增拥有AliyunContainerRegistryFullAccess的权限的子账号，严格管控子账号的新增；（系统能力已有，需要宙斯团队内部同步下：不做增量）\n\n  3.ACREE固定账号需要ACREE同学再次评估是否是标准合理的架构模式，对内和对客都是一种隐藏的风险（文案提醒等）；[@邓隽](undefined/juan.dengj)0930\n\n:::\n\n#### 〖关注点2〗控制台权限审计功能不准确误导实际大账号管理者，如何治理？\n:::info\n**〖问题总结〗**\n\n控制台的权限审计BETA版本可能存在问题，实际这个子账号有在用这个权限 但是展示的确实最近无使用，具体需要该功能的owner排查。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/11077/1724730225393-7c112dbe-81d7-4347-b677-db1c93524b67.png)\n\n**〖改进点〗**\n\n权限审计功能管控范围的调研，将此次事件的[@治洋](undefined/zhiyang.tzy)\n\n:::\n\n\n\n## 五、故障关注点\n### 5.1【系统质量】\n#### 5.1.1 需求&设计评估\n##### 〖关注点〗是否涉及产品、技术方案评估？此核心的问题是什么，如何改进？\n:::info\n- [x] 否，不涉及\n\n**〖问题总结〗**\n\n核心问题为子账号治理中，对于权限配置的问题；\n\n:::\n\n#### 5.1.2  代码质量\n##### 〖关注点〗是否代码自身存在漏洞或BUG、代码健壮性是否存在问题等?\n:::info\n- [x] 否，不涉及\n\n:::\n\n#### 5.1.3 变更质量\n##### 〖关注点〗变更阶段\n:::info\n+ **是否涉及变更：**\n    - [x] 是\n+ **变更类型：**\n    - [x] 其他变更：____阿里云子账号权限收回________\n\n:::\n\n##### 〖关注点〗灰度阶段\n:::info\n+ **是否经过灰度：**\n    - [x] 否，账号权限无法灰度\n\n:::\n\n##### 〖关注点〗上线阶段\n:::info\n+ **是否在窗口期进行发布变更**\n    - [x] 是\n+ **变更是否影响上下游**\n    - [x] 是\n+ **是否提前知会上下游评估及关注变更**\n    - [x] 否\n\n**〖问题总结〗**\n\n大账号owner是云侧同学，目前此账号已禁止ak3年，也无权限审计记录，所以直接关了子账号的权限；\n\n:::\n\n### 5.2【处置能力】\n#### 5.2.1 故障发现&响应\n:::info\n+ **是否监控发现**\n    - [x] 否，原因为：实例权限配置问题\n+ **发现后是否五分钟内响应**\n    - [x] 是",
    "chunk_order_index": 1,
    "full_doc_id": "doc-9fb4ee43517234e7ad6794edf4536f07"
  },
  "chunk-b6edc367228828f2e4e45c3e970a4cdc": {
    "tokens": 750,
    "content": "大账号owner是云侧同学，目前此账号已禁止ak3年，也无权限审计记录，所以直接关了子账号的权限；\n\n:::\n\n### 5.2【处置能力】\n#### 5.2.1 故障发现&响应\n:::info\n+ **是否监控发现**\n    - [x] 否，原因为：实例权限配置问题\n+ **发现后是否五分钟内响应**\n    - [x] 是\n+ **应急协同组织是否存在问题，如何改进？**\n    - [x] 否\n    - [ ] 是\n        - [ ] 应急流程不明确（无流程或者流程不清晰、应急相关角色&职责不明确，缺失一号位等)\n        - [ ] 应急执行不到位（有流程，但未按流程执行，通告发送不及时，响应不及时等）\n\n**〖问题总结〗**\n\n控制台权限审计功能不准确需做好调整；\n\n**〖改进点〗**\n\n1、env-center存储密钥不合规，需要整改，[@晓与](undefined/zxy382343)0830\n2、aone侧的拉取镜像报错的监控阈值调整[@得雷](undefined/zouqiang.zou)0830\n\n:::\n\n#### 5.2.2 故障定位&恢复\n:::info\n+ **故障涉及恢复方式：**\n    - [x] 其他，子账号权限配置恢复\n\n:::\n\n##### 〖关注点〗是否有更快恢复的方式？如何优化改进？\n:::info\n**〖问题总结〗**\n\n事后回看，定位为子账号权限问题后，配置权限是最快的恢复方式了；\n\n:::\n\n## 六、故障Action\n| **序号** | **ACTION** | **是否keyAction** | **计划完成时间** | **验收标准** | **Action负责人** | **Action验收人** |\n| --- | --- | --- | --- | --- | --- | :---: |\n| 1 |   1.宙斯梳理大账号下所有有镜像推送和拉取权限的子账号找到责任人并登记在文档在团队内部同步，同时推动其采用个人独立账号实现ACREE仓库能力，不走大账号。实在短期无法实现改成子账号无AKSK或固定AKSK有限权限访问大账号ACREE的方式， | | 0930 |  | [@审配](undefined/shenpei) | |\n| 2 | 1.1 先整理aone使用的大账号所有范围，做好这些账号影响面控制；aone使用的宙斯仓库的场景，评估无AKSK或固定AKSK的系统能力改进； | | 0930 |  | [@得雷](undefined/zouqiang.zou) | |\n| 3 | ACREE固定账号需要ACREE同学再次评估是否是标准合理的架构模式，对内和对客都是一种隐藏的风险（文案提醒等）； | | 0930 |  | [@邓隽](undefined/juan.dengj) | |\n| 4 | aone侧的拉取镜像报错的监控阈值调整 | | 0830 |  | [@得雷](undefined/zouqiang.zou) | |\n| 5 |  | |  |  |  | |",
    "chunk_order_index": 2,
    "full_doc_id": "doc-9fb4ee43517234e7ad6794edf4536f07"
  },
  "chunk-b5ad31ac53063d1e28ad724138908bdc": {
    "tokens": 1200,
    "content": "## 一、故障简述\n2024-09-04 10:14，业务同学反馈首页展示异常，监控显示首页兜底数量突增；10:38，自动恢复。后定位到是因为慢sql触发TDDL限流策略。期间外网舆情6例。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/128256406/1725607346700-b3600aee-7013-4524-b102-78a0b84ec607.png)![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/128256406/1725607385494-290f91fe-c72b-49b8-88a8-1afac2ac3002.png)![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/128256406/1725439621523-2db35fc5-7b77-4628-ac69-49c26317e3f1.png)\n\n## 二、故障过程回顾\n### 2.1【故障时间线概览】\n![画板](https://intranetproxy.alipay.com/skylark/lark/0/2024/jpeg/128256406/1725847981329-4909e7d3-061f-4e83-91af-8f2bdbf67ac6.jpeg)\n\n故障时长：21min\n\n处理时长：24min\n\n### 2.2【故障完整时间线】\n2024-09-04 09:39，[@萧泽](undefined/xiaoze.wk)手动执行清理数据任务项 【故障引入】\n\n2024-09-04 10:09，素材查询SQL触发慢SQL限流策略，有tair缓存，缓存命中率开始下跌\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/342766/1725430121452-17ca6b21-0083-4f12-9b21-8fea79b54ec8.png)\n\n2024-09-04 10:14，业务反馈首页十个圈展示异常 **【故障发现】**\n\n2024-09-04 10:17，推首页兜底开关，发现兜底数据不完整。同一时间首页十个圈展示成功量最近3分钟与基线同比下跌大于60%且成功量基线当前值大于3000，触达故障**【故障发生】**\n\n2024-09-04 10:23，停用清理数据任务项\n\n2024-09-04 10:26，停掉投放预发机器的java容器,重启运行清理数据任务机器，停掉运行中的任务\n\n2024-09-04 10:30左右，协调DBA同学协助排查\n\n2024-09-04 10:31，重启投放系统线上环境的机器\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/143358/1725429988158-fdf8f1b9-8b4a-43f0-8c51-85054a607a8c.png?x-oss-process=image%2Fformat%2Cwebp%2Fresize%2Cw_1022%2Climit_0)\n\n2024-09-04 10:37，首页限流，单机阈值4改为2，推送过程中发现首页展示恢复\n\n2024-09-04 10:38，首页展示自动恢复**【故障恢复】**\n\n2024-09-04 13:20左右，定位原因为查询素材sql命中tddl的慢sql自动限流策略，同时清理历史素材sql也触发该限流策略，两个sql模板共用限流线程池（16个线程）。由于清理历史素材sql执行耗时较长占满线程池，导致素材查询sql无法执行，最终首页展示异常。【故障定位】\n\n## 三、故障原因\n### 3.1【背景说明】\n投放历史数据较多，为了降低线上慢SQL风险，删除历史数据。\n\n### 3.2【一句话原因】\n投放坑位单次查询素材SQL命中数据库的慢SQL自动限流策略，同时清理历史素材SQL也触发该限流策略\n\n两个SQL模板共用限流线程池（16个线程），由于清理历史素材SQL执行耗时较长占满线程池，导致素材查询SQL无法执行，最终十个圈展示异常。\n\n### 3.3【根因分析】\n+ 数据库自动限流策略说明：\n    - 当一个请求执行超过设置阈值1秒（slow_query_blocker_long_query_time_sec）时，会自动生成限流规则。每一次请求在执行前，会在数据库内核会匹配是否存在限流规则，若存在，则检查是否满足限流阈值16（slow_query_blocker_limit_ratio * thread_pool_size），当请求量并发超过阈值时，进入fastfail状态，应用层产生Query execution was interrupted 报错信息。\n    - 自动限流规则有一个计时器，在300秒（slow_query_blocker_rule_timeout_sec）内未发生限流，规则会自动失效。\n+ 素材查询触发数据库自动限流策略，�",
    "chunk_order_index": 0,
    "full_doc_id": "doc-dab68d8930fa6d64dc4d1a229af5d2d3"
  },
  "chunk-b11e14b1f1c25a30bf57b95f199214dc": {
    "tokens": 1200,
    "content": "存在，则检查是否满足限流阈值16（slow_query_blocker_limit_ratio * thread_pool_size），当请求量并发超过阈值时，进入fastfail状态，应用层产生Query execution was interrupted 报错信息。\n    - 自动限流规则有一个计时器，在300秒（slow_query_blocker_rule_timeout_sec）内未发生限流，规则会自动失效。\n+ 素材查询触发数据库自动限流策略，叠加限流线程池被删除素材sql占满，最终无法执行素材查询。\n+ [限流策略背景及原理](https://aliyuque.antfin.com/db_service_lark/magkb7/qmc713)\n\n## 四、关注点分析\n关注点1：故障为什么没有监控发现？\n\n+ 首页和10个圈监控只判断了是否有数据，未对数据合法性（圈数量）做校验。只要有某个圈的素材返回，监控就不会报异常，导致首页监控失效。\n+ 其他监控有预警，但是未进到【导购风险预警群】，未引发预警关注。\n\n:::tips\n**Action：**\n\n+ 首页核心楼层监控增加合法性校验，确保监控能正常预警** **[@萧泽](undefined/xiaoze.wk)**  **9.12\n+ 梳理监控预警链路（应用、中间件、业务等），将所有核心页面的监控进到【导购风险预警群】[@寂帷](undefined/tjw284520)  9.19\n+ 内部评估核心应用和非核心应用预警的管理方案，增量场景的预警管理，落入标准流程维护。 [@酥打](undefined/shaodan.xsd) [@兰葩](undefined/lanpa.yzz)  带回讨论\n+ 梳理导购域应用，确保数据库应用级别标签（核心/非核心）和实际对应 [@寂帷](undefined/tjw284520)\n\n:::\n\n\n\n关注点2：首页兜底为什么失效？\n\n+ 首页兜底机制：会将成功的页面数据放进兜底oss中。\n+ 失效原因：兜底数据并未做数据合法性校验。本次case中，db没有全部被限流，依然会有某个圈素材返回，导致这种不合法数据也写进了兜底数据中，从而污染了兜底数据。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/128256406/1725852011395-e8c9fd81-c55c-4c8a-9fac-f7355b99c99e.png)\n\n:::tips\n**Action：**\n\n+ 需要建立一套首页兜底强保机制。包含数据合法性校验，兜底有效性校验（对端），数据覆盖率校验等，并且每天输出一次校验 [@酥打](undefined/shaodan.xsd)[@寂帷](undefined/tjw284520)[@萧泽](undefined/xiaoze.wk)[@北翎](undefined/dengna.dn)  9.14\n+ 确保导购侧核心的转化场景兜底机制的有效性（直达P1/2，升级P1/2）   [@寂帷](undefined/tjw284520)  验收人：[@北翎](undefined/dengna.dn)\n\n:::\n\n\n\n关注点3：故障定位为什么花费这么长时间？\n\n+ 客观：\n    - 根因与问题发生时间偏差较大（故障注入09:39，故障发生10:08），导致没有快速关联到。\n    - DB SQL模板自动限流机制（触发时机&两个SQL模板共用同一个限流池）黑盒，研发侧无人知晓。\n+ 主观：\n    - 排查同学缺乏线上应急经验。排查工具和排查方法不足；\n\n:::tips\n**Action：**\n\n+ 针对错误码 “4614” 报错透出，设置监控  [@萧泽](undefined/xiaoze.wk)  9.19\n+ 业务侧订阅慢sql限流通知   [@智盛](undefined/zhisheng.cjf)  带回评估\n\n:::\n\n\n\n关注点4：清理SQL执行了58分钟是否正常？\n\n+ 应用层会快速收到报错\n+ DB层是否有自动终止超时SQL任务的机制？\n    - DB侧不会针对SQL进行超时终止，没法单独加白\n    - 查看正在执行的SQL的方法，[@智盛](undefined/zhisheng.cjf) 提供文档\n\n\n\n关注点5：10:23已经停止清理任务了，为什么任务没有停止？\n\n+ 10:23禁用DTS任务，10:26~28重启运行任务机器，确保停掉运行中的任务\n+ 任务是已停止的，但是DB限流机制不会立即停止\n\n\n\n关注点6：DB限流池中资源分配逻辑是什么样的？\n\n一个work线程会同步等待innodb的读写结果, 因此在query IO时间内, 线程资源被当前query占据. worker线程数量限制为thread_pool_size * thread_pool_oversubscribe（当前设置为16）, 当有大量slow query到来",
    "chunk_order_index": 1,
    "full_doc_id": "doc-dab68d8930fa6d64dc4d1a229af5d2d3"
  },
  "chunk-b9e414bd7de6daa9307b7bdb5dcc6781": {
    "tokens": 1200,
    "content": "确保停掉运行中的任务\n+ 任务是已停止的，但是DB限流机制不会立即停止\n\n\n\n关注点6：DB限流池中资源分配逻辑是什么样的？\n\n一个work线程会同步等待innodb的读写结果, 因此在query IO时间内, 线程资源被当前query占据. worker线程数量限制为thread_pool_size * thread_pool_oversubscribe（当前设置为16）, 当有大量slow query到来占据线程池资源, 则后续请求无法进去worker被执行(或者进入线程池后因为IO资源被slow query占用而导致IO 等待, 进而恶化线程池资源地释放)。\n\n\n\n关注点7：是否有办法针对触发了限流策略的SQL进行加白的操作？\n\n已经触发自动限流的sql暂时没有加白的手段，目前已给阿里云提出需求，现阶段先找[@智盛](undefined/zhisheng.cjf)协助处理\n\n\n关注点8：高峰期时间做变更是否合理？\n\n+ 数据清理同学[@萧泽](undefined/xiaoze.wk)有意识到数据清理是一个危险的操作。但是该数据清理任务已执行一周时间，一开始是晚上执行，但是发现执行速度很慢，所以将任务执行改到了白天，并且一周以来也没有出现问题，所以出现了松懈。并且整个过程没有遵循数据变更规范。\n+ 主管[@酥打](undefined/shaodan.xsd)也有意识到该执行动作是风险行为，并且在周会上有强调，但未给出数据清理的标准SOP，并且没有未持续关注该数据清理执行的进程。整个过程出现了管理失位。\n\n:::tips\n**Action：**\n\n+ 量化数据清理过程，数据清理过程统一使用DMS任务根据时间定时清理的功能进行清理；[@寂帷](undefined/tjw284520)\n+ DTS任务要纳入管控流程  [@若丰](undefined/huipeng.whp)   \n\n:::\n\n\n\n### 4.1【系统质量】\n#### 4.1.1 需求&设计评估  _否_\n**〖关注点1〗****是否涉及产品、技术方案评估？此核心的问题是什么，如何改进？**\n\n- [ ] **是，涉及**\n    - [ ] 需求评估遗漏\n    - [ ] 产品设计缺陷\n    - [ ] 系统架构设计缺陷\n        - [ ] 容错性不足 \n        - [ ] 单点，无冗余\n        - [ ] 缺乏自我保护\n        - [ ] 缓存设计不当\n        - [ ] 容量评估不足\n        - [ ] 非幂等设计\n        - [ ] 强弱依赖不合理\n        - [ ] 其他：__________\n- [ ] 否，不涉及\n\n**〖问题总结〗**\n\n**〖改进点〗**_**需明确写明不同故障相关方的改进项（若有的话），下同。**_\n\n1、\n\n#### 4.1.2 代码质量  _否_\n**〖关注点1〗****是否经过CodeReview？CodeReview阶段是否发现问题？为何没发现？**\n\n+ **是否经过CR**\n    - [ ] 是\n    - [ ] 否\n    - [x] 不涉及\n+ **是否设置合理的CR卡点**\n    - [ ] 是\n    - [ ] 否\n    - [x] 不涉及\n+ **CodeReview阶段是否发现问题？为何没发现？后续如何发现？**\n    - [ ] 是\n    - [ ] 否\n    - [x] 不涉及\n\n\n\n**〖关注点3〗****测试阶段**\n\n+ **测试内容：**涉及的测试提交单、测试用例等\n+ **测试人员：**\n+ **是否经过测试验证**\n    - [ ] 是，验证环境\n        - [ ] 预发环境\n        - [ ] 日常环境\n    - [ ] 是，测试方法\n        - [ ] 单元测试\n        - [ ] 功能回归测试\n        - [ ] 集成测试/链路测试\n        - [ ] 验收测试\n    - [ ] 否\n    - [x] 不涉及\n+ **测试未发现原因是什么？后续如何改进？**\n    - [ ] 回归测试遗漏\n        - [ ] 手工回归测试用例遗漏\n        - [ ] 自动化未建设\n        - [ ] 自动化回归覆盖不足\n        - [ ] 其他：__________\n    - [ ] 新场景测试遗漏\n        - [ ] 功能测试用例遗漏，包括正常分支和异常分支\n        - [ ] 容灾兜底测试遗漏\n        - [ ] 客户端兼容性测试遗漏\n        - [ ] 埋点测试遗漏\n        - [ ] 性能测试遗漏，影响评估不足\n        - [ ] 安全测试遗漏\n    - [ ] 其他：__________\n\n#### 4.1.3 变更质量   _否_\n+ **是否涉及变更：**\n    - [ ] 是\n    - [x] 否\n+ **变更类型：**\n    - [ ] 代码发布\n    - [ ] 配置变更\n    - [ ] 其他变更：____________\n    - [ ] 不涉及\n+ **变更平台是否接",
    "chunk_order_index": 2,
    "full_doc_id": "doc-dab68d8930fa6d64dc4d1a229af5d2d3"
  },
  "chunk-51fc0edba9f1eb78becb199f058440bc": {
    "tokens": 1200,
    "content": "安全测试遗漏\n    - [ ] 其他：__________\n\n#### 4.1.3 变更质量   _否_\n+ **是否涉及变更：**\n    - [ ] 是\n    - [x] 否\n+ **变更类型：**\n    - [ ] 代码发布\n    - [ ] 配置变更\n    - [ ] 其他变更：____________\n    - [ ] 不涉及\n+ **变更平台是否接入ChangeFree：**\n    - [ ] 是，CF变更单链接：________\n\n_/*要这样的链接_ [https://aicf.alibaba-inc.com/aicf/change/detail/1725370372](https://aicf.alibaba-inc.com/aicf/change/detail/1725370372) */\n\n    - [ ] 否\n+ **是否违反变更红线**\n    - [ ] 是，违反哪条原则：\n    - [ ] 否\n\n**集团变更红线3.2**** **[链接](https://aliyuque.antfin.com/trecs/fzg6dy/uar1k6)\n\n**盒马研发变更红线**** **[链接](https://aliyuque.antfin.com/hemasre/safety/responsibility)\n\n\n\n**〖关注点1〗****灰度阶段**\n\n+ **是否经过灰度：**\n    - [ ] 是\n    - [ ] 否\n+ **观测了哪些监控**：_可以附链接_\n    - [ ] GOC监控：\n    - [ ] 系统大盘：\n    - [ ] 其他：___________\n+ **是否灰度期间发现问题？**\n    - [ ] 是\n        - [ ] 是否灰度流量过大，导致故障\n        - [ ] 灰度发现但未有效或及时修复，导致故障\n        - [ ] 其他：___________\n    - [ ] 否，后续如何灰度发现？_____________\n+ **未灰度发现原因**\n    - [ ] 应用灰\n        - [ ] 灰度流量太小\n        - [ ] 灰度阶段无监控\n        - [ ] 灰度批次不合理\n        - [ ] 超长时间灰度才能发现\n    - [ ] 业务灰：策略不合理\n    - [ ] 灰度无法发现\n    - [ ] 其他：_____________\n\n**〖问题总结〗**\n\n**〖改进点〗**_**需明确写明不同故障相关方的改进项（若有的话），下同。**_\n\n1、\n\n\n\n**〖关注点2〗****上线阶段**\n\n+ **是否有确定的监控观测指标**\n    - [ ] 是，监控指标及监控链接：\n    - [ ] 否\n+ **是否在窗口期进行发布变更**\n    - [ ] 是\n    - [ ] 否，原因：\n+ **变更是否影响上下游**\n    - [ ] 是，是否有提前知会上下游评估及关注变更\n        - [ ] 有提前知会\n        - [ ] 没有提前知会\n    - [ ] 否\n\n**〖问题总结〗**\n\n**〖改进点〗**_**需明确写明不同故障相关方的改进项（若有的话），下同。**_\n\n1、\n\n### 4.2【处置能力】\n#### 4.2.1 故障发现&响应 _是_\n+ **是否监控发现**\n    - [ ] 故障触发方 监控发现\n    - [ ] 故障受影响方 监控发现\n    - [x] 否，原因为：（监控无效/监控缺失） 监控无效\n+ **是否5分钟内响应**\n    - [x] 是\n    - [ ] 否，原因为：\n+ **是否存在应急协同问题**\n    - [ ] 是\n        - [ ] 应急流程不明确（无流程或者流程不清晰、应急相关角色&职责不明确，缺失一号位等)\n        - [ ] 应急执行不到位（有流程，但未按流程执行，通告发送不及时，响应不及时等）\n    - [x] 否\n\n#### 4.2.2 故障定位&恢复  _不涉及_\n+ **主要恢复方式：**\n    - [ ] 代码发布/回滚\n    - [ ] 配置发布/回滚\n    - [ ] 数据订正\n    - [ ] 机器隔离/重启/扩容\n    - [ ] 配置限流\n    - [ ] 预案降级\n    - [ ] 自动恢复\n    - [x] 其他：自动恢复\n\n## 五、故障Action\n| **序号** | *******Action标题** | *******负责人** | *******计划完成时间** | **验收人** |\n| --- | --- | --- | --- | --- |\n| 1 | 梳理监控预警链路（应用、中间件、业务等），将所有核心页面的监控进到【导购风险预警群】 | 寂帷 | 919 |  |\n| 2 | 确保导购侧核心的转化场景兜底机制的有效性（直达P1/2，升级P1/2）  | 寂帷 |  | 北翎 |\n| 3 | 梳理导购域应用，确保数据库应用级别标签",
    "chunk_order_index": 3,
    "full_doc_id": "doc-dab68d8930fa6d64dc4d1a229af5d2d3"
  },
  "chunk-20228a442f4772596384c4df34245a00": {
    "tokens": 420,
    "content": "业务等），将所有核心页面的监控进到【导购风险预警群】 | 寂帷 | 919 |  |\n| 2 | 确保导购侧核心的转化场景兜底机制的有效性（直达P1/2，升级P1/2）  | 寂帷 |  | 北翎 |\n| 3 | 梳理导购域应用，确保数据库应用级别标签（核心/非核心）和实际对应 | 寂帷 |  |  |\n| 4 | 量化数据清理过程，数据清理过程统一使用DMS任务根据时间定时清理的功能进行清理； | 寂帷 |  |  |\n| 5 | 首页核心楼层监控增加合法性校验，确保监控能正常预警 | 萧泽 | 912 |  |\n| 6 | 针对错误码 “4614” 报错透出，设置监控  [错误码详情链接](https://aliyuque.antfin.com/coronadb/ydgmzl/gepyvxm9xiphkher) | 萧泽 | 919 |  |\n| 7 | 需要建立一套首页兜底强保机制。包含数据合法性校验，兜底有效性校验（对端），数据覆盖率校验等，并且每天输出一次校验 | 酥打、寂帷、萧泽 | 9.14 | 北翎 |\n| 8 | DTS任务纳入管控流程  |  若丰 |  |  |\n\n\n业务侧订阅慢sql限流通知   [@智盛](undefined/zhisheng.cjf)  带回评估\n内部评估核心应用和非核心应用预警的管理方案，增量场景的预警管理，落入标准流程维护。  酥打、兰葩",
    "chunk_order_index": 4,
    "full_doc_id": "doc-dab68d8930fa6d64dc4d1a229af5d2d3"
  },
  "chunk-e2f2c4282c49d48abb7059d4bbd2e3e3": {
    "tokens": 1200,
    "content": "## 一、故障简述\n【P4】2024-08-27 14:28，tpp轻应用出现异常日志数据告警；14:48 客满同学反馈店铺产品分类打开不展示商品，15:09通过回滚恢复，后确定原因为新上线模块异常（8月21日）导致CPU利用率异常升高，8月27日日志修复的迭代切流时CPU利用率再次升高，线程池阻塞，导致服务不可用。故障期间，共93例客诉（已去重），触达P4故障。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/128256406/1725000305371-62b052bd-4ca0-4166-ac64-63267073f7d0.png)![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/128256406/1725000239067-3b353cc0-4dd2-40b8-8d47-43dd86d7d645.png)\n\n## 二、故障过程回顾\n2024-08-27 10:39，[@张发林](undefined/wb-zfl907117)操作TPP应用部署完成 \n\n2024-08-27 11:36，切流完成\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/128256406/1725519569415-0ad92d35-51af-4b02-8c4b-f85aa3ed9c4b.png)\n\n2024-08-27 14:28，tpp轻应用出现异常日志数据告警**【故障发现】**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/128256406/1725347564268-8d045b71-fea0-4047-9b19-c87f5fa6a2ca.png)\n\n2024-08-27 14:30左右，[@雨毅](undefined/lichaoyu.lcy)介入排查 【故障响应】\n2024-08-27 14:48，CPU占用95%，日志显示线程池被打满，所有新任务都被拒绝；同时客满同学开始反馈店铺产品分类打开不展示商品  【初因定位】\n\n2024-08-27 14:52，重启、扩容TPP轻应用机器\n\n2024-08-27 14:53，TPP应用开始回滚切流\n\n2024-08-27 14:54，TPP应用切流回滚完成\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/128256406/1725335587681-133203b7-aa20-4b7c-b595-8631c4202e37.png)\n\n2024-08-27 15:05，反馈客诉100+，触达P4故障**【故障发生】**\n\n2024-08-27 15:07，TPP轻应用重启完成，分批重启，扛不住当前翻倍流量\n\n2024-08-27 15:08，回滚到astore代码至老版模块【由tpp轻应用切换至tide】 【恢复执行】\n\n2024-08-27 15:09，重新分批次刷新老版缓存，线上逐渐恢复正常 【故障恢复】\n\n2024-08-27 15:20，TPP轻应用扩容完成\n\n2024-08-27 15:22，反馈线上恢复 【影响消除】\n\n## 三、故障原因\n### 3.1【背景说明】\n旺铺后端在做迁移升级，各模块由原先的tide应用(groovy)升级至tpp轻应用\n\n+ 08月21日（TPP轻应用上线）：\n    - pc端全部商品模块全部迁移完成（新迁移的模块相比于原先都有改进处理，部分串行调用改为并行调用，新增了线程池）\n    - 此时已经出现CPU利用率不合理升高，而当时未注意此现象。\n    - ![CPU利用率](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/132756375/1724848443167-a6ee2f1e-9ede-4d48-84ee-14c8816cd1b5.png?x-oss-process=image%2Fformat%2Cwebp%2Fresize%2Cw_1500%2Climit_0%2Fresize%2Cw_1500%2Climit_0)\n+ 08月27日（迭代）：\n    - 迭代内容：非业务相关，修复异常日志和接口错误率统计修正。\n    - 具体发布流程为：部署分两批，切流第一次从0%-30%，第二次为30%-60%【此后故障发生】[发布单查看](https://tppnext.alibaba-inc.com/web/v1/lightapp/44113/publish?tab=online)\n\n  主要变更代码：新增抛出异常\n\n```java\nprivate void fillCompanyHeadData(WpDataQueryParam param, Map resultMap) throws Exception {\n        final Long loginUserId = param.getLoginUserId();",
    "chunk_order_index": 0,
    "full_doc_id": "doc-cc1edc94b826d8c0af49e14371cf44c1"
  },
  "chunk-0decf48d2fd7c39c618ac83bd2d59d00": {
    "tokens": 1200,
    "content": "，切流第一次从0%-30%，第二次为30%-60%【此后故障发生】[发布单查看](https://tppnext.alibaba-inc.com/web/v1/lightapp/44113/publish?tab=online)\n\n  主要变更代码：新增抛出异常\n\n```java\nprivate void fillCompanyHeadData(WpDataQueryParam param, Map resultMap) throws Exception {\n        final Long loginUserId = param.getLoginUserId();\n        Map mwParams = new HashMap<>();\n        String memberId = param.getMemberId();\n        mwParams.put(CommonConstant.param_member_id, memberId);\n        mwParams.put(CommonConstant.LOGIN_USER_ID,param.getLoginUserId());\n        mwParams.put(SHI_LI_RANK_INFO, true);\n        CompletableFuture.allOf(\n                        //通用\n                        CompletableFuture.runAsync(() -> headDataService.fillIconDataProcess(resultMap, mwParams), executorService),\n                        //榜单优惠劵\n                        CompletableFuture.runAsync(() -> headDataService.fillRankListProcess(resultMap, loginUserId, memberId), executorService),\n                        //工厂信息\n                        CompletableFuture.runAsync(() -> headDataService.fillFactoryInfoProcess(param, resultMap, mwParams), executorService),\n                        //店铺评价\n                        CompletableFuture.runAsync(() -> headDataService.fillShopCommentProcess(param, resultMap), executorService),\n                        //店铺名片\n                        CompletableFuture.runAsync(() -> headDataService.fillShopCardProcess(param, resultMap), executorService))\n                .join();\n        if(resultMap.get(\"companyName\") == null){\n            throw new Exception(\"公司名称缺失\");\n        }\n    }\n```\n\n### 3.2【一句话原因】\n原先线程池构建和使用，以及打印日志内容过多（序列化对象占用CPU过多）不合理，导致流量稍大时CPU利用率就会变高，27号部署时CPU又有升高情况，进一步导致服务异常。\n\n### 3.3【根因分析】\n+ **8月21日商品模块迁移到TPP应用，代码不合理+日志序列化问题导致CPU异常升高**\n\nTPP轻应用未使用官方线程池，且部分地方使用线程池不合理，导致在发布后特别是12点、15点时流量较高时CPU利用率较高；\n两种线程池区别 [tpp官方线程池文档](https://aliyuque.antfin.com/tppdocs/manual/wpnrtk)\n\n```java\nimport java.util.concurrent.LinkedBlockingQueue;\nimport java.util.concurrent.ThreadPoolExecutor;\nimport java.util.concurrent.TimeUnit;\n\nexecutorService = new ThreadPoolExecutor(coreSize, maximumPoolSize, 2000,\n     TimeUnit.MILLISECONDS, new LinkedBlockingQueue<>(queueCapacity),\n     new ThreadFactoryBuilder().setNameFormat(\"biz-wp-thread-%d\").build(), \n     new ThreadPoolExecutor.AbortPolicy());\n```\n\n```java\n// 参考：https://aliyuque.antfin.com/tppdocs/manual/wpnrtk\nimport com.alibaba.kondyle.protocol.service.async.ThreadPoolFactory;\nimport com.alibaba.kondyle.protocol.service.repo.CommonServiceManager;\n\n\nThreadPoolFactory threadPoolFactory = CommonServiceManager.getThreadPoolFactory();\n// 构建线程池，指定线程名字前缀，core size，max线程数，线程闲置时间，如果任务并发超出最大线程数，会在当前线程执行\nexecutorService = threadPoolFactory.newThreadPoolExecutor(\"biz-wp-thread-%d\",\n                    coreSize, maximumPoolSize, 2000,\n                    TimeUnit.MILLISECONDS, threadPoolFactory.abortPolicy());\n```\n\n下述调用结果运用线程池不合理，原因是genBrandBarInfoDataMap方法本就是运行在线程池的一个任务，而在该方法内部又使用了CompletableFuture.supplyAsync来并行执行其他任务。这样会导致一次请求并发起多次线程池任务，可能会造成线程池压力过大。\n\n```java\nprivate Map genBrandBarInfoDataMap(String memberId, Long userId) {\n    Map> futureMap = new ConcurrentHashMap<>();\n            // 获取用户标签的服务，用于判断是否工厂商家、是否质享家商家\n            futureMap.put(\"tags\", CompletableFuture.supplyAsync(() -> queryTagsByMemberId(memberId), executorService));\n            futureMap.put(\"isAgentMember\", CompletableFuture.supplyAsync(() -> isChtMember(memberId), executorService));\n            futureMap.put(\"brandInfo\", CompletableFuture.supplyAsync(() -> queryMemberRole(userId), executorService));\n            futureMap.put(\"manuFacturer\", CompletableFuture.supplyAsync(() -> findManufactorerModel(memberId), executorService));\n            futureMap.put(\"bsrModel\", CompletableFuture.supplyAsync(() -> getShopBsrData(memberId), executorService));\n            //后续获取各模块值\n}\n```\n\n打印日志时序列化结果时，若对象过大，序列化时间太长，占用CPU过多\n\n```java\n@IntegrationLog(digestLog = false, desc = \"商品搜索\")\npublic SearchReponseParam search(SearchRequestParam searchRequestParam) {\n    if (searchRequestParam == null){\n            return null;\n    }\n    return iWinPortSearchService.getSearchResult(searchRequestParam);\n}\n\n@Around(\"@annotation(com.alibaba.cbu.winport.wireless.common.log.integration.IntegrationLog)\")\npublic Object aroundAdvice(ProceedingJoinPoint proceedingJoinPoint) throws Throwable {\n    // xxxx省略\n    LoggerUtil.info(LOGGER, \"【INTEGRATION】 desc={},class={},method={},success={},rt={}ms,args={},result={}\",\n                StringUtils.isNotBlank(annotation.desc",
    "chunk_order_index": 1,
    "full_doc_id": "doc-cc1edc94b826d8c0af49e14371cf44c1"
  },
  "chunk-36184192b69362c63baeb6b85ce8def4": {
    "tokens": 1200,
    "content": "return null;\n    }\n    return iWinPortSearchService.getSearchResult(searchRequestParam);\n}\n\n@Around(\"@annotation(com.alibaba.cbu.winport.wireless.common.log.integration.IntegrationLog)\")\npublic Object aroundAdvice(ProceedingJoinPoint proceedingJoinPoint) throws Throwable {\n    // xxxx省略\n    LoggerUtil.info(LOGGER, \"【INTEGRATION】 desc={},class={},method={},success={},rt={}ms,args={},result={}\",\n                StringUtils.isNotBlank(annotation.desc()) ? annotation.desc() : className,\n                className, methodName, success ? \"Y\" : \"N\", cost,\n                JSON.toJSONString(getArgsLog(args)),\n                digest ? null : JSON.toJSONString(result));\n}\n```\n\n\u0000![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/132756375/1725452031114-9343e752-b728-432e-a5d3-99404fa26c78.png)\n\n\n\n+ **8月27日部署时CPU抖动+灰度流量太大**\n\nTPP轻应用发布流程\n\n    1. 分为两步骤：部署、切流。具体如下：\n        1. 部署：基线版本和灰度版本部署在同一台机器上。\n        2. 切流：TPP平台将灰度流量切流到灰度版本。\n    2. TPP轻应用部署切流时，CPU利用率会有突刺，经咨询TPP官方同学\n        * 部署会有一些CPU密集性的操作，比如类加载，另外有一些jit优化的事情。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/132756375/1725007602113-b50eeeac-3539-408a-a642-1d907adeacf1.png)\n\n        * 切流会向未接流的新版本代码接入请求，没接过流量的java 代码，不是所有class都会一开始就加载好的，有不少class是用到了才加载，这里会有冷启动现象；切流时也会有类加载的过程，也会拉高CPU\n\n![分两批部署，从7%升高到20%以上](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/132756375/1724817803901-366ed530-d6a1-49af-a6ca-55ab6facde1e.png?x-oss-process=image%2Fformat%2Cwebp%2Fresize%2Cw_1500%2Climit_0)\n\n## 四、关注点分析\n关注点1：21号迁移后CPU就有升高，当时CPU水位到哪里，为什么27号才爆发出来？\n\n21日部署后，高峰时CPU利用率在70%以上，而27日又进行了上线，在切流到30%-60%时CPU抖动升高至不可用。抖动原因见根因处TPP冷启动现象。\n\n\n\n关注点2： 应用的基础监控有配置CPU利用率的告警规则，但是没有触发告警是什么原因？\n\n初步判断是由于单机视角无数据导致无法触发告警。TPP应用对应的pod资源的serverless.io/app-name 和sunfire的app_nema不一致，sunfire数据采集失败。目前临时解决方案是协调TPP的同学帮忙在应用上加一段配置即可。[link](https://aliyuque.antfin.com/bx5106/gvmtiw/bz54k5brauq6g0u0)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/128256406/1725522657390-2bd29fdc-9176-4dc5-8fd2-854710dbf480.png)![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/128256406/1725330323511-858b0163-3577-4f54-a8e9-926630d3c508.png)![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/128256406/1725328726294-8e3546c4-a118-42b9-9173-d4d0dba9e4e6.png)\n\nAction：TPP轻应用告警检查    初耀，验收人：定果\n\n\n\n关注点3：灰度过程中是否有停下来观察过基础监控的各项指标是否正常？\n\n有观察接口错误率、异常日志等指标，这一部分正常；未细致观察CPU变化。\n\n\n\n关注点4：TPP应用扩容花了28分钟（14:52-15:20），过程中是有遇到什么问题吗？\n\n扩容时发现机器资源不够，花了一点时间协调资源\n\nAction：FC资源迁移腾挪，为TPP轻应用做资源补充    初耀   带回讨论 \n\n### 4.1【系统质量】\n#### 4.1.1 需求&设计评估  _不涉及_\n**〖关注点1〗****是否涉及产品、技术方案评估？此核心的问题是什么，如何改进？**\n\n- [ ] **是，涉及**\n    - [ ] 需求评估遗漏\n    - [ ] 产品设计缺陷\n    - [ ] 系统架构设计缺陷\n        - [ ] 容错性不足 \n        - [ ]",
    "chunk_order_index": 2,
    "full_doc_id": "doc-cc1edc94b826d8c0af49e14371cf44c1"
  },
  "chunk-e397d55ed39a841e4fafb09c28ecea1f": {
    "tokens": 1200,
    "content": "质量】\n#### 4.1.1 需求&设计评估  _不涉及_\n**〖关注点1〗****是否涉及产品、技术方案评估？此核心的问题是什么，如何改进？**\n\n- [ ] **是，涉及**\n    - [ ] 需求评估遗漏\n    - [ ] 产品设计缺陷\n    - [ ] 系统架构设计缺陷\n        - [ ] 容错性不足 \n        - [ ] 单点，无冗余\n        - [ ] 缺乏自我保护\n        - [ ] 缓存设计不当\n        - [ ] 容量评估不足\n        - [ ] 非幂等设计\n        - [ ] 强弱依赖不合理\n        - [ ] 其他：__________\n- [ ] 否，不涉及\n\n#### 4.1.2 代码质量  _是_\n**〖关注点1〗是否代码自身存在漏洞或BUG、代码健壮性是否存在问题等?**\n\n**〖问题分析〗**运用线程池不合理，genBrandBarInfoDataMap方法本就是运行在线程池的一个任务，而在该方法内部又使用了CompletableFuture.supplyAsync来并行执行其他任务。这样会导致一次请求并发起多次线程池任务，可能会造成线程池压力过大。\n\n**〖改进点〗**_****_\n\n1、避免线程池滥用\n\n2、线程池任务设置合理超时时间\n\n**〖关注点2〗****是否经过CodeReview？CodeReview阶段是否发现问题？为何没发现？**\n\n+ **是否经过CR**\n    - [x] 是\n    - [ ] 否\n    - [ ] 不涉及\n+ **是否设置合理的CR卡点**\n    - [x] 是\n    - [ ] 否\n    - [ ] 不涉及\n+ **CodeReview阶段是否发现问题？为何没发现？后续如何发现？**\n    - [ ] 是\n    - [x] 否\n    - [ ] 不涉及\n\n**〖改进点〗**_****_\n\n1、设计到线程池等影响性能的指标应重点关注\n\n**〖关注点3〗****测试阶段**\n\n+ **测试内容：**涉及的测试提交单、测试用例等\n+ **测试人员：**\n+ **是否经过测试验证**\n    - [x] 是，验证环境\n        - [x] 预发环境\n        - [ ] 日常环境\n    - [x] 是，测试方法\n        - [x] 单元测试\n        - [x] 功能回归测试\n        - [ ] 集成测试/链路测试\n        - [x] 验收测试\n    - [ ] 否\n    - [ ] 不涉及\n+ **测试未发现原因是什么？后续如何改进？**\n    - [ ] 回归测试遗漏\n        - [ ] 手工回归测试用例遗漏\n        - [ ] 自动化未建设\n        - [ ] 自动化回归覆盖不足\n        - [ ] 其他：__________\n    - [ ] 新场景测试遗漏\n        - [ ] 功能测试用例遗漏，包括正常分支和异常分支\n        - [ ] 容灾兜底测试遗漏\n        - [ ] 客户端兼容性测试遗漏\n        - [ ] 埋点测试遗漏\n        - [x] 性能测试遗漏，影响评估不足\n        - [ ] 安全测试遗漏\n    - [ ] 其他：__________\n\n#### 4.1.3 变更质量  _ 是_\n+ **是否涉及变更：**\n    - [x] 是\n    - [ ] 否\n+ **变更类型：**\n    - [x] 代码发布\n    - [ ] 配置变更\n    - [ ] 其他变更：____________\n    - [ ] 不涉及\n+ **变更平台是否接入ChangeFree：**\n    - [ ] 是，CF变更单链接：________\n    - [x] 否\n+ **是集团变更红线3.2**** **[**链接**](https://aliyuque.antfin.com/trecs/fzg6dy/uar1k6)\n    - [ ] 是，违反哪条原则：\n    - [x] 否\n\n\n\n**〖关注点1〗****灰度阶段**\n\n+ **是否经过灰度：**\n    - [x] 是\n    - [ ] 否\n+ **观测了哪些监控**：_可以附链接_\n    - [ ] GOC监控：\n    - [x] 系统大盘：[模块数据-旺铺数据站点 (alibaba-inc.com)](https://fbi.alibaba-inc.com/fbi/site/page.htm?id=51364&menuId=r2dsov20j3g)\n    - [ ] 其他：___________\n+ **是否灰度期间发现问题？**\n    - [x] 是\n        - [x] 是否灰度流量过大，导致故障\n        - [ ] 灰度发现但未有效或及时修复，导致故障\n        - [ ] 其他：___________\n    - [ ] 否，后续如何灰度发现？_____________\n\n**〖改进点〗**_****_\n\n1、灰度时切流幅度过大，未来在部署切流时，每次10%，保证影响达到最小\n\n2、发布时关注指标太少，应该仔细观察CPU、内存",
    "chunk_order_index": 3,
    "full_doc_id": "doc-cc1edc94b826d8c0af49e14371cf44c1"
  },
  "chunk-2d97da38d7c375cef1a48ed6487cadd3": {
    "tokens": 636,
    "content": "[ ] 灰度发现但未有效或及时修复，导致故障\n        - [ ] 其他：___________\n    - [ ] 否，后续如何灰度发现？_____________\n\n**〖改进点〗**_****_\n\n1、灰度时切流幅度过大，未来在部署切流时，每次10%，保证影响达到最小\n\n2、发布时关注指标太少，应该仔细观察CPU、内存、错误率等基础和业务指标。\n\n**〖关注点2〗****上线阶段**\n\n+ **是否有确定的监控观测指标**\n    - [x] 是，监控指标及监控链接：\n    - [ ] 否\n+ **是否在窗口期进行发布变更**\n    - [x] 是\n    - [ ] 否，原因：\n+ **变更是否影响上下游**\n    - [ ] 是，是否有提前知会上下游评估及关注变更\n        - [ ] 有提前知会\n        - [ ] 没有提前知会\n    - [x] 否\n\n### 4.2【处置能力】\n#### 4.2.1 故障发现&响应\n+ **是否监控发现**\n    - [x] 故障触发方 监控发现\n    - [ ] 故障受影响方 监控发现\n    - [ ] 否，原因为：（监控无效/监控缺失）\n+ **是否5分钟内响应**\n    - [x] 是\n    - [ ] 否，原因为：\n+ **是否存在应急协同问题**\n    - [ ] 是\n        - [ ] 应急流程不明确（无流程或者流程不清晰、应急相关角色&职责不明确，缺失一号位等)\n        - [ ] 应急执行不到位（有流程，但未按流程执行，通告发送不及时，响应不及时等）\n    - [x] 否\n\n#### 4.2.2 故障定位&恢复\n+ **主要恢复方式：**\n    - [x] 代码发布/回滚\n    - [ ] 配置发布/回滚\n    - [ ] 数据订正\n    - [x] 机器隔离/重启/扩容\n    - [ ] 配置限流\n    - [ ] 预案降级\n    - [ ] 自动恢复\n    - [ ] 其他：\n\n## 五、故障Action\n| **序号** | *******Action标题** | *******负责人** | *******计划完成时间** | **验收人** |\n| --- | --- | --- | --- | --- |\n| 1 | TPP轻应用告警检查    |  初耀 |  | 定果 |\n\n\nAction：营销侧对FC资源迁移腾挪，释放资源为TPP轻应用做资源补充    初耀   带回讨论",
    "chunk_order_index": 4,
    "full_doc_id": "doc-cc1edc94b826d8c0af49e14371cf44c1"
  },
  "chunk-74f7dcca3ea052219979d3904f903712": {
    "tokens": 1200,
    "content": "## 【故障过程回顾】\n【故障发现】\n2024-09-04 08:46，触发GOC风险预警，GOC监控同学接入。\n【业务响应】\n\n2024-09-04 08:46，igraph [@时峰](undefined/huangsixiang.hsx)介入处理\n\n【故障定位】\n2024-09-04 08:48，初步判断表 TPP_qyq_sex_age_temtrans_query_statistic_igraph 流量暴涨导致星座水位被打爆，考虑扩容恢复，发起对应星座的扩容工单，并尝试进一步分析原因。\n【故障发生】\n2024-09-04 08:49，iGraph_主体星座延迟异常，耗时最近10分钟最小值大于等于20ms，已达到P5故障。\n2024-09-04 08:50,  定位到大概是因为资源评估不准确的原因，导致 orb 自动化运维的时候，认为目标星座能够扛住表的流量而发起迁移。并且迁移工单在 2024-09-04 08:48 在原星座完成部署删除， 已经无法快速回滚。\n【恢复执行】\n2024-09-04 08:52， 发起表迁移回滚操作，尝试将表倒流回原星座，分摊目标星座的压力。\n2024-09-04 08:57， 判断迁移速度较慢，尝试联系用户进行表降级。\n2024-09-04 09:13， 扩容机器开始逐步渐进预热。\n2024-09-04 09:20，扩容机器逐步预热完毕，逐渐接流，缓解线上。\n2024-09-04 09:21， 表业务执行降级操作。\n【故障恢复】2024-09-04 09:26，抖动完全恢复\n2024-09-04 10:02， 表业务恢复降级\n2024-09-04 10:03， 最终原因定位： 表因为表数据均衡发起迁移，因为cache命中率很高，资源使用量评估不准，加上刚接流的时候缓存击穿，导致星座水位被打爆，引发线上rt抖动。\n\n## 【故障原因】\n### 【背景说明】\n背景：1. 倚天平台上期望支持topdown level2指标的采集；2.期望在倚天上支持内存延时指标的输出。[https://aone.alibaba-inc.com/v2/project/2015952/req/54471207](https://aone.alibaba-inc.com/v2/project/2015952/req/54471207)\n\n[https://aone.alibaba-inc.com/v2/project/2015952/req/57562642](https://aone.alibaba-inc.com/v2/project/2015952/req/57562642)\n\n### 3.2【原因分析】\n### 【一句话原因】\n表因为表数据均衡发起迁移，但由于cache命中率很高，资源使用量评估不准，加上刚接流的时候缓存击穿，导致星座水位被打爆，引发线上rt抖动。\n\n### 【背景说明】\n1. 表迁移的背景是 igraph 表与星座越来越多，并且每一张的状态可能会发生查询成分与流量的变化，表在每一个时期适合存放的星座不是一成不变的，同时如果表能自动部署在最优部署星座，就能有效的降低 igraph 运维成本 和 资源成本， 还可能提供更低 rt 和稳定性。 因此，引入了 orb 的表自动流转机制，能够自动评估各个表的资源使用情况与各个星座之间的资源余量，进行表自动迁移到最优部署星座。\n2. 迁移流程背景，发起迁移工单以后，管控会先进行 【表添加迁入星座的部署】【等待迁入星座切换完成，迁移完成时两个星座同时对这张表进行接流】【删除迁出星座的部署】【等待迁出星座删除部署，删除完成即任务完成】\n\n### 【根因分析】\norb（自动化运维工具）触发表迁移操作的时候，对于Cache命中率高的表，占用资源情况估值不准确，发起了错误的迁移决策。 \n\n并且当时 kmonitor 指标获取失败，导致后续决策扩容失败，在星座水位报警的时候没有触发自动扩容。\n\n## 【核心关注点】\n##### 【关注点1】 表迁移的背景是什么呢，或者说ORB在什么条件触发表迁移，对目标表资源评估是如何评估的，为什么会出现评估不准的情况，后续有什么改进？\n[原因分析〕表迁移的背景是 igraph 表与星座越来越多，并且每一张的状态可能会发生查询成分与流量的变化，表在每一个时期适合存放的星座不是一成不变的，同时如果表能自动部署在最优部署星座，就能有效的降低 igraph 运维成本 和 资源成本， 还可能提供更低 rt 和稳定性。 因此，引入了 orb 的表自动流转机制，能够自动",
    "chunk_order_index": 0,
    "full_doc_id": "doc-3dae525e308c6f988ff30025857954e5"
  },
  "chunk-ce853f59ed9768a6c9417a66231db544": {
    "tokens": 1200,
    "content": "是 igraph 表与星座越来越多，并且每一张的状态可能会发生查询成分与流量的变化，表在每一个时期适合存放的星座不是一成不变的，同时如果表能自动部署在最优部署星座，就能有效的降低 igraph 运维成本 和 资源成本， 还可能提供更低 rt 和稳定性。 因此，引入了 orb 的表自动流转机制，能够自动评估各个表的资源使用情况与各个星座之间的资源余量，进行表自动迁移到最优部署星座。\n当日上午由 cons_209_pangu 触发了表部署数量过多的报警，由 orb 自动判定需要从 cons_209_pangu 迁移到 cons_200_pangu， 均衡每个星座的表数量时。 通过对比 cpu负载的计算公式 $ \\frac{qps(迁出表) \\times rt(迁出表)}{\\sum_{表}^{星座}{(qps(表) \\times rt(表))}} \\times 迁出星座实际负载 \\le 迁入星座剩余负载 - 0.1 \\times 迁入星座规格 $\n\n使用上述公式的时候评估 cons_200_pangu 是足够放下，但由于迁出表 TPP_qyq_sex_age_temtrans_query_statistic_igraph 缓存命中率较高 （>75 %）， 导致其计算资源占比的时候出现了严重低估，并加上刚接流的时候缓存击穿的问题，最终导致 cons_200_pangu 水位被打爆。\nACTION:  orb 会完善迁移流程，设计更加安全可靠的自动化迁移流程，保证表迁移流程能够做更平稳。\n\n【关注点2】 “迁移工单在 2024-09-04 08:48 在原星座完成部署删除，已经无法快速回滚”，目前迁移的流程是怎样的，在迁移新表的过程中，是否可以在迁移后观察一段时间再删除原星座部署？\n[原因分析〕迁移流程背景，发起迁移工单以后，管控会先进行 【表添加迁入星座的部署】【等待迁入星座切换完成，迁移完成时两个星座同时对这张表进行接流】【删除迁出星座的部署】【等待迁出星座删除部署，删除完成即任务完成】\n当日上午  2024-09-04 08:48  迁移工单已经走完， 其在 cons_209_pangu 的部署已经被删除，不具备立刻回滚的调教，此时回滚操作只能重新添加回 cons_209_pangu 的部署或者再发起一次反向迁移的流程。\nACTION:  orb 后续改进的方案会在删除部署前加入一个观察判断的流程，用以保证发现迁入星座无法承接迁入表的流量时可以快速回滚。\n\n【关注点3】 自动运维工具做开始表迁移的时间点是什么时候，迁移时间是否可以安排在工作时间，以便能够及时发现处置？\n[原因分析〕orb为24小时无间断的运行，本次表迁移任务是由表部署报警触发的，并不能保证报警触发时，一定处于工作时间。其次，表流转的任务较重，单个任务周期较长，仅在工作时间处理不了那么多的均衡任务。\nACTION: 优化表迁移流程的安全性。\n【关注点4】 “联系用户进行表降级”，用户降级是有损的吗？表降级后是否能马上恢复？故障恢复的有效方式最终是扩容还是降级？\n[原因分析〕可能是有损的，但用户同意降级，说明损失能够承受或者由其他兜底策略。表降级的发布是在 2024-09-04 09:21 客户端发布配置，发布后，cons_200_pangu 的 其中13列rt恢复到正常水平，仍有3列 rt较高， 在后续逐渐扩容与降级配置逐步生效的过程中逐步恢复。 在发生故障的时候，如果也无妨能够接受的话，对影响来源表执行降级操作可以加速恢复线上（最极限的办法是直接摘流，可以立刻恢复线上），但是是否能够降级必须由业务评估。\nACTION: 服务端下次遇到类似的情况，可以先沟通用户是否允许降级，然后在igraph侧直接发布降级配置，加速降级的生效速度，即使止损。并上线紧急扩容与紧急切换的功能，加快扩容速度和迁移速度，减少影响时间。\n\n【关注点5】  “kmonitor 指标获取失败，导致后续决策扩容失败，在星座水位报警的时候没有触发自动扩容”， kmonitor 指标获取失败的原因是什么，自动扩容依赖此报警的话，如何保障报警的可靠性？\n[原因分析〕kmonitor的指标因为服务压力较大资源不足，导致对应时刻 orb 请求 kmonitor 超时， 无法获取到 报警星座的详细水位信息，导致无法计算需要扩的资源量而无法触发自动扩容。\nACTION: kmon给igraph新建出来一个独立的token，保障资源使用量\n\n \n\n\n\n## 【故障Action】\n短期：添加紧急迁移任务与紧",
    "chunk_order_index": 1,
    "full_doc_id": "doc-3dae525e308c6f988ff30025857954e5"
  },
  "chunk-7d19143ca0f4f1ab18d4d399812e1fae": {
    "tokens": 156,
    "content": "的可靠性？\n[原因分析〕kmonitor的指标因为服务压力较大资源不足，导致对应时刻 orb 请求 kmonitor 超时， 无法获取到 报警星座的详细水位信息，导致无法计算需要扩的资源量而无法触发自动扩容。\nACTION: kmon给igraph新建出来一个独立的token，保障资源使用量\n\n \n\n\n\n## 【故障Action】\n短期：添加紧急迁移任务与紧急扩容任务，加快迁移和扩容速度\n\n短期：kmonitor给igraph新建出来一个独立的token，保障资源使用量。\n\n长期：orb优化迁移流程，例如增加回滚观测，保证迁移的安全性。\n\n\n\n##",
    "chunk_order_index": 2,
    "full_doc_id": "doc-3dae525e308c6f988ff30025857954e5"
  },
  "chunk-c1d74845cd59ecb6b9ce7dea409ee7d1": {
    "tokens": 1200,
    "content": "## 一、故障简述\n08-31 00:27开始，天猫国际_同意退款成功率最近5分钟最大值小于90%，触达P4故障，初步确认为数据库升配连接异常导致，通过手动更新配置后，00:56故障止血。\n\n## 二、故障过程回顾\n| **时间轴** | **事件** |\n| --- | --- |\n| 2024-08-30 14:05 | 桃熙同各数据库owner进行申配事宜沟通，评估风险![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/270963/1725352716424-ec59a616-0ce4-4036-af41-47e1780f230e.png?x-oss-process=image%2Fformat%2Cwebp%2Fresize%2Cw_1500%2Climit_0) |\n| 2024-08-31 00:16 | 桃熙在dbservice上发起rp_buyers_app的cn-shanghai集群升配![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/270963/1725352769624-8e84c7b0-f0ad-474e-a98b-cda57a54fef8.png) |\n| 2024-08-31 00:22 | 备库完成升配，但是由于元数据不正确，**注册新备库节点信息失败**。同时该异常触发电话告警，但是DB同学未能注意到告警信息 |\n| 2024-08-31 00:23 | 数据库实例发生主备切换，但是无法切换tddl权重到新节点上 |\n| 2024-08-31 00:31 | **【故障发现】**风险预警，监控值班拉起应急       ![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/12771/1725355477467-68ae0e1c-6677-494e-84f1-cee482a0a163.png) |\n| 2024-08-31 00:31 | **【故障发生】**成功率低于90%持续5min，触达故障标准![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/12771/1725355083769-8b0549bb-30f7-45ba-8674-254d2ee24e7b.png) |\n| 2024-08-31 00:34 | **【故障响应】**国际技术传洪接手排查 |\n| 2024-08-31 00:39 | 淘天业务侧联系到辰宿，告知升配异常导致业务受损，辰宿上线处理 |\n| 2024-08-31 00:44 | 阿里云辰宿发现0000号库主备dbkey信息不对，无法通过切换权重来恢复业务，于是通知DB侧清蓝处理；同时业务侧陆续反馈访问其他分库报错，辰宿通过任务流检查确认其他分库变配正常，属于预期内切换报错 |\n| 2024-08-31 00:45 | 交易霖方入、数据库智盛入群排查问题 |\n| 2024-08-31 00:54 | 爱橙许恺非标的方式更新了南通单元unsh dbkey映射的ip port信息，此时业务访问0000号库的报错恢复，0000号库的DRC处于中断状态。 |\n| 2024-08-31 00:57 | **【故障恢复】**业务恢复  |\n| 2024-08-31 02:36 | 云侧在南通DRC环境修复0000号库dbkey，恢复0000号库的单元化同步。 |\n| 2024-08-31 02:37-02:47  | 云侧完成南通其他各个单元 非标dbkey的修复。 |\n\n\n## 三、故障原因\n### 3.1【变更背景】\n:::tips\n由于双11大促，部分数据库需要提升配置；计划cn-shanghai集群在8月31日凌晨升配到双11配置。\n\n:::\n\n### 3.2【原因分析】\n#### 一句话原因：\n:::tips\n南通rp_buyers_0000号库的**数据库实例信息元数据错误**，**升配过程中注册新备库节点到tddl失败，导致数据库主备切换后无法正常切换tddl权重。**\n\n:::\n\n#### 详细原因：\n:::tips\n**数据错误原因：**之前做管控数据切换的时候引入，当前已经做了数据的矫正，大约15条数据；\n\n**实例升配会经历以下几个阶段：**\n\n1. 业务下发任务后，在指定时间发起升配任务流\n2. 管控任务流先升配备库，完成后通知dbservice更新tddl中的备库信息，注册新备库的dbkey和ip port\n3. 管控任务发起数据库内核主备切换，通知dbservice更新tddl权重，将流量切换到新备库上\n4. 管控任务升级旧主库，并通知dbservice更新",
    "chunk_order_index": 0,
    "full_doc_id": "doc-c700d0f061c8176753cd72866f46b9a1"
  },
  "chunk-b54f1a6261d21c0059274ab9c41887da": {
    "tokens": 1200,
    "content": "业务下发任务后，在指定时间发起升配任务流\n2. 管控任务流先升配备库，完成后通知dbservice更新tddl中的备库信息，注册新备库的dbkey和ip port\n3. 管控任务发起数据库内核主备切换，通知dbservice更新tddl权重，将流量切换到新备库上\n4. 管控任务升级旧主库，并通知dbservice更新tddl的信息\n\n**本次的问题出现在环节2中注册新备库信息这个步骤。详细过程如下：**\n\n1. dbservice任务流需要从表physical_mysql_dbinstance_info中捞取当前实例id对应的appname\n2. 根据旧备库的ip port以及i.中获取的appname从dtools元数据库中获取当前需要替换的dbkey信息，但是由于0000号库的实例在physical_mysql_dbinstance_info的appname是错误的，导致这一步从dtool元数据中读取到的数据为空，添加新备库操作失败\n\n由于新备库未能正常注册到tddl中，在数据库内核切换之后，tddl权重无法切换到新备库上，导致业务访问数据库失败。\n\n同时，管控实例升配任务流继续执行完成了步骤d，但是由于同样的原因，新节点信息也未能正常注册到tddl中，所以最终tddl主备节点信息和数据库实际主备节点信息不一致，无法通过切换tddl权重的方式来让业务恢复。\n\n:::\n\n#### 故障关注点：\n:::tips\n**1、如何主动发现此类元数据错误问题**\n\n**    **后续将在编配任务流增加校验环节，确保数据准确性。\n\n**2、升配各相关方的协作过程是怎样的？**\n\n    业务这边提交单子，需要数据库同学配合完成，当天也是同学DB同学一起操作。\n\n**3、后续业务如何判断申配是否已经成功？**\n\n    建议依据业务自身表现进行判断，有成量的监控很容易发现异常。\n\n**4、申配操作通知范围是否可以告知业务方**\n\n     主要依赖数据Owner，数据库申配是一个风险较低的操作；后续此类大促级别的操作，需要拉库OWNER、DBA、数据库等相关同学一起。\n\n:::\n\n## 四、常规检查项\n### 4.1【系统质量】 _--不涉及_\n#### 4.1.1 需求&设计评估    _--不涉及_\n#### 4.1.2 代码质量   _--不涉及_\n#### 4.1.3 变更质量   _--不涉及_\n### 4.2【处置能力】 \n#### 4.2.1 故障发现&响应\n+ **是否监控发现**\n    - [ ] 故障触发方 监控发现\n    - [x] 故障受影响方 监控发现\n\n        **国际、交易、猫超均有监控发现。**\n\n** **国际：\n\n       ![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/12771/1725355083769-8b0549bb-30f7-45ba-8674-254d2ee24e7b.png)\n\n        猫超：\n\n     ![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/12771/1725356204555-da4aff7e-d7b3-4d17-9feb-8b0116aa2012.png)\n\n      交易大盘：\n\n    ![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/12771/1725418545674-5ee008ef-586a-444e-a8f8-d9b14e9d982f.png)\n\n \n\n    - [ ] 否，原因为：（监控无效/监控缺失）\n+ **是否5分钟内响应**\n    - [x] 是\n    - [ ] 否，原因为：\n+ **是否存在应急协同问题**\n    - [ ] 是\n        - [ ] 应急流程不明确（无流程或者流程不清晰、应急相关角色&职责不明确，缺失一号位等)\n        - [ ] 应急执行不到位（有流程，但未按流程执行，通告发送不及时，响应不及时等）\n    - [x] 否\n\n#### 4.2.2 故障定位&恢复\n+ **主要恢复方式：**\n    - [ ] 代码发布/回滚\n    - [ ] 配置发布/回滚\n    - [ ] 数据订正\n    - [ ] 机器隔离/重启/扩容\n    - [ ] 配置限流\n    - [ ] 预案降级\n    - [ ] 自动恢复\n    - [x] 其他：错误数据\n+ **是否10分钟内恢复**_/* P1P2故障填写*/_\n    - [ ] 是\n    - [x] 否，原因：__________\n\n\n\n**〖关注点2〗业务自身是否具备容灾逃逸能力？后续如何改进？**_/* 如涉及基础设施引发的故障，可填写*/_\n\n- [ ] 具备容灾能力\n    - [ ] 因未演练不敢执行\n    - [ ] 因有",
    "chunk_order_index": 1,
    "full_doc_id": "doc-c700d0f061c8176753cd72866f46b9a1"
  },
  "chunk-36b295b3d5e80f7dbcf8d39ba95a155f": {
    "tokens": 916,
    "content": "_/* P1P2故障填写*/_\n    - [ ] 是\n    - [x] 否，原因：__________\n\n\n\n**〖关注点2〗业务自身是否具备容灾逃逸能力？后续如何改进？**_/* 如涉及基础设施引发的故障，可填写*/_\n\n- [ ] 具备容灾能力\n    - [ ] 因未演练不敢执行\n    - [ ] 因有损评估决策不执行\n    - [ ] 无决策或者决策不当，未执行\n- [x] 不具备容灾能力\n\n#### 5.2.3 SRE应急参与（淘天业务技术参考）\n+ **SRE工程师应急参与**：__\n    - 是否响应\n        - [x] 是\n        - [ ] 否\n    - 是否帮助定位\n        - [x] 是\n        - [ ] 否，备注：__________\n        - [ ] 未参与，备注：__________\n    - 是否操作恢复/提出有效恢复方案\n        - [x] 是\n        - [ ] 否，备注：__________\n        - [ ] 未参与，备注：__________\n+ **SRE专家是否有效指挥**\n        - [x] 是\n        - [ ] 否，备注：__________\n        - [ ] 未参与，备注：__________\n\n\n\n## 六、故障Action\n| **序号** | *******Action** | *******负责人** | *******计划完成时间** | **验收标准** | **是否keyAction** | **是否回血Action** |\n| --- | --- | --- | --- | --- | --- | --- |\n| 1 | 短期：历史错误数据的矫正 | 辰宿 | 已完成 | 历史错误数据矫正完成 | 否 | 否 |\n| 2 | 长期：变更过程校验卡点 | 辰宿 | 12.31 | 卡口功能完成 | 否 | 否 |\n| 3 | 长期：管控任务流 | 辰宿 | 12.31日 | 实现任务流管控 | 否 | 否 |\n\n\n## 七、影响产品线&影响面\n| **受影响业务** | **等级** | **影响说明** |\n| --- | --- | --- |\n| 天猫国际 | P4 | - [x] 业务影响：00:27开始，天猫国际最大值持续小于90%，最低下跌至61%，00:56恢复。持续约29MIN。触达P4。![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/12771/1725355083769-8b0549bb-30f7-45ba-8674-254d2ee24e7b.png) ![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/12771/1725355185006-6ec0e87a-ae3e-40e8-8a28-4d2a1d8a1fb4.png)      ![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/12771/1725354790724-91734ea5-c470-4826-bdcb-3286b97dc83f.png) |\n| 猫超 | 未到故障 | ![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/12771/1725356204555-da4aff7e-d7b3-4d17-9feb-8b0116aa2012.png) |\n| 交易 | 未到故障 | - [x] 业务影响：指标有波动未触达故障  ![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/12771/1725418545674-5ee008ef-586a-444e-a8f8-d9b14e9d982f.png?x-oss-process=image%2Fformat%2Cwebp%2Fresize%2Cw_672%2Climit_0) |",
    "chunk_order_index": 2,
    "full_doc_id": "doc-c700d0f061c8176753cd72866f46b9a1"
  },
  "chunk-e030d1f4350b043c9a35df28cec8811c": {
    "tokens": 1200,
    "content": "## 一、故障简述\n2024-08-31 03:39开始 用户批量反馈购物车顺序异常，通过RDB备份数据重建新v2_copy集群并切流到v2_copy集群、线上机器重启后故障于10:53分止血。期间客诉去重后848+，触发P2故障级别。\n\n## 二、故障过程回顾\n### 2.1核心时间点\n#### 故障发生前\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/12771/1725588276809-2f6ee3c4-1675-4804-be0c-3d0ccb41f1e4.png)\n\n#### 故障发生时\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/12771/1725588345806-898b3352-5b77-429c-8ec6-d812a940ddd8.png)\n\n### 2.2详细时间点\n时间主线爱橙科技阿里云\n\n| **时间轴** | **事件** |\n| --- | --- |\n| 2024-02-20 18:08 | 业务方(淘系购物车)同学，从诺曼底创建由 r-uf65c5b6933acb74 到 r-uf650b993d601e14 的DTS同步任务，DTS任务id：dtsa91r245520g46j8，通过DTS逻辑迁移，做Redis的版本升级，并启动DTS任务 |\n| 2024-03-21 14:00 | 业务开始切流10%->50%->100%，之后老的Redis集群(r-uf65c5b6933acb74)无业务流量 |\n| 2024-03-28 | 业务对老集群依赖代码下线 |\n| 2024-04-10 | 淘特、mmc等长尾流量清明后确认移除，老集群流量清零+代码逻辑完全下线，从此往后，老集群已经没有业务流量，**业务切流完成 （此时应立即结束 DTS，如果为可回切，可建立反向 DTS）** |\n| 2024-05-29 22:41 | DTS发布新功能，此功能支持Redis秒级守护，标记目标端连接串的规则，由IP+PORT改为DBRole(master/slave)+IP+PORT，增加了DB角色信息，重启会触发全量+增量同步 |\n| 2024-06-03 15:43 | 通过诺曼底的审计日志查询，此时为业务方同学在故障发生前，最后一次登录诺曼底查看该DTS任务，此刻DTS任务在诺曼底的状态显示为正常 |\n| 2024-06-04 11:40 | cc因Config错误同步，在cc控制台页面展示DTS任务状态为“已销毁” |\n| 2024-06-04 20:52 | Config将DTS任务信息，重新正常同步给了cc |\n| 2024-06-13 | 用户登录CC控制台（非查看实例）![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/12771/1725589132590-9bfea176-e6f1-4efe-8dd6-8a3a34874126.png) |\n| 2024-08-31 03:29 | 故障发现** **故障发生VOC风险预警：购物车无法加购      ![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/12771/1725078808474-94230e8c-d4c5-4950-ad9c-cbbde08e73bc.png?x-oss-process=image%2Fformat%2Cwebp%2Fresize%2Cw_676%2Climit_0) |\n| 2024-08-31 03:32 | GOC启动应急 业务响应GOC值班拉值班魏直、远若等同学开始进群 |\n| 2024-08-31 03:45 | GOC值班反馈目前共找到 28 条客户原声（其中在线人工 28 条），已经达到p4。【**尚未启动故障应急**】 |\n| 2024-08-31 03:48 | 远若初步查看业务&系统监控大盘，未见明显系统异常；同时发起视频会议，拉石碌、浔枫、莽晨等业务开发同学排查；明确carts2有紧急发布但只发到spe环境，有预期内的数据库升配；初步判断和这两个变更没有关系 |\n| 2024-08-31 03:59  | 通过逐条查看原声明细，魏直明确问题是购物车顺序异常，非无法加购或购物车商品被删除，远若定位到 rdb对比监控报错量突增（这个报错是个业务实时监控，看线上请求中从rdb结构数据里的cartId和mysql商品数据cartId对应不上的qps实时量级，后台没有建设全量校验的能力）![](https://intranetproxy.alipay.com/skyl",
    "chunk_order_index": 0,
    "full_doc_id": "doc-aa51c86860e1eaf80a916c67edf0b3bc"
  },
  "chunk-f6024abddb395edb2ed00655e1d4f3fb": {
    "tokens": 1200,
    "content": "原声明细，魏直明确问题是购物车顺序异常，非无法加购或购物车商品被删除，远若定位到 rdb对比监控报错量突增（这个报错是个业务实时监控，看线上请求中从rdb结构数据里的cartId和mysql商品数据cartId对应不上的qps实时量级，后台没有建设全量校验的能力）![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/12771/1725079375721-6111ee24-7f26-4e19-a09b-9f213453f4ae.png?x-oss-process=image%2Fformat%2Cwebp%2Fresize%2Cw_1168%2Climit_0) |\n| 2024-08-31 04:09  | 远若看到有redis实例故障切换通知，且时间点和出现问题的时间点高度吻合，且rdb实例吻合，正是存储购物车结构数据的rdb，怀疑和RDB的故障切换相关![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/142490/1725080092690-228f37ec-c895-4bb0-816d-d1cd43d409cc.png) |\n| 2024-08-31 04:11  | 石碌确认报错用户张北和南通都有，没有单元聚集性 |\n| 2024-08-31 04:19  | 云侧应急远若拉redis楚玉进行排查，楚玉反馈故障切换只会有分片级别的秒级闪断，不会有持续性异常，且浔枫应证redis运维闪断不会有持续异常，暂时推测不是redis可用性问题后续查询南通集群24年共发生过三次闪断：2024-3-4  02:01:072024-5-24 04:00:072024-8-31 03:10:09 |\n| 2024-08-31 04:29  | 浔枫怀疑是由于**rdb结构数据读串了**（rdb结构数据中的cartid在当前的用户购物车mysql商品记录行中并不存在，此时大家怀疑cartid是属于别的用户，实际原因是因为结构里cartid是4个月前的历史数据，在当前数据中查不到）。浔枫反馈是否要切回到店铺模式，但是由于根据监控线上数据不一致请求非影响全部用户，且切回到店铺模式会导致分组功能不可用，会有大规模的舆情，所以此时决策先不切到店铺模式。 后续7点降级后大量舆情反馈分组功能不可用印证。 |\n| 2024-08-31 04:44  | 技术反馈之前bbq和购物车也有类似的场景，通过重启恢复，广陌决策全量重启carts2机器> 魏直反馈bbq之前有过类似数据读串的问题，导致A用户读取到了B用户的数据，浔枫反馈购物车之前也因为oom导致jedis.close释放资源不对导致数据读串的问题，且这两个问题全量重启机器可以恢复 |\n| 2024-08-31 04:54  | 远若执行机器分4批重启，由于诺曼底重启问题，全量重启会导致前几批都是混部机器，因此只能先重启中心，再重启南通，且串行操作不能同时重启  |\n| 2024-08-31 05:19  | 大家同步捞取测试账号，个人账号的rdb数据看能否复现，因用户只要访问购物车页面，错乱的数据就会被更新并写入rdb，所以开始找未登录页面的测试账号进行定位 |\n| 2024-08-31 05:31  | 重启过程中对比不一致监控未见明显下降；比对了若干个账号后，发现一个账号**线上rdb里数据就是错的**，而非应用查询结果错乱 |\n| 2024-08-31 05:45  | 再次电话楚玉，确认redis故障切换是否会导致数据错乱，楚玉反馈只会有秒级闪断 |\n| 2024-08-31 05:46  | 子墉猜测可能是近期的并行化&异步化改造导致用户的数据访问错了，远若执行了预案降级后并未恢复 |\n| 2024-08-31 05:48  | 浔枫反馈某一个测试账号的rdb数据只错了一个cartid，猜测是不是访问了个人历史数据，由于cartid和userid并没有关联性，只能通过离线数据来捞取定位 |\n| 2024-08-31 05:50  | 线上全量重启完成，问题并未恢复，同步拉redis征衡上线 |\n| 2024-08-31 06:11  | 浔枫反馈rdb数据可能回到了历史版本，因为数据中有v字段自增，rdb里是30，业务日志在8.30号的日志里的版本是70![](https://intranetproxy",
    "chunk_order_index": 1,
    "full_doc_id": "doc-aa51c86860e1eaf80a916c67edf0b3bc"
  },
  "chunk-67b0bc31a2ea3aaf2e38bd4b33797976": {
    "tokens": 1200,
    "content": "�取定位 |\n| 2024-08-31 05:50  | 线上全量重启完成，问题并未恢复，同步拉redis征衡上线 |\n| 2024-08-31 06:11  | 浔枫反馈rdb数据可能回到了历史版本，因为数据中有v字段自增，rdb里是30，业务日志在8.30号的日志里的版本是70![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/142490/1725081521699-9a400acf-baf7-43b9-86e4-795fd507d8ef.png)![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/142490/1725081514719-f763ffb9-39b1-448a-a336-bec68d077008.png) |\n| 2024-08-31 06:25  |  初因定位浔枫反馈今天凌晨南通redis做故障运维，张北也同时发生了抖动，怀疑是rdb历史数据被重刷了【**故障排查的关键转折点**】![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/142490/1725081746963-13ed9b62-6b0f-46a7-a7de-b4f02b3bd656.png) |\n| 2024-08-31 06:32  | 征衡猜测可能是单元化切流导致两边数据脏，远若拉取最近一次的单元化切流时间为7.28，时间已经过去了很久 |\n| 2024-08-31 06:35 | 开始讨论数据恢复方案，能否以恢复备份数据的方式来讨论恢复方案，征衡反馈此redis没有开通数据按时间点恢复 |\n| 2024-08-31 06:47  | 魏直反馈redis控制台看到有备份能否使用，征衡反馈需要评估备份恢复的范围和有效性，全量分片备份恢复还是切换的实例分片，备份数据版本是否符合预期。 ![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/142490/1725082035123-6fc064b0-0cd5-42db-b28f-bc5008e0647b.png) |\n| 2024-08-31 06:58  | 征衡询问是否只有故障维护的单分片有数据大量写入，远若反馈其余分片也有大量数据写入。 |\n| 2024-08-31 07:05  | 魏直下载单分片数据，量级在800万左右；众人确认rdb里的数据版本情况，评估如果切换到备份数据，数据的正确性是否满足要求 |\n| 2024-08-31 07:07  | GOC发送P3故障通知![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/12771/1725081758135-1a4f70ef-6a79-44d7-a48f-b08b5000cf09.png?x-oss-process=image%2Fformat%2Cwebp%2Fresize%2Cw_860%2Climit_0) |\n| 2024-08-31 07:17  | 征衡反馈如果恢复数据备份，会有若干时间的rdb不可用，根据3点写入数据量级预估影响用户范围上亿，子墉决策关闭rdb相关业务功能（购物车结构、购物车数字）进行降级 |\n| 2024-08-31 07:41 | 浔枫推送预发开关，准备做rdb结构数据读写访问的降级，回退到店铺模式，预发验证完毕后推送spe以及线上 |\n| 2024-08-31 07:44  | **店铺模式推送完成**，秒级自定义db与rdb对比补偿监控因业务降级降低至0![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/12771/1725082229236-b1fd561e-47e2-4fc0-bb46-56dc3ee96166.png?x-oss-process=image%2Fformat%2Cwebp%2Fresize%2Cw_1306%2Climit_0) |\n| 2024-08-31 07:50  | 远若推送开关itemOptimisticEvent，关闭购物车结构调整入口功能 |\n| 2024-08-31 08:01  | 雷晨反馈刚才切店铺模式后，购物车错乱的舆情明显下降，但是购物车分组丢失的舆情增加 |\n| 2024-08-31 08:17  |  恢复执行浔枫、远若分别操作rdb备份，但是都提示控制台权限不足，需要cc同学才能操作 |\n| 2024-08-31 08:34  | 拉cc同学瑜彦操作rdb备份恢复，新的v2_copy实例",
    "chunk_order_index": 2,
    "full_doc_id": "doc-aa51c86860e1eaf80a916c67edf0b3bc"
  },
  "chunk-6cdb5bf8683af06d6c7c28227a07cf33": {
    "tokens": 1200,
    "content": "乱的舆情明显下降，但是购物车分组丢失的舆情增加 |\n| 2024-08-31 08:17  |  恢复执行浔枫、远若分别操作rdb备份，但是都提示控制台权限不足，需要cc同学才能操作 |\n| 2024-08-31 08:34  | 拉cc同学瑜彦操作rdb备份恢复，新的v2_copy实例创建完成，**开始数据恢复** |\n| 2024-08-31 08:44  | CCO布防完成；布防口径：您好，购物车因系统升级导致商品顺序和分组信息丢失，给你带来不便还请谅解，我们会尽快修复，请耐心等待。 |\n| 2024-08-31 08:53  | 石碌推送一休实验，关闭详情购物车数字功能（关闭详情应用访问rdb） |\n| 2024-08-31 08:48 | **rdb数据重建完成** |\n| 2024-08-31 09:51 | 客诉量在线人工700+，升级P2； |\n| 2024-08-31 09:53 | **SPE环境验证重建的rdb集群OK**，开始对线上机器重启恢复，预计1小时后恢复，浔枫全量重启 carts2host 分组，发现分批不均（在线单元集中在最后2批）> 各个单元机房机器数量如下：> ![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/97529/1725082654389-7ad155ab-7e4d-49cc-994b-9fbb8daddbff.png?x-oss-process=image%2Fformat%2Cwebp%2Fresize%2Cw_1500%2Climit_0)> 对于 na610，有 430 台机器，前 4 批仅有 1 台机器， 第 5 批 140，第 6 批 286> ![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/97529/1725071759478-43c41c69-34f7-4012-b730-64108abfd5bf.png) |\n| 2024-08-31 09:59 | 龙饮操作 carts2host [4 个混部单元集群下线](https://n.alibaba-inc.com/commander/batchOperations/changeRecords/scaleIn/9231)（每个单元留20台） |\n| 2024-08-31 10:13  | carts2host 4 个混部单元集群下线下线完成，浔枫关闭之前的重启工单，重新发起 [carts2host重启单](https://cd.aone.alibaba-inc.com/unite/micro/ops/app/52236/RESTART/detail?changeOrderId=397279424000134)，分批正常，正常执行重启 |\n| 2024-08-31 10:53 |  故障止血RDB重建且重启线上机器，回滚用户的分组数据至8月31日凌晨2点后止血 |\n| 2024-08-31 10:57  | 龙饮操作 cartsapihost  [4 个混部单元集群下线](https://n.alibaba-inc.com/commander/batchOperations/changeRecords/scaleIn/9232)（每个单元留4台） |\n| 2024-08-31 10:59  | carts2apihost 4 个混部单元集群下线下线完成，同时浔枫发起[cartsapihost 重启单](https://cd.aone.alibaba-inc.com/unite/micro/ops/app/12037/RESTART/detail?changeOrderId=397313246000006)，正常执行重启 |\n| 2024-08-31 11:05 | [carts2host 重启单](https://cd.aone.alibaba-inc.com/unite/micro/ops/app/52236/RESTART/detail?changeOrderId=397279424000134) 结束，业务执行预案 |\n| 2024-08-31 11:19 | [cartsapihost 重启单](https://cd.aone.alibaba-inc.com/unite/micro/ops/app/12037/RESTART/detail?changeOrderId=397313246000006) 结束 |\n| 2024-08-31 11:41 | 开发check数据符合预期，GOC值班操作故障恢复 |\n| 2024-08-31 14:00  | 西溪现场办公讨论，分析异常流量来源渠道。道延咨询LB侧是否有历史访问来源统计， 咨询啸剑统计信息和异常时间点有写入流量但是无读流量现象，啸剑反馈VPC内流量走NGLB无流量，异常写入流量可能是集团内部BU跨域或者专线。 |\n| 2024-08-31 14:16 | 征衡咨询DTS同学虾球，虾球通过实例ID，在DTS后台找出来有一个关联Redis的正在运行的DTS任务，并反馈给业务方，此时才得知DTS链路信息",
    "chunk_order_index": 3,
    "full_doc_id": "doc-aa51c86860e1eaf80a916c67edf0b3bc"
  },
  "chunk-143de30a14979a2f4531019c4727da39": {
    "tokens": 1200,
    "content": "现象，啸剑反馈VPC内流量走NGLB无流量，异常写入流量可能是集团内部BU跨域或者专线。 |\n| 2024-08-31 14:16 | 征衡咨询DTS同学虾球，虾球通过实例ID，在DTS后台找出来有一个关联Redis的正在运行的DTS任务，并反馈给业务方，此时才得知DTS链路信息，并明确写入流量来源。 |\n| 2024-08-31 16:00  | 业务确定原因为RDB数据库被历史数据覆盖 |\n\n\n## 三、故障原因\n### 一句话原因：\n:::tips\n购物车rdb新老集群迁移场景下，在功能读写迁移到新rdb集群后停止DTS任务，但实际DTS任务未删除，8.31目标端rdb在发生HA后，DTS任务重启，触发5.29DTS功能升级后增量位点丢失，引发DTS基于4.10左右的rdb老集群数据重新做了一次全量+增量同步，最终导致DTS 和业务对目标端Rdb进行双写，数据出现错乱。\n\n:::\n\n### 详细原因：\n:::tips\n+ 2月20日，购物车业务开发同学创建DTS链路，用来做Redis版本升级，于**4月10号完成全部应用迁移切流后，对应用代码逻辑完成下线，（系统视角：未对老库和DTS链路做下线操作）**（业务开发视角：搭建DTS链路在4月份迁移完成后开发操作停止任务，但实际DTS任务没有释放。）\n+ 5月29日，DTS发布功能升级，在Redis连接串信息中增加了 -master/-slave 的主备节点信息，该升级会使得**DTS任务后续第一次重启时，丢失增量位点，做一次全量+增量同步动作**；\n+ 6月4日，cc基于Config同步的信息，标记cc资源中心DTS页面状态为**“已销毁”，**当天Config又重新把DTS的任务正常状态，同步给了cc，**但cc重新创建了一条新记录且没有关联应用，业务开发同学看不到新的DTS任务**\n+ 8月31日，迁移链路中的目标端Redis库，因主机故障发生HA，触发DTS任务重启后丢失增量位点，重新对迁移链路的源端老库做了**全量数据同步**到目标端，与应用业务产生双写，从而将RDB的v1老集群（**4月10日左右的老数据**）数据全量写至v2集群（购物车结构数据当前线上使用集群）导致用户购物车结构数据错乱。\n\n:::\n\n#### 【升级背景】\n:::tips\n购物车结构数据rdb的V1集群有历史部署问题：\n\n+ 张北、南通实例规格不一致、实例版本不一致\n+ 扩容必须满足5.0及以上版本，rdb实例版本过低，**原地直接升级风险较大**（1.7.4->5.0跨度过大），升级过程会有最大60s只读状态，可能影响该时段购物车功能可用性。\n因此采用方案新建rdb V2集群，**同时依靠dts做存量数据单向迁移。**\n\n:::\n\n#### 【升级方案】\n:::tips\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/59531/1708572258615-85c42e9b-7ceb-4857-a420-f6a7a55e0d96.png)\n\n\n\n1. 建立旧南通V1 rdb到新南通V2 rdb的**单向同步DTS**，开启同步做数据初始化。\n2. 开启全球多活，新V2南通和新V2张北数据同步。\n3. carts2+cartsapi **切流态 同时连接新老两个集群**，通过switch和diamond控制切流比例实时生效。\n4. 灰度逐步切流用户流量至新V2集群，**切流用户不写老库，不会触发该用户数据dts增量同步**。未切流用户保留老集群读写，通过单向dts将数据同步至新集群。\n5. 用户整体切流至新集群，老集群流量清零，相关切流代码下线，**此时DTS任务已无新增业务同步流量，业务同学操作DTS停止，实际DTS任务仍在运行中**。\n6. 老集群需要待所有应用迁移完成后再下线，否则会导致依赖应用无法线上重启造成问题。\n\n:::\n\n#### 【升级节奏】\n> #### 2024/02/20  提交dts资源申请，使用周期0509截止（这里是申请时的预估）：\n> [https://cc.alibaba-inc.com/resource/change-order?orderId=89e1e5ac-8549-4740-b6b6-a0335ccd60aa](https://cc.alibaba-inc.com/resource/change-order?orderId=89e1e5ac-8549-4740-b6b6-a0335ccd60aa)\n>\n> ![](",
    "chunk_order_index": 4,
    "full_doc_id": "doc-aa51c86860e1eaf80a916c67edf0b3bc"
  },
  "chunk-b49e70d250637be181d53277a3a4c82a": {
    "tokens": 1200,
    "content": "提交dts资源申请，使用周期0509截止（这里是申请时的预估）：\n> [https://cc.alibaba-inc.com/resource/change-order?orderId=89e1e5ac-8549-4740-b6b6-a0335ccd60aa](https://cc.alibaba-inc.com/resource/change-order?orderId=89e1e5ac-8549-4740-b6b6-a0335ccd60aa)\n>\n> ![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/59531/1725089506952-b7af0c92-7710-4b94-9d8b-97ea34b206a3.png?x-oss-process=image%2Fformat%2Cwebp%2Fresize%2Cw_1500%2Climit_0)\n>\n> 业务切流过程：\n>\n> + 2024/03/20 11:14 开始切流 0.1%\n> + 2024/03/21 14:00 开始切流10%->50%->100%\n> + 2024/03/28 所有carts2和cartsapi已梳理场景对老V1集群依赖代码整体下线，老V1集群流量\n> + 2024/04/10 发现淘特、mmc等有长尾流量，逐步推进清明后移除。老集群流量清零+代码逻辑完全下线，后续通过**鹰眼确认老集群已无上游应用流量**。**此时由于老集群已无应用侧流量，研发判断dts数据同步任务不会再被触发**。**后续担心老rdb下线会导致有未梳理长尾应用无法重启造成问题，故老集群未进行下线。**\n>\n\n\n\n## 四、故障关注点\n#### 1、关于原因\n**〖关注点1〗****DTS任务是否有被销毁过，业务方有没有看到过已销毁的页面？如果有，是在什么时间？**\n\n:::tips\n**〖问题总结〗**\n\n+ 业务开发同学有在云控制台操作过停止DTS，**因为是三个月前的事情，是否看到过已销毁页面和具体时间点已经找不到记录了，**但是在故障当时从cc确实看到任务被销毁了。\n+ **担心老rdb下线会导致有未梳理长尾应用无法重启造成问题，故老集群未进行下线。**\n+ **从CC及阿里云控制台的操作记录来看，未见到有实例删除的操作；**附：诺曼底与数据库管控未找到相应停止任务的操作记录如下。\n\n_**故障当天CC展示：**_\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/59531/1725095080611-9b836538-0f69-464a-ad08-8a22a8726745.png)\n\n_**实例日志记录：**_\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/12771/1725591127995-26c027c7-f817-4f5f-b70e-695a495073e4.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/12771/1725591115613-da56717f-3819-456d-beb1-2488f7b0f503.png)\n\n**〖改进点〗**\n\n+ DTS资源释放            8.31 已完成\n+ 老集群RDB彻底下线      [@浔枫](undefined/bonan.hbn)  9.30\n\n:::\n\n\n\n**〖关注点2〗****DTS任务究竟是否被停止，如未停止，cc平台为什么会显示dts任务已被销毁，如未销毁，业务同学为什么无法从cc平台carts2的DTS资源看到该任务**\n\n:::tips\n**〖问题总结〗**DTS任务实际未被停止，从CC端及阿里云控制台均未看到有销毁的记录，故障当时及6.4日后展示为销毁的原因是：\n 6月4日 11:40 CC接收到Config的收到该DTS实例被删除的通知，CC将该实例标记为已删除（实际未删除），会导致看到是删除页面。后续6月4日 20:52   CC接收到Config的收到该DTS实例被创建的通知，CC重新记录了一条DTS实例数据（实例ID为dtsa91r245520g46j8），但是无应用归属，且是新的查看页面，业务用户查看不到。\n\n_**CC为何会将实际未删除的任务展示为删除？**_\n\n阿里云资源中心系统对账时查dts的api查不全，将对账删除的信息传给下游config，config将信息传递给CC，CC做删除展示。\n\n_**资源中心对账时为何查dts的api不全？**_\n\n dts内部逻辑处理问题，引发资源中心对账时查dts的api不全。\n\n**〖改进点〗 **\n\n+  CC资源展示问题修复，对于删除状态的显示需要多",
    "chunk_order_index": 5,
    "full_doc_id": "doc-aa51c86860e1eaf80a916c67edf0b3bc"
  },
  "chunk-80ebc467943db929839aeca050fd390d": {
    "tokens": 1200,
    "content": "系统对账时查dts的api查不全，将对账删除的信息传给下游config，config将信息传递给CC，CC做删除展示。\n\n_**资源中心对账时为何查dts的api不全？**_\n\n dts内部逻辑处理问题，引发资源中心对账时查dts的api不全。\n\n**〖改进点〗 **\n\n+  CC资源展示问题修复，对于删除状态的显示需要多维度校验。   [@瑜彦](undefined/yuyan.lx)  930\n\n:::\n\n\n\n**〖关注点3〗****DTS资源是否应该被释放？是否有相关说明？**\n\n:::tips\n**〖问题总结〗DTS建议：****业务完成切流后，应该立即释放DTS任务。**\n\n[文档1：](https://help.aliyun.com/zh/dts/getting-started/manage-a-data-migration-task?spm=a2c4g.11186623.0.0.73d7240eLqUT81)手册的迁移流程明确定义，在业务完成切换后，需要结束迁移任务\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/4399/1725523564974-1637b000-be6e-409b-b402-ab4b57cc1a48.png)\n\n[文档](https://help.aliyun.com/zh/dts/user-guide/overview-of-data-migration-scenarios?spm=a2c4g.11186623.0.0.2c213175sMihZt)2：明确提示需要用户手动结束任务\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/4399/1725523613753-8806d7b4-92d4-4503-928a-6daf3d64e2c7.png)\n\n[文档](https://help.aliyun.com/zh/dts/user-guide/migrate-data-between-apsaradb-for-redis-instances?spm=a2c4g.11186623.0.i10)3：再次提示，务必结束或者释放DTS任务\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/4399/1725523667787-aa88955a-b998-460a-b0e1-ef86a411c0e6.png)\n\n**〖改进点〗**暂无\n\n:::\n\n\n\n**〖关注4〗****DTS的5月29号变更，之前HA不会触发全量同步，DTS功能升级后增量位点丢失，从而触发老集群全量同步是否合理**\n\n:::tips\n**〖问题总结〗合理，该产品行为，符合产品使用设计。**\n\n**技术实现原因：**DTS在5月29日为支持《Redis集群版秒级守护》的需求，对产品做过一次功能升级，标记目标端连接串的规则，由IP+PORT改为DBRole(master/slave)+IP+PORT，增加了DB角色信息，在这次的HA切换中，DTS任务重启后，无法根据连接串信息，重新获取到重启前的增量位点信息，所以发起了全量同步。\n\n**方案设计原因：**该设计方案在内部评估过，判断对历史版本会产生仅一次全量，在满足目标库只有DTS写入情况下，不会产生数据问题，方案本身没有问题，是在满足产品使用限制的前提下去做的代码实现，不会去考虑非产品支持的业务场景（业务双写）下的逻辑正确性，这也是为什么线上这么多任务(144+)都没问题，购物车这个case会出问题。\n\n\n[文档1：](https://help.aliyun.com/zh/dts/user-guide/migrate-data-from-an-apsaradb-for-redis-instance-to-another-apsaradb-for-redis-instance-across-alibaba-cloud-accounts?spm=a2c4g.11186623.0.i5)HA导致DTS连接断开，会导致全量数据重新迁移致目标端，从而导致数据不一致。方案和实现，符合产品设计预期\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/4399/1725523458134-1b8a2ee4-a4af-446e-b218-1eaaa12f4e53.png?x-oss-process=image%2Fformat%2Cwebp%2Fresize%2Cw_1320%2Climit_0)\n\n运行时，不允许除DTS外的数据写入到目标库\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/4399/1725523242545-5115c11f-f0ab-4d26-8f48-4cb478e0de31.png)\n\n**〖改进点〗**\n\n+ **说明文档优化：**接入文档加强说明，此案例场景作为案例列入说明文档。    [@脚仙](undefined/shoumin.gsm)  9.13日\n+ **方案优化评估：**DTS产品层面是否可支持此类业务场景（在做HA的时候，避免第一次全量的发生）        [@脚仙](undefined/shoumin.gsm)  9.13日 给",
    "chunk_order_index": 6,
    "full_doc_id": "doc-aa51c86860e1eaf80a916c67edf0b3bc"
  },
  "chunk-f75facee3af91209711aeb951c6fefd5": {
    "tokens": 1200,
    "content": "+ **说明文档优化：**接入文档加强说明，此案例场景作为案例列入说明文档。    [@脚仙](undefined/shoumin.gsm)  9.13日\n+ **方案优化评估：**DTS产品层面是否可支持此类业务场景（在做HA的时候，避免第一次全量的发生）        [@脚仙](undefined/shoumin.gsm)  9.13日 给出评估结论\n\n:::\n\n\n\n**〖关注5〗****触发DTS位点丢失数据重传场景都有哪些？如果没有5.29日DTS的升级，是否会数据重传？**\n\n:::tips\n**〖问题总结**〗如果DTS链路不销毁，或者老的库业务不下线，可能会有其他场景触发触发重传。\n\n** 触发重传场景：  待**[@墨无](undefined/wx105683)** **补充\n\n**〖改进点〗 **\n\n+ DTS确认淘天使用的版本的Redis是否支持tair的binlog，避免位点丢失的情况发生    [@墨无](undefined/wx105683)   9.13日\n\n:::\n\n\n\n**〖关注6〗****DTS是否有版本概念，新增功能由业务方自由选择？DTS的5月29号变更后，内部已知晓会触发全量同步的可能性，对于线上没有增量同步但是还在跑着的任务是否可以批量提醒？**\n\n:::tips\n**〖问题总结〗**DTS当前有版本概念；通常评估必要的功能是会主动告知用户，让用户感知；此次5.29优化内部评估了按照产品规约进行使用的情况，判断不会有异常发生，所以主动未告用户。\n\n**〖改进点〗**\n\n+ 捞取线上还存在的此类使用场景的资源**(会上讨论，实现有难度，需要评估方案）**\n\n      -- [@脚仙](undefined/shoumin.gsm)  9.13日 评估完成\n\n+ DTS通道长期未同步的进行主动通知提醒         [@脚仙](undefined/shoumin.gsm)  9.13日 评估完成\n+ 基于此故障的经验，业务后期对于DTS任务消除需要主动检查确认        @子墉   内部同步\n\n:::\n\n\n\n####  2、应急处置\n**〖关注点1〗****系统发现能力**\n\n:::tips\n**〖问题总结〗有监控发现**\n\n+ rdb结构数据和数据库数据对比不一致有监控，且有舆情监控触发\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/142490/1725080035956-a57687f6-3ede-49cc-bfde-ae2b468f2bb2.png)![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/142490/1725509815905-36fb1321-b675-4df5-a01e-ac967edb07f2.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/142490/1725509807365-f95e7867-88dc-4133-9960-9977a6190398.png)\n\n**〖改进点〗**暂无\n\n:::\n\n\n\n**〖关注点2〗****故障从凌晨3点持续到上午11点左右，持续过程长。**\n\n:::tips\n**〖问题总结〗主要是定位和恢复过程花费了过多的时间；**\n\n+ 一开始考虑是舆情不能加购，有误导，后来由于rdb连接没有正确释放导致数据读串，并且之前也有类似问题，先做了全量重启，并且由于诺曼底重启分批有bug导致张北、南通需分批重启，耽误了时间。\n+ 业务层面可以提早切回到店铺模式，但是当时根据监控判断受影响的非全量用户，且由于切回到店铺模式也会导致自定义分组功能不可用，也会导致大规模的舆情（从后续切回店铺模式之后的舆情看证实了这一点），所以此时未决策切到店铺模式。\n+ 后续通过比对不同测试账号rdb内数据以及购物车数据库内的数据，定位到了rdb的cartid不对，但是由于cartid和用户id没有关联性，在定位cartid是用户历史购物车数据还是其他用户的购物车数据花了一些时间。\n+ 由于rdb没有开启数据闪回，在准备使用rdb自带备份功能时，需要rdb同学进行功能是否可用评估，同时需要对备份数据进行抽查，在确认数据可用后，在操作rdb备份恢复时由于权限问题又耽误了一些时间。\n+ 在rdb备份数据完成后，需要应用层切换rdb链接后重启才能生效，但是由于重启诺曼底重启分批有bug，需要容器同学先做混部的全量下线才能重启，耽误了一些时间。\n\n**〖改进点〗**\n\n+ 购物车增加凌晨写流量的监控           [@浔枫](undefined",
    "chunk_order_index": 7,
    "full_doc_id": "doc-aa51c86860e1eaf80a916c67edf0b3bc"
  },
  "chunk-cce0bbc1e1118378024c70a0119c3abb": {
    "tokens": 1200,
    "content": "权限问题又耽误了一些时间。\n+ 在rdb备份数据完成后，需要应用层切换rdb链接后重启才能生效，但是由于重启诺曼底重启分批有bug，需要容器同学先做混部的全量下线才能重启，耽误了一些时间。\n\n**〖改进点〗**\n\n+ 购物车增加凌晨写流量的监控           [@浔枫](undefined/bonan.hbn)    9.30\n+ 流量来源排查工具建设(Rdb带回，评估可行性)        [@征衡](undefined/zhengheng.wzh)   9.13   可行性确定\n\n:::\n\n\n\n**〖关注点3〗****诺曼底重启各个单元分批不均匀且无法分批跳过问题 **\n\n:::tips\n**〖问题总结〗**简单来说，诺曼底的分批重启，在第一批的时候会保证在每个机房有1台机器，后续每批重启过程中会优先选择待分批实例数高的workload，因为 ea118 有 6000+副本，所有后面都会取ea118。所以导致了这种极端的分批不均[情况](https://cd.aone.alibaba-inc.com/unite/micro/ops/app/52236/RESTART/detail?changeOrderId=397260490000002) （na610 前 4 批仅有 1 台机器， 第 5 批 142，第 6 批 286）。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/97529/1725071751372-e53acb47-7e0c-4abf-a0af-4867cea0cc8b.png)\n\n这个功能是 2023 年 9 月就上线了，去年双 11 也有 carts2 的[**重启单**]( https://cd.aone.alibaba-inc.com/unite/micro/ops/app/52236/RESTART/detail?changeOrderId=60616544000040)，分批策略也是一样的，批次是 12 批。\n\n**〖改进点〗**\n\n+ Normandy 重启[分批策略优化  ](https://aliyuque.antfin.com/xtask/guisgu/pudtnrnik1g0by46) [@龙饮](undefined/hsj160886) \n+ Normandy [重启体验优化](https://aliyuque.antfin.com/xtask/guisgu/lw89kn7ctk4cu8tx)（提单、批次跳过、机房单元筛选等） [@龙饮](undefined/hsj160886) \n+ 上线后业务方进行发布体验验证        [@远若](undefined/yuanruo.ck)\n\n:::\n\n\n\n**〖关注点4〗****阿里云控制台上业务同学没有权限将数据进行恢复，只能由cc同学提交**\n\n:::tips\n**〖问题总结〗**该Redis实例为集团大账号下实例，集团大账号对于权限有严格的管控策略。\n\n由于备份恢复操作会生成新的Redis实例，若直接在控制台上操作实例会导致实例无归属应用，无法进行运维管理和分账。**因此平台不允许用户直接从云控制台上发起备份恢复操作，需要从CC页面发起备份恢复操作**，具体如下图，操作文档[Redis备份恢复](https://aliyuque.antfin.com/cloudcenter/resource/kw6s1pg6u7u75c7o)：\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/197343/1719839971964-b248db7e-f889-4c2a-bdd0-7dc89f2053cf.png?x-oss-process=image%2Fformat%2Cwebp%2Fresize%2Cw_1118%2Climit_0)\n\n**〖改进点〗**\n\n1. CC页面上对于本地盘实例备份恢复的体验较差（大分片场景下，需要手动点多个备份ID），需要优化交互体验，支持全选备份、操作按钮旁边新增说明[@瑜彦](undefined/yuyan.lx)\n2. 相关操作手册和文档宣导不足，会同Redis同学一起完善使用手册[@瑜彦](undefined/yuyan.lx)\n3. 对于特殊应急场景，应该对特定运维同学支持临时申请权限，支持从云控制台完整相关操作[@瑜彦](undefined/yuyan.lx)\n\n:::\n\n\n\n## 五、常规检查项\n### 5.1【系统质量】   \n#### 5.1.1 需求&设计评估  _--不涉及_\n#### 5.1.2 代码质量   _--不涉及_\n#### 5.1.3 变更质量   _--不涉及_\n### 5.2【处置能力】  __\n#### 5.2.1 故障发现&响应   _--详见第四部分故障关注点_\n+ **是否监控发现**\n    - [ ] 故障触发方 监控发现\n    - [x] 故障受影响方 监控发现\n    - [ ] 否，原因为：（监控无效/监控缺失）\n+ **是否",
    "chunk_order_index": 8,
    "full_doc_id": "doc-aa51c86860e1eaf80a916c67edf0b3bc"
  },
  "chunk-9214f777467ecbcff75eee06812b81ed": {
    "tokens": 1200,
    "content": "_\n### 5.2【处置能力】  __\n#### 5.2.1 故障发现&响应   _--详见第四部分故障关注点_\n+ **是否监控发现**\n    - [ ] 故障触发方 监控发现\n    - [x] 故障受影响方 监控发现\n    - [ ] 否，原因为：（监控无效/监控缺失）\n+ **是否5分钟内响应**\n    - [x] 是\n    - [ ] 否，原因为：\n+ **是否存在应急协同问题**\n    - [ ] 是\n        - [ ] 应急流程不明确（无流程或者流程不清晰、应急相关角色&职责不明确，缺失一号位等)\n        - [ ] 应急执行不到位（有流程，但未按流程执行，通告发送不及时，响应不及时等）\n    - [x] 否\n\n#### 5.2.2 故障定位&恢复  _--详见第四部分故障关注点_\n+ **主要恢复方式：**\n    - [ ] 代码发布/回滚\n    - [ ] 配置发布/回滚\n    - [ ] 数据订正\n    - [ ] 机器隔离/重启/扩容\n    - [ ] 配置限流\n    - [ ] 预案降级\n    - [ ] 自动恢复\n    - [x] 其他：RDB备份数据重建\n+ **是否10分钟内恢复**_/* P1P2故障填写*/_\n    - [ ] 是\n    - [x] 否，原因：__________\n\n#### 5.2.3 SRE应急参与（淘天业务技术参考）\n+ **SRE工程师应急参与**：__\n    - 是否响应\n        - [x] 是\n        - [ ] 否\n    - 是否帮助定位\n        - [x] 是\n        - [ ] 否，备注：__________\n        - [ ] 未参与，备注：__________\n    - 是否操作恢复/提出有效恢复方案\n        - [x] 是\n        - [ ] 否，备注：__________\n        - [ ] 未参与，备注：__________\n+ **SRE专家是否有效指挥**\n        - [x] 是\n        - [ ] 否，备注：__________\n        - [ ] 未参与，备注：__________\n\n\n\n## 六、故障Action\n| **序号** | **类型** | *******Action描述** | *******负责人** | *******计划完成时间** | **验收标准** | **是否keyAction** | **是否回血Action** |\n| --- | --- | --- | --- | --- | --- | --- | --- |\n| 1 | 运维类 | 短期：老集群RDB同步至新集群RDB DTS从云控制台释放 | 浔枫 | 已完成 | DTS从云控制台释放 | 否 | 否 |\n| 2 | | 短期：老集群RDB彻底下线 | 浔枫 | 9.30 | 下线完成 | 否 | 否 |\n| 3 | | 长期：新集群RDB开启数据闪回 | 浔枫 | 已完成 | 开启完成 | 否 | 否 |\n| 4 | | 短期：8.31临时创建的备份RDB集群下线 | 浔枫 | 9.30 | 集群下线 | 否 | 否 |\n| 5 | 监控类 | 短期：购物车增加凌晨写流量的监控     | 浔枫 | 9.15 | 监控增加完成 | 否 | 否 |\n| 6 | 产品优化类 | 短期：Normandy 重启[分批策略优化  ](https://aliyuque.antfin.com/xtask/guisgu/pudtnrnik1g0by46)  | 龙饮 | 9.15 | 重启分批不均问题解决 | 是 | 否 |\n| 7 | | 短期：Normandy [重启体验优化](https://aliyuque.antfin.com/xtask/guisgu/lw89kn7ctk4cu8tx) | 龙饮 | 9.15 | 重启体验优化上线 | 否 | 否 |\n| 8 | 文档类 | 短期：完善使用手册 | 瑜彦 | 9.13 | 完善使用手册 | 否 | 否 |\n| 9 | 产品优化类 | 短期：CC资源展示问题修复，对于删除状态的显示需要多维度校验 | 瑜彦 | 9.13 | CC资源展示问题修复 | 否 | 否 |\n| 10 | | 长期：应急类场景权限申请支持 | 瑜彦 | 10.31 | 应急类场景权限申请支持 | 是 | 否 |\n| 11 | | 长期：CC优化本地盘实例备份恢复体验 | 瑜彦 | 10.31 | 优化完成 | 否 | 否 |\n| 12 | 文档类 | **说明文档优化：**接入文档加强说明，此案例场景作为案例列入说明文档 | 梓悠 | 9.13 | 产品说明文档补充完成 | 否 | 否 |\n| 13 | 信息确认类 | **信息确认",
    "chunk_order_index": 9,
    "full_doc_id": "doc-aa51c86860e1eaf80a916c67edf0b3bc"
  },
  "chunk-c7b09eab5d64055b9a70eedf766bf256": {
    "tokens": 836,
    "content": "长期：CC优化本地盘实例备份恢复体验 | 瑜彦 | 10.31 | 优化完成 | 否 | 否 |\n| 12 | 文档类 | **说明文档优化：**接入文档加强说明，此案例场景作为案例列入说明文档 | 梓悠 | 9.13 | 产品说明文档补充完成 | 否 | 否 |\n| 13 | 信息确认类 | **信息确认：**DTS确认淘天使用的版本的Redis是否支持tair的binlog，避免位点丢失的情况发生 | 墨无 | 9.13 | 确认完成 | 否 | 否 |\n| 14 | 方案评估类 | **方案优化评估：**DTS产品层面是否可支持此类(在做HA的时候，避免第一次全量的发生)业务场景        | 墨无 | 9.13 | 方案评估完成，给与明确评估结论 | 否 | 否 |\n| 15 | | **评估捞取可行性：**捞取线上还存在的此类使用场景的资源 | 梓悠 | 9.13 | | 否 | 否 |\n| 16 | | **产品方案评估：**DTS通道长期未同步的进行主动通知提醒   | 梓悠 | 9.13 | | 否 | 否 |\n| 17 |  | 流量来源排查工具建设(Rdb带回，评估可行性)   | 征衡 | 9.13 | | 否 | 否 |\n\n\n## 七、故障总结反思\n**【做得好的】**\n\n**【经验教训】**举一反三，学习，避免踩坑\n\n如何避免此问题再次发生：\n\n核心是规避对数据库的双写：在使用DTS做数据同步时，如果目标端有写入，需要在目标端写入之前，把DTS链路给停掉；如果DTS链路不停，那么业务上目标端数据库只能作为只读库去使用。\n\n**几种业务场景的最佳实践，供参考：**\n\n+ 如果想保留源端作为历史备份，应该停止所有的相关DTS同步链路\n+ 如果想保留源端作为实时备份，供后续实时回切使用，应该及时停止正向同步，业务切换到目标端后，建一条反向的同步链路，让源库保持数据实时更新\n+ 如果Redis版本是tail版，可以使用DTS的双向同步链路，支持业务在目标端的双写需求\n\n## 八、影响产品线&影响面\n| **受影响业务** | **等级** | **影响说明** |\n| --- | --- | --- |\n| 业务技术-购物车 | P2 | - [ ] 是否影响可用性：否- [ ] 业务影响：未触发高可用故障场景- [x] 是否有客诉：在线人工反馈898，去重后848，故障级别P2> 关键词：购物车 AND （乱 OR 顺序 OR （分组 AND （没了 OR 消失）））> ![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/12771/1725506320627-301e5f57-9b03-40d5-bb49-508a3cd9fe9f.png)> 故障标准：> ![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/12771/1721284675497-ad73050c-f678-48a7-9d8b-fbf374197459.png) - [ ] 是否有社会舆情：否- [ ] 是否产生资损：否 |",
    "chunk_order_index": 10,
    "full_doc_id": "doc-aa51c86860e1eaf80a916c67edf0b3bc"
  },
  "chunk-938850a8bd6af6723020fa1251ee3e75": {
    "tokens": 1200,
    "content": "## 一、故障简述\n故障简述：2024-08-31 12:00 有批量用户进线反馈12点下单时手猫APP端88VIP 96折优惠未生效，初步定位与ump调用奥格限流有关，于12:10左右流量下降后自动止血，故障期间客诉达到20+，触发P4。\n\n## 二、故障过程回顾\n### 2.1【时间线概览】\n![画板](https://intranetproxy.alipay.com/skylark/lark/0/2024/jpeg/244704/1725186000134-c487e152-984d-4ea1-a831-f0628879944c.jpeg)\n\n\n\n### 2.2【故障处理时间线】\n故障时间线：\n\n2024-07-24，【风险注入】88vip折上折支持一品多报的需求（**详细代码见背景说明**）\n\n2024-08-31 11:58，手猫商业化收到购物车流量上涨预警推送。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/10179/1725276740314-f45949fa-ce99-409c-b768-ade169449eed.png)\n\n2024-08-31 12:00，【事件发生】叠纸心意旗舰店8月31号12:00新品商品上架开卖。\n\n2024-08-31 12:02，手猫交易异步化应用mallx-nextrpc应用CPU利用率上涨预警推送。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/10179/1725277944848-45ffdf17-3732-46e6-860d-aafbdbb6a3b2.png)\n\n2024-08-31 12:04， 手猫newbuy交易错误码上涨和下单成功率下跌预警推送。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/10179/1725276895704-f407e11e-720d-488d-9c72-c16334689ff5.png)![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/10179/1725276961559-afbb3e5f-e643-483b-a9af-881219c0a51e.png)\n\n2024-08-31 12:07，【响应】手猫技术SRE国梓拉手猫基础链路技术春翡、依凡、风为、虎贝、海火、周隹排查手猫商业化流量大幅上涨 、手猫交易异步化应用(mallx-nextrpc)CPU利用率上涨预警。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/10179/1725276419130-1b924964-42ab-4abd-be3b-110c9eb8ab6b.png)\n\n2024-08-31 12:09，【故障发生】VOC预警，批量用户反馈88vip折上折未生效\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/8177/1725347171688-300ee407-7df6-4769-9f8c-a6922fa0c97b.png)\n\n2024-08-31 12:12， 【响应】会员技术质量菱菡拉起【没用上88vip】舆情预警群\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/10179/1725278205512-1ba4b9d9-da65-40c1-90d6-661d0363d063.png)\n\n2024-08-31 12:14， 会员技术宗龙拉手猫技术SRE国梓进入【没用上88vip】舆情预警群进行排查\n\n2024-08-31 12:15，【故障恢复】消费者集中抢购流量下降，消费者下单使用手猫88VIP折上折优惠基本恢复可用\n\n2024-08-31 12:20，手猫技术SRE拉天猫APP88vip折上折优惠玩法产品漪岚、开发李世堤、运营蓓酱、大促PDM冬九进入【没用上88vip】舆情预警群进行排查\n\n2024-08-31 12:24，手猫大促PDM冬九反馈小红书（关键字：恋与深空 96折）上有用户反馈天猫APP88VIP96折优惠下单未生效\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/10179/1725278725226-60ced25f-c5eb-47aa-9c09-b21e19ecf6ae.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/10179/1725278748740-3c181b1c-04c8-4296-abe9-41d28b0b5f3f.png)![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png",
    "chunk_order_index": 0,
    "full_doc_id": "doc-671baf453dcde20b316c521b9fd46ce3"
  },
  "chunk-5606226ff3e6129c80f8cdf496b8e52c": {
    "tokens": 1200,
    "content": "-c5eb-47aa-9c09-b21e19ecf6ae.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/10179/1725278748740-3c181b1c-04c8-4296-abe9-41d28b0b5f3f.png)![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/10179/1725278764752-e3ecaf07-aa39-472d-851f-5ba1f5c722c3.png)\n\n2024-08-31 12:25， 手猫大促PTM天士反馈验证消费者反馈的问题商品再次下单能享受天猫APP88VIP9N折扣优惠（验证订单号：4025842848180128232）\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/10179/1725278852044-c0149cb6-199d-4bb8-b4fd-2499eafb756f.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/10179/1725278919232-f6dde1ab-da21-4740-965d-11c155b14eff.png)\n\n2024-08-31 12:31，  手猫技术SRE国梓排查到11:59-12:02 手猫下单错误码USING_PROMOTION_FAIL(UMP:CONSISTENCY_CHECK_FAIL#PROMOTION_NOT_FOUND) 数量异常上涨。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/10179/1725287554263-1a708e0f-5751-4a17-a97a-8b9cded52ae6.png)\n\n[https://xflush.alibaba-inc.com/custom/42/product/preview/multiMinute/4404](https://xflush.alibaba-inc.com/custom/42/product/preview/multiMinute/4404) 手猫下单整体错误码 监控\n\n2024-08-31 13:00，【初因定位】手猫技术世堤定位到用户满足人群门槛，但在88VIP折上折优惠产品包内判断人群校验不通过，导致天猫APP88VIP折上折96折活动没有生效。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/10179/1725287762999-f97fb40a-464f-4605-9299-7b31e6a8e6ca.png)\n\n2024-08-31 13:18，手猫技术世堤进一步排查发现ump2调用奥格服务存在限流报错日志。****\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/10179/1725276216568-f6e729aa-2aef-4bf1-9f88-8b50ea65aac2.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/10179/1725288006532-51473107-c841-4e35-b01f-463837f6e567.png)\n\n2024-08-31 13:23，【根因排查】 UMP技术休比确认手猫折上折产品包中存在调用奥格放大问题\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/10179/1725276271090-e3c06905-6adf-456c-aa27-2c08752b5fe1.png)![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/10179/1725276288330-9b4fd2e5-dff9-45a5-997a-0aa3b4fb6dc3.png)\n\n2024-08-31 13:23，手猫技术SRE国梓拉到奥格技术明樵、龚少确认ump2调用奥格存在限流原因\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/10179/1725276343259-8add48ba-1a7d-45d4-9c4b-a401a9d642cd.png)\n\n2024-08-31 13:25，手猫运营蓓酱同步手猫客户体验子昕，客服侧布防方案。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/10179/1725279074382-65c58e8b-c3ae-4be7-81f7-32bbc4f119bc.png)\n\n2024-08-31 13:34，奥格技术龚少反馈ump2配置了奥格人群服务方法单机限流为1000qps。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/10179/1725288085358-9ddc68d0-00ed-48e6-8d96-c48127ecb423.png)\n\n2024-08-31 13:45，【根因排查】UMP技术文安查询ump2应用sentnel实时监控，12:00问题",
    "chunk_order_index": 1,
    "full_doc_id": "doc-671baf453dcde20b316c521b9fd46ce3"
  },
  "chunk-186aec7008e757d7de5b6a52ddaf660a": {
    "tokens": 1200,
    "content": "单机限流为1000qps。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/10179/1725288085358-9ddc68d0-00ed-48e6-8d96-c48127ecb423.png)\n\n2024-08-31 13:45，【根因排查】UMP技术文安查询ump2应用sentnel实时监控，12:00问题出现时间段有大量限流(通过QPS：260.2万，限流QPS：204.7万)。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/10179/1725272852806-4b1702c3-ee3d-4489-851c-52cd19ce00e7.png)\n\n2024-08-31 13:59， 营销平台促销开发道昭调整ump2调用奥格人群服务方法(auge.AugeCrowdService.isTargetInCrowdWithResult)单机限流从1000到2000\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/10179/1725272640270-fd390eae-dde6-4bb8-a69a-0f6e8364a010.png)\n\n2024-08-31 14:02， 【影响消除】ump2掉用奥格人群服务方法(auge.AugeCrowdService.isTargetInCrowdWithResult)限流数量降到0\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/10179/1725272574496-6b2a787c-444d-4db1-995c-36d505870879.png)![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/10179/1725272780933-62566f4e-97d2-4e57-ba72-0ed15a5fdf77.png)\n\n2024-08-31 14:40， CCO布防，布防话术是引导用户重新下单。\n\n2024-08-31 15:06，宣导客服此类问题禁止赔付，待确定方案后再同步；——是否可以拉到已赔付名单？避免重复赔付。[@国燕](undefined/guoyan.lgy) 0906同步初步进展 如果可以拉出来，剔除这部分用户的赔付\n\n:::info\n附小红书舆情时间：此问题客服首个赔付出现在2024-08-31 12:08:40，在15：06下落强调禁止赔付前，零散几个小二支持了用户差价赔付，用户获得赔付后，在小红书发布消息，13：50开始有批量进线要求赔付，截止17：00此问题咨询量在363（用户未去重）。在15:06强调禁止赔付后，问题处理抽样来看，未见客服对此问题赔付。\n\n:::\n\n2024-08-31 16:00， 因为客诉量还在持续上涨，大部分用户对第一次布防方案不满意。CCO进行二次布防，布防话术是引导用户重新下单，已下单用户通过红包补差价。\n\n2024-08-31 17:00，**【ESU介入】**舆情监测异常，ESU感知介入。追踪第一条舆情为12：02，微博网名发布[https://weibo.com/7820385403/OuNxNnZw7](https://weibo.com/7820385403/OuNxNnZw7)\n\n2024-09-01 17:30，ump修复代码修改QA验证通过，提交UMP紧急发布申请，于9月3日完成发布，线上风险消除\n\n2024-09-02 17:00，针对受影响用户确认后续的补偿方案：[https://aliyuque.antfin.com/sz59uq/fdtwo2/rubbg0k7i75m2mbg?singleDoc#](https://aliyuque.antfin.com/sz59uq/fdtwo2/rubbg0k7i75m2mbg?singleDoc#) \n\n\n\n## 三、故障原因\n### 3.1【背景说明】\n【需求名称】手猫9N折商业化抽佣-一品多报\n\n【需求简介】手猫9N折商业化需求要放开优惠工具对商家提报，这样9N折就会存在平台圈品（老链路）和商家提报新链路的场景，如果招商支持双报，那么前台优惠的表达需要择优表达，否则会展示出多个相同的98折扣，影响用户体验。具体的产品需求细节[https://aliyuque.antfin.com/g/shaoting.gst/work/az7s2n50onr5gwsh/collaborator/join?token=jWhrRCASePzbMH1T&source=doc_collaborator#](https://aliyuque.antfin.com/g/shaoting.gst/work/az7s2n50onr5gwsh/collaborator/join?token=jWhrRCASePzbMH1T&source=doc_collaborator#) 《官旗折扣商业",
    "chunk_order_index": 2,
    "full_doc_id": "doc-671baf453dcde20b316c521b9fd46ce3"
  },
  "chunk-d4af043471e8eb18cd8148aff8523d63": {
    "tokens": 1200,
    "content": "az7s2n50onr5gwsh/collaborator/join?token=jWhrRCASePzbMH1T&source=doc_collaborator#](https://aliyuque.antfin.com/g/shaoting.gst/work/az7s2n50onr5gwsh/collaborator/join?token=jWhrRCASePzbMH1T&source=doc_collaborator#) 《官旗折扣商业化方案》\n\n【需求截图】一品多报场景展示\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/244704/1725286691056-6ecb5ce6-0dff-455f-8b00-ee3def5316cb.png) ![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/244704/1725280660059-0c989707-e06e-48f2-9d9e-6c71ca572be7.png)\n\n【需求关键逻辑】\n\n \t按照当时的需求定义9N折(96折或98折)活动存在**平台圈品完全补贴活动，商家提报0%抽佣活动，商家提报4%抽佣活动**等三种类型，产品的需求需要选择**优惠金额最大且佣金最高**的组合优惠。所以一个品最多可能报6个活动，分别是三个98折和三个96折活动。\n\n假如A品报了一个98折活动P1，B品报了98折活动P2和96折活动P3。如果用户在98折人群中，那么最优解是P1的98+P2的98折 组合优惠。实际优惠过滤会产生P1+P3，P1，P2，P3四种优惠组合，**其中P1+P3是最优组合优惠**，但是不符合人群过滤条件，返回的结果就会变成P1，P2两种独立的优惠。\n\n为了解决上述问题，需要把**人群的过滤逻辑放到优惠过滤逻辑之前**（扩展点为：GENERAL_PROMOTION#QUERY#FILTER_PROMOTION_SCOPE\u0000），把不满足人群条件的优惠，先行剔除，那可以保证优惠过滤逻辑组合出来的结果肯定是满足人群过滤条件的最优解，即能够返回P1+P2，P1，P2等三种独立的优惠选择。\n\n【需求变更代码截图】\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/244704/1725354446248-ec14852c-678f-46e2-a776-56ebfcf4334b.png)\n\n代码作者：世堤\n代码cr：昱彦\n【需求变更遗留问题】\n\n主要有四处问题：\n\n1. GENERAL_PROMOTION#QUERY#FILTER_PROMOTION_SCOPE\u0000，这个优惠过滤扩展点，没有过滤手淘的流量，手淘和手猫的流量的都会进来，没有进行限端，放大奥格的调用。\n2. 奥格服务调用在商品循环内部，这样就会按照商品数量进行放大，正常4个商品，3种优惠活动，需要3次奥格调用，实际上做了4*3次的人群校验。\n3. 每个优惠配置了两个人群标，调用奥格时没有调用批量接口，因此每次调用奥格的次数还会乘以2。\n4. 前置进行人群校验过滤后，工具本身的人群校验能力没有去掉，因此剩余的优惠还会多校验一次人群（无用调用）。\n\n### 3.2【原因分析】\n一句话原因：UMP调用奥格人群产生限流，导致优惠不生效，引起客诉\n\n根因分析：\n\n+ 08月31号叠纸心意旗舰店12:00开卖“恋与深空”游戏周边新品（商家的日常活动），抢购流量下单渲染QPS达到了7742，购物车流量达到5600+，下单QPS3750左右。\n+ 天猫APP9N折优惠产品包内查询奥格人群有调用放大问题（当前为优惠*商品叠加维度调用，可以修改成人群维度）\n+ 购物车（本身商品数就比较多）与订单渲染&下单（当时店铺有满188送赠品的活动）等有多商品请求场景，会将上述问题急剧放大（没有过滤手淘的流量，从流量上看，手淘流量是手猫的10倍，是主因）\n    - 流量组成上，200w 中，大部分为：（150K+15K）（手淘流量+手猫流量） * （4-10）（均商品数） * （2-3）（均9n优惠数）\n+ UMP调用奥格存在单机1000的限流值，12点后，该限流值被打破，导致部分奥格请求异常。由于下单逻辑不阻断，会继续下单，但无相关优惠。\n\n| 来源 | 手淘 | 手猫 | 备注 |\n| --- | --- | --- | --- |\n| 购物车query   QPS | 40K![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/246167/172527985",
    "chunk_order_index": 3,
    "full_doc_id": "doc-671baf453dcde20b316c521b9fd46ce3"
  },
  "chunk-b96c6b34848362085b2c46561a707a5a": {
    "tokens": 1200,
    "content": "限流值，12点后，该限流值被打破，导致部分奥格请求异常。由于下单逻辑不阻断，会继续下单，但无相关优惠。\n\n| 来源 | 手淘 | 手猫 | 备注 |\n| --- | --- | --- | --- |\n| 购物车query   QPS | 40K![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/246167/1725279854598-95344359-3ac6-467d-ba44-c6efd1837a64.png) | 3.3K![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/246167/1725280090621-aca8bea7-23c8-4feb-a848-77c12db7cfae.png) | 商品和活动会叠加放大，倍数会大于下单商品数，手猫、手淘一次加载50个品,9N折品人有均10.8个 |\n| 购物车异步query  QPS | 11K![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/246167/1725279893136-4c826296-5f94-44e3-9704-d4d0e9e7b8a6.png) | 2.2K![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/246167/1725183779011-357aebf5-3eb3-4939-95f1-ed60756da6c3.png?x-oss-process=image%2Fformat%2Cwebp%2Fresize%2Cw_750%2Climit_0) | 商品和活动会叠加放大，倍数会大于下单商品数，手猫、手淘一次加载50个品,9N折品人有均10.8个 |\n| 下单渲染  QPS | 77K![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/246167/1725279948968-7e66ea72-f8f7-488c-8a8a-89b1e02d2856.png) | 7.7K![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/246167/1725182824958-d111c0b5-1b19-49dd-b706-d187de0a13ce.png) | 下单商品数量峰值为平均4-6个 |\n| 下单创建  QPS | 20K![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/246167/1725279912833-8bd5c329-d342-44b2-bc3e-ceebc9c865b4.png) | 4.1K![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/246167/1725183508158-37dec27f-31b5-483c-8eea-8f62052004bd.png?x-oss-process=image%2Fformat%2Cwebp%2Fresize%2Cw_750%2Climit_0)![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/246167/1725183851135-a8cd6e55-e190-441a-873b-539e361f6531.png?x-oss-process=image%2Fformat%2Cwebp%2Fresize%2Cw_750%2Climit_0) | 下单商品数量峰值为平均4-6个![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/10179/1725289094074-19a7106f-9f08-4c06-bf7f-ded3883eecb6.png) |\n\n\n\n\n+ 叠纸新意旗舰店8月31日新品上架开卖前十分钟的全站订单分布\n\n| 12点时刻 | 子订单数量 | 主订单数 | 买家数量 |\n| --- | --- | --- | --- |\n| 12:00 | 1464373 | 275083 | 250665 |\n| 12:01 | 227602 | 57824 | 52354 |\n| 12:02 | 11683 | 4649 | 4613 |\n| 12:03 | 116 | 64 | 60 |\n| 12:04 | 144 | 45 | 45 |\n| 12:05 | 148 | 55 | 54 |\n| 12:06 | 94 | 49 | 48 |\n| 12:07 | 94 | 46 | 45 |\n| 12:08 | 68486 | 28057 | 24066 |\n| 12:09 | 266470 | 56556 | 50031 |\n| 12:10 | 4708 | 888 | 888 |\n\n\n+ 叠纸新意旗舰店8月31日新品从12点0分到12点15分未生效天猫APP88VIP折上折优惠订单：[https://fbi.alibaba-inc.com/dashboard/view/page.htm?spm=a2o1z.819007",
    "chunk_order_index": 4,
    "full_doc_id": "doc-671baf453dcde20b316c521b9fd46ce3"
  },
  "chunk-79d7c6463661aad074c0f052dc205609": {
    "tokens": 1200,
    "content": "| 24066 |\n| 12:09 | 266470 | 56556 | 50031 |\n| 12:10 | 4708 | 888 | 888 |\n\n\n+ 叠纸新意旗舰店8月31日新品从12点0分到12点15分未生效天猫APP88VIP折上折优惠订单：[https://fbi.alibaba-inc.com/dashboard/view/page.htm?spm=a2o1z.8190076.0.0.4b0a543fDoSiP7&id=1529905](https://fbi.alibaba-inc.com/dashboard/view/page.htm?spm=a2o1z.8190076.0.0.4b0a543fDoSiP7&id=1529905)\n\n截止到9月3号\n\n    - 涉及的主单：15,169\n    - 涉及的用户：13,385\n    - 涉及的补偿金额：113,942.57（无实际资损）\n\n## 四、关注点分析\n【关注点1】第一次业务决策布防后出了一波客诉高峰，是什么原因？\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/14646/1725116855558-2a0a488f-7f5c-42c5-bd66-ec5d8f034053.png?x-oss-process=image%2Fformat%2Cwebp%2Fresize%2Cw_879%2Climit_0%2Fresize%2Cw_879%2Climit_0)\n\n:::info\n【问题总结】服务端布防口径为：亲，很抱歉给您带来不好的体验，关于您反馈的这个问题目前已经解决，建议您可以重新下单享受折扣，感谢您对天猫APP的关注和支持。\n\n1. 用户不同意退款重拍，因为发货时间不一样。\n2. 客诉期间，有小二补偿了20元红包，事件在xhs上扩散，大量用户过来要红包。\n3. 布防方案：事件发生在周末，存在信息触达不及时的情况，且在群里具体的赔付方案没有明确，导致这个赔付方案没有及时落地。\n\n【改进方案】\n\n1. 此类问题服务布防口径出来后，处理方案出来之前，均增加强调禁止赔付；[@国燕](undefined/guoyan.lgy)\n2. 与cco协作sop。后续的营销活动，先提前做好风险布防预案[@子昕](undefined/yaping.yangyp)\n+ 安抚话术\n+ 涉及到价差的，需要确定是否可赔付。后续可以再出具体的赔付方案\n3. 若cco已经补偿红包的（看有没有自动化的工具进行记录），需要确认下针对这部分重复补偿的方案\n\n:::\n\n\n\n【关注点2】奥格的限流值是否有进行过评估和压测？为什么压测时没有发现问题？\n\n:::info\n【问题总结】\n\n奥格的限流在做业务的时候业务方未知，所以没有进行评估\n\n目前优惠是金本位的优惠，没有进入压测场景case\n\n【改进方案】\n\n [@世堤](undefined/lsd233424)线下确认方案 0919\n\n:::\n\n\n\n【关注点3】当时为什么选择调用奥格，不用uic标？\n\n:::info\n【问题总结】\n\n1.首先uic的写入是有延迟的，并不是准实时生效\n\n2.其次当时的业务要做很复杂的AB实验，走uic的方案做不了\n\n【改进方案】针对奥格使用场景进行重保，增加监控告警[@世堤](undefined/lsd233424) \n\n:::\n\n\n\n【关注点4】限流规则是哪方配置的？\n\n:::info\n【问题总结】由ump侧配置，配置的是接口维度单机限流，不区分业务\n\n【改进方案】\n\n1. UMP增加限流上调和下调的紧急预案，\n2. 奥格评估限流位点调整\n\n:::\n\n\n\n【关注点5】限端能力为啥不是框架层面支持，要每一次逻辑变更上手动添加？\n\n:::info\n【问题总结】优惠维度平台有通用端校验能力。在工具维度扩展点入参中平台框架传入了端信息，具备让业务自行校验的能力。\n\n【改进方案】平台无需改进。业务在新增业务逻辑时即需要明确扩展点的执行流程和影响面。\n\n需要业务侧关注，check list \n\n:::\n\n\n\n【关注点6】当前最优组合优惠，没有考虑人群条件，使得返回的最优解可能不满足条件，是否需要改进？\n\n:::info\n【问题总结】\n\nump优惠生成的叠加串是在人群过滤之前，会导致一品多报的场景出来的最优解不满足条件\n\n【改进方案】\n\n平台无需改进。\n\n不相交叠加（比如优惠工具T有P1、P2和P3三个活动，优惠P1可用在Item1和Item2，优惠P2可用在Item3和Item4，优惠P3可用在Item2和Item5，P1和P2可以叠加，P1和P3不能叠加，P2和P",
    "chunk_order_index": 5,
    "full_doc_id": "doc-671baf453dcde20b316c521b9fd46ce3"
  },
  "chunk-05d8233933eac42d3eac7d1f6082c1b6": {
    "tokens": 1200,
    "content": "最优解不满足条件\n\n【改进方案】\n\n平台无需改进。\n\n不相交叠加（比如优惠工具T有P1、P2和P3三个活动，优惠P1可用在Item1和Item2，优惠P2可用在Item3和Item4，优惠P3可用在Item2和Item5，P1和P2可以叠加，P1和P3不能叠加，P2和P3可以叠加）\n\n非不相交叠加的优惠是先过人群再做叠加，不相交叠加考虑到求最优解的复杂度，平台默认流程是先找出可能叠加的组合再根据叠加规则和其它优惠进行叠加，平台侧的解决方案是通过扩展点的方式前置过滤\n\n业务方自行关注，增加到check list@虎贝  \n\n:::\n\n\n\n【关注点7】奥格当前作为9N折强依赖的服务，后续如何监控和保障稳定性？\n\n:::info\n【问题总结】ump对奥格限流的监控[@孜于](undefined/liming.slm)关注下其他接口的限流风险\n\n【改进方案】针对手猫定制人群的告警需要订阅[@世堤](undefined/lsd233424)[@孜于](undefined/liming.slm) 0913\n\n调用老的奥格服务需要关掉[@世堤](undefined/lsd233424)0913\n\n奥格定制人群的重保[@世堤](undefined/lsd233424)[@一字](undefined/yizi.lzh) 0913\n\n:::\n\n\n\n【关注点8】流量放大的问题的排查[@虎贝](undefined/wuhan.hwh)双11前\n\n### 4.1【系统质量】\n#### 4.1.1 需求&设计评估 不涉及\n**〖关注点1〗****是否涉及产品、技术方案评估？此核心的问题是什么，如何改进？**\n\n- [x] **是，涉及**\n    - [ ] 需求评估遗漏\n    - [ ] 产品设计缺陷\n    - [ ] 系统架构设计缺陷\n        - [ ] 容错性不足 \n        - [ ] 单点，无冗余\n        - [ ] 缺乏自我保护\n        - [ ] 缓存设计不当\n        - [ ] 容量评估不足\n        - [ ] 非幂等设计\n        - [ ] 强弱依赖不合理\n        - [x] 其他：__一品多报业务需求针对折上折过于复杂______\n- [ ] 否，不涉及\n\n**〖问题总结〗**\n\n**〖改进点〗**_**需明确写明不同故障相关方的改进项（若有的话），下同。**_\n\n\n\n#### 4.1.2 代码质量\n**〖关注点1〗是否代码自身存在漏洞或BUG、代码健壮性是否存在问题等?**\n\n**〖问题分析〗代码中存在调用放大问题，根据活动个数和商品个数乘数放大**\n\n**〖改进点〗**_****_\n\n1、把现有的分活动、人的奥格调用，改为批量一次调用奥格请求。\n\n\n\n**〖关注点2〗****是否经过CodeReview？CodeReview阶段是否发现问题？为何没发现？**\n\n+ **是否经过CR**\n    - [x] 是\n    - [ ] 否\n    - [ ] 不涉及\n+ **是否设置合理的CR卡点**\n    - [x] 是\n    - [ ] 否\n    - [ ] 不涉及\n+ **CodeReview阶段是否发现问题？为何没发现？后续如何发现？**\n    - [ ] 是\n    - [x] 否\n    - [ ] 不涉及\n\n**〖问题分析〗****CR过程中没有没有意识到会存在奥格限流，以为只是一次本地调用，没有完全评估影响面。**\n\n**〖改进点〗**_****_\n\n1、以后针对for循环的调用，要严格控制外部依赖调用。\n\n2、促销的改动，需要组内多轮CR，和ump开发人员交叉CR。\n\n\n\n**〖关注点3〗****测试阶段**\n\n+ **测试内容：**涉及的测试提交单、测试用例等\n+ **测试人员：**\n+ **是否经过测试验证**\n    - [x] 是，验证环境\n        - [x] 预发环境\n        - [ ] 日常环境\n    - [x] 是，测试方法\n        - [ ] 单元测试\n        - [x] 功能回归测试\n        - [x] 集成测试/链路测试\n        - [x] 验收测试\n    - [ ] 否\n    - [ ] 不涉及\n+ **测试未发现原因是什么？后续如何改进？**\n    - [ ] 回归测试遗漏\n        - [ ] 手工回归测试用例遗漏\n        - [ ] 自动化未建设\n        - [ ] 自动化回归覆盖不足\n        - [x] 其他：__无法通过功能验证发现________\n    - [ ] 新场景测试遗漏\n        - [ ] 功能测试用例遗漏，包括正常分支和异常分支\n        - [ ] 容灾兜底测试遗漏\n        - [ ] 客户端",
    "chunk_order_index": 6,
    "full_doc_id": "doc-671baf453dcde20b316c521b9fd46ce3"
  },
  "chunk-cca974577aa2d0897d43c55e28de760b": {
    "tokens": 1200,
    "content": "遗漏\n        - [ ] 手工回归测试用例遗漏\n        - [ ] 自动化未建设\n        - [ ] 自动化回归覆盖不足\n        - [x] 其他：__无法通过功能验证发现________\n    - [ ] 新场景测试遗漏\n        - [ ] 功能测试用例遗漏，包括正常分支和异常分支\n        - [ ] 容灾兜底测试遗漏\n        - [ ] 客户端兼容性测试遗漏\n        - [ ] 埋点测试遗漏\n        - [ ] 性能测试遗漏，影响评估不足\n        - [ ] 安全测试遗漏\n    - [x] 其他：____无法评估有这么大流量产生______\n\n**〖问题总结〗大流量场景下才会触发，测试时无法发现**\n\n**〖改进点〗放checklist：看调用链路。代码路径是否符合预期**\n\n\n\n#### 4.1.3 变更质量\n+ **是否涉及变更：**\n    - [x] 是\n    - [ ] 否\n+ **变更类型：**\n    - [x] 代码发布\n    - [ ] 配置变更\n    - [ ] 其他变更：____________\n    - [ ] 不涉及\n+ **变更平台是否接入ChangeFree：**\n    - [x] 是，CF变更单链接：__[https://aicf.alibaba-inc.com/aicf/approval/detail/7781031](https://aicf.alibaba-inc.com/aicf/approval/detail/7781031)______\n    - [ ] 否\n+ **是否违反变更红线3.1**** **[链接](https://aliyuque.antfin.com/ngoc/fzg6dy/uar1k6)\n    - [ ] 是，违反哪条原则：\n    - [x] 否\n\n\n\n**〖关注点1〗****灰度阶段**\n\n+ **是否经过灰度：**\n    - [x] 是\n    - [ ] 否\n+ **观测了哪些监控**：_可以附链接_\n    - [ ] 黑屏、白屏\n    - [x] GOC监控：\n    - [x] 系统大盘：\n    - [ ] 其他：___________\n+ **是否灰度期间发现问题？**\n    - [ ] 是\n        - [ ] 是否灰度流量过大，导致故障\n        - [ ] 灰度发现但未有效或及时修复，导致故障\n        - [ ] 其他：___________\n    - [x] 否，后续如何灰度发现？____灰度流量比较少无法发现_____\n+ **未灰度发现原因**\n    - [ ] 应用灰\n        - [x] 灰度流量太小\n        - [ ] 灰度阶段无监控\n        - [ ] 灰度批次不合理\n        - [ ] 超长时间灰度才能发现\n    - [ ] 业务灰：策略不合理\n    - [ ] 灰度无法发现\n    - [ ] 其他：_____________\n\n**〖问题总结〗**灰度流量比较少无法发现\n\n**〖改进点〗**_****_\n\n1、无\n\n\n\n**〖关注点2〗****上线阶段**\n\n+ **是否有确定的监控观测指标**\n    - [x] 是，监控指标及监控链接：手猫交易大盘：[https://xflush.alibaba-inc.com/custom/42/product/preview/cms/1172](https://xflush.alibaba-inc.com/custom/42/product/preview/cms/1172)\n    - [ ] 否\n+ **是否在窗口期进行发布变更**\n    - [x] 是\n    - [ ] 否，原因：\n+ **变更是否影响上下游**\n    - [ ] 是，是否有提前知会上下游评估及关注变更\n        - [ ] 有提前知会\n        - [ ] 没有提前知会\n    - [x] 否\n\n**〖问题总结〗目前是渲染和提交不一致**\n\n**〖改进点〗**_****_\n\n1. 补充订单渲染场景下生效了88VIP折上折优惠监控\n2. 补充订单创建场景下勾选88VIP折上折优惠监控\n3. 增加流量侧的埋点，特别是订单渲染[@孜于](undefined/liming.slm)\n\n### 4.2【处置能力】\n#### 4.2.1 故障发现&响应\n+ **是否监控发现**\n    - [x] 故障触发方 监控发现\n    - [ ] 故障受影响方 监控发现\n    - [ ] 否，原因为：（监控无效/监控缺失）\n+ **是否5分钟内响应**\n    - [x] 是\n    - [ ] 否，原因为：\n+ **是否存在应急协同问题**\n    - [x] 是\n        - [ ] 应急流程不明确（无流程或者流程不清晰、应急相关角色&职责不明确，缺失一号位等)\n        - [ ] 应急执行不到位（有流程，但未按流程执行，通告发送不及时，响应不及时等）\n    - [ ] 否\n\n**〖问题总结〗开发侧不知道会出现爆发式商品",
    "chunk_order_index": 7,
    "full_doc_id": "doc-671baf453dcde20b316c521b9fd46ce3"
  },
  "chunk-f7cff826047964442a70c30b2a05040a": {
    "tokens": 1200,
    "content": "是否存在应急协同问题**\n    - [x] 是\n        - [ ] 应急流程不明确（无流程或者流程不清晰、应急相关角色&职责不明确，缺失一号位等)\n        - [ ] 应急执行不到位（有流程，但未按流程执行，通告发送不及时，响应不及时等）\n    - [ ] 否\n\n**〖问题总结〗开发侧不知道会出现爆发式商品抢购行为，没有做相应的保障机制。**[@贝酱](undefined/hb233852)\n\n**〖改进点〗**_****_\n\n1、后续热点商家、商品保障，运营是否能提前通知到产技侧。\n\n2、针对热品、爆品上线时间段，启动产技重点保障流程。\n\n#### 4.2.2 故障定位&恢复\n+ **主要恢复方式：**\n    - [ ] 代码发布/回滚\n    - [ ] 配置发布/回滚\n    - [ ] 数据订正\n    - [ ] 机器隔离/重启/扩容\n    - [x] 配置限流\n    - [ ] 预案降级\n    - [x] 自动恢复：**抢购流量峰值后，活动自动恢复。**\n    - [ ] 其他：****\n+ **是否10分钟内恢复**__\n    - [x] 是\n    - [ ] 否，原因：_______\n\n**〖关注点1〗定位&恢复阶段存在什么问题？是否可以增加预案，****有更快的恢复方式？****相关的优化改进？**\n\n**〖问题总结〗抢购峰值过后系统自动恢复**\n\n**〖改进点〗**\n\n\n\n**〖关注点2〗业务自身是否具备容灾逃逸能力？后续如何改进？**__\n\n- [x] 不具备容灾能力\n\n**〖问题总结〗没有评估到会触发奥格限流，触发大面积活动失效场景，没有制定活动失效应对策略。**\n\n**〖改进点〗**\n\n1、需要**制定手猫折上折活动失效应对策略，已经对于的CCO应对话术。**\n\n**2、评估链路中是否存在其他依赖，会导致的活动失效场景。**\n\n#### 4.2.3 SRE应急参与（淘天业务技术参考）\n+ **SRE工程师应急参与**：__\n    - 是否响应\n        - [x] 是\n        - [ ] 否\n    - 是否帮助定位\n        - [x] 是\n        - [ ] 否，备注：__________\n        - [ ] 未参与，备注：__________\n    - 是否操作恢复/提出有效恢复方案\n        - [x] 是\n        - [ ] 否，备注：__________\n        - [ ] 未参与，备注：__________\n+ **SRE专家是否有效指挥**\n        - [x] 是\n        - [ ] 否，备注：__________\n        - [ ] 未参与，备注：__________\n\n\n\n## 五、故障Action\n| **序号** | *******Action** | *******负责人** | *******计划完成时间** |\n| --- | --- | --- | --- |\n| 1 | 短期：UMP中的奥格限流从单机1000 调整为单机2000，当时的止血方案 | [@文安](undefined/rencong.rc) | 已完成 |\n| 2 | 短期：奥格与UMP侧一起评估限流位点（是否限流后置）与 限流值 | [@孜于](undefined/liming.slm) | 0913 |\n| 3 | 短期：UMP侧增加针对奥格的限流预案，增加一个单机1000和一个单机为3000的应急预案 | [@道昭](undefined/wz267333) | 已完成 |\n| 4 | 短期：天猫侧 96折产品包逻辑改造 | [@世堤](undefined/lsd233424) | 已完成 |\n| 5 | 短期：评估99及双十一后续大促是否有活动流量，并评估加入压测模型 | [@国梓](undefined/guozi.yf)[@世堤](undefined/lsd233424) | 9.19前 |\n| 6 | 短期：评估本次受影响订单情况以及处理补偿方案：[方案详情](https://aliyuque.antfin.com/sz59uq/fdtwo2/rubbg0k7i75m2mbg?singleDoc#) | [@虎贝](undefined/wuhan.hwh) | 已完成 |\n| 7 | 短期：需要确认已赔付用户名单，将这部分用户从后续补偿方案中剔除 | @国燕 | 9.06无法核对到是对应故障的赔付 |\n| 8 | 短期：制定针对奥格限流的压测方案 | [@世堤](undefined/lsd233424) | 0919 |\n| 9 | 短期：针对奥格使用场景进行重保，增加监控告警 | [@世堤](undefined/lsd233424) | 0913 |\n| 10 | 短期：调用老的奥格服务需要",
    "chunk_order_index": 8,
    "full_doc_id": "doc-671baf453dcde20b316c521b9fd46ce3"
  },
  "chunk-47df9d09f8bf7481948bfcec6dd7f2ac": {
    "tokens": 1200,
    "content": "赔付 |\n| 8 | 短期：制定针对奥格限流的压测方案 | [@世堤](undefined/lsd233424) | 0919 |\n| 9 | 短期：针对奥格使用场景进行重保，增加监控告警 | [@世堤](undefined/lsd233424) | 0913 |\n| 10 | 短期：调用老的奥格服务需要关掉 | [@世堤](undefined/lsd233424) | 0913 |\n| 11 | 短期：针对风险数据没有提前准备，导致评估影响范围花费了比较长的时间，针对9N折人群进行梳理 | [@一字](undefined/yizi.lzh) |  |\n| 12 | 长期：人群优惠未生效的问题是否可以加自动化补偿方案？可以参考下价保方案 |  |  |\n\n\n## 六、故障总结反思\n**【做得好的】**\n\n   1、线上故障发生时候，业务监控及时发现并且报警，通知到值班人员进行应急相应。\n\n   2、启动应急流程后，第一时间拉起电话会议，通知对应业务、技术、SRE一起应急定位、解决问题。\n\n**【经验教训】**\n\n举一反三，学习，避免踩坑\n\n1、针对潜在的热点抢购的商品以及配置优惠，希望能提前通知到产技侧做重点保障。\n\n2、后对促销代码改动，要与平台侧开发&组内开发交叉CR。\n\n3、针对风险数据没有提前准备，导致评估影响范围花费了比较长的时间，针对9N折人群进行梳理[@一字](undefined/yizi.lzh)\n\n4、后续针对新增性平台工具，要做极限流量压测，覆盖业务测试不能出现的问题。\n\n5、手猫有一些自己的人群营销工具，主要基于奥格平台，需要有针对特定人群访问量监控视图\n\n\n\n**【代码修复方案】**\n\n产品包代码修复CR：[https://code.alibaba-inc.com/business-apps/sjtm88vipdiscount-product/codereview/18176368](https://code.alibaba-inc.com/business-apps/sjtm88vipdiscount-product/codereview/18176368)\n\n核心修改点：\n\n```plain\n1.限制手淘端的流量进来\n在优惠过滤扩展点上直接拦截手淘端的流量\nString ttid = Optional.ofNullable(invokeInfo.getClientInfo())\n        .map(a -> a.getAppInfo())\n        .map(a -> a.getTtid()).orElse(\"\");\n//不是手猫端需求，直接过滤\nif (!BlackVipUtils.isTmallMobile(ttid)) {\n    return;\n}\n\n\n2.人群校验走一次批量的人群查询\npublic static Map batchCrowdCheck(List modelList, Long userId,String marketPlace) {\n\n\n\n```\n\n\n\n## 七、影响产品线&影响面\n- [ ] 是否影响可用性：否\n\n可用性影响说明：手猫端的其他商品购买无明显影响，搜索、导购、购后链路无明显影响。\n\n\n\n- [x] 业务影响：\n\n业务影响说明：\n\n+ 截止9月2日？\n+ 截止8月31日20:00，叠纸心意店铺下单可用但未生效优惠的用户待支付&已支付的订单支付金额待支付&已支付的订单共14054笔，用户11867人，支付金额296.8万，最大补偿优惠金额11.8万（按支付金额96折计算、包含用户主动取消专享优惠用户)。\n\n\n\n- [x] 是否有客诉：\n\n客诉影响说明：\n\n+ 故障期间：08-31 12:00-12:15 客诉总量126例（小蜜26例，在线人工100）\n+ 截止8月31日 13:02（限流恢复日常时间点，限流qps于8月31日13:02恢复到8月30日的1000qps以下，同8月31日11:30的限流水位），419条客户原声，订单去重382笔，其中未生效优惠258笔258位用户，即有效客诉258条。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/10179/1725285982794-ce967ea5-151d-440d-99cd-3ede93f5520f.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/10179/1725286090434-7ef37518-00f6-487e-8bb8-2f657c89d555.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/10179/1725286506913-7405d8a2-7c46-48b4-8b71-c4b87108b350.png)\n\n\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/10179/1725286116295-9fc0f70b-ff35-433f-a10a-fb45b13b9e8f.png)\n\n+ 截止8月31日 15:00（CCO话术布防时间点），1120条",
    "chunk_order_index": 9,
    "full_doc_id": "doc-671baf453dcde20b316c521b9fd46ce3"
  },
  "chunk-555399504d9330781baead9bc7bdf4b3": {
    "tokens": 237,
    "content": "-48b4-8b71-c4b87108b350.png)\n\n\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/10179/1725286116295-9fc0f70b-ff35-433f-a10a-fb45b13b9e8f.png)\n\n+ 截止8月31日 15:00（CCO话术布防时间点），1120条客户原声，订单去重942笔，其中未生效优惠451笔450位用户，即有效客诉451条。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/14646/1725116855558-2a0a488f-7f5c-42c5-bd66-ec5d8f034053.png?x-oss-process=image%2Fformat%2Cwebp%2Fresize%2Cw_879%2Climit_0)\n\n- [x] 是否有社会舆情_：_\n\n舆情影响说明：22条",
    "chunk_order_index": 10,
    "full_doc_id": "doc-671baf453dcde20b316c521b9fd46ce3"
  },
  "chunk-c2c1d85a9f4c67b9147858cd7ac34c8b": {
    "tokens": 1200,
    "content": "## 一、故障简述\n【P4】2024-09-05 15:55 fiber-api 触发报警阈值70%，调度同学收到报警，访问较大范围失败，业务同学陆续反馈有页面打开失败，客诉量级触达P5故障，因16:50左右累计客诉量：20+，故障升级至P4，由于fiber-api重启过程中 DB 被其他业务慢 sql 拖累导致 DB CPU 100%，导致 fiber-api 启动无法成功，并且 fiber-api 做了数据分列，生产分为 2 列，出问题时单列不可用，意味着 Aone Serverless + TPP 一半业务不可读写（TPP 弹性链路不受影响）。于17:00 DB侧慢sql 恢复，fiber-api 重启成功，故障恢复。\n\n## 二、故障过程回顾\n### 2.1【故障处理时间线】\n| **时间轴** | **事件** |\n| --- | --- |\n| 2024-09-05 15:26 | dosa 应用因为metaspace 满，需要走发布链路重启，提交了全量发布单**【故障注入】** |\n| 2024-09-05 15:27 | 发布任务提交后，CPU 从20% 上升到55%，业务反馈页面打开有些卡，访问接口很慢，由于一直在关注dosa发布，此时调度同学已经在开始介入，但还未定位到fiber-api的问题，请求部分超时，并未完全失败 |\n| 2024-09-05 15:55 | fiber-api 触发报警阈值，70%，CPU显著再上升一次，调度同学收到报警，开始介入fiber-api的排查，此时访问较大范围失败，业务同学陆续反馈有页面打开失败**【故障发现】【故障响应】** |\n| 2024-09-05 16:05 | CPU 持续上升，这个过程也触发fiber-api.go_routines 的增长，直至16:05 fiber-api 触发OOM，服务挂掉 **【初因定位】** |\n| 2024-09-05 16:07 | 上述OOM 之后，在16:07重启成功 ，但是堆积的请求，迅速将CPU再次打满**** |\n| 2024-09-05 16:21 | 再次OOM |\n| 2024-09-05 16:21-17:00  | 这个过程中反复重启，但是因为Load DB 数据失败，重启一直不成功，重启不成功原因是因为 drogo 业务的慢sql 引起 ，由于dbservice 时间单位不准确，导致一直没有定位到时慢sql的原因 |\n| 2024-09-05 16:42 | 累计客诉达5例 **【故障发生】** |\n| 2024-09-05 16:52 | 持续的fiber-api失败，引起除dosa业务侧的反馈 GOC风险预警 |\n| 2024-09-05 17:00 | DB侧慢sql 恢复，fiber-api 重启成功，自动恢复**【故障恢复】 ** |\n| 2024-09-05 17:52  | 执行fiber-api 的节点升配并完成，缓解后续可能的CPU 问题**【恢复执行】【影响消除】 ** |\n| 2024-09-05 18:00- 2024-09-06 03:00  | 根因定位到为慢sql问题及性能问题**【根因定位】****【后续排查】参考：**[**《2024.09.05 Serverless 调度管控挂掉》**](https://aliyuque.antfin.com/search-infra/pufssx/svs5uwtez27wmo7e?singleDoc#)** ** |\n\n\n\n\n### 2.2【时间线概览】\n![画板](https://intranetproxy.alipay.com/skylark/lark/0/2024/jpeg/149256407/1725961019519-30a31310-e8a1-447a-a08f-f439c1dcfcdd.jpeg)\n\n## 三、故障原因\n### 3.1【背景说明】\n#### 【需求背景】\n:::tips\nfiber-api 是Aone Serverless 中一个管控链路组件，是负责Aone Serverless APP的任务发布以及对外统一接口的服务\n\n:::\n\n#### 【业务链路】\n参考：[Serverless 调度系统依赖](https://aliyuque.antfin.com/search-infra/pufssx/crst7rw216tn66h0)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/9648/1725623904955-af902b43-32f0-4dd6-b29f-efba80094dba.png)\n\n### 3.2【原因分析】\n#### 一句话原因：\n:::tips\ndosa app 下午对 三个生产集群发布，由于关注人较多，同时打开 aone 发布页面，导致打到 Serverless 调度管控组件（fiber-api）流量过高（性能太差），引起 fiber-api CPU 100%及 OOM。OOM 后重启过程中由于启动时 DB 被其他业务慢 sql 拖累导致 DB CPU 100%，导致 fiber-api 启动无法成功。后由于",
    "chunk_order_index": 0,
    "full_doc_id": "doc-7519dce2612d4b418dcbdf6b43d83b30"
  },
  "chunk-2e3a772c0b5761c3431fe29acb0d035c": {
    "tokens": 1200,
    "content": "一句话原因：\n:::tips\ndosa app 下午对 三个生产集群发布，由于关注人较多，同时打开 aone 发布页面，导致打到 Serverless 调度管控组件（fiber-api）流量过高（性能太差），引起 fiber-api CPU 100%及 OOM。OOM 后重启过程中由于启动时 DB 被其他业务慢 sql 拖累导致 DB CPU 100%，导致 fiber-api 启动无法成功。后由于慢 SQL 执行完成 DB CPU 恢复后，fiber-api 启动成功而恢复。\n\n:::\n\n#### 根因分析：\n##### 性能恶化问题\n15:27 dosa 对 3 大生产集群（近 3000 容器）做了发布：\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/9648/1725543802323-3e41d092-2748-4ebc-9c04-61f7e9e1adef.png)\n\n下图中，fiber-api 在 15:27 有了显著的 cpu 上升。在 15:58 又有一波上升。16：05 后 OOM 重启。16:21 再次 OOM。后在 17:00 之前一直反复重启，均未重启成功。17:00 后重启成功恢复。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/9648/1725543698179-405c3b54-73ca-4a5a-ae45-dca99b97d39c.png)\n\n按分钟流量数据：\n\n```shell\n\n$grep -E '2024:15:[345]' access.log  | awk -F '[' '{print $2}' | awk -F ':' '{print $1, $2,$3}' | sort | uniq -c \n   4552 05/Sep/2024 15 30\n   4596 05/Sep/2024 15 31\n   5111 05/Sep/2024 15 32\n   4939 05/Sep/2024 15 33\n   4313 05/Sep/2024 15 34\n   4922 05/Sep/2024 15 35\n   5225 05/Sep/2024 15 36\n   5113 05/Sep/2024 15 37\n   5635 05/Sep/2024 15 38\n   5468 05/Sep/2024 15 39\n   5481 05/Sep/2024 15 40\n   5306 05/Sep/2024 15 41\n   5070 05/Sep/2024 15 42\n   4758 05/Sep/2024 15 43\n   4721 05/Sep/2024 15 44\n   4866 05/Sep/2024 15 45\n   5160 05/Sep/2024 15 46\n   5033 05/Sep/2024 15 47\n   5179 05/Sep/2024 15 48\n   5803 05/Sep/2024 15 49\n   4978 05/Sep/2024 15 50\n   5173 05/Sep/2024 15 51\n   5427 05/Sep/2024 15 52\n   5269 05/Sep/2024 15 53\n   5580 05/Sep/2024 15 54\n   6323 05/Sep/2024 15 55\n   5707 05/Sep/2024 15 56\n   5837 05/Sep/2024 15 57\n   6598 05/Sep/2024 15 58\n   6055 05/Sep/2024 15 59\n\n   6536 05/Sep/2024 16 00\n   7246 05/Sep/2024 16 01\n   8397 05/Sep/2024 16 02\n   3597 05/Sep/2024 16 03\n    200 05/Sep/2024 16 04 # oom\n   4275 05/Sep/2024 16 05\n   6264 05/Sep/2024 16 06\n   8112 05/Sep/2024 16 07\n   7978 05/Sep/2024 16 08\n   6974 05/Sep/2024 16 09\n   5637 05/Sep/2024 16 10\n   6370 05/Sep/2024 16 11\n   6119 05/Sep/2024 16 12\n   6422 05/Sep/2024 16 13\n   7208 05/Sep/2024 16 14\n   6563 05/Sep/2024 16 15\n   5995 05/Sep/2024 16 16\n   5652 05/Sep/2024 16 17\n   5187 05/Sep/2024 16 18\n   5050",
    "chunk_order_index": 1,
    "full_doc_id": "doc-7519dce2612d4b418dcbdf6b43d83b30"
  },
  "chunk-1537255748b3aa15d114f5356bf0e7d6": {
    "tokens": 1200,
    "content": "6422 05/Sep/2024 16 13\n   7208 05/Sep/2024 16 14\n   6563 05/Sep/2024 16 15\n   5995 05/Sep/2024 16 16\n   5652 05/Sep/2024 16 17\n   5187 05/Sep/2024 16 18\n   5050 05/Sep/2024 16 19\n   3400 05/Sep/2024 16 20\n```\n\nAone 侧观测到的流量：\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/9648/1725849114704-05e39459-0e2e-4c9f-b3bc-e5a19467029b.png)\n\n流量分布与正常情况下不同：\n\n```shell\n     12  /scene/dosa.ea119.dosa.24b5622da46c3df4/Task\n     12  /scene/dosa.na610.dosa.4c957f395218a45e/Task\n     12  /scene/dosa.na620.dosa.9d476544992263b2/Task\n     39  /scene/dosa.ea118.dosa.223267be66062b04/Status\n     40  /scene/dosa.ea118.dosa.788ba79c684fbfce/Status\n     40  /scene/dosa.ea119.dosa.24b5622da46c3df4/Status\n     40  /scene/dosa.na175.dosa.bd9e4fbac1156340/Status\n     40  /scene/dosa.na610.dosa.4c957f395218a45e/Status\n     40  /scene/dosa.na620.dosa.9d476544992263b2/Status\n     40  /scene/dosa.na62.dosa.524090a0a6ad294c/Status\n     45  /v2/scene/dosa/BriefStatus\n    489  /v2/scene/dosa/Plan\n   2477  /v2/scene/dosa/nodes\n```\n\n正常情况下 nodes 接口与 Plan 接口数量接近一致。15:55 开始 nodes 接口就开始增多。\n\n15:58 的时候，fiber-api 总 QPM 6598，其中 dosa 2966 QPM。该流量中，涉及获取 dosa pods 的接口 QPM 2477。由于 dosa 此时机器较多（3000），导致 fiber-api 性能急剧恶化。\n\n对应协程数急剧增长，日常 600，高峰 7000+ 。协程数反映了对外服务消耗的资源，间接佐证结论：\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/9648/1725544404702-3cbe0e30-c739-4051-9a47-e88ad52d1566.png)\n\n（15:58 后 CPU 接近满，也引起写 DB 耗时增加（协程调度受影响），该现象容易误导问题分析）：\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/9648/1725595913664-8811894e-c987-4690-8003-08304976392e.png)\n\n15:37 提交发布后，cpu 直接涨了 20%，证明为性能问题，而非流量重试之类的 BUG。15:57 之前，流量有自然增长，但 err qps 并未上涨，说明并非 user level error 导致上游重试。15:57 之后流量暴涨，大概率就是用户行为导致。整个链路经过沟通确认，系统层面没有重试逻辑。\n\n##### 重启失败问题\n16:21 ~ 17:00 之间重启无法成功，主要是因为 drogo 侧业务访问 role_log 表存在慢 SQL 引起 DB CPU 100%，由于 DB 共用，DB无法及时响应引起 fiber-api 启动失败。\n\n```shell\nI0905 16:40:14.728031     123 scene_prototype.go:266] load task 1f58a68d8b356f49a6e6baa4d90fa7be success for scene glaucus-online.na175.2475\nE0905 16:40:14.732980     123 db.go:168] query rows failed [select hippo_id,carbon_id, scene_list.sid as sid, scene_list.biz as biz, scene_list.cluster as cluster, scene_list.tid as tid,zone_id, scene_task.status as status, loc, mlabels\n                from scene_list left join scene_task on scene_task.tid = scene_list.tid] [invalid connection]\nI0905 16:40:49.327100     123 scene_prototype.go:248] load scene list used 39997 ms\nE0905 16:40:49.327127     123 replica_manager.go:27] load all object failed: invalid connection\nI0905 16:40:49.327139     123 elect_app.go:105] shutdown elect app\n\n```\n\n```shell\nI0905 16:41:02.542380   17069 elect_app.go:127",
    "chunk_order_index": 2,
    "full_doc_id": "doc-7519dce2612d4b418dcbdf6b43d83b30"
  },
  "chunk-9c59e6fcf6b58904df6923a2203a946e": {
    "tokens": 1200,
    "content": "100     123 scene_prototype.go:248] load scene list used 39997 ms\nE0905 16:40:49.327127     123 replica_manager.go:27] load all object failed: invalid connection\nI0905 16:40:49.327139     123 elect_app.go:105] shutdown elect app\n\n```\n\n```shell\nI0905 16:41:02.542380   17069 elect_app.go:127] elect done, signal elect monitor stopped\nE0905 16:41:02.550188   17069 db.go:154] query rows failed [select hippo_id,carbon_id, scene_list.sid as sid, scene_list.biz as biz, scene_list.cluster as cluster, scene_list.tid as tid,zone_id, scene_task.status as status, loc, mlabels\n                from scene_list left join scene_task on scene_task.tid = scene_list.tid] [Error 1317: [188ac6d0dec00000][33.62.179.56:8507][DROGO_APP]ERR-CODE: [TDDL-4614][ERR_EXECUTE_ON_MYSQL] Error occurs when execute on GROUP 'DROGO_GROUP' ATOM 'cn-zhangjiakou_i-8vbip9tv7wwvk8rdfebi_drogo_3016': Query execution was interrupted More: [http://middleware.alibaba-inc.com/faq/faqByFaqCode.html?faqCode=TDDL-4614]]\nI0905 16:41:02.550284   17069 scene_prototype.go:248] load scene list used 7 ms\nE0905 16:41:02.550296   17069 replica_manager.go:27] load all object failed: Error 1317: [188ac6d0dec00000][33.62.179.56:8507][DROGO_APP]ERR-CODE: [TDDL-4614][ERR_EXECUTE_ON_MYSQL] Error occurs when execute on GROUP 'DROGO_GROUP' ATOM 'cn-zhangjiakou_i-8vbip9tv7wwvk8rdfebi_drogo_3016': Query execution was interrupted More: [http://middleware.alibaba-inc.com/faq/faqByFaqCode.html?faqCode=TDDL-4614]\n\n```\n\n（ 期间做过一次资源规格变更的动作，试图升配，但由于封网被管控变更单实际没生效，应急时去黑屏处理 dosa 发布任务所以没关注变更单情况。）\n\n下图显示 16:18 ~ 16:55 附近 CPU 100%：\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/9648/1725544683252-ce3fad6d-49ce-463f-abd7-01cf50d995a6.png)\n\nDB CPU 100%原因：\n\n15:20 ~ 17:05 SQL 耗时占比，下图中主要是 select role_log 表引起。且 22 次查询中 20 次失败：\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/9648/1725595431769-4f2237b4-deb6-42bc-85f8-ce9669d95c36.png)\n\n在 SQL 详情中，显示开始执行 16:18，多条失败+成功的 SQL 耗时 2000s+，开始与结束时间与 CPU 满时间吻合。执行慢的 SQL 都为同一个业务触发（主要是业务在发布时点击查看「调度日志」引起）：\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/9648/1725595673991-6d0e2875-37e3-468b-8643-7843d8eb01c2.png)\n\n该表 80,654,644 行数据，每次触发全量扫描。\n\n## 四、关注点分析\n**〖关注点1〗**** 本次变更是否在变更窗口内，是否符合云侧的变更规范，变更灰度过程是否有效，灰度未发现的原因是什么，后续应如何改进。**\n\n:::tips\n**〖问题总结〗**\n\n不涉及变更，只是变更触发，fiber-api自身业务对流量过大场景承载能力不足\n\n**〖改进点〗**\n\n**管控容量不足，优化链路，增强处理能力**\n\n1、[DONE] 针对发布页面获取 Pods 接口（准确来说是获取 Serverless App 节点实例），由于其本身无状态，可以直接实现在 fiber-api gateway 侧，从而支持水平扩展。(9.6 凌晨发布)\n\ngateway水平扩容\n\n2、[DONE] 屏蔽 role_log 慢 sql 功能解决\n\n3、从当前 2 shard 拆分到 4 shard，降低单 shard 挂掉影响面   0930\n\n4、[DONE] DB 配置 CPU/MEM/慢 SQL 报警\n\n** **[@尘定](undefined/fengjianhui.fjh) **  0930**\n\n:::\n\n****\n\n**〖关注点2〗** 是否监控发现，报警阈值是否设置合理？\n\n:::tips\n**〖问题总结〗**\n\n是监控发现，70报警阈值\n\n**〖改进点〗**\n\n从观察到的 CPU 数据来看，性能恶化",
    "chunk_order_index": 3,
    "full_doc_id": "doc-7519dce2612d4b418dcbdf6b43d83b30"
  },
  "chunk-461e0a0b20c67ea06a10dceb0cbd7bb7": {
    "tokens": 1200,
    "content": "DONE] DB 配置 CPU/MEM/慢 SQL 报警\n\n** **[@尘定](undefined/fengjianhui.fjh) **  0930**\n\n:::\n\n****\n\n**〖关注点2〗** 是否监控发现，报警阈值是否设置合理？\n\n:::tips\n**〖问题总结〗**\n\n是监控发现，70报警阈值\n\n**〖改进点〗**\n\n从观察到的 CPU 数据来看，性能恶化较快，性能也很差，尤其在 15:58 增加 2000 流量后，需要构建压测环境 perf 下性能曲线\t0930  产出压测文档  验收人：沙羽\nfiber-api 触发报警阈值调整50%，\t[@尘定](undefined/fengjianhui.fjh)   0913\nserverless报警场景新增评估\t\t[@少荃](undefined/shaoquan)   0930  验收人：[@沙羽](undefined/lyy241867)\n\n发布单对fiber-api的有损降级\t\t[@少荃](undefined/shaoquan)\t1130    验收人：[@沙羽](undefined/lyy241867)\n\n:::\n\n\n\n\n\n**〖关注点4〗** 慢sql产生的根因，为何会导致CPU100%，没有做对应的措施保护DB吗？\n\n:::tips\n**〖问题总结〗**\n\n15:20 ~ 17:05 SQL 耗时占比，下图中主要是 select role_log 表引起。且 22 次查询中 20 次失败：\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/9648/1725595431769-4f2237b4-deb6-42bc-85f8-ce9669d95c36.png)\n\n在 SQL 详情中，显示开始执行 16:18，多条失败+成功的 SQL 耗时 2000+s，开始与结束时间与 CPU 满时间吻合。执行慢的 SQL 都为同一个业务触发（主要是业务在发布时点击查看「调度日志」引起）：\n〖改进点〗\n梳理相关的慢sql，并设置合理的DB报警提前发现并做出相关备案措施 [@尘定](undefined/fengjianhui.fjh)  0930\n提需求给sunfire 慢sql报警接入（需求评估）  [@沙羽](undefined/lyy241867)   0930\n\n:::\n\n\n\n## 五、常规检查项\n### 5.1【系统质量】\n#### 5.1.1 需求&设计评估\n###### 〖关注点1〗是否涉及产品、技术方案评估？此核心的问题是什么，如何改进？ _--涉及_\n- [x] **是，涉及**\n    - [ ] 需求评估遗漏\n    - [ ] 产品设计缺陷\n    - [ ] 系统架构设计缺陷\n        - [ ] 容错性不足 \n        - [ ] 单点，无冗余\n        - [ ] 缺乏自我保护\n        - [ ] 缓存设计不当\n        - [x] 容量评估不足\n        - [ ] 非幂等设计\n        - [ ] 强弱依赖不合理\n        - [ ] 其他：__________\n- [ ] 否，不涉及\n\n#### 5.1.2 代码质量  _--不涉及_\n#### 5.1.3 变更质量\n+ **是否涉及变更：**\n    - [ ] 是\n    - [x] 否\n+ **变更类型：**\n    - [ ] 代码发布\n    - [ ] 配置变更\n    - [ ] 其他变更：____________\n    - [x] 不涉及\n+ **变更平台是否接入ChangeFree：**\n    - [ ] 是，CF变更单链接：________\n\n_/*要这样的链接_ [https://aicf.alibaba-inc.com/aicf/change/detail/1725370372](https://aicf.alibaba-inc.com/aicf/change/detail/1725370372) */\n\n    - [x] 否\n+ **是否违反变更红线3.1**** **[链接](https://aliyuque.antfin.com/ngoc/fzg6dy/uar1k6)\n    - [ ] 是，违反哪条原则：\n    - [x] 否\n\n\n\n###### 〖关注点1〗灰度阶段     \n###### 〖关注点2〗上线阶段   \n+ **是否有确定的监控观测指标**\n    - [ ] 是，监控指标及监控链接：\n    - [ ] 否\n+ **是否在窗口期进行发布变更**\n    - [ ] 是\n    - [ ] 否，原因：\n+ **变更是否影响上下游**\n    - [ ] 是，是否有提前知会上下游评估及关注变更\n        - [ ] 有提前知会\n        - [ ] 没有提前知会\n    - [ ] 否\n\n**〖问题总结〗**\n\n**〖改进点〗**_**需明确写明不同故障相关方的改进项（若有的话），下同。**_\n\n### 5.2【处置能力】 __\n#### 5.2.1 故障发现&响应\n+ **是否监控发现**\n    - [x] 故障触",
    "chunk_order_index": 4,
    "full_doc_id": "doc-7519dce2612d4b418dcbdf6b43d83b30"
  },
  "chunk-221eaae41f45ab1972a8c13dde01f2eb": {
    "tokens": 1033,
    "content": "- [ ] 没有提前知会\n    - [ ] 否\n\n**〖问题总结〗**\n\n**〖改进点〗**_**需明确写明不同故障相关方的改进项（若有的话），下同。**_\n\n### 5.2【处置能力】 __\n#### 5.2.1 故障发现&响应\n+ **是否监控发现**\n    - [x] 故障触发方 监控发现\n    - [ ] 故障受影响方 监控发现\n    - [ ] 否，原因为：（监控无效/监控缺失）\n+ **是否5分钟内响应**\n    - [x] 是\n    - [ ] 否，原因为：\n+ **是否存在应急协同问题**\n    - [x] 是\n        - [ ] 应急流程不明确（无流程或者流程不清晰、应急相关角色&职责不明确，缺失一号位等)\n        - [x] 应急执行不到位（有流程，但未按流程执行，通告发送不及时，响应不及时等）\n    - [ ] 否\n\n**〖问题总结〗 **\n\n**〖改进点〗**_****_\n\n1、通知乐尽协助排查  \n\n#### 5.2.2 故障定位&恢复\n+ **主要恢复方式：**\n    - [ ] 代码发布/回滚\n    - [ ] 配置发布/回滚\n    - [ ] 数据订正\n    - [ ] 机器隔离/重启/扩容\n    - [ ] 配置限流\n    - [ ] 预案降级\n    - [x] 自动恢复\n    - [ ] 其他：\n+ **是否10分钟内恢复**__\n    - [ ] 是\n    - [x] 否，原因：DB 因为慢sql原因持续CPU 100%，慢sql 执行完成后，自动恢复\n\n**〖关注点1〗定位&恢复阶段存在什么问题？是否可以增加预案，****有更快的恢复方式？****相关的优化改进？**\n\n**〖问题总结〗没有完全定位是DB CPU 100% 的具体原因，这个与dbservice 上慢sql 统计有关**\n\n\n\n## 六、故障Action\n| **序号** | *******Action** | *******负责人** | *******计划完成时间** | **验收标准** | **是否keyAction** | **是否回血Action** |\n| --- | --- | --- | --- | --- | --- | --- |\n| 1 | 管控容量不足，优化链路，增强处理能力 | 尘定 | 9.10 |  完全定位性能急剧的原因并完成改进 | 是 | 否 |\n| 2 | 构建压测环境 perf 下性能曲线 | 尘定 | 0930 | 产出压测文档 | 否 | 否 |\n| 3 | 发布单对fiber-api的有损降级  | 少荃 | 1130 | 上线并验收通过 | 否 | 否 |\n| 4 | fiber-api 触发报警阈值调整50% | 尘定 | done | 调整至线上并验证通过 | 否 | 否 |\n| 5 | serverless报警场景新增评估 | 少荃 | 0930 |  评估结果同步，若可行上线监控场景，验证无误 | 否 | 否 |\n| 6 | 梳理相关的慢sql，并设置合理的DB报警提前发现  | 尘定 | 0930 | 产出文档，并设置完成慢sql报警，监控完成上线并验证通过 | 否 | 否 |\n| 7 | 提需求给sunfire 慢sql报警接入（需求评估） | 沙羽 | 0930 | 完成需求评估，判断是否需新增需求给sunfire | 否 | 否 |\n\n\n\n\n## 八、影响产品线&影响面\n| **受影响业务** | **等级** | **影响说明** |\n| --- | --- | --- |\n|  | P4 | - [ ] 是否影响可用性：是- [ ] 高可用影响：无- [x] 是否有客诉：在线人工反馈20+[0905-Asi发布失败-部分客诉.xlsx](https://yuque.antfin.com/attachments/lark/0/2024/xlsx/147156506/1731031183704-0b85ea65-9da7-4f18-aa8b-d4034f9ffc9c.xlsx)  - [ ] 是否有社会舆情：否- [ ] 是否产生资损：否 |",
    "chunk_order_index": 5,
    "full_doc_id": "doc-7519dce2612d4b418dcbdf6b43d83b30"
  },
  "chunk-b50a155bc1d81d80cedeffce92b0cdf2": {
    "tokens": 1200,
    "content": "## 一、故障简述\n【P4】2024-08-29 16:06用户反馈unzbmix 单元diamond 推送失败，客诉量级触达P5故障，因16:43累计客诉量：20+，故障升级至P4，由于机器升配导致镜像版本降低，影响多bu业务发布，于17:25通过删除nginx的lua脚本后故障恢复，请知晓。\n\n\n## 二、故障过程回顾\n### 2.1【故障处理时间线】\n| **时间轴** | **事件** |\n| --- | --- |\n| 2024-08-29 14:59 | **【故障注入】**14:59:04: 开始升配，8C16G -> 16C32G，升配机器数：48 台15:17:43: 额度受限，ECS 资源不足，发布暂停，开始导入第一批ecs资源。15:18:00 观测资源池大盘详情，发现5台机器不足以完成配置升级，导入第二批ecs资源![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/131956531/1725502138339-e96b4633-cbd0-41b7-8e9c-092043d26a44.png)15:21:17: 节点池第一批扩容成功，发布继续15:34:22: 线上环境标准发布，升配完成 |\n| 2024-08-29 16:06 | **【故障发现】【故障发生】**GOC风险预警，达到5例客诉![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/149256407/1725000567706-08fb641d-b649-4d26-9cd8-8214eac34327.png) |\n| 2024-08-29 16:06 | **【故障响应】**![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/149256407/1725000635070-7e43431b-efc6-474e-b21d-a38fb6d580e5.png) |\n| 2024-08-29 16:43 | 因客诉统计超过20例，故障升级P4 |\n| 2024-08-29 16:50 | 怀疑机器升配导致，正在降配尝试止血，降配后观察机器报错情况 |\n| 2024-08-29 16:54  | diamond-zbmixhost-arm-46，diamond-zbmixhost-arm-47机器降配成功，但是未止血，停止降配** ** |\n| 2024-08-29 16:59  | **【故障定位】【恢复执行】**移除一台nginx 后发布成功，目前正在全量 |\n| 2024-08-29 17:04 | 部分业务开始恢复 |\n| 2024-08-29 17:25 | **【故障恢复】【影响消除】**删除nginx的lua脚本后故障止血，用户反馈已恢复 |\n| 2024-08-29 17:25 | 统计客诉如下：对客群3例客诉，研发小蜜21例客诉，共24例客诉，去重后共22位用户进行了反馈，最早反馈时间为 15:46，17:18开始有用户陆续恢复 |\n\n\n\n\n### 2.2【时间线概览】\n![画板](https://intranetproxy.alipay.com/skylark/lark/0/2024/jpeg/149256407/1725511442328-34013287-02f9-4f57-be23-27093efa4c32.jpeg)\n\n\n\n## 三、故障原因\n### 3.1【背景说明】\n#### 【需求背景】\n:::tips\n由于【[2024[99] 0828 压测 unn1 快上问题](https://aliyuque.antfin.com/coreengine/diamond/phdrxbqbq6r2thkn)】diamond-server cpu 水位高达 90%，导致业务获取配置异常。遂考虑对 diamond-server 进行 unsh + 混部单元的升配（8C16G -> 16C32G）, 以降低快上期间 diamond 压力。\n\n:::\n\n#### 【业务链路】\n![画板](https://intranetproxy.alipay.com/skylark/lark/0/2024/jpeg/58156276/1725606674482-7881dffd-5288-4dee-a7b9-9f4428f4c175.jpeg)\n\n### 3.2【原因分析】\n#### 一句话原因：\n:::tips\n由于历史原因执行过**重置配置**的操作。导致 kubenest 平台和 workload 中镜像版本存在不一致问题。在本次故障中，diamond-server 需要升配并重新部署，而部署会按照 kubenest 平台的镜像版本（旧版本）进行下发，出现了镜像版本的回退。低版本镜像中的 tengine 执行 lua 脚本异常，导致无法正常处理网络请求，进而引发了本次故障。\n\n:::\n\n#### 根因分析：Diamond 升配后镜像版本下降\n![](https://intranetproxy.alipay.com/skylark/l",
    "chunk_order_index": 0,
    "full_doc_id": "doc-ab196954f0aaeb3bd6e25aacc85e0570"
  },
  "chunk-12f54e18ac4e2272831c0530a7c6175c": {
    "tokens": 1200,
    "content": "升配并重新部署，而部署会按照 kubenest 平台的镜像版本（旧版本）进行下发，出现了镜像版本的回退。低版本镜像中的 tengine 执行 lua 脚本异常，导致无法正常处理网络请求，进而引发了本次故障。\n\n:::\n\n#### 根因分析：Diamond 升配后镜像版本下降\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/58156276/1725007510390-0cd5b8a4-e2fb-46ad-baf4-023415008725.png)\n\n镜像版本下降过程：\n\n:::tips\n+ 工单一 3372480：升级新的镜像版本 20230823（兼容 ARM 机型），标准发布，发布异常并执行关单。\n+ 工单二 3386186：手动执行扩容操作，此时由于工单一部署失败且关单，导致配置不一致无法继续执行扩容。只能手动执行**重置配置**，重置的镜像版本为最近一次发布成功的镜像版本（20230809 旧版本）。但由于是扩容单子，不会重新部署，也就不会更新 workload 文件。\n\n:::\n\n工单二执行**重置配置**过后，workload 文件中为新的镜像版本，但是 kubenest 平台为旧的镜像版本。\n\n+ 扩缩容动作：会使用 workload 文件中新的的镜像版本，没有任何问题。\n+ 部署动作：会按照 kubenest 平台旧的镜像版本进行下发，而升配过程需要重新进行部署。\n\n## 四、关注点分析\n**〖关注点1〗**** 本次变更是否在变更窗口内，是否符合云侧的变更规范，变更灰度过程是否有效，灰度未发现的原因是什么，后续应如何改进。**[@项升](undefined/xiangsheng.gh)\n\n:::tips\n**〖问题总结〗**\n\n****\n\n**〖改进点〗**\n\n+ KubeNest应用集群下pod数大于1的强制限制部署分批数必须大于等于2 ，默认发布方式改成分批发布[@睿封](undefined/bingrong.fbr)  09.30\n\n:::\n\n****\n\n**〖关注点2〗**kubenest平台的20230809镜像中的 tengine 执行 lua 脚本异常，为什么之前没有暴露此问题，目前还有其他地方使用吗\n\n:::tips\n**〖问题总结〗**之前云侧出现过同样的问题升级0823版本解决，并且无人部署就不会有问题\n\n****\n\n**〖改进点〗**针对kubenest发布失败场景进行梳理 [@睿封](undefined/bingrong.fbr) 10.18\n\n:::\n\n\n\n**〖关注点3〗**** **Diamond推送失败影响多bu，平台侧是否及时发现，未发现的原因是什么[@项升](undefined/xiangsheng.gh)\n\n:::tips\n**〖问题总结〗**\n\n\n\n**〖改进点〗**梳理现有核心监控并检查是否配置报警。例如：Nginx 状态码监控，ops 监控\n\n:::\n\n\n\n**〖关注点4〗**16:59定位了根因，但在17:25分删除nginx的lua脚本，为什么删除过程耗时较长，后续如何确保快恢。 \n\n:::tips\n**〖问题总结〗**\n\n\n\n**〖改进点〗**\n\nkubenest平台产品文档初版完善  @睿封  12.30\n\nkubenest平台沟通[@乐尽](undefined/cuirongcheng.crc)  0930\n\n:::\n\n\n\n## 五、常规检查项\n### 5.1【系统质量】\n#### 5.1.1 需求&设计评估 _--不涉及_\n#### 5.1.2 代码质量  _--不涉及_\n#### 5.1.3 变更质量\t_--涉及_\n+ **是否涉及变更：**\n    - [x] 是\n    - [ ] 否\n+ **变更类型：**\n    - [ ] 代码发布\n    - [ ] 配置变更\n    - [x] 其他变更：____升配________\n    - [ ] 不涉及\n+ **变更平台是否接入ChangeFree：**\n    - [x] 是，CF变更单链接：___[_https://aicf.alibaba-inc.com/aicf/change/v2/detail/1201343538__](https://aicf.alibaba-inc.com/aicf/change/v2/detail/1201343538)__\n    - [ ] 否\n+ **是否违反变更红线3.1**** **[链接](https://aliyuque.antfin.com/ngoc/fzg6dy/uar1k6)\n    - [ ] 是，违反哪条原则：\n    - [x] 否\n\n\n\n**〖关注点1〗****灰度阶段**\n\n+ **是否经过灰度：**\n    - [ ] 是\n    - [x] 否\n+ **观测了哪些监控**：_可以附链接_\n    - [ ] 黑屏、白屏\n    - [ ] GOC监控：\n    - [ ] 系统大盘：\n    - [x] 其他：______有监控无报警_____\n+ **是否灰度期间发现问题？**\n    - [ ] 是",
    "chunk_order_index": 1,
    "full_doc_id": "doc-ab196954f0aaeb3bd6e25aacc85e0570"
  },
  "chunk-6f169b75e2a8dd5ebc4b949b78186c89": {
    "tokens": 1200,
    "content": "度阶段**\n\n+ **是否经过灰度：**\n    - [ ] 是\n    - [x] 否\n+ **观测了哪些监控**：_可以附链接_\n    - [ ] 黑屏、白屏\n    - [ ] GOC监控：\n    - [ ] 系统大盘：\n    - [x] 其他：______有监控无报警_____\n+ **是否灰度期间发现问题？**\n    - [ ] 是\n        - [ ] 是否灰度流量过大，导致故障\n        - [ ] 灰度发现但未有效或及时修复，导致故障\n        - [ ] 其他：___________\n    - [x] 否，后续如何灰度发现？_____分两批以上发布，并且留出观察时间________\n+ **未灰度发现原因**\n    - [ ] 应用灰\n        - [ ] 灰度流量太小\n        - [ ] 灰度阶段无监控\n        - [ ] 灰度批次不合理\n        - [ ] 超长时间灰度才能发现\n    - [ ] 业务灰：策略不合理\n    - [ ] 灰度无法发现\n    - [x] 其他：_____________\n\n**〖问题总结〗**\n\n**〖改进点〗**_**需明确写明不同故障相关方的改进项（若有的话），下同。**_\n\n1、\n\n\n\n**〖关注点2〗****上线阶段**\n\n+ **是否有确定的监控观测指标**\n    - [x] 是，监控指标及监控链接：\n    - [ ] 否\n+ **是否在窗口期进行发布变更**\n    - [ ] 是\n    - [x] 否，原因：\n\n**〖问题总结〗**\n\n**〖改进点〗**_**需明确写明不同故障相关方的改进项（若有的话），下同。**_\n\n1、\n\n### 5.2【处置能力】 _--涉及_\n#### 5.2.1 故障发现&响应\n+ **是否监控发现**\n    - [ ] 故障触发方 监控发现\n    - [ ] 故障受影响方 监控发现\n    - [x] 否，原因为：（监控无效/监控缺失）监控但未报警\n+ **是否5分钟内响应**\n    - [x] 是\n    - [ ] 否，原因为：\n+ **是否存在应急协同问题**\n    - [ ] 是\n        - [ ] 应急流程不明确（无流程或者流程不清晰、应急相关角色&职责不明确，缺失一号位等)\n        - [ ] 应急执行不到位（有流程，但未按流程执行，通告发送不及时，响应不及时等）\n    - [x] 否\n\n#### 5.2.2 故障定位&恢复\n+ **主要恢复方式：**\n    - [ ] 代码发布/回滚\n    - [ ] 配置发布/回滚\n    - [ ] 数据订正\n    - [ ] 机器隔离/重启/扩容\n    - [ ] 配置限流\n    - [ ] 预案降级\n    - [ ] 自动恢复\n    - [x] 其他：删除nginx的lua脚本\n+ **是否10分钟内恢复**__\n    - [ ] 是\n    - [x] 否，原因：___手动删除48台lua脚本_______\n\n**〖关注点1〗定位&恢复阶段存在什么问题？是否可以增加预案，****有更快的恢复方式？****相关的优化改进？**\n\n**〖问题总结〗**\n\n**〖改进点〗**\n\n1、配置类型变更日常风险演练\t@项升\t11.30\n\n## 六、故障Action\n| **序号** | *******Action** | *******负责人** | *******计划完成时间** | **验收标准** | **是否keyAction** | **是否回血Action** |\n| --- | --- | --- | --- | --- | --- | --- |\n| 1 | x86 代替混部单元 arm 机型，避免以后持续踩坑。 | 曲怪 | 预发环境：08.29   线上环境：09.02 |  | 否 | 否 |\n| 2 | 梳理现有核心监控并检查是否配置报警。例如：Nginx 状态码监控，ops 监控 | 曲怪 | 09.06 |  | 否 | 否 |\n| 3 | 捞取故障期间配置变更数据，反馈业务进行一致性检查 | 曲怪 | 09.02 |   | 否 | 否 |\n| 4 | 镜像配置一致性巡检 | 曲怪 | 12.30 | 常态一致性巡检验收通过 | 否 | 否 |\n| 5 | 配置类型变更日常风险演练 | 项升 | 11.30 | 演练产出相关文档并改进 | 否 |  |\n| 6 | kubenest平台产品文档初版完善 | 睿封  | 12.30 | 线上平台产出产品文档 | 否 |  |\n| 7 | KubeNest平台对已部署的应用集群配置限制重置 | 睿封 | 09.30 | KubeNest平台",
    "chunk_order_index": 2,
    "full_doc_id": "doc-ab196954f0aaeb3bd6e25aacc85e0570"
  },
  "chunk-3597e49bf003a4f49420eea05e9209af": {
    "tokens": 408,
    "content": "演练 | 项升 | 11.30 | 演练产出相关文档并改进 | 否 |  |\n| 6 | kubenest平台产品文档初版完善 | 睿封  | 12.30 | 线上平台产出产品文档 | 否 |  |\n| 7 | KubeNest平台对已部署的应用集群配置限制重置 | 睿封 | 09.30 | KubeNest平台上线并验证通过 | 否 | 否 |\n| 8 | KubeNest应用集群下pod数大于1的强制限制部署分批数必须大于等于2 | 睿封 | 09.30 | KubeNest平台上线并验证通过 | 否 | 否 |\n| 9 | kubenest平台沟通 | 乐尽 | 09.30 | 同步结果 | 否 | 否 |\n|  |  |  |  |  |  | 否 |\n\n\n\n\n## 七、故障总结反思\n**【做得好的】**\n\n**【经验教训】**举一反三，学习，避免踩坑\n\n\n\n## 八、影响产品线&影响面\n| **受影响业务** | **等级** | **影响说明** |\n| --- | --- | --- |\n| 爱橙-技术风险与效能部    | P4 | - [ ] 是否影响可用性：否- [ ] 高可用影响：无- [x] 是否有客诉：在线人工反馈 24 例链接：[https://aliyuque.antfin.com/qiwenjing.qwj/ikonha/mn4yhew40cofbwge](https://aliyuque.antfin.com/qiwenjing.qwj/ikonha/mn4yhew40cofbwge)- [ ] 是否有社会舆情：否- [ ] 是否产生资损：否 |",
    "chunk_order_index": 3,
    "full_doc_id": "doc-ab196954f0aaeb3bd6e25aacc85e0570"
  },
  "chunk-adc5f42273c75d738dc492a6fcfdbcb3": {
    "tokens": 1200,
    "content": "## 一、故障简述\n【P5】于2024-09-04 08:38收到反馈，离线后消息未分配到商家正常设置代理账号，排查为商家未设置离线留言分配方案，离线留言从默认给服务助手修正到默认给主账号，10:47回滚恢复，期间在线反馈89例。\n\n## 二、故障过程回顾\n| **时间轴** | **事件** |\n| --- | --- |\n| 2024-09-04 08:38 | 预警卡片推送【故障发生】【故障发现】 |\n| 2024-09-04 08:39 | 风险预警群拉起（离线后消息未分配到商家正常设置代理账号） |\n| 2024-09-04 08:40 | 子策响应【故障响应】 |\n| 2024-09-04 08:42 | 长济发起钉钉会议 |\n| 2024-09-04 08:44 | 通用布防上线![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256311/1725849191520-9ec2905c-5a7c-4588-95a3-06b5603c0e88.png) |\n| 2024-09-04 08:46 | 值班长反馈无新增商家，单点case排查 |\n| 2024-09-04 09:00 | 长济排查到有个case的代理账号是正常在线，排查用户在线状态问题 |\n| 2024-09-04 09:15 | 洵舒排查到有商家【用户离线消息分配模式设置为null】，通知反馈商家后台设置，同步排查值为null的原因，怀疑是否因近期前端变更，导致商家正常的代理帐号设置被重置成了null |\n| 2024-09-04 09:20 | 反馈的5个用户表现都为【用户离线消息分配模式设置为null】，离线统计反馈商家设置，近30天离线消息分配模式均为null，确认是商家未设置离线留言导致。过程中持续跟进商家反馈情况，值班长反馈无新增。同时拉前端同学进会议确定前几日离线留言池的变更影响 |\n| 2024-09-04 09:25 | 会议中：让知惜挂公告让商家检查离线留言设置，按自身需求设置离线留言池分配方案 |\n| 2024-09-04 09:46 | 知惜反馈离线消息在线反馈51+![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256311/1725849682280-76c245a3-5f8a-4723-aa34-5546fe1e96db.png) |\n| 2024-09-04 09:51 | 会议中：修改布防口径，引导商家设置离线分配方案，可千牛登录主账号查询消费者的离线消息 |\n| 2024-09-04 09:57 | 布防口径更新![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256311/1725850493028-3362613b-b350-47ea-b0a3-f8701a337bd1.png) |\n| 2024-09-04 10:03 | 确定是分流逻辑变更导致，当天分配逻辑暂时恢复到与用户习惯相符的操作【故障定位】 |\n| 2024-09-04 10:11 | 变更回滚开始执行【恢复执行】![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256311/1725849954674-380bd5b1-0462-4a50-b6ec-66372213a7a6.png) |\n| 2024-09-04 10:47 | 变更回滚完成【故障恢复】 |\n\n\n## 三、故障原因\n### 3.1【背景说明】\n> 离线消息分配商家侧公告：[查看详情](https://helpcenter.tmall.com/servicehall/knowledge_detail?kwdContentId=264200399203914752&)\n>\n> 离线留言池优化需求：[查看详情](https://aone.alibaba-inc.com/v2/project/1177582/req/57563063) \n>\n> 离线留言池整体方案：[查看详情](https://aliyuque.antfin.com/xs86z6/nq6lv9/tr2rlm6rgurs9c8n#vapIC)\n>\n\n离线留言池优化升级，整体功能梳理时，发现未设置离线消息处理方案会给服务助手，和产品预期不符，本次需求进行修正，调整全店离线消息后默认分配方式： \n\n+ **修正前**：商家未设置离线消息处理方案，默认分给服务助手（不符合产品预期）\n    - 商家可至【离线消息池】查询离线后消费者咨询，并执行转交等操作\n+ **修正后**：商家未设置离线消息",
    "chunk_order_index": 0,
    "full_doc_id": "doc-e4ae864a525ec74be4422c3694442076"
  },
  "chunk-34c0704cec4aceb7de251e56410c9603": {
    "tokens": 1200,
    "content": "方案会给服务助手，和产品预期不符，本次需求进行修正，调整全店离线消息后默认分配方式： \n\n+ **修正前**：商家未设置离线消息处理方案，默认分给服务助手（不符合产品预期）\n    - 商家可至【离线消息池】查询离线后消费者咨询，并执行转交等操作\n+ **修正后**：商家未设置离线消息处理方案，默认分给主账号（符合产品预期，尽量分流给人工客服，提升咨询回复满意度）\n    - 商家主账号可登录【千牛工作台】查询离线后消费者咨询，并执行转交等操作\n\n![画板](https://intranetproxy.alipay.com/skylark/lark/0/2024/jpeg/12460/1725548892573-3bf2af1d-882a-4cbf-abbd-bd8575922834.jpeg)\n\n修正预估影响面：\n\n> 未设置离线留言分配商家占比：1.91%,（未设置离线留言分配方案：442986，商家总量：23173122）\n>\n> 商家占比较低，不影响消息收发核心流程，且修正符合产品预期，同时已有**未设置默认优先给主账号**的商家公告，整体风险可控\n>\n\n### 3.2【原因分析】\n一句话原因：\n\n:::tips\n离线留言从默认给服务助手修正到默认给主账号，不符合部分商家（未配置离线留言分配方案）的预期\n\n:::\n\n\n\n根因分析：\n\n:::tips\n+ **分流节点pipeline如下**[**link**](https://code.alibaba-inc.com/qn-dispatch/dep/blob/master/dep/dep-service/src/main/java/com/taobao/dep/engine/EngineFactory.java)\n\n      若无在线客服，且未设置离线分配方案，均默认分配至主账号\n\n      ![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/12460/1725939417096-843b5f62-0746-4f86-87d8-390ef59d5271.png)\n\n:::\n\n---\n\n:::tips\n+ **服务助手分流逻辑**[link](https://code.alibaba-inc.com/qn-dispatch/dep/codereview/17590895?file=fddd1fc6278100143c7401aed9a414d74dfa466f)\n\n      历史服务助手开通则可以进行离线消息分配，当前匹配离线留言方案后执行\n\n     ![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/12460/1725529629866-fbdacda5-234d-4379-aa5b-0afa1ffc2f72.png)\n\n**      **老逻辑：根据是否开通服务助手(openServiceAccount)判断是否可分配给服务助手（openServiceAccount == 1 可分配给服务助手），故商家未设置离线留言分配方案（offlineAccountType值为空），开通服务助手的情况会将离线消息分配至服务助手\n\n      ![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/12460/1725938635824-51771c2f-c7ac-498e-a0cd-fa19d8047856.png)\n\n**     ** 新逻辑[**link**](https://code.alibaba-inc.com/qn-dispatch/dep/codereview/17590895?file=878b22dae2dc35414587c07771ab45fc9d1f4429)：根据商家设置的离线留言分配方案（offlineAccountType字段）来决策，仅当值为3时可分配给服务助手，否则默认给主账号。\n\n    - offlineAccountType字段说明如下：\n        * OfflineDealSettingConstants.TO_MAIN_ACCOUNT：离线留言给主账号\n        * OfflineDealSettingConstants.TO_DELEGATE_ACCOUNT：离线留言给代理帐号\n        * OfflineDealSettingConstants.TO_SERVICE_ACCOUNT：离线留言给服务助手\n\n       ![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/12460/1725532514317-2179173f-d572-454d-a714-4a43c3cf34bf.png)\n\n:::\n\n---\n\n:::tips\n+ **主账号兜底逻辑**[link](https://code.alibaba-inc.com/qn-dispatch/dep/blob/master/dep/dep-service/src/main/java/com/taobao/dep/engine/ChainDispatchEngine/nodes/MainAccountDispatchNode.java)\n\n      ![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256311/1725958060380-41762ca9-aa1f-42f7-aa33-83564ce2d45d.png)\n\n:::\n\n---\n\n:::tips\n+ **反馈商家配置**\n\n反馈商家均为未设置离线留言池（offlineAccountType == null，openServiceAccoun == 1 ），根据产品预期，默认分配给主账号，但和商家预期不符导致舆情反馈，其设置截图如下：\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/288258/1725421748799-01eab6e4-05e0-",
    "chunk_order_index": 1,
    "full_doc_id": "doc-e4ae864a525ec74be4422c3694442076"
  },
  "chunk-c51fc13993ba37ab131989e871cbaff4": {
    "tokens": 1200,
    "content": "配置**\n\n反馈商家均为未设置离线留言池（offlineAccountType == null，openServiceAccoun == 1 ），根据产品预期，默认分配给主账号，但和商家预期不符导致舆情反馈，其设置截图如下：\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/288258/1725421748799-01eab6e4-05e0-493a-88de-012ef32d63ea.png)\n\n:::\n\n## 四、关注点分析 \n「关注点」：离线消息异常是否有监控，监控是否有预警？\n\n:::tips\n监控链接：[查看详情](https://xflush.alibaba-inc.com/custom/11/product/update/multiMinute/4370)，新增离线留言记录在23:00以后小幅下跌，波动较小且在本次变更的业务预期内\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/288258/1725420264541-d6c2225b-10c4-40d7-bd2c-7bda5df1ac76.png)\n\naction：监控按接待类型（主账号、服务助手、代理账号）做细分  墨葶  0914\n\n:::\n\n\n\n「关注点」：8:40业务响应至10:03原因定位耗时长，为何一直未考虑到跟变更有关？\n\n:::tips\n离线留言需求发布涉及数据库、服务端（离线留言后台ddc和分流引擎执行dep）以及前端，刚开始问题反馈有一定误导，技术均在重点排查【商家离线消息分配模式设置为null】的原因，担心是后台发布导致商家设置的代理帐号被复写成null了。后续确定是商家没有设置过离线处理方案导致，而不是前后端异常导致商家设置的代理帐号被改错了，因仅5例无新增，技术给到的解决方案是公告布防引导商家去后台按需设置即可。直到离线消息反馈已达79+，持续上涨并非个例，才考虑分流变更回滚，恢复到与商家习惯相符的操作\n\n\n\n完整过程如下：\n\n2024-09-04 09:15 之前仅5例反馈，问题是离线后没有分配给商家正常设置的代理帐号，技术同学均在排查【商家离线消息分配模式设置为null】的原因，商家设置最后修改时间均是近几天以内，担心是近期后台发布导致商家设置的代理帐号被复写成null了\n\n2024-09-04 09:20 所有在线操作记录和日志均未查询到相关变更，离线查询商家近30天离线留言分配设置，才确定是商家没有设置离线处理方案，而不是前后端异常导致商家设置的代理帐号被改错了。符合修正后业务预期，仅5例未新增，技术给到的解决方案是公告布防引导商家去后台按需设置即可\n\n2024-09-04 09:46 反馈离线消息反馈已达79+，持续上涨并非个例，才考虑分流变更回滚，恢复到与商家习惯相符的操作\n\n\n\n:::\n\n\n\n「关注点」：老逻辑未设置离线留言分配方案，且服务助手未开通 ，会分配到哪里？\n\n:::tips\n兜底会分配至主账号\n\n:::\n\n\n\n「关注点」：后续发布，布防计划？\n\n:::tips\naction：\n\n1、产品公告宣导（飘小黄条），引导商家主动设置离线留言分配方案  峻宁  0930\n\n2、分流后台强制更新为默认分流主账号（按名单/比例灰度）  峻宁  1015\n\n:::\n\n\n\n「关注点」：值班长反馈客诉5例未新增，知惜反馈VOB声量高\n\n:::tips\n1、XP+1预警依赖人工上报，值班长给小二宣导有新增的客诉量及时反馈\n\n2、提醒客满接口人及时在预警群更新VOB声量\n\n:::\n\n\n\n「关注点」：客诉情况预警卡片（分时间或者客诉量进行推送）\n\n:::tips\n亦然带回跟新茶沟通，根据关键词统计声量在群内播报方式\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256311/1726026373176-0afaeacb-7482-4b8c-9261-8be6e161534c.png)\n\n:::\n\n### 4.1【系统质量】\n#### 4.1.1 需求&设计评估 --不涉及\n#### 4.1.2 代码质量\n**〖关注点1〗是否代码自身存在漏洞或BUG、代码健壮性是否存在问题等?---不涉及**\n\n\n\n**〖关注点2〗****是否经过CodeReview？CodeReview阶段是否发现问题？为何没发现？**\n\n+ **是否经过CR**\n    - [x] 是  CR链接：[https://code.alibaba-inc.com/qn-dispatch/dep/codereview/17590895?file=",
    "chunk_order_index": 2,
    "full_doc_id": "doc-e4ae864a525ec74be4422c3694442076"
  },
  "chunk-5c09a4b946158e6ba3f724f596761bde": {
    "tokens": 1200,
    "content": "1.2 代码质量\n**〖关注点1〗是否代码自身存在漏洞或BUG、代码健壮性是否存在问题等?---不涉及**\n\n\n\n**〖关注点2〗****是否经过CodeReview？CodeReview阶段是否发现问题？为何没发现？**\n\n+ **是否经过CR**\n    - [x] 是  CR链接：[https://code.alibaba-inc.com/qn-dispatch/dep/codereview/17590895?file=878b22dae2dc35414587c07771ab45fc9d1f4429](https://code.alibaba-inc.com/qn-dispatch/dep/codereview/17590895?file=878b22dae2dc35414587c07771ab45fc9d1f4429)\n    - [ ] 否\n    - [ ] 不涉及\n+ **是否设置合理的CR卡点**\n    - [x] 是\n    - [ ] 否\n    - [ ] 不涉及\n+ **CodeReview阶段是否发现问题？为何没发现？后续如何发现？**\n    - [x] 是\n    - [ ] 否\n    - [ ] 不涉及\n\n\n\n**〖关注点3〗****测试阶段**\n\n+ **测试内容：**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/12460/1725939006949-65a93e23-19e6-406c-94d7-f6fe49046f72.png)\n\n+ **测试人员：什衣**\n+ **是否经过测试验证**\n    - [x] 是，验证环境\n        - [x] 预发环境\n        - [ ] 日常环境\n    - [x] 是，测试方法\n        - [ ] 单元测试\n        - [x] 功能回归测试\n        - [ ] 集成测试/链路测试\n        - [ ] 验收测试\n    - [ ] 否\n    - [ ] 不涉及\n\n#### 4.1.3 变更质量\n+ **是否涉及变更：**\n    - [x] 是\n    - [ ] 否\n+ **变更类型：**\n    - [x] 代码发布\n    - [ ] 配置变更\n    - [ ] 其他变更：____________\n    - [ ] 不涉及\n+ **变更平台是否接入ChangeFree：**\n    - [x] 是，CF变更单链接：[https://aicf.alibaba-inc.com/aicf/approval/detail/7969941?spm=goc-apm.aicf-_grayscale_hm.0.0.41642388ww0ehj](https://aicf.alibaba-inc.com/aicf/approval/detail/7969941?spm=goc-apm.aicf-_grayscale_hm.0.0.41642388ww0ehj)\n    - [ ] 否\n+ **是否违反变更红线3.1**** **[链接](https://aliyuque.antfin.com/ngoc/fzg6dy/uar1k6)\n    - [ ] 是，违反哪条原则：\n    - [x] 否\n\n\n\n**〖关注点1〗****灰度阶段**\n\n+ **是否经过灰度：**\n    - [x] 是\n    - [ ] 否\n+ **观测了哪些监控**：_可以附链接_\n    - [ ] 黑屏、白屏\n    - [ ] GOC监控：\n    - [ ] 系统大盘：\n    - [x] 其他：[https://xflush.alibaba-inc.com/custom/11/product/preview/multiMinute/4370](https://xflush.alibaba-inc.com/custom/11/product/preview/multiMinute/4370)\n+ **是否灰度期间发现问题？**\n    - [ ] 是\n        - [ ] 是否灰度流量过大，导致故障\n        - [ ] 灰度发现但未有效或及时修复，导致故障\n        - [ ] 其他\n    - [x] 否\n+ **未灰度发现原因**\n    - [ ] 应用灰\n        - [ ] 灰度流量太小\n        - [ ] 灰度阶段无监控\n        - [ ] 灰度批次不合理\n        - [ ] 超长时间灰度才能发现\n    - [ ] 业务灰：策略不合理\n    - [ ] 灰度无法发现\n    - [x] 其他\n\n\n\n**〖关注点2〗****上线阶段**\n\n+ **是否有确定的监控观测指标**\n    - [x] 是，：[https://xflush.alibaba-inc.com/custom/11/product/preview/multiMinute/4370](https://xflush.alibaba-inc.com/custom/11/product/preview/multiMinute/4370)\n    - [ ] 否\n+ **是否在窗口期进行发布变更**\n    - [x] 是\n    - [ ] 否，原因：\n+ **变更是否影响上下游**\n    - [ ] 是，是否有提前知会上下游评估及关注变更\n        - [ ] 有提前知会\n        - [ ] 没有提前知会\n    - [x] 否\n\n\n\n### 4.2【处置能力】\n#### 4.2.1 故障发现&响应\n+ **是否监控发现**\n    - [ ] 故障触发方 监控发现\n    - [ ] 故障受影响方 监控发现\n    - [",
    "chunk_order_index": 3,
    "full_doc_id": "doc-e4ae864a525ec74be4422c3694442076"
  },
  "chunk-0b9114f00afdf784f0a8ae5f38dd8588": {
    "tokens": 934,
    "content": "游评估及关注变更\n        - [ ] 有提前知会\n        - [ ] 没有提前知会\n    - [x] 否\n\n\n\n### 4.2【处置能力】\n#### 4.2.1 故障发现&响应\n+ **是否监控发现**\n    - [ ] 故障触发方 监控发现\n    - [ ] 故障受影响方 监控发现\n    - [x] 否\n+ **是否5分钟内响应**\n    - [x] 是\n    - [ ] 否，原因为：\n+ **是否存在应急协同问题**\n    - [ ] 是\n        - [ ] 应急流程不明确（无流程或者流程不清晰、应急相关角色&职责不明确，缺失一号位等)\n        - [ ] 应急执行不到位（有流程，但未按流程执行，通告发送不及时，响应不及时等）\n    - [x] 否\n\n#### 4.2.2 故障定位&恢复\n+ **主要恢复方式：**\n    - [x] 代码发布/回滚\n    - [ ] 配置发布/回滚\n    - [ ] 数据订正\n    - [ ] 机器隔离/重启/扩容\n    - [ ] 配置限流\n    - [ ] 预案降级\n    - [ ] 自动恢复\n    - [ ] 其他：\n\n## 五、故障总结反思\n_/* P1故障必填，主要用于总结分享和提炼分析*/_\n\n**【做得好的】**\n\n最佳实践\n\n**【经验教训】**\n\n举一反三，学习，避免踩坑\n\n## 六、故障Action\n| **序号** | *******Action标题** | *******负责人** | *******计划完成时间** | **Action描述** | **验收标准** | **验收人** | **是否keyAction** | **是否回血Action** |\n| --- | --- | --- | --- | --- | --- | :---: | --- | --- |\n| 1 | 短期：监控按接待类型（主账号、服务助手、代理账号）做细分    | 墨葶 | 0914 | **** | **** | **** | **** | **** |\n| 2 | 短期：产品公告宣导（飘小黄条），引导商家主动设置离线留言分配方案 | 峻宁 | 0930 | |  | | | |\n| 3 | 短期：分流后台强制更新为默认分流主账号（按名单/比例灰度） | 峻宁 | 1017 | |  | | | |\n| 4 | 长期：所有涉及改动用户预期行为的功能变更，均需提前公告 | 墨葶 |  | |  | | | |\n\n\n\n\n## 七、影响产品线&影响面\n    - [x] 是否有客诉量：\n\n       关键词：离线消息 and （没有 or 未分配 ） \n\n       时间段：2024-09-04 00:00-2024-09-04 10:47\n\n       声量：在线89\n\n\n\n备注：\n\n> 9月4号 , 8-23点之间，命中未配置离线留言池分配方案的商家总量：1526（占比0.0065%，23173122），具体名单id：[https://sheet.alibaba-inc.com/sheet/51836152-584c-4578-a7bb-e2153ac1d6be](https://sheet.alibaba-inc.com/sheet/51836152-584c-4578-a7bb-e2153ac1d6be)\n>\n> 9月4号 , 0-23点之间，命中未配置离线留言池分配方案的商家总量：9748（占比0.042%，23173122），具体名单id：[https://sheet.alibaba-inc.com/sheet/1e1dd21f-3efc-4ebd-a031-e0978ce1e1ad](https://sheet.alibaba-inc.com/sheet/1e1dd21f-3efc-4ebd-a031-e0978ce1e1ad)\n>\n\n###",
    "chunk_order_index": 4,
    "full_doc_id": "doc-e4ae864a525ec74be4422c3694442076"
  },
  "chunk-969b277abb76ac2fd4cd7f617e3cca1d": {
    "tokens": 1200,
    "content": "## 一、故障简述\n于9月3日14:25分开始陆续收到反馈，BP前台显示创意拒绝，提示缺少 800*800 的图片，实际客户是有添加的，经排查故障初步定位是由于少量直播高RT视频制作任务打到了图文制作服务队列，造成图文制作阻塞，通过资源隔离提升图文制作吞吐，清除了积压任务，业务于22:00分恢复。故障期间累计客诉量84例。\n\n## 二、故障过程回顾\n### 2.1【时间线概览】\n![画板](https://intranetproxy.alipay.com/skylark/lark/0/2024/jpeg/80256396/1725622283684-76eaa43b-5c07-406f-9ee9-31ab007e9ed9.jpeg)\n\n故障发现～初因定位：406min\n\n初因定位～故障恢复：39min\n\n### 2.2【故障处理时间线】\n**2024-08-14** **14:10**，beta环境灰度发布后，开始在正式环境持续到8月27日muse分批发布有关直播创意尺寸拆分需求的变更并逐步灰度放量；**——【故障引入】**\n\n**2024-08-27 17:59**，直播创意尺寸拆分需求推全，请求到图文队列的直播视频制作消息量（预期外）逐渐增长；****\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/303126/1725449156853-233a757f-305f-41f8-98cb-6d5a01cf2e09.png)\n\n视频请求量\n\n随着请求量上涨，本就是高RT的任务出现大量超时（timeout=300s），降低了整体任务的吞吐；\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/303126/1725450194181-f85fdb62-b92b-4562-b5a8-ec5e3ac2999e.png)\n\n视频RT（s）\n\n该视频制作服务的平均RT长期保持在70s左右，主要原因是资源有限，服务CPU长期处于高水位；\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/16357058/1725449702921-c4cf85ae-a339-4fa2-a1d0-bc3eab9fec49.png)\n\n2024-09-03 14:13，客满团队收到第一例有关无界创意拒绝的相关客诉；\n\n**2024-09-03 14:25**，开始陆续收到有关创意拒绝相关客诉预警单（【wj】创意拒绝提示缺少一张800*800的图、【wj】创意显示审核拒绝但不提示具体违规原因、【wj】创意拒绝，没有提示拒绝原因），由[@麟彦](undefined/zmh356266)拉群处理；[@皮咔](undefined/pika.qy)同学通过监控报警发现应用出现大量堆积；**——【故障发现】【业务响应】**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/236219/1725451131515-eecb0c06-c43a-4d46-9c6a-7cbc5ef9a04e.png)![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/303126/1725450635727-8e5e2c64-3477-43ad-8d76-587d03569766.png)\n\n2024-09-03 14:27，[@麟彦](undefined/zmh356266)同学联系[@彦谦](undefined/yanqian.lyl)同步排查，看是否是延迟导致的问题；\n2024-09-03 14:29，[@皮咔](undefined/pika.qy)同学在创意制作报警监控群中同步上下游协助排查；\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/303126/1725450553033-5ef4209b-1f05-4031-9569-2d49d9a75075.png)\n\n2024-09-03 14:30， [@麟彦](undefined/zmh356266)发起电话会议进行协同排查；\n\n2024-09-03 14:31， [@彦谦](undefined/yanqian.lyl) 拉[@皮咔](undefined/pika.qy)[@云芑](undefined/yunqi.zm) 进预警群，共同介入排查；\n\n**2024-09-03 14:39**，客诉达到40例（去重后）；**——【故障发生】**\n\n2024-09-03 14:46，[@云芑](undefined/yunqi.zm) 反馈图像服务正常，初步确认是上游堆积导致；\n\n——会议ACTION： 初步判断存在请求量上涨、制作RT上涨等问题\n\n1. 先停掉可能有影响的增量请求 \n2. 对制作服务扩容，降低消费RT\n3",
    "chunk_order_index": 0,
    "full_doc_id": "doc-32d16e33180164f22bb7a6a392eec35f"
  },
  "chunk-32afd8fdbee6d4a3cbbc17b858ac4a1e": {
    "tokens": 1200,
    "content": "例（去重后）；**——【故障发生】**\n\n2024-09-03 14:46，[@云芑](undefined/yunqi.zm) 反馈图像服务正常，初步确认是上游堆积导致；\n\n——会议ACTION： 初步判断存在请求量上涨、制作RT上涨等问题\n\n1. 先停掉可能有影响的增量请求 \n2. 对制作服务扩容，降低消费RT\n3. 扩大请求制作服务并发\n4. 并行排查问题原因\n\n2024-09-03 14:58， [@麟彦](undefined/zmh356266) 停止BP 的刷追投创意链路；\n\n2024-09-03 15:01， [@雨行](undefined/yuxing.hqb) 开始进行创意制作服务扩容操作，从万相黑盒挪30卡，并沟通从文案大模型的黑盒中挪一些资源，其中 [@云芑](undefined/yunqi.zm) 对ACB-Image离线制作服务缩容，腾挪资源；\n\n2024-09-03 15:10， [@麟彦](undefined/zmh356266) 询问停止 BP 的刷追投创意后下游情况，[@彦谦](undefined/yanqian.lyl)[@皮咔](undefined/pika.qy) 反馈时间和趋势上看不出明显变化；\n\n2024-09-03 15:42，[@雨行](undefined/yuxing.hqb) 完成创意制作服务全部扩容，但是创意算法服务QPM无明显提升；[@皮咔](undefined/pika.qy) 开始操作扩大 30% 请求算法制作并发数（40-52）；\n\n2024-09-03 16:13， [@少奇](undefined/eric.wb) 组织线下会议（C1-304）协同排查；\n\n2024-09-03 16:16， [@皮咔](undefined/pika.qy) 发布完成；\n\n2024-09-03 16:20， [@云芑](undefined/yunqi.zm) 提到图像制作 RT 上涨可能和 [@皮咔](undefined/pika.qy) 这边的 igraph 查询服务 14:35 失败有关；\n\n2024-09-03 16:42，[@静琬](undefined/jingwan.fxy)同学反馈此时聚类客诉55例；\n\n2024-09-03 16:47，[@皮咔](undefined/pika.qy)在[@雨行](undefined/yuxing.hqb)的协助下恢复 igraph 查询服务，图像制作服务RT恢复正常，文案制作服务QPM短暂回升，但堆积问题未缓解；\n\n2024-09-03 17:08，截止至17:42分[@皮咔](undefined/pika.qy) 调整增加请求下游并发（52-120），没有明显帮助，发布后短时间内消费量可以上涨\n\n2024-09-03 17:30， [@云芑](undefined/yunqi.zm)停掉失败重放的小时级请求，以尽可能减少整体服务请求量；\n\n2024-09-03 18:10， [@少奇](undefined/eric.wb)发现存在一个kgb外投离线补数据的d2节点；\n\n2024-09-03 18:18，[@云芑](undefined/yunqi.zm)确认该节点不关键后，操作停掉kgb离线补数据；\n\n2024-09-03 18:20， [@广生](undefined/guangsheng.wds)提出找 metaQ 同学帮助排查，[@泽萱](undefined/zexuan.zzy)电话 metaQ 同学介入帮助看消费缓慢问题，发现消费卡在请求下游线程，怀疑可能是 CTM 性能问题；\n\n2024-09-03 18:57，截止至19:46分，现场同学帮助分析可能性能原因，由 [@皮咔](undefined/pika.qy) 操作调整降低请求下游并发（120-40），扩服务核数，仍没有明显帮助；\n\n2024-09-03 20:19，[@皮咔](undefined/pika.qy) 为排除离线制作请求的影响， 操作停止 CTM 上的视频 action2 离线 DB 制作任务，没有明显帮助；\n\n2024-09-03 21:00， [@彦谦](undefined/yanqian.lyl) 等同学共同提出为排除其它制作请求影响，可以发布单台机器所缩小消费范围内验证，[@皮咔](undefined/pika.qy)[@彦谦](undefined/yanqian.lyl)分别发布单台 CTM 机器，只消费图文队列消息，验证问题出在图文队列内部；\n\n**2024-09-03 21:11**， [@彦谦](undefined/yanqian.lyl) 发现请求到CTM 单机里仍存在 300s 超长请求，发给[@皮咔](undefined/pika.qy) ，分析请求内容，确认是图像队列里出现了预期外的视频制作消息；**——【故障定位】**\n\n**2024-09-03 21:32**， [@皮咔](undefined",
    "chunk_order_index": 1,
    "full_doc_id": "doc-32d16e33180164f22bb7a6a392eec35f"
  },
  "chunk-7fbfa62248caf01774c5ab99f08c780b": {
    "tokens": 1200,
    "content": "21:11**， [@彦谦](undefined/yanqian.lyl) 发现请求到CTM 单机里仍存在 300s 超长请求，发给[@皮咔](undefined/pika.qy) ，分析请求内容，确认是图像队列里出现了预期外的视频制作消息；**——【故障定位】**\n\n**2024-09-03 21:32**， [@皮咔](undefined/pika.qy) 根据异常视频请求的共性特征，分四批发布 CTM 资源隔离方案，将预期外的视频制作请求挪到新的队列中消费；**——【恢复执行】**\n\n**2024-09-03 21:50，**CTM资源隔离方案发布完成；**——【故障恢复】**\n\n2024-09-03 22:00， 观察中间件平台确认消息链路不再堵塞；\n\n2024-09-03 22:02， [@皮咔](undefined/pika.qy) 操作恢复 CTM 上的视频 action2 离线 DB 制作任务；\n\n2024-09-03 22:05， [@少奇](undefined/eric.wb) 操作恢复失败重放的小时级请求；\n\n**2024-09-03 22:31**， 堆积消息完全消费完。**——【影响消除】**\n\n## 三、影响产品线&影响面\n    - [x] 是否有客诉量：\n        * 故障期间整体客诉量：84例（去重后）\n\n链接：[https://aliyuque.antfin.com/qf9pla/dx8mse/zs13byulnad58mg8#BaBo](https://aliyuque.antfin.com/qf9pla/dx8mse/zs13byulnad58mg8#BaBo)\n\n截图：\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256396/1725591650708-bc3570ae-01c0-43c3-b69a-ecf318724860.png)\n\n## 四、故障原因\n### 4.1【背景说明】\n+ _**【业务链路】**___\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/303126/1725853728860-96266fa0-d705-447c-9327-67e230321173.png)\n\n+ **【需求背景】**\n\n原来一个创意里有多个尺寸素材，投放时若图片尺寸不满足，会被过滤掉，浪费quota，所以需要按尺寸拆成两个创意(1:1和3:4)\n\nprd:[https://alidocs.dingtalk.com/i/nodes/gvNG4YZ7Jnxop15OC2GZjdX6W2LD0oRE?rnd=0.49735678879015377](https://alidocs.dingtalk.com/i/nodes/gvNG4YZ7Jnxop15OC2GZjdX6W2LD0oRE?rnd=0.49735678879015377)\n\n### 4.2【原因分析】\n**一句话原因：**\n\n直播高RT的视频制作任务（预期外）打到了图文制作服务队列，造成图文制作阻塞。\n\n关键词场景只有一个走算法创意，无原始创意，制作队列堆积后，导致创意不可投。\n\n**根因分析：**\n\n1、堆积原因：\n直播创意尺寸拆分需求后，制作metaq.tag保持不变，依然用tag=atomo_live_video_query进行制作，但未正确指定taskname[注：目标算法服务的标识]，导致请求到了高RT的视频服务，进一步导致主要是低RT队列里消息堆积。\n\n2、关键词创意不可投原因：\n二期创意中，人群场景有多种尺寸，所以每个尺寸对应一个原始创意+一个算法制作创意；关键词场景，只有1:1广告创意，且引擎希望控制创意数量，所以只有一个算法制作创意；当制作堆积时，人群场景中，如果客户图的尺寸满足资源位要求，则可直接投放，但关键词场景不可投。\n\n\n\n## 五、关注点分析\n### 5.1【系统质量】\n#### 5.1.1 需求&设计评估\n**〖关注点〗****是否涉及产品、技术方案评估？此核心的问题是什么，如何改进？**\n\n    - [x] **是，涉及**\n        - [ ] 需求评估遗漏\n        - [ ] 产品设计缺陷\n        - [x] 系统架构设计缺陷：\n\n            - [ ] 容错性不足 \n\n    - [ ] 单点，无冗余\n\n    - [ ] 缺乏自我保护\n\n            - [ ] 缓存设计不当\n\n    - [ ] 容量评估不足\n\n    - [ ] 非幂等设计\n\n            - [ ] 强弱依赖不合理\n\n    - [x] 其他：       接口细节评估遗漏       \n\n    - [ ] **否，不涉及**\n\n**〖改进点〗**_****_\n\n1、约定新增场景的taskname为必填字段，同时存量场景在迁移或者升级的时候确保taskname补全；梳理新增场景梳理出标准SOP指导手册",
    "chunk_order_index": 2,
    "full_doc_id": "doc-32d16e33180164f22bb7a6a392eec35f"
  },
  "chunk-cfa48960c47582ecb1d16bc14cdbb32a": {
    "tokens": 1200,
    "content": "幂等设计\n\n            - [ ] 强弱依赖不合理\n\n    - [x] 其他：       接口细节评估遗漏       \n\n    - [ ] **否，不涉及**\n\n**〖改进点〗**_****_\n\n1、约定新增场景的taskname为必填字段，同时存量场景在迁移或者升级的时候确保taskname补全；梳理新增场景梳理出标准SOP指导手册。\n\n#### 5.1.2 代码质量\n##### **〖关注点1〗****CodeReview阶段**\n+ **是否经过CR（****红线点****）**\n\n- [x] 是   请提供代码提交or合并的Aone链接：  [https://code.alibaba-inc.com/AdPlatform/ad-creative/codereview/17902248](https://code.alibaba-inc.com/AdPlatform/ad-creative/codereview/17902248) \n\n- [ ] 否\n\n- [ ] 不涉及\n\n+ **是否设置合理的CR卡点**\n\n- [x] 是     \n\n- [ ] 否\n\n- [ ] 不涉及\n\n注：[CR卡点设置要求](https://ata.alibaba-inc.com/articles/225396?spm=ata.25287382.0.0.5e0c7536X43l05)\n\n+ **CodeReview阶段是否发现问题？**\n\n- [ ] 是\n\n- [x] 否，未发现原因：对taskName参数的作用/影响，理解不一致。测试的时候，双方均没有对字段有明确指定要求。\n\n**〖改进点〗**_****_\n\n1、对请求算法的相关字段，如requestMetaqTag,taskName等后续需提供明确的要求。\n\n##### **〖关注点2〗****单测阶段**\n+ **在线变更，****是否经过功能单测：（****红线点****）**\n\n        - [x] 是\n\n- [ ] 否\n\n+ **离线变更，****生成的离线数据是否经过数据校验：**（**红线点**，校验内容：与发布前版本对比，校验数据条数、数据大小、关键字段值域正态分布等是否符合预期）\n\n        - [ ] 是\n\n- [ ] 否\n\n+ **单测阶段是否发现问题？**\n\n- [ ] 是\n\n- [x] 否，未发现原因：单侧无法发现算法性能问题。\n\n##### **〖关注点3〗****测试阶段**\n+ **测试内容：**[https://tpm.alibaba-inc.com/testProject/testProjectDetail?id=1116&key=827](https://tpm.alibaba-inc.com/testProject/testProjectDetail?id=1116&key=827)\n+ **测试人员：卡卡**\n+ **是否经过测试验证：**\n    - [x] 是\n\n验证环境：\n\n- [x] 预发环境\n\n- [ ] 日常环境\n\n测试方法：\n\n- [ ] 回归测试\n\n- [ ] 集成测试\n\n- [ ] 链路测试\n\n- [x] 验收测试\n\n    - [ ] 否\n\n- [ ] 不涉及\n\n+ **是否自动化测试可覆盖：**\n\n    - [ ] 是\n\n- [x] 否\n\n\n\n+ **测试未发现的原因：**\n    - [ ] 回归遗漏\n\n        - [ ] 手工回归case遗漏\n\n- [ ] 自动化未建设\n\n- [ ] 自动化回归覆盖不足\n\n- [ ] 其它： \n\n    - [x] 新场景遗漏\n\n        - [ ] 功能测试用例遗漏，包括正常分支和异常分支\n\n- [ ] 容灾兜底测试遗漏\n\n        - [ ] 客户端兼容性测试遗漏\n\n- [ ] 埋点测试遗漏\n\n        - [ ] 性能测试遗漏，影响评估不足\n\n- [ ] 安全测试遗漏\n\n        - [x] 其他：  应该仅测试召回是否正常，对细节内容和字段不关注。 也不会测试算法的性能问题。  \n\n****\n\n**〖分析〗**\n\n直播视频制作中误发，测试阶段指定正确与否产出的结果都是制作失败，因为不需要视频制作，图文制作是正常的，不影响广告主投放，所以无法反映出本次问题。\n\n#### 5.1.3 变更质量\n+ **是否涉及变更：**\n\n    - [x] 是\n\n- [ ] 否\n\n\n\n+ **变更类型：**\n\n- [x] 在线生产代码变更\n\n- [ ] 引擎全量索引变更\n\n- [ ] 实时索引更新变更\n\n- [ ] 算法模型变更\n\n- [ ] whaleshark实验参数变更\n\n- [x] 其他变更：         diamond            \n\n- [ ] 不涉及\n\n+ **变更平台是否接入ChangeFree：**\n    - [x] 是，CF变更单链接： [https://aicf.alibaba-inc.com/aicf/change/v2/detail/1167430517?spm=goc-apm.aicf-_changeList.0.0.48162388ixZntb](https://aicf.alibaba-inc.com/aicf/change/v2/detail/1167430517?spm=goc-apm.aicf-_changeList.0.0.48162388ixZntb) \n    - [ ] 否，外部变更系统： \n+ **是否违反变更红线3.2**** **[**链接**](https://aliyuque.antfin.com/trecs",
    "chunk_order_index": 3,
    "full_doc_id": "doc-32d16e33180164f22bb7a6a392eec35f"
  },
  "chunk-b8303bae85f10b60be84a035a077e589": {
    "tokens": 1200,
    "content": "0.48162388ixZntb](https://aicf.alibaba-inc.com/aicf/change/v2/detail/1167430517?spm=goc-apm.aicf-_changeList.0.0.48162388ixZntb) \n    - [ ] 否，外部变更系统： \n+ **是否违反变更红线3.2**** **[**链接**](https://aliyuque.antfin.com/trecs/fzg6dy/uar1k6)\n    - [ ] 是，违反哪条原则：\n    - [x] 否\n\n##### **〖关注点1〗****灰度阶段**\n变更执行影响面**资损低于20%**或影响**客户数量低于20%**的变更统一称为灰度变更\n\n+ **是否经过灰度：（****红线点****）**\n- [x] 是，\n    - 是否有效灰度（灰度发布时间间隔大于20分钟）：\n\n        - [x] 是\n\n- [ ] 否\n\n- [ ] 否\n+ **观测了哪些监控**：_附链接_\n    - [ ] 黑屏、白屏\n    - [ ] GOC监控： \n    - [x] 系统大盘： [https://x.alibaba-inc.com/application/appmonitor/ad-creative/monitor/basic?](https://x.alibaba-inc.com/application/appmonitor/ad-creative/monitor/basic?) \n    - [ ] 其他： \n+ **是否灰度期间发现问题？**\n    - [ ] 是\n\n        - [ ] 灰度流量过大，引发故障\n\n- [ ] 灰度发现但未有效或及时修复，导致故障\n\n- [ ] 其它： \n\n    - [x] 否，未发现原因：\n\n        - [ ] 应用灰：\n\n- [ ] 灰度流量太小\n\n- [ ] 灰度阶段无法监控\n\n- [ ] 灰度批次不合理\n\n- [ ] 超长时间恢复才能发现\n\n        - [ ] 业务灰：策略不合理\n        - [ ] 灰度无法发现\n        - [x] 其它：   流量小，未触发此次问题。    \n\n**〖改进点〗**_****_\n\n暂无\n\n##### **〖关注点2〗****上线阶段**\n+ **是否在窗口期进行发布变更：**【周一~周五 09：30~20：00（注意避开吃饭时间12:00~13:30）】\n    - [x] 是\n    - [ ] 否，原因： \n+ **变更是否影响上下游**\n    - [x] 是，是否有提前知会上下游评估及关注变更\n        - [x] 有提前知会\n        - [ ] 没有提前知会\n    - [ ] 否\n+ **是否分批分机房或分批发布：（****红线点****）**\n\n    - [x] 是\n\n\n\n    - 分机房或分批发布第一批发布时间间隔是否大于20分钟：\n\n        - [x] 是\n\n- [ ] 否\n\n    - [ ] 否\n+ **是否进行黄金眼指标观察：**（涉及引擎相关变更，此点为**红线点**，变更10分钟左右，观察已发布本机房、核心pid、分广告主体类型的黄金眼业务指标）\n    - [ ] 是，观测监控链接： \n    - 是否发现问题\n\n        - [ ] 是\n\n- [ ] 否，原因： \n\n    - [ ] 否\n    - [x] 不涉及\n+ **是否验证变更改动点：**(**红线点**，已变更的功能逻辑&数据已经生效)\n    - [x] 是 (请提供观测监控链接，或直接/间接生效截图记录)： \n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/219530/1725866687177-cb4872a8-de23-47f9-ad45-fafc565a29ba.png)\n\n    - 是否发现问题\n\n        - [ ] 是\n\n- [x] 否，原因： 当前流量未导致算法出现堆积问题                             \n\n    - [ ] 否\n+ **是否验证其它核心变点：**(错误日志/功能或接口成功率或失败率/rt、CPU、内存等系统指标等)\n    - [x] 是 验证点： [https://x.alibaba-inc.com/application/appmonitor/ad-creative/monitor/basic?](https://x.alibaba-inc.com/application/appmonitor/ad-creative/monitor/basic?) \n    - 是否发现问题\n\n        - [ ] 是\n\n- [x] 否，原因：    当前流量未导致算法出现堆积问题                           \n\n    - [ ] 否\n\n**〖改进点〗**_****_\n\n1、持续关注点：根据算法反馈，确认并周期性对无效请求进行定期清理。\n\n### 5.2【处置能力】\n#### 5.2.1 故障发现&响应\n+ **是否监控发现**\n    - [x] 是，监控报警链接/截图如下：\n        - [x] muse团队状态监控（创意可投率）：\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/103576/1725857391335-96254e",
    "chunk_order_index": 4,
    "full_doc_id": "doc-32d16e33180164f22bb7a6a392eec35f"
  },
  "chunk-162235cd82bb9c5bf6e9631cb65a1f3e": {
    "tokens": 1200,
    "content": "理。\n\n### 5.2【处置能力】\n#### 5.2.1 故障发现&响应\n+ **是否监控发现**\n    - [x] 是，监控报警链接/截图如下：\n        - [x] muse团队状态监控（创意可投率）：\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/103576/1725857391335-96254e3b-bb36-4675-96ff-3817534d7657.png)\n\n        - [x] 创意引擎团队，消息堆积报警监控，链接：[@皮咔](undefined/pika.qy)[https://q.alibaba-inc.com/region/sh/monitors?consumerId=CID-alimama-algo-common&topic=scs_creative_make_command](https://q.alibaba-inc.com/region/sh/monitors?consumerId=CID-alimama-algo-common&topic=scs_creative_make_command)\n        - [x] 创意算法团队，消息堆积报警群，截图如下：\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/236219/1725863580094-996b9404-6638-4700-aba3-6f27edff3598.png)\n\n        - [x] 故障触发方\n\n- [x] 受影响方\n\n    - [ ] 否，原因为：\n\n        - [ ] 监控缺失\n\n- [ ] 监控无效\n\n- [ ] 无法监控\n\n+ **发现后是否五分钟内响应**\n    - [x] 是\n    - [ ] 否，原因为：\n+ **应急协同组织是否存在问题，如何改进？**\n    - [ ] 是\n        - [ ] 应急流程不明确（无流程或者流程不清晰、应急相关角色&职责不明确，缺失一号位等)\n        - [ ] 应急执行不到位（有流程，但未按流程执行，通告发送不及时，响应不及时等）\n    - [x] 否\n\n**〖改进点〗**_****_\n\n1、muse团队状态监控，针对创意可投率监控阈值进行调整，确保监控有效性和报警及时性；——负责人：彦谦   预计：09.20   验收人：皮咔\n\n2、创意制作到处理过程中新增创建时间较长的监控报警；——负责人：皮咔     预计：待调研    验收人：少奇\n\n#### 5.2.2 故障定位&恢复\n+ **主要恢复方式：**\n\n    - [ ] 代码发布/回滚\n\n- [x] 配置发布/回滚\n\n- [ ] 数据订正\n\n- [ ] 机器隔离/重启/扩容\n\n    - [ ] 配置限流\n\n- [ ] 预案降级\n\n- [ ] 自动恢复\n\n- [ ] 其它： \n\n+ **是否10分钟内恢复**__\n    - [ ] 是\n    - [x] 否\n\n**〖关注点1〗定位&恢复阶段存在什么问题？是否可以增加预案，****有更快的恢复方式？****相关的优化改进？**\n\n分析：定位时间较长，初步排查认为是资源问题导致，进行扩容、扩并发操作发现无效后，才引入中间件团队同学协助排查，进一步定位到原因。\n反思：不能一味的自查，可以及时通过其他团队协助排查提高定位时效。\n1、本次问题是部分用户受影响，即部分图文处理阻塞，针对遇到问题后的统计口径需要进一步梳理，制作失败/超时RT需要被考虑，将统计口径调整的更为全面，从业务场景做出不同维度的监控拆分；——负责人：皮咔    预计：09.20         验收人： 少奇、彦谦\n2、采集分析异常/超时日志，按类型进行区分，针对不同业务线RT分析后进一步处理优化；——负责人：皮咔     预计：待评估     验收人：少奇、彦谦\n\n\n**〖关注点2〗业务自身是否具备容灾逃逸能力？后续如何改进？**__\n\n- [ ] 具备容灾能力\n\n    - [ ] 因未演练不敢执行\n\n- [ ] 因有损评估决策不执行\n\n- [ ] 无决策或者决策不当，未执行\n\n- [x] 不具备容灾能力\n\n**〖改进点〗**\n\n暂无\n\n## 六、故障总结反思\n+ **此次故障是否触发广告技术部安全生产考试中的红线点？**\n\n- [ ] 是，团队： \n\n- [x] 否\n\n## 七、故障Action\n| **序号** | *******Action标题** | *******负责人** | *******计划完成时间** | **Action描述** | **验收标准** | **验收人** | **是否keyAction** | **是否回血Action** |\n| :---: | --- | :---: | :---: | --- | --- | :---: | :---: | :---: |\n| 1 | 短期：任务队列白名单 | 皮咔",
    "chunk_order_index": 5,
    "full_doc_id": "doc-32d16e33180164f22bb7a6a392eec35f"
  },
  "chunk-7a0a997de995286e10415ec4c4e70c81": {
    "tokens": 870,
    "content": "号** | *******Action标题** | *******负责人** | *******计划完成时间** | **Action描述** | **验收标准** | **验收人** | **是否keyAction** | **是否回血Action** |\n| :---: | --- | :---: | :---: | --- | --- | :---: | :---: | :---: |\n| 1 | 短期：任务队列白名单 | 皮咔 | 09.20 | 任务队列白名单：需要重点排查图文队列中夹杂的视频请求。区分开创意链路中图文和视频请求，确保不相互影响。 | 确保创意链路中图文和视频请求不相互影响。 | - | 是 | - |\n| 2 | 短期：提升创意稳定性 | 少奇 | 09.20 | 算法服务监控并周期性分析失败率极高的请求，反馈至MUSE。 | 确保算法服务监控并周期性分析失败率极高的请求，反馈至MUSE。 | 彦谦 | 是 | - |\n| 4 | 短期：梳理相关字段配置要求 | 彦谦 | 09.20 | 约定新增场景的taskname为必填字段，同时存量场景在迁移或者升级的时候确保taskname补全；以文档的形式产出具体字段配置要求。对请求算法的相关字段，如requestMetaqTag,taskName等后续需提供明确的要求。 | 确保以文档形式产出具体字段配置要求 | 皮咔少奇 | 是 | - |\n| 6 | 短期：调整创意可投率监控 | 彦谦 | 09.20 | muse团队状态监控，针对创意可投率监控阈值进行调整，确保监控有效性和报警及时性。 | 确保创意可投率监控阈值合理。 | 皮咔 | 是 | - |\n| 8 | 短期：按业务场景进行监控拆分 | 皮咔 | 09.20 | 针对遇到问题后的统计口径需要进一步梳理，制作失败/超时RT需要被考虑，将统计口径调整的更为全面，从业务场景做出不同维度的监控拆分。 | 确保统计口径合理性，以及监控从业务场景维度进行拆分。 | 少奇彦谦 | - | - |\n| 3 | 短期：清理无效请求 | 彦谦 | 09.27 | 根据算法反馈，确认并周期性对无效请求进行定期清理。 | - | - | 是 | - |\n| 5 | 长期：架构优化 | 彦谦文歆 | 待评估 | 不需要算法加工的素材，BP直接处理并由MUSE添加至素材组，需要算法加工的素材才请求算法。技术方案待评估后进一步确认。 | - | - | - | - |\n| 7 | 短期：新增创建时间较长的监控报警 | 皮咔 | 待调研 | 创意制作到处理过程中新增创建时间较长的监控报警（目前只支持队列长度，受业务影响较大，误报较难发现）。 | 确保新增创意制作时间较长的监控报警。 | 少奇 | - | - |\n| 9 | 短期：采集分析异常/超时日志并进行优化处理 | 皮咔 | 待评估 | 采集分析异常/超时日志，按类型进行区分，针对不同业务线异常/超时情况分析后进一步处理优化。 | 确保分析异常/超时日志后进行优化处理。 | 少奇彦谦 | - | - |",
    "chunk_order_index": 6,
    "full_doc_id": "doc-32d16e33180164f22bb7a6a392eec35f"
  },
  "chunk-fee4336c9d563781c9eab7586fad1407": {
    "tokens": 1200,
    "content": "## 一、故障简述\n于2024年9月10日16:37分外投二跳入口流量ingress-2服务ea120集群请求qps开始下跌，初步怀疑是上游abyss调用vipserver超时导致，经排查发现是ingress-2服务ea120集群在16:37分分配了一台ea119的机器，上游abyss只有ea119机器，导致流量全打到ea119一台机器上，通过删除ea120集群上的ea119节点机器，业务请求于17:50分恢复正常。故障期间累计资损金额17.6万元。\n\n\n**APM故障链接：**\n\n [https://trfree.alibaba-inc.com/ormEmergency/workbench/emergency/202409120000002193001](https://trfree.alibaba-inc.com/ormEmergency/workbench/emergency/202409120000002193001)\n\n## 二、故障过程回顾\n### 2.1【妈妈侧时间线概览】\n![画板](https://intranetproxy.alipay.com/skylark/lark/0/2024/jpeg/80256396/1726220682012-d8929ab3-6927-4c9d-b867-0765b8213a93.jpeg)\n\n故障发现～初因定位：55min\n\n初因定位～恢复执行：10min\n\n### 2.2【故障处理时间线】\n2024-09-10 16:37，外投二跳入口流量ingress-2服务ea120集群请求qps开始下跌；\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/23456529/1726236239184-d7975e12-c6af-4b85-b130-591a21c31aeb.png)\n\n2024-09-10 16:45，妈妈侧外投引擎团队通过入口QPS监控报警，发现ea120入口流量下跌，群里通知上游同学排查；资损金额达到15万元；**——【故障发生】【阿里妈妈侧故障发现】【业务响应】**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/23456529/1726236375751-40c1514e-b2f7-42b6-a208-2427f7199492.png)\n\n2024-09-10 16:50，展示广告引擎团队收到有关展示广告收入下跌的监控报警；\n\n2024-09-10 16:52，蚂蚁侧收到农场小院等多展位收入和曝光下跌告警；**——【蚂蚁侧故障发现】**\n\n2024-09-10 16:55，展示广告引擎团队定位到是外投引擎的问题，并联系相关同学排查；\n2024-09-10 17:10，蚂蚁侧展位GMV同比下跌大于等于30%持续30分钟触达P5；**——【蚂蚁侧故障发生】**\n\n2024-09-10 17:39，蚂蚁侧通过发布实验，降低全部展位二方广告返回的超时时间，以降低体验影响；\n\n2024-09-10 17:40，经过kmonitor入口QPS监控逐个排查ingress-2服务中IP收到流量的情况，定位到异常IP，进一步排查发现是ingress-2服务的ea120集群中混入ea119机器，导致其他ea120机器没有流量，上游流量全部打到一台ea119机器上；开始操作删除ea120集群上ea119节点机器；**——【初因定位】【恢复执行】**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/23456529/1726236463609-9ffcd3fa-f11a-4da0-b3fd-f23c2e7af439.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/23456529/1726236602629-e7704a09-a41c-42a0-94b2-2590dbe26106.png)\n\n2024-09-10 17:50，机器重启后流量恢复至日常水位；**——【故障恢复】【影响消除】**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/23456529/1726236239184-d7975e12-c6af-4b85-b130-591a21c31aeb.png?x-oss-process=image%2Fformat%2Cwebp%2Fresize%2Cw_937%2Climit_0)\n\n2024-09-10 17:56，妈妈侧确认恢复，蚂蚁侧回滚应急发布实验。****\n\n## 三、影响产品线&影响面\n    - [ ] 是否有客诉量：\n        * 在线，热线，排队量\n    - [x] 是否产生资损：\n        * 故障期间展示广告累计资损金额17.6万元，触达阿里妈妈侧P5资损标准\n        * 多个核心展位曝光量同步下跌大于30%持续30min，触达蚂蚁侧P5\n\n## 四、故障原因",
    "chunk_order_index": 0,
    "full_doc_id": "doc-492553886a5fbfa790dee87c55c5a226"
  },
  "chunk-0bd28c0ddadb4d8f0f8f2e0b20dcfb7b": {
    "tokens": 1200,
    "content": "&影响面\n    - [ ] 是否有客诉量：\n        * 在线，热线，排队量\n    - [x] 是否产生资损：\n        * 故障期间展示广告累计资损金额17.6万元，触达阿里妈妈侧P5资损标准\n        * 多个核心展位曝光量同步下跌大于30%持续30min，触达蚂蚁侧P5\n\n## 四、故障原因\n### 4.1【一句话原因】\n二跳ingress-2服务ea120集群混入一台ea119机器，导致流量全部打到ea119机器上。\n\n### 4.2【详细原因】\n**【业务链路图】**\n\n![画板](https://intranetproxy.alipay.com/skylark/lark/0/2024/jpeg/23456529/1726285784674-23ae24a5-5da6-4f22-a0e5-8098f55ffed8.jpeg)\n\ningress-2服务ea120集群在16:37分分配了一台ea119的机器，上游abyss服务只有ea119机器，导致流量全打到ea119那一台机器上，导致流量下降。\n\nvipserver未配置机房归组（目前已补充）。![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/23456529/1726236921325-5c64d214-d393-4e32-9b6f-201d8e0db5b2.png)\n\n**【集群机器分发机制】**\n\n由于vipserver未配置机房归组，新增ea119机房，触发vipserver路由策略调整：跨机房访问切换到同机房访问；\n\nvipserver上没有配置机房归组时，优先访问同机房，若下游服务无同机房，访问同网段的机房；\n\n![画板](https://intranetproxy.alipay.com/skylark/lark/0/2024/jpeg/17056786/1726282966461-6f0cd464-8513-44e1-bc60-c6e0650b4536.jpeg)\n\nVipserver机房归组指的是将几个机房组成逻辑上的一个机房，当指定同机房优先调用策略时，归到一组的机房则认为是在一个机房；\n\n![画板](https://intranetproxy.alipay.com/skylark/lark/0/2024/jpeg/17056786/1726282705965-a588f8b7-c490-43f1-9021-b177ce0fc3c0.jpeg)\n\n**120机房混入119机房机器说明：**\n\nad_hippo_ea120集群，是一个混布多机房的集群，资源能直接多机房随机分配，所以120集群可能是以下的任意机房机器。\n\n可以给应用强制加label的方式避免此种情况： sigma.ali/site=ea120\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/11756623/1726298332938-d15a24de-2f3a-483e-8241-065e7b4813ec.png)\n\n## 五、关注点讨论\n#### 1、问题引入阶段——不涉及\n【在/离线变更代码开发完成后，需要经过**code review**确认无误后进行合并**代码主干**提交】--红线点\n【在线变更代码修改提交必须经过**功能单测；**离线变更代码修改完成后，生成的离线数据必须要经过**数据校验**】--红线点\n\n**〖关注点1〗**是否有经过CR？是否有经过单测？是否有经过测试？是否自动化测试可覆盖？测试阶段为何没发现？\n请提供CR链接： 无变更\n [原因分析]\n ACTION：\n\n【生产变更，**务必要经过灰度发布**，灰度发布时间**间隔大于20min****】**--红线点\n\n**〖关注点2〗**是否变更窗口期进行发布？是否经过灰度？分机房或分批发布第一批发布时间间隔是否大于20分钟？灰度过程中为何未发现问题？\n请提供ChangeFree变更单链接：无变更\n [原因分析]\n ACTION：\n\n\n\n\n\n**【****黄金眼指标观察**，10分钟左右，观察已发布**本机房、核心pid、分广告主体类型**的黄金眼业务指标】--红线点\n\n**【****变更改动点验证**，验证已变更的**功能逻辑&数据已经生效**(最好有直接或间接生效截图记录)**】**--红线点\n\n**〖关注点3〗**是否进行黄金眼指标观察，观察是否发现问题？是否验证变更改动点，验证是否发现问题？\n\n请提供观测链接：无变更\n [原因分析]\n ACTION：\n\n#### 2、故障应急阶段\n**〖关注点4〗**是否有监控发现？若没有，为什么？（监控缺失/报警太多未及时处理/。。） \n[原因分析] 有监控发现流量下跌，但是没有监测上游获取vipserver的机器ip\n\n外投效果引擎ingress-2入口QPS监控链接：[https://x.alibaba-inc.com/custom/49",
    "chunk_order_index": 1,
    "full_doc_id": "doc-492553886a5fbfa790dee87c55c5a226"
  },
  "chunk-159b6be98e7a7e89d2f3a5f71c52cb9c": {
    "tokens": 969,
    "content": "分析]\n ACTION：\n\n#### 2、故障应急阶段\n**〖关注点4〗**是否有监控发现？若没有，为什么？（监控缺失/报警太多未及时处理/。。） \n[原因分析] 有监控发现流量下跌，但是没有监测上游获取vipserver的机器ip\n\n外投效果引擎ingress-2入口QPS监控链接：[https://x.alibaba-inc.com/custom/49/product/preview/multiMinute/1290?crossTenant=true](https://x.alibaba-inc.com/custom/49/product/preview/multiMinute/1290?crossTenant=true)\n\n[https://sqi.alibaba-inc.com/beacon/index.htm#/alarm_add?path=2730128&itemId=57126125](https://sqi.alibaba-inc.com/beacon/index.htm#/alarm_add?path=2730128&itemId=57126125)\n\n展示广告引擎侧监控链接：\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256396/1726228327032-805df630-db06-4e0e-bd03-c39287df5b8a.png)\n\n ACTION：后续补充上游服务获取vipserver的机器ip是否正常的监控，便于后续出现问题快速排查定位根因。——负责人：宸珑      预计：待评估      验收人：共持\n目前妈妈侧有整条链路的漏斗情况，可以看见各业务侧域名入口流量，新增整体链路监控大盘；——负责人：共持     预计：09.20      验收人：宸珑\n**〖关注点5〗**相关角色的应急响应是否有改进空间？故障恢复方式是什么？是否可优化\n[原因分析]  未增加相应监控导致定位问题较困难。删除异常节点后恢复。\n ACTION：  暂无。\n\n## 六、后续Action\n| **序号** | *******Action标题** | **Action描述** | *******负责人** | *******计划完成时间** | **验收标准** | **验收人** | **是否keyAction** | **是否回血Action** |\n| :---: | --- | --- | :---: | :---: | --- | :---: | :---: | :---: |\n| 1 | 短期：机房归组配置 | vipserver配置机房归组。 | 共持 | 已完成 | - | - | 是 | - |\n| 2 | 长期：新增上游获取vipserver机器IP相关监控 | 后续补充上游服务获取vipserver的机器ip是否正常的监控，便于后续出现问题快速排查定位根因。 | 宸珑 | 待确认 | 确保新增有关上游服务获取vipserver的机器ip监控 | 共持 | - | - |\n| 3 | 长期：新增整体链路监控大盘 | 目前妈妈侧有整条链路的漏斗情况，可以看见各业务侧域名入口流量，新增整体链路监控大盘。 | 共持 | 09.20 | 确保如果再出现问题通过整体链路监控大盘及时定位到问题原因。 | 宸珑 | 是 | - |\n\n\n\n\n## 七、故障相关方\n【故障等级】P5\n\n| **  系统质量（30%）** | | | | | **处置能力（70%）** |\n| --- | --- | --- | --- | --- | :---: |\n| **相关方** | **需求设计** | **代码质量** | **变更质量** | **自定义项** | **发生时间** | **发现时间（30%）** | **恢复时间（40%）** |\n| 淘天集团-用户平台&阿里妈妈事业部-阿里妈妈-广告技术部-工程技术-大外投&营销引擎-外投效果引擎 | 不涉及 | 不涉及 | 不涉及 | 历史因素导致配置遗漏 | 09-10 16:45 | 09-10 16:45 | 09-10 17:50 |\n|  |  |  |  |  |  |  |  |\n|  |  |  |  |  |  |  |  |\n\n\n  \n\n\n###",
    "chunk_order_index": 2,
    "full_doc_id": "doc-492553886a5fbfa790dee87c55c5a226"
  },
  "chunk-235a99ab54d79dae61c68945732f17b2": {
    "tokens": 1200,
    "content": "## 一、故障简述\n**故障简述：**\n\n于2024年9月9日09:30分广告技术部预警群收到有关精准人群推广计划消耗集中的客诉预警单，经排查由于lindorm bulkload导入时构建索引异常，导致databus中adgroup_ppb_ais_mm任务失败，因此线上target roas（目标投放计划类型）计划依赖的笔单价数据读取不到改用默认值50，导致笔单价低于50的计划ppc提升过高。通过操作出价参数回滚，业务于13:20分恢复。故障期间累计客诉15例。\n\n**APM故障链接：**\n\n[https://trfree.alibaba-inc.com/ormEmergency/workbench/emergency/202409090000000254001](https://trfree.alibaba-inc.com/ormEmergency/workbench/emergency/202409090000000254001)\n\n## 二、故障过程回顾\n### 2.1【妈妈侧时间线概览】\n![画板](https://intranetproxy.alipay.com/skylark/lark/0/2024/jpeg/80256396/1726143258243-72377945-e41b-48e0-9e89-de671cdfd495.jpeg)\n\n### 2.2【故障处理时间线】\n#### **2.2.1【时间线各阶段概括性总结】**\n2024-09-08 08:01，阿里妈妈智能广告平台已离职的算法同学收到有关databus任务失败报警；\n\n**2024-09-08 16:30**，磁盘空间满导致工作节点与ResourceManager断联，进而导致索引导入任务卡住 ；**——【故障引入】**\n\n2024-09-09 06:50，由于前一天lindorm bulkload导入时构建索引异常，导致databus中adgroup_ppb_ais_mm任务失败，从0908 07时后adgroup_ppb_ais_mm表数据不再更新，0909 07时 adgroup_ppb_ais_mm表数据失效；\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/138656555/1725957758567-db4e65ca-b1c0-494c-ade4-f514b4b01b0d.png)\n\n**2024-09-09 09:06**，广告技术部客满团队收到3例有关无界早上精准人群推广计划消耗集中引发的客诉；**——【故障发生】**\n\n**2024-09-09 09:29**，广告技术部收到无界精准人群集中消耗引发的客诉，[@向桐](undefined/wanglianyu.wly)接手预警单开始接入排查；**——【故障发现】【广告技术部业务响应】**\n\n2024-09-09 09:54，[@向桐](undefined/wanglianyu.wly)发现集中消耗客诉全是人群推广targetROAS 计划类型，现象都是展示渠道突然爆量，同时风险预警中三个计划ais调控正常出价参数没有大波动。[@深舟](undefined/shenzhou.xhy)通过一些异常case现象分析，联合Rank同学[@明言](undefined/zhangming.czm)排查部分pid的cvr（成交的预估转化率）预估值上涨是否符合预期，截止至11:01分反馈目前无中小流量实验；经排查并无异常。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/138656555/1726049861878-0d917429-3e47-448b-9203-60573493ac8e.png)\n\n**2024-09-09 10:30**，lindorm团队收到客户反馈导入任务慢，值班同学接入排查 ；**——【lindorm团队业务响应】**\n\n2024-09-09 10:53，[@风沐](undefined/null.wh)反馈431039_1007 431040_1007 这两个位置的原始点击量和昨天基本持平，怀疑是流量分配有问题，经排查流量分配未出现异常；\n\n**2024-09-09 11:34**，lindorm团队对索引导入服务进行重启，重启后新增任务执行成功。遂通知各业务方重试失败的任务；监控值班同学同步技术同学反馈故障已自然恢复，技术反馈异常时间是7点到11点，客满统计最后一例是10:57分，故障应急结束，具体根因还在确认中。**——【阿里云恢复执行】**\n\n2024-09-09 12:39 [@深舟](undefined/shenzhou.xhy)反馈12:21分后target roas cost、ppc有个明显上涨，出价参数有很大的跳变；\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/138656555/1726050251742-e1abd5de-c714-4ae2-9d4c-73a1bd521b42.png)\n\n2024-09-09 12:52，[@深舟](undefined/shenzhou.xhy",
    "chunk_order_index": 0,
    "full_doc_id": "doc-ec4c00520ad11e9d335838d26fafc370"
  },
  "chunk-2e36cef3c344c9ffb6d319372a39aa6c": {
    "tokens": 1200,
    "content": "后target roas cost、ppc有个明显上涨，出价参数有很大的跳变；\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/138656555/1726050251742-e1abd5de-c714-4ae2-9d4c-73a1bd521b42.png)\n\n2024-09-09 12:52，[@深舟](undefined/shenzhou.xhy)分别与[@花笑](undefined/jiaoyu.jy)[@应灵](undefined/durui.dr)[@亮深](undefined/wf169406)确认人群场景bp、引擎、工程团队确认均无变更；\n\n2024-09-09 13:02，[@深舟](undefined/shenzhou.xhy)联系[@亮深](undefined/wf169406)反馈出价参数有很大的跳变，需要回滚参数；\n\n2024-09-09 13:04，[@亮深](undefined/wf169406)反馈可以联系[@念刃](undefined/jiaqi.ajq)协助处理参数回滚操作；\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256396/1726146027112-1fabca21-66ee-4d36-9bb6-7077121392b4.png)\n\n**2024-09-09 13:10**，[@弈理](undefined/gushan.gs)、[@向桐](undefined/wanglianyu.wly)、[@念刃](undefined/jiaqi.ajq)就出价参数有很大的跳变问题，开始分批操作参数回滚；**——【阿里妈妈恢复执行】**\n\n**2024-09-09 13:20**，参数回滚完成；**——【故障恢复】**\n\n**2024-09-09 13:28**，[@深舟](undefined/shenzhou.xhy)[@弈理](undefined/gushan.gs)、[@向桐](undefined/wanglianyu.wly)、[@念刃](undefined/jiaqi.ajq)同步当前进展：**——【初因定位】**\n\n问题原因：lindorm bulkload导入时构建索引异常，引发databus数据导入数据失败，原先未读取到ppb统计值时，所有计划都用的默认值50元，恢复后大部分计划的笔单价超过50元，导致出价参数会有提升。 **\n**解决方案：通过参数回滚修复，下午将targetROAS所有计划进行参数初始化进行彻底修复；\n\n2024-09-09 14:12 [@深舟](undefined/shenzhou.xhy)反馈参数回滚后，有缓解，基本控住。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/138656555/1726050455187-041fdb9d-453e-41f0-ab42-6612b0118fe3.png)\n\n**2024-09-09 15:20**，完成出价参数回滚后放开，计划开始正常调控。**——【影响消除】**\n\n#### **2.2.2【故障详细时间点】**\n| **时间轴** | **事件** |\n| :---: | --- |\n| **2024-09-08 16:30** | **【故障引入】**磁盘空间满导致工作节点与ResourceManager断联，进而导致索引导入任务卡住 ；**** |\n| 2024-09-09 06:50 | 由于前一天lindorm bulkload导入时构建索引异常，导致databus中adgroup_ppb_ais_mm任务失败，从0908 18时后adgroup_ppb_ais_mm表数据不再更新，0909 06:50adgroup_ppb_ais_mm表数据失效；![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/138656555/1725957758567-db4e65ca-b1c0-494c-ade4-f514b4b01b0d.png) |\n| **2024-09-09 09:06** | **【故障发生】**广告技术部客满团队收到3例有关无界早上精准人群推广计划消耗集中引发的客诉；**** |\n| **2024-09-09 09:29** | **【故障发现】**** ****【广告技术部业务响应】**广告技术部收到无界精准人群集中消耗引发的客诉，[@向桐](undefined/wanglianyu.wly)接手预警单开始接入排查；****![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/138656555/1725957959597-0a2ed660-0050-4e5a-b978-31061e9ba155.png) |\n| 2024-09-09 09:30 | 机器人创建应急群开始排查；![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/138656555/1725961196960-6a4f7384-e504-4ce3-9f1f-183a4bfbc390.png) |\n| 2024-09-09 09:",
    "chunk_order_index": 1,
    "full_doc_id": "doc-ec4c00520ad11e9d335838d26fafc370"
  },
  "chunk-b49eaa7343d64aadde8fc5dac0a673c1": {
    "tokens": 1200,
    "content": "e9ba155.png) |\n| 2024-09-09 09:30 | 机器人创建应急群开始排查；![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/138656555/1725961196960-6a4f7384-e504-4ce3-9f1f-183a4bfbc390.png) |\n| 2024-09-09 09:31 | [@竹洲](undefined/zhuzhou.hkw)咨询集中消耗这个问题，是哪一类出价计划； |\n| 2024-09-09 09:51 | [@深舟](undefined/shenzhou.xhy)反馈是target roas出价计划消耗集中； |\n| 2024-09-09 09:54 | [@向桐](undefined/wanglianyu.wly)发现集中消耗客诉全是人群推广targetROAS 计划类型，现象都是展示渠道突然爆量，同时风险预警中三个计划ais调控正常出价参数没有大波动。[@深舟](undefined/shenzhou.xhy)联合Rank同学排查部分pid的cvr预估值上涨是否符合预期。![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/138656555/1726049861878-0d917429-3e47-448b-9203-60573493ac8e.png) |\n| 2024-09-09 10:17 | [@娇娇](undefined/jiaojiao)反馈431039_1007这个pid的ppc涨得比较多；![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256396/1726144292503-b8c35cd0-04d2-45fc-b20f-9276d508ad6e.png)订单id：71595982000 ，展示渠道计划id：71604645001，![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256396/1726144334588-73f5e589-6dd7-4df8-a942-2d2d1bc20bc6.png) |\n| 2024-09-09 10:23 | [@应灵](undefined/durui.dr)反馈[@娇娇](undefined/jiaojiao)给的这个pid（431039_1007）， pcvr存在几个跳变，联系[@明言](undefined/zhangming.czm)协助排查pcvr预估是否有异常；![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256396/1726144348654-2d506304-bf71-4667-a5f9-e49a2a0d1bb4.png) |\n| 2024-09-09 10:26 | [@莯辰](undefined/langdong.ld)同步客诉相关信息：[会员名id]：tb279711076:苏打水[问题发生日期]：9.9[计划名称]：棉签92[campaignId]：71582692593[问题描述]：商家反馈计划消耗快； |\n| 2024-09-09 10:27 | [@明言](undefined/zhangming.czm)反馈这种跳变一般是黄金眼波动或者流量波动； |\n| **2024-09-09 10:30** | **【lindorm团队业务响应】**lindorm团队收到客户反馈导入任务慢，值班同学接入排查 ；**** |\n| 2024-09-09 10:39 | [@莯辰](undefined/langdong.ld)反馈客诉增长比较缓慢，目前5例客诉； |\n| 2024-09-09 10:41 | [@弈理](undefined/gushan.gs)同步展示的tROAS类型曝光监控；![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256396/1726144561263-f4906b7a-b90b-4ed3-9d53-a3f8f6dbb5e5.png) |\n| 2024-09-09 10:52 | [@向桐](undefined/wanglianyu.wly)反馈这个计划在431408_1007pid上某个人的pcvr很高![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256396/1726144648973-e9fa7fb4-7758-4f99-8696-f8fe77fc5417.png) |\n| 2024-09-09 10:53 | [@风沐](undefined/null.wh)反馈431039_1007 431040_1007 这两个位置的原始点击量和昨天基本持平，怀疑是流量分配有问题； |\n| 2024-09-09 10:56 | [@深舟](undefined/shenzhou.xhy)怀疑命中小流量实验，pcvr高集中在一些流量上，联系[@明言](undefined/zhangming.czm)协助排查431408_1007pid上这个pcvr是否正常；[@弈理](undefined/gushan.gs)通过异常",
    "chunk_order_index": 2,
    "full_doc_id": "doc-ec4c00520ad11e9d335838d26fafc370"
  },
  "chunk-cb487ddebbbbf3826820742590fe1060": {
    "tokens": 1200,
    "content": "持平，怀疑是流量分配有问题； |\n| 2024-09-09 10:56 | [@深舟](undefined/shenzhou.xhy)怀疑命中小流量实验，pcvr高集中在一些流量上，联系[@明言](undefined/zhangming.czm)协助排查431408_1007pid上这个pcvr是否正常；[@弈理](undefined/gushan.gs)通过异常case排查发现是 431408_1007这个pid今天有异常；![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256396/1726144914085-9e3fb9d4-9fb4-4f68-a646-3de9f037115e.png)![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256396/1726144957224-240f9377-fc99-4c33-8a88-51bcc248ff4a.png) |\n| 2024-09-09 10:58 |  有关无界9.9日早上人群推广计划消耗集中反馈客诉量达到10例，触达P5； |\n| 2024-09-09 10:59 | [@弈理](undefined/gushan.gs)反馈该pid整体pv有一些提升，可能结合其他原因在tROAS表现更明显。![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256396/1726144080722-5196bc23-ea92-448b-b4b1-9f0038331e9a.png) |\n| 2024-09-09 11:01 | [@明言](undefined/zhangming.czm)反馈中小链路目前无小流量实验； |\n| 2024-09-09 11:04 | [@亮深](undefined/wf169406)邀请[@念刃](undefined/jiaqi.ajq)进应急群，联系算法同学协助排查，并咨询当前进展； |\n| 2024-09-09 11:05 | [@深舟](undefined/shenzhou.xhy)反馈目前看431039_1007、431408_1007这两个pid，target roas的竞得pcvr上涨，导致ppc上涨，关于竞得pcvr上涨原因暂未定位到； |\n| **2024-09-09 11:34** | **【lindorm团队恢复执行】**lindorm团队对索引导入服务进行重启，重启后新增任务执行成功。遂通知各业务方重试失败的任务；****监控值班同学同步技术同学反馈故障已自然恢复，技术反馈异常时间是07点到11点，客满统计最后一例是10:57，故障应急结束，具体根因还在确认中。 |\n| 2024-09-09 11:37 | 将故障状态调整为已恢复； |\n| 2024-09-09 11:40 | [@风沐](undefined/null.wh)反馈整点有抢红包活动，怀疑可能有关；![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256396/1726145377282-398ee9b2-0342-496b-bcb7-e532d025b31f.png)![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256396/1726145385548-e8713102-9c53-414a-b993-0e60962ac712.png) |\n| 2024-09-09 11:55 | [@析君](undefined/zhaopeng.zzp)反馈签到场景整体流量平稳，刚刚图上第一个是淘宝秒杀的活动，跟签到没关系，另外这个场景也没有接商业化；除非这个场景对大盘流量的拉升，影响到了我们存量其他的场景带来的预估波动；第二个活动是淘宝秒杀，跟签到也没关系![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256396/1726145415094-edbacbca-8e7d-4bce-bdec-8f1d6d095320.png) |\n| 2024-09-09 11:59 | [@亮深](undefined/wf169406)反馈这两个PID的中小场景分组：一个是红包分组，一个是天猫农场； |\n| 2024-09-09 12:27 | [@深舟](undefined/shenzhou.xhy)联系[@明言](undefined/zhangming.czm)反馈红包这个场景大盘的原始pcvr相应的时间点有明显上涨，需要协助排查下原因，之前说参竞没变化，竞得变化了这个比较奇怪；不像是模型更新，但为什么有这个pcvr的变化很奇怪；不同流量场也有类似的情况，不像是流量场的变更；![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256396/1726145678075-00cd7d25-64a1-",
    "chunk_order_index": 3,
    "full_doc_id": "doc-ec4c00520ad11e9d335838d26fafc370"
  },
  "chunk-28f22ae14107f61ba123899d4d1df64e": {
    "tokens": 1200,
    "content": "协助排查下原因，之前说参竞没变化，竞得变化了这个比较奇怪；不像是模型更新，但为什么有这个pcvr的变化很奇怪；不同流量场也有类似的情况，不像是流量场的变更；![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256396/1726145678075-00cd7d25-64a1-4ad1-9fc6-300b7ec65488.png) |\n| 2024-09-09 12:39 | [@深舟](undefined/shenzhou.xhy)反馈12:21分后target roas cost、ppc有个明显上涨，出价参数有很大的跳变。![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/138656555/1726050251742-e1abd5de-c714-4ae2-9d4c-73a1bd521b42.png) |\n| 2024-09-09 12:50 | [@深舟](undefined/shenzhou.xhy)联系客满同学关注下12:21分后的客诉，需要更多的异常case排查； |\n| 2024-09-09 12:52 | [@深舟](undefined/shenzhou.xhy)分别与[@花笑](undefined/jiaoyu.jy)[@应灵](undefined/durui.dr)[@亮深](undefined/wf169406)确认人群场景bp、引擎、工程团队确认均无变更； |\n| 2024-09-09 13:02 | [@深舟](undefined/shenzhou.xhy)联系[@亮深](undefined/wf169406)反馈出价参数有很大的跳变，需要回滚参数； |\n| 2024-09-09 13:04 | [@亮深](undefined/wf169406)反馈可以联系[@念刃](undefined/jiaqi.ajq)协助处理参数回滚操作；![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256396/1726146027112-1fabca21-66ee-4d36-9bb6-7077121392b4.png) |\n| 2024-09-09 13:10 | [@弈理](undefined/gushan.gs)、[@向桐](undefined/wanglianyu.wly)、[@念刃](undefined/jiaqi.ajq)就出价参数有很大的跳变问题，开始回滚参数， |\n| 2024-09-09 13:19 | [@广生](undefined/guangsheng.wds)反馈跟上次问题现象类似；![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256396/1726146077063-dea94e35-f6fb-4e9d-aa9c-7330889fc50e.png) |\n| **2024-09-09 13:20** | **【阿里妈妈恢复执行】  **** **** 【故障恢复】**参数回滚完成；**** |\n| **2024-09-09 13:28** | **【初因定位】**[@深舟](undefined/shenzhou.xhy)[@弈理](undefined/gushan.gs)、[@向桐](undefined/wanglianyu.wly)、[@念刃](undefined/jiaqi.ajq)同步当前进展：问题原因：lindorm bulkload导入时构建索引异常，引发databus数据导入数据失败，原先未读取到ppb统计值时，所有计划都用的默认值50元，恢复后大部分计划的笔单价超过50元，导致出价参数会有提升。解决方案：通过参数回滚修复，下午将targetROAS所有计划进行参数初始化进行彻底修复； |\n| 2024-09-09 14:12 | [@深舟](undefined/shenzhou.xhy)反馈参数回滚后，有缓解，基本控住。![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/138656555/1726050455187-041fdb9d-453e-41f0-ab42-6612b0118fe3.png) |\n| **2024-09-09 15:20** | 完成出价参数回滚后放开，计划开始正常调控。**——【影响消除】** |\n\n\n## 三、影响产品线&影响面\n    - [x] 是否有客诉量：\n        * 故障期间整体客诉量15例\n\n[9.9消耗集中.xlsx](https://yuque.antfin.com/attachments/lark/0/2024/xlsx/147156506/1731031183564-40e72ba2-20b3-4d5c-9228-a3791b6e93e4.xlsx)\n\n## 四、故障原因\n### 4.1【背景说明】\n【线上出价链路流程图】\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/313801/1714158099506-7ada01a9-761a-4b5d-8652-d9b465164744.png?x-oss-process=image%2F",
    "chunk_order_index": 4,
    "full_doc_id": "doc-ec4c00520ad11e9d335838d26fafc370"
  },
  "chunk-3a6203aae328ebda1536eee350caadef": {
    "tokens": 1200,
    "content": "8-a3791b6e93e4.xlsx)\n\n## 四、故障原因\n### 4.1【背景说明】\n【线上出价链路流程图】\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/313801/1714158099506-7ada01a9-761a-4b5d-8652-d9b465164744.png?x-oss-process=image%2Fformat%2Cwebp%2Fresize%2Cw_1500%2Climit_0)\n\n### 4.2【原因分析】\n#### 【阿里妈妈-广告技术部】\n**【一句话原因】**\n\nlindorm bulkload导入时构建索引异常，引发databus数据导入数据失败，同时未及时发现任务异常。\n\n**【根因分析】**\n\nlindorm bulkload导入时构建索引异常，引发databus数据导入数据失败。target roas（目标投资回报率）计划类型依赖的笔单价ppb（每笔成交单价）数据失效，AIS离线调控时改用默认值50，导致ppb小于50的部分计划出价参数有了有基于ppb差值相关倍数的提高，ppb大于50的部分计划有基于ppb差值相关倍数的下降。待databus数据导入成功后，ppb从默认值50重新更正为实际值，导致引发了ppb高的计划出价提升，ppb低的计划出价变低。\n\n---\n\n#### **【lindorm团队】**\n**【一句话原因】**\n\n索引导入服务磁盘空间满造成导入任务卡住，重启服务后恢复，后续通知客户逐步重试失败的任务。\n\n**【**详细原因】\n1、表dwd_np_person_lz_tb_mobile_booklet_info_dd提交了一个1740亿行规模的导入任务，导致存储空间不足。\n2、表dwd_np_person_lz_tb_mobile_booklet_info_dd本不应该携带索引，但其删除索引的工单失败，因此涉及到了索引导入。 \n注：目前lindorm侧不鼓励数据表携带索引。\n\n## 五、关注点讨论\n#### 1、问题引入阶段——不涉及\n【在/离线变更代码开发完成后，需要经过**code review**确认无误后进行合并**代码主干**提交】--红线点\n【在线变更代码修改提交必须经过**功能单测；**离线变更代码修改完成后，生成的离线数据必须要经过**数据校验**】--红线点\n\n**〖关注点1〗**是否有经过CR？是否有经过单测？是否有经过测试？是否自动化测试可覆盖？测试阶段为何没发现？\n请提供CR链接：\n [原因分析]\n ACTION：\n\n【生产变更，**务必要经过灰度发布**，灰度发布时间**间隔大于20min****】**--红线点\n\n**〖关注点2〗**是否变更窗口期进行发布？是否经过灰度？分机房或分批发布第一批发布时间间隔是否大于20分钟？灰度过程中为何未发现问题？\n请提供ChangeFree变更单链接：\n [原因分析]\n ACTION：\n\n\n\n\n\n**【****黄金眼指标观察**，10分钟左右，观察已发布**本机房、核心pid、分广告主体类型**的黄金眼业务指标】--红线点\n\n**【****变更改动点验证**，验证已变更的**功能逻辑&数据已经生效**(最好有直接或间接生效截图记录)**】**--红线点\n\n**〖关注点3〗**是否进行黄金眼指标观察，观察是否发现问题？是否验证变更改动点，验证是否发现问题？\n\n请提供观测链接：\n [原因分析]\n ACTION：\n\n\n\n#### 2、故障应急阶段\n**〖关注点4〗**是否有监控发现？若没有，为什么？\n\n**[原因分析]**\n\n**阿里妈妈：**非监控发现\n\n+ 通过广告技术部风险预警和万相台无界风险预警群客诉预警单发现\n+ 黄金眼大盘无十分显著变化\n\n**阿里云：**非监控发现\n\n+ lindorm团队收到客户反馈导入任务慢，值班同学接入排查\n ACTION：\n\n**阿里妈妈：**\n\n1. databus数据导入任务异常后未及时发现，为相关同学添加任务失败通知。——负责人：向桐，已完成\n2. 增加监控：调控Kmonitor大盘增加离线出价参数曲线监控，便于实时查看离线出价参数（出价公式上的相关参数）变化情况。——负责人：念刃        预计：09.25      验收人：向桐\n3. 算法团队梳理并新增重要调控流程使用重要特征的相关监控，包括但不限于如笔单价使用默认值的比例（特征变化、表的数据输入两方面进行梳理补充）。——负责人：向桐、念刃       预计：09.30       验收人：弈理\n\n**阿里云：**\n\n1. 增加导入集群磁盘空间报警监控。——负责人：玄岚       预计：",
    "chunk_order_index": 5,
    "full_doc_id": "doc-ec4c00520ad11e9d335838d26fafc370"
  },
  "chunk-3d034e3478972f8d24cb392945a1e39f": {
    "tokens": 1200,
    "content": "调控流程使用重要特征的相关监控，包括但不限于如笔单价使用默认值的比例（特征变化、表的数据输入两方面进行梳理补充）。——负责人：向桐、念刃       预计：09.30       验收人：弈理\n\n**阿里云：**\n\n1. 增加导入集群磁盘空间报警监控。——负责人：玄岚       预计：09.30     验收人：天引\n\n**〖关注点5〗**相关角色的应急响应是否有改进空间？故障恢复方式是什么？是否可优化\n**[原因分析]**\n\n**阿里妈妈：**\n\n+ 相关角色的应急响应发现后五分钟内响应，故障恢复方式出价参数回滚发布。\n+ 故障原因定位时间较长，原因为:由于风险预警客诉中的三个计划由于当天有成交算法进行了优化，出价侧无显著变化，在故障原因定位上针对计划花费了较多时间。\n\n**阿里云：**\n\n+ lindorm团队对索引导入服务进行重启，重启后新增任务执行成功。\n ACTION：\n\n**阿里妈妈：**\n\n1. AIS参数回滚功能升级：当前回滚方式为回滚历史信息，后续还有加工处理（只有target roas计划类型较为特殊，需要乘ppb笔单价的值），升级为直接回滚产出信息，优化为回滚且补充写入参数的信息。——负责人：向桐、念刃     待评估\n\n**阿里云：**\n\n1. 删除表dwd_np_person_lz_tb_mobile_booklet_info_dd上的索引（已完成） ——负责人：天引\n2. 建议客户带索引的导入任务迁移到API导入模式（不强制要求业务方，仅作为建议）。\n3. 建议客户有Deadline的任务在Dataworks等平台配置基线报警。——妈妈侧有配置，本次已经将接收报警的同学更新为算法团队新同学。\n\n## 六、后续Action\n| **序号** | *******Action标题** | **Action描述** | *******负责人** | *******计划完成时间** | **验收标准** | **验收人** | **是否keyAction** | **是否回血Action** |\n| :---: | --- | --- | :---: | :---: | --- | :---: | :---: | :---: |\n| 1 | 短期：监控报警规则调整 | databus数据导入任务异常后未及时发现，为相关同学添加任务失败通知。 | 向桐 | 已完成 | 确保监控报警信息能及时有效触达智能广告算法团队同学。 | - | 是 | - |\n| 2 | 短期：删除索引 | 删除表dwd_np_person_lz_tb_mobile_booklet_info_dd上的索引。 | 天引 | 已完成 | - | - | 是 | - |\n| 3 | 短期：新增离线出价参数监控 | 增加监控：调控Kmonitor大盘增加离线出价参数曲线监控，便于实时查看离线出价参数（出价公式上的相关参数）变化情况。 | 念刃 | 09.25 | 确保新增离线出价参数曲线监控的有效性和报警规则配置的合理性。 | 向桐 | 是 | - |\n| 4 | 短期：增加磁盘空间监控 | 增加导入集群磁盘空间报警监控。 | 玄岚 | 09.30 | 确保磁盘空间报警监控合理性和报警有效性。 | 天引 | 是 | - |\n| 5 | 短期：新增重要调控流程使用重要特征的相关监控 | 算法团队梳理并新增重要调控流程使用重要特征的相关监控，包括但不限于如笔单价使用默认值的比例（特征变化、表的数据输入两方面进行梳理补充）。 | 向桐念刃 | 09.30 | 确保梳理并新增重要调控流程使用重要特征的相关监控，保障监控报警有效性。 | 弈理 | - | - |\n| 6 | 短期：AIS参数回滚功能升级 | 当前回滚方式为回滚历史信息，后续还有加工处理（只有target roas计划类型较为特殊，需要乘ppb笔单价的值），升级为直接回滚产出信息，优化为回滚且补充写入参数的信息。 | 向桐念刃 | 待评估 | - | - | - | - |\n\n\n\n\n## 七、故障相关方\n【故障等级】P5\n\n| **  系统质量（30%）** | | | | | **处置能力（70%）** |\n| :---: | --- | --- | --- | --- | :---: |\n| **相关方** | **需求设计** | **代码质量** | **变更质量** | **自定义项** | **发生时间** | **发现时间（30%）** | **恢复时间（40%）** |\n| 淘天集团-用户平台&阿里妈妈事业部-阿里妈妈-广告技术部-广告算法-智能广告平台 | 不涉及 |",
    "chunk_order_index": 6,
    "full_doc_id": "doc-ec4c00520ad11e9d335838d26fafc370"
  },
  "chunk-aa7095cce4da8d44d170d66414c84b40": {
    "tokens": 230,
    "content": "| :---: | --- | --- | --- | --- | :---: |\n| **相关方** | **需求设计** | **代码质量** | **变更质量** | **自定义项** | **发生时间** | **发现时间（30%）** | **恢复时间（40%）** |\n| 淘天集团-用户平台&阿里妈妈事业部-阿里妈妈-广告技术部-广告算法-智能广告平台 | 不涉及 | 不涉及 | 不涉及 |  | 09-09 09:06 | 09-09 09:29 | 09-09 13:20 |\n| 云智能集团-阿里云智能-阿里云智能CTO线-数据库产品事业部-NoSQL产品部-Lindorm内核-多模生态 | 不涉及 | 不涉及 | 不涉及 | 容量评估 | 09-09 09:06 | 09-09 10:30 | 09-09 13:20 |\n|  |  |  |  |  |  |  |  |",
    "chunk_order_index": 7,
    "full_doc_id": "doc-ec4c00520ad11e9d335838d26fafc370"
  },
  "chunk-79bfb40064e5c13209bd348f0493183d": {
    "tokens": 1200,
    "content": "## 一、故障简述\n于2024年9月5日09:39分开始广告技术部陆续收到有关无界精准人群集中消耗的客诉，原因确认是Weex侧在手淘10.40.0版本修复willchange事件漏报，新增自动轮播willchange事件上报，该变更影响到了ND广告计费等相关逻辑。通过前端修改逻辑根据事件参数isAuto字段区分自动轮播与手动滑动上报广告埋点，业务于15:56分恢复。故障期间累计客诉21例（去重后）。\n\n## 二、故障过程回顾\n### 2.1【妈妈侧时间线概览】\n![画板](https://intranetproxy.alipay.com/skylark/lark/0/2024/jpeg/80256396/1726109550266-437831d1-0694-4582-8229-b5c3734393b6.jpeg)\n\n故障发现～初因定位：183min\n\n初因定位～恢复执行：136min\n\n### 2.2【故障处理时间线】\n#### **2.2.1【时间线各阶段概括性总结】**\n**2024-09-05 09:39，**广告技术部客满团队累计收到3例有关无界精准人群集中消耗引发的客诉；**——【故障发生】**\n\n**2024-09-05 10:37，**广告技术部收到无界精准人群集中消耗引发客诉的预警单；[@泊凡](undefined/bofan.sy)接手预警单开始接入排查**——【故障发现】【阿里妈妈侧业务响应】**\n\n2024-09-05 10:58，广告技术部内部团队初步怀疑有攻击，反作弊团队介入排查；\n2024-09-05 11:07，经排查部分ND的pid原始量暴涨：\n\nmm_12852562_1778064_115714950137\n\nmm_12852562_1778064_115685900469\n\nmm_12852562_1778064_114749650314\n\n2024-09-05 11:35，场景侧尝试把ND任务先操作下线处理；\n\n**2024-09-05 11:47**，[@龙阙](undefined/longque.zs)反馈该时间段无变更；**——【用户&内容技术侧业务响应】**\n\n2024-09-05 11:48，购后流量回滚完成；\n\n2024-09-05 12:08，三个ND场景的PV没涨，点击暴涨，反作弊初步确认是pic_move埋点上涨，属于折损操作；\n\n1）回滚购后nd 2.0未恢复；\n\n2）正在下线三个异常场景的任务 @张兆朋(兆朋) ；\n\n3）正在排查埋点异常的原因\n\n2024-09-05 12:57，[@淮竹](undefined/dagui.cdg)反馈现在线上回退了流量还是有一些资损的，总结并同步当前ACTION：  \n1. 淘金币场景流量切成小流量   \n2. 跑分端分版本分坑位的数据，同步到群里。[@庄魅](undefined/qiurui.qiu)[@风沐](undefined/null.wh)  \n3. 自查中小场景ND的发布情况 [@龙阙](undefined/longque.zs)[@予默](undefined/shengkeng.zsk)，是否存在有配置会在0点自动生效。  \n4. 埋点验证和线上数据对不齐的原因 [@青絮](undefined/qingxu.hj)（线上CTR>40%，但是埋点验证的CTR偏低）\n\n2024-09-05 13:11，数据分析确认，异常流量集中在Android 10.40.0版本[9.4 20:07开始扩量]，从一灰版本就有问题；\n\n**2024-09-05 13:20**，[@予默](undefined/shengkeng.zsk)联系终端平台-跨端技术-Weex&引擎技术同学[@龙冥](undefined/pengtao.pt)咨询weex Android 10.39.40及灰度版本是否有改动，横划容器相关的；**——【终端平台侧业务响应】**\n\n2024-09-05 13:30，端侧验证，ND业务一灰集成单没问题，手淘整体的一灰包有问题；内容化场景均有问题，不局限在农场、金币等任务消耗渠道；\n2024-09-05 13:38，[@予默](undefined/shengkeng.zsk)同步端侧验证进度：\n分端数据，Android一灰版本就有问题  \n1、ND一灰业务集成单没问题，手淘整体的一灰包有问题  \n2、Weex确认：ND前端埋点上报，依赖weex侧给的willChange事件，该事件主动滑动会给，自动轮播之前没给。10.40.0灰度版本变更，补充willChange事件，前端会触发上报  \n3、有问题的包，购后场景内容化也有问题，不局限农场之类的取到\n\n**2024-",
    "chunk_order_index": 0,
    "full_doc_id": "doc-7d2551f2c402446ade661bafd052d1f3"
  },
  "chunk-fcd734204654cd6288e1ff60d07d02c9": {
    "tokens": 1200,
    "content": "灰包有问题  \n2、Weex确认：ND前端埋点上报，依赖weex侧给的willChange事件，该事件主动滑动会给，自动轮播之前没给。10.40.0灰度版本变更，补充willChange事件，前端会触发上报  \n3、有问题的包，购后场景内容化也有问题，不局限农场之类的取到\n\n**2024-09-05 13:40**，业务前端 & Weex 定位排查：问题场景与Weex侧在10.40.0 版本修正自动轮播丢失willchange事件强关联。问题引入前，自动轮播场景不会发送willchange事件，前端上报广告逻辑依赖此事件，并确认回滚方案，前端修改逻辑根据事件参数isAuto字段区分自动轮播与手动滑动上报广告埋点 [@一格](undefined/xiongbilin.xbl) [@龙冥](undefined/pengtao.pt)；**——【故障定位】**\n\n2024-09-05 13:56，[@予默](undefined/shengkeng.zsk)反馈目前端侧的验证进度：  \n**问题场景**：Android10.40.0版本内容化流量均有问题，首猜当前已经切换到实验室2.0场景没问题【内容化和实验室，主图实现有差异】  \n分端数据，Android一灰版本就有问题  \n1、ND一灰业务集成单没问题，手淘整体的一灰包有问题  \n2、有问题的包，购后场景内容化也有问题，不局限农场之类的渠道  \n3、【问题原因】Weex确认：ND前端埋点上报，依赖weex侧给的willChange事件，该事件主动滑动会给，自动轮播之前没给。10.40.0灰度版本变更，补充willChange事件，前端会触发上报  \nAndroid版本上架，iOS版本还未上架，理论上双端都有问题  \n**解决方案**：  \n1、weex侧无可止血开关 @彭涛(龙冥)   \n2、前端修改监听时机，规避自动轮播埋点处理时机，修改验证中@熊碧林(一格) @冯子仪(子仪) \n\n**2024-09-05 14:20**，修复方案验收完成，开始发布流程 [@一格](undefined/xiongbilin.xbl) [@洵臻](undefined/fengziyi.fzy)**；****——【恢复执行】**\n\n**2024-09-05 15:56**，前端修复版本走完大促发布流程，线上推全 [@一格](undefined/xiongbilin.xbl)。**——【故障恢复】**\n\n**2024-09-05 16:36**，[@淮竹](undefined/dagui.cdg)反馈CTR已恢复至周环比位置；可以联系业务同学恢复ND任务。**——【影响消除】**\n\n#### **2.2.2【故障详细时间点】**\n| **时间轴** | **事件** |\n| :---: | --- |\n| **2024-09-05 09:39** | **【故障发生】**广告技术部客满团队累计收到3例有关无界精准人群集中消耗引发的客诉 |\n| **2024-09-05 10:37** | **【故障发现】**** ****【阿里妈妈侧业务响应】**广告技术部收到无界精准人群集中消耗引发客诉的预警单；[@泊凡](undefined/bofan.sy)接手预警单开始接入排查![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256396/1725876985459-e41b1df3-74e5-4803-baf1-3dafc07f60b7.png) |\n| 2024-09-05 10:50 | [@崖飞](undefined/ruibo.hrb)创建应急群开始排查 |\n| 2024-09-05 10:59 | [@深舟](undefined/shenzhou.xhy)邀请反作弊团队同学[@风沐](undefined/null.wh)从作弊流量视角，排查是否来自同一个用户 |\n| 2024-09-05 11:07 | [@风沐](undefined/null.wh)反馈部分nd的pid原始量暴涨，咨询是否是活动导致![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256396/1725603789538-3abbd64c-5219-4cf6-845e-edf17317cc23.png) |\n| 2024-09-05 11:10 | [@深舟](undefined/shenzhou.xhy)联系产品同学[@奇果](undefined/jingyi.yang)咨询这个上涨是否符合预期，以及[@玥深](undefined/shushen.fss)咨询nd最近端上是否有改动 |\n| 2024-09-05 11:11 | [@风沐](undefined/null.wh)将pid（mm_12852562_177806",
    "chunk_order_index": 1,
    "full_doc_id": "doc-7d2551f2c402446ade661bafd052d1f3"
  },
  "chunk-457e903421359d1885f51cdc51ba8a5e": {
    "tokens": 1200,
    "content": "4-09-05 11:10 | [@深舟](undefined/shenzhou.xhy)联系产品同学[@奇果](undefined/jingyi.yang)咨询这个上涨是否符合预期，以及[@玥深](undefined/shushen.fss)咨询nd最近端上是否有改动 |\n| 2024-09-05 11:11 | [@风沐](undefined/null.wh)将pid（mm_12852562_1778064_115685900469）发给[@淮竹](undefined/dagui.cdg)协助排查流量上涨是否符合预期 |\n| 2024-09-05 11:13 | [@深舟](undefined/shenzhou.xhy)发起语音会议协调各团队同学对焦排查；[@弈理](undefined/gushan.gs)反馈看起来是某些场景 ctr+ click+ cost+![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256396/1725604122360-c632247a-c5b6-4f0c-a2bc-ba1481483206.png) |\n| 2024-09-05 11:21 | [@一敦](undefined/chenzongqi.czq)反馈这四个pid，为主要出现异常pidmm_12852562_1778064_115714950137 mm_12852562_1778064_115685900469 mm_12852562_1778064_114749650314 mm_12852562_1778064_115741150278 |\n| 2024-09-05 11:26 | [@析君](undefined/zhaopeng.zzp)邀请业务技术-首页&信息流服务端同学[@宇捷](undefined/wyj378462)协助排查；![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256396/1725605183555-802864ba-24ea-40fb-b940-47bb4b9530ac.png)[@深舟](undefined/shenzhou.xhy)提供pid为mm_12852562_1778064_115714950137的点击异常监控；![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256396/1725605255480-40d2af44-0add-4747-bd4e-c1165b240cf9.png) |\n| 2024-09-05 11:27 | [@风沐](undefined/null.wh)反馈上报点多了4倍，pic_move，这个计费点比前天同比涨了很多20240902 、9点 pic_move 4139169 20240905、9点 pic_move 21476722![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256396/1725605275968-0aa54a73-eb19-48dd-b07a-5510545d30ca.png) |\n| 2024-09-05 11:31 | [@深舟](undefined/shenzhou.xhy)反馈以下三个点击上涨很多mm_12852562_1778064_115714950137 mm_12852562_1778064_115685900469 mm_12852562_1778064_114749650314 |\n| 2024-09-05 11:33 | 产品同学[@苏绮](undefined/panhuamin.phm)将信息流导购升级埋点表提供给测试质量同学[@青絮](undefined/qingxu.hj)，[@青絮](undefined/hj177365)反馈不会带来 集中消耗；[@深舟](undefined/shenzhou.xhy)咨询[@庄魅](undefined/qiurui.qiu)能否屏蔽这几个pid；链接：[https://aliyuque.antfin.com/wmlu3u/hftknc/glfqa8t06w2x32ab?singleDoc#21Iz](https://aliyuque.antfin.com/wmlu3u/hftknc/glfqa8t06w2x32ab?singleDoc#21Iz)邀请用户终端技术-用户前端同学[@一格](undefined/xiongbilin.xbl)协助排查； |\n| 2024-09-05 11:35 | [@庄魅](undefined/qiurui.qiu)反馈屏蔽后就没有广告返回了，需要咨询引擎同学评估；[@庄魅](undefined/qiurui.qiu)咨询产品同学[@苏绮](undefined/panhuamin.phm)评估场景侧能不能把ND的任务先下掉；邀请首页&信息流服务端同学[@龙阙](undefined/longque.zs)协助排查； |\n| 2024-09-05 11:37 | [@一敦](undefined/chenzongqi.czq)反馈这四个pid，9点同比前天，只有pic_move 计费点涨了快10倍，怀疑是滑动图片的计费点出现问题![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256396/1725605766238-04d5b288-58a0-48de-921a-6fe953fba86c.png?x-oss-process=image%2Fformat%",
    "chunk_order_index": 2,
    "full_doc_id": "doc-7d2551f2c402446ade661bafd052d1f3"
  },
  "chunk-31d2deb6b66e8547ef27636cad9c3325": {
    "tokens": 1200,
    "content": "pid，9点同比前天，只有pic_move 计费点涨了快10倍，怀疑是滑动图片的计费点出现问题![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256396/1725605766238-04d5b288-58a0-48de-921a-6fe953fba86c.png?x-oss-process=image%2Fformat%2Cwebp%2Fresize%2Cw_698%2Climit_0)![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256396/1725605766123-fa8ba96a-33ed-439f-90c4-430aae04e59e.png?x-oss-process=image%2Fformat%2Cwebp%2Fresize%2Cw_704%2Climit_0)[@析君](undefined/zhaopeng.zzp)提供点击异常pid对应的任务场景：购后：431578_1007红包签到ND任务流：mm_12852562_1778064_115714950137   淘金币ND任务流：mm_12852562_1778064_115685900469   农场ND任务：mm_12852562_1778064_114749650314 |\n| 2024-09-05 11:42 | [@照夜](undefined/mazhenjia.mzj)反馈看点击率，18点就已经开始涨了![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256396/1725605921101-ee016818-7aee-4a97-8a08-8e70e2e3b6b9.png) |\n| **2024-09-05 11:47** | **【用户&内容技术侧业务响应】**[@龙阙](undefined/longque.zs)反馈该时间段无变更![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256396/1726021899303-7648d1b1-73bb-4183-83eb-29f54872ef4a.png)[@风沐](undefined/null.wh)反馈mm_12852562_1778064_115714950137 第一个尖峰是0点2分，每分钟的量![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256396/1725606077206-9f27d56e-fd67-4f5c-9cac-26d5655c019f.png) |\n| 2024-09-05 11:48 | [@宇捷](undefined/wyj378462)反馈购后的流量已经回滚完了 |\n| 2024-09-05 11:59 | 客诉达到10+例，升级为P5故障![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256396/1725607310422-d6a7fd51-0858-408d-be5e-30d623ac40a6.png) |\n| 2024-09-05 12:08 | [@深舟](undefined/shenzhou.xhy)同步当前进展：**3个ND场景的pv没涨，点击暴涨，目前看是pic_move埋点上涨，折损操作：****1）回滚购后nd 2.0未恢复；****2）正在下线三个异常场景的任务**[@析君](undefined/zhaopeng.zzp)**；****3）正在排查埋点异常的原因** |\n| 2024-09-05 12:09 | [@亮深](undefined/wf169406)确认ND是否属于中小场景；[@庄魅](undefined/qiurui.qiu)反馈是中小场景里接入的ND；[@亮深](undefined/wf169406)反馈在召回侧做中小场景的过滤还是有必要的 |\n| 2024-09-05 12:10 | [@昀乔](undefined/yunqiao.gh)提供渠道入口流量的变化情况在零点有突增![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256396/1725607438552-6d02aec7-98b3-45a7-a15b-43df0bfa93d3.png) |\n| 2024-09-05 12:12 | [@风沐](undefined/null.wh)咨询[@昀乔](undefined/yunqiao.gh)零点的突增是否有相关变更 |\n| 2024-09-05 12:13 | [@昀乔](undefined/yunqiao.gh)反馈这三个pid对应的瞬开流量，只有一个渠道涨了![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256396/1725607600296-f4a5d883-492c-4c64-9991-20a2b5af6871.png) |\n| 2024-09-05 12:14 | [@风沐](undefined/null.wh)通过广告业务每分钟点击量的原始日志分析，",
    "chunk_order_index": 3,
    "full_doc_id": "doc-7d2551f2c402446ade661bafd052d1f3"
  },
  "chunk-f537ae8261730f41c52a0507c2e8f1b1": {
    "tokens": 1200,
    "content": "只有一个渠道涨了![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256396/1725607600296-f4a5d883-492c-4c64-9991-20a2b5af6871.png) |\n| 2024-09-05 12:14 | [@风沐](undefined/null.wh)通过广告业务每分钟点击量的原始日志分析，反馈这两个图在0点增长趋势相同；![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256396/1725607609139-850caa91-b28e-4cfe-b26f-11b51116c76a.png) |\n| 2024-09-05 12:15 | [@苏绮](undefined/panhuamin.phm)反馈红包签到ND任务流：mm_12852562_1778064_115714950137下掉了，线上留了0.01%的流量 |\n| 2024-09-05 12:32 | [@深舟](undefined/shenzhou.xhy)联系[@析君](undefined/zhaopeng.zzp)反馈农场ND任务：mm_12852562_1778064_114749650314这个还没下；[@析君](undefined/zhaopeng.zzp)反馈 淘金币ND任务流：mm_12852562_1778064_115685900469；[@一敦](undefined/chenzongqi.czq)反馈 pid mm_12852562_1778064_115685900469 淘金币_超推ND任务 |\n| 2024-09-05 12:33 | [@庄魅](undefined/qiurui.qiu)反馈在操作下线了![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256396/1725608377752-a52f135c-43e1-42b5-aa37-ae46529985d7.png) |\n| 2024-09-05 12:35 | [@昀乔](undefined/yunqiao.gh)咨询能否按客户端类型和版本看看异常分布情况 |\n| 2024-09-05 12:37 | [@析君](undefined/zhaopeng.zzp)提供 utdid:ZkadANQF+0QDANEQDbjmdEk0 |\n| 2024-09-05 12:43 | [@昀乔](undefined/yunqiao.gh)根据11:47分的截图，反馈签到曝光和点击我看每天0点应该都会涨一点的，可以同比确定一下 |\n| 2024-09-05 12:44 | [@鸾萱](undefined/xinjie.dxj)反馈昨天八点新版本发布，咨询流量异常的时间点 |\n| 2024-09-05 12:46 | [@庄魅](undefined/qiurui.qiu)反馈分端分版本分坑位的ctr |\n| 2024-09-05 12:57 | [@淮竹](undefined/dagui.cdg)**总结并同步当前ACTION：   ****1. 淘金币场景流量切成小流量    ****2. 跑分端分版本分坑位的数据，同步到群里。**[@庄魅](undefined/qiurui.qiu)[@风沐](undefined/null.wh)**   ****3. 自查中小场景ND的发布情况 **[@龙阙](undefined/longque.zs)[@予默](undefined/shengkeng.zsk)**，是否存在有配置会在0点自动生效。   ****4. 埋点验证和线上数据对不齐的原因 **[@青絮](undefined/qingxu.hj)**（线上CTR>40%，但是埋点验证的CTR偏低）   ****--------   ****现在虽然止血了客户反馈的故障，但是线上回退了流量还是有一些资损的**（BTW：@张兆朋(兆朋) ACITON1帮忙@ 下淘金币的业务方） |\n| 2024-09-05 12:59 | [@龙阙](undefined/longque.zs)咨询刚刚零点上涨的数据是不曝光pv也上涨了；联系[@明湛](undefined/xiashibo.xsb)把淘金币零点卡片曝光的监控发到群里；与[@析君](undefined/zhaopeng.zzp)[@青絮](undefined/qingxu.hj)确认刚验证埋点的时候 是用iOS验证的； |\n| 2024-09-05 13:04 | [@玥深](undefined/shushen.fss)反馈重点排查安卓10.40版本，初步怀疑该版本有问题，ios应该没问题 |\n| 2024-09-05 13:07 | [@风沐](undefined/null.wh)反馈安卓10.40.0的版本自动轮播会上报9001 9002，安卓10.39不复现上面这个问题，只有10.40复现了，[@灵息](undefined/yasen.wys)反馈10.39没复现，升级到10.40之后可以复现，2秒一次 |\n| 2024-09-05 13:09 | 和用户&内容技术同学[@予默](undefined/shengkeng.zsk",
    "chunk_order_index": 4,
    "full_doc_id": "doc-7d2551f2c402446ade661bafd052d1f3"
  },
  "chunk-34985c54c2d9731d21fa6f7de1d96804": {
    "tokens": 1200,
    "content": "10.40.0的版本自动轮播会上报9001 9002，安卓10.39不复现上面这个问题，只有10.40复现了，[@灵息](undefined/yasen.wys)反馈10.39没复现，升级到10.40之后可以复现，2秒一次 |\n| 2024-09-05 13:09 | 和用户&内容技术同学[@予默](undefined/shengkeng.zsk)确认购后场景入口在订单列表，下面拉下去的信息流坑位 |\n| 2024-09-05 13:11 | [@一敦](undefined/chenzongqi.czq)反馈分app的版本来看pic_move计费点所占流量的占比，主要出在10.40.0和其灰度的这几个版本![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256396/1725626476605-f79ab9fc-bbc1-4cd0-9cf8-a8fdf2b84920.png) |\n| 2024-09-05 13:12 | [@予默](undefined/shengkeng.zsk)咨询0.99的是否有问题，10.39.31.1,11,12（10.40.0的灰度版本），10.40.0 这几个 |\n| 2024-09-05 13:13 | [@玥深](undefined/shushen.fss)反馈主要看10.40.0版本，它的量占绝大多数，且抓包复现出来了，其他几个灰度版本因为反作弊同学手机上没有对应版本，所以反作弊同学难以操作复现，需要端上同学去尝试复现 |\n| 2024-09-05 13:15 | [@析君](undefined/zhaopeng.zzp)与[@可鱼](undefined/keyu.hy)[@壹天](undefined/vivianwu.wty)反馈农场 金币场景下线了 |\n| 2024-09-05 13:16 | [@陶岳](undefined/yue.taoy)联系[@析君](undefined/zhaopeng.zzp)反馈先下掉线上任务，这边nd客户端在看了 |\n| 2024-09-05 13:19 | [@明湛](undefined/xiashibo.xsb)同步淘金币卡片曝光监控水位![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256396/1725627256975-36029530-cdec-4d48-85a0-4f5478228f10.png) |\n| **2024-09-05 13:20** | **【终端平台侧业务响应】**[@予默](undefined/shengkeng.zsk)联系终端平台-跨端技术-Weex&引擎技术同学[@龙冥](undefined/pengtao.pt)咨询weex Android 10.39.40及灰度版本是否有改动，横划容器相关的 |\n| 2024-09-05 13:23 | [@析君](undefined/zhaopeng.zzp)联系[@宇捷](undefined/wyj378462)[@霜醉](undefined/yanghexiang.yhx)反馈和ND2.0无关，可以恢复了 |\n| 2024-09-05 13:29 | [@析君](undefined/zhaopeng.zzp)反馈目前流量下线对广告整体收入是有损的，需要等ND同学明确问题修复后，再恢复广告线上流量 |\n| 2024-09-05 13:32 | [@龙冥](undefined/pengtao.pt)联系[@一格](undefined/xiongbilin.xbl)确认事件名；[@予默](undefined/shengkeng.zsk)**反馈目前端侧的验证进度：   ****分端数据，Android一灰版本就有问题   ****1、ND一灰业务集成单没问题，手淘整体的一灰包有问题   ****2、Weex待确认改动强关联性** |\n| 2024-09-05 13:33 | [@予默](undefined/shengkeng.zsk)联系[@龙冥](undefined/pengtao.pt)反馈weex侧的确认直接从一灰版本改动开始确认，一灰的集成单你们有的话可以直接发下；[@龙冥](undefined/pengtao.pt)反馈will change 事件 自动轮播之前没发，其他业务报了有bugfix；确认是一灰改的，willChange报的； |\n| 2024-09-05 13:35 | [@陶岳](undefined/yue.taoy)联系[@乐舟](undefined/lezhou.wyl)帮忙发weex android0828迭代的集成单 |\n| 2024-09-05 13:38 | [@予默](undefined/shengkeng.zsk)**同步端侧验证进度：****分端数据，Android一灰版本就有问题   ****1、ND一灰业务集成单没问题，手淘整体的一灰包有问题   ****2、Weex确认：ND前端埋点上报，依赖weex侧给的willChange事件，该事件主动滑动会给，自动轮播之前没给。10.40.0灰度版本变更",
    "chunk_order_index": 5,
    "full_doc_id": "doc-7d2551f2c402446ade661bafd052d1f3"
  },
  "chunk-4ba4e79850d2ea1e464681fb38b0a754": {
    "tokens": 1200,
    "content": "undefined/shengkeng.zsk)**同步端侧验证进度：****分端数据，Android一灰版本就有问题   ****1、ND一灰业务集成单没问题，手淘整体的一灰包有问题   ****2、Weex确认：ND前端埋点上报，依赖weex侧给的willChange事件，该事件主动滑动会给，自动轮播之前没给。10.40.0灰度版本变更，补充willChange事件，前端会触发上报   ****3、有问题的包，购后场景内容化也有问题，不局限农场之类的取到** |\n| 2024-09-05 13:39 | [@一格](undefined/xiongbilin.xbl)反馈ios 自动播不触发，安卓自动播会触发 10.40.0；[@龙冥](undefined/pengtao.pt)反馈IOS也会触发，新版本修了这个问题 其他业务提了这个bug；[@一格](undefined/xiongbilin.xbl)咨询这个上线是否有开关；[@龙冥](undefined/pengtao.pt)反馈WillChange 跟change应该是一样的； |\n| **2024-09-05 13:40** | **【故障定位】**业务前端 & Weex 定位排查：问题场景与Weex侧在10.40.0 版本修正自动轮播丢失willchange事件强关联。问题引入前，自动轮播场景不会发送willchange事件，前端上报广告逻辑依赖此事件，并确认回滚方案，前端修改逻辑根据事件参数isAuto字段区分自动轮播与手动滑动上报广告埋点 [@一格](undefined/xiongbilin.xbl) [@龙冥](undefined/pengtao.pt) |\n| 2024-09-05 13:41 | [@壹天](undefined/vivianwu.wty)反馈农场的12:32已经操作下掉了；[@予默](undefined/shengkeng.zsk)**反馈目前端侧的验证进度：****分端数据，Android一灰版本就有问题****1、ND一灰业务集成单没问题，手淘整体的一灰包有问题****2、****有问题的包，购后场景内容化也有问题，不局限农场之类的渠道****3、****【问题原因】****Weex确认：ND前端埋点上报，依赖weex侧给的willChange事件，****该事件主动滑动会给，自动轮播之前没给。10.40.0灰度版本变更，补充willChange事件，前端会触发上报****Android版本上架，iOS版本还未上架，理论上双端都有问题。** |\n| 2024-09-05 13:43 | [@析君](undefined/zhaopeng.zzp)反馈红包签到ND任务流：mm_12852562_1778064_115714950137 12:15下线，线上留了0.01%的流量   农场ND任务：mm_12852562_1778064_114749650314 12:32已经操作下掉   淘金币ND任务：待下线 |\n| 2024-09-05 13:44 | [@予默](undefined/shengkeng.zsk)咨询购后是广告比较少吗，这个问题是所有内容化都会有问题 |\n| 2024-09-05 13:45 | [@析君](undefined/zhaopeng.zzp)猜测是互动场景ND是任务导流形式，流量很大且是首卡计费；购后ND是双列流二跳且首卡不计费，所以影响面对比互动场景会小一些 |\n| 2024-09-05 13:46 | [@予默](undefined/shengkeng.zsk)得出购中后可能是插卡的场景，也是有问题的，插的ND卡；[@析君](undefined/zhaopeng.zzp)回复安卓有问题版本汇总，购后ND非首卡且商品卡，估计也有问题；[@淮竹](undefined/dagui.cdg)咨询首猜和购后/中小是不一致的吗？另外这个可以回滚么？回滚完后广告侧通过数据情况验证是否为该问题导致；[@予默](undefined/shengkeng.zsk)回复首猜当前已经切换到实验室2.0，其他渠道的场景目前大部分都还是内容化，这两个场景实现有差异，有问题的是内容化场景的广告流量 |\n| 2024-09-05 13:47 | 运营同学[@竹洲](undefined/zhuzhou.hkw)反馈已有的客户舆情，业务侧需要给莯辰一个对客话术。除了流量侧同学，修复流量侧问题以外。咨询[@深舟](undefined/shenzhou.xhy)对于已经产生的“异常”点击，后面在对客BP离线数据中 是否会做过滤或处理，这涉及到对客的引导。 |\n| 2024-09-05 13:48 | [@析君](undefined/zhaopeng.zzp)联系[@淮竹](undefined/dagui.cdg)评估要不要购后的ND对",
    "chunk_order_index": 6,
    "full_doc_id": "doc-7d2551f2c402446ade661bafd052d1f3"
  },
  "chunk-58d5e01aa4bc6660faf0af2902421704": {
    "tokens": 1200,
    "content": "量侧问题以外。咨询[@深舟](undefined/shenzhou.xhy)对于已经产生的“异常”点击，后面在对客BP离线数据中 是否会做过滤或处理，这涉及到对客的引导。 |\n| 2024-09-05 13:48 | [@析君](undefined/zhaopeng.zzp)联系[@淮竹](undefined/dagui.cdg)评估要不要购后的ND对广告商品做些止损，但是这个问题如果集中在某些版本上就不太好分版本控了 |\n| 2024-09-05 13:56 | [@予默](undefined/shengkeng.zsk)反馈目前端侧的验证进度：   **问题场景：Android10.40.0版本内容化流量均有问题，首猜当前已经切换到实验室2.0场景没问题【内容化和实验室，主图实现有差异】   ****分端数据，Android一灰版本就有问题   ****1、ND一灰业务集成单没问题，手淘整体的一灰包有问题   ****2、有问题的包，购后场景内容化也有问题，不局限农场之类的渠道   ****3、【问题原因】Weex确认：ND前端埋点上报，依赖weex侧给的willChange事件，该事件主动滑动会给，自动轮播之前没给。10.40.0灰度版本变更，补充willChange事件，前端会触发上报   ****Android版本上架，iOS版本还未上架，理论上双端都有问题   ****解决方案：   ****1、weex侧无可止血开关 @彭涛(龙冥)    ****2、前端修改监听时机，规避自动轮播埋点处理时机，修改验证中@熊碧林(一格) @冯子仪(子仪) **[@龙冥](undefined/pengtao.pt)反馈代码确认了 有isAuto 字段，能区分是不是自动轮播场景；[@勤仁](undefined/cl121469)反馈[@一格](undefined/xiongbilin.xbl)在尝试兼容方案，测试中 |\n| **2024-09-05 14:20** | **【恢复执行】**修复方案验收完成，开始发布流程 [@一格](undefined/xiongbilin.xbl) [@洵臻](undefined/fengziyi.fzy)[@深舟](undefined/shenzhou.xhy)咨询[@风沐](undefined/null.wh)反作弊已经产生的“异常”点击，后面在对客BP离线数据中 是否会做过滤处理，客户2小时后看到bp的数据会回落，还是得等到日终，另外需要评估下反作弊过滤的比例 |\n| 2024-09-05 14:25 | [@玥深](undefined/shushen.fss)反馈会看下小时级过滤情况 |\n| 2024-09-05 14:30 | [@可鱼](undefined/keyu.hy)反馈金币这边大流量的ND任务已经下线完毕 |\n| 2024-09-05 14:31 | [@析君](undefined/zhaopeng.zzp)反馈红包签到ND任务流：mm_12852562_1778064_115714950137 12:15下线;   农场ND任务：mm_12852562_1778064_114749650314 12:32已经操作下掉   淘金币ND任务：mm_12852562_1778064_115685900469 14:30分操作下线 |\n| 2024-09-05 14:32 | [@莯辰](undefined/langdong.ld)反馈当前客诉23例；![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256396/1725629755642-8970eb38-eb11-4f4c-af06-77b7a62d3db9.png) |\n| 2024-09-05 14:46 | [@一格](undefined/xiongbilin.xbl)反馈测试有效，正在走大促发布流程 |\n| 2024-09-05 14:50 | [@一格](undefined/xiongbilin.xbl)反馈线上扫这个码应该恢复正常了，会把这个版本发到线上![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256396/1725629832788-1aff5781-8262-4f6f-a01c-4f79e2c4d089.png?x-oss-process=image%2Fformat%2Cwebp%2Fresize%2Cw_942%2Climit_0) |\n| 2024-09-05 14:52 | [@玥深](undefined/shushen.fss)反馈到14点的，这部分异常版本上的这类流量过滤比超过99%，理论上小时修正后客户应该无明显感知；[@淮竹](undefined/dagui.cdg)反馈止血的方式是受影响的场景断流。不过仍然保留了一部分流量线上方便排查，所以可能会有一些增量的影响，不过幅度很小影响应该会比较微弱 |\n| 2024-09",
    "chunk_order_index": 7,
    "full_doc_id": "doc-7d2551f2c402446ade661bafd052d1f3"
  },
  "chunk-40b2895eb2f500ede03b447c62f7727e": {
    "tokens": 1200,
    "content": ".fss)反馈到14点的，这部分异常版本上的这类流量过滤比超过99%，理论上小时修正后客户应该无明显感知；[@淮竹](undefined/dagui.cdg)反馈止血的方式是受影响的场景断流。不过仍然保留了一部分流量线上方便排查，所以可能会有一些增量的影响，不过幅度很小影响应该会比较微弱 |\n| 2024-09-05 14:54 | [@玥深](undefined/shushen.fss)反馈今天历史时段的数据会在日常的反作弊逻辑中进行修正，不需要任何特殊操作，可以找几个有客诉的客户伪登录看看，现在应该报表都恢复了 |\n| 2024-09-05 14:58 | [@向桐](undefined/wanglianyu.wly)反馈已经恢复了![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256396/1725629946169-ed3a6989-65a9-46db-9589-81be1a7dab3a.png) |\n| 2024-09-05 15:00 | [@苏绮](undefined/panhuamin.phm)咨询业务可以恢复线上ND任务了吗 |\n| 2024-09-05 15:01 | [@玥深](undefined/shushen.fss)反馈得依赖端上同学的修复情况，我们反作弊只是把已经发生的在小时级修正回来，如果端上没修复就恢复ND任务，还会造成新的问题；[@淮竹](undefined/dagui.cdg)反馈线上是否能恢复以端上同学的发布进度为准，不依赖广告主报表结果 |\n| 2024-09-05 15:06 | [@一格](undefined/xiongbilin.xbl)反馈发布正在放量，尽量1小时内放完全量 |\n| **2024-09-05 15:56** | **【故障恢复】**前端修复版本走完大促发布流程，线上推全 [@一格](undefined/xiongbilin.xbl)。 |\n| 2024-09-05 15:58 | [@淮竹](undefined/dagui.cdg)咨询[@一格](undefined/xiongbilin.xbl)放量到多少了，线上CTR好像仍然比较高；[@一格](undefined/xiongbilin.xbl)反馈前端兜底修复版本刚推全，10.40.0版本流量会逐渐更新成新版本，全量后覆盖率上去比较快，可以再观测下 |\n| 2024-09-05 16:10 | [@淮竹](undefined/dagui.cdg)反馈看上去在下降了，应该就是这个问题。可以再观察一段时间![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256396/1725630181590-12580d6a-7939-40b3-81e3-1dc349d92752.png?x-oss-process=image%2Fformat%2Cwebp%2Fresize%2Cw_1500%2Climit_0) |\n| **2024-09-05 16:36** | **【影响消除】**[@淮竹](undefined/dagui.cdg)反馈CTR已恢复至周环比位置；[@苏绮](undefined/panhuamin.phm)确认是否可以联系业务同学恢复ND任务；![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256396/1725630207618-7b038758-d07e-40c6-a2bc-876b3d620f4f.png) |\n| 2024-09-05 16:39 | [@一格](undefined/xiongbilin.xbl)同学反馈可以恢复ND任务，因为是前端做的兜底，后续CTR需关注是否有小规模gap |\n| 2024-09-05 16:41 | [@析君](undefined/zhaopeng.zzp)反馈购后ND的点击率恢复至正常水位，可以通知互动场景的同学ND任务恢复上线止损；![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256396/1725954873019-0a094d12-fdc6-43bf-afc6-3b0231c31c1a.png) |\n\n\n\n\n\n\n## 三、影响产品线&影响面\n    - [ ] 是否影响可用性\n        * 可用性指标，可用性时长消耗\n    - [ ] 业务影响：\n        * 影响的产品线，业务功能，功能受损程度（成功量/率下跌多少%），持续多少时间\n    - [x] 是否有客诉量：\n        * 故障期间无界精准人群整体客诉量：21例（去重后）\n\n[9.5消耗集中.xlsx](https://yuque.antfin.com/attachments/lark/0/2024/xlsx/147156506/1731031183406-9d1fece3-dd2d-4fcf-af23-f4bbb3b44a03.xlsx)\n\n    - [ ] 是否有社会舆情",
    "chunk_order_index": 8,
    "full_doc_id": "doc-7d2551f2c402446ade661bafd052d1f3"
  },
  "chunk-309e00143a6b502e7dc676ddb9926837": {
    "tokens": 1200,
    "content": "客诉量：\n        * 故障期间无界精准人群整体客诉量：21例（去重后）\n\n[9.5消耗集中.xlsx](https://yuque.antfin.com/attachments/lark/0/2024/xlsx/147156506/1731031183406-9d1fece3-dd2d-4fcf-af23-f4bbb3b44a03.xlsx)\n\n    - [ ] 是否有社会舆情：\n        * 舆情ESU等级/未到E等级，舆情关键词，总声量，负声量\n    - [ ] 是否产生资损：\n        * 理论资损金额，实际资损金额\n\n_/* 可附相关故障等级定义的链接和截图]*/_\n\n链接：[https://aliyuque.antfin.com/qf9pla/dx8mse/zs13byulnad58mg8#BaBo](https://aliyuque.antfin.com/qf9pla/dx8mse/zs13byulnad58mg8#BaBo)\n\n截图：\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256396/1725852712077-2ffab57d-efbf-401e-a1df-fb450138bcd2.png)\n\n## 四、故障原因\n### 4.1【背景说明】\n[小时达业务反馈Slider组件自动轮播丢失willchange事件](https://aone.alibaba-inc.com/v2/project/1049436/bug/58117187# 《Slider 在自动轮播情况下不会触发 willchange，手动滑动才能触发》)，Weex 在手淘10.40.0版本上修复此业务反馈问题，导致ND业务监听willchange事件旧有线上逻辑出现非预期差异，影响广告计费\n\n\n\n### 4.2【原因分析】\n#### **4.2.1 一句话原因**\nWeex侧在手淘10.40.0版本修复willchange事件漏报，新增自动轮播willchange事件上报，该变更影响到了ND广告计费等相关逻辑。\n\n#### **4.2.2 根因分析**\n**用户路径：**\n\n非手淘10.40.0版本，用户进入ND商品卡->手动滑动图文->发送pic_move广告事件\n\n手淘10.40.0版本发版后，用户进入ND商品卡->无需手动滑动图文，自动滑动时就会发送pic_move广告事件，带来pic_move类型的整体广告上报量激增，引发客诉。\n\n**技术侧归因：**\n\nND pic_move广告埋点上报，依赖weex框架侧给的Silder-willchange事件，该事件非手淘10.40.0版本只在主动滑动会给。10.40.0 版本Weex变更，willchange事件主动滑动+自动轮播均会触发（修复漏发问题），导致ND前端非广告的自动轮播事件被误识别为广告点击。\n\n业务实际使用与官方文档描述存在行为差异，导致业务使用出现非预期行为；链接：[https://weex.alibaba-inc.com/docs/components/slider.html#willchange](https://weex.alibaba-inc.com/docs/components/slider.html#willchange)\n\n## 五、关注点分析\n### 5.1【系统质量】\n#### 5.1.1 需求&设计评估\n**〖关注点〗****是否涉及产品、技术方案评估？此核心的问题是什么，如何改进？**\n\n    - [ ] **是，涉及**\n        - [ ] 需求评估遗漏\n        - [ ] 产品设计缺陷\n        - [ ] 系统架构设计缺陷：\n\n            - [ ] 容错性不足 \n\n    - [ ] 单点，无冗余\n\n    - [ ] 缺乏自我保护\n\n            - [ ] 缓存设计不当\n\n    - [ ] 容量评估不足\n\n    - [ ] 非幂等设计\n\n            - [ ] 强弱依赖不合理\n\n    - [ ] 其他： \n\n    - [x] **否，不涉及**\n\n**〖问题总结〗**\n\n\n\n**〖改进点〗**_****_\n\n_****_\n\n#### 5.1.2 代码质量\n##### **〖关注点1〗****CodeReview阶段**\n+ **是否经过CR（****红线点****）**\n\n- [x] 是   请提供代码提交or合并的Aone链接： [https://code.alibaba-inc.com/openweex/weex/codereview/17709572](https://code.alibaba-inc.com/openweex/weex/codereview/17709572) \n\n- [ ] 否\n\n- [ ] 不涉及\n\n+ **是否设置合理的CR卡点**\n\n- [x] 是     \n\n- [ ] 否\n\n- [ ] 不涉及\n\n注：[CR卡点设置要求](https://ata.alibaba-inc.com/articles/225396?spm=ata.25287382.0.0.5e0c7536X43l05)\n\n+ **CodeReview阶段是否发现问题？**\n\n- [ ] 是\n\n- [x] 否，未发现原因：本次变更是为了修正问题，变更行为符合需求预期\n\n**〖改进点〗**_****_\n\n暂无\n\n##### **〖关注点2〗****单测阶段**\n+ **在线变更，****是否经过功能单测",
    "chunk_order_index": 9,
    "full_doc_id": "doc-7d2551f2c402446ade661bafd052d1f3"
  },
  "chunk-85661b928b869b930cf2f70c383eb93e": {
    "tokens": 1200,
    "content": "87382.0.0.5e0c7536X43l05)\n\n+ **CodeReview阶段是否发现问题？**\n\n- [ ] 是\n\n- [x] 否，未发现原因：本次变更是为了修正问题，变更行为符合需求预期\n\n**〖改进点〗**_****_\n\n暂无\n\n##### **〖关注点2〗****单测阶段**\n+ **在线变更，****是否经过功能单测：（****红线点****）**\n\n        - [x] 是\n\n- [ ] 否\n\n+ **离线变更，****生成的离线数据是否经过数据校验：**（**红线点**，校验内容：与发布前版本对比，校验数据条数、数据大小、关键字段值域正态分布等是否符合预期）\n\n        - [ ] 是\n\n- [ ] 否\n\n+ **单测阶段是否发现问题？**\n\n- [ ] 是\n\n- [x] 否，未发现原因：行为符合预期\n\n##### **〖关注点3〗****测试阶段**\n+ **测试内容：**涉及的测试提交单、测试用例等\n+ **测试人员：乐舟**\n+ **是否经过测试验证：**\n    - [x] 是\n\n验证环境：\n\n- [x] 预发环境\n\n- [ ] 日常环境\n\n测试方法：\n\n- [ ] 回归测试\n\n- [ ] 集成测试\n\n- [ ] 链路测试\n\n- [x] 验收测试\n\n    - [ ] 否\n\n- [ ] 不涉及\n\n+ **是否自动化测试可覆盖：**\n\n    - [ ] 是\n\n- [x] 否\n\n\n\n+ **测试未发现的原因：**\n    - [ ] 回归遗漏\n\n        - [ ] 手工回归case遗漏\n\n- [ ] 自动化未建设\n\n- [ ] 自动化回归覆盖不足\n\n- [ ] 其它： \n\n    - [ ] 新场景遗漏\n\n        - [ ] 功能测试用例遗漏，包括正常分支和异常分支\n\n- [ ] 容灾兜底测试遗漏\n\n        - [ ] 客户端兼容性测试遗漏\n\n- [ ] 埋点测试遗漏\n\n        - [ ] 性能测试遗漏，影响评估不足\n\n- [ ] 安全测试遗漏\n\n        - [ ] 其他： \n    - [x] 其他  新版本行为在测试中被认为是符合预期的，本次代码修改的目的就是为修复不发事件的问题 \n\n**〖改进点〗**_****_\n\n暂无\n\n#### 5.1.3 变更质量\n+ **是否涉及变更：**\n\n    - [x] 是\n\n- [ ] 否\n\n\n\n+ **变更类型：**\n\n- [ ] 在线生产代码变更\n\n- [ ] 引擎全量索引变更\n\n- [ ] 实时索引更新变更\n\n- [ ] 算法模型变更\n\n- [ ] whaleshark实验参数变更\n\n- [x] 其他变更：       客户端发版              \n\n- [ ] 不涉及\n\n+ **变更平台是否接入ChangeFree：**\n    - [ ] 是，CF变更单链接： \n\n_/*要这样的链接_ [https://aicf.alibaba-inc.com/aicf/change/detail/1725370372](https://aicf.alibaba-inc.com/aicf/change/detail/1725370372) */\n\n    - [x] 否，外部变更系统：     本次属于运营类变更未硬性要求接入CF，需要外部厂商进行发布因此评估后不可接入CF，[集团变更系统管控接入规范](https://aliyuque.antfin.com/trecs/fzg6dy/rutkif) \n+ **是否违反变更红线3.2**** **[**链接**](https://aliyuque.antfin.com/trecs/fzg6dy/uar1k6)\n    - [ ] 是，违反哪条原则：\n    - [x] 否\n\n##### **〖关注点1〗****灰度阶段**\n变更执行影响面**资损低于20%**或影响**客户数量低于20%**的变更统一称为灰度变更\n\n+ **是否经过灰度：（****红线点****）**\n- [x] 是，\n    - 是否有效灰度（灰度发布时间间隔大于20分钟）：\n\n        - [x] 是\n\n- [ ] 否\n\n- [ ] 否\n+ **观测了哪些监控**：__\n    - [ ] 黑屏、白屏\n    - [ ] GOC监控： \n    - [x] 系统大盘： [https://ha.emas.alibaba-inc.com/#/page/crash?r_=/overview/:appId&g_={%22appId%22:%2212278902@android%22}&l_={}](https://ha.emas.alibaba-inc.com/#/page/crash?r_=/overview/:appId&g_={%22appId%22:%2212278902@android%22}&l_={}) \n    - [ ] 其他： \n+ **是否灰度期间发现问题？**\n    - [ ] 是\n\n        - [ ] 灰度流量过大，引发故障\n\n- [ ] 灰度发现但未有效或及时修复，导致故障\n\n- [ ] 其它： \n\n    - [x] 否，未发现原因：\n\n        - [ ] 应",
    "chunk_order_index": 10,
    "full_doc_id": "doc-7d2551f2c402446ade661bafd052d1f3"
  },
  "chunk-6387e2387fbf29fc7e947435a3597f6a": {
    "tokens": 1200,
    "content": "%22:%2212278902@android%22}&l_={}) \n    - [ ] 其他： \n+ **是否灰度期间发现问题？**\n    - [ ] 是\n\n        - [ ] 灰度流量过大，引发故障\n\n- [ ] 灰度发现但未有效或及时修复，导致故障\n\n- [ ] 其它： \n\n    - [x] 否，未发现原因：\n\n        - [ ] 应用灰：\n\n- [x] 灰度流量太小\n\n- [ ] 灰度阶段无法监控\n\n- [ ] 灰度批次不合理\n\n- [ ] 超长时间恢复才能发现\n\n        - [ ] 业务灰：策略不合理\n        - [ ] 灰度无法发现\n        - [ ] 其它： \n\n**〖改进点〗**_****_\n\n1、客户端灰度版本是否可提供广告相关的监控能力/问题发现能力，关于ND任务场景新增脱敏数据监控看板；——负责人：迎曦     预计：待评估     验收人：庄魅\n\n2、梳理出相关核心场景需要进行对应的埋点情况，具体埋点验收场景视情况而定。\n\n##### **〖关注点2〗****上线阶段**\n+ **是否在窗口期进行发布变更：**【周一~周五 09：30~20：00（注意避开吃饭时间12:00~13:30）】\n    - [x] 是\n    - [ ] 否，原因： \n+ **变更是否影响上下游**\n    - [x] 是，是否有提前知会上下游评估及关注变更\n        - [ ] 有提前知会\n        - [x] 没有提前知会\n    - [ ] 否\n+ **是否分批分机房或分批发布：（****红线点****）**\n\n    - [x] 是\n\n\n\n    - 分机房或分批发布第一批发布时间间隔是否大于20分钟：\n\n        - [x] 是\n\n- [ ] 否\n\n    - [ ] 否\n+ **是否进行黄金眼指标观察：**（涉及引擎相关变更，此点为**红线点**，变更10分钟左右，观察已发布本机房、核心pid、分广告主体类型的黄金眼业务指标）\n    - [ ] 是，观测监控链接： \n    - 是否发现问题\n\n        - [ ] 是\n\n- [ ] 否，原因： \n\n    - [ ] 否\n    - [x] 不涉及\n+ **是否验证变更改动点：**(**红线点**，已变更的功能逻辑&数据已经生效)\n    - [x] 是 (请提供观测监控链接，或直接/间接生效截图记录)：    验证了本次改动需求方小时达自动轮播功能，功能逻辑符合预期   \n    - 是否发现问题\n\n        - [ ] 是\n\n- [ ] 否，原因： \n\n    - [ ] 否\n    - [ ] 不涉及\n+ **是否验证其它核心变点：**(错误日志/功能或接口成功率或失败率/rt、CPU、内存等系统指标等)\n    - [ ] 是 验证点： \n    - 是否发现问题\n\n        - [ ] 是\n\n- [ ] 否，原因： \n\n    - [ ] 否\n    - [x] 不涉及\n\n**〖改进点〗**_****_\n\n1、底层变更需知会业务方\n\n[小时达业务反馈Slider组件自动轮播丢失willchange事件](https://aone.alibaba-inc.com/v2/project/1049436/bug/58117187#%20%E3%80%8ASlider%20%E5%9C%A8%E8%87%AA%E5%8A%A8%E8%BD%AE%E6%92%AD%E6%83%85%E5%86%B5%E4%B8%8B%E4%B8%8D%E4%BC%9A%E8%A7%A6%E5%8F%91%20willchange%EF%BC%8C%E6%89%8B%E5%8A%A8%E6%BB%91%E5%8A%A8%E6%89%8D%E8%83%BD%E8%A7%A6%E5%8F%91%E3%80%8B)，Weex 在手淘10.40.0版本上修复此业务反馈问题。\n\n后续底层事件变更上线前，需对影响面进行充分评估，并与相关业务方进行确认。\n\n### 5.2【处置能力】\n#### 5.2.1 故障发现&响应\n+ **是否监控发现**\n    - [ ] 是，监控报警链接： \n\n        - [ ] 故障触发方\n\n- [ ] 受影响方\n\n    - [x] 否，原因为：\n\n        - [x] 监控缺失\n\n- [ ] 监控无效\n\n- [ ] 无法监控\n\n+ **发现后是否五分钟内响应**\n    - [x] 是\n    - [ ] 否，原因为：\n+ **应急协同组织是否存在问题，如何改进？**\n    - [ ] 是\n        - [ ] 应急流程不明确（无流程",
    "chunk_order_index": 11,
    "full_doc_id": "doc-7d2551f2c402446ade661bafd052d1f3"
  },
  "chunk-86a26727a0b916bc1d180527628ca913": {
    "tokens": 1200,
    "content": "- [x] 否，原因为：\n\n        - [x] 监控缺失\n\n- [ ] 监控无效\n\n- [ ] 无法监控\n\n+ **发现后是否五分钟内响应**\n    - [x] 是\n    - [ ] 否，原因为：\n+ **应急协同组织是否存在问题，如何改进？**\n    - [ ] 是\n        - [ ] 应急流程不明确（无流程或者流程不清晰、应急相关角色&职责不明确，缺失一号位等)\n        - [ ] 应急执行不到位（有流程，但未按流程执行，通告发送不及时，响应不及时等）\n    - [x] 否\n\n**【****本次阿里妈妈侧未监控发现的原因分析】**\n\nmm_12852562_1778064_115714950137、mm_12852562_1778064_115685900469、mm_12852562_1778064_114749650314 这几个PID，没有放到nd聚合场景监控下面，所以只能通过大盘的点击波动报警发现，妈妈侧同环比报警，上涨只有超过30%才报警，这几个PID加起来没有到阈值。  \n**【****改进点****】**  \n1、黄金眼把这些pid加到ND的聚合场景报警中：黄金眼监控场景对齐，本次通过「大盘报警」而非ND场景报警报出来，是因为当前ND聚合场景PID写死，出问题PID（mm_12852562_1778064_115714950137、mm_12852562_1778064_115685900469、mm_12852562_1778064_114749650314）不再对应场景，需要设置「同步机制」，将统一配置的PID信息同步至黄金眼报警。——负责人：[@应灵](undefined/durui.dr)[@迎曦](undefined/yingxi.wl)         预计：待评估   验收人：[@庄魅](undefined/qiurui.qiu)\n\n2、ND侧补充广告上涨场景的监控报警；——已完成\n\n#### 5.2.2 故障定位&恢复\n+ **主要恢复方式：**\n\n    - [x] 代码发布/回滚\n\n- [ ] 配置发布/回滚\n\n- [ ] 数据订正\n\n- [ ] 机器隔离/重启/扩容\n\n    - [ ] 配置限流\n\n- [ ] 预案降级\n\n- [ ] 自动恢复\n\n- [ ] 其它： \n\n+ **是否10分钟内恢复**__\n    - [ ] 是\n    - [x] 否\n\n**〖关注点1〗定位&恢复阶段存在什么问题？是否可以增加预案，****有更快的恢复方式？****相关的优化改进？**\n\n改进项：任何引起对外行为变更的底层改动后续强制要求加开关，终端内部团队变更规范要求文档补充，团队内部宣导周知到相关同学。——负责：家愿     已完成\n\n**〖关注点2〗业务自身是否具备容灾逃逸能力？后续如何改进？**__\n\n- [ ] 具备容灾能力\n\n    - [ ] 因未演练不敢执行\n\n- [ ] 因有损评估决策不执行\n\n- [ ] 无决策或者决策不当，未执行\n\n- [x] 不具备容灾能力\n\n## 六、故障总结反思\n+ **此次故障是否触发广告技术部安全生产考试中的红线点？**\n\n- [ ] 是，团队： \n\n- [x] 否\n\n## 七、故障Action\n| **序号** | *******Action标题** | *******负责人** | *******计划完成时间** | **Action描述** | **验收标准** | **验收人** | **是否keyAction** | **是否回血Action** |\n| :---: | --- | :---: | :---: | --- | --- | :---: | :---: | :---: |\n| 1 | 短期：weex底层变更的同步机制 | 龙冥 | 09.30 | + Weex侧对外暴露的能力发生行为变更，需提前同步到上层各业务方；+ 增加Weex组件、事件埋点，用于分析变更影响面和关联业务方 | 日常迭代变更内容通过ReleaseNotes形式同步到业务群；组件事件数据上埋点上报，客户端0925迭代集成 | 乐舟 | - | - |\n| 2 | 短期：业务高风险链路梳理 | 展示：庄魅搜索：蓝壹wsearch：小枫团队weex：乐舟 | 待评估，中秋节后对焦 | 待评估具体可行性解决方案：+ 梳理业务重要场景（涉及广告、资金等）Weex事件依赖及前端使用方式的合理性+ 妈妈团队协助梳理出广告核心链路用到weex事件回调情况 | - | - | - | - |\n| 3 | 短期：监控场景补充 | 一格 | 09.10（已完成） | ND侧补充广告上涨场景的监控报警",
    "chunk_order_index": 12,
    "full_doc_id": "doc-7d2551f2c402446ade661bafd052d1f3"
  },
  "chunk-81fa2360cc321c55be2036b6bee0ce6b": {
    "tokens": 774,
    "content": "+ 梳理业务重要场景（涉及广告、资金等）Weex事件依赖及前端使用方式的合理性+ 妈妈团队协助梳理出广告核心链路用到weex事件回调情况 | - | - | - | - |\n| 3 | 短期：监控场景补充 | 一格 | 09.10（已完成） | ND侧补充广告上涨场景的监控报警 |  | - | 是 | - |\n| 4 | 短期：ND聚合场景黄金眼报警新增对应PID统计 | 应灵、迎曦 | 09.25 | 黄金眼把这些pid加到ND的聚合场景报警中：黄金眼监控场景对齐，本次通过「大盘报警」而非ND场景报警报出来，是因为当前ND聚合场景PID写死，出问题PID（mm_12852562_1778064_115714950137、mm_12852562_1778064_115685900469、mm_12852562_1778064_114749650314）不再对应场景，需要设置「同步机制」，将统一配置的PID信息同步至黄金眼报警。 | ND聚合场景黄金眼监控补充本次相关pid的统计，确保监控有效性。 | 庄魅 | 是 | - |\n| 5 | 短期：ND任务场景新增脱敏数据监控看板 | 迎曦 | 待评估，中秋节后进一步对焦 | 客户端灰度版本是否可提供广告相关的监控能力/问题发现能力，关于ND任务场景新增脱敏数据监控看板； | 确保ND任务场景新增脱敏数据监控看板。 | 庄魅 | - | - |\n\n\n## 八、故障定级&定责&故障分自查\n【故障等级】P5\n\n| **  系统质量（30%）** | | | | | **处置能力（70%）** |\n| :---: | --- | --- | --- | --- | :---: |\n| **相关方** | **需求设计** | **代码质量** | **变更质量** | **自定义项** | **发生时间** | **发现时间（30%）** | **恢复时间（40%）** |\n| 淘天集团-用户平台&阿里妈妈事业部-阿里妈妈-广告技术部-工程技术-效果引擎-展示广告引擎 | 不涉及 | 不涉及 | 不涉及 |  | 09-05 09:39 | 09-05 10:37 | 不涉及，属于受影响方，不具备恢复能力 |\n| 淘天集团-业务技术-终端平台-跨端技术-Weex&引擎技术 | 不涉及 | 不涉及 | 是 |  | 09-05 09:39 | 09-05 13:20 | 09-05 15:56 |\n| 淘天集团-业务技术-用户&内容技术-用户终端技术-用户前端 | 不涉及 | 不涉及 | 不涉及 | 业务实际使用与官方文档描述存在行为差异，导致业务使用出现非预期行为链接：[https://weex.alibaba-inc.com/docs/components/slider.html#willchange](https://weex.alibaba-inc.com/docs/components/slider.html#willchange) | 09-05 09:39 | 09-05 11:47 | 09-05 15:56 |",
    "chunk_order_index": 13,
    "full_doc_id": "doc-7d2551f2c402446ade661bafd052d1f3"
  },
  "chunk-8d0a1bb5f7332a0af1217819212aef23": {
    "tokens": 1200,
    "content": "## 一、故障简述\n2024年09月04日17:37分收到有关无界商家反馈手机短信提示退款成功，但是账户明细没有申请退款的客诉风险预警单，初步排查客户未发生真实退款，怀疑是短信误发导致，北僧同学通过暂停所有退款短信下发任务，业务于17:45分恢复。故障期间累计客诉39例。\n\n**APM故障链接：**\n\n[https://cofree.alibaba-inc.com/ormEmergency/workbench/emergency/202409040000001413001](https://cofree.alibaba-inc.com/ormEmergency/workbench/emergency/202409040000001413001) \n\n## 二、故障过程回顾\n### 2.1【时间线概览】\n![画板](https://intranetproxy.alipay.com/skylark/lark/0/2024/jpeg/80256396/1725951922804-5f4bb3e2-e3d6-4142-addc-708fdf943aa2.jpeg)\n\n### 2.2【故障处理时间线】\n**2024-09-04 16:56:46**，系统显示DB规格升级完成；**——【故障引入】**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/97008/1725518861117-0f306190-3efe-4edc-b16f-e36d4ea4cf91.png)\n\n2024-09-04 17:10，退款通知任务首次执行超时；\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/97008/1725520946974-d282367c-896a-4b32-900b-b0f70d4d44a1.png)![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/97008/1725520961707-7ab4fa91-f051-4d4f-a663-507fec2d22e8.png)\n\n图1-17时任务执行14s未超时（说明未发送积压短信）\t\t\t\t图2-17时10分任务执行8分钟\n\n2024-09-04 17:16:49，客满团队收到第一例有关无界商家手机短信提示退款成功，但是账户明细没有申请退款的客诉；\n\n**2024-09-04 17:18:59**，客诉达到3例（去重后）；**——【故障发生】**\n\n**2024-09-04 17:26**，发现超时预警，排查退款任务超时报警；**——【故障发现】【业务响应】**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/97008/1725520860835-5a1bd3a5-7fd3-41b6-b739-24b22611e446.png)![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/97008/1725520466406-c5f3b672-125f-497b-9267-abc7849f5a49.png)\n\n2024-09-04 17:37，广告技术部风险预警群收到有关“无界商家手机短信提示退款成功，但是账户明细没有申请退款”的客诉预警单；\n\n2024-09-04 17:38，张黑接收并将预警单转交给[@北僧](undefined/haoyantao.hyt)进一步排查；\n\n2024-09-04 17:40，针对客诉客户排查退款情况，确认实际无退款交易；****\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/97008/1725521747424-c3c3e846-aace-4500-bec8-7b94fecdfc2d.png)\n\n**2024-09-04 17:43**，期间经讨论推测可能是某个节点错发了短信；**——【初因定位】**\n\n**2024-09-04 17:45**，[@北僧](undefined/haoyantao.hyt)同学停止对应任务调度；**——【恢复执行】【故障恢复】【影响消除】**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/97008/1725521941426-e18c578a-b68d-4381-8056-fabc638d5c66.png)\n\n2024-09-04 18:03，研发同学[@湛明](undefined/zhanming.szm)联系客满同学[@莯辰](undefined/langdong.ld)反馈用户实际没有退款，辛苦安抚客户是短信误发，具体误发原因排查中，相关任务均已暂停；\n\n**2024-09-04 19:00**，确认因数据库规格升级导致有历史积压退款短信发送请求集中处理（因DB升级，慢查询耗时下降，历史积压短信补发成功）；**——【根因定位】**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/97008/1725523396473-76b5d4a8-bc46-42f2-b977-ba1b136ab302.png)",
    "chunk_order_index": 0,
    "full_doc_id": "doc-d280e864b60719bc97116bc974ee7b7b"
  },
  "chunk-0be7b1a71b6abed4f58ddeb636aac68d": {
    "tokens": 1200,
    "content": "**，确认因数据库规格升级导致有历史积压退款短信发送请求集中处理（因DB升级，慢查询耗时下降，历史积压短信补发成功）；**——【根因定位】**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/97008/1725523396473-76b5d4a8-bc46-42f2-b977-ba1b136ab302.png)\n\n2024-09-04 21:11，与业务对焦先临时下线退款短信发送功能观察，相关代码发布完成，任务恢复调度。****\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/97008/1725522742603-239a0331-b7e3-420d-9417-1b83d33ff897.png)\n\n## 三、影响产品线&影响面\n    - [x] 是否有客诉量：\n        * 故障期间无界累计客诉量：39例（去重后）\n\n[9.4退款短信误提醒.xlsx](https://yuque.antfin.com/attachments/lark/0/2024/xlsx/147156506/1731031183296-c2538117-b4bd-4928-855a-a23bc0b6bbf2.xlsx)\n\n    - [ ] 是否产生资损：\n        * 无\n\n## 四、故障原因\n### 4.1【一句话原因】\n确认因数据库规格升级导致有历史积压退款短信发送请求集中处理（因DB升级慢查询耗时下降，历史积压短信补发任务获取积压消息成功，积压短信下发成功）；\n\n### 4.2【详细原因】\n1. 「计划消耗/限额数据产出任务」上线试跑，发现ALIAD_STL_CREDIT库CPU打满，考虑做扩容升级；\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/97008/1725525059748-e53e3ee8-2038-4634-84d3-d9efdda4478f.png)\n\n2. 退款任务会对历史未成功触达短信做消息补发，但因旧DB性能不足慢查询无法返回待补发消息列表，该补发任务从未成功执行；\n\n![画板](https://intranetproxy.alipay.com/skylark/lark/0/2024/jpeg/97008/1725934250613-8acead2a-1578-43bb-bdb1-ad73f8ab82d0.jpeg)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/97008/1725524501023-b0e095f7-546e-48e4-b4f8-8ee8da99ec06.png)![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/97008/1725524534917-0fb4145d-14e3-498a-9c73-0aa549f90218.png)\n\n**图-DB升级前待补发查询耗时>5s\t\t\t\t\t\t\t图-DB升级前待补发查询耗时4s**\n\n## 五、关注点讨论\n#### 1、问题引入阶段——不涉及代码发布变更\n【在/离线变更代码开发完成后，需要经过**code review**确认无误后进行合并**代码主干**提交】--红线点\n【在线变更代码修改提交必须经过**功能单测；**离线变更代码修改完成后，生成的离线数据必须要经过**数据校验**】--红线点\n\n**〖关注点1〗**是否有经过CR？是否有经过单测？是否有经过测试？是否自动化测试可覆盖？测试阶段为何没发现？\n请提供CR链接：\n [原因分析]\n ACTION：\n\n【生产变更，**务必要经过灰度发布**，灰度发布时间**间隔大于20min****】**--红线点\n\n**〖关注点2〗**是否变更窗口期进行发布？是否经过灰度？分机房或分批发布第一批发布时间间隔是否大于20分钟？灰度过程中为何未发现问题？\n请提供ChangeFree变更单链接：\n [原因分析]\n ACTION：\n\n\n\n\n\n**【****黄金眼指标观察**，10分钟左右，观察已发布**本机房、核心pid、分广告主体类型**的黄金眼业务指标】--红线点\n\n**【****变更改动点验证**，验证已变更的**功能逻辑&数据已经生效**(最好有直接或间接生效截图记录)**】**--红线点\n\n**〖关注点3〗**是否进行黄金眼指标观察，观察是否发现问题？是否验证变更改动点，验证是否发现问题？\n\n请提供观测链接：\n [原因分析]\n ACTION：\n\n#### 2、故障应急阶段\n**〖关注点4〗**是否有监控发现？若没有，为什么？（监控缺失/报警太多未及时处理/。。） \n[原因分析]监控发现\n请提供监控报警链接：     [scx任务](https://center.schedulerx2.alibaba-inc.com/#/JobList?regionId=cn-hangzhou&namespace=system_namespace&source=schedulerx&) \n\n![](https://intranetproxy.alipay.com/skylark/l",
    "chunk_order_index": 1,
    "full_doc_id": "doc-d280e864b60719bc97116bc974ee7b7b"
  },
  "chunk-40ae0f7f03d9891318dad4d7cc61c2bb": {
    "tokens": 1073,
    "content": "点4〗**是否有监控发现？若没有，为什么？（监控缺失/报警太多未及时处理/。。） \n[原因分析]监控发现\n请提供监控报警链接：     [scx任务](https://center.schedulerx2.alibaba-inc.com/#/JobList?regionId=cn-hangzhou&namespace=system_namespace&source=schedulerx&) \n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/97008/1725888077070-67d7c4bb-13d3-43a3-a9fd-d4b824a8d6cc.png)\n\n ACTION：\n\n+ 退款部分异常日志监控缺失：21年迁移时未完整梳理相关监控，已于今日补建监控；——负责人：北僧     预计：09.13    验收人：湛明\n+ 短信下发同环比监控缺失：未重视短信影响风险，已剔除；——使用CRM平台配置解决\n\n**〖关注点5〗**相关角色的应急响应是否有改进空间？故障恢复方式是什么？是否可优化\n[原因分析]及时暂停短信下发任务，已经是最快的恢复方式了。\n ACTION：\n\n+ 一旦发生退款客诉，退款出款任务应该立即暂停。\n\n## 六、后续Action\n| **序号** | *******Action标题** | **Action描述** | *******负责人** | *******计划完成时间** | **验收标准** | **验收人** | **是否keyAction** | **是否回血Action** |\n| :---: | --- | --- | :---: | :---: | --- | :---: | :---: | :---: |\n| 1 | 短期：退款短信功能下线 | 退款短信功能下线 | 北僧 | 2024.09.04 | - | - | - | - |\n| 2 | 短期：新增同环比上涨监控 | 梳理所有短信、千牛触达客户任务，建同环比监控（补充同环比上涨监控）[https://x.alibaba-inc.com/custom/49/product/preview/multiMinute/2005](https://x.alibaba-inc.com/custom/49/product/preview/multiMinute/2005) | 北僧 | 2024.09.14 | 确保同环比监控阈值配置的合理，能有效及时发现报警。 | 湛明 | 是 | - |\n| 3 | 短期：异常日志加监控梳理+慢SQL影响评估 | 资管侧各场景异常日志加监控梳理，DB的慢SQL梳理评估排除潜在风险，包括但不限于短信数量波动根据业务日常数据评估新增监控（数量波动报警监控）。 | 湛明 | 2024.09.30 | 确保资管侧各场景异常日志加监控梳理完毕，DB的慢SQL梳理后排除潜在风险。 | 慎先 | - | - |\n| 4 | 长期：统一产品化消息触达能力优化 | 收集相关任务，实际短信的发送通过CRM平台配置有关消息触达能力，疲劳度能力建设，以及积压消息管控方面，产品侧先对焦业务边界，于9月底前商讨出具体解决方案。 | 墨海 | 2024.09.30 | 确保方案能实现统一产品化消息触达能力。 | 湛明 | - | - |\n| 5 | 长期：批量式任务超时报警监控梳理 | 梳理并校验资管侧各个场景是否配置任务超时监控规则。 | 北僧 | 2024.09.30 | 确保监控阈值配置合理性和报警有效性。 | 湛明 | 是 | - |\n\n\n## 七、故障相关方\n【故障等级】P5\n\n| **  系统质量（30%）** | | | | | **处置能力（70%）** |\n| :---: | --- | --- | --- | --- | :---: |\n| **相关方** | **需求设计** | **代码质量** | **变更质量** | **自定义项** | **发生时间** | **发现时间（30%）** | **恢复时间（40%）** |\n| 淘天集团-用户平台&阿里妈妈事业部-阿里妈妈-广告技术部-工程技术-广告结算&风控平台-资管平台 | 是 | 不涉及 | 不涉及 |  | 09-04 17:18 | 09.04 17:26 | 09-04 17:45 |",
    "chunk_order_index": 2,
    "full_doc_id": "doc-d280e864b60719bc97116bc974ee7b7b"
  },
  "chunk-1efd880a4eb3f137bbe27667bee1f398": {
    "tokens": 1200,
    "content": "## 一、故障简述\n【P5】2024-09-08 11.06，集群管理研发“清文”kubelet发布 1.22.3.516-20240829152248 版本，之后ODPS、云侧陆续反馈节点不可用，云智能研发“层岚”14:22拉起了一个处理群“20240908-AY36A-MC集群批量异常”排查问题，14:34影响的作业堆积2000+，14:36研发同学定位到是由于kubelet发布的新版本按照timeout seconds（1s）执行readiness probereadiness probe超时导致odps pod not ready，执行回滚动作，直到14:50，全部回滚完成，作业堆积预期消化。\n\n\n\n## 二、故障过程回顾\n### 2.1【故障处理时间线】\n| **时间轴** | **事件** |\n| --- | --- |\n| 2024-09-08 11.06 | 集群管理研发“清文”kubelet发布了1.22.3.516-20240829152248 版本发布单：[**https://asiops.alibaba-inc.com/changes/changeTickets/200376281**](https://asiops.alibaba-inc.com/changes/changeTickets/200376281)**【故障注入】** |\n| 2024-09-08 14.22 | 云智能研发“层岚”拉起了处理群“20240908-AY36A-MC集群批量异常”排查AY36A-MC集群批量异常问题**【故障发现】【故障发生】【故障响应】** |\n| 2024-09-08 14:34 | ASI集群组件发布导致超50%集团节点不可用，到14:34影响的作业堆积2000+logview\\报错截图 |\n| 2024-09-08 14:36 | 拉集群管理研发\"清文\"进群，排查定位到是清文发布导致，执行回滚动作**【故障定位】【恢复执行】** |\n| 2024-09-08 14:50 | 全部回滚恢复，作业堆积预期消化**【故障恢复】** |\n\n\n\n\n### 2.2【时间线概览】\n![画板](https://intranetproxy.alipay.com/skylark/lark/0/2024/jpeg/149256407/1725955816854-a154ebf6-7343-45bd-837d-b8c8e7d7f344.jpeg)\n\n## 三、故障原因\n### 3.1【背景说明】\n#### 【需求背景】\n:::tips\nkubelet发布 1.22.3.516-20240829152248 版本，其中[修复了exec probe超时时间不正确的问题](https://code.alibaba-inc.com/cos/kubernetes/codereview/17726771)（有用户反馈该问题），该修复已发布大部分hippo、hhpai、core01产品线的集群。\n\n发布 asi_zjk_odps_ay36a_02 集群（第一个发布的odps集群）时，由于readiness probe超时导致odps pod not ready\n\n:::\n\n\n\n### 3.2【原因分析】\n#### 一句话原因：\n:::tips\nkubelet按照timeout seconds（1s）执行readiness probe，probe超时导致pod not ready\n\n:::\n\n#### 根因分析：\n:::tips\n### **问题原因**\nkubelet按照timeout seconds（1s）执行readiness probe，probe超时导致pod not ready\n\n### **为什么老版本kubelet没有发生这个问题**\nkubelet老版本有bug，执行probe命令成超时时间会设置成2分钟，而不是用户指定的timeout seconds。[新版本kubelet修了这个bug](https://code.alibaba-inc.com/cos/kubernetes/codereview/17726771)\n\nodps pod的timeout seconds只有1s，也就是说老版本kubelet以2分钟的timeout执行probe，新版本以1s的timeout执行probe，但耗时超过1s所以失败\n\n\n\nreadiness probe配置：\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/133557095/1725953802720-a4520579-67d4-42b9-9b7a-17611a2d13d5.png)\n\nprobe执行时间超过1s，导致pod not ready：\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/133557095/1725953816412-7759cd60-ceb3-4ac6-b2bd-27f1b1e7a7fc.png)\n\n:::\n\n\n\n## 四、关注点分析\n**〖关注点1〗**** 本次变更是否在变更窗口内，是否符合云侧的变更规范，变更灰度过程是否有效，灰度未发现的原因是什么，后续应如何改进。**[@清文](undefined/daiwenqing.dwq)\n\n:::tips\n**〖问题总结〗**\n\n否；否\n未发现的原因：灰度时只关注了节点是否ready以及kubelet是否正常运行，没有关注pod的ready情况\n\n**〖改进点〗**\n\n1. 稳定版本覆盖面足够才自动化推平\n2. 不应该周末发布，应严格遵循",
    "chunk_order_index": 0,
    "full_doc_id": "doc-e0868b32487e7cc0b15bff0301b64e2e"
  },
  "chunk-cebcf986035adce6f4c0e9293f5050c3": {
    "tokens": 1200,
    "content": "原因是什么，后续应如何改进。**[@清文](undefined/daiwenqing.dwq)\n\n:::tips\n**〖问题总结〗**\n\n否；否\n未发现的原因：灰度时只关注了节点是否ready以及kubelet是否正常运行，没有关注pod的ready情况\n\n**〖改进点〗**\n\n1. 稳定版本覆盖面足够才自动化推平\n2. 不应该周末发布，应严格遵循云侧变更规范\n3. 组件发布时要在群里同步，方便故障时定位原因\t\t\n4. 发布时要考虑到可能影响的指标，发布时要时刻关注该指标的大盘\n5. 发布集群顺序：先发小集群，测试集群。\n6. 集群odps基座变更协同下游落地  [@潇客](undefined/liang.yel)\t0920\n\n:::\n\n****\n\n**〖关注点2〗** 是否监控发现，监控未发现的原因是什么？\n\n:::tips\n**〖问题总结〗**\n\n最后是通过监控发现\n一开始未发现是因为发布时未关注/不知道有odps[相关大盘](https://tesla.alibaba-inc.com/m3/d/f6j5KHI4z/clusteroverview-on-asi?from=1725703116404&orgId=1&to=1725860475360&var-cluster=asi_zjk_odps_ay36a_02&var-interval=1m&var-quantile=0.95)\n\n**〖改进点〗**\n\n**监控完善，颗粒度指标细化\t**[@潇客](undefined/liang.yel)** **0920\n\n以后发布odps集群时，注意关注[相关大盘](https://tesla.alibaba-inc.com/m3/d/f6j5KHI4z/clusteroverview-on-asi?from=1725703116404&orgId=1&to=1725860475360&var-cluster=asi_zjk_odps_ay36a_02&var-interval=1m&var-quantile=0.95)（odps、tair、中间件）指标\n告警场景订阅  [@锦雯](undefined/jinwen)\t0920\n\n:::\n\n\n\n**〖关注点3〗**** **发布时间是否合理，是否通知上下游业务？\n\n:::tips\n**〖问题总结〗**\n\n不合理，没有通知上下游业务\n\n**〖改进点〗**\n\n1. 不应该周末发布，以后一定注意非工作日禁止发布\n2. 发布时补充变更单详细信息、原因\t\n3. 组件发布时要在群里同步，方便故障时定位原因\n\n:::\n\n\n\n**〖关注点4〗** 新版发布是否需要对存量业务对老版本逻辑的依赖评估？\n\n:::tips\n**〖问题总结〗**\n\n需要\n\n**〖改进点〗**\n\n变更时要考虑最坏情况，如果最坏情况不可接受，则不变更\n\n:::\n\n\n\n## 五、故障Action\n| **序号** | *******Action** | *******负责人** | *******计划完成时间** | **验收标准** | **是否keyAction** | **是否回血Action** |\n| --- | --- | --- | --- | --- | --- | --- |\n| 1 | 发布流程规范：1. 稳定版本覆盖面足够才自动化推平2. 不应该周末发布，应严格遵循云侧变更规范3. 组件发布时要在群里同步，方便故障时定位原因\t4. 发布时补充变更单详细信息、原因\t\t5. 发布时要考虑到可能影响的指标，发布时要时刻关注该指标的大盘（odps、tair、中间件）指标6. 变更时要考虑最坏情况，如果最坏情况不可接受，则不变更7. 发布集群顺序：先发小集群，测试集群 | 清文 | 0920 | 产出变更文档： | 是 | 是 |\n| 2 | 集群odps基座变更协同下游落地  | 潇客 | 0920 | 同步协调结果至各下游业务方 | 否 | 否 |\n| 3 | 监控完善，颗粒度指标细化 | 潇客 | 0920 |   完善相关监控文档，监控上线并验证通过 | 否 | 否 |\n| 4 | 告警场景订阅 | 锦雯\t | 0920 | 相关告警场景订阅所有下游业务群 | 否 | 否 |\n\n\n\n\n## 六、故障总结反思\n**【做得好的】**\n\n**【经验教训】**举一反三，学习，避免踩坑\n\n清文：\n\n1. 不应该周末发布，以后一定注意非工作日禁止发布\n2. 发布新版本时，没有考虑到存量业务对老版本逻辑的依赖（即使是个bug）\n3. 组件发布时要在群里同步，方便故障时定位原因\n4. 稳定版本覆盖面足够才自动化推平\n5. 以后发布odps集群时，注意关注[相关大盘](https://tesla.alibaba-inc.com/m3/d/f6j5KHI4z/clusteroverview-on-asi?from=172570",
    "chunk_order_index": 1,
    "full_doc_id": "doc-e0868b32487e7cc0b15bff0301b64e2e"
  },
  "chunk-4df9b68fce02477a93792c93cc45ecd3": {
    "tokens": 155,
    "content": "业务对老版本逻辑的依赖（即使是个bug）\n3. 组件发布时要在群里同步，方便故障时定位原因\n4. 稳定版本覆盖面足够才自动化推平\n5. 以后发布odps集群时，注意关注[相关大盘](https://tesla.alibaba-inc.com/m3/d/f6j5KHI4z/clusteroverview-on-asi?from=1725703116404&orgId=1&to=1725860475360&var-cluster=asi_zjk_odps_ay36a_02&var-interval=1m&var-quantile=0.95)指标\n\n#### \n\n\n  \n\n\n####",
    "chunk_order_index": 2,
    "full_doc_id": "doc-e0868b32487e7cc0b15bff0301b64e2e"
  },
  "chunk-29c828f2d9a663ba5956e2b4be468bfc": {
    "tokens": 1200,
    "content": "## 【故障过程回顾】\n【故障引入】2024-09-18 17:35，[@图凌](undefined/tuling.dhy) 更新 RS 的下游全量 RTP biz。选择分批发布，第一批发布 EA120 机房。由于机房切换需要时间，开始机房机器还没切换完，没有实际生效发布过程前几分钟，所以[@图凌](undefined/tuling.dhy)观测指标无异常\n\n2024-09-18 17:44， RTP biz 开始有机器切换好，RS EA120 出现 ERROR QPS，并持续上涨。\n\n**【故障发现】**2024-09-18 17:56， 主搜rank异常率持续3分钟大于2% 触发P5故障。\n\n**【故障发生】**2024-09-18 18:00， 主搜rank异常率持续3分钟大于10% ，故障升级P4。\n2024-09-18 18:02， RTP EA120 切换完成，RS EA120 全部 ERROR QPS。\n【故障响应】【故障定位】2024-09-18 18:08，定位到正在单机房发布的 RTP。\n【恢复执行】2024-09-18 18:09， [@振云](undefined/zhenyun.yzy) 操作 RTP 回滚目标。\n2024-09-18 18:10，RTP 部分机器回滚成功，ERROR QPS 逐渐下降。\n\n**【故障恢复】**2024-09-18 18:16，回滚完成，故障恢复。\n\n【影响消除】2024-09-18 18:17， RTP 全部回滚成功，RS 恢复正常。\n\n## 【故障原因】\n### 【背景说明】\n需求背景：大促调控的 RTP 耗时较高，需要做性能优化，减少不必要字段计算（之前是计算产出的，为了减少计算过程耗时，选择直接给默认值）。因此修改 racing_weight 字段的默认返回值，优化整体请求耗时。\n\n### 【原因分析】\n**一句话原因：**RS 调用的 RTP 更改了返回值类型，导致 RS 校验类型失败，RS 请求直接 ERROR 无结果。\n\n**根因分析：**\n\n+ 验证不充分直接修改全量 RTP\n    - 正常情况下需要新建rtp biz验证，然后接流新biz。\n    - 在rtp侧做了验证会正常返回，但是没有和rs做全链路的验证。\n+ RS 对于 RTP 返回类型兼容性不足\n    - 系统架构：RS 调用 RTP，默认 RTP 返回类型为 float。当 RTP 返回值为空时，RS 会填默认值兜底；当 RTP 返回非 float 类型时，RS 会校验类型失败，本次 RS 请求 ERROR 无结果。\n\n## 【核心关注点】\n##### 【关注点1】 将racing_weight 字段的返回值修改成什么类型，修改方案是否做过验证？涉及大范围变更，是否需要协同RS侧评估改造方案？rtp发布是否有完善的验证流程规范。\n[原因分析〕\n\n+ racing_weight默认返回0，rtp会识别为int，修改方案通过其他rtp biz验证可以正常返回0。\n+ rs侧对返回值兼容性不足。RS 调用 RTP，默认 RTP 返回类型为 float。当 RTP 返回值为空时，RS 会填默认值兜底；当 RTP 返回非 float 类型时，RS 会校验类型失败，本次 RS 请求 ERROR 无结果。\nACTION:  \n\n+ RS 对 RTP 返回类型兜底：\n+ 算法侧变更全链路测试：\n【关注点2】 修改字段返回值是在哪个变更平台操作的，是否接入CF。本次如何定位到可疑变更，定位过程是否有问题？\n[原因分析〕\n\n+ 修改字段返回值是在suezops操作的。\nACTION:  \n可疑变更通知故障发生时发到指定钉群。[@渝月](undefined/gongpei.gong)\n\n【关注点3】   本次变更灰度批次是什么，灰度期间观察哪些指标，未发现的原因是什么\n[原因分析〕\n\n+ 本次变更是分批发布，第一批发布 EA120 机房。由于机房切换需要时间，开始机房机器还没切换完，没有实际生效发布过程前几分钟，所以[@图凌](undefined/tuling.dhy)观测指标无异常。\n\nACTION:  \n\n+ 算法发布流程中，对观测的要求规范。\n    - 变更规范中增加：全量接流的BIZ变更优先新建biz进行验证，如果因容量等问题无法新建BIZ验证。需要周知上下游，并且观测时间需要在机房接流后大于3分钟。 [@锦雯](undefined/jinwen) 并确认负责规范宣讲的同学。\n    - 算法变更要求在mbox进行验证。\n【关注点4】 18:09操作回滚到18:16回滚完成，回滚时间是否可以优化。（P3故障定的5分钟，能否在5分钟内回滚完成）\n[原因分析〕\n\n+ 可以通过增加额外开关控制切走流量，但故障切流前评估ea119机房扛不住切流流量，只能回滚处理。\nACTION:  \n\n+ 主搜业务单机房级的切流快",
    "chunk_order_index": 0,
    "full_doc_id": "doc-0382516631af04f1625647ca8fd2ce9a"
  },
  "chunk-567d5fbae4b06d062ab7c78063880950": {
    "tokens": 454,
    "content": "18:09操作回滚到18:16回滚完成，回滚时间是否可以优化。（P3故障定的5分钟，能否在5分钟内回滚完成）\n[原因分析〕\n\n+ 可以通过增加额外开关控制切走流量，但故障切流前评估ea119机房扛不住切流流量，只能回滚处理。\nACTION:  \n\n+ 主搜业务单机房级的切流快恢演练（每季度/半年）：通过压测模拟日常高峰期下的单机房切流，在尽量不降级的情况下，保证任意时刻下其他3机房能承接全部流程。\n+ 确认当前RS降级链是否最小可用（确定都有哪些biz）[@振云](undefined/zhenyun.yzy)，评估分机房RS切降级链方案。@曲悠\n+ hyperspace分层开关是否可用以及操作权限[@福豆](undefined/fuyu.lfy)[@夫卡](undefined/yuliang.yyl)\n\n## 【故障Action】\n1. 算法发布流程中，对观测的要求规范：\n    1. 变更规范中增加：全量接流的BIZ变更优先新建biz进行验证，如果因容量等问题无法新建BIZ验证。需要周知上下游，并且观测时间需要在机房接流后大于3分钟。 并确认负责规范宣讲的同学。\n    2. 算法变更要求在mbox进行验证。\n2. 主搜业务单机房级的切流快恢演练（每季度/半年）：通过压测模拟日常高峰期下的单机房切流，在尽量不降级的情况下，保证任意时刻下其他3机房能承接全部流程。\n3. 确认当前RS降级链是否最小可用（确定都有哪些biz），评估分机房RS切降级链方案。\n4. hyperspace分层开关是否可用以及操作权限。\n\n\n\n##",
    "chunk_order_index": 1,
    "full_doc_id": "doc-0382516631af04f1625647ca8fd2ce9a"
  },
  "chunk-16f4dacc1f01d75cfd614fcad41d7ceb": {
    "tokens": 1144,
    "content": "## 一、故障简述\n故障简述：于9月11日反馈韩国本对本发货台商家模版批量发货，模版全部发货识别有误造成交易超时关单，根因确认为模版将“全部发货”识别为\"部分发货\"，订单超时关单后款退给消费者，商家钱货两失引发资损，于9月12日凌晨2:15通过修改代码止血\n\n## 二、故障过程回顾\n### 【故障处理时间线】\n| 时间节点 | 故障节点 | 过程描述 |\n| --- | --- | --- |\n| 2024-06-26 17:21 | 【故障引入】 | 拆子单发货逻辑需求上线 |\n| 2024-09-11 17:43 | 【故障发现】 | @灵葵 反馈韩国本对本发货台商家模版批量发货，模版全部发货识别有误造成交易超时关单 |\n| 2024-09-11 18:00 | 【业务响应】 | @孚远 @林宇豪 介入问题排查 |\n| 2024-09-11 18:00 | 【故障定位】 | @孚远 @林宇豪 定位到代码没有兼容小y问题 |\n| 2024-09-11 23:51 | 【恢复执行】 | @有擎 开始发布修复代码，兼容小y问题，并做非法校验 |\n| 2024-09-12 02:15 | 【故障恢复】 | @有擎 完成所有线上发布，问题止血 |\n| 2024-09-11 21:302024-09-12 06:15 | 【影响消除】 | @孚远 @林宇豪 @有擎开发拉数据代码工具，确认资损影响面 |\n\n\n\n\n## 三、故障原因\n### 3.1【背景说明】\n【需求背景】：\n\n支持商家拆子单发货，在子单后面填写Y/N代表是部分还是全部发货\n\nione：[https://ione.alibaba-inc.com/v2/project/885806/req/57136899](https://ione.alibaba-inc.com/v2/project/885806/req/57136899)  \nprd：[https://aliyuque.antfin.com/shenbi.ml/hxamvg/wutlmhbyyrgb5ytw?singleDoc#](https://aliyuque.antfin.com/shenbi.ml/hxamvg/wutlmhbyyrgb5ytw?singleDoc#)\n\n\n\n【业务链路】\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/138656473/1726653194318-2c7f5ff2-bc3c-479d-816b-e98fa810c5ae.png)\n\n### 3.2【原因分析】\n一句话原因：\n\n:::tips\n商家上传excel，想要将订单全部发货，系统误认为是部分发货\n\n:::\n\n\n\n根因分析：\n\n:::tips\n判断是全部发货的条件用的大Y去完全匹配。但是商家上传excel中写是小y，没有做兼容，也没有校验提示\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/138656473/1726636591088-1da0c84d-b3b9-446d-abca-f27236df7134.png)\n\n:::\n\n\n\n逻辑：超时没有发货会关单\n\n## 四、关注点分析\n【关注点1】提前发现\n\n:::tips\n分析：3PL的订单，是否全部或者部分发货依靠商家自己输入，无法做对账\n\n改进：后续by商家维度进行监控预警，如果即将超时的订单达到一定比例或者数量，即预警   @孚远 10.25\n\n:::\n\n\n\n【关注点2】商家输入优化\n\n:::tips\n分析：全部发货和部分发货全依赖商家自己输入\n\n改进：\n\n产品提供下拉框让商家选择，减少商家输入  @孚远 带回和产品评估\n\n涉及到资损，不要用太简单的英文字母表达  @孚远 带回和产品评估\n\n:::\n\n\n\n【关注点2】风险梳理\n\n:::tips\n梳理存在资损风险的场景\n\n已梳理，@简悟  可和 @淋漓 对接\n\n:::\n\n\n\n## 五、故障Action\n| **序号** | *******Action标题** | *******负责人** | *******计划完成时间** | **Action描述** | **验收标准** | **验收人** | **是否keyAction** | **是否回血Action** |\n| --- | --- | --- | --- | --- | --- | :---: | --- | --- |\n| 1 | 短期：by商家维度进行监控预警，如果即将超时的订单达到一定比例或者数量，即预警   |  孚远 |  10.25 | |  | | | |",
    "chunk_order_index": 0,
    "full_doc_id": "doc-16f4dacc1f01d75cfd614fcad41d7ceb"
  },
  "chunk-f620338f5647dc933d660d34ec6966e3": {
    "tokens": 44,
    "content": "by商家维度进行监控预警，如果即将超时的订单达到一定比例或者数量，即预警   |  孚远 |  10.25 | |  | | | |",
    "chunk_order_index": 1,
    "full_doc_id": "doc-16f4dacc1f01d75cfd614fcad41d7ceb"
  },
  "chunk-77882346ea6b1a288ee0b17b59f2cbc0": {
    "tokens": 1200,
    "content": "## 一、故障简述\n**故障简述：**于8月30日18:40业务反馈生态仓有重复发货的问题，根因确认为小二使用的平台仓拦截推单工具并不支持生态仓单据（但工具逻辑未做限制），导致履约未下发拦截指令给到WMS，重复下发新单据导致，于8月31日02:27完成推单工具调整止血\n\n## 二、故障过程回顾\n### 【故障处理时间线】\n| 时间节点 | 故障节点 | 过程描述 |\n| --- | --- | --- |\n| 2022-09 | 【故障引入】 | 生态仓需求上线，新增生态仓单独拦截重推工具，但是平台仓发拦截重推工具未屏蔽生态仓，针对生态仓订单使用平台仓发拦截重推工具会导致重复下发&发货。 |\n| 2024-08-20 17:55 | | 小二针对生态仓订单8191857061871391使用平台仓发拦截重推工具进行拦截，导致重复发货资损。 |\n| 2024-08-30 18:40 | 【故障发现】 | PD拉群反馈生态仓有重复发货问题。同时进行问题排查。 |\n| 2024-08-30 18:50 | 【业务响应】 | @行晟 介入问题排查 |\n| 2024-08-30 19:20 | 【故障定位】 | 根因定位为小二使用的拦截推单工具并不支持生态仓单据，导致履约未下发拦截指令给到WMS，重复下发新单据至WMS，导致重复发货 |\n| 2024-08-30 22:57 | 【恢复执行】 | @行晟 开始发布工具修复代码，屏蔽平台仓发拦截重推工具对生态仓处理 |\n| 2024-08-31 02:27 | 【故障恢复】 | @行晟 完成所有线上发布，问题止血 |\n| 2024-09-02 10:10 | 【故障补发】 | 评估存在实际资损，故障补发 |\n\n\n## 三、影响产品线及影响面\n    - [x] 是否有客诉量：1+\n    - [x] 是否产生资损：是\n        * 理论资损金额：1493.80美金，实际资损金额：886.66美金\n        * 资损场景（失血点）：重复发货\n\n## 四、故障原因\n### 4.1【一句话原因】\n生态仓订单使用履约通用（平台仓发）重推工具时，会去取消菜鸟LP，同时作废这笔仓单并且重新生成新仓单；由于生态仓并非走菜鸟履行，菜鸟没有订单记录，取消会成功，就导致已取消的订单实际已下发了生态仓对应的3pl WMS系统，生成的新仓单再次下发了一次，最终重复发货。\n\n### 4.2【背景说明】\n+ 【背景】不涉及新需求和变更，历史链路问题\n\n### 4.3【根因分析】\n生态仓订单使用履约通用重推工具，会去取消菜鸟LP，取消成功这笔仓单就作废了并会重新生成新仓单，但是生态仓并不走菜鸟履行，所以当小二错误的使用通用工具重推生态仓订单时，会走到菜鸟链路，又因菜鸟没有该生态仓订单就会取消成功并重新生成新仓单下发，但是实际这笔生态仓订单之前是下发到了对应的wps系统，且因错误使用实际并未取消，生成的新仓单再次下发，最终重复发货\n\n##### 【业务链路图】\n\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/jpeg/93285/1725247160599-fd0b0e56-11be-4aa7-9fcb-31326731619c.jpeg?x-oss-process=image%2Fformat%2Cwebp%2Fresize%2Cw_1920%2Climit_0%2Finterlace%2C1)\n\n\n\n##### 业务代码逻辑\n    - 平台仓发拦截HSF接口：com.alibaba.global.uop.ae.api.tool.intercept.FulfillmentOrderInterceptFacade#intercept\n    - 生态仓拦截HSF接口：com.alibaba.global.uop.ae.api.tool.intercept.EcoFulfillmentOrderInterceptFacade#ecoIntercept\n    - 重新下发接口：com.alibaba.global.uop.ae.api.tool.intercept.FulfillmentOrderResendFacade#resend\n    - 工具流程：\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/jpeg/93285/1725246119622-87922085-71a8-4973-9b88-fdc557c19ccb.jpeg)\n\n\n\n\n\n##### 生态仓拦截工具关键逻辑：业务校验及拦截执行\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/8317/1725352788825-ac706f0d-1a13-4ec4-b",
    "chunk_order_index": 0,
    "full_doc_id": "doc-37b4b5bdfaecdc60c0ff5cc6da6bb34b"
  },
  "chunk-9b50e2f69f8cdd182e90982bed914056": {
    "tokens": 1024,
    "content": "4/jpeg/93285/1725246119622-87922085-71a8-4973-9b88-fdc557c19ccb.jpeg)\n\n\n\n\n\n##### 生态仓拦截工具关键逻辑：业务校验及拦截执行\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/8317/1725352788825-ac706f0d-1a13-4ec4-b23e-f0cab97fca8b.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/8317/1725351257125-a4acc3d5-cf21-4429-87b8-91c1f8bb7cc0.png)\n\n##### 官方仓拦截工具关键逻辑：业务校验及拦截实操\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/8317/1725352855104-0dbace3f-0061-476e-ad37-604300c3038c.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/8317/1725352652851-7fd5eddc-2233-46bd-bb46-004ba32ab601.png)\n\n### 4.4【核心关注点】\n【关注点1】【事前】为何需求方案设计时没有识别这个问题\n\n:::tips\n**原因：**\n\n1. 平台仓发拦截重推工具校验策略是黑名单策略，对于新增场景默认不做阻断，但是逻辑未必正确，对于方案评估遗漏的场景是很大的风险敞口。\n\n**改进措施：**\n\n1. 短期：对于拦截重推类高资损风险工具，业务校验阶段面向链路需要做白名单策略（阻断 > 误调用），避免新增链路评估不到位误用工具造成问题。  @野芳  9.13\n2. 长期 ：收口为同一个入口，建设拦截路由能力    @古言  方案时间 \n+ 优先级：给业务小二使用先收口为一个入口 \n\n:::\n\n\n\n【关注点2】【事中】为何发生资损问题时未第一时间感知\n\n:::tips\n**原因：**\n\n1. 生态仓有建设基于反查WMS单据状态的对账能力，但是该对账噪音较大，当前没有专门业务关注维护，同时几经交接，核心开发同学均已离职，导致该对账目前处于未保鲜&无人关注的状态，未能及时关注并发现该问题；\n\n**改进措施：**\n\n1. 小二操作接 CF审批流 （审批节点 区分大促和日常）   @野芳 9.30\n2. 高危场景（资损场景），监控对账建设    @野芳  9.20（对拦截做补控，确保订单真实取消）\n+ 对账能力\n+ 对拦截做补控，确保订单真实取消\n3. 长期：对于存量业务的稳定性保障SOP，包括监控对账保鲜、异常数据处理流程、订正审批流等； \n\n:::\n\n## 五、故障Action\n| **序号** | **ACTION** | **是否keyAction** | **计划完成时间** | **验收标准** | **Action负责人** | **Action验收人** |\n| --- | --- | --- | --- | --- | --- | :---: |\n| 1 | 短期：对于拦截重推类高资损风险工具，业务校验阶段面向链路需要做白名单策略（阻断 > 误调用） | 是 | 9.13 |  | 野芳 | |\n| 2 | 短期：小二操作接 CF审批流 （审批节点 区分大促和日常） | 否 | 9.30 |  | | |\n| 3 | 短期：高危场景（资损场景），监控对账建设 | 否 | 9.20 |  | | |\n| 4 | 长期：收口为同一个入口，建设拦截路由能力   | 是 | 方案输出时间-待定 |  | 古言  | |\n| 5 | 长期：对于存量业务的稳定性保障SOP，包括监控对账保鲜、异常数据处理流程、订正审批流（等 | 否 |  |  | 野芳 | |",
    "chunk_order_index": 1,
    "full_doc_id": "doc-37b4b5bdfaecdc60c0ff5cc6da6bb34b"
  },
  "chunk-e84c15e35500a168c5558b933dbcfa2c": {
    "tokens": 1200,
    "content": "## 一、故障简述\n故障简述：于9月18日16:57分 ICBU问鼎广告展示总量开始下跌，于17:08总量最近10分钟与基线同比下跌大于等于40%，触达到P4故障，根因为算法侧对广告归一化query逻辑干预做变更，分支未合并最新master代码，代码发布线上造成影响，变更回滚后于17:13故障恢复\n\n## 二、故障过程回顾\n### 【故障处理时间线】\n| 时间点 | 算法 | 广告 |\n| --- | --- | --- |\n| 2024-09-18 16:05 | QP归一化逻辑干预发布。灰度全量发布完成 【故障引入】 | |\n| 2024-09-18 16:52 | 监控发现广告（效果广告）主搜cov下跌【故障发现1】 | |\n| 2024-09-18 16:52 | 首先检查实验稳定性，看到相关性一二阶段联合实验其中一个实验桶下跌明显，及时停止实验切流止损。【业务响应1】 | |\n| 2024-09-18 16:59 | 继续定位cov下跌时间点和qp变更时间点match，怀疑线上qp变更导致，开始回滚qp变更 （有多个集群，回滚时间10min+） 【恢复执行】 | |\n| 2024-09-18 17:02 |  | 问鼎广告展示总量最近3分钟求和与上周同比下跌: 77.31% > 40%，触发监控报警，同时 筱吾 接手风险响应处理【故障发现2】【业务响应2】![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/128756344/1726827893645-cc73ad51-7c94-495d-a517-916d650b73ab.png) |\n| 2024-09-18 17:08 |  | 最近10分钟与基线同比下跌大于等于40%，触达P4 【故障发生】![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/128756344/1726829193267-65c4cd77-c97e-46b3-8c13-58d02fb63675.png?x-oss-process=image%2Fformat%2Cwebp%2Fresize%2Cw_440%2Climit_0) |\n| 2024-09-18 17:10 |  | 定位为算法相关性变更导致 |\n| 2024-09-18 17:13 | 回滚后线上cov和消耗恢复正常 | 监控恢复正常水位，故障恢复【故障恢复】 |\n| 2024-09-18 19:00 | 为了减少当天消耗的大盘损失，恢复相关性实验桶切流 |  |\n\n\n## 三、影响产品线及影响面\n+ 品牌广告影响：\n\n问鼎广告展示总量下跌，下跌时间：16:57-17:13，持续约15min（只影响补流）\n\n累计一天app和pc端，曝光总量相比基线+21万。\n\n![问鼎广告展现总量影响](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/193892/1726678000577-0524bbb5-0133-471d-af8f-6ea3b87a8343.png)\n\n![问鼎广告天维度曝光总量情况](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/193892/1726717920132-98f05490-9fa4-4cef-bca7-7dd22efd2b3d.png)\n\n\n\n+ 效果广告营收影响：（无实际影响）\n\n周同比 rpm +9.02%，日环比rpm+8.75%，一天大盘rpm转化缺口一整天已追平甚至超过日环比和周同比。\n\n![效果广告消耗影响](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/193892/1726677818748-64f4af48-c72e-4035-bbea-b064240e1bcd.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/193892/1726714592760-7457fe58-e34f-4668-aa9e-40c8a8a7c084.png)\t![效果广告一天整体营收情况](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/193892/1726714723265-79813fc1-337c-4bad-bc02-884f808a3df0.png)\t\t  \n\t\n\n+ 理论资损金额，实际资损金额：无\n\n###### 关联tr的goc监控\n       ![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/128756344/1727063584193-f2786863-4af1-4497-b58c-cd35159dd24c.png)\n\n       ![](https://intranetproxy.alipay.com/skylark/lark/0/",
    "chunk_order_index": 0,
    "full_doc_id": "doc-f684d1cab2648d4c76052612d9ffa953"
  },
  "chunk-63fef2bf30b62528929423f2393f673d": {
    "tokens": 1200,
    "content": "+ 理论资损金额，实际资损金额：无\n\n###### 关联tr的goc监控\n       ![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/128756344/1727063584193-f2786863-4af1-4497-b58c-cd35159dd24c.png)\n\n       ![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/128756344/1727063788857-be23c14e-329a-4209-ae63-5c592d01f377.png)\n\n## 四、故障原因\n### 4.1【背景说明】\n工单投诉部分query因归一化一致，导致无法正常干预屏蔽词，需要对归一化词典进行发包干预，涉及广告QP模块变更。（[示例工单](https://tickets.alibaba-inc.com/goc-ticket/ticket/2022102800006903848?page=1&spm=a1zb9.8233112.0.0.5b2e3a88CNNdLT)）\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/128756344/1727074245324-c9e6a2a7-7f82-4bc2-8d82-942eb1b621a9.png)\n\n### 4.2【一句话原因】\n广告归一化query逻辑干预，变更分支未合并最新master代码，Aone代码CR和测试未发现异常，问题代码发布线上造成影响\n\n### 4.3【根因分析】\n1、开发同学的开发流程不规范\n\n2、变更QP归一化干预逻辑词典，在历史已有干预归一化的分支上进行新的干预变更，没有merge最新master代码。（QP无自动化merge master的变更发布流水线，需要人工check）  \n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/193892/1726678943199-e6a19128-3b25-40c8-be1e-2a457b06dd6c.png)\n\n3、提交代码CR，Aone代码CR没有与最新master代码比较diff，而是与主干分支比较，导致diff遗漏，代码审核通过。干预逻辑也通过单点逻辑测试。CR和单元测试没有检测出该类问题。  \n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/193892/1726679366277-13f53fd6-9cff-4e40-a633-e51d2e2fa5d4.png)\n\n4、QP代码灰度生效后，没有及时观测品牌广告动向，只观测了效果广告，低估变更代码的diff影响。\n\n\n\n### 4.4【深挖根因的关键提问】\n#### 变更前：\n【**关注点1**】**前期风险评估**\n\n:::tips\n**分析：**干预逻辑依赖线上代码变更与发布，干预风险增加，方法不够安全\n\n**改进：**对归一化干预逻辑从代码发布改为读表干预逻辑 - 暂时的想法\n\n:::\n\n\n\n**【关注点2**】**QP未实现自动化发布流水线**\n\n:::tips\n**分析：**与其他模块发布流水线不同，QP无法自动化merge master，QP发布只能依赖个人良好的开发习惯与人工check保障。\n\n**改进：**\n\n长期：如可以升级自动化发布流水线可以提高发布安全性。如果无法升级则更要依赖于变更同学的代码规范和安全意识    @雪花  带回确定时间  （风险高，优先级上升）\n\n短期：算法内部变更规范文档，并内部宣导   @雪花  已完成\n\n:::\n\n\n\n**【关注点3**】**CR过程**\n\n:::tips\n**分析：**\n\n**CodeReview（**[**用户手册**](https://aliyuque.antfin.com/alicode/docs/rvqmhfypfp4g7h23)**）：**代码CR没有显示主干分支与最新master之间的diff，只显示与主干分支的diff，代码评审人与开发者忽略了代码真实的diff范围，需要人工保障。**  \n**![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/193892/1726679842205-a9f05634-3321-4861-9995-27839209fdc1.png)\n\n**改进：**\n\n暂无，合理逻辑\n\n:::\n\n\n\n**【关注点4】测试过程**\n\n:::tips\n**分析：**开发自测，验证干预功能正常。也未评估到会影响品牌广告，所以测试也未测到\n\n**改进：**效果和品牌相互影响\n\n短期：自测注意事项增加，对应变更都要回归品牌和效果广告 ，包括发布中的监控观测     @雪花  （同关注点2）\n\n长期：品牌和效果广告解藕，需要拉齐业务   @博舟\n\n:::\n\n\n\n#### 变更中：\n**【关注点5】变更未有及时观察大盘消耗曲线的风险意识**\n\n:::tips\n**分析：**再小的变更也是",
    "chunk_order_index": 1,
    "full_doc_id": "doc-f684d1cab2648d4c76052612d9ffa953"
  },
  "chunk-ddeb9b8ab87b5d8b1ebb594af84ef4ba": {
    "tokens": 1200,
    "content": "短期：自测注意事项增加，对应变更都要回归品牌和效果广告 ，包括发布中的监控观测     @雪花  （同关注点2）\n\n长期：品牌和效果广告解藕，需要拉齐业务   @博舟\n\n:::\n\n\n\n#### 变更中：\n**【关注点5】变更未有及时观察大盘消耗曲线的风险意识**\n\n:::tips\n**分析：**再小的变更也是变更，不能因为变更小而低估对大盘的影响判断。\n\n**改进：**（同关注点2）\n\n:::\n\n****\n\n**【关注点6】缺乏对品牌广告的影响预警**：\n\n:::tips\n**分析：**效果广告和品牌广告有很多公共在线模块，效果广告也需增加对问鼎和顶展的监控报警\n\n**改进：**（同关注点2）\n\n:::\n\n\n\n#### 变更后：\n**【关注点7】QP的回滚是否有优化空间**\n\n:::tips\n分析：多个集群，之前评估建立双机房的成本更高\n\n会中意见：可能针对此次影响来讲成本更高，后续有很大的风险\n\n改进：快恢建设   [@雪花](undefined/xuehua.sx)   9.24 给结论\n\n:::\n\n\n\n\n\n##  五、故障关注点\n### 5.1【系统质量】\n#### 5.1.1 需求&设计评估\n**〖关注点1〗****是否涉及产品、技术方案评估？此核心的问题是什么，如何改进？**\n\n- [x] 否，不涉及\n\n**〖问题总结〗**干预逻辑依赖线上代码变更与发布，干预风险增加，干预方法不够安全\n\n**〖改进点〗**对归一化干预逻辑从代码发布改为读表干预逻辑\n\n#### 5.1.2  代码质量\n**〖关注点1〗是否代码自身存在漏洞或BUG、代码健壮性是否存在问题等?**\n\n**〖问题分析〗**否\n\n**〖改进点〗**没有merge master代码，如可升级自动化发布流水线可以提高发布安全性。如果无法升级则更要依赖于变更同学的代码规范和安全意识。\n\n****\n\n**〖关注点2〗****是否经过CodeReview？CodeReview阶段是否发现问题？为何没发现？**\n\n+ **是否经过CR**\n    - [x] 是\n+ **是否设置合理的CR卡点**\n    - [x] 不涉及\n    - [CR卡点设置要求](https://ata.alibaba-inc.com/articles/225396?spm=ata.25287382.0.0.5e0c7536X43l05)\n+ **CR人员：**林梵\n+ **附代码提交or代码合并的Aone链接或者代码库，CR的审核过程截图：**[**https://code.alibaba-inc.com/b2b_qp/sc_qp/codereview/18411154?file=cfc3548e4ee404eeda9c4678b17932ac089c6be6**](https://code.alibaba-inc.com/b2b_qp/sc_qp/codereview/18411154?file=cfc3548e4ee404eeda9c4678b17932ac089c6be6)\n+ **CodeReview阶段是否发现问题？为何没发现？后续如何发现？**\n    - [x] 否\n\n**〖问题分析〗**CodeReview未完全展现变更Diff\n\n**〖改进点〗**提高代码CR工具的可用性，加强代码CR评审同学的谨慎性。\n\n#### 5.1.3 变更质量\n+ **是否涉及变更：**\n    - [x] 是\n+ **变更类型：**\n    - [x] 代码发布\n+ **变更平台是否接入ChangeFree：**\n    - [x] 是，CF变更单链接：________\n+ **变更内容：**\n    - 变更执行人: ___雪花______\n    - 变更系统：__广告QP______\n    - 变更对象：__广告QP归一化词典配置______\n\n**〖关注点1〗****自测阶段(研发人员)**\n\n+ **自测内容：**包含改动涉及的自测case\n+ **验证人员：**雪花\n+ **是否经过单元测试：**\n    - [x] 是\n+ **是否经过功能验证**\n    - [x] 是，测试环境\n        - [x] 预发环境\n    - [x] 是，测试方法\n        - [x] 单元测试\n        - [x] 功能测试\n+ **自测未发现原因是什么？后续如何改进？**\n        - [x] 异常场景评估/测试遗漏\n\n**〖问题总结〗见关注点4**\n\n\n\n**〖关注点3〗****灰度阶段(研发人员)**\n\n+ **是否经过灰度：**\n    - [x] 是\n+ **灰度时长**：41\n+ **灰度对象**：\n+ **观测了哪些监控**：__\n    - [x] 其他：__[https://xflush.alibaba-inc.com/custom/6/product/preview/dashboard/45464](https://xflush.alibaba-inc.com/custom/6/product/preview/dashboard/45464)_________\n+",
    "chunk_order_index": 2,
    "full_doc_id": "doc-f684d1cab2648d4c76052612d9ffa953"
  },
  "chunk-cc6145470353b6b12c9d10355c0f23ef": {
    "tokens": 1200,
    "content": "****灰度阶段(研发人员)**\n\n+ **是否经过灰度：**\n    - [x] 是\n+ **灰度时长**：41\n+ **灰度对象**：\n+ **观测了哪些监控**：__\n    - [x] 其他：__[https://xflush.alibaba-inc.com/custom/6/product/preview/dashboard/45464](https://xflush.alibaba-inc.com/custom/6/product/preview/dashboard/45464)_________\n+ **监控异常list**：_灰度期间无异常_\n+ **是否灰度期间发现问题？后续如何灰度发现？**\n    - [x] 否\n+ **未灰度发现原因**\n    - [x] 灰度无法发现\n\n**〖问题总结〗本域内无法发现**\n\n****\n\n**〖关注点4〗****上线阶段(研发人员)**\n\n+ **是否分批发布**\n    - [x] 是\n        * 分批数量：2\n        * 前两批间隔时长：40 mins\n+ **是否有确定的监控观测指标**\n    - [x] 是\n        * 监控指标及监控链接：[https://xflush.alibaba-inc.com/custom/6/product/preview/dashboard/45464](https://xflush.alibaba-inc.com/custom/6/product/preview/dashboard/45464)\n+ **是否在窗口期进行发布变更**\n    - [x] 是\n+ **变更是否影响上下游**\n    - [x] 是\n+ **是否提前知会上下游评估及关注变更**\n    - [x] 否\n\n**〖问题总结〗见关注点1**\n\n****\n\n**〖关注点6〗****红线检查(研发人员) -否**\n\n[变更工具产品设计及变更实施，需要满足风险防控三原则：可灰度，可监控，可回滚。]\n\n变更系统是否接入ChangeFree？ChangeFree单链接请提供？\n\n| **集团通用版变更红线V3.2****是否违反变更红线3.2** [链接](https://aliyuque.antfin.com/ngoc/tt8iek/me5hbu18bzzx3rhq?singleDoc#) | | |\n| --- | --- | --- |\n| 变更红线v3.2 | 是否违规 | 是否有待改进项 |\n| **面向变更系统/工具** | | |\n| 评估**会引发P4及以上故障**的**变更系统/工具**，需在变更场景上线/更新后的30个工作日内完成变更准入管控接入和变更信息同步能力，同时根据变更系统/工具自身特性，具备灰度发布能力，如无法具备相应能力，或无法按时效要求完成，需提前进行特殊报备，并在平台明确提示用户。对接完成前，变更系统/工具需在平台明确提示用户。 |  | |\n| 对运营或产品等非研发使用的运营变更系统/工具，**如触发P4及以上故障**，其涉及的变更场景需在故障复盘完成后30个工作日内具备变更信息同步能力，是否需具备变更准入管控能力及灰度能力可在故障复盘时由一二层组织安全生产负责人决策。对接完成前，变更系统/工具需在平台明确提示用户。 |  | |\n| 变更系统/工具灰度能力改造完成前，没在操作台明确提示操作者自行灰度的。 |  | |\n| **面向变更执行人** | | |\n| 禁止变更执行人故意绕过变更系统/工具的变更准入管控检测 |  | |\n| 禁止变更执行人故意进行未通过变更申请或报备的变更操作 |  | |\n| 禁止一切与变更方案计划内容、线上问题排查无关的生产环境变更操作 |  | |\n| 禁止一切非正常业务流程的变更 | | |\n| 禁止**未经测试验证、未经预发、未经灰度**的线上变更 |  | |\n\n\n### 5.2【处置能力】\n#### 5.2.1 故障发现&响应\n+ **是否监控发现**\n    - [x] 是\n+ **发现后是否五分钟内响应**\n    - [x] 是\n+ **若为跨域/BU的故障，监控发现方为**\n    - [x] 故障触发方\n    - [x] 受影响方\n    - [ ] 不涉及（非跨域/BU故障）\n\n**〖问题总结〗**\n\n#### 5.2.3 故障定位&恢复\n+ **故障涉及恢复方式：**\n    - [x] 代码回滚\n\n**〖改进点〗是否有更快恢复的方式？****如何优化改进？**\n\n**〖问题总结〗见关注点7**\n\n\n\n\n\n## 六 、故障Action\n#### 【action制定原则】\n> 机制流程不能超过总数的20%；\n>\n> 故障ACTION的数量建议不超过10条；\n>\n> 加强提升意识的Action建议关注即可，不要纳入Action管理；\n>\n> 短期ACTION建议于1-2周内完结，并内部验收（如缺陷修复、监控等避免故障再发的的措施需列",
    "chunk_order_index": 3,
    "full_doc_id": "doc-f684d1cab2648d4c76052612d9ffa953"
  },
  "chunk-0dfc23ef2f12af742582c059876fa1d9": {
    "tokens": 1200,
    "content": "7**\n\n\n\n\n\n## 六 、故障Action\n#### 【action制定原则】\n> 机制流程不能超过总数的20%；\n>\n> 故障ACTION的数量建议不超过10条；\n>\n> 加强提升意识的Action建议关注即可，不要纳入Action管理；\n>\n> 短期ACTION建议于1-2周内完结，并内部验收（如缺陷修复、监控等避免故障再发的的措施需列为短期action）；\n>\n> 产生严重影响的问题/重复发生的问题/应急成本较高的ACTION需至少有1个keyAction（治本Action，从根源上避免类似问题再发生/控制爆炸半径）；\n>\n> ACTION描述须完整、语言简洁，让ACTION指派人一目了然。\n>\n\n| **序号** | **ACTION** | **是否keyAction** | **计划完成时间** | **验收标准** | **Action负责人** | **Action验收人** |\n| --- | --- | --- | --- | --- | --- | :---: |\n| 1 | 算法内部变更规范文档，并内部宣导 （包括QP发布规范、自测注意事项增加、发布中的监控观测等） | 否 |  已完成 | [效果广告算法团队红线](https://aliyuque.antfin.com/ywg18h/sopw5f/wefshbecwbh22ziv) | 雪花  | |\n| 2 | 升级自动化发布流水线可以提高发布安全性 | 是 | 暂定11.1 |  | 雪花 带回和工程同学沟通 | |\n| 3 | 快恢方案（单机房切流、建立双机房等） | | 9.24给结论单机房切流快恢：当前引擎已经实现了这个能力，在灰度阶段可以实现单机房切流，全量后没有办法 |  | 雪花  | |\n| 4 | 长期：品牌广告和效果广告解藕，需要拉齐业务讨论方案 | |  |  | 博舟 | |\n\n\n## 七、故障定级&定责&故障分自查\n【故障等级】暂定P4\n\n【故障责任方】无需定责   \t__\n\n【故障分】_/* 以系统计算结果为准*/_\n\n| **  系统质量（30%）** | | | | | **处置能力（70%）** |\n| :---: | --- | --- | --- | --- | --- |\n| **相关方** | **需求设计** | **代码质量** | **变更质量** | **自定义项** | **发生时间** | **发现时间（30%）** | **恢复时间（40%）** |\n| ICBU技术部-智能技术-应用算法-效果广告 | 否 | 否 | 是 |  | 2024-09-18 17:08 | 2024-09-18 16:52 | 2024-09-18 17:13 |\n| ICBU技术部-数字营销技术部-营销创意 | 不涉及 | 不涉及 | 不涉及 |  | 2024-09-18 17:08 | 2024-09-18 17:02 | 不涉及 |\n|  |  |  |  |  |  |  |  |\n\n\n资损故障：\n\n| **  系统质量（60%）** | | | | | **处置能力（40%）** |\n| :---: | --- | --- | --- | --- | --- |\n| **相关方** | **需求设计** | **代码质量** | **变更质量** | **自定义项** | **发生时间** | **是否监控发现20%** | **恢复时间20%** |\n| A团队 |  |  |  |  |  |  |  |\n| B团队 |  |  |  |  |  |  |  |\n| C团队 |  |  |  |  |  |  |  |\n\n\n_/* 填写说明：*/_\n\n> 故障涉及相关方都需填写，相关方包括【**触发方、根因方、导致故障影响扩大方、受影响方**】\n>\n> 参考安全生产度量规范：[https://aliyuque.antfin.com/ngoc/fzg6dy/wf9gze](https://aliyuque.antfin.com/ngoc/fzg6dy/wf9gze)\n>\n> **系统质量：**\n>\n> + 需求&设计：是否存在系统架构设计、产品设计缺陷等设计方面问题，填 是或否或不涉及\n> + 代码质量：是否自身或引入第三方组件，存在代码BUG、漏洞等。填 是或否或不涉及\n> + 变更质量 ：配置及运维类变更，是否存在方案设计、灰度执行方面问题；提供的工具不满足红线要求方面问题。填 是或否或不涉及\n> + 自定义项：可不填写，根据复盘时讨论点实际确定\n>\n> **处置能力：**\n>\n> + 发生时间、发现时间、恢复时间需填写各方的时间\n> + 填具体时间或不涉及，若非监控发现，则勾选未发现\n> + 发现或恢复能力如不涉及，需描述具体理由\n> + 发现能力：受影响方缺少有效的系统",
    "chunk_order_index": 4,
    "full_doc_id": "doc-f684d1cab2648d4c76052612d9ffa953"
  },
  "chunk-2ac71832c5b3ef6f4a7e1ae814382e94": {
    "tokens": 864,
    "content": "不涉及\n> + 自定义项：可不填写，根据复盘时讨论点实际确定\n>\n> **处置能力：**\n>\n> + 发生时间、发现时间、恢复时间需填写各方的时间\n> + 填具体时间或不涉及，若非监控发现，则勾选未发现\n> + 发现或恢复能力如不涉及，需描述具体理由\n> + 发现能力：受影响方缺少有效的系统监控手段，未发现业务异常等问题；变更执行方或触发方，对变更没有进行有效的观测，发现能力不足等问题\n> + 恢复能力：受影响方缺少容灾能力，响应速度慢等问题；处置方预案不足，响应速度慢等问题\n>\n\n\n\n## 十、附录\n### 附1：故障打标规范\n参考：[https://aliyuque.antfin.com/ngoc/cltlwa/gw086g](https://aliyuque.antfin.com/ngoc/cltlwa/gw086g)\n\n#### 时间线打标规范\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/7773/1688969397509-2c9d7ddd-d346-4f1f-a73d-490bfab8acef.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/7773/1688969407141-945368c1-0780-4c63-8821-795ab3b5e1b3.png)\n\n\n\n### 附2：故障机制参考\n#### 故障相关方定义\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/7773/1688969946769-8bd28bca-7352-44d1-8b01-c73db5a2d281.png)\n\n[https://aliyuque.antfin.com/ngoc/fzg6dy/laf0oz](https://aliyuque.antfin.com/ngoc/fzg6dy/laf0oz)\n\n\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/2763/1656924636921-077e71cc-a8d1-40a0-8d7d-dc0e9ead77ba.png)\n\n#### 高可用故障分测算\n**横轴表示故障从发生时间开始-恢复时间的整个时长（分钟）：**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/2763/1656924726389-a00fb430-c3bc-44cf-a2aa-cf94aa97d8d4.png)\n\n备注：实际故障分以系统计算结果为准。\n\n\n\n**高可用故障分计算系数：**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/2763/1656924851376-9d274389-90ce-47e1-a3b7-1ed29818f417.png)\n\n#### 资损故障定级\n参考：[https://aliyuque.antfin.com/ngoc/fzg6dy/hikl2ibbk8934lax](https://aliyuque.antfin.com/ngoc/fzg6dy/hikl2ibbk8934lax)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/7773/1688970048219-78b29218-2ff2-499b-8f9d-70d50392106e.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/7773/1688970064707-8e0efecd-f516-4bd0-83ed-78a49f9d8316.png)\n\n#### 资损故障分测算",
    "chunk_order_index": 5,
    "full_doc_id": "doc-f684d1cab2648d4c76052612d9ffa953"
  },
  "chunk-e5bdafb0b2738a115f9fee74cc3b0bce": {
    "tokens": 1200,
    "content": "## 一、故障简述\n**故障简述：**于9月9日09:47开始，批量用户反馈无法发送消息给客服，根因确认为icbu账号体系断流，引入新的会员体系查询接口，跨单元调用整体耗时升高，任务堆积导致部分消息发送失败。于10:12分开始操作机器扩容，10:20分故障恢复，期间客诉量30+，触达P4\n\n## 二、故障过程回顾\n### 【故障处理时间线】\n2024-09-05 17:48，@柳塘（国际中台-客户体验部）开始发布 ICBU UIC断流改造，引入新的会员体系查询接口[发布单](https://ione.alibaba-inc.com/ec/app/78793/deploy/order?id=110934319&envId=4347809)\n\n2024-09-06 10:50，发布完成【故障引入】\n\n2024-09-09 9:47，ICBU侧 批量商家反馈无法发送消息给客服【故障发现】\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/128756344/1725849538508-9c5cdfe7-5ccc-495d-b542-837749877ebd.png)\n\n2024-09-09 09:50，@韦振（ICBU技术） 群里响应排查【业务响应】\n\n2024-09-09 09:59，联系@树丰（国际中台-客户体验部）继续排查，同时goc拉起应急会议\n\n2024-09-09 10:08，客诉触达20+，触发P4故障【故障发生】\n\n2024-09-09 10:09，初步定位张北机房cpu利用率飙高\n\n2024-09-09 10:12，@树丰 开始机器扩容【恢复执行】\n\n2024-09-09 10:20，故障恢复【故障恢复】\n\n2024-09-12 10:00，@柳塘（国际中台-客户体验部）定位详细根因【故障定位】\n\n\n## 三、影响产品线及影响面\n    - [x] 是否有客诉量：34例\n\n## 四、故障原因\n### 4.1【一句话原因】\nicbu账号体系断流，引入新的会员体系查询接口，跨单元调用新加坡机房导致整体耗时升高，任务堆积导致部分消息发送失败\n\n### 4.2【背景说明】\n##### 【变更背景】\n:::tips\nICBU UIC断流改造 - me-account-lazada [需求链接](https://ione.alibaba-inc.com/v2/project/2034184/req#viewIdentifier=12a91b1dfcace5cd98ca60ba&openWorkitemIdentifier=56784546)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/15256763/1726133680070-59e9d75f-b02f-460c-bbd4-139458cf1cb6.png)\n\n\n\n:::\n\n##### 【业务链路】\n![画板](https://intranetproxy.alipay.com/skylark/lark/0/2024/jpeg/15256763/1726130606689-6ffca9f0-283b-407c-ad93-9dcc37d33019.jpeg)\n\n### 4.3【根因分析】\n###### 根因分析：\n:::tips\n+ 用户进线过程中建连和发送消息均会请求到account账号体系中，**从AIDC张北环境跨单元调用到新加坡的环境的机器**，耗时明显升高。\n+ 主要在IM侧建连以及处理ChannelHandler的过程中耗时升高太多，导致线程处理不过来，阻塞了IM的IO线程，致使部分消息发送失败。扩容后因为请求分散了，消息总体等待时间减少\n+ 跨单元调用是新需求引入，新查询体系只在 国内中心、新加坡、美东\n\n:::\n\n \n\n###### 最终解法：\n:::tips\nICBU业务在aidc-zb环境，故障发生原因是因为跨单元请求了新加坡环境的机器，耗时较长，现改到跨单元请求中心机房的数据，单次请求耗时整体下降到10ms左右。\n\n###### ![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/15256763/1726133955008-71165cee-21e6-4177-9219-543114c0ab3d.png)\n:::\n\n\n\n###### 上行消息的耗时\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/15256763/1726045846295-fc26e6f5-6a01-46e8-bf14-c8d62f8a8346.png?x-oss-process=image%2Fformat%2Cwebp%2Fresize%2Cw_1500%2Climit_0)\n\n###### 建连的耗时\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/15256763/1726127103833-e016eb08-0c46-4b2d-8dcb-e7241c3e",
    "chunk_order_index": 0,
    "full_doc_id": "doc-b08eadfcf914849587caacbfc8a44891"
  },
  "chunk-13fc12a85633dd7c91a7b5ffdcdc8d2d": {
    "tokens": 752,
    "content": "f8a8346.png?x-oss-process=image%2Fformat%2Cwebp%2Fresize%2Cw_1500%2Climit_0)\n\n###### 建连的耗时\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/15256763/1726127103833-e016eb08-0c46-4b2d-8dcb-e7241c3e6232.png)\n\n###### 请求account的耗时\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/15256763/1726127800623-7aba7ece-40b2-450f-8fa5-db2061bcc2b3.png)\n\n###### 一次上行消息的请求链路\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/15256763/1726130206943-ae16600b-b7a9-4872-8d4d-136d5f5507dd.png)\n\n:::tips\n上行消息整体耗时在400ms左右，首先异步调用代理层proxy发送消息，之后IM侧主动查询一次account，最后再调用一次proxy，这次调用中proxy也会查询account，整个过程中会调用两次account应用，每次调用耗时都在180ms上下\n\n:::\n\n\n\n![画板](https://intranetproxy.alipay.com/skylark/lark/0/2024/jpeg/15256763/1726130606689-6ffca9f0-283b-407c-ad93-9dcc37d33019.jpeg)\n\n\n\n### 4.4【核心关注点】\n【关注点1】能否监控提前发现？避免客诉上报（国际中台-客户体验&ICBU）\n\n:::tips\n-----中台----\n\n分析：之前有前端报错的监控，但是量级较小\n\n缺乏对IM整体耗时的报警机制（包含成功率和成功量）\n\n改进：增加监控  核心指标已完成 @柳塘 \n\n国际中台关于此监控相关的预警群拉下icbu侧的同学-良猛、重放、韦振\n\n-----ICBU----\n\n分析：icbu侧感知不到，无法做监控\n\n改进：暂无\n\n:::\n\n\n\n【关注点2】灰度过程是怎样的？为什么灰度没发现（国际中台-客户体验）\n\n:::tips\n分两批灰度，且分两天发布完成，存在早高峰的流量，但灰度期间业务都是正常，所以未发现\n\n改进：暂无\n\n:::\n\n\n\n【关注点3】测试预发为何未发现问题？（国际中台-客户体验）\n\n:::tips\n测试验证功能正常，依赖线上流量大小，测试不一定能发现\n\n改进：是否提前进行压测 带回评估 @柳塘  9.20 --评估不需要，核心action为耗时监控\n\n:::\n\n\n\n## 五、故障Action\n| **序号** | **ACTION** | **是否keyAction** | **计划完成时间** | **验收标准** | **Action负责人** | **Action验收人** |\n| --- | --- | --- | --- | --- | --- | :---: |\n| 1 | 短期：IM整体耗时的报警机制 | 是 | 已完成 |  | 柳塘 | |",
    "chunk_order_index": 1,
    "full_doc_id": "doc-b08eadfcf914849587caacbfc8a44891"
  },
  "chunk-a9368a7825806cfb3e391bae8ad5dcbc": {
    "tokens": 1200,
    "content": "## 一、故障简述\n**故障简述：**于9月9日16:07收到批量反馈 商家后台/违规中心违规不显示产品ID，故障原因初步确认为处罚中心发布升级mtee动作，代码中存在BUG导致，通过代码回滚于17:18故障止血，于19:28存量数据处理完成，影响消除。\n\n## 二、故障过程回顾\n### 【故障处理时间线】\n2024-09-09 09:37，开始发布，升级mtee动作 [发布单](https://jiugong.crowork.alibaba-inc.com/jiugong/?spm=osapp.b0138491-91c1-4669-af3d-af11415db9bf.0.0.13a45d4dOKoA2K#/osapp/appmanage/mergePubApp/PublishInfo/jiugong-plugin-action/2086460/de09d561-adbe-4f12-a394-d15fc0b60ddc?clusterName=decision_prod&currentNode=4cae35b3-2648-429e-a4d2-6765a3cc0285&activeGroupKey=all) 【故障引入】\n\n2024-09-09 16:11， 发布完成\n\n2024-09-09 16:12，批量商家反馈商家后台/违规中心 违规不显示产品ID 【故障发现】\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/128756344/1726112975559-d10c3fe6-df5e-42fd-80bf-9ef7126d2eee.png)\n\n2024-09-09 16:15，君与、时白接手风险响应，并联系国利（国际中台-风险管理）排查 【业务响应】\n\n2024-09-09 16:37，客诉上升到5例，触发P5故障【故障发生】\n\n2024-09-09 16:25，夏雷（集团处罚中心）确认问题为动作变更导致，开始回滚应用（分6批）【初因定位】【恢复执行】\n2024-09-09 17:18，回滚完成，故障止血，开始捞取线上影响数据【故障恢复】\n2024-09-09 17:53，确定受影响数据量\n2024-09-09 18:06，确认解决方案（一部分处罚撤销并补下，另一部分订正商品id，重新执行处置点）\n2024-09-09 19:28，受影响数据全部处理完成【影响消除】\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/128756344/1726122369912-023db221-8dd9-4fa1-bfdd-daa920350d61.png)\n\n\n\n## 三、故障原因 \n### 3.1【一句话原因】\n发布升级mtee动作，代码存在BUG，无法把商品信息传到处罚\n\n### 3.2【背景说明】\n【需求背景】集团安全处罚中心-业务需求池\n\n:::tips\nICBU在MTEE中使用【处罚商品SC】动作，指定计次对象，下游处罚未生效（未按指定计次对象进行计次），排查后，发现【处罚商品SC】该动作代码部分逻辑缺失，AIDC无权限修改。提交需求到处罚中心 [链接](https://aone.alibaba-inc.com/v2/project/2058517/req/58627223)\n\n需求：将动作里面指定的计次对象，传递给处罚中心，让处罚中心以指定计次对象进行计次\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/128756344/1726113243947-4bcab0bb-6f3b-4de2-b905-1c2eef1e81e6.png)\n\n\n\n:::\n\n\n动作修改权限问题：\n\n:::tips\n影响面评估后再确认修改方 （集团处罚中心&国际化中台-风险管理）\n\n+ 若只影响aidc，可将权限开放到国际化中台修改\n+ 若还影响国内，集团处罚中心修改\n\n:::\n\n\n\n【变更背景】\n\n:::tips\n【后端开发】任务：MTEE-动作-处罚商品SC\n\n[https://cd.aone.alibaba-inc.com/unite/micro/cr/app/236843/26494661?_app_id_=236843](https://cd.aone.alibaba-inc.com/unite/micro/cr/app/236843/26494661?_app_id_=236843)\n\n:::\n\n\n\n### 3.3【根因分析】\n【代码】左边为原来代码传itemid（商品id），变更将itemid改成meteringObjiect（计次对象），引发故障\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/2434/1726107255820-5dccc6f4-81ca-4186-8657-124983096ace.png)\n\n\n\n### 3.4【核心关注点】\n**【关注点1】**处置点执行的监控\n\n:::tips\n通用监控无法监控到该场景，不同的处置点有不同的逻辑\n\n改进：适用群体下 处置点+案例code 维度的监控告",
    "chunk_order_index": 0,
    "full_doc_id": "doc-6306e16ae3af642a338623cbfe5522ae"
  },
  "chunk-f5f374aa5387827aa99a10772c17df1d": {
    "tokens": 594,
    "content": "6107255820-5dccc6f4-81ca-4186-8657-124983096ace.png)\n\n\n\n### 3.4【核心关注点】\n**【关注点1】**处置点执行的监控\n\n:::tips\n通用监控无法监控到该场景，不同的处置点有不同的逻辑\n\n改进：适用群体下 处置点+案例code 维度的监控告警  @夏雷  10.31\n\n:::\n\n****\n\n**【关注点2】集团风控系统、国际中台能否针对ICBU单独拉出来告警项，完善线上预警能力？（包括实时的预警，并且通知到ICBU风控团队，这样可以做到根据告警发现和解决问题，而不是客诉上报）**\n\n:::tips\n集团风控系统：基于关注点1 完成后再将icbu单独拆分 @夏雷 \n\n国际中台-风险管理：暂无\n\n:::\n\n\n\n**【关注点3】流程规范**\n\n+ **预发测试过程是怎样的？为什么没有发现问题？**\n\n:::tips\n开发自测+业务验证，只验证了新的场景（计次对象是否可以传处罚中心）没有回归历史场景\n\n改进：动作用例回归用例集  （集团安全&国际中台交接过程再做具体讨论）\n\n:::\n\n+ 灰度过程是怎样的，为什么没有发现\n\n:::tips\n没有商品id和有商品id都属于正常业务逻辑，灰度不一定可以发现\n\n改进：见关注点1\n\n:::\n\n****\n\n**【关注点4】恢复时间长，是否有更快的恢复方式？如何改进？**\n\n:::tips\n恢复改进：决策机器的优化 （集团处罚中心）\n\n兜底的展示文案\n\n:::\n\n****\n\n**【关注点5】ICBU内部是否可增加一道拦截转换，风控信息不直接透给客户？**\n\n:::tips\n无法增加，执行系统不经过ICBU\n\n:::\n\n## 五、故障Action\n| **序号** | **ACTION** | **是否keyAction** | **计划完成时间** | **验收标准** | **Action负责人** | **Action验收人** |\n| --- | --- | --- | --- | --- | --- | :---: |\n| 1 | 短期：适用群体下 处置点+案例code 维度的监控告警 |  | 10.30 |  | 夏雷 | |\n| 2 | 短期：基于action 1 完成后再将icbu单独拆分  | | 10.30 |  | 夏雷 | |",
    "chunk_order_index": 1,
    "full_doc_id": "doc-6306e16ae3af642a338623cbfe5522ae"
  },
  "chunk-80860c05343001b8770d7e363edb7946": {
    "tokens": 1200,
    "content": "## 一、故障简述\n中东国家站近期发现线上有一定量的商品标题/详描被错翻成波斯语，问题定位为AIB翻译服务迁移到新的部署平台，模型文件配置错误导致，影响商品量：5185268。AIB于9.2 22:40已紧急修复翻译模型，故障止血。但目前需要AE商品侧配合回刷数据覆盖掉线上错翻的商品标题和详描信息。于9.7 01:00左右全量500多万商品已回刷操作完成，影响基本消除。\n\n## 二、故障过程回顾\n### 【故障处理时间线】\n2024-07-12 16:52，AIB模型上线；【故障引入】\n\n2024-09-02 16:20，中东国家站业务方佑夫发现问题后反馈给AIB，AIB同时开始响应；【故障发现】【业务响应】\n\n2024-09-02 19:20，AIB定位到是7月模型迁移发布导致；【故障定位】\n\n2024-09-02 22:40，整体集群发布完成；【故障止血】\n\n2024-09-03 11:00，业务拉群确认影响面，沟通订正方案，发起订正审批流程\n\n2024-09-04 14:00，剩余影响商品确认回刷方案；因评估500万商品的数据订正在一天内执行完成的风险比较高，因此决策分成2天进行回刷。\n\n2024-09-07 01:00，商品侧将全量500多万商品已基本回刷操作完成【影响消除】\n\n\n\n#### 算法工作台迁移时间线\n2024 / 6 / 18 ：  算法工作台迁移正式开启， 在此之前，翻译服务是以( hsf - tpp - rtp) 结构部署，从当天开始，对话翻译模型率先全部切换至算法工作台，并开启灰度观察；\n2024 / 6 / 19:     算法工作台对话模型灰度观察结束，商品翻译 模型启动迁移，并开始模型梳理和验证工作（从rtp迁移出来）；\n2024 / 6 / 27：   和算法工作明确：以标模型文件model.bin的 md5sum 为识模型的唯一码；并上线该功能，在每条请求后附带该标识码；\n2024 / 7 / 3:       商品翻译全部历史服务语项梳理完毕，其中就包括本次事故涉及语项：en2ar； 模型验证通过， en2ar 模型也验证正常；\n2024 / 7 / 4:       测试团队发布首版《算法模型版本变更管控机制》，在翻译团队开始试点，并于其后（7.23日进行了培训）；\n\n                                                   (以上为算法工作台迁移的节奏)\n                  --------------------------------------------------------------\n\n#### 模型上线时间线\n                                                （以下是涉及en2arurbn 的上线节奏）\n涉及故障的模型如下：\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/122456409/1725431110996-66b771a3-4ef4-4175-bdca-14cc9130fe59.png)\n\n2024 / 7 / 11:      算法有多个需求上线，上线内容包括：\n1）10个chat 已达上线标准的语向(en-esfrptitukruarhebn) 进行上线；\n2）query模型新增和优化语向（query_enzh2ja/query_zhjako2en）；\n\n**3）**title 模型(title_tr2csroelhu / title_en2arurbn) ，其中title_en2arurbn变更背景是为了**减少线上模型数量**的需求，**将线上原本en2ar和en2urbn两个模型合并到一个模型en2arurbn。**\n\n2024 / 7 / 12:      各算法同学将各自模型统一上传至算法工作台后， 并通知工程侧发布至预发环境；并开始进行在预发环境的验证；但当时验证的机制，还没有建立起全量回归跑 case的机制，且当时测试环境全量case验证仍存在不一致情况， 因此只能通过零散的 case 来验证模型本身的准确性，同时由于ar和ur高度相似，当时人工并未检测出en2ar翻译异常； \n2024 / 7 / 13 - 2024 / 8 / 5:\t在将近一个月期间虽然title_en2arurbn模型在线，但en2ar语向几乎没有调用量，统计报表显示期间仅16次调用；补充：在此期间AIB算法同学提供了离线表（当时使用的是正确的模型）给到了业务方佑夫，用于AB实验，佑夫搭建了AB实验，后续由AIB业务方恺航进行主导。![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/167447/1725507388615-0bd88c28-b7cd-4eae-a599-be5692214c45.png)\n\n2024 / 8/ 6:        AE商品技术侧开始",
    "chunk_order_index": 0,
    "full_doc_id": "doc-d062756d9652fa88e531866f8d3cdc53"
  },
  "chunk-a0372b39b773d4cfe2e2918148633638": {
    "tokens": 1200,
    "content": "方佑夫，用于AB实验，佑夫搭建了AB实验，后续由AIB业务方恺航进行主导。![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/167447/1725507388615-0bd88c28-b7cd-4eae-a599-be5692214c45.png)\n\n2024 / 8/ 6:        AE商品技术侧开始做切流动作，双方均未对实际翻译效果进行校验。\n2024/  9/ 2:        下午16:20业务方反馈商品标题语种错误，算法同学开始排查。19:20故障定位到模型上传错误，拉算法工程同学摩耳、北豪开始进行回滚，22:40整体集群发布完成。\n\n\n\n## 三、影响产品线及影响面\n    - [x] 业务影响：\n        * AE商品标题、详描受影响，影响商品量：5185268；SA转化率跌10%，点击率跌3%\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/116556437/1726208774752-8bcf1c35-be17-4d5d-b8f3-b96654f097a8.png)\n\n        * AIB统计的影响面：GMV占比5%（占阿里伯国家的比例）\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/116556437/1726208456557-6a3daa0b-bce4-42a3-a329-e2a30827a3f6.png)\n\n    - [ ] 是否有客诉量：\n        * 在线，热线，排队量\n\n## 四、故障原因\n### 4.1【一句话原因】\nAIB更新en2arurbn模型时上传模型错误，导致en2ar的功能实际透出为en2ur的商品标题。商品详描问题确认是属于单个case存在问题（模型个别badcase）。\n\n### 4.2【背景说明】\n模型从原先的RTP系统迁移至算法工作台系统后，同时为了减少线上模型数量的需求，将线上原本en2ar（英语转阿拉伯语）和en2urbn（英语转波斯语）两个模型合并到一个模型en2arurbn。将原本的模型做了迭代更新。\n\n    - aib翻译模型更新的 pipline链路： \n        * 1)  非量化版本的模型结果（mos 验证的结果）--> 达标\n        * 2）模型ctranslate2 转换成int8量化版本；并生成模型md5sum；\n        * 3）模型本地调试，并跑出一份测试集的结果；简称答案集: A;\n        * 4）模型上传至算法工作台的模型仓库；\n        * 5)  工程侧将模型发布至算法工作台的预发；\n        * 6)  算法自测模型的准确性验证；\n        * 7）测试调用 hsf 的 api 接口，并利用测试集跑出一份测试集的结果，简称结果集: B;\n        * 8)  测试介入验证，并且全匹配比对答案集: A; 和 结果集: B;  若一致则模型上线\n\n### 4.3【根因分析】\n本次故障主要由2次变更带来\n变更一：出现在7.11日算法更新en2arurbn模型，但上传模型错误，导致en2ar的功能实际透出为en2ur。\n算法工作台完成了一轮第一批迁移，但当时迁移到算法工作台的模型是 en2ar，模型验证无误； 后续在7.11 日，算法新模型上线的时候，en2arurbn 被第二批上线，模型验证环境机制不完善，没有发现该类问题； \n变更二：在08.06号之后，en2ar语项业务方开始切流，但双方均未对结果进行验证。\n\n\n\n#### 模型出问题的原因\n根本原因是模型命名错误导致模型被混淆。\n\n模型合并是需要重新训练的，并且需要多组对照实验；  \n比如：目标是对 en2ar、en2ur、en2bn 这三个语项进行合并  \n那么对照试验则需要进行如下的：  \nen2ar  \nen2arur  \nen2arbn  \n**en2urbn**\n**en2arurbn**\n\n\n另外，还要针对不同语种合并在一起数据量大比例进行调整；所以针对这个实验，其实最后训练出来很多个实验模型；  \n最后从里面挑一个最好的，进行人工离线评测，当时 en2arurbn 这个组合最好，人工评测结果超过了业务方所定义的竞对；  \n  \n到了7.11 左右，模型要上线的时候，当时就决定将已有的 en2ar 替换成 en2arurbn；这样既新增了两个语项，但是模型并没有新增，节省了卡资源；  \n  \n但是算法同学在操作的时候，在一堆实验记录里面，开始进行模型转换时，模型原始路径找错了；**这主要是因为当时多组对照实验过程中，实验名字没有变更过来，把",
    "chunk_order_index": 1,
    "full_doc_id": "doc-d062756d9652fa88e531866f8d3cdc53"
  },
  "chunk-b35cb29a1302c3849e1a4d4f994ac1b5": {
    "tokens": 810,
    "content": ".11 左右，模型要上线的时候，当时就决定将已有的 en2ar 替换成 en2arurbn；这样既新增了两个语项，但是模型并没有新增，节省了卡资源；  \n  \n但是算法同学在操作的时候，在一堆实验记录里面，开始进行模型转换时，模型原始路径找错了；**这主要是因为当时多组对照实验过程中，实验名字没有变更过来，把一个 en2urbn的模型命名为了 en2arurbn 名字，最后也拿了这个模型交给工程的同学，上线到预发环境了；**\n那这个叫做 en2arurbn，但是实际是 en2urbn 的模型，输入en, 让他翻译成 ar, 他就将其输出为了和ar 最近似的 ur 语； 由此造成这个问题；\n\n\n\n#### 问题点总结\n+ **变更上线前测试不充分**\n\n 模型上线至预发环境之后，算法也进行了测试，只不过受限于当时的环境问题，做的是单点、单条case的测试，ar 和 ur 由于非常相似，由此并没有被测试出来。\n\n\n\n### 4.4【核心关注点】\n【关注点1】新模型上线前是否有做过验证？上线后是否有业务做过验收？是否有相应监控可观测？\n\n:::tips\n上传错误模型后，验证不够充分，通过肉眼观测人为疏忽，未建立有效的质量保障手段。\n\n在 0806号en2ar语项业务方开始切流，双方均未对结果进行验证。\n\n:::\n\n【关注点2】针对AB实验，AIB业务侧关注了哪些内容？是否有关注翻译的正确性？\n\n:::tips\n当时AIB算法同学提供给业务方做AB实验的是离线数据，使用的是正确的语向。\n\n:::\n\n【关注点3】8.6号业务方做了切流，切流节奏是怎样的？是否有检查线上效果？\n\n:::tips\nAE商品技术侧做的切流，切流时AE技术侧有在群中通知到AIB工程侧，但AIB算法同学不知晓。技术侧切流仅能确认是否能正常调用AIB算法模型，无法check语向的正确性。500W+商品基本上是平均分布在问题发生期间。\n\n:::\n\n【关注点4】后续新的模型如何保障正确和准确性？此类问题如何避免？\n\n:::tips\n语向正确性检测和翻译标准，变成线上巡检能力，后面实时检测\n\n:::\n\n## 六、故障Action\n| **序号** | **ACTION** | **是否keyAction** | **计划完成时间** | **验收标准** | **Action负责人** | **Action验收人** |\n| --- | --- | --- | --- | --- | --- | --- |\n| 1 | 翻译全语向case补齐，纳入自动化回归体系 | 是 | 9.30 |  | 冰心、林龙 | 行禅、伯桃 |\n| 2 | 线上切流，业务扩量后需要增加线上验证机制，确认具体SOP，包括通知方式、通知范围 | | 9.30 |  | 冰心、恺航 | 行禅 |\n| 3 | 制定算法研发流程规范，增加测试验收环节 | | 已完成 |  | 冰心 | |\n| 4 | 评估阿拉伯语向转化率纳入监控中，做前置监控，和业务梳理指标 | | 9.30 |  | 伯桃 | |",
    "chunk_order_index": 2,
    "full_doc_id": "doc-d062756d9652fa88e531866f8d3cdc53"
  },
  "chunk-af1f4098ff8a858feb68a3380da4e6e3": {
    "tokens": 1200,
    "content": "## 一、故障简述\n**故障简述：**\n\n于9.6 9:38收到商家客诉反馈商品资质中心待合规页面无数据，于10:12舆情反馈40+，触达P4故障。原因初步确认是CRO业务配置的撤销策略问题导致900W+数据被误撤销掉。问题发现后规则已及时下线，于17:33通过重新补发数据后故障恢复。\n\n****\n\n## 二、故障过程回顾\n### 【故障处理时间线】\n2024-09-06 09:38，商家客诉反馈商品资质中心待合规页面无数据【故障发现】\n\n2024-09-06 09:40，联系到国利上线排查【业务响应】\n\n2024-09-06 09:50，确认pop商品资质异常\n\n2024-09-06 10:02，初步排查到后台数据库无数据，怀疑上游运营产出数据问题对焦中\n\n2024-09-06 10:12，商家客诉达到40例，触达P4故障【故障发生】\n\n2024-09-06 10:25，确认异常预警规则id：5144336，数据需要重跑，预警消息重新补发【恢复执行】\n\n2024-09-06 10:32，pop、全托蒙层布防生效\n\n2024-09-06 11:36，修改限速前的预警持续下发中，下发量目前是60w；修改限速后的策略还在识别数据中，识别成功后才能再次下发\n\n2024-09-06 11:50，已在用新的3000限速进行下发，同时初步确认是撤销策略问题导致，目前已下线【初因定位】\n\n2024-09-06 13:00，发现回捞任务被卡住，后续确认是多个任务在同时进行导致，决策停掉老的任务\n\n2024-09-06 16:02，回捞任务已下发400W+数据\n\n2024-09-06 17:33，已全部下发完成，故障恢复【故障恢复】\n\n\n\n## 三、影响产品线及影响面\n    - [x] 是否有客诉量：\n        * 截止止血时间客诉110+\n        * 商家感知：前一天看到了待合规的商品资质，但是在商家未进行操作的情况下，第二天看不到了。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/116556437/1726661382842-ff4a4ea6-9b3f-4b2a-b379-88438b63042d.png)\n\n## 四、故障原因\n### 4.1【一句话原因】\n通过MTEE离线规则下发了900万资质预警信息，在T+1执行的的另外一个预警消除规则中被误删除了。\n\n### 4.2【背景说明】\n[@雪绵](undefined/xuemian.yw) \n\n业务背景：\n\n此前欧盟仅有一套P0-P4管控预警下发，MTEE离线规则5144336用于解除欧盟非P0-P4管控类目的资质中心预警。\n\n9月初新增欧盟GPSR管控预警，规则5144336引用DNA名单L105406依赖的ODPS表底层逻辑，仅排除掉欧盟P0-P4管控商品，但误将新管控商品范围圈入，导致错误的撤销了新管控商品的预警。\n\n### 4.3【根因分析】\n[@雪绵](undefined/xuemian.yw) \nMTEE策略逻辑：\n\n解除所有由于类目变更导致不在欧盟P0-P4管控范围内的商品的生效欧盟预警。\n\nDNA名单L105406上游ODPS表逻辑：\n\n所有下发欧盟资质预警的商品减去欧盟P0-P4管控范围内的商品。\n\n\n\n根因分析：\n\n1、DNA名单L105406的“业务联系人”、离线规则5144336的“任务执行人”均挂载在金美龄的HRO账号（WB01776233）；\n\n2、该同学转正后，HRO账号已注销，生成新账号（437900）；\n\n3、但DNA名单L105406的“业务联系人”、离线规则5144336的“任务执行人”仍然挂载在HRO账号（WB01776233）名下；\n\n4、因此金美龄的新账号（437900），无法接收到DNA名单L105406的名单数据量变化预警，也无法收到离线规则5144336的变化预警；\n\n5、另外规则大量变化会需要手动确认，本次case疑似自动确认，需排查确认。--**会后与花冻确认 禹奇 **\n\n\n\n### 4.4【核心关注点】\n【关注点1】该问题是否能通过监控告警尽早发现，而不是被动通过客诉感知？\n\n:::tips\n理论上离线名单和策略大量变化会有告警需要手动构建；离线策略规则变化有波动预警。**--具体未告警的原因会后与花冻确认 禹奇 0927**\n\n![](https://intranet",
    "chunk_order_index": 0,
    "full_doc_id": "doc-9f07ba9adb015d6606ee638daabe18ae"
  },
  "chunk-3b9c90f128567b265f74960cd2a27992": {
    "tokens": 808,
    "content": "奇 **\n\n\n\n### 4.4【核心关注点】\n【关注点1】该问题是否能通过监控告警尽早发现，而不是被动通过客诉感知？\n\n:::tips\n理论上离线名单和策略大量变化会有告警需要手动构建；离线策略规则变化有波动预警。**--具体未告警的原因会后与花冻确认 禹奇 0927**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/116556437/1727072609053-d5efd68c-79ac-4830-b71a-f4582093c074.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/116556437/1727072484555-8cfb3741-2d1d-4668-9a18-d9791d5a483a.png)\n\n:::\n\n【关注点2】后续“误将新管控商品范围圈入”此类问题如何规避？\n\n:::tips\n1、后续运营侧下发任务的量级\n\n2、CRO技术侧建设关于新增/取消资质提醒的同比监控波动对比 --mohong 10.15\n\n3、确认离线任务时间是否可以置前，最好是晚上去跑 --mohong 0927\n\n4、若波动大但无法100%拦截是否可以对离线任务进行限速，评估调研一下 --禹奇 0927\n\n:::\n\n【关注点3】离线任务的变化预警接收人是否可以设置多人？\n\n:::tips\n评估调研一下 --禹奇 0927\n\n:::\n\n\n\n## 五、常规项检查\n#### 5.1.3 变更质量\n+ **是否涉及变更：**\n    - [x] 是\n    - [ ] 否\n+ **变更类型：**\n    - [x] 其他变更：____MTEE规则离线变更____\n\n#### 5.2.1 故障发现&响应\n+ **是否监控发现**\n    - [x] 否，原因为：部分卖家的特定资质预警数据被删除了，接口成功率无异常。\n+ **发现后是否五分钟内响应**\n    - [x] 是\n\n\n\n#### 5.2.3 故障定位&恢复\n+ **故障涉及恢复方式：**\n    - [x] 其他： 通过MTEE离线规则重跑做数据恢复\n\n\n\n## 六、故障Action\n| **序号** | **ACTION** | **计划完成时间** | **Action负责人** | **Action验收人** |\n| --- | --- | --- | --- | --- |\n| 1 | 短期：规则大量变化会需要手动确认，本次case疑似自动确认。联系集团CRO花冻排查确认 | 9.27 | 禹奇 | |\n| 2 | 短期：CRO技术侧建设关于新增/取消资质提醒的同比监控波动对比 | 10.15 | mohong | 禹奇 |\n| 3 | 短期：确认离线任务时间是否可以置前 | 9.27 | mohong | |\n| 4 | 短期：若波动大但无法100%拦截是否可以对离线任务进行限速，进行评估调研 | 9.27 | 禹奇 | |\n| 5 | 短期：评估调研离线任务的变化预警接收人是否可以设置多人 | 9.27 | 禹奇 | |",
    "chunk_order_index": 1,
    "full_doc_id": "doc-9f07ba9adb015d6606ee638daabe18ae"
  },
  "chunk-a716a893a7f5b753f0405deef9777bb0": {
    "tokens": 1200,
    "content": "## 一、故障简述\n故障简述：\n\n于2024-09-02 01:44 mysql 增量同步drc延迟，影响阿里妈妈alimama.solar_feed、alimama_ods.solar_feed_ref两个分区产出，进而影响集团tbcdm.dim_tb_itm表产出。 通过执行drc追数，阿里妈妈使用全量datax同步，于2:30采用datax全量同步覆盖对应分区，于4:24完成，问题恢复。\n影响面：妈妈客户报表7级基线破线，产出延迟74分钟，及时挂公告未引起大规模客诉。\n            集团业务多条8基线预警，很多7基线破线。\n\n## 二、故障过程回顾  \n故障时间线：\n\n2024-09-02 01:44，问题反馈。承寒联系TT值班繁霜 **【故障发现】**\n\n**MYSQL增量同步的TT标done延迟**[**link**](https://tt.alibaba-inc.com/datahub/projects/proj_tt_migrate/topics/solar_jupiter_app_feed_quick/connectors)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/113456498/1725608400565-299dfaa6-582d-43f0-bfe9-3773359ad91a.png)\n\n**影响商品公共层tbcdm.dim_tb_itm**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/113456498/1725608398531-d96d79e6-b6b9-4393-a67a-9fbb68125a10.png)\n\n2024-09-02 01:48，问题响应。**【故障响应】**\n\n2024-09-02 02:20,  承寒开始启动datax全量同步的替代方案，升级相关的datax全量同步节点。\n2024-09-02 02:29，承寒启动feed_item的datax全量同步任务。\n2024-09-02 02:36，承寒修改feed_union的datax全量同步任务，由于是第一次提交，需要数据库owner审批同意，电话许乐进行审批。\n2024-09-02 02:58， feed_union表开始启动datax全量同步。 \n2024-09-02 03:18，承寒启动feed_quick的datax全量同步任务，中间运行失败2次，3:18联系DBA肖泉，判断是DB限流导致，需要将并发从16调整到10以下。\n2024-09-02 03:35，修改任务并发为9重新发布，alimama_ods.solar_all_feed，分区：feed_union表datax同步完成，线上节点置成功。\n2024-09-02 03:41，重新启动feed_quick同步任务。\n2024-09-02 03:54，alimama_ods.solar_all_feed，分区：feed_item同步完成，线上节点置成功\n2024-09-02 04:24，alimama_ods.solar_all_feed，分区：feed_quick同步完成，线上节点置成功 **【故障恢复】**\n\n+ 止血措施描述：\na、drc追数，暂无加速手段@目云(292342)\n\nb、dim_tb_itm当前评估不能解除依赖，下游影响基线3000+且分区缺失数据量较大，去除依赖会带来全局的正确性问题@剑萧(086413)\nc、阿里妈妈使用全量datax同步，大约2:30左右采用datax全量同步覆盖对应分区，于4:24完成@承寒(114749)\n\n## 三、故障原因 \n### 3.1【背景说明】\n\n\n\n\n### 3.2【原因分析】\n**关键原因概述：**@王银瓶(062575)@繁霜(285641)@目云(292342)\n\n**TT侧**\n\n1）晚上21点例行监控发现任务异常，点位卡在0点10分；\n2）登入查看日志发现0点后，连接DRC异常，到13点多DRC侧恢复，但是点位不连续；\n3）TT侧调整点位到有效时间，这个时间段已经延迟21小时，调整点位后开始追数据；\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/113456498/1725607887470-2cff6edb-994f-43ea-bae6-40fbcfb5ad18.png)\n\n**DRC侧**\n\n1）凌晨0点10分出现任务异常进行第一次容灾，前推半小时拖binlog。但是binlog数据量比较大，磁盘空间不足，拿不到对应的信息，容灾不成功。\n2）凌晨1点10分再次容灾，容灾成功，这时候DRC侧已经认为自己恢复，但是没法完成点位衔接（数据已不存在）\n\n## 四、关注点分析\n**〖关注点1〗**DRC侧在1:10认为自己已经恢复，但是位点接不上问题，有什么方法规避。或者让相关同学感知到手动处理？@目云(292342)\n\n:::tips\n**DRC侧：**\n\n这个问题的根因还是**源端binlog保存时间太短**，否则就算手",
    "chunk_order_index": 0,
    "full_doc_id": "doc-14056c5666e1c930aba6c3af1346c15d"
  },
  "chunk-03f913c9e3cb4508dc8ecf9049914d9e": {
    "tokens": 649,
    "content": "没法完成点位衔接（数据已不存在）\n\n## 四、关注点分析\n**〖关注点1〗**DRC侧在1:10认为自己已经恢复，但是位点接不上问题，有什么方法规避。或者让相关同学感知到手动处理？@目云(292342)\n\n:::tips\n**DRC侧：**\n\n这个问题的根因还是**源端binlog保存时间太短**，否则就算手动处理问题也接不上位点了，恢复不了源端binlog位点；源端保存10几分钟的binlog，那DRC就相当于不能做容灾，下游也不能有任何延迟，否则就一定出问题\ndrc容灾失败未报警，后续加容灾失败报警 ，发现时间会大大减短\n缺失能力：无法监控下游\n容灾成功但点位不连续问题：第一次容灾成功点位不会不连续，监控加第一次容灾失败可解决\n\n**〖改进点〗**\n\n1、第一次容灾失败和核心app加监控告警   ---目云  9.19\n\n2、核心app评估 ：林顿收集集团大促核心app，如需增加核心app找林顿处理  \n\n\n\n**数据库侧**：\n方案：核心数据库在大促期间需要设置时间优先的binlog保存策略，这个方案是对核心数据库的日志盘扩容后调整日志清理策略，延长本地保留日志的时间  99之后就会上线 \n\n**〖改进点〗**\n\nbinlog增加保存时间：扩容到可保存8小时以上 ---  林顿\n\n:::\n\n**〖关注点2〗**业务方（阿里妈妈侧）发现时间较晚。是否具备更快发现能力？\n\n:::tips\nTT平台提供监控延迟的方案，也建议业务方配置延迟报警，也能快速发现\n\n**〖改进点〗**\n\n梳理核心TT top作业 ，订阅TT延迟告警  --- 阿吉   \n\n:::\n\n\n\n## 五、故障Action   \n| **序号** | *******Action** | *******负责人** | *******计划完成时间** | **验收标准** | **验收人** | **是否keyAction** | **是否回血Action** |\n| --- | --- | --- | --- | --- | :---: | --- | --- |\n| 1 | 短期：第一次容灾失败和核心app加监控告警   | 目云 | 9.19 |  | | | |\n| 2 | 短期：收集集团大促核心app | 林顿 | 已完成 |  | | | |\n| 3 | 短期：binlog增加保存时间 | 林顿 | 已完成 |  | | | |\n| 4 | 短期：梳理核心TT top作业 ，订阅TT延迟告警 | 阿吉 |  |  | | | |",
    "chunk_order_index": 1,
    "full_doc_id": "doc-14056c5666e1c930aba6c3af1346c15d"
  },
  "chunk-076322605edeeb1d5fd85e02795ebee7": {
    "tokens": 1200,
    "content": "## **一、故障简述**\n**故障概述：**\n\n2024-09-12 18:40:00，CSW出现间歇性抖动，影响部分集团业务，因涉及核心链路故升级P5，故障原因初步判断npd变更引起，此异常只会在1.0.61-20240906121012版本的npd服务重启时出现瞬时load飙高，因此在2024-09-12 19:11:31 发布完成后，未再出现过异常节点，故障恢复。\n\n**影响产品线：**\n\n**CSW  **\n\n闲鱼\n淘天集团\n\n**业务影响：**\n\n大量应用报load飙升\n\n**客诉量：**\n\n共2例+反馈\n最早反馈时间：18:43\n恢复时间：19:11\n\n## **二、故障过程回顾**\n### **2.1【故障处理时间线】**\n【故障注入】\n2024-09-10 16:16:47 乐钦开始对泛交易发布链路变更npd，变更镜像ali-t-kubenode-npd-1.0.61-20240906121012\n\n2024-09-10 20:35:18\t测试,日常, 预发集群发布完成；开始发布Core生产集群\n\n2024-09-12 16:01:45 Core生产集群发布完成\n\n2024-09-12 16:11:59 开始进行m集群推平 首先在asi_zjk_core_m_na620_a01开始发布\n\n2024-09-12 17:20:54 asi_zjk_core_m_na620_a01 集群推平完成,推平期间个别机器出现cpu load飙高（相比其他m集群异常机器幅度较小）\n\n+ 以33.33.183.235为例，cpuload指标飙高 [https://grafana-share.alibaba-inc.com/d/QLFh-1IGk2/su-zhu-ji-xiang-qing-dan-ipcha-xun?orgId=5&var-env=Prometheus-kmon&var-node=33.33.183.235&from=1726118644564&to=1726142031995](https://grafana-share.alibaba-inc.com/d/QLFh-1IGk2/su-zhu-ji-xiang-qing-dan-ipcha-xun?orgId=5&var-env=Prometheus-kmon&var-node=33.33.183.235&from=1726118644564&to=1726142031995)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/88356371/1726208173844-83038685-6277-43fe-a0bf-3cb2983121be.png)\n\n2024-09-12 17:31:08 asi_sh_core_m_ea119_01 开始推平，\n\n+ 17:31:08 - 17:32:23 第1批变更，涉及节点 1 台\n+ 17:37:23 - 17:39:19 第2批变更，涉及节点 5 台\n+ 17:44:20 - 17:54:21 第3批变更，涉及节点 10 台\n+ 17:59:21 - 18:09:23 第4批变更， 涉及节点 660 台\n\n2024-09-12 18:09:23 asi_sh_core_m_ea119_01 推平完成，其中第4批次变更开始后部分节点cpuload出现飙高\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/88356371/1726208565617-f870a388-5033-4573-bddd-fdb099c20361.png)\n\n2024-09-12 18:19:36\tasi_zjk_core_m_na610_01 开始推平，\n\n+ 18:19:36 - 18:21:06  第1批变更，涉及节点 1 台\n+ 18:26:06 - 18:28:06  第2批变更，涉及节点 5 台\n+ 18:33:07 - 18:34:52  第3批变更，涉及节点 10 台\n+ 18:39:52 - 18:49:54  第4批变更，涉及节点 1000 台\n+ 18:54:54 - 19:02:02  第5批变更，涉及节点 1000 台\n+ 19:07:03 开始执行第6批次变更，涉及节点1000台 \n\n【故障发生】\n2024-09-12 18:40:00 开始, 以及 18:55-58 19:07-19:10，CSW出现间歇性抖动，影响部分集团业务\n【故障发现】\n2024-09-12 18:43:03 集团业务触发告警：闲鱼_订单详情接口失败量指标[当前值为:229] 最近2分钟持续大于150 \n【故障响应】\n2024-09-12 19:07:00 路仁在TRE-集群管理大群 同步淘天反馈有大量应用报load飙升情况，询问是否有线上变更\n\n2024-09",
    "chunk_order_index": 0,
    "full_doc_id": "doc-de9de1395c480a36a71a060f3150ce80"
  },
  "chunk-d27ce16714db9bfe1b4017db1e17668b": {
    "tokens": 1200,
    "content": "】\n2024-09-12 18:43:03 集团业务触发告警：闲鱼_订单详情接口失败量指标[当前值为:229] 最近2分钟持续大于150 \n【故障响应】\n2024-09-12 19:07:00 路仁在TRE-集群管理大群 同步淘天反馈有大量应用报load飙升情况，询问是否有线上变更\n\n2024-09-12 19:07:00 乐钦准备暂停npd批次自动发布，但此时19:07:03执行的第6批次已经开始发布，发布完成即可恢复。\n\n【故障恢复】\n2024-09-12 19:11:31 第6批次发布完成，后续批次已停止未继续发布\n\n> 此异常只会在1.0.61-20240906121012版本的npd服务重启时出现瞬时load飙高，因此在2024-09-12 19:11:31 发布中止后，未再出现过异常节点。同时结合故障现象和排查复现的情况，也能够印证异常仅在部分机器该版本的npd发生重启时会出现load飙高。\n>\n> 但考虑到线上已发布的节点如果npd出现非预期的重启或者节点重启，有可能再次触发异常load飙高，故障风险未完全解除。\n>\n\n2024-09-12 19:20:00 乐钦抽取部分load飙高节点排查发现飙高时刻与npd装包时间强相关，找到哲欤排查确认\n\n2024-09-12 19:27:00 在「机器load突然升高」群内同步npd在asi_zjk_core_m_na610_01有发布并已经中止发布这一情况\n\n【初因定位】\n2024-09-12 20:15:00 20点促销活动过后，开始净空机器33.57.247.131尝试复现定位异常原因\n\n（原因定位过程在线下进行，具体准确时间及详细细节待确认补充）\n\n+ 异常机器上重启npd能稳定复现load飙高异常\n+ npd回滚至发布前的的版本t-kubenode-npd-1.0.61-20240822163353.alios7.aarch64，多次重启npd均未出现load飙高异常，初步定位触发异常的变更在npd版本 1.0.61-20240906121012 -> 1.0.61-20240822163353 之中\n+ 将此次变更异常的版本 1.0.61-20240906121012 中新增的巡检组逐个删除后尝试重启npd，尝试定位触发异常的巡检项。在删除kernel-hw-error-monitor巡检组后，重启npd后异常不再复现；尝试仅保留该巡检组，依然能稳定复现npd重启后cpu load飙高问题。初步确认新引入的 kernel-hw-error-monitor 巡检组触发会触发npd重启后load飙高异常\n\n【恢复执行】\n\n> npd发布停止后，存量已发布的节点没有再出现load飙高情况。\n>\n> 考虑到线上已发布的节点如果npd出现非预期的重启或者节点重启，有可能再次触发异常load飙高。因此制定回滚方案在2024-09-12 23:00后对asi_sh_core_m_ea119_01 和 asi_zjk_core_m_na610_01集群npd版本分批回滚至变更前的 1.0.61-20240822163353\n>\n\n2024-09-12 23:07:54\tasi_sh_core_m_ea119_01 开始分批回滚npd版本，前3批次逐个观测发布后节点指标，未出现异常情况\n\n2024-09-12 23:27:13\tasi_zjk_core_m_na610_01 开始分批回滚npd版本，前3批次逐个观测发布后节点指标，未出现异常情况\n\n2024-09-13 00:33:19 asi_sh_core_m_ea119_01 全部回滚完成，期间观测未出现cpu load飙高异常\n\n2024-09-13 06:14:58 asi_zjk_core_m_na610_01 全部回滚完成，期间观测未出现cpu load飙高异常\n\n【影响消除】\n2024-09-13 06:14:58 asi_sh_core_m_ea119_01 和 asi_zjk_core_m_na610_01全部回滚完成，故障风险解除\n\n\n\n### 2.2**【时间线概览】**\n![画板](https://intranetproxy.alipay.com/skylark/lark/0/2024/jpeg/149256407/1726641655501-cb6762fc-c400-4d57-9a6d-be70ce7e48c0.jpeg)\n\n## 三、故障原因\n### **3.1【背景说明】**\n#### 【需求背景】\n:::tips\nnpd新增内核日志硬件错误原因分类异常巡检项，根据硬件错误的类型(cpu/mem/pcie)及严重程度上报对应的异常 [【",
    "chunk_order_index": 1,
    "full_doc_id": "doc-de9de1395c480a36a71a060f3150ce80"
  },
  "chunk-7cc5d0556df259ba4318c6dec0c7b823": {
    "tokens": 1200,
    "content": "/jpeg/149256407/1726641655501-cb6762fc-c400-4d57-9a6d-be70ce7e48c0.jpeg)\n\n## 三、故障原因\n### **3.1【背景说明】**\n#### 【需求背景】\n:::tips\nnpd新增内核日志硬件错误原因分类异常巡检项，根据硬件错误的类型(cpu/mem/pcie)及严重程度上报对应的异常 [【anoe】npd对不同硬件错误的日志pattern进行探测并上报](https://aone.alibaba-inc.com/v2/project/786442/req/58439318#) \n\n:::\n\n---\n\n巡检方案简述 [可展开]由于npd中filelog-monitor仅支持单行日志正则匹配，不支持对连续多行日志进行pattern匹配。因此这里使用了如下方案：配置内核日志匹配patternHardware error from APEI Generic Hardware Error Source（硬件错误多行日志的首行）时执行hook，取出将该行及其后7行日志进行解析分类，将硬件错误类型和严重程度压缩为一行输出至/tmp/npd_kern_hw_error_reason_log文件中npd中新增 watch/tmp/npd_kern_hw_error_reason_log文件的filelog-monitor巡检项，匹配硬件错误类型和严重程度日志，并上报相应异常\n#### 【业务链路】\n![画板](https://intranetproxy.alipay.com/skylark/lark/0/2024/jpeg/88356371/1726812394492-95977190-6b5f-4ebf-a6d7-a3405c81015f.jpeg)\n\n\n\n### **3.2【原因分析】**\n#### **一句话原因：**\n:::tips\nnpd的日志文件巡检模块使用了内核的inotify机制，在初始化inotify watch时会对目录对应inode下的所有dentry进行遍历。由于/tmp目录下的dentry（目录项）数量巨大，耗时太长导致在该CPU1上产生了soft lockup；同时如果其他内核线程也尝试获取/tmp目录的的i_lock（索引节点锁），也会由于长时间获取不到，spin_lock自旋导致CPU 2产生soft lockup。\n\n:::\n\n#### **根因分析：**\n:::tips\n1. [@华敏](undefined/huamin.thm)： 原因与该问题分析类似 [https://www.cnxct.com/linux-file-system-fsnotify-notes/](https://www.cnxct.com/linux-file-system-fsnotify-notes/) 基于以上的分析流程，再次梳理下soft lockup问题产生的链路。  \n\n2. 目录/tmp下的dentry cache特别多，比如占据内存10GB，可能其中大部分都是negative dentry；  \ninotify_add_watch对/tmp这个目录进行了watch；  \n用户态代码调用inotify_add_watch 监控/tmp这个目录时，调用链路中会调用__fsnotify_update_child_dentry_flags这个函数；  \n__fsnotify_update_child_dentry_flags函数会对这个目录对应inode下的所有dentry（包括negative dentry）进行遍历，耗时太多导致在该CPU上产生了soft lockup；\n\n\n\n3. 另外，因为目录/tmp的inode的spin_lock被该内核线程占用太久，如果此时有其他进程需要获取该目录对应inode的spin_lock时，也会在其它CPU上产生soft lockup；  \n所以，综上，如果/tmp目录对应inode下的dentry巨多，soft lockup会有两个触发路径：  \nInotify_add_watch导致，由于内核线程A持有目录/tmp的i_lock，占据CPU 1太久导致soft lockup；  \n这时候内核线程B也尝试获取目录/tmp的i_lock，因为长时间获取不到，spin_lock自旋导致CPU 2产生soft lockup\n\n[@红叶](undefined/hongye.yx) [npd发布导致系统短暂hang，loadd飙高](https://aone.alibaba-inc.com/v2/project/786442/bug/59716330#) \n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/88356371/1726224673890-70ae0bf9-1084-4c82-9aa6-24b7537a66f6.png)\n\n:::\n\n\n\n## 四、关注点分析\n**关注点1〗**** 本次变更是否在变更窗口内，是否符合云侧的变更规范，变更灰度过程是否有效，灰度未发现的原因是什么，后续应如何改进。**\n\n:::tips\n**〖问题总结〗发布单：**[**https://asiops.alibaba-inc.com/changes/changeTickets/209109846**](https://asiops.alibaba-inc.com/changes/changeTickets/209109846)\n\n\n\n**〖改进点〗**\n\n:::\n\n****\n\n**〖关注点2〗** 是否监控发现，监控未发现的原因是什么？\n\n:::tips\n**〖问题总结〗有监控无告警阈值**\n\n\n\n**〖改进点〗配置监控阈值，实现监控告警通知@乐钦   0930**\n\n:::\n\n\n\n\n\n**〖关注点3〗** /tmp目录下的dentry（目录项）数量巨大,是否需要改进，核心目录是否需要拆分？\n\n:::tips\n**〖问题总结〗m集群即arm机型下，",
    "chunk_order_index": 2,
    "full_doc_id": "doc-de9de1395c480a36a71a060f3150ce80"
  },
  "chunk-e7172a0fc23c40ae6e2f19dc9617db72": {
    "tokens": 1200,
    "content": "**〖问题总结〗有监控无告警阈值**\n\n\n\n**〖改进点〗配置监控阈值，实现监控告警通知@乐钦   0930**\n\n:::\n\n\n\n\n\n**〖关注点3〗** /tmp目录下的dentry（目录项）数量巨大,是否需要改进，核心目录是否需要拆分？\n\n:::tips\n**〖问题总结〗m集群即arm机型下，**/tmp下的dentry cache特别多，为何arm的dentry cache特别多？\n\n**〖改进点〗**\n\n**m集群即arm机型下，**/tmp下的dentry cache修复[@雪钟](undefined/huanghaowei.hhw) \n监控大盘卫士稳定性建设（集群变更）带回需求确认[@锦雯](undefined/jinwen) 10.30\n灰度规则优化：machine-operator 迭代圈机器打散规则 方案确认[@广侯](undefined/guanghou.zt)   10.30\nnpd巡检日志文件迁至独立专用目录。避免触发inotify 致 softlockup异常@乐钦 已完成（巡检项下线，tmp目录删除npd巡检日志文件）\n\n\n\n:::\n\n## 五、故障Action\n| **序号** | *******Action** | *******负责人** | *******计划完成时间** | **验收标准** | **是否keyAction** | **是否回血Action** |\n| --- | --- | --- | --- | --- | --- | --- |\n| 1 | npd巡检日志文件迁至独立专用目录。避免触发inotify 致 softlockup异常    | 乐钦 |  0920 | CR合入发版 | 是 | 是 |\n| 2 | 灰度规则优化：machine-operator 迭代圈机器打散规则 |  | 待确认    |   | 否 | 否 |\n| 3 | 发布文档整理 |  | 0930 |  | 否 | 否 |\n|  |  |  |  |  |  |  |\n\n\n\n\n## 六、FAQ\n问题：NPD是什么？\n\nNPD（Node Problem Detector）是Kubernetes社区的一个开源组件，**主要用于监控节点的健康状态和检测节点的故障**。它能够将节点的异常，如Docker Engine Hang、Linux Kernel Hang、网络出网异常、文件描述符异常等，转换为Node的事件。结合kube-eventer等工具，可以实现节点事件告警的闭环，从而帮助维护集群的稳定性和可靠性。\n在Kubernetes集群中，NPD的作用包括：\n\n+ 监控节点的健康状态，及时发现并报告节点故障。\n+ 将节点故障转换为Kubernetes事件，便于集群管理。\n+ 与其他工具（如kube-eventer）结合，实现事件的实时采集、定向告警和异步归档。\n此外，NPD还可以与其他组件如Draino和Autoscaler配合使用，实现更高效的集群管理和故障响应。例如，在ECS被用作Kubernetes集群的Node节点时，通过云助手插件ecs-tool-event，结合NPD等工具，可以自动化监测和响应ECS系统事件，提升集群的稳定性和可靠性。\n\n问题：m集群是什么？代表什么\nm机器是arm机型，预发环境都是x86机型，无法观测。\n\n\n\n问题：inotify机制简介\n\ninotify是Linux内核提供的一种高效的文件系统事件监控机制，允许用户空间程序监控文件系统对象（如文件、目录）的变化，如创建、删除、修改等事件。它是通过在内核中为被监控的对象设置监控点（watch）来实现的。\n\n\n\n问题：初始化inotify watch时的问题\n\n当使用inotify对一个目录（如`/tmp`）设置监控时，内核会遍历该目录下的所有dentry（目录项），为每个子项设置监控。对于像`/tmp`这样可能包含大量临时文件和目录的系统目录来说，这个初始化过程可能会非常耗时，因为它需要对每个dentry进行处理。这可能导致执行该操作的CPU（在这里是CPU1）长时间忙于此任务，从而无法处理其他任务，引发soft lockup现象。Soft lockup通常表示一个CPU核心在一段时间内（通常是20秒）没有机会切换到其他任务，尽管系统并未完全挂起。\n\n\n\n\n\n问题：i_lock与spin_lock自旋\n\n当其他内核线程尝试访问同一目录（例如尝试获取`/tmp`的i_lock，即索引节点锁）时，如果因为当前有线程正在遍历并持有该锁，这些线程将进入spin_lock自旋等待状态，即不断地检查锁是否可用，直到可以获取锁。在`/tmp`目录下的dentry数量非常多的情况下，这个等待时间可能会很长，导致执行这些线程的CPU（CPU2）也陷入soft lockup，因为它也在执行无休止的循环等待，而没有机会执行其他任务。\n\n解决方案与建议\n\n优化监控策略：考虑是否有必要对整个`/tmp`目录进行监控，或者能否缩小监控范围至特定的子目录或文件。针对性地设置监控点可以减少初始化时的负担。\n\n使用inotify",
    "chunk_order_index": 3,
    "full_doc_id": "doc-de9de1395c480a36a71a060f3150ce80"
  },
  "chunk-ef926093e64be9cace0317ef28381b6d": {
    "tokens": 300,
    "content": "时间可能会很长，导致执行这些线程的CPU（CPU2）也陷入soft lockup，因为它也在执行无休止的循环等待，而没有机会执行其他任务。\n\n解决方案与建议\n\n优化监控策略：考虑是否有必要对整个`/tmp`目录进行监控，或者能否缩小监控范围至特定的子目录或文件。针对性地设置监控点可以减少初始化时的负担。\n\n使用inotify的非阻塞特性：确保在使用inotify时采用非阻塞模式，这样即使在初始化或监控过程中遇到耗时操作，也不会完全阻塞整个进程或线程。\n\n增加超时机制：在遍历或锁定操作中考虑引入超时逻辑，以避免无限期地等待，虽然这可能需要更复杂的错误处理逻辑。\n\n系统调优：调整内核参数，比如spin_lock的自旋时间限制，或者增加系统的整体并发能力，以减轻此类问题的影响。\n\n资源隔离：考虑使用cgroups（Control Groups）等技术来限制特定进程或线程对系统资源的使用，避免它们过度消耗CPU导致其他任务受到影响。\n\n监控与告警：增强系统监控，对可能发生soft lockup的关键操作设置告警，以便及时发现并处理潜在问题。\n\n  \n\n\n  \n\n\n### \n\n\n\n\n\n\n## \n  \n\n\n\n\n****",
    "chunk_order_index": 4,
    "full_doc_id": "doc-de9de1395c480a36a71a060f3150ce80"
  },
  "chunk-d4b7cf248eeab95b476cfd87af1b8e26": {
    "tokens": 1200,
    "content": "原因是什么，后续应如何改进。**[@清文](undefined/daiwenqing.dwq)\n\n:::tips\n**〖问题总结〗**\n\n否；否\n未发现的原因：灰度时只关注了节点是否ready以及kubelet是否正常运行，没有关注pod的ready情况\n\n**〖改进点〗**\n\n1. 稳定版本覆盖面足够才自动化推平\n2. 不应该周末发布，应严格遵循云侧变更规范\n3. 组件发布时要在群里同步，方便故障时定位原因\t\t\n4. 发布时要考虑到可能影响的指标，发布时要时刻关注该指标的大盘\n5. 发布集群顺序：先发小集群，测试集群。\n6. 集群odps基座变更协同下游落地  [@潇客](undefined/liang.yel)\t0920\n\n:::\n\n****\n\n**〖关注点2〗** 是否监控发现，监控未发现的原因是什么？\n\n:::tips\n**〖问题总结〗**\n\n最后是通过监控发现\n一开始未发现是因为发布时未关注/不知道有odps[相关大盘](https://tesla.alibaba-inc.com/m3/d/f6j5KHI4z/clusteroverview-on-asi?from=1725703116404&orgId=1&to=1725860475360&var-cluster=asi_zjk_odps_ay36a_02&var-interval=1m&var-quantile=0.95)\n\n**〖改进点〗**\n\n**监控完善，颗粒度指标细化\t**[@潇客](undefined/liang.yel)** **0920\n\n以后发布odps集群时，注意关注[相关大盘](https://tesla.alibaba-inc.com/m3/d/f6j5KHI4z/clusteroverview-on-asi?from=1725703116404&orgId=1&to=1725860475360&var-cluster=asi_zjk_odps_ay36a_02&var-interval=1m&var-quantile=0.95)（odps、tair、中间件）指标\n告警场景订阅  [@锦雯](undefined/jinwen)\t0920\n\n:::\n\n\n\n**〖关注点3〗**** **发布时间是否合理，是否通知上下游业务？\n\n:::tips\n**〖问题总结〗**\n\n不合理，没有通知上下游业务\n\n**〖改进点〗**\n\n1. 不应该周末发布，以后一定注意非工作日禁止发布\n2. 发布时补充变更单详细信息、原因\t\n3. 组件发布时要在群里同步，方便故障时定位原因\n\n:::\n\n\n\n**〖关注点4〗** 新版发布是否需要对存量业务对老版本逻辑的依赖评估？\n\n:::tips\n**〖问题总结〗**\n\n需要\n\n**〖改进点〗**\n\n变更时要考虑最坏情况，如果最坏情况不可接受，则不变更\n\n:::\n\n\n\n## 五、故障Action\n| **序号** | *******Action** | *******负责人** | *******计划完成时间** | **验收标准** | **是否keyAction** | **是否回血Action** |\n| --- | --- | --- | --- | --- | --- | --- |\n| 1 | 发布流程规范：1. 稳定版本覆盖面足够才自动化推平2. 不应该周末发布，应严格遵循云侧变更规范3. 组件发布时要在群里同步，方便故障时定位原因\t4. 发布时补充变更单详细信息、原因\t\t5. 发布时要考虑到可能影响的指标，发布时要时刻关注该指标的大盘（odps、tair、中间件）指标6. 变更时要考虑最坏情况，如果最坏情况不可接受，则不变更7. 发布集群顺序：先发小集群，测试集群 | 清文 | 0920 | 产出变更文档： | 是 | 是 |\n| 2 | 集群odps基座变更协同下游落地  | 潇客 | 0920 | 同步协调结果至各下游业务方 | 否 | 否 |\n| 3 | 监控完善，颗粒度指标细化 | 清文 | 0920 |   完善相关监控文档，监控上线并验证通过 | 否 | 否 |\n| 4 | 发布变更场景订阅 | 锦雯\t | 0920 | 发布变更订阅到下游业务群 | 否 | 否 |\n\n\n\n\n## 六、故障总结反思\n**【做得好的】**\n\n**【经验教训】**举一反三，学习，避免踩坑\n\n清文：\n\n1. 不应该周末发布，以后一定注意非工作日禁止发布\n2. 发布新版本时，没有考虑到存量业务对老版本逻辑的依赖（即使是个bug）\n3. 组件发布时要在群里同步，方便故障时定位原因\n4. 稳定版本覆盖面足够才自动化推平\n5. 以后发布odps集群时，注意关注[相关大盘](https://tesla.alibaba-inc.com/m3/d/f6j5KHI4z/clusteroverview-on-asi?from=1725703116404&",
    "chunk_order_index": 1,
    "full_doc_id": "doc-1c28696ccfd9b7c0e4c33a8bbf50c3f4"
  },
  "chunk-202ca73b295e7d6acbd6a9bf03724a2b": {
    "tokens": 151,
    "content": "逻辑的依赖（即使是个bug）\n3. 组件发布时要在群里同步，方便故障时定位原因\n4. 稳定版本覆盖面足够才自动化推平\n5. 以后发布odps集群时，注意关注[相关大盘](https://tesla.alibaba-inc.com/m3/d/f6j5KHI4z/clusteroverview-on-asi?from=1725703116404&orgId=1&to=1725860475360&var-cluster=asi_zjk_odps_ay36a_02&var-interval=1m&var-quantile=0.95)指标\n\n#### \n\n\n  \n\n\n####",
    "chunk_order_index": 2,
    "full_doc_id": "doc-1c28696ccfd9b7c0e4c33a8bbf50c3f4"
  },
  "chunk-4a55067f3cced453788e7e3d687ccbbd": {
    "tokens": 1200,
    "content": "## 一、故障简述\n**故障简述：**\n\n2024-09-12 17:53，有批量用户反馈小二推出的卡片需要上传凭证时无法点击相册，初步定位到与17:34 小蜜前端发布相关，于18:05回滚后止血，故障期间客诉20+，到达P4。 \n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/8177/1726198055256-e0c260cd-cc77-483e-a61f-fd5baed96edb.png)\n\n\n\n影响面：  \n报错数量9101， 用户反馈数量40\n\n## 二、故障过程回顾\n### 2.1【时间线概览】\n![画板](https://intranetproxy.alipay.com/skylark/lark/0/2024/jpeg/125756462/1726154874607-8a1a7bec-495c-479d-b542-a935fc3fa650.jpeg)\n\n\n\n### 2.2【故障处理时间线】\n故障时间线：\n\n2024-09-12 17:34，小蜜前端发布**【故障引入】**\n\n2024-09-12 17:53，有批量用户反馈上传不了凭证照片，于17:53触发VOC预警**【故障发现】【故障发生】**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/8177/1726192748984-aab3bd5d-9ce4-4684-8029-e337a0a5d980.png)![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/8177/1726192908463-665e8f22-0595-4780-8ec5-402690467af8.png)\n\n2024-09-12 17:55，GOC拉群处理\n\n2024-09-12 17:56，诗海看到钉钉群告警信息，用本地手机验证时未发现问题，于18:04决策开始回滚\n\n2024-09-12 18:04，回滚完成\n\n2024-09-12 18:06，确认是客运这边的业务，开始拉研发进群处理  \n\t\t\t     同时[@诗海](undefined/baoxiaohai.bxh)回滚，问题止血，数据恢复\n\n2024-09-12 18:16， 责任人[@诗海](undefined/baoxiaohai.bxh)被拉到风险处理群并同步相关信息![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/125756462/1726193921845-32db50dc-cb44-4048-bbee-83645735f925.png)\n\n\n\n\n\n## 三、故障原因\n### 3.1【背景说明】\n背景：\n\n本次发布为了修复 **新增图片多选功能后导致工作台小二无法审核** 的问题，修改后老链路调用走了WVCamera但保留了多选标识导致接口报错\n\n### 3.2【原因分析】\n**一句话原因：**\n\n保留了多选标识但走了老的接口链路的原本线上未覆盖分支，测试和自测机型刚好错过会触发的条件\n\n\n\n**根因分析：**\n\n![](https://intranetproxy.alipay.com/skylark/lark/__puml/070d7dba131f9484896ed3e5715bd950.svg)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/125756462/1726155358508-0fe011c6-fa2c-4d1e-828e-3f6f219c6c28.png)![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/125756462/1726155335350-f8d1b345-618a-4a17-8b6b-a197416da5b2.png)\n\n多选改回单选后 多选的标识没有删除 对应的走进bridge中以前对于单选的接口。\n\n但是该接口目前发现是不支持多选的，在能力执行之前 执行了上面check，历史代码是有对固定机型和tb版本的判断的，**对于小米和ios强制复写为多选标false**。\n\n在自测和测试阶段对iphone 和 小米机型反复验证 均恰好避开限制 未能复现问题继而带到线上造成影响。\n\n## 四、关注点分析\n【关注点1】历史代码是有对固定机型和tb版本的判断的，对于小米和ios强制复写为多选标false，这个逻辑研发发布前是否知道？\n\n:::info\n问题总结：发布前不知道，是故障发生后才排查到的逻辑\n\n优化：针对历史单机型判断的定制逻辑应该尽量减少，\n\n:::\n\n### 4.1【系统质量】\n#### 4.1.1 需求&设计评估\n**〖关注点1〗****是否涉及产品、技术方案评估？此核心的问题是什么，如何改进？**\n\n- [x] **是，涉及**\n    - [ ] 需求评估遗漏\n    - [ ] 产品",
    "chunk_order_index": 0,
    "full_doc_id": "doc-a455d56af97799632b83ae11a82c560c"
  },
  "chunk-33b22067b537083bf13ac6e29deaaa91": {
    "tokens": 1200,
    "content": "查到的逻辑\n\n优化：针对历史单机型判断的定制逻辑应该尽量减少，\n\n:::\n\n### 4.1【系统质量】\n#### 4.1.1 需求&设计评估\n**〖关注点1〗****是否涉及产品、技术方案评估？此核心的问题是什么，如何改进？**\n\n- [x] **是，涉及**\n    - [ ] 需求评估遗漏\n    - [ ] 产品设计缺陷\n    - [ ] 系统架构设计缺陷\n        - [x] 容错性不足 \n        - [ ] 单点，无冗余\n        - [x] 缺乏自我保护\n        - [ ] 缓存设计不当\n        - [ ] 容量评估不足\n        - [ ] 非幂等设计\n        - [ ] 强弱依赖不合理\n        - [ ] 其他：__________\n- [ ] 否，不涉及\n\n**〖问题总结〗**\n\n**〖改进点〗**_****_\n\n1、单机型判断的定制逻辑应该尽量减少\n\n2、如果能力不具备需要注释说明\n\n#### 4.1.2 代码质量\n**〖关注点1〗是否代码自身存在漏洞或BUG、代码健壮性是否存在问题等?**\n\n**〖问题分析〗**\n\n**〖改进点〗**_**需明确写明不同故障相关方的改进项（若有的话），下同。**_\n\n1、\n\n\n\n**〖关注点2〗****是否经过CodeReview？CodeReview阶段是否发现问题？为何没发现？**\n\n+ **是否经过CR**\n    - [ ] 是\n    - [ ] 否\n    - [ ] 不涉及\n+ **是否设置合理的CR卡点**\n    - [ ] 是\n    - [ ] 否\n    - [ ] 不涉及\n+ **CodeReview阶段是否发现问题？为何没发现？后续如何发现？**\n    - [ ] 是\n    - [ ] 否\n    - [ ] 不涉及\n\n**〖问题分析〗******\n\n**〖改进点〗**_**需明确写明不同故障相关方的改进项（若有的话），下同。**_\n\n1、\n\n\n\n**〖关注点3〗****测试阶段**\n\n+ **测试内容：**涉及的测试提交单、测试用例等\n+ **测试人员：**\n+ **是否经过测试验证**\n    - [ ] 是，验证环境\n        - [ ] 预发环境\n        - [ ] 日常环境\n    - [ ] 是，测试方法\n        - [ ] 单元测试\n        - [ ] 功能回归测试\n        - [ ] 集成测试/链路测试\n        - [ ] 验收测试\n    - [ ] 否\n    - [ ] 不涉及\n+ **测试未发现原因是什么？后续如何改进？**\n    - [ ] 回归测试遗漏\n        - [ ] 手工回归测试用例遗漏\n        - [ ] 自动化未建设\n        - [ ] 自动化回归覆盖不足\n        - [ ] 其他：__________\n    - [ ] 新场景测试遗漏\n        - [ ] 功能测试用例遗漏，包括正常分支和异常分支\n        - [ ] 容灾兜底测试遗漏\n        - [ ] 客户端兼容性测试遗漏\n        - [ ] 埋点测试遗漏\n        - [ ] 性能测试遗漏，影响评估不足\n        - [ ] 安全测试遗漏\n    - [ ] 其他：__________\n\n**〖问题总结〗**\n\n**〖改进点〗**_**需明确写明不同故障相关方的改进项（若有的话），下同。**_\n\n1、\n\n#### 4.1.3 变更质量\n+ **是否涉及变更：**\n    - [x] 是\n    - [ ] 否\n+ **变更类型：**\n    - [x] 代码发布\n    - [ ] 配置变更\n    - [ ] 其他变更：____________\n    - [ ] 不涉及\n+ **变更平台是否接入ChangeFree：**\n    - [ ] 是，CF变更单链接：________\n\n_/*要这样的链接_ [https://aicf.alibaba-inc.com/aicf/change/detail/1725370372](https://aicf.alibaba-inc.com/aicf/change/detail/1725370372) */\n\n    - [x] 否\n+ **是否违反变更红线3.1**** **[链接](https://aliyuque.antfin.com/trecs/fzg6dy/davhpu2lb9m9g6g2)\n    - [ ] 是，违反哪条原则：\n    - [ ] 否\n\n暂时能力还在建设中，目前是走线下的审批流，会走到前端的同学这边。后续会接CF，[@遇丞](undefined/caiyucheng.cyc) 930之前接入虽然没有\n\n\n\n**〖关注点1〗****灰度阶段**\n\n+ **是否经过灰度：**\n    - [ ] 是\n    - [x] 否\n+ **观测了哪些监控**：_可以附链接_\n    - [ ] 黑屏、白屏\n    - [ ] GOC监控：\n    - [ ] 系统大盘：\n    - [x] 其他：[https://x.alibaba-inc.com/custom",
    "chunk_order_index": 1,
    "full_doc_id": "doc-a455d56af97799632b83ae11a82c560c"
  },
  "chunk-3008589abe1744a76a6edf81f72d170b": {
    "tokens": 1200,
    "content": "930之前接入虽然没有\n\n\n\n**〖关注点1〗****灰度阶段**\n\n+ **是否经过灰度：**\n    - [ ] 是\n    - [x] 否\n+ **观测了哪些监控**：_可以附链接_\n    - [ ] 黑屏、白屏\n    - [ ] GOC监控：\n    - [ ] 系统大盘：\n    - [x] 其他：[https://x.alibaba-inc.com/custom/36/product/preview/multiMinute/19047?crossTenant=true](https://x.alibaba-inc.com/custom/36/product/preview/multiMinute/19047?crossTenant=true)\n+ **是否灰度期间发现问题？**\n    - [ ] 是\n        - [ ] 是否灰度流量过大，导致故障\n        - [ ] 灰度发现但未有效或及时修复，导致故障\n        - [ ] 其他：___________\n    - [x] 否，后续如何灰度发现？___补充灰度__________\n+ **未灰度发现原因**\n    - [ ] 应用灰\n        - [ ] 灰度流量太小\n        - [ ] 灰度阶段无监控\n        - [ ] 灰度批次不合理\n        - [ ] 超长时间灰度才能发现\n    - [ ] 业务灰：策略不合理\n    - [ ] 灰度无法发现\n    - [x] 其他：_____________\n\n**〖问题总结〗卡片工坊之前无灰度能力**\n\n**〖改进点〗**_****_\n\n1、卡片工坊灰度发布能力补充\n\n\n\n**〖关注点2〗****上线阶段**\n\n+ **是否有确定的监控观测指标**\n    - [x] 是，监控指标及监控链接：\n    - [ ] 否\n+ **是否在窗口期进行发布变更**\n    - [ ] 是\n    - [x] 否，原因：\n+ **变更是否影响上下游**\n    - [ ] 是，是否有提前知会上下游评估及关注变更\n        - [ ] 有提前知会\n        - [ ] 没有提前知会\n    - [x] 否\n\n**〖问题总结〗目前只把故障场景接入了风险洞察**\n\n**〖改进点〗**_****_\n\n1、后续梳理top20场景接入风险洞察[@岂几](undefined/akai.lk) 0920\n\n### 4.2【处置能力】\n#### 4.2.1 故障发现&响应\n+ **是否监控发现**\n    - [x] 故障触发方 监控发现\n    - [ ] 故障受影响方 监控发现\n    - [ ] 否，原因为：（监控无效/监控缺失）\n+ **是否5分钟内响应**\n    - [ ] 是\n    - [x] 否，原因为：发布后未及时关注告警群信息\n+ **是否存在应急协同问题**\n    - [ ] 是\n        - [ ] 应急流程不明确（无流程或者流程不清晰、应急相关角色&职责不明确，缺失一号位等)\n        - [ ] 应急执行不到位（有流程，但未按流程执行，通告发送不及时，响应不及时等）\n    - [x] 否\n\n**〖问题总结〗**\n\n**〖改进点〗**_**需明确写明不同故障相关方的改进项（若有的话），下同。**_\n\n1、发布后15分钟及时关注告警信息\n\n2、对应告警项配置合理阈值电话通知\n\n#### 4.2.2 故障定位&恢复\n+ **主要恢复方式：**\n    - [x] 代码发布/回滚\n    - [ ] 配置发布/回滚\n    - [ ] 数据订正\n    - [ ] 机器隔离/重启/扩容\n    - [ ] 配置限流\n    - [ ] 预案降级\n    - [ ] 自动恢复\n    - [ ] 其他：\n+ **是否10分钟内恢复**_/* P1P2故障填写*/_\n    - [ ] 是\n    - [x] 否，原因：发现时间晚了，发现后5min回滚\n\n**〖关注点1〗定位&恢复阶段存在什么问题？是否可以增加预案，****有更快的恢复方式？****相关的优化改进？**\n\n**〖问题总结〗**\n\n1、 没能及时关注告警通知\n2、发现问题后定位验证几分钟才进行回滚操作 进一步加大问题\n\n**〖改进点〗**\n\n1、告警通知明确，发布后及时关注告警\n2、发现问题只要问题出现时间和发布时间相似 需要立刻回滚\n\n\n**〖关注点2〗业务自身是否具备容灾逃逸能力？后续如何改进？**_/* 如涉及基础设施引发的故障，可填写*/_\n\n- [ ] 具备容灾能力\n    - [ ] 因未演练不敢执行\n    - [ ] 因有损评估决策不执行\n    - [ ] 无决策或者决策不当，未执行\n- [ ] 不具备容灾能力\n\n**〖问题总结〗**\n\n**〖改进点�",
    "chunk_order_index": 2,
    "full_doc_id": "doc-a455d56af97799632b83ae11a82c560c"
  },
  "chunk-d21a0345d3055a43de8579711aef7441": {
    "tokens": 1117,
    "content": "？后续如何改进？**_/* 如涉及基础设施引发的故障，可填写*/_\n\n- [ ] 具备容灾能力\n    - [ ] 因未演练不敢执行\n    - [ ] 因有损评估决策不执行\n    - [ ] 无决策或者决策不当，未执行\n- [ ] 不具备容灾能力\n\n**〖问题总结〗**\n\n**〖改进点〗**\n\n## 五、故障Action\n| **序号** | *******Action** | *******负责人** | *******计划完成时间** | **验收标准** | **验收人** | **是否keyAction** | **是否回血Action** |\n| --- | --- | --- | --- | --- | --- | --- | --- |\n| 1 | 遵循发布流程及时关注告警信息，出现疑似问题第一时间回滚，后续安排组内复盘分享，同步发布流程注意事项 | [@诗海](undefined/baoxiaohai.bxh) | 9.13 |  | [@遇丞](undefined/caiyucheng.cyc) | | |\n| 2 | 卡片top20场景，sunfire告警接入风险洞察 | [@诗海](undefined/baoxiaohai.bxh)[@岂几](undefined/akai.lk) | 9.20 | 监控项目复查 | [@遇丞](undefined/caiyucheng.cyc) | | |\n| 3 | 涉及 jsBridge 调用的改动，组织技术方案评审,给测试明确输入需要做兼容性测试的部分 | [@诗海](undefined/baoxiaohai.bxh) | 9.13 | 流程规范 | [@遇丞](undefined/caiyucheng.cyc) | | |\n| 4 | 测试用例评审，明确兼容性测试覆盖范围（机型、系统、手淘版本等） | [@敏瑜](undefined/hujing.hj) | 9.13 | [小蜜测试流程规范](https://aliyuque.antfin.com/eglo0l/ngh4p0/gpuax8qh588cembe#Ny9Zp) | [@敏瑜](undefined/hujing.hj) | | |\n| 5 | 兼容性测试验收标准（覆盖范围、验收报告） | [@敏瑜](undefined/hujing.hj) | 9.20 | [测试计划模板](https://aliyuque.antfin.com/eglo0l/ngh4p0/mg7qpn)[测试报告模板](https://aliyuque.antfin.com/eglo0l/ngh4p0/cq48g0) | [@敏瑜](undefined/hujing.hj) | | |\n| 6 | 卡片支持灰度发布 | [@诗海](undefined/baoxiaohai.bxh) | 9.26 | 功能验收 | [@遇丞](undefined/caiyucheng.cyc) | | |\n| 7 | 拉当时转人工率的上涨比例 |  |  |  |  | | |\n\n\n## 六、故障总结反思\n_/* P1故障必填，主要用于总结分享和提炼分析*/_\n\n**【做得好的】**\n\n最佳实践\n\n**【经验教训】**\n\n举一反三，学习，避免踩坑\n\n## 七、影响产品线&影响面\n_/* 可附本次故障影响触达的等级，以及等级定义的链接和截图]*/_\n\n- [x] 是否影响可用性：/*_可用性指标，可用性时长消耗*/_\n\n可用性影响说明：\n\n对于卡片code为new-evidence-uploader的卡片 点击上传凭证后点击相册无响应\n\n- [x] 业务影响：/*_影响的产品线，业务功能，功能受损程度（成功量/率下跌多少%），持续多少时间*/_\n\n业务影响说明：\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/125756462/1726193921845-32db50dc-cb44-4048-bbee-83645735f925.png?x-oss-process=image%2Fformat%2Cwebp%2Fresize%2Cw_860%2Climit_0)\n\n在17:34到18:04阶段安卓非小米机型无法上传举证。\n\n影响业务：退款退运费相关需要用户上传举证的场景\n\n客诉反馈20+，报错量9101\n\n- [x] 是否有客诉：\n\n客诉影响说明：在线人工40条中只有10天是因为在小蜜端推出的卡片无法上传凭证导致转人工客服\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/8177/1726208367123-08269aff-bc5c-4e88-98b0-a26609059c1e.png)",
    "chunk_order_index": 3,
    "full_doc_id": "doc-a455d56af97799632b83ae11a82c560c"
  },
  "chunk-f787e6af23a6436cdde6474d0498e70b": {
    "tokens": 17,
    "content": "-4e88-98b0-a26609059c1e.png)",
    "chunk_order_index": 4,
    "full_doc_id": "doc-a455d56af97799632b83ae11a82c560c"
  },
  "chunk-033f4a38f73e15a53342d3d8bc73dcaa": {
    "tokens": 1200,
    "content": "## 一、故障简述\n于2024年9月24日12:10分开始拍立淘业务开始下跌，通过业务监控定位到向量召回trigger由于路由参数非预期，导致访问异常。引擎同学通过操作预案，恢复正常参数配置，业务于12:40分恢复。故障期间累计资损为30万。\n\n**APM故障链接：**\n\n [https://trfree.alibaba-inc.com/ormEmergency/workbench/emergency/202409250000001107001](https://trfree.alibaba-inc.com/ormEmergency/workbench/emergency/202409250000001107001)\n\n## 二、故障过程回顾\n### 2.1【时间线概览】\n![画板](https://intranetproxy.alipay.com/skylark/lark/0/2024/jpeg/80256396/1727577136082-30a9d295-6f85-4123-87dc-46b8daab320b.jpeg)\n\n故障发现～初因定位：12:20 ~ 12:34，14min\n\n初因定位～恢复执行：12:34 ~ 12:40，6mim\n\n### 2.2【故障处理时间线】\n2024-09-09 09:36，新建二进制实验，由于需要升级在线索引数据，在实验田复制了一个生产biz，用于验证改动效果是否符合预期。整体索引改动，效果持平微正，符合预期。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/52383/1727502957679-4f8b856c-a26b-4a3f-9584-6037d90e0459.png)\n\n**2024-09-12 08:32**，算法同学影书操作拍立淘二进制实验参数推向base，导致二进制环境承接全部生产流量；**——【故障引入】**\n\n[https://whaleshark-next.alibaba-inc.com/product/experiment/publish?domain=kgb&publishId=213692&type=algo](https://whaleshark-next.alibaba-inc.com/product/experiment/publish?domain=kgb&publishId=213692&type=algo)\n\n2024-09-12 08:44，第一批机房发布\n\n2024-09-12 09:12，第二批机房发布(间隔26min)，黄金眼效果平稳\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/52383/1727502713612-70bfa0db-ac3b-4577-9356-f329d207a9ac.png)\n\n2024-09-24 12:10， 实验平台自动回收接流静默14天环境，导致img-vec-trigger路由失败；\n\n[https://whaleshark-next.alibaba-inc.com/product/experiment/publish?domain=kgb&publishId=219098&type=algo](https://whaleshark-next.alibaba-inc.com/product/experiment/publish?domain=kgb&publishId=219098&type=algo)\n\n**2024-09-24 12:20**， 拍立淘场景效果大跌，触发黄金眼报警。** ——【故障发现】**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/235531/1727178608036-181b94d2-a805-4c32-b7ff-3f64c8b17b5d.png)\n\n**2024-09-24 12:21**，值班同学联系场景负责同学介入排查；**——【故障响应】**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/235531/1727178651398-e7695abb-5ff3-47ed-bf89-00fddaa95c45.png)\n\n**2024-09-24 12:25**，拍立淘业务累计资损达到15万元；**——【故障发生】**\n\n**2024-09-24 12:34**，由于相邻时间**无任何生产事件（非预期）** & 机房特征，各方排查链路问题中。最终通过MatchServer报错日志找到故障问题表现；**——【故障定位】**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/235531/1727178820862-043110ba-06bb-4631-9004-06024290057a.png)\n\n**2024-09-24 12:40**，通过参数状态查询，确定当前base区不符合预期。建立预案完成问题修复；**——【恢复执行】【故障恢复】**\n\n## 三、影响产品线&影响面\n    - [ ] 是否有客诉量：\n        * 无\n    - [x] 是否产生资损：\n        * 故障期间累计资损金额30万元\n\n## 四、故障原因\n### 4.1【一句话原因】\n由于二进制实验直接推base，导致生产流量全部导入实验环境。实验环境被自动回收任务删除，导致拍立淘召回Trigger全部访问失败，场景消耗突降。\n\n### 4.2【详细原因】\n**【业务链路图】**\n\n拍立淘业务场",
    "chunk_order_index": 0,
    "full_doc_id": "doc-341d86b737e0960a0e89177167520855"
  },
  "chunk-5be1ea65816219cea686c172fc7d409b": {
    "tokens": 1200,
    "content": "损：\n        * 故障期间累计资损金额30万元\n\n## 四、故障原因\n### 4.1【一句话原因】\n由于二进制实验直接推base，导致生产流量全部导入实验环境。实验环境被自动回收任务删除，导致拍立淘召回Trigger全部访问失败，场景消耗突降。\n\n### 4.2【详细原因】\n**【业务链路图】**\n\n拍立淘业务场景召回链路图：\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/235531/1727540489046-27619b26-95c5-42b4-8616-8fff9e1372df.png)\n\n**【二进制实验参数变更需求背景】**\n\n在线拍立淘相关性case有较大比例来自于用商品副图检索，为了快速解决相关性问题，从召回索引中下线副图来源。\n\n**【问题/正常参数配置发布截图】**\n\nvt_b_srv_biz指向实验田biz，参数不需要推到在线。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/52383/1727503066246-cf4d0f81-7071-4eba-a826-573685e124c6.png)\n\n**【本次预期外误操作推送的问题参数含义】**\n\n指定img_vec_trigger的biz名，在线会请求访问这个biz。\n\n**【实验平台回收任务的逻辑】**\n\n二进制实验环在最新的实验版本接流14天后，自动回收流量和机器资源。\n\n## 五、关注点讨论\n#### 1、问题引入阶段\n【在/离线变更代码开发完成后，需要经过**code review**确认无误后进行合并**代码主干**提交】--红线点\n【在线变更代码修改提交必须经过**功能单测；**离线变更代码修改完成后，生成的离线数据必须要经过**数据校验**】--红线点\n\n**〖关注点1〗**是否有经过CR？是否有经过单测？是否有经过测试？是否自动化测试可覆盖？测试阶段为何没发现？\n请提供CR链接：不涉及 \n [原因分析] \n主要是更换新索引数据，实验田验证效果需要复制一个线上biz，替换索引数据，不涉及代码改动。9.9 ~ 9.12 实验田小流量观察3天，效果符合预期。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/52383/1727503246340-4159adcb-3960-4b2d-a96f-e4fa29a7e2b9.png)\n\n ACTION：\n暂无  \n\n【生产变更，**务必要经过灰度发布**，灰度发布时间**间隔大于20min****】**--红线点\n\n**〖关注点2〗**是否变更窗口期进行发布？是否经过灰度？分机房或分批发布第一批发布时间间隔是否大于20分钟？灰度过程中为何未发现问题？\n请提供ChangeFree变更单链接：[https://aicf.alibaba-inc.com/aicf/change/v2/detail/1231143357?spm=goc-apm.aicf-_changeList.0.0.37c0238867vXqI](https://aicf.alibaba-inc.com/aicf/change/v2/detail/1231143357?spm=goc-apm.aicf-_changeList.0.0.37c0238867vXqI)\n\n [原因分析] 有经过灰度，符合灰度要求，灰度过程中无法发现的原因说明：\n\n分批发布，前后分机房观察间隔26min，拍立淘场景消耗等各项指标平稳。无法发现问题的原因是推base后流量全部导入实验田，且实验田机器容量可承接，从业务效果监控上无法发现。\n\n ACTION：\n\n暂无\n\n\n\n**【****黄金眼指标观察**，10分钟左右，观察已发布**本机房、核心pid、分广告主体类型**的黄金眼业务指标】--红线点\n\n**【****变更改动点验证**，验证已变更的**功能逻辑&数据已经生效**(最好有直接或间接生效截图记录)**】**--红线点\n\n**〖关注点3〗**是否进行黄金眼指标观察，观察是否发现问题？是否验证变更改动点，验证是否发现问题？\n\n请提供观测链接：\n\n[拍立淘场景 - 新版黄金眼 (alibaba-inc.com)](https://goldeneye.alibaba-inc.com/#/myquery/detail/2750?dvs=%E6%8B%8D%E7%AB%8B%E6%B7%98&productLineId=1&dataAppId=373&metricIds=rank_pctr,rank_pcvr,valid_click,valid_cost,page,all_pv,ad_pv,pvr,RPMi,CTRi,PPC,tfr&timeSlice=300&statTimeSlice=60&startTime=2024-09-12%2000:00&endTime=2024-09-12%2023:55&compareType=1&displaytype=0&showLineChartOrNot&showAccLineChartOrNot=false&show",
    "chunk_order_index": 1,
    "full_doc_id": "doc-341d86b737e0960a0e89177167520855"
  },
  "chunk-3c8df09c4d41f92b7dc75d23798640c0": {
    "tokens": 1200,
    "content": "_pctr,rank_pcvr,valid_click,valid_cost,page,all_pv,ad_pv,pvr,RPMi,CTRi,PPC,tfr&timeSlice=300&statTimeSlice=60&startTime=2024-09-12%2000:00&endTime=2024-09-12%2023:55&compareType=1&displaytype=0&showLineChartOrNot&showAccLineChartOrNot=false&showDataTableOrNot=false)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/52383/1727503461186-8086d8f3-25c6-4a77-837f-1d8791d3f3f3.png)\n\n [原因分析] 有进行黄金眼指标观察，9月9日当天拍立淘场景黄金眼监控指标一切正常，有验证变更改动点，确保新数据生效，否则召回无结果。\n ACTION：\n暂无\n\n#### 2、故障应急阶段\n**〖关注点4〗**是否有监控发现？若没有，为什么？（监控缺失/报警太多未及时处理/。。） \n请提供监控报警链接：[拍立淘业务场景黄金眼监控](https://goldeneye.alibaba-inc.com/#/myquery/detail/2750?dvs=%E6%8B%8D%E7%AB%8B%E6%B7%98&productLineId=1&dataAppId=373&metricIds=rank_pctr,rank_pcvr,valid_click,valid_cost,page,ad_pv,pvr,beta_pvr,alpha_pvr,adnum,beta_adnum,rank_tfr,rerank_ratio,pvr_valid_ratio,page_deep,RPMi,CTRi,PPC,alpha_adnum,tfr&timeSlice=60&statTimeSlice=60&startTime=2024-09-26%2000:00&endTime=2024-09-26%2023:55&compareType=1&displaytype=0&showLineChartOrNot&showAccLineChartOrNot=false&showDataTableOrNot=false)\n\n[原因分析] 由效果监控发现，存在10min延时。其中3min为故障判断，7min为故障上报。\n问题定位较久。img-vectrigger失败率由于历史biz迁移，报警失效，但由于预判报警生效，未关注到失败率指标变化原因。\n ACTION： \n\n1. 黄金眼故障上报已调整为3min，持续观察。img-vectrigger失败率监控需要补全。——潇劼，已完成\n2. 搜索业务场景核心监控进行整体摸排，避免出现类似监控失效的情况。——潇劼，已完成  \n\n\n**〖关注点5〗**相关角色的应急响应是否有改进空间？故障恢复方式是什么？是否可优化\n[原因分析] 有，故障恢复方式是恢复正常参数配置，问题发生在午饭时刻，众多相关同学不在工位导致排查较久。自动化发布需避开相关时间。\n ACTION：\n\n1. 实验平台调整自动回收任务触发时间。\n\n## 六、后续Action\n| **序号** | *******Action标题** | **Action描述** | *******负责人** | *******计划完成时间** | **验收标准** | **验收人** | **是否keyAction** | **是否回血Action** |\n| :---: | --- | --- | :---: | :---: | --- | :---: | :---: | :---: |\n| 1 | 平台发布记录优化 | whaleshark平台展现完整的发布记录，需包含回收任务，考虑支持搜索任务类型分类 | 劲昆 | 10.12 | 确保whaleshark平台展现的发布记录包含平台自动回收任务的记录 | 影书 | - | - |\n| 2 | 发布记录支持按场景筛选 | whaleshark平台支持按场景筛选发布记录 | 劲昆 | 待评估，节后跟进 | - | 潇劼 | - | - |\n| 3 | 平台自动回收执行时间优化 | whaleshark平台自动回收执行时间调整，回收时间点对标变更规范中的变更窗口期时间点，周一～周五10:00～20:00（避开12:00～14:00） | 劲昆 | 10.12 | 确保whaleshark平台自动回收执行时间调整为日常工作时间 | 欣洋 | - | - |\n| 4 | 增加QPS校验监控 | whaleshark平台自动回收机制删除环境前增加qps校验，如出现异常进行系统报警，将异常推送至实验平台的同学 | 劲昆 | 10.12 | 确保平台自动回收机制删除环境前增加qps校验，保证监控有效性 | 欣洋 | 是 | - |\n| 5 | 二进制实验发布优化 | 实验平台系统层面二进制实验不允许推base | 劲昆 | 10.12 | 确保系统层面不允许二进制实验推base | 影书 | 是 | - |\n| 6 | 宣导搜索算法团队变更发布规范 | 在团队内部宣",
    "chunk_order_index": 2,
    "full_doc_id": "doc-341d86b737e0960a0e89177167520855"
  },
  "chunk-68b360d5318fe11a9f1392e8ac9c9030": {
    "tokens": 560,
    "content": "删除环境前增加qps校验，保证监控有效性 | 欣洋 | 是 | - |\n| 5 | 二进制实验发布优化 | 实验平台系统层面二进制实验不允许推base | 劲昆 | 10.12 | 确保系统层面不允许二进制实验推base | 影书 | 是 | - |\n| 6 | 宣导搜索算法团队变更发布规范 | 在团队内部宣导强调按搜索算法团队变更发布规范严格执行。链接：[https://aliyuque.antfin.com/qf9pla/dx8mse/wylulut2lwakdw58](https://aliyuque.antfin.com/qf9pla/dx8mse/wylulut2lwakdw58) | 影书 | 09.30 | - | - | - | - |\n| 7 | 补全img-vectrigger失败率监控 | 黄金眼故障上报已调整为3min，持续观察。img-vectrigger失败率监控补全。 | 潇劼 | 已完成 | - | - | 是 | - |\n| 8 | 搜索业务场景核心监控整体摸排 | 搜索业务场景核心监控进行整体摸排，避免出现类似监控失效的情况。 | 潇劼 | 已完成 | - | - | - | - |\n\n\n\n\n## 七、故障相关方\n【故障等级】P5\n\n| **  系统质量（30%）** | | | | | **处置能力（70%）** |\n| :---: | --- | --- | --- | --- | :---: |\n| **相关方** | **需求设计** | **代码质量** | **变更质量** | **自定义项** | **发生时间** | **发现时间（30%）** | **恢复时间（40%）** |\n| 淘天集团-用户平台&阿里妈妈事业部-阿里妈妈-广告技术部-工程技术-效果引擎-搜索&直播广告引擎 | 不涉及 | 不涉及 | 不涉及 |  | 09-24 12:25 | 09-24 12:20 | 09-24 12:40 |\n| 淘天集团-用户平台&阿里妈妈事业部-阿里妈妈-广告技术部-广告算法-搜索广告-多模态 | 否 | 是 | 否 |  | 09-24 12:25 | 09-24 12:20 | 09-24 12:40 |",
    "chunk_order_index": 3,
    "full_doc_id": "doc-341d86b737e0960a0e89177167520855"
  },
  "chunk-757792cb349ec480db8e9bda375ec19d": {
    "tokens": 1200,
    "content": "## 一、故障简述\n于2024年9月13日09:02分开始广告技术部陆续收到有关无界9月12日下午开始不显示关键词操作记录的客诉，原因确认是日志中心计算任务问题修复变更及控制台已有错误叠加导致，仲古同学通过执行日志模板发布操作，业务于9月13日11:18分恢复。故障期间累计客诉23例。\n\n**APM故障链接：**\n\n [https://trfree.alibaba-inc.com/ormEmergency/workbench/emergency/202409130000000370001](https://trfree.alibaba-inc.com/ormEmergency/workbench/emergency/202409130000000370001)\n\n## 二、故障过程回顾\n### 2.1【时间线概览】\n![画板](https://intranetproxy.alipay.com/skylark/lark/0/2024/jpeg/80256396/1727161772185-b7c24e47-6b0f-4eaa-b455-8cbbc8ee6db2.jpeg)\n\n故障发现～初因定位：34min\n\n初因定位～故障恢复：57min\n\n### 2.2【故障处理时间线】\n#### **2.2.1【关键时间节点】**\n**2024-09-11 15:00**，BP 同学反馈 仅发布到预发环境的模板会影响线上环境，排查后确认是计算任务的环境隔离机制失效，该错误会导致生产环境加载预发环境的模板，并于当日下午 15 点左右修复完毕。**——【故障引入】**\n\n**2024-09-13 09:15**，广告技术部客满团队收到3例有关无界关键词操作记录9.12日下午开始不显示记录的客诉；**——【故障发生】**\n\n2024-09-13 09:46，广告技术部预警群收到有关无界关键词操作记录9.12日下午开始不显示记录的聚类客诉预警单；\n\n**2024-09-13 09:47**，[@迅决](undefined/luoyong.ly)[@三朝](undefined/zefan.wzf)接手预警单开始介入排查；**——【故障发现】【业务响应】**\n\n2024-09-13 09:51，[@崖飞](undefined/ruibo.hrb)联系[@叱云](undefined/zineng.yzn)协助排查有关操作日志丢失的问题；\n2024-09-13 10:12，[@田瑞发](undefined/trf01493578)反馈目前看是所有词的出价操作都没有日志；\n\n**2024-09-13 10:21**，[@叱云](undefined/zineng.yzn)定位到是日志中心计算任务内部错误，导致操作日志模板未加载，进而无法产生操作记录。联系[@仲古](undefined/zhonggu.qyc)回滚受影响模块；**——【初因定位】**\n\n**2024-09-13 10:35**，[@仲古](undefined/zhonggu.qyc)开始回滚第一个受影响模块；**——【恢复执行】**\n\n2024-09-13 10:40，三个受影响模块均已回滚完毕；\n2024-09-13 10:42，[@崖飞](undefined/ruibo.hrb)总结并同步当前进展：****\n\n原因定位：目前初步排查是草稿状态的模版被误生效到线上导致  \n修复进展：词的模版已恢复，新增的操作会正常记录；存量丢失数据需要[@叱云](undefined/zineng.yzn)尽最大可能进行回追；\n\n**2024-09-13 11:18**，[@仲古](undefined/zhonggu.qyc)与[@方川](undefined/yuanlingqiang.ylq)确认添加创意的模版，白名单新增479的SceneId这个可以直接推上去；**——【故障恢复】**\n\n2024-09-13 11:25，[@仲古](undefined/zhonggu.qyc)联系[@许乐](undefined/xule.qw)[@叱云](undefined/zineng.yzn)一同关注下11:10分依恋的反馈，关于预发按白名单配置的模板也有问题；\n2024-09-13 11:26，[@叱云](undefined/zineng.yzn)反馈正在排查，[@许乐](undefined/xule.qw)反馈应该是和之前环境隔离的变更相关，后续会同步具体原因；\n\n**2024-09-13 15:31**，[@叱云](undefined/zineng.yzn)反馈关键词缺失操作日志已回补完毕。**——【影响消除】**\n\n\n\n#### **2.2.2【故障详细时间点】**\n| **时间轴** | **事件** |\n| :---: | --- |\n| **2024-09-11 15:00** | **【故障引入】**BP 同学反馈 仅发布到预发环境的模板会影响线上环境，排查后确认是计算任务的环境隔离机制失效，该错误会导致生产环境加载预发环境的模板，并于当日下午 15 点左右修复完毕。**** |\n| **2024-09-13 09:15",
    "chunk_order_index": 0,
    "full_doc_id": "doc-23518dc92679402d0c82681a188157c6"
  },
  "chunk-ccc893d5af87e958d47f815d8fc03693": {
    "tokens": 1200,
    "content": "| :---: | --- |\n| **2024-09-11 15:00** | **【故障引入】**BP 同学反馈 仅发布到预发环境的模板会影响线上环境，排查后确认是计算任务的环境隔离机制失效，该错误会导致生产环境加载预发环境的模板，并于当日下午 15 点左右修复完毕。**** |\n| **2024-09-13 09:15** | **【故障发生】**广告技术部客满团队收到3例有关无界关键词操作记录9.12日下午开始不显示记录的客诉； |\n| 2024-09-13 09:46 | 广告技术部预警群收到有关无界关键词操作记录9.12日下午开始不显示记录的聚类客诉预警单；![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256396/1726742182303-f53a210b-a042-410f-b4db-ec6bac983cf4.png) |\n| **2024-09-13 09:47** | **【故障发现】**** ****【业务响应】**[@迅决](undefined/luoyong.ly)[@三朝](undefined/zefan.wzf)接手预警单开始介入排查； |\n| 2024-09-13 09:49 | [@崖飞](undefined/ruibo.hrb)创建应急群协同各团队同学对焦排查； |\n| 2024-09-13 09:51 | [@崖飞](undefined/ruibo.hrb)联系[@叱云](undefined/zineng.yzn)协助排查有关操作日志丢失的问题； |\n| 2024-09-13 09:55 | 测试同学[@田瑞发](undefined/trf01493578)提供trace ID：213e38f217261924757566315e5a19，反馈测试账号修改出价操作记录没显示出来；[@叱云](undefined/zineng.yzn)咨询[@崖飞](undefined/ruibo.hrb)这个改价对应哪个日志模板； |\n| 2024-09-13 09:57 | [@叱云](undefined/zineng.yzn)反馈如果是个别操作没有日志，大概率是模板有问题； |\n| 2024-09-13 09:58 | [@耕佣](undefined/luoyinxian.lyx)反馈模版没有对应的发布；![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256396/1726742518689-5e3e4f5d-1f10-421e-97b4-558a6eaf30e1.png) |\n| 2024-09-13 10:00 | [@耕佣](undefined/luoyinxian.lyx)反馈从去年上线来就没有动过，并发起语音会议开始对焦；![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256396/1726742557308-a7e74554-c6af-4cb0-a4cb-ee22d28d30a1.png) |\n| 2024-09-13 10:05 | [@依恋](undefined/yilian.cc)同步trace ID：215044dc17261930389262295e0aec |\n| 2024-09-13 10:06 | 客诉达到10+例升级为P5故障； |\n| 2024-09-13 10:12 | [@田瑞发](undefined/trf01493578)反馈目前看是所有词的出价操作都没有日志 |\n| 2024-09-13 10:16 | [@田瑞发](undefined/trf01493578)反馈以下内容没有操作日志；![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256396/1726742728949-5018b2dc-6f9c-44fb-841a-dc4d73731e88.png) |\n| **2024-09-13 10:21** | **【初因定位】**[@叱云](undefined/zineng.yzn)提供离线表 alimama_ods.ods_op_log_trace_log_mm；[@依恋](undefined/yilian.cc)反馈213e367017261940812266827ee2f2，加词；[@叱云](undefined/zineng.yzn)定位到是日志中心计算任务内部错误，导致操作日志模板未加载，进而无法产生操作记录。联系[@仲古](undefined/zhonggu.qyc)回滚受影响模块； |\n| 2024-09-13 10:32 | [@田瑞发](undefined/trf01493578)反馈pre-45 在预发针对该问题验证已修复，trace ID：2107968d17261946760313923e17dc； |\n| **2024-09-13 10:35** | **【恢复执行】**[@仲古](undefined/zhonggu.qyc)开始回滚第一个受影响模块； |\n| 2024-09-13 10:37 | [@仲古](undefined/zhonggu.qyc)反馈template Key :21 35 |\n| 2024-",
    "chunk_order_index": 1,
    "full_doc_id": "doc-23518dc92679402d0c82681a188157c6"
  },
  "chunk-bd65c36de46027b9d3a71e5f4602103c": {
    "tokens": 1200,
    "content": "，trace ID：2107968d17261946760313923e17dc； |\n| **2024-09-13 10:35** | **【恢复执行】**[@仲古](undefined/zhonggu.qyc)开始回滚第一个受影响模块； |\n| 2024-09-13 10:37 | [@仲古](undefined/zhonggu.qyc)反馈template Key :21 35 |\n| 2024-09-13 10:40 | [@仲古](undefined/zhonggu.qyc)反馈：37 -- 10:35    21 -- 10:37   45 -- 10:40![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256396/1726742920623-5e055036-f5b7-43af-8a72-bd28150215b3.png)![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256396/1726742943108-9c27d559-ccd8-4349-ac45-cd2c74f7d429.png)![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256396/1726742958574-237b8ca8-f397-4037-b30f-fefcc28400db.png) |\n| 2024-09-13 10:41 | [@仲古](undefined/zhonggu.qyc)反馈都处理完毕；![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256396/1726743026391-f89afdb1-bd4a-40b3-8831-e1e90f760898.png) |\n| 2024-09-13 10:42 | [@崖飞](undefined/ruibo.hrb)总结并同步当前进展：原因定位：目前初步排查是草稿状态的模版被误生效到线上导致   修复进展：词的模版已恢复，新增的操作会正常记录；存量丢失数据需要[@叱云](undefined/zineng.yzn)尽最大可能回追一下； |\n| 2024-09-13 10:46 | [@泽萱](undefined/zexuan.zzy)咨询词的模版修复完成的具体时间点； |\n| 2024-09-13 10:49 | [@仲古](undefined/zhonggu.qyc)同步第一个受影响模板回滚：10:35 第二个受影响模板回滚   10:37第三个受影响模板回滚  10:40 -- 止血完成 |\n| 2024-09-13 11:10 | [@依恋](undefined/yilian.cc)联系[@许乐](undefined/xule.qw)[@叱云](undefined/zineng.yzn)反馈修改计划名称，添加主体，解绑创意，刚才崖飞截图那些操作日志还是没有；并提供操作账号：bp测试075，修改计划名称，添加主体，删除人群，解绑创意无操作记录、bp测试023，店铺直达是修改计划名称，删除人群，解绑创意没有记录； |\n| 2024-09-13 11:13 | [@叱云](undefined/zineng.yzn)咨询具体是哪些key； |\n| 2024-09-13 11:14 | [@许乐](undefined/xule.qw)联系[@叱云](undefined/zineng.yzn)操作过滤预发中和开发中的；79 91 111 137 29； |\n| 2024-09-13 11:15 | [@仲古](undefined/zhonggu.qyc)根据11:10分依恋的反馈得出这部分白名单也有问题，开始处理；![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256396/1726743362480-5cace00f-c9fc-488d-be9f-175609b010d9.png) |\n| **2024-09-13 11:18** | **【故障恢复】**[@仲古](undefined/zhonggu.qyc)与[@方川](undefined/yuanlingqiang.ylq)确认添加创意的模版，白名单新增479的SceneId这个可以直接推上去； |\n| 2024-09-13 11:19 | [@仲古](undefined/zhonggu.qyc)咨询测试同学，记录是否已恢复； |\n| 2024-09-13 11:22 | 测试同学反馈记录已恢复； |\n| 2024-09-13 11:25 | [@仲古](undefined/zhonggu.qyc)联系[@许乐](undefined/xule.qw)[@叱云](undefined/zineng.yzn)一同关注下11:10分依恋的反馈，关于预发按白名单配置的模板也有问题； |\n| 2024-09-13 11:26 | [@叱云](undefined/zineng.yzn)反馈正在排查，[@许乐](undefined/xule.qw)反馈应该是和之前环境隔离的变更相关，后续[@叱云](undefined/zineng.yzn)会",
    "chunk_order_index": 2,
    "full_doc_id": "doc-23518dc92679402d0c82681a188157c6"
  },
  "chunk-8a7bbcac20e1f29e86fb080ecbcc0231": {
    "tokens": 1200,
    "content": "eng.yzn)一同关注下11:10分依恋的反馈，关于预发按白名单配置的模板也有问题； |\n| 2024-09-13 11:26 | [@叱云](undefined/zineng.yzn)反馈正在排查，[@许乐](undefined/xule.qw)反馈应该是和之前环境隔离的变更相关，后续[@叱云](undefined/zineng.yzn)会同步具体原因； |\n| **2024-09-13 15:31** | **【影响消除】**[@叱云](undefined/zineng.yzn)反馈关键词缺失操作日志已回补完毕。 |\n\n\n\n\n\n## 三、影响产品线&影响面\n    - [x] 是否有客诉量：\n        * 故障期间累计客诉量：23例（去重后）\n\n[0913客诉记录.xlsx](https://yuque.antfin.com/attachments/lark/0/2024/xlsx/147156506/1731031181779-73b98106-2a1a-4b9a-92a9-695bc4c7f69a.xlsx)\n\n    - [ ] 是否产生资损：\n        * 无\n\n## 四、故障原因\n### 4.1【一句话原因】\n日志中心计算任务内部错误，导致操作日志模板未加载，进而无法产生操作记录。\n\n### 4.2【详细原因】\n几个概念：\n\n    1. **日志模板**——用于渲染操作记录\n    2. 日志模板的**环境**——用户环境隔离\n    3. 日志模板的**版本号**——每个模板在每个环境都有多个版本，方便回滚\n    4. 日志模板的**当前版本**——模板的最新版本\n    5. 日志模板的**激活版本**——**环境**（预发、生产）下某一日志模板**被激活的版本号**，用于确定哪个版本承接流量。\n\n日志模板 + 版本号 构成一条唯一记录。\n\n11 日下午，BP 同学反馈 **仅发布到预发环境的模板会影响线上环境**，排查后确认是**计算任务**的**环境隔离机制**失效（记为**错误 A**），更具体的原因为计算任务环境区分代码存在错误，历史问题；该错误会导致**生产环境加载预发环境的模板**，并于当日下午 15 点左右修复完毕。\n整个日志中心的环境隔离机制，有两部分配合完成，即 **计算任务** +** 开发控制台**。在问题排查过程中发现，开发控制台的部分逻辑也存在错误（记为**错误 B**），历史问题。该错误会导致：将**当前版本**发布到**预发环境**，会将**所有环境**的**激活版本**设置为**当前版本**——这显然是不正确的，因为此时**生产环境**并没有这个版本的模板。错误 B 已于 13 日上午 11 时左右修复，修复方案为仅设置目标环境（而不是所有环境）的激活版本。\n\n因此，在**只修复了错误 A** 而**没有修复错误 B**，且**没有执行止血动作**的情况下，就会出现模板无法加载进而无法产生操作记录的问题。举例说明：\n\n假设：模板 T 的**当前版本**为 **X** 且该模板**仅发布**到了**预发**，则模板 T 在**预发**和**生产**环境的**激活版本**均为 **X**（错误 B 导致）。此时，**生产**环境的**计算任务**查询到模板 T 在**生产**环境的**激活版本**为 **X**，然后尝试通过模板 T + **X** **版本号**查询数据，但查询结果为空（因为生产环境并没有这个版本的模板），从而导致模板加载失败，进而导致操作记录丢失。\n\n如果**没有修复错误 A** 且**没有修复错误 B**（11 日下午 15 点前的情况），则由于**错误 A**，导致即使**错误 B **存在，模板 T 的 X 版本也能在生产环境加载（实际上加载的是预发环境的 X 版本）。\n\n如果在**修复了错误 A **的情况下，执行止血动作，即：发布模板至生产环境，则可将在计算任务“尝试通过模板 T + **X** **版本号**查询数据”时，查询出结果，进而止血。\n\n综上所述，该问题是由**仅修复错误 A 而没有修复错误 B **导致的，但如果不修复错误 A，会导致更严重的问题，即**环境隔离完全失效，预发开发配置污染线上数据**。\n\n附：\n\n错误 A 修复 commit：[https://code.alibaba-inc.com/alimama-app-platform/ad-oplog/commit/76a258af7208fffaca7fcd7fd9c30c0ff1e4aa3c](https://code.alibaba-inc.com/alimama-app-platform/ad-oplog/commit/76a258af7208fffaca7fcd7fd9c30c0ff1e4aa3c)\n\n错误 B 修复 commit：[https://code.alibaba-inc.com/alimama-app-platform/ad-oplog/commit/87f9a969e11ef30a2862cf6c8e7a898adc",
    "chunk_order_index": 3,
    "full_doc_id": "doc-23518dc92679402d0c82681a188157c6"
  },
  "chunk-fa204f2095eab2f110f2f9902586834d": {
    "tokens": 1200,
    "content": "9c30c0ff1e4aa3c](https://code.alibaba-inc.com/alimama-app-platform/ad-oplog/commit/76a258af7208fffaca7fcd7fd9c30c0ff1e4aa3c)\n\n错误 B 修复 commit：[https://code.alibaba-inc.com/alimama-app-platform/ad-oplog/commit/87f9a969e11ef30a2862cf6c8e7a898adc18ec0b](https://code.alibaba-inc.com/alimama-app-platform/ad-oplog/commit/87f9a969e11ef30a2862cf6c8e7a898adc18ec0b)\n\n\n\n## 五、关注点讨论\n#### 1、问题引入阶段\n【在/离线变更代码开发完成后，需要经过**code review**确认无误后进行合并**代码主干**提交】--红线点\n【在线变更代码修改提交必须经过**功能单测；**离线变更代码修改完成后，生成的离线数据必须要经过**数据校验**】--红线点\n\n**〖关注点1〗**是否有经过CR？是否有经过单测？是否有经过测试？是否自动化测试可覆盖？测试阶段为何没发现？\n请提供CR链接：日志中心计算任务为鹊桥任务，发布动作均在鹊桥平台而非 Aone，CR 均在线下执行（线下和团队同学沟通）\n [原因分析]发布前已在预发环境并进行测试，但由于上述的错误 B 会导致模板一定会发布到预发（即预发环境模板存在），因此预发环境操作日志一定不会缺失。\n ACTION：\n\n1. 宣导效果BP团队变更规范：后续鹊桥平台的发布也需要严格按变更规范中的CR流程执行。——负责人：许乐，预计：09.29\n2. backup 同学培养。（团队人员培养计划，不作为action记录）\n3. 日志中心核心模版需要补充至自动化测试内容中，涉及词相关的模版均已补充。————负责人：依恋，已完成\n4. 日志中心核心模版需要补充至自动化测试内容中，进一步梳理并补充与钱相关的增删改有关的核心模版，完善日常巡检测试用例（针对人群、关键词、货品运营场景主流程增删改模块先进行补充）。——负责人：依恋     预计：10.14     验收人：落葵\n\n【生产变更，**务必要经过灰度发布**，灰度发布时间**间隔大于20min****】**--红线点\n\n**〖关注点2〗**是否变更窗口期进行发布？是否经过灰度？分机房或分批发布第一批发布时间间隔是否大于20分钟？灰度过程中为何未发现问题？\n请提供ChangeFree变更单链接：[https://aicf.alibaba-inc.com/aicf/change/v2/detail/1229908272?spm=goc-apm.aicf-_changeList.0.0.2b5b2388btzhx5](https://aicf.alibaba-inc.com/aicf/change/v2/detail/1229908272?spm=goc-apm.aicf-_changeList.0.0.2b5b2388btzhx5)\n\n [原因分析]日志中心的发布平台为鹊桥平台，暂不支持灰度或分批发布。\n ACTION：\n\n说明：鹊桥平台将于S2财年支持分批发布。\n\n\n\n**【****黄金眼指标观察**，10分钟左右，观察已发布**本机房、核心pid、分广告主体类型**的黄金眼业务指标】--红线点\n\n**【****变更改动点验证**，验证已变更的**功能逻辑&数据已经生效**(最好有直接或间接生效截图记录)**】**--红线点\n\n**〖关注点3〗**是否进行黄金眼指标观察，观察是否发现问题？是否验证变更改动点，验证是否发现问题？\n\n请提供观测链接：[https://kmonitor2.alibaba-inc.com/d/0IUzXbUMz/queqiao-blink-drc?orgId=1&var-taskName=entity_modify_log_consume_job_20240911154544](https://kmonitor2.alibaba-inc.com/d/0IUzXbUMz/queqiao-blink-drc?orgId=1&var-taskName=entity_modify_log_consume_job_20240911154544)\n\n [原因分析]日志中心计算任务均不涉及黄金眼指标，日志中心计算任务的系统监控指标（消费延迟、fallover 等）一切正常。\n ACTION： 无\n\n#### 2、故障应急阶段\n**〖关注点4〗**是否有监控发现？若没有，为什么？（监控缺失/报警太多未及时处理/。。） \n请提供监控报警链接：\n[原因分析]本次系统指标正常，缺失业务指标相关监控。\n ACTION：\n\n1. 短期：DQC离线同环比监控：日志中心整体小时级别的整体量级监控。——负责人：叱云     预计：10.14    验收人：许乐\n2. 长期：业务型监控建设，针对日志输出量分析（可根据场景、操作",
    "chunk_order_index": 4,
    "full_doc_id": "doc-23518dc92679402d0c82681a188157c6"
  },
  "chunk-23b10dc6b96b2cf90b411b62355fcf2d": {
    "tokens": 965,
    "content": "监控报警链接：\n[原因分析]本次系统指标正常，缺失业务指标相关监控。\n ACTION：\n\n1. 短期：DQC离线同环比监控：日志中心整体小时级别的整体量级监控。——负责人：叱云     预计：10.14    验收人：许乐\n2. 长期：业务型监控建设，针对日志输出量分析（可根据场景、操作类型等进行分析），新增日志中心计算任务流量波动监控。——负责人：叱云     预计：10.31   验收人：许乐\n\n**〖关注点5〗**相关角色的应急响应是否有改进空间？故障恢复方式是什么？是否可优化\n[原因分析]故障恢复方式：将无界关键词操作记录场景的修改计划名称、新建主体、移除定向、解绑创意等相关有预发版本的模板全部重新发布到正式环境，保障预发与生产环境日志版本一致性，无优化空间。\n ACTION：无\n\n## 六、后续Action\n| **序号** | *******Action标题** | **Action描述** | *******负责人** | *******计划完成时间** | **验收标准** | **验收人** | **是否keyAction** | **是否回血Action** |\n| :---: | --- | --- | :---: | :---: | --- | :---: | :---: | :---: |\n| 1 | 短期：宣导效果BP团队变更规范 | 后续鹊桥平台的发布也需要严格按变更规范中的CR流程执行。在团队内部与新老同学宣讲效果BP团队变更规范，并要求大家严格遵守并执行。 | 许乐 | 09.30 | - | - | - | - |\n| 2 | 短期：巡检任务中增加词模版用例case | 日志中心核心模版需要补充至自动化测试内容中，补充本次场景中涉及词相关的模版。 | 依恋 | 已完成 | - | - | 是 | - |\n| 3 | 短期：梳理并补充主流程核心模块测试用例 | 日志中心核心模版需要补充至自动化测试内容中，进一步梳理并补充与钱相关的增删改有关的核心模版，完善日常巡检测试用例，针对人群、关键词、货品运营场景主流程增删改模块先进行补充。 | 依恋 | 10.14 | 确保日常巡检任务中补充人群、关键词、货品运营场景主流程增删改模块。 | 落葵 | - | - |\n| 4 | 短期：新增DQC离线同环比监控 | 确保日志中心新增小时级别的整体量级同环比监控。 | 叱云 | 10.14 | 确保监控规则合理性和有效性。 | 许乐 | 是 | - |\n| 5 | 长期：新增日志中心计算任务流量波动监控 | 业务型监控建设，针对日志输出量分析（可根据场景、操作类型等进行分析），新增日志中心计算任务流量波动监控。 | 叱云 | 10.31 | 确保日志中心计算任务流量波动监控建设完毕，并配置有效的报警规则。 | 许乐 | 是 | - |\n\n\n\n\n## 七、故障相关方\n【故障等级】P5\n\n| **  系统质量（30%）** | | | | | **处置能力（70%）** |\n| :---: | --- | --- | --- | --- | :---: |\n| **相关方** | **需求设计** | **代码质量** | **变更质量** | **自定义项** | **发生时间** | **发现时间（30%）** | **恢复时间（40%）** |\n| 淘天集团-用户平台&阿里妈妈事业部-阿里妈妈-广告技术部-工程技术-应用平台-业务平台 | 不涉及 | 是 | 是 |  | 09-13 09:15 | 09-13 09:47 | 09-13 11:18 |\n\n\n  \n\n\n###",
    "chunk_order_index": 5,
    "full_doc_id": "doc-23518dc92679402d0c82681a188157c6"
  },
  "chunk-74818a022166fea183348b3c8eeea5d4": {
    "tokens": 1200,
    "content": "## 一、故障简述\n2024年9月2日14:25监控预警四海通推广发券成功率下跌，随后签到、优惠扣减、机票提交订单、互动玩法陆续预警，故障原因初步确认是玩法数据库异常导致，于14:43通过数据库切换备库完成止血，故障恢复，期间产生5例客诉，根据监控下跌幅度判定达P4故障等级。\n\n## 二、影响产品线及影响面\n- [x] 是否影响可用性：否\n- [x] 业务影响：\n\n| **业务场景** | **影响面** | **是否触发故障** | **影响时段** |\n| --- | --- | :---: | :---: |\n| 四海通发券推广成功率下跌 | 玩法数据库连接异常，导致四海通调用玩法预发券接口全部超时失败 | P4 | 14:23-14:40成功率持续<80%![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/41240/1725866582340-e176b250-0d44-4d2d-aa73-06f1087d1254.png) |\n| 飞猪签到动作接口总量异常   | ****签到接口调用失败，用户无法签到   | P4 | 14:23-14:41成功率持续<80%![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/41240/1725867580766-8bb49c38-0d32-461a-af0b-fc3117adee40.png) |\n| 飞猪互动玩法兑换成功率异常 | 玩法数据库异常导致   | P4 | 14:23-14:41成功率持续<60%![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/41240/1726297769466-38503ec0-72a4-4b7c-aea1-1815ac5d9cea.png) |\n| 飞猪国内机票提交订单异常 | 平台玩法数据库连接异常，导致机票调用玩法机酒签约接口异常  | 未触发 | 14:23-14:42![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/41240/1726297576519-100892b3-b2ee-4544-ae9d-7be798cb8b15.png) |\n| 优惠扣减失败 | 玩法数据库异常导致返现下单创建履约单失败 | 未触发 | 14:23-14:41![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/41240/1725867470631-637874a0-4185-4dc0-9bcb-44a66bdd7582.png) |\n\n\n- [x] 是否有客诉：5个工单（其中签到3个投诉单）\n- [x] 是否有社会舆情_：_否\n- [x] 是否产生资损：否\n\n## 三、故障过程回顾\n2024-05-23 18:05 [@翊霖](undefined/yilin.yy) 创建了结构设计，工单号：31672927，变更内容：将以下三张表的need_delete字段类型从bit(1)变更成tinyint，ALTER TABLE `user_award_detail_0896` MODIFY COLUMN `need_delete` tinyint NOT NULL DEFAULT 1[关注点1](#YyW4d)；当时dms任务一直显示“iDB-OnlineDDL Execute Error:任务终止 - [数据校验失败] 请在低峰期重试任务，或暂时关闭实例上的无锁结构变更选项，采用原生DDL执行。 TraceId : 2108d37217164667826773862de87a”\n2024-05-23 20:29，[@翊霖](undefined/yilin.yy) 提交了aone工单（工单号：[57021694](https://aone.alibaba-inc.com/v2/project/959292/bug/57021694# 《做表类型变更时，报iDB-OnlineDDL Execute Error》)）咨询，DBA清蓝建议写sql做普通数据变更，用数据库原生online DDL，增加字段或修改字段类型这种操作，会短暂锁表，执行期间不影响DML，但实际操作下来无法执行任务，再次与DBA清蓝确认，建议联系DMS值班同学。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/181189/1725330865531-8b095bbe-3cb7-4779-aa55-3b9ef7f0aa34.png?x-oss-process=image%2Fformat%2Cwebp%2Fresize%2Cw_1020%2Climit_0)![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/181189/1725330887995-751544cd-194f-4670-8dfa-37b6aae5da05.png?x-oss-process=image%2Fformat%2Cwebp%2Fresize%2Cw_996%2Climit_0)\n\n![](https://intranetproxy.al",
    "chunk_order_index": 0,
    "full_doc_id": "doc-b306c38cdfe24b422edfba1fd35c58af"
  },
  "chunk-254c91ab9228abacd294fb74ae6f70f4": {
    "tokens": 1200,
    "content": "1020%2Climit_0)![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/181189/1725330887995-751544cd-194f-4670-8dfa-37b6aae5da05.png?x-oss-process=image%2Fformat%2Cwebp%2Fresize%2Cw_996%2Climit_0)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/181189/1725330907527-68e0bd43-c2f0-47cf-b892-c26ef1bff748.png?x-oss-process=image%2Fformat%2Cwebp%2Fresize%2Cw_1009%2Climit_0)\n\n2024-05-24 17:53，[@翊霖](undefined/yilin.yy) 群里咨询了DMS同学，DMS回复关闭无锁原生执行或低峰期重试，除此之外没有更好的办法。开发进一步确认使用mysql原生ddl执行是否会锁表，说DBA回复不影响DML，DMS回复以DBA信息为准，最终开发选择关闭无锁原生执行，开始执行字段变更\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/181189/1725331002377-b18ca954-9eb9-43eb-870f-ef6dd55e4ded.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/181189/1725331019525-c529fbd5-4aea-46b2-966d-ade1c80c29e2.png)\n\n2024-05-24 18:19，[@翊霖](undefined/yilin.yy) 开始执行字段变更的任务，发现任务执行期间任务锁表造成了业务失败率升高，故停止任务(停止任务后业务成功率立即恢复)，计划低峰期执行\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/181189/1726980061781-f3733ed9-7a17-493e-8759-8693bb17a361.png)\n\n2024-05-24 23:01，[@翊霖](undefined/yilin.yy) 继续执行字段变更的任务，发现仍然锁表影响业务成功率，故决定放弃执行字段变更，通过新加字段 tinyint(3) unsigned 来支持业务需求\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/181189/1726980184631-b527ebc8-073b-4968-9192-bfe001dea21b.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/181189/1725331199243-2b622780-133e-4068-9169-f5589992763e.png)\n\n2024-08-16 11:30左右，备库突然挂了，备库重启后发现数据库表dms上的拓扑有问题了，群里面咨询了，也提了工单(59409382)。DMS表示是分表不一致导致的，现在无论是回滚还是继续推进任务变更完成，都可能会影响业务，需要开发和DBA一起看看选择哪种方案，DMS负责给出方案可执行的方式。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/181189/1725331974624-a63a1d83-5fc0-4b5d-8ac6-e657bfeadc63.png?x-oss-process=image%2Fformat%2Cwebp%2Fresize%2Cw_1125%2Climit_0)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/181189/1725331857776-5e0d4041-84aa-48f6-b6ff-fc3432550b16.png?x-oss-process=image%2Fformat%2Cwebp%2Fresize%2Cw_1125%2Climit_0)![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/181189/1725331221456-c1a0daec-68f6-42a8-ab80-f5cd5f703b9e.png?x-oss-process=image%2Fformat%2Cwebp%2Fresize%2Cw_1056%2Climit_0)![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/181189/1725331510766-81748ea5-6ab5-4a9e-ba1d-ea0c7309b811.png?x-oss-process=image%2Fformat%2Cwebp%2Fresize%2Cw_1006%2Climit_0)\n\n2024-09-02 14:20，[@翊霖](undefined/yilin.yy) 想看一下这个工单的报错错误，重试了工单，发现任务开始执行了，并且线上报警了，14:21立刻关闭了任务，当时以为会自动恢复，结果主",
    "chunk_order_index": 1,
    "full_doc_id": "doc-b306c38cdfe24b422edfba1fd35c58af"
  },
  "chunk-d04447a1ae2e7bdaa318cb7aad53fcc8": {
    "tokens": 1200,
    "content": "-oss-process=image%2Fformat%2Cwebp%2Fresize%2Cw_1006%2Climit_0)\n\n2024-09-02 14:20，[@翊霖](undefined/yilin.yy) 想看一下这个工单的报错错误，重试了工单，发现任务开始执行了，并且线上报警了，14:21立刻关闭了任务，当时以为会自动恢复，结果主库数据库连接池慢了**【风险注入】**\n\n2024-09-02 14:25，飞猪_四海通推广发券成功率下跌预警**【故障发现】**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/41240/1725852174551-df9c4d5e-6a73-4fdf-b044-ed6407145030.png)\n\n2024-09-02 14:26，飞猪签到动作接口总量异常&飞猪_营销优惠扣减异常预警\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/41240/1725852484828-ff23d3d4-cf18-4e60-893b-bba83fd36da1.png)![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/41240/1725852619282-0fb5a448-d47f-4d39-baab-b2a4e0a2efcc.png)\n\n2024-09-02 14:29，飞猪国内机票_提交订单异常预警\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/41240/1725852731401-273ebf1c-c497-4c83-8536-ea32362b8ed3.png)\n\n2024-09-02 14:32，飞猪_互动玩法兑换成功率异常预警，同时飞猪签到动作接口总量成功率持续10分钟小于等于80%，触发P4故障**【故障发生】**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/41240/1725852752812-caac29b2-730c-41a0-acde-c25a30ed5141.png)\n\n2024-09-02 14:33,  发现DMS任务停止后，业务一直未恢复，开始尝试联系DBA**【业务响应】**\n\n2024-09-02 14:36，联系DBA帮忙切换备库**【恢复执行】**\n\n2024-09-02 14:43，备库启动，业务基本恢复**【故障恢复】**\n\n2024-09-05 14:20，dms上点击暂停任务后，底层DB没接收到这个请求，从而server层的字段变更执行未停止，从而导致业务表更新请求无法执行进而等待，直到把线程池打满**【初因定位】**\n\n## 四、故障原因\n##### 一句话原因：\n数据库原生online DDL 对字段类型如：bit到tinyint的修改，是会在执行期间锁表的，在此期间所有的dml操作都会被拒止掉，此时业务的更新SQL在锁表期间无法获取到锁，进而开始进行锁等待，大量活跃链接无法释放，直到将连接池打满。\n\n##### 根因分析：\nDDL期间锁表，所有业务更新都被拒止。\n\n## 五、关注点分析\n###### 1、变更表类型中写的是要变更3张表的字段类型，但语句中只写到了0896这张表的报错，是另外两张表已经变更成功了吗？\n答：都没有完全变更成功，3张表都是执行了一部分。\n\n###### 2、为何第一次执行任务线上数据库报错后很快恢复，没有造成数据库连接池满的问题？\n答：连接池满过程是：DDL导致表被锁住，有大量对此表的DML操作，会出现等MDL锁，但此时活跃连接不会释放，活跃线程持续上涨直至达到上限，此时DMS再进行暂停的kill query请求在建连时会失败。所以第一次执行暂停时，一定是活跃连接未达上限，DMS的kill连接能正常建立并执行。\n\n###### 3、9月2日10点40还未得出结论后，为何要再次看工单的报错错误？\n答：由于dms拓扑不统一之后，当时得出的结论是必须将这个任务执行完，清蓝老师又怀疑不会长时间锁表；而之前几次执行时任务停止后，业务立即能恢复；所以希望重新执行一下然后立即停止，看是否这次能不锁表了。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/181189/1725331510766-81748ea5-6ab5-4a9e-ba1d-ea0c7309b811.png?x-oss-process=image%2Fformat%2Cwebp%2Fresize%2Cw_1006%2Climit_0%2Fresize%2Cw_1006%2Climit_0)\n\n###### 4、DMS暂停失败的原因是什么? 任务状态显示不正常会误导开发，建议优化。",
    "chunk_order_index": 2,
    "full_doc_id": "doc-b306c38cdfe24b422edfba1fd35c58af"
  },
  "chunk-a93c5761515d2bed9ebb732237d6b2fa": {
    "tokens": 1200,
    "content": "48ea5-6ab5-4a9e-ba1d-ea0c7309b811.png?x-oss-process=image%2Fformat%2Cwebp%2Fresize%2Cw_1006%2Climit_0%2Fresize%2Cw_1006%2Climit_0)\n\n###### 4、DMS暂停失败的原因是什么? 任务状态显示不正常会误导开发，建议优化。\n答：DMS需要新建连接来中断原来的SQL，但这个时候因为数据库的连接池已打满，新的连接无法被执行，导致暂停失败。关于DMS状态展示正确的需求，由[@相勖](undefined/xukai.xu)带回给DMS同学进行优化。\n\n###### 5、现在引发问题的任务是中止状态，后续该如何操作，继续推进变更完成还是回滚？\n答：把原表的bit字段drop掉即可，目前已经在执行当中了，每晚低峰期执行。drop任务全部执行完毕后，需要联系DMS刷新拓扑，关闭原生执行。[@翊霖](undefined/yilin.yy) \n\n###### 6、飞猪目前很多表都有json的情况，后续该如何避免这种情况再次发生？\n答：[@相勖](undefined/xukai.xu)已经提交了aone需求（[链接](https://aone.alibaba-inc.com/v2/project/794481/req/59112035)），目前处于排期中状态：\n\n1. 集团全网扫描未开 DMS online ddl配置的实例，并重新开启\n2. 关闭dms online ddl 操作需要设置为会话级，会话结束后恢复为无锁\n3. 有锁变更调整为高风险，增加审批流程控制\n\n### 5.1【系统质量】\n#### 5.1.1 需求&设计评估--不涉及\n**〖关注点1〗****是否涉及产品、技术方案评估？此核心的问题是什么，如何改进？**\n\n- [ ] **是，涉及**\n    - [ ] 需求评估遗漏\n    - [ ] 产品设计缺陷\n    - [ ] 系统架构设计缺陷\n        - [ ] 容错性不足 \n        - [ ] 单点，无冗余\n        - [ ] 缺乏自我保护\n        - [ ] 缓存设计不当\n        - [ ] 容量评估不足\n        - [ ] 非幂等设计\n        - [ ] 强弱依赖不合理\n        - [ ] 其他：__________\n- [ ] 否，不涉及\n\n**〖问题总结〗**\n\n**〖改进点〗**_**需明确写明不同故障相关方的改进项（若有的话），下同。**_\n\n\n\n#### 5.1.2 代码质量--不涉及\n**〖关注点1〗是否代码自身存在漏洞或BUG、代码健壮性是否存在问题等?**\n\n**〖问题分析〗**\n\n**〖改进点〗**_**需明确写明不同故障相关方的改进项（若有的话），下同。**_\n\n\n\n\n\n**〖关注点2〗****是否经过CodeReview？CodeReview阶段是否发现问题？为何没发现？**\n\n+ **是否经过CR**\n    - [ ] 是\n    - [ ] 否\n    - [ ] 不涉及\n+ **是否设置合理的CR卡点**\n    - [ ] 是\n    - [ ] 否\n    - [ ] 不涉及\n+ **CodeReview阶段是否发现问题？为何没发现？后续如何发现？**\n    - [ ] 是\n    - [ ] 否\n    - [ ] 不涉及\n\n**〖问题分析〗******\n\n**〖改进点〗**_**需明确写明不同故障相关方的改进项（若有的话），下同。**_\n\n\n\n\n\n**〖关注点3〗****测试阶段**\n\n+ **测试内容：**涉及的测试提交单、测试用例等\n+ **测试人员：**\n+ **是否经过测试验证**\n    - [ ] 是，验证环境\n        - [ ] 预发环境\n        - [ ] 日常环境\n    - [ ] 是，测试方法\n        - [ ] 单元测试\n        - [ ] 功能回归测试\n        - [ ] 集成测试/链路测试\n        - [ ] 验收测试\n    - [ ] 否\n    - [ ] 不涉及\n+ **测试未发现原因是什么？后续如何改进？**\n    - [ ] 回归测试遗漏\n        - [ ] 手工回归测试用例遗漏\n        - [ ] 自动化未建设\n        - [ ] 自动化回归覆盖不足\n        - [ ] 其他：__________\n    - [ ] 新场景测试遗漏\n        - [ ] 功能测试用例遗漏，包括正常分支和异常分支\n        - [ ] 容灾兜底测试遗漏\n        - [ ] 客户端兼容性测试遗漏\n        - [ ] 埋点测试遗漏\n        - [ ] 性能测试遗漏，影响评估不足\n        - [ ] 安全测试遗漏\n    - [ ] 其他：__________\n\n**〖问题总结〗**\n\n**〖改进点〗**_**需明确写明不同故障相关方的改进项（若有的话），下同。**_\n\n\n\n#### 5.1.3 变更",
    "chunk_order_index": 3,
    "full_doc_id": "doc-b306c38cdfe24b422edfba1fd35c58af"
  },
  "chunk-3368d1c56cbc8118fa052bae54698c18": {
    "tokens": 1200,
    "content": "端兼容性测试遗漏\n        - [ ] 埋点测试遗漏\n        - [ ] 性能测试遗漏，影响评估不足\n        - [ ] 安全测试遗漏\n    - [ ] 其他：__________\n\n**〖问题总结〗**\n\n**〖改进点〗**_**需明确写明不同故障相关方的改进项（若有的话），下同。**_\n\n\n\n#### 5.1.3 变更质量--不涉及\n+ **是否涉及变更：**\n    - [ ] 是\n    - [ ] 否\n+ **变更类型：**\n    - [ ] 代码发布\n    - [ ] 配置变更\n    - [ ] 其他变更：____________\n    - [ ] 不涉及\n+ **变更平台是否接入ChangeFree：**\n    - [ ] 是，CF变更单链接：________\n    - [ ] 否\n+ **是否违反变更红线3.1 **[链接](https://aliyuque.antfin.com/trecs/fzg6dy/uar1k6)\n    - [ ] 是，违反哪条原则：\n    - [ ] 否\n\n\n\n**〖关注点1〗****灰度阶段**\n\n+ **是否经过灰度：**\n    - [ ] 是\n    - [ ] 否\n+ **观测了哪些监控**：_可以附链接_\n    - [ ] 黑屏、白屏\n    - [ ] GOC监控：\n    - [ ] 系统大盘：\n    - [ ] 其他：___________\n+ **是否灰度期间发现问题？**\n    - [ ] 是\n        - [ ] 是否灰度流量过大，导致故障\n        - [ ] 灰度发现但未有效或及时修复，导致故障\n        - [ ] 其他：___________\n    - [ ] 否，后续如何灰度发现？_____________\n+ **未灰度发现原因**\n    - [ ] 应用灰\n        - [ ] 灰度流量太小\n        - [ ] 灰度阶段无监控\n        - [ ] 灰度批次不合理\n        - [ ] 超长时间灰度才能发现\n    - [ ] 业务灰：策略不合理\n    - [ ] 灰度无法发现\n    - [ ] 其他：_____________\n\n**〖问题总结〗**\n\n**〖改进点〗**_**需明确写明不同故障相关方的改进项（若有的话），下同。**_\n\n\n\n\n\n**〖关注点2〗****上线阶段**\n\n+ **是否有确定的监控观测指标**\n    - [ ] 是，监控指标及监控链接：\n    - [ ] 否\n+ **是否在窗口期进行发布变更**\n    - [ ] 是\n    - [ ] 否，原因：\n+ **变更是否影响上下游**\n    - [ ] 是，是否有提前知会上下游评估及关注变更\n        - [ ] 有提前知会\n        - [ ] 没有提前知会\n    - [ ] 否\n\n**〖问题总结〗**\n\n**〖改进点〗**_**需明确写明不同故障相关方的改进项（若有的话），下同。**_\n\n1、\n\n### 5.2【处置能力】\n#### 5.2.1 故障发现&响应\n+ **是否监控发现**\n    - [ ] 故障触发方 监控发现\n    - [x] 故障受影响方 监控发现\n    - [ ] 否，原因为：（监控无效/监控缺失）\n+ **是否5分钟内响应**\n    - [x] 是\n    - [ ] 否，原因为：\n+ **是否存在应急协同问题**\n    - [ ] 是\n        - [ ] 应急流程不明确（无流程或者流程不清晰、应急相关角色&职责不明确，缺失一号位等)\n        - [ ] 应急执行不到位（有流程，但未按流程执行，通告发送不及时，响应不及时等）\n    - [x] 否\n\n#### 5.2.2 故障定位&恢复\n+ **主要恢复方式：**\n    - [ ] 代码发布/回滚\n    - [ ] 配置发布/回滚\n    - [ ] 数据订正\n    - [ ] 机器隔离/重启/扩容\n    - [ ] 配置限流\n    - [ ] 预案降级\n    - [ ] 自动恢复\n    - [x] 其他：数据库主备切换\n\n**〖关注点1〗定位&恢复阶段存在什么问题？是否可以增加预案，****有更快的恢复方式？****相关的优化改进？**\n\n**〖问题总结〗**暂无问题\n\n## 六、故障Action\n| **序号** | *******Action** | *******负责人** | *******计划完成时间** | **是否keyAction** |\n| :---: | --- | --- | --- | --- |\n| 1 | 短期：DMS任务状态提示优化，显示正确状态 |  [@相勖](undefined/xukai.xu) | 待定 |  |\n| 2 | 短期：提供飞猪所有关闭无锁配置的数据库状态离线表 |  [@相勖](undefined/xukai.xu) |   10",
    "chunk_order_index": 4,
    "full_doc_id": "doc-b306c38cdfe24b422edfba1fd35c58af"
  },
  "chunk-c7b84a98138679a0e4984e0aa01fdb58": {
    "tokens": 440,
    "content": "**是否keyAction** |\n| :---: | --- | --- | --- | --- |\n| 1 | 短期：DMS任务状态提示优化，显示正确状态 |  [@相勖](undefined/xukai.xu) | 待定 |  |\n| 2 | 短期：提供飞猪所有关闭无锁配置的数据库状态离线表 |  [@相勖](undefined/xukai.xu) |   10.11 | 是 |\n| 3 | 短期：DMS Online DDL支持json需求评估 | [@相勖](undefined/xukai.xu) 927提需求和[@清蓝](undefined/xiaojingfu.xjf)一起与DMS沟通后给出结论 | 需求已提aone（[链接](https://aone.alibaba-inc.com/v2/project/794481/req/59976504)） |  |\n\n\n## 七、故障定级&定责&故障分自查\n【故障等级】P4\n\n【故障责任方】飞猪-飞猪技术部-平台技术-会员&玩法平台-玩法平台  \t\n\n责任人：翊霖\n\n测试责任人：园直\n\n【故障分】_/* 以系统计算结果为准*/_\n\n| **  系统质量（30%）** | | | | | **处置能力（70%）** |\n| :---: | --- | --- | --- | --- | :---: |\n| **相关方** | **需求设计** | **代码质量** | **变更质量** | **自定义项** | **发生时间** | **发现时间（30%）** | **恢复时间（40%）** |\n| 飞猪-飞猪技术部-平台技术-会员&玩法平台-玩法平台 | 否 | 否 | 否 | DB变更不规范 | 09-02 14:32 | 09-02 14:25 | 09-02 14:43 |",
    "chunk_order_index": 5,
    "full_doc_id": "doc-b306c38cdfe24b422edfba1fd35c58af"
  },
  "chunk-1eec76254558b0a96a324b336485edc6": {
    "tokens": 1200,
    "content": "## 一、故障简述\n9.19日17:30开始，淘分销订单创建、自营技术订单提交、飞猪酒店、国内机票订单提交等成功率异常，17:51 数据库执行预案回滚及部分库主备切换后故障恢复，故障原因初步确认为预建连预案执行过程中数据库连接打满导致。整体故障触达P3。\n9.21日15:40起，淘宝买菜下单创建页成功率异常，到达P4故障，经确认故障为预建连演练导致，15:45数据库执行预案回滚及部分库主备切换后故障恢复。\n\n## 二、故障过程回顾\n时间主线自营技术  数据库   Ump飞猪淘分销 TRE\n\n#### 919预案执行故障\n| **时间轴** | **事件** |\n| --- | --- |\n| 2024-09-19 17:28 |   数据库   DBA推预建连预案，开启预案后所有实例均快速建连，有4个实例连接数达到19.8w，其它实例大多为18.68w。    故障引入_备注：从数据库侧看所有实例的链接都在19w以上_![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/12771/1727143837515-9575dc28-83d0-4f9d-8fee-645f7a04f4ae.png) |\n| 2024-09-19 17:30 |  故障发现 故障响应自营技术自营技术订单提交风险预警，其玄、环杰等接手排查  淘分销淘分销订单创建风险预警，兵林接手飞猪飞猪_营销优惠扣减异常、酒店_提交订单_排错、国内机票_提交订单异常&飞猪分销_高德提交接口异常风险预警 Ump新限购分桶库存consume监控风险预警，辛德、道昭介入排查![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/12771/1727073845719-c26e857d-4980-42d7-b78a-cd551e55ad2e.png)![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/12771/1727078209656-70377d3f-bda8-45a0-941c-de6e859d679d.png) |\n| 2024-09-19 17:32 |  故障发生自营技术订单提交成功率持续3min小于90%，触达P4![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/12771/1727076010919-c15e1b81-fa92-4de5-b064-09288d9e9e77.png?x-oss-process=image%2Fformat%2Cwebp%2Fresize%2Cw_1500%2Climit_0)![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/12771/1727076061248-266e6287-0513-4c4a-b135-2a999aa2f318.png?x-oss-process=image%2Fformat%2Cwebp%2Fresize%2Cw_1500%2Climit_0) |\n| 2024-09-19 17:33 | 淘分销淘分销订单创建成功率5min小于80%，触达P4![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/12771/1727078557249-eb186409-5a28-4910-883a-1252e276b325.png?x-oss-process=image%2Fformat%2Cwebp%2Fresize%2Cw_1110%2Climit_0) |\n| 2024-09-19 17:34 | 自营技术未音排查到Ump超时报错![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/12771/1727074291148-0c279897-5b90-40da-8968-55f5b08d6442.png) |\n| 2024-09-19 17:35 | 飞猪定位到DB有超时Ump排查发现是由于数据库线程池满导致查询超时，开始联系TRE |\n| 2024-09-19 17:37 | 飞猪机票交易、日历房交易成功率下跌达P4 |\n| 2024-09-19 17:38 | Ump孜于拉会 |\n| 2024-09-19 17:45 | DBA prefill回滚完成，自营技术订单提交、飞猪、淘分销受影响业务恢复![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/12771/1727143950357-47eccca1-6ec4-4daf-90db-7af1b63fa544.png) |\n| 2024-09-19 17:48 | 自营技术下单创建成功率下跌持续5min低于50%,",
    "chunk_order_index": 0,
    "full_doc_id": "doc-d9780cf336f56f8be7c2b14c8dc9dc67"
  },
  "chunk-928e26f62ef01eed93cfb8f23c0ba249": {
    "tokens": 1200,
    "content": "技术订单提交、飞猪、淘分销受影响业务恢复![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/12771/1727143950357-47eccca1-6ec4-4daf-90db-7af1b63fa544.png) |\n| 2024-09-19 17:48 | 自营技术下单创建成功率下跌持续5min低于50%,触达P3![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/12771/1727076651554-fb076ef6-35ac-49c8-8ff0-168ce7b0bed5.png?x-oss-process=image%2Fformat%2Cwebp%2Fresize%2Cw_1500%2Climit_0) |\n| 2024-09-19 17:51 | 故障恢复 0006分库与0010 分库在预案回滚后业务仍有异常，通过kill主节点恢复，下单创建成功率恢复。其中：+ 0006分库在预案回滚后 快速大量建连。+ 0010分库在预案回滚后连接数无变化，仍在高位。![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/12771/1727076701138-3ccaf8bd-52db-42d5-a511-f00bf4246f2b.png?x-oss-process=image%2Fformat%2Cwebp%2Fresize%2Cw_1500%2Climit_0) |\n\n\n## 三、故障原因\n### 3.1【背景说明】\n:::tips\n为了保证峰值的时候业务稳定，避免洪峰对数据库造成的冲击，大促峰值前需要做数据库链接预热，也就是数据库预建连，是历年大促的常规预案。\n\n:::\n\n### 3.2【原因分析】\n#### 一句话原因：\n:::tips\n919：MKT_BUYLIMIT_UNIT数据库执行预建连后，连接数超出预期，导致业务查询数据库超时。\n921: MKT_BUYLIMIT_UNIT数据库调整预建连预案参数后验证时，灰度预案的实例在未关闭预案，连接数处于高水位的情况下，又执行了开启全量预案，由于连接释放速度小于建连速度，导致灰度的两个实例连接池打满。\n\n:::\n\n#### 根因分析：\n:::tips\n数据库执行了预建连操作之后，部分分库的连接数超过19万，最高达到19.9万，与营销侧计算的预期连接数不符，\n\n营销侧评估的连接该数据库总容器数为4.5万台，其中属于张北单元的有2.3万台，按照提前约定好的连接数4，数据库为单实例2库，总链接数应该是184000，实际上从当日表现来看仍然有预期外的应用与该库建立了连接，导致总机器数超出预期。\n\n:::\n\n## 四、故障关注点\n**〖关注点1〗****919 1W的建连差量来自哪里？**\n\n:::tips\n**〖问题总结〗**主要有两方面：\n\n+ 有业务预期外应用进行数据库连接；业务侧（ump）现有的评估能力无法评估到预期外的连接。故障后问题排查时也是TRE(通过diamond查询订阅这个数据库配置的应用容器列表)帮助获取到一个比较准确的建连的机器数。\n+ 业务在建立连接的时候，数据库层面会有一个权限认证的过程，未认证完成的链接会占用数据库侧的总链接，但是客户端有可能出现等待超时又重发建连请求的情况，导致在数据库上的总链接超过预估。所以连接数是需要保留充足buffer'空间的；**数据库建议连接水位保持在70%以下比较安全。**\n+ **UMP侧评估过程：**ump侧评估过程：通过鹰眼上的数据库访问来源来评估有哪些应用连接了MKT_BUYLIMIT_UNIT，鹰眼上只能看到近期有流量的应用，评估到需要连接的应用有三个，ump2、fliggy-ump3、umcc。这三个应用我们评估的峰值期间中心单元机器总量是2.1万台，南通2万台，总计4.1万台机器。按照实际能观测到的应用计算，中心库的连接数最高为2.1*2*4 = 16.8万，南通库的连接数最高为2*2*4=16万。  \n考虑到后续可能有扩容，或者有一些预期外的应用连接该库，我们给每个单元留了2000台buffer，也就是中心最多2.3万台，南通2.2万台，总计4.5万台，按照这个量级评估，中心库的连接数最高为2.3*2*4 = 18.4万，南通库的连接数数量最高为2.2*2*4=17.6万，均没有超过数据库连接池上限19万。\n9月21号快上演练时，统计连接到数据库的IP数量，即使计算上预期外的应用，南通库连接的机器数少于业务",
    "chunk_order_index": 1,
    "full_doc_id": "doc-d9780cf336f56f8be7c2b14c8dc9dc67"
  },
  "chunk-7c0a1ba0264acf08ce4479ecbf7e19cb": {
    "tokens": 1200,
    "content": "台，按照这个量级评估，中心库的连接数最高为2.3*2*4 = 18.4万，南通库的连接数数量最高为2.2*2*4=17.6万，均没有超过数据库连接池上限19万。\n9月21号快上演练时，统计连接到数据库的IP数量，即使计算上预期外的应用，南通库连接的机器数少于业务侧的预估，中心与预估接近，按照真实机器数计算，连接数也是没有超过19万上限的。主要是有预期外的应用建连。\n\n**〖改进点〗**\n\n+ 后续预建连容量数据的评估由爱橙侧提供，Ump需共同评估；    --长期执行\n+ 大促态prefill参数调整为minpool3，maxpool3         已完成   [@辰宿](undefined/chenlindun.cld)\n\n:::\n\n\n\n**〖关注点2〗**** 预案回滚后为何还有两个库未恢复？需要手动kill？**\n\n:::tips\n**〖问题总结〗**\n\n+ 和业务的具体请求情况强相关，对于未完全打满的库预案回滚后可自动恢复。如果库本身已经处于完全被打满的状态，则会一直连接，无法自动释放。这链各个库就属于前者。\n+  从当前情况来看，这个情况暂时无法避免，数据库层面来看比较有效的做法是预案停止后，及时观测其它库的指标，如有异常，立马进行切库，当前可做到1MIN回切。\n\n**〖改进点〗**预案回滚后需观测未恢复库及时进行干预处理。  --sop  [@辰宿](undefined/chenlindun.cld)\n\n:::\n\n\n\n**〖关注点3〗**** 预建联是否有灰度？**\n\n:::tips\n**〖问题总结〗**\n\n+ 当前预建连预案，是一个中心化的配置，一旦打开就是所有应用全部推送，所以从云数据库这一侧无法做到灰度打开，这是当前tddl这个形态决定的；\n+ 当前仅预建连预案的执行时间已经超过半个小时了，大促时同时需要执行多个预案，出于预案的效率考虑，长期来看，阿里云数据库层面不会针对单库级别进行灰度开启。\n+ 爱橙侧建议短期云侧从单元级别灰度推预案（会上反馈效率会比较低，时效来不及，下来数据库端仔细评估下）。\n+ 长期来看，由于TDDL已交接给爱橙，数据库运维也在爱橙侧，爱橙内部将从数据裤、TDDL维度综合确定下预案执行灰度方案。\n\n**〖改进点〗 **\n\n+ ** ** 短期：单元级别灰度可行性评估        [@辰宿](undefined/chenlindun.cld)     10.11日 给出评估结论\n+   长期：预案执行灰度方案确定           @相勖      12.31  方案确定\n\n:::\n\n\n\n**〖关注点4〗**** ****预建联能否有更好的方案，不kill现有连接，新增连接做追加，一方面预建连是不会抖，另外一方面即使连接数超了不会有问题****？**\n\n:::tips\n**〖问题总结**〗去年也有相同的问题，今年同去年情况基本相同：\n\n+ 核心是看Durid能否提供“不断已有的老连接，直接新建连接”的能力。TDDL是直接用了开源Durid连接池的能力。\n+ 相比于改动Durid连接池的逻辑，业务做好算术评估的风险小很多。优惠连接数超过19W在集团众多应用中，是一个超特殊的场景。所以建议还是做好事前评估。\n+ TDDL侧建议能够从业务控制连接水位，业务侧暂时评估无法做到，主要是无法将流量打到MAX，流量打到MAX可能会影响真实的流量。此点会上暂未有结论，业务如有诉求，可同TDDL侧继续探讨可行性。\n\n**〖改进点〗**暂无\n\n:::\n\n\n\n**〖关注点5〗**** 连接池满的告警是怎样的？**\n\n:::tips\n**〖问题总结〗**\n\n+ 对于预案执行的场景，连接数上升的很快，及时有告警，也避免不了故障的发生；\n+ 对于连接数的监控，当前只有绝对值的监控，缺少使用率的监控；\n\n**〖改进点〗**\n\n+ 短期：梳理核心库，进行连接数告警配置（根据上限手动折算告警值），同时完善内存指标告警**。            **  @辛德     930\n+ 长期：连接数使用率监控能力支持；       @相勖       930 完成需求沟通，确定排期\n\n:::\n\n\n\n**〖关注点6〗**** 为何只有MMC及淘分销下跌幅度较大（>40%）？**\n\n:::tips\n**〖问题总结〗**初步怀疑原因：\n 当前MMC和淘分销主要是限购场景，若连接不成功，",
    "chunk_order_index": 2,
    "full_doc_id": "doc-d9780cf336f56f8be7c2b14c8dc9dc67"
  },
  "chunk-d6a9b1b68ffd7d8be17ff5d853d8d216": {
    "tokens": 1200,
    "content": "930\n+ 长期：连接数使用率监控能力支持；       @相勖       930 完成需求沟通，确定排期\n\n:::\n\n\n\n**〖关注点6〗**** 为何只有MMC及淘分销下跌幅度较大（>40%）？**\n\n:::tips\n**〖问题总结〗**初步怀疑原因：\n 当前MMC和淘分销主要是限购场景，若连接不成功，影响会比较大\n 当前连接销毁后，TDDL参数控制会将老的数据库访问连接进行保留（当前是12S），12S后会关闭连\n  此点未达成一致，会后小群再明确原因。\n\n**〖改进点〗**暂无\n\n:::\n\n\n\n**〖关注点7〗**** 手动及自动执行建连连接数叠加的问题如何解决？**\n\n:::tips\n**〖问题总结〗**此次手动执行，是为验证prefill参数调整为minpool3，maxpool3 的临时灰度方案，后续不会再有手动+自动的场景出现。不过从此次事件过程，发现连接处于高水位的时候，重新发起建连是有很大风险的，前面提到TDDL参数控制会将老的数据库访问连接进行保留（当前是12S），所以建议后续高水位情况下预案执行时间间隔也至少有12S。\n\n**〖改进点〗**暂无\n\n:::\n\n## 五、故障Action\n| **序号** | *******Action** | *******负责人** | *******计划完成时间** | **验收标准** | **是否keyAction** | **是否回血Action** |\n| --- | --- | --- | --- | --- | --- | --- |\n| 1 | 配置：将MKT_BUYLIMIT_UNIT库预建连时的连接数修改为：\"minPoolSize\": \"3\", \"maxPoolSize\": \"3\" | 林顿 | 已完成 | 调整完成 | 否 | 否 |\n| 2 | SOP：预案回滚后需观测未恢复库及时进行干预处理 | 林顿 | 930 | 宣导完成 | 否 | 否 |\n| 3 | 方案：单元级别灰度可行性评估         | 林顿 | 10.11 | 评估完成，给出结论 | 否 | 否 |\n| 4 | 方案：预案执行灰度方案确定 | 许恺 | 12.31 | 方案确定 | 是 | 否 |\n| 5 | 监控：梳理核心库，进行连接数告警配置（根据上限手动折算告警值），同时完善内存指标告警 | 辛德 | 930 | 监控优化完成 | 否 | 否 |\n| 6 | 监控：连接数使用率监控能力支持 | 许恺 | 930 | 完成需求沟通，确定排期 | 否 | 否 |\n\n\n## 六、影响产品线&影响面\n| **受影响业务** | **等级** | **影响说明** |\n| --- | --- | --- |\n| 自营技术-超市订单创建 | P3 | - [ ] 是否影响可用性：否- [x] 业务影响：+  下单创建页打不开或者访问成功量下跌，41分开始下跌，44分成功率低于50%，51分恢复，触达P3![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/12771/1727076651554-fb076ef6-35ac-49c8-8ff0-168ce7b0bed5.png)![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/12771/1727076701138-3ccaf8bd-52db-42d5-a511-f00bf4246f2b.png)[故障标准：](https://tr.alibaba-inc.com/orm/config/emergency-scene/list/online?children=true&nodeId=55986&depth=1&refId=bdbc191aaa4213b7&scenarioTypes%5B0%5D=FAULT_RISK&scenarioTypes%5B1%5D=FAULT)![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/12771/1727076721896-312eb68d-70ac-465a-bc36-ace9d3d4a35c.png)+ 订单提交成功率28分开始下跌，32分到达P4，45分恢复![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/12771/1727076010919-c15e1b81-fa92-4de5-b064-09288d9e9e77.png)![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/12771/1727076239954-d097542a-e77f-4d5c-bf90-be4de5fe190c.png)[故障标准](https://tr.alibaba-inc.com/orm/config/emergency-scene/list/online?children=true&nodeId=31576&depth=1&refId=9bb76c0c64b5fa63&scenarioTypes%5B0%5D=FAULT_RISK&scenarioTypes%5B1%5D=FAULT",
    "chunk_order_index": 3,
    "full_doc_id": "doc-d9780cf336f56f8be7c2b14c8dc9dc67"
  },
  "chunk-6d7f61445607967ed46516b4b99f969f": {
    "tokens": 1175,
    "content": "9954-d097542a-e77f-4d5c-bf90-be4de5fe190c.png)[故障标准](https://tr.alibaba-inc.com/orm/config/emergency-scene/list/online?children=true&nodeId=31576&depth=1&refId=9bb76c0c64b5fa63&scenarioTypes%5B0%5D=FAULT_RISK&scenarioTypes%5B1%5D=FAULT)：![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/12771/1727076061248-266e6287-0513-4c4a-b135-2a999aa2f318.png)- [ ] 是否有客诉：否- [ ] 是否有社会舆情_：_否- [ ] 是否产生资损：否 |\n| 天猫技术-淘分销 | P4 | - [ ] 是否影响可用性：否- [x] 业务影响：+ 【淘分销】下单-用户创建订单失败，18分开始下跌，29分成功率低于80%，33分触达P4，45分恢复![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/12771/1727078557249-eb186409-5a28-4910-883a-1252e276b325.png)[故障标准：](https://tr.alibaba-inc.com/orm/config/emergency-scene/list/online?children=true&nodeId=31576&depth=1&spm=goc-apm.orm-mobile__-type_-missionNumber.0.0.68da65e9j4wd1X&refId=6af966f5e2a4bd3a&scenarioTypes%5B0%5D=FAULT_RISK&scenarioTypes%5B1%5D=FAULT)![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/12771/1727078420499-dccc8ffb-a6cc-48ab-beec-7f87512fd17f.png)- [ ] 是否有客诉：否- [ ] 是否有社会舆情_：_否- [ ] 是否产生资损：否 |\n| 飞猪 | P4 | - [ ] 是否影响可用性：否- [x] 业务影响：+   国内机票交易下跌：17:28-17:38成功率持续低于80%，37分触发P4  ![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/41240/1727058481526-8dfc1f94-a185-4774-865a-ed6c7d2c0716.png)+  酒店日历房交易下跌，17:28-17:44成功率持续低于80%，37分触发P4   ![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/41240/1727058602831-7f13790e-7553-4a0e-9c37-90877a33011e.png)此外营销优惠扣减、飞猪分销_高德提交接口等多条业务场景也出现预警。- [ ] 是否有客诉：否- [ ] 是否有社会舆情_：_否- [ ] 是否产生资损：否 |\n\n\n## 七、故障定级&定责&故障相关方\n【故障等级】P3  \n【故障分】_/* 以系统计算结果为准*/_\n\n| ** 系统质量（30%）** | | | | | **处置能力（70%）** |\n| --- | --- | --- | --- | --- | --- |\n| **相关方** | **需求设计** | **代码质量** | **变更质量** | **自定义项** | **发生时间** | **发现时间（30%）** | **恢复时间（40%）** |\n| 业务技术-自营技术-消费技术 | N | N | N |  | 2024-09-19 17:32 | 2024-09-19 17:30 | 不涉及 |\n| 业务技术-天猫技术-天猫国际技术 | N | N | N |  | 2024-09-19 17:33 | 2024-09-19 17:30 | 不涉及 |\n| 飞猪 | N | N | N |  | 2024-09-19 17:37 | 2024-09-19 17:30 | 不涉及 |\n| 业务技术-营销&交易技术-营销基础平台-优惠平台 | N | N | N | 容量评估 | 2024-09-19 17:32 | 2024-09-19 17:30 | 不涉及 |\n| 爱橙科技-技术风险与效能部-解决方案中心-数据库管理 | N | N | N |  | 2024-09-19 17:32 | 不涉及 | 2024-09-19 17:51 |\n\n\n_备注：此处记录爱橙为相关方，主要原因为阿里云同爱橙就预案执行的owne方沟通达成一致，爱橙为执行方_",
    "chunk_order_index": 4,
    "full_doc_id": "doc-d9780cf336f56f8be7c2b14c8dc9dc67"
  },
  "chunk-2d7392258d7952b1773400f2ef8aaa25": {
    "tokens": 75,
    "content": "|  | 2024-09-19 17:32 | 不涉及 | 2024-09-19 17:51 |\n\n\n_备注：此处记录爱橙为相关方，主要原因为阿里云同爱橙就预案执行的owne方沟通达成一致，爱橙为执行方_",
    "chunk_order_index": 5,
    "full_doc_id": "doc-d9780cf336f56f8be7c2b14c8dc9dc67"
  },
  "chunk-a7d589e51e54b40736774a34287d8e60": {
    "tokens": 1200,
    "content": "## 一、故障简述\n9.12 10:31开始，批量消费者反馈无法合并付款，11:30回滚后恢复，初步原因与奥创热发变更相关，期间客诉40+，触达P4 。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/12771/1726711705592-d3546a6b-0705-4adf-a7ff-9d4001775f1b.png)\n\n## 二、故障过程回顾\n| **时间轴** | **事件** |\n| --- | --- |\n| 2024-09-11 16:00 | 执行奥创发布**【故障注入】** |\n| 2024-09-11 20:30 | 奥创发布完成**** |\n| 2024-09-12 10:31 | VOC风险预警，GOC拉群 【**故障发生】【故障发现】**   ![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/16656576/1726115202035-22a582f0-aff1-44b1-b7c9-8e7e76c8bea0.png) |\n| 2024-09-12 10:35 | 电话会议沟通 |\n| 2024-09-12 10:38 | 服务端飞絮、怀宇等介入排查【**故障响应】** |\n| 2024-09-12 10:51 | 客户端赤也进群，开始处理问题 |\n| 2024-09-12 10:55 | 初步怀疑和奥创热法变更相关**【故障定位】** |\n| 2024-09-12 10:58 | 尝试奥创回滚**【恢复执行】** |\n| 2024-09-12 11:03 | 相关同学集中处理 |\n| 2024-09-12 11:05 | 准备奥创热发变更 |\n| 2024-09-12 11:16 | 测试回归通过，开始奥创热发 |\n| 2024-09-12 11:30 | 奥创热发完成**【故障恢复】** |\n\n\n## 三、故障原因\n### 3.1【背景说明】\n:::tips\n**事件链迁移背景：**新版中DX不再维护tborder.json中的事件链，需要业务将其中的事件迁移至event_chain。订单业务配合迁移，国际化以及列表4.0项目均已使用新版，但迁移成本较高以及长尾版本存在，旧版仍需要继续维护。\n\n**本次变更背景：**修复订单列表图片偶现闪烁的体验问题，图片组件增加属性disableSettingEmptyPlaceholder=\"true\"\n\n:::\n\n### 3.2【原因分析】\n#### 一句话原因：\n:::tips\n模板从 dx 平台迁移到vscode dx插件开发，插件不支持老的订单事件链编译，生成的模板产物没有包含tborder.json配置文件，导致事件配置丢失；奥创侧将该模板发布上线后，出现用户侧使用异常；\n\n:::\n\n#### 详细原因：\n:::tips\n目前订单这边修改发布模板有两个渠道：dx平台和vscode的dx插件，之前使用插件开发和发布的模板**没有使用老的事件链**，整体发布都是正常的。\n11号订单列表有个seller组件修改了样式，该模板是首次通过vscode的dx插件进行发布，并且使用到了老的事件链功能，**vscode的dx插件已不支持此类特性打包，导致发布的模板产物中没有包含tborder.json配置文件出现相关事件配置丢失，**导致线上舆情反馈合并支付功能异常。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/16656576/1726133462743-d38d6559-65d4-4efe-86b5-d5bee14e8b2e.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/16656576/1726136473450-0f7a3251-601d-43cb-98af-82b350e76e42.png)\n\n:::\n\n\n\n## 四、故障关注点\n#### 1、关于原因\n**〖关注点1〗****Dx插件不支持tborder.json中的事件链，什么时候开始的？是否还有其它历史组建也在使用？此风险如何规避？**\n\n:::tips\n**〖问题总结〗**\n\n+ dx插件对于这种目前还包含旧版事件配置的模板在发布阶段做阻断【状态：已发布上线，同时增强了发布校验，不限于 tborder.json 文件，如果发现非白名单文件和错误配置时也会阻断发布，可以规避所有产物和源码不匹配的问题】。\n+ 订单业务对依赖 tborder.json中的事件链迁的组件移进行中，但是未有明确的时间。\n\n**〖改进点〗**确认所有潜在影响的业务，通知到位【状态：已完成】\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/238910/1726752277444-bb55a036-1d50-40ac-af3f-153",
    "chunk_order_index": 0,
    "full_doc_id": "doc-949cfc68993b4731dd42db28daa6c66d"
  },
  "chunk-135010a845e46444fc2efd24ae98c4b4": {
    "tokens": 1200,
    "content": "】。\n+ 订单业务对依赖 tborder.json中的事件链迁的组件移进行中，但是未有明确的时间。\n\n**〖改进点〗**确认所有潜在影响的业务，通知到位【状态：已完成】\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/238910/1726752277444-bb55a036-1d50-40ac-af3f-1530246a47d5.png)\n\n:::\n\n#### 2、变更过程\n**〖关注点1〗 ****开发过程【即：DX模板编译生成】中，为什么没有发现问题**\n\n:::tips\n**〖问题总结〗变更链路：DX模板编译生成 -> DX模板线上生效发布，**dx组件通过vscode dx插件生成正式版本，diff信息中看不出tborder有变化（实际也没变化，发布不会带上这份json文件）\n\n**〖改进点〗**识别首次迁移的模板发布，提示开发者**工具变更需要重点对比编译产物**；识别到tborder.json弹窗阻断发布（同上）；\n\n:::\n\n\n\n**〖关注点2〗 ****测试回归流程是否可以发现**\n\n:::tips\n**〖问题总结〗**需求修复了订单店铺图片icon闪动的问题，回归时观察订单列表icon是否闪动，该场景是在待付款tab且有多个待付款订单时候有勾选按钮，未回归合并付款按钮场景\n\n**〖改进点〗**\n\n+ 补充合并付款场景P0、P1 case回归、自动化回归能力     [@飞絮](undefined/xiaopei.sgxp)  9.30\n+ 过渡态工具变更需求组件涉及功能需全量回归。      ---内部约定  雷晨\n\n:::\n\n\n\n**〖关注点3〗 ****灰度过程【即：DX模板线上生效发布】是怎样的，是否在灰度过程中发现问题？**\n\n:::tips\n**〖问题总结〗**从下午4点开始发布，至8点半发布完成，过程中观测了crash及舆情情况，均未发现有问题。该问题无法通过技术手段有效检测，能想到的手段：\n\n+ 舆情，第一例舆情是在11号21:47发出，截至12号也仅有7条舆情。\n+ 组件曝光，页面组件种类多，针对组件曝光做监控可行性存疑\n+ 服务端接口流量监控有配置，但是合并支付量级占比很小，导致波动很小，预警不出来\n\n**〖改进点〗** \n\n+ 结合MID一致性监控，增加核心功能埋点监控，添加合并付款等场景曝光点击埋点，通过观察埋点量级预警业务问题。    [@良徽](undefined/zhabin.zha)     已完成 \n+ 订单场景一级按钮增加端侧监控。       [@瑜晟](undefined/shoulei.msl)     10.15 日\n\n:::\n\n#### 2、应急处置\n**〖关注点1〗****整个故障的定位、恢复是否有可提升空间？**\n\n:::tips\n**〖问题总结〗**从问题定位完成到恢复耗了将近四十分钟，过程中评估奥创回滚的风险大于重新热发，而热发需要走一系列审批流程，导致最终耗时增加。\n\n**〖改进点〗 **\n\n+ 奥创平台优化快速回滚能力，进行回滚日常演练；    @苏寄    3.31日   依赖回滚能力的上线\n+ 奥创后对于已写基线的场景回滚方案确定；             [@无浅](undefined/sunxxing.sx)    10.18日  方案确定\n                aone发布人可以走审批流进行跳过操作；     ---     \n\n:::\n\n## 五、故障Action\n| **序号** | **Action类型** | *******Action** | *******负责人** | *******计划完成时间** | **验收标准** | **是否keyAction** | **是否回血Action** |\n| --- | --- | --- | --- | --- | --- | --- | --- |\n| 1 | 工具类 | DX 插件增加不支持文件类型的发布阻塞功能 | 非攻 | 已完成 | 功能上线 | 是 | 是 |\n| 2 | 监控类 | MID功能加强，增加核心功能埋点监控 | 良徽 | 已完成 |         监控增加 | 否 | 否 |\n| 3 | 监控类 | 订单场景一级按钮增加端侧监控 | 瑜晟 | 10.15 |      监控增加完成 | 否 | 否 |\n| 4 | 演练类 | 奥创平台优化快速回滚能力，进行回滚日常演练 | 苏寄 | 03.31 |      全员演练完成 | 否 | 否 |\n| 5 | 工具类 | 奥创平台回滚能力优化 | 无浅 | 10.18 |       方案确定 | 是 | 否 |\n| 6 | 工具类 | aone发布跳过能力，支持CF | 顺岭 | 待定 |       功能完成 | 否 |",
    "chunk_order_index": 1,
    "full_doc_id": "doc-949cfc68993b4731dd42db28daa6c66d"
  },
  "chunk-3affea6ee59ff60986790143806e3163": {
    "tokens": 678,
    "content": "回滚能力，进行回滚日常演练 | 苏寄 | 03.31 |      全员演练完成 | 否 | 否 |\n| 5 | 工具类 | 奥创平台回滚能力优化 | 无浅 | 10.18 |       方案确定 | 是 | 否 |\n| 6 | 工具类 | aone发布跳过能力，支持CF | 顺岭 | 待定 |       功能完成 | 否 | 否 |\n| 7 | 测试类 | 补充合并付款场景P0、P1 case回归、自动化回归能力 |       飞絮 | 930 |     用例补充完成 | 否 | 否 |\n\n\n## 六、影响产品线&影响面\n| **受影响业务** | **等级** | **影响说明** |\n| --- | --- | --- |\n| 交易-待付款列表合并支付 | P4 | - [ ] 是否影响可用性：否- [x] 业务影响：待付款列表合并支付功能失效，未触发高可用场景- [x] 是否有客诉：在线客诉41条，P4      ![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/12771/1721284675497-ad73050c-f678-48a7-9d8b-fbf374197459.png?x-oss-process=image%2Fformat%2Cwebp)- [ ] 是否有社会舆情_：/*舆情ESU等级/未到E等级，舆情关键词，总声量，负声量*/_- [ ] 是否产生资损：_/*理论资损金额，实际资损金额*/_ |\n\n\n## 七、故障定级&定责&故障相关方\n【故障等级】P4  \n【故障责任方】*团队 \t_/* P1故障必填，非P1故障可不填*/_  \n【故障分】_/* 以系统计算结果为准*/_\n\n| ** 系统质量（30%）** | | | | | **处置能力（70%）** |\n| --- | --- | --- | --- | --- | --- |\n| **相关方** | **需求设计** | **代码质量** | **变更质量** | **自定义项** | **发生时间** | **发现时间（30%）** | **恢复时间（40%）** |\n| 业务技术-终端平台-体验技术-原生技术 | N | N | N |  | 2024-09-12 10:31 | 2024-09-12 10:31 | 2024-09-12 11:30不涉及 |\n| 业务技术-营销&交易技术-交易业务技术-交易前端技术 | N | N | N |  | 2024-09-12 10:31 | 2024-09-12 10:31 | 2024-09-12 11:30 |\n\n\n\n\n  \n\n\n若有收获，就点个赞吧",
    "chunk_order_index": 2,
    "full_doc_id": "doc-949cfc68993b4731dd42db28daa6c66d"
  },
  "chunk-b13cea140c5684030298a26f6ce79563": {
    "tokens": 1200,
    "content": "## 一、故障简述\n2024-09-13 8:31左右客满同学反馈用户使用临时地址下单报错；10:15左右，客诉60+，触达P4故障；10:51通过重启恢复。后定位原因为机器本地内存中无新版本地址缓存数据。去重后期间共产生48例客诉。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/147556600/1726202895386-1041a6e5-31fa-4bd3-b1a6-590941956aa1.png)\n\n## 二、故障过程回顾\n2024-09-13 06:00，变更开始时间\n2024-09-13 06:10，变更完成时间\n\n2024-09-13 08:31，客满同学故障群里反馈用户使用临时地址下单报错 **【问题发现】**\n\n2024-09-13 09:18，客满同学在技术群反馈 \n2024-09-13 09:21，技术同学介入排查，怀疑是缓存导致的，建议手动重选地址【问题响应】\n\n2024-09-13 09:39，通知交易排查地址选择器触发地址校验出错的文案\n\n2024-09-13 09:40,B类买家客诉50+，触达P4故障**【故障发生】**\n\n2024-09-13 09:52，前端定位到接口问题，准备重新发布，后端等前端发布完成dimand回滚版本\n\n2024-09-13 09:54，群里周柯柯反馈问题的时候执行重启相关机器的预案\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/147556600/1726217615790-f62bac6c-9446-441a-909d-d4f4900e0c28.png)\n\n2024-09-13 10:07，分销回流订单反馈收货地址同步异常\n\n2024-09-13 10:14，[@巴鲁](undefined/linjiaxuan.ljx)前端准备回滚过程中，[@八归](undefined/bagui.zjb)[@悟三](undefined/wusan.wyb)[@中舟](undefined/zhongzhou.lq)后端定位是部分机器没刷到缓存，捞出所有问题机器，手动重启问题机器，发现错误日志减少，让前端暂缓回滚【问题定位】【恢复执行】\n\n2024-09-13 10:15， SRE[@开岳](undefined/kaiyue)帮忙全量重启机器，物流后端[@悟三](undefined/wusan.wyb)[@八归](undefined/bagui.zjb)[@中舟](undefined/zhongzhou.lq)手动重启问题机器\n\n2024-09-13 10:15，引导用户重新编辑下单地址陆续还是有进线，客诉60+****\n\n2024-09-13 10:16，周柯柯反馈重新编辑和新增都解决不了问题，只能多次重试\n\n2024-09-13 10:23，第一批机器重启完成\n\n2024-09-13 10:34，手动重启完成，上海区恢复\n\n2024-09-13 10:51，全量重启完成 【故障恢复】\n\n## 三、故障原因\n### 3.1【背景说明】\n最近一次地址库更新23年1月；为了解决商家反馈地址库未更新导致发货受阻的问题进行地址库版本更新（V41->V46）。\n\n### 3.2【一句话原因】\n 机器本地内存中无新版本地址缓存数据\n\n### 3.3【根因分析】\n+ **前端地址消费流程&发布流程：**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/19556273/1726217099324-2caf46b2-812a-4907-bfd2-5bfc16c53b7a.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/19556273/1726215689210-dbc2bf7b-8527-4392-bda1-7060eca6fe52.png)\n\n\n\n+ **后端操作逻辑：**\n\n一键发布业务链路，触发后端地址库变更，可以理解为将现在的数据切到v46版本对外提供服务\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/147556600/1726203003742-a68dbc35-2ab3-41b0-a022-22495f2a02a3.png?x-oss-process=image%2Fformat%2Cwebp)\n\n![画板](https://intranetproxy.alipay.com/skylark/lark/0/2024/jpeg/147556600/1726226939285-159c51fa-a4c5-4c86-872b-ee5ec54ccd5f.jpeg)\n\n\n\n+ **访问为什么出问题**\n\n![画板](https://intranetproxy.alipay.com/skylark/lark/0/2024/jpeg/147556600/",
    "chunk_order_index": 0,
    "full_doc_id": "doc-1bcbba67bbb10a90aacd3d8f85f36cf7"
  },
  "chunk-0e05923ec92901205ea86bea8d600ccc": {
    "tokens": 1200,
    "content": "format%2Cwebp)\n\n![画板](https://intranetproxy.alipay.com/skylark/lark/0/2024/jpeg/147556600/1726226939285-159c51fa-a4c5-4c86-872b-ee5ec54ccd5f.jpeg)\n\n\n\n+ **访问为什么出问题**\n\n![画板](https://intranetproxy.alipay.com/skylark/lark/0/2024/jpeg/147556600/1726304440504-3d366433-a65a-42d5-be0f-cd507a2be248.jpeg)\n\n+ **链路中出现问题的点**\n\n![画板](https://intranetproxy.alipay.com/skylark/lark/0/2024/jpeg/147556600/1726299905245-006c2080-7550-401e-bbcb-9c82c31f624d.jpeg)\n\n\n\n+ **具体原因：**\n\n数据库单表总量：150w数据，**其中v46数据4.9w条**\n\n根因是dimand变更时太多机器捞db数据，同时**并发太多，又是深分页**，导致库的cpu和内存升高，造成数据库自保的一些熔断措施\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/147556600/1726302313354-adc9e2f8-ad1c-4a19-af26-8504e6d1c1a5.png)\n\n执数据库更新缓存到本地内存中，由于并发存在sql失败\n\n[Query execution was interrupted报错处理](https://aliyuque.antfin.com/db_service_lark/magkb7/qmc713)\n\n之前2022年代码里做过优化，包括随机睡眠等待时间和pageSize 5000 -> 800的变更，但是并未解决深分页的问题\n\n## 四、关注点分析\n**关注点：****如何后续如何避免深分页、大并发触发限流的问题？**\n\n1. 规范发布SOP，分多批发布限制在10批以上，但是后面扩容后解决不了\n2. 通过游标代替分页逻辑，(已确认地址库有版本号索引和id)，应该是没问题的\n3. 加一级tair缓存，手动预热到tair，然后机器都从缓存中取\n\n:::tips\n**Action：**\n\n1、优化数据库地址更新的查询逻辑，用游标代替分页逻辑 [@中舟](undefined/zhongzhou.lq)  10.31    \n2、添加tair缓存，避免机器直接访问DB导致DB负载升高 [@中舟](undefined/zhongzhou.lq)  10.31\n\n:::\n\n\n\n**关注点：****变更期间是否有停留观察？是否有监控报警？**\n\n发布时间选择低峰期早上6点，低峰期的同时方便出现问题各域快速响应\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/147556600/1726208078925-468cb891-806d-4077-813d-f6734f66bbfa.png)\n\n发布期间没发现是因为我们目前的监控项是对交易核心链路没影响，比如地址新建，运费大盘这种，下单有效订单数并未发现有异常\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/147556600/1726209832163-b0ef0c12-a434-4614-a31d-5e11afccf4e9.png)\n\n:::tips\n**Action：**\n\n1、新增地址库加载失败监控配置 [@颖露](undefined/raoyinglu.ryl)  done\n\n2、预热，发布过程中监控报警 [@中舟](undefined/zhongzhou.lq)   done\n\n3、新增异常机器的监控，提前发现问题机器   [@中舟](undefined/zhongzhou.lq) 927\n\n:::\n\n****\n\n**关注点：****为什么当时不选择回滚**？\n\n之前的出现问题的预案是重启机器，在发现问题后在按当时的预案在走了，开始重启问题机器，当时可以操作回滚，但是9点流量高峰期了前端发布和后端发布会存在不一致的时间，可能会引入更多客诉，出于这个考虑没选择回滚，并且重启后问题在收敛得到验证；\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/147556600/1726212148426-cc3da7f2-6e16-4df5-b286-fc312d8f6177.png)\n\n\n\n**关注点：****从问题发现（08:31）到问题响应(09:21)中间过了50分钟，后续如何缩短问题响应时间？**\n\n在地址变更前钉了之前接触的各域相关同学，技术侧群里感知到反馈是9点18\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/147556600/1726219351574-a92a3ecd-ec56-4f55-b325-392fc5c38ad2.png)![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/",
    "chunk_order_index": 1,
    "full_doc_id": "doc-1bcbba67bbb10a90aacd3d8f85f36cf7"
  },
  "chunk-b3b47fc48269baa0af3ccdd7b774c119": {
    "tokens": 598,
    "content": "了之前接触的各域相关同学，技术侧群里感知到反馈是9点18\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/147556600/1726219351574-a92a3ecd-ec56-4f55-b325-392fc5c38ad2.png)![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/147556600/1726219435144-a8479abf-3262-4fa4-8e53-2a08d47e0d87.png)\n\n### \n## 五、故障Action\n| **序号** | *******Action标题** | *******负责人** | *******计划完成时间** | **Action描述** | **验收人** |\n| --- | --- | --- | --- | --- | :---: |\n| 1 | 短期：组内地址变更宣讲，根据故障复盘规范发布的SOP | [@中舟](undefined/zhongzhou.lq) | 0920 | 组内地址变更宣讲，根据故障复盘规范发布的SOP | |\n| 2 | 短期：地址库加载失败监控配置 | [@颖露](undefined/raoyinglu.ryl) | done | 地址库加载失败监控配置   [https://sunfire.alibaba-inc.com/custom/54/product/preview/multiMinute/3393](https://sunfire.alibaba-inc.com/custom/54/product/preview/multiMinute/3393) | |\n| 3 | 短期：预热，发布过程中监控报警 | [@中舟](undefined/zhongzhou.lq) | done | 预热，发布过程中监控报警[https://sunfire.alibaba-inc.com/custom/54/product/preview/generalComp/1432](https://sunfire.alibaba-inc.com/custom/54/product/preview/generalComp/1432) | |\n| 4 | 新增异常机器的监控，提前发现问题机器 | [@中舟](undefined/zhongzhou.lq) | 09.27 |  | |\n| 5 | 长期：优化数据库地址更新的查询逻辑，用游标代替分页逻辑      | [@中舟](undefined/zhongzhou.lq)    | 10.31 | 优化数据库地址更新的查询逻辑，用游标代替分页逻辑   | |\n| 6 | 长期：添加tair缓存，避免机器直接访问DB导致DB负载升高  |  [@中舟](undefined/zhongzhou.lq)  | 10.31 | 添加tair缓存，避免机器直接访问DB导致DB负载升高 | |",
    "chunk_order_index": 2,
    "full_doc_id": "doc-1bcbba67bbb10a90aacd3d8f85f36cf7"
  },
  "chunk-6c8a99affe13b98e67bad7d4592437f7": {
    "tokens": 1196,
    "content": "return null;\n    }\n    return iWinPortSearchService.getSearchResult(searchRequestParam);\n}\n\n@Around(\"@annotation(com.alibaba.cbu.winport.wireless.common.log.integration.IntegrationLog)\")\npublic Object aroundAdvice(ProceedingJoinPoint proceedingJoinPoint) throws Throwable {\n    // xxxx省略\n    LoggerUtil.info(LOGGER, \"【INTEGRATION】 desc={},class={},method={},success={},rt={}ms,args={},result={}\",\n                StringUtils.isNotBlank(annotation.desc()) ? annotation.desc() : className,\n                className, methodName, success ? \"Y\" : \"N\", cost,\n                JSON.toJSONString(getArgsLog(args)),\n                digest ? null : JSON.toJSONString(result));\n}\n```\n\n\u0000![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/132756375/1725452031114-9343e752-b728-432e-a5d3-99404fa26c78.png)\n\n\n\n+ **8月27日部署时CPU抖动+灰度流量太大**\n\nTPP轻应用发布流程\n\n    1. 分为两步骤：部署、切流。具体如下：\n        1. 部署：基线版本和灰度版本部署在同一台机器上。\n        2. 切流：TPP平台将灰度流量切流到灰度版本。\n    2. TPP轻应用部署切流时，CPU利用率会有突刺，经咨询TPP官方同学\n        * 部署会有一些CPU密集性的操作，比如类加载，另外有一些jit优化的事情。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/132756375/1725007602113-b50eeeac-3539-408a-a642-1d907adeacf1.png)\n\n        * 切流会向未接流的新版本代码接入请求，没接过流量的java 代码，不是所有class都会一开始就加载好的，有不少class是用到了才加载，这里会有冷启动现象；切流时也会有类加载的过程，也会拉高CPU\n\n![分两批部署，从7%升高到20%以上](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/132756375/1724817803901-366ed530-d6a1-49af-a6ca-55ab6facde1e.png?x-oss-process=image%2Fformat%2Cwebp%2Fresize%2Cw_1500%2Climit_0)\n\n## 四、关注点分析\n关注点1：21号迁移后CPU就有升高，当时CPU水位到哪里，为什么27号才爆发出来？\n\n21日部署后，高峰时CPU利用率在70%以上，而27日又进行了上线，在切流到30%-60%时CPU抖动升高至不可用。抖动原因见根因处TPP冷启动现象。\n\n\n\n关注点2： 应用的基础监控有配置CPU利用率的告警规则，但是没有触发告警是什么原因？\n\n初步判断是由于单机视角无数据导致无法触发告警。TPP应用对应的pod资源的serverless.io/app-name 和sunfire的app_nema不一致，sunfire数据采集失败。目前临时解决方案是协调TPP的同学帮忙在应用上加一段配置即可。[link](https://aliyuque.antfin.com/bx5106/gvmtiw/bz54k5brauq6g0u0)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/128256406/1725522657390-2bd29fdc-9176-4dc5-8fd2-854710dbf480.png)![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/128256406/1725330323511-858b0163-3577-4f54-a8e9-926630d3c508.png)![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/128256406/1725328726294-8e3546c4-a118-42b9-9173-d4d0dba9e4e6.png)\n\nAction：TPP轻应用告警检查    初耀，验收人：定果\n\n\n\n关注点3：灰度过程中是否有停下来观察过基础监控的各项指标是否正常？\n\n有观察接口错误率、异常日志等指标，这一部分正常；未细致观察CPU变化。\n\n\n\n关注点4：TPP应用扩容花了28分钟（14:52-15:20），过程中是有遇到什么问题吗？\n\n扩容时发现机器资源不够，花了一点时间协调资源\n\nAction：FC资源迁移腾挪，为TPP轻应用做资源补充    初耀   带回讨论 \n\n\n\n## 五、故障Action\n| **序号** | *******Action标题** | *******负责人** | *******计划完成时间** | **验收人** |\n| --- | --- | --- | --- | --- |\n| 1 | TPP轻应用告警检查    |  初耀 |  | 定果 |\n\n\nAction：营销侧对FC资源迁移腾挪，释放资源为TPP轻应用做资源补充    初耀   带回讨论",
    "chunk_order_index": 2,
    "full_doc_id": "doc-28f3f3a99a74a5692eb99aff02149df0"
  },
  "chunk-74089d637b9a1d6b285bc512da7208c0": {
    "tokens": 96,
    "content": "| **序号** | *******Action标题** | *******负责人** | *******计划完成时间** | **验收人** |\n| --- | --- | --- | --- | --- |\n| 1 | TPP轻应用告警检查    |  初耀 |  | 定果 |\n\n\nAction：营销侧对FC资源迁移腾挪，释放资源为TPP轻应用做资源补充    初耀   带回讨论",
    "chunk_order_index": 3,
    "full_doc_id": "doc-28f3f3a99a74a5692eb99aff02149df0"
  },
  "chunk-a1a639ab77f6f79445bedef3318fbce1": {
    "tokens": 1200,
    "content": "_** **_\n\n## 一、故障简述\n2024-09-19 21:47,盒马订单创建成功量持续3分钟成功率低于95%，失败量大于30，触达P4故障；22:05，成功率低于90%，失败量大于30，触达P3故障；22:10左右定位连接数占满；22:16，DBA同学扩容连接数恢复。\n\n## 二、故障过程回顾\n### 2.1【故障时间线概览】\n![画板](https://intranetproxy.alipay.com/skylark/lark/0/2024/jpeg/128256406/1727314261815-da9fb0d6-69d2-4401-b754-4787b2c3952d.jpeg)\n\n### 2.2【故障完整时间线】\n2024-09-19 15:19，快上期间检测连接数，发现MKTTB_RETAIL_APP集群单实例连接高，且DB最大连接数默认值为60000，准备调整最大连接参数；\n\n2024-09-19 15:32，爱橙DBA[@相勖](undefined/xukai.xu) 联系云侧DBA[@叶北](undefined/luocaiping.lcp)将 max_user_connections（60000），max_connections（61000）连接数分别上调至198000，199000；\n\n2024-09-19  16:44，识别到张北0000分库所在实例内存水位超过130%，且持续上涨（8核16G），实例有OOM风险，爱橙DBA推荐业务侧（ump）紧急升配；\n\n2024-09-19  16:50，业务侧（ump）发起升配，内存调整至32G；\n\n2024-09-19  16:59，升配完成。由于max_user_connections，max_connections为内存态调整，升配后会回退到默认配置；****\n\n2024-09-19** **18:21，MKTTB_RETAIL_APP集群实例连接数被打满**【故障注入】**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/128256406/1727162988897-4cb2a400-e070-47ea-a128-c562dc69aeef.png)\n\n2024-09-19 21:36 halo-wdk-ump应用第一批 开始发布（限时疯抢专享价-业务需求日常发布）；\n\n2024-09-19 21:45 halo-wdk-ump应用第一批次 发布完成；**【第一次下跌】**\n\n2024-09-19  21:45，盒马buy2五道口创建订单成功量最近2分钟连续小于95,失败数最近2分钟连续大于20,触发预警；**【故障发现】**\n\n2024-09-19 21:48，盒马订单创建成功量持续3分钟成功率低于95%，失败量大于30，触达P4故障；** 【故障发生】**\n\n2024-09-19 21:52 halo-wdk-ump应用 开始回滚；**【第一次故障恢复】**\n\n2024-09-19 22:01 halo-wdk-ump应用 回滚完成；**【第二次下跌】**\n\n2024-09-19 22:04左右，排查到数据库rt上涨，协调到DB的同学协助排查；\n\n2024-09-19 22:05，盒马订单创建成功量持续3分钟成功率低于90%，失败量大于30，触达P3故障；\n2024-09-19 22:10，定位到订单下跌原因：限购库没连接成功，限购资源扣减失败；\n\n2024-09-19 22:14左右，协调UMP的同学协助排查；\n\n2024-09-19 22:15，DB侧主备切换，并调整最大连接数；\n2024-09-19 22:16，监控恢复到正常水位，故障恢复。**【故障恢复】**\n\n## 三、故障原因\n### 3.1【背景说明】\nump侧：云交付验收\n\n盒马侧：盒马限时疯抢专享价-业务需求日常发布\n\n### 3.2【一句话原因】\nDBA调整数据库的最大连接数配置是内存态调整，没有持久化，调整了最大连接数后执行扩容内存操作，最大连接数会被重置，导致连接数达到上限，业务查询超时。\n\n### 3.3【根因分析】\n+ **连接数调整与数据库升配**\n\n0000分库所在实例，快上后有 15589台容器连接至数据库，DB侧连接数持续上涨，15:12采集到的连接数达到55247，并导致数据库内存水位也持续上涨。紧急调整max_connections后虽然不会出现连接数满的情况，但内存持续上涨可能造成数据库进程OOM，DB与ump同学沟通后决定升配内存规格至32G（原8C16G）。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/128256406/1727161617347-48f3d7af-ba4c-4031-a877-5b",
    "chunk_order_index": 0,
    "full_doc_id": "doc-388e8ba4aa2ce934481ba4c242a92a83"
  },
  "chunk-fd2f5c66564e63272d5f43c61b79bbb6": {
    "tokens": 1200,
    "content": "。紧急调整max_connections后虽然不会出现连接数满的情况，但内存持续上涨可能造成数据库进程OOM，DB与ump同学沟通后决定升配内存规格至32G（原8C16G）。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/128256406/1727161617347-48f3d7af-ba4c-4031-a877-5b6725863bc3.png)![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/128256406/1727161697149-43b428c7-6e66-42c0-8443-d4ef7dcb97b5.png)\n\n升配完成后，由于之前调整的max_user_connections是内存态，在升配后会回退到默认值60000，快上的容器持续建连，**在18:21 实例的连接数被打满。**由于此时距离重启已超过1小时20分钟，TDDL连接的慢加载模式下盒马的正常业务均已正常建连。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/128256406/1727162988897-4cb2a400-e070-47ea-a128-c562dc69aeef.png)\n\n\n\n之前能发现，18:21之后没有发现---快上期间有巡检\n\n\n\n+ **订单成功量第一次下跌（**21:47-21:53**）**\n    - 因mkttb_retail数据库最大连接数达到上限，halo-wdk-ump第一批发布成功的机器未能成功连接数据库，因状态已经发布成功，流量会路由至这批机器，出现第一次下跌；\n+ **订单成功量第一次下跌恢复**\n    - halo-wdk-ump回滚过程中因机器被摘除，流量不会路由至发布中的机器，第一次下跌成功率恢复；\n+ **订单成功量第二次下跌（**22:01-22:16**）**\n    - halo-wdk-ump回滚成功后，因数据库连接数达到上限，回滚的机器未能成功连接数据库，因状态已经发布成功，流量会路由至这批机器，出现第二次下跌；\n\n![画板](https://intranetproxy.alipay.com/skylark/lark/0/2024/jpeg/128256406/1728468162579-bad6d174-b203-44d1-b3ac-23b32766ee52.jpeg)\n\n## 四、关注点分析\n**关注点：****本次变更安全生产环境是否有发现异常？**[@湫兮](undefined/lcb149581)\n\n1. 安全生产发布&详细验证时数据库连接池正常；\n2. 安全生产核心验证代码变更内容，未命中mkttb_retail库场景；\n3. 安全生产流量小，优惠核销成功率体现不出来；\n4. 日常发布通常重点关注业务相关报错；业务日志中不记录数据库连接异常；\n\naction：业务日志识别数据库连接异常监控 [@湫兮](undefined/lcb149581)  done\n\n \n\n**关注点：** **连接数调整采用临时调整方案是什么原因？**[@辰宿](undefined/chenlindun.cld)\n\nmax_user_connections=60000 是集团生产环境的默认配置，已经是很高的连接数配置了。将max_user_connections 调整到19.8w 可能带来oom的风险，本次出现问题的集群不在预案范围内，所以只会临时修改内存态。除非业务有特殊的要求，aone或者邮件报备审批过，才会固化。\n另外，大促的参数预案，也是修改内存态参数。\n\n:::tips\n**Action：**\n\n1、UMP和新零售相关共用的数据库，连接数问题，彻底自动化解决 [@智盛](undefined/zhisheng.cjf)  9.22\n2、数据库连接数固化为19W [@许恺](undefined/xukai.xu) done\n\n:::\n\n\n\n**关注点：****MKTTB_RETAIL这个库为什么会出现连接数被占满的情况？****是否有评估过****这个库的连接数上限？**[@辛德](undefined/xinde.xy)\n\n快上之后淘鲜达业务使用的机器数变多了导致连接数占满。对于不参与预建连的库，评估过不会超过上限19.8万，营销侧无法感知到升配后连接数上限回滚到6万。\n\n\n\n**关注点：****后续如何提前发现问题？是否有监控可以提前发现？**[@湫兮](undefined/lcb149581)[@相勖](undefined/xukai.xu)[@辛德](undefined/xinde.xy)\n\n盒马：没有数据库的监控，发布前无法关注到连接数异常的情况，目前已增加数据库连接池最大连接数&异常连接数等相关监控告警；\n\nUMP：ump侧目前没有提前发现配置被回滚后，连接数异常的能力，sunfire对于异常连接数目前只支持绝对值告警，如果上限是19.8万，那么到6万是不会触发告警的，核心问题还是无法监控到【已用连接数占比】这个参数；\n\nDB：目前我们暂时没办法对某个库连接",
    "chunk_order_index": 1,
    "full_doc_id": "doc-388e8ba4aa2ce934481ba4c242a92a83"
  },
  "chunk-80de881524533afa2e2c9ea4ce7be6f7": {
    "tokens": 737,
    "content": "池最大连接数&异常连接数等相关监控告警；\n\nUMP：ump侧目前没有提前发现配置被回滚后，连接数异常的能力，sunfire对于异常连接数目前只支持绝对值告警，如果上限是19.8万，那么到6万是不会触发告警的，核心问题还是无法监控到【已用连接数占比】这个参数；\n\nDB：目前我们暂时没办法对某个库连接数的使用率配置告警；可以通过应用关联DB的形式接入sunfire关注到数据库的情况。\n\n:::tips\n**Action：**\n\n1、增加数据库异常连接数等相关监控告警 [@湫兮](undefined/lcb149581)  done\n2、DB对营销这些重点库通过订阅告警的方式订阅告警的方式巡检兜底  [link](https://alidocs.dingtalk.com/i/nodes/7NkDwLng8Za7QYkeHOg2YjGGJKMEvZBY) [@智盛](undefined/zhisheng.cjf) \n\n3、建立连接数水位告警（按照连接数使用率监控）& 连接数告警功能上线后订阅数据库告警  [@智盛](undefined/zhisheng.cjf) [@辛德](undefined/xinde.xy)  10.11\n\n:::\n\n   \n\n**关注点：****ump侧后续如何保障盒马的稳定性**\n\n:::tips\n**Action：**\n\n1、淘鲜达流量回迁的进度确认 [@辛德](undefined/xinde.xy) [@云彻](undefined/yunche.ch) 9.26 \n\n:::\n\n\n\n## 五、故障Action\n| **序号** | *******Action标题** | *******负责人** | *******计划完成时间** | **验收人** |\n| --- | --- | --- | --- | --- |\n| 1 | UMP和新零售相关共用的数据库，连接数问题，彻底自动化解决 | [@智盛](undefined/zhisheng.cjf)  | 9.22 |  |\n| 2 | 数据库连接数固化为19W | [@许恺](undefined/xukai.xu) | done | 筝竹 |\n| 3 | DB对营销这些重点库通过订阅告警的方式订阅告警的方式巡检兜底  [link](https://alidocs.dingtalk.com/i/nodes/7NkDwLng8Za7QYkeHOg2YjGGJKMEvZBY)  | [@智盛](undefined/zhisheng.cjf)  |  |  |\n| 4 | 建立连接数水位告警（按照连接数使用率监控）&连接数告警功能上线后订阅数据库告警 | [@智盛](undefined/zhisheng.cjf) [@辛德](undefined/xinde.xy)  | 10.11 |  |\n| 5 | 增加数据库异常连接数等相关监控告警  | [@湫兮](undefined/lcb149581) | done |  |\n| 6 | 淘鲜达流量回迁的进度确认 | [@云彻](undefined/yunche.ch) [@辛德](undefined/xinde.xy) | 9.26  |  |\n\n\n##",
    "chunk_order_index": 2,
    "full_doc_id": "doc-388e8ba4aa2ce934481ba4c242a92a83"
  },
  "chunk-143fbe0fcaad038a18efdfec483ac142": {
    "tokens": 1200,
    "content": "## 一、故障简述\n【P4】于2024-09-25 10:01生意参谋_10点_8级基线破线时间大于等于1分钟，触达P4故障，初步确认为lindorm集群问题，导致生意参谋导数任务大批量变慢，lindorm多次重启后于10:38生意参谋8基线任务完成。后续排查为CSW（核心交换机）上联MC（Marshall Connection）部分（4/256）链路极化打满引发网络拥塞延迟，网络同学隔离一条打满的CSW（核心交换机）链路，于15:17恢复。\n\n## 二、故障过程回顾\n### 2.1【故障处理时间线】\n#### 生意参谋侧\n| **时间轴** | **事件** |\n| --- | --- |\n| 2024-09-25 07:38 | 8基线变慢触发时间![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256311/1728441224016-81f7a8be-08ea-4ced-a38e-d1c79130d6f2.png) |\n| 2024-09-25 07:47 | 电话通知到浩凌**【故障发现】【故障响应】** |\n| 2024-09-25 08:04 | 宇暉向天引反馈同步任务变慢**【初因定位】**![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256311/1728456492073-8746684c-9232-433c-a582-a90512644994.png) |\n| 2024-09-25 08:09 | 途远电话联系天引![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256311/1728456273431-2d068793-defe-4d48-b49e-eaf83172a4ba.png) |\n| 2024-09-25 08:23 | 天引整体重启一次lindorm集群，业务进行观察**【恢复执行】** |\n| 2024-09-25 08:43 | 业务侧反馈部分8基线任务有破线风险，整理文档和天引一起观察![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256311/1728456984343-ffd4a7a6-0f71-459c-be28-e6353a74d63f.png) |\n| 2024-09-25 09:11 | ‘生意参谋-商品排行昨日数据未更新’客诉预警卡片推送 |\n| 2024-09-25 09:12 | 风险预警群拉起**** |\n| 2024-09-25 09:20 | 美迦群内同步因lindorm导数问题，导致数据产出过慢 |\n| 2024-09-25 09:22 | 钉钉会议拉起 |\n| 2024-09-25 10:01 | 生意参谋-零售电商版_10点_8级基线破线**【故障发生】** |\n| 2024-09-25 10:22～15:00 | 天引间歇性重启LTS（Lindorm Tunnel Service） ，在启动后的一段时间内可以恢复流量，随着时间递减。通过不断重启使得任务获得推进。 |\n| 2024-09-25 10:38 | 8基线作业已经跑完**【故障恢复】**![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256311/1728377450944-2bfcf892-8c2b-42ca-bc76-a81c20fc86b4.png) |\n| 2024-09-25 16:07 | 天引同步7级基线任务已经完成 |\n| 2024-09-25 17:10 | 途远同步生意参谋当日离线同步任务完成 |\n\n\n#### 物理网络侧\n| **时间轴** | **事件** |\n| --- | --- |\n| 2024-09-25 01:58 | NA61/NA63/NA175/EA119/EA120盘古进专区阿里云私网汇总路由增加一段（11.152.0.0/14）变更开始执行【故障注入】![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256311/1728547790110-ea489e39-8b28-41c9-a33f-c3458ac6f358.png) |\n| 2024-09-25 02:40 | 物理网络变更下发NA63机房的第一台CSR的静态路由，CSR传递给云MC（Marshall Connection），云MC（Marshall Connection）传递给专区MC（Marshall Connection）和CSW（核心交换机）， CSW（核心交换机）从云MC（Marshall Connection）学到（11.152.0.0/14）",
    "chunk_order_index": 0,
    "full_doc_id": "doc-85e7d46e0fa2a7cf2d3a98b73053f1c2"
  },
  "chunk-5b85ab7438c3d5378584985bd117c466": {
    "tokens": 1200,
    "content": "f358.png) |\n| 2024-09-25 02:40 | 物理网络变更下发NA63机房的第一台CSR的静态路由，CSR传递给云MC（Marshall Connection），云MC（Marshall Connection）传递给专区MC（Marshall Connection）和CSW（核心交换机）， CSW（核心交换机）从云MC（Marshall Connection）学到（11.152.0.0/14）这个新汇总大段后，开始出现hash异常，4条链路开始出现hash极化现象(此时4条链路铜牌流量打满，物理网络值班同学观察到铜牌流量后未进行处置) |\n| 2024-09-25 08:00左右 | 4条hash极化的专线线路流量一直处于流量打满的状态，但此时主要流量变成了银牌，业务伴随偶尔的高延时现象。(由于前期确认主要流量为铜牌流量，此时未及时处理) |\n| 2024-09-25 12:01  | 业务同学拉AIS服务台进入故障群确认张家口网络是否存在异常 |\n| 2024-09-25 12:06 | 物理网络服务台答复张家口-南通长途有流量打满告警，未看到明显丢包情况 |\n| 2024-09-25 12:08 | 物理网络值班同学进一步核实下，反馈张家口-南通长途打满为后端采集异常引发的误告警，并初步确认张家口地域跨AZ网络未发现明显异常 |\n| 2024-09-25 12:15 | 业务同学反馈7:50分开始有大量访问延时报错，要求确认7:50前后是否存在相关变更 |\n| 2024-09-25 12:16 | 值班同学确认物理网络大盘无异常，核实对应时间点无相关变更操作 |\n| 2024-09-25 12:16～13:29 | 配合业务方排查发现ping存在高延时现象，且服务器分散在多个集群，从现象看与网络的相关度较高，物理网络值班同学决策内部升级排查 |\n| 2024-09-25 13:29  | 手动发起应急，拉二线同学念琦、辞呈等会进入电话会议排查 |\n| 2024-09-25 13:43 | 根据业务给出的信息，针对原11.88.134.36目的11.182.104.134进行排查 |\n| 2024-09-25 13:50～15:03 | 1、念琦登录异常服务器进行flow探测，未发现异常，发现服务器ping 确实有延时不稳定的情况2、排查庖丁对应原和目的之间的异常，针对14:17 庖丁展示MC（Marshall Connection）丢包排查，发现偶发丢包一直存在，与故障现象无关3、针对原11.88.134.36目的11.182.104.134进行流统，手工流统无法打标，自动化流统统计计数-1，无法确定结果 |\n| 2024-09-25 15:03  | 业务潇洛上线，对齐只有NA63云上存在异常，张北云上互访没有问题。开始对张北NA63进行重点排查，并重点排查NA63上下云专线的情况 |\n| 2024-09-25 15:13 | 确认NA63 CSW（核心交换机）上下云专线存在4/256条链路存在拥塞**【根因定位】** |\n| 2024-09-25 15:17  | 隔离一个拥塞端口后拥塞缓解【影响消除】 |\n\n\n## 三、故障原因\n### 3.1【背景说明】\n![画板](https://intranetproxy.alipay.com/skylark/lark/0/2024/jpeg/80256311/1728444143381-6929bace-41c1-465c-a571-e45de10377c2.jpeg)\n\n### 3.2【原因分析】\n一句话原因：\n\n由于地址分配回收的历史问题，ACTN存在11.144.0.0/12大段路由，ABTN存在11.144.0.0/14段路由，导致阿里云11.144.0.0/14访问集团跨域VIP时回包黑洞(缺乏明细路由走ACTN)的情况，故需要在张北专区CSR路由变更将11.144.0.0/14路由下发机房内，路由下发后触发CSW（核心交换机）设备vxlan隧道的ECMP下一跳刷新异常的BUG，引起CSW（核心交换机） HASH极化部分链路打满拥塞，引起张北NA63集团上云业务访问延迟\n\n根因分析：\n\nCSW（核心交换机）-VM-MASTER-G1-2.NA63极化根因：厂家已定位为老版本bug导致vxlan隧道的ECMP下一跳刷新异常引",
    "chunk_order_index": 1,
    "full_doc_id": "doc-85e7d46e0fa2a7cf2d3a98b73053f1c2"
  },
  "chunk-1cd9d3c87828ef408839a16e6fb78a96": {
    "tokens": 1200,
    "content": "核心交换机）设备vxlan隧道的ECMP下一跳刷新异常的BUG，引起CSW（核心交换机） HASH极化部分链路打满拥塞，引起张北NA63集团上云业务访问延迟\n\n根因分析：\n\nCSW（核心交换机）-VM-MASTER-G1-2.NA63极化根因：厂家已定位为老版本bug导致vxlan隧道的ECMP下一跳刷新异常引起极化，需升级版本解决。\n\n## 四、关注点分析\n「关注点」生意参谋侧是否有降级手段？\n\n:::tips\n商家数据需要在adb/lindorm（占70%）取数据，对作业本身无法做降级，发现问题后做了以下处理：\n\n1.对8基线作业和核心7级作业执行双跑处理\n\n2.对商品排行通讯表剔除卡住的同步任务的依赖，商品排行通讯表9:52产出\n\n3.联系业务布防\n\n:::\n\n「关注点」为何重启lindorm集群会出现一段时间内流量恢复？\n\n:::tips\n重启lindorm集群后流量下降，任务执行过程中流量升高后再次拥塞\n\n:::\n\n「关注点」物理网络变更后观测了哪些监控指标？\n\n:::tips\n本次变更主要观察了aliping(对服务器进行ICMP和TCP探测、银牌报文)、操作的对象设备CSR和CSR互联设备相关的电路组流量监控；但是本次是CSW（核心交换机）设备收到CSR的路由后出现异常，属于操作A设备引起的非互联的其他设备出现异常(类似隔山打牛)，导致变更未观察到异常。\n\n:::\n\n「关注点」2:40变更，为何对业务的影响在7:50左右开始？\n\n:::tips\n2:40对CSR设备下发配置后，CSW（核心交换机）收到路由后已经触发设备的软件BUG出现hash极化部分链路少量拥塞的情况，但是由于是凌晨主要流量都是低优先级的铜牌流量，此时影响的是铜牌业务方，铜牌业务对网络少量丢包天然不敏感，故从业务上看影响可控或者说无特别影响。但从7：50后银牌流量开始上涨，此时拥塞的流量开始出现少量的银牌丢包或者延时高的现象。银牌业务对网络质量敏感度比较高，故看起来业务影响是7：50左右开始的。\n\n:::\n\n「关注点」CSW（核心交换机）-MC（Marshall Connection）链路流量打满告警为何未及时处理？\n\n:::tips\n主要有以下几个原因：\n\n    - 凌晨2点多为链路打满为铜牌打满，告警处理确认后，早上8点左右链路打满已经由铜牌切换成银牌，值班同学以为是同一原因故未再次核实处理\n    - 当前CSW（核心交换机） MC（Marshall Connection）不支持QOS队列采集，MC（Marshall Connection）侧可通过抽样采集来推断每个端口的银牌流量大致组成，导致产生偏差，未将告警等级进行升级(银牌流量90%以上会提升告警等级，本次抽样采集的银牌水位在85%左右)\n\nAction：\n\n    - 针对极化以及首次打满的流量告警，降低银牌流量水位阈值90%->60%，来提升告警处理等级 六观 已完成\n    - 告警持续时间久，出现次数频繁，要求值班同学进一步排查-----内部宣导\n\n:::\n\n「关注点」整体故障定位时间较长的原因？\n\n:::tips\n首先是CSW（核心交换机）-MC（Marshall Connection）链路铜牌流量/银牌流量打满告警未及时处理，其次为故障处理中的信息对齐问题，未第一时间对齐故障范围为NA63集团上云存在问题，待业务潇洛上线后，快速对齐是NA63集团上云上下云互访存在异常后，才锁定是NA63 CSW（核心交换机）到云MC（Marshall Connection）之间的线路极化导致。\n\n:::\n\n「关注点」版本是否已升级？\n\n:::tips\nCSW（核心交换机）本身至MC（Marshall Connection）只有10.0/8 11.0/8大段路由，本次故障是因为NA63 CSR将11.152.0.0/14大段路由播布后通过MC（Marshall Connection）传递到CSW（核心交换机），H3C的CSW（核心交换机）设备因为设备软件BUG导致vxlan隧道的ECMP下一跳刷新异常，引起少量端口路由表项刷新出现HASH极化的现象。\n\nAction：暂停明细路由传播到集团上云CSW（核心交换机）的类似变更  已完成 六观\n\n长期方案：对CSW（核心交换机）进行升级  六观  预计双12左右进行灰度，明年618之前完成现网设备升级\n\n:::\n\n「关注点」业务应急响应之后，lindorm、adb、tunnel三方研发都上线",
    "chunk_order_index": 2,
    "full_doc_id": "doc-85e7d46e0fa2a7cf2d3a98b73053f1c2"
  },
  "chunk-bc40a85496b11c81e4d33a4ec918c189": {
    "tokens": 1200,
    "content": "表项刷新出现HASH极化的现象。\n\nAction：暂停明细路由传播到集团上云CSW（核心交换机）的类似变更  已完成 六观\n\n长期方案：对CSW（核心交换机）进行升级  六观  预计双12左右进行灰度，明年618之前完成现网设备升级\n\n:::\n\n「关注点」业务应急响应之后，lindorm、adb、tunnel三方研发都上线排查，各自服务均未发现明显异常，后续如何进一步朝着网络方向定位，以及联系网络值班介入，缩短根因定位时长？\n\n:::tips\naction：网络链路跟odps相关的监控订阅  @六观 潇洛 天泷  线下拉群确认订阅范围及完成时间\n\n备注：紧急情况拉网络值班账号 AIS-网络运营服务台 /网络运营服务台-咨询专用 \n\n:::\n\n### 4.1【系统质量】\n#### 4.1.1 需求&设计评估----不涉及\n#### 4.1.2 代码质量----不涉及\n#### 4.1.3 变更质量----不涉及\n+ **是否涉及变更：**\n    - [x] 是\n    - [ ] 否\n+ **变更类型：**\n    - [ ] 代码发布\n    - [ ] 配置变更\n    - [x] 其他变更：物理网络变更\n    - [ ] 不涉及\n+ **变更平台是否接入ChangeFree：**\n    - [x] 是，CF变更单链接[https://bg.aliyun-inc.com/#/change-approval/detail?bgVid=BG202409240571NC0PC](https://bg.aliyun-inc.com/#/change-approval/detail?bgVid=BG202409240571NC0PC)\n    - [ ] 否\n+ **是否违反变更红线3.1**** **[链接](https://aliyuque.antfin.com/ngoc/fzg6dy/uar1k6)\n    - [ ] 是，违反哪条原则：\n    - [x] 否\n\n\n\n**〖关注点〗****灰度阶段**\n\n+ **是否经过灰度：**\n    - [x] 是\n    - [ ] 否\n+ **观测了哪些监控**：_可以附链接_\n    - [ ] 黑屏、白屏\n    - [ ] GOC监控：\n    - [ ] 系统大盘：\n    - [x] 其他：本次变更主要观察了aliping(对服务器进行ICMP和TCP探测、银牌报文)、操作的对象设备CSR和CSR互联设备相关的电路组流量监控\n+ **是否灰度期间发现问题？**\n    - [ ] 是\n        - [ ] 是否灰度流量过大，导致故障\n        - [ ] 灰度发现但未有效或及时修复，导致故障\n        - [ ] 其他\n    - [x] 否\n+ **未灰度发现原因**\n    - [ ] 应用灰\n        - [ ] 灰度流量太小\n        - [ ] 灰度阶段无监控\n        - [ ] 灰度批次不合理\n        - [ ] 超长时间灰度才能发现\n    - [ ] 业务灰：策略不合理\n    - [ ] 灰度无法发现\n    - [x] 其他：本次是CSW（核心交换机）设备收到CSR的路由后出现异常，属于操作A设备引起的非互联的其他设备出现异常，导致变更未观察到异常。\n\n### 4.2【处置能力】\n#### 4.2.1 故障发现&响应\n+ **是否监控发现**\n    - [ ] 故障触发方 监控发现\n    - [x] 故障受影响方 监控发现\n    - [ ] 否，原因为：（监控无效/监控缺失）\n+ **是否5分钟内响应**\n    - [x] 是\n    - [ ] 否，原因为：\n+ **是否存在应急协同问题**\n    - [ ] 是\n        - [ ] 应急流程不明确（无流程或者流程不清晰、应急相关角色&职责不明确，缺失一号位等)\n        - [ ] 应急执行不到位（有流程，但未按流程执行，通告发送不及时，响应不及时等）\n    - [x] 否\n\n#### 4.2.2 故障定位&恢复\n+ **主要恢复方式：**\n    - [ ] 代码发布/回滚\n    - [ ] 配置发布/回滚\n    - [ ] 数据订正\n    - [x] 机器隔离/重启/扩容\n    - [ ] 配置限流\n    - [ ] 预案降级\n    - [ ] 自动恢复\n    - [ ] 其他：\n\n#### 4.2.3 SRE应急参与（淘天业务技术参考）\n+ **SRE工程师应急参与**：__\n    - 是否响应\n        - [ ] 是\n        - [x] 否\n    - 是否帮助定位\n        - [ ] 是\n        - [ ] 否\n        - [x] 未参与\n    - 是否操作恢复/提出有效恢复方案\n        - [ ] 是\n        - [ ] 否\n        - [",
    "chunk_order_index": 3,
    "full_doc_id": "doc-85e7d46e0fa2a7cf2d3a98b73053f1c2"
  },
  "chunk-f134f7d3c818042a294e06f7850824f7": {
    "tokens": 412,
    "content": "2.3 SRE应急参与（淘天业务技术参考）\n+ **SRE工程师应急参与**：__\n    - 是否响应\n        - [ ] 是\n        - [x] 否\n    - 是否帮助定位\n        - [ ] 是\n        - [ ] 否\n        - [x] 未参与\n    - 是否操作恢复/提出有效恢复方案\n        - [ ] 是\n        - [ ] 否\n        - [x] 未参与\n+ **SRE专家是否有效指挥**\n        - [x] 是\n        - [ ] 否\n        - [ ] 未参与\n\n## 五、故障Action\n| **序号** | *******Action标题** | *******负责人** | *******计划完成时间** | **Action描述** | **验收标准** | **验收人** | **是否keyAction** | **是否回血Action** |\n| --- | --- | --- | --- | --- | --- | :---: | --- | --- |\n| 1 | 短期：针对极化以及首次打满的流量告警，降低银牌流量水位阈值90%->60%，来提升告警处理等级  | 六观  | 已完成 | |  | | | |\n| 2 | 短期：网络链路跟odps相关的监控订阅 | 六观、潇洛、 天泷  | 拉群讨论后确定时间 | |  | | | |\n| 3 | 短期：暂停明细路由传播到集团上云CSW（核心交换机）的类似变更   | 六观 | 已完成 | |  | | | |\n| 4 | 长期：对CSW（核心交换机）进行升级  | 六观 | 预计双12左右进行灰度，明年618之前完成现网设备升级 | |  | | | |",
    "chunk_order_index": 4,
    "full_doc_id": "doc-85e7d46e0fa2a7cf2d3a98b73053f1c2"
  },
  "chunk-df39ccd8bcaf8df6e1d0917f8a9adfd9": {
    "tokens": 1200,
    "content": "## 一、故障简述\n2024年10月8日15:36监控预警飞猪OFFER链路预定异常，继而交通辅营转交易、国内机票出票、商旅机票支付、国内机票订单详情页等场景陆续预警，影响用户国内机票下单操作，故障原因初步确认是atowhost应用分组下线导致，于15:49通过扩容完成止血，故障恢复。期间产生13例客诉，根据监控下跌幅度判定达P2故障等级。\n\n## 二、影响产品线及影响面\n- [x] 是否影响可用性：否\n- [x] 业务影响：\n\n**业务影响说明：**影响国内机票下单预定，生单不可用，支付出票不阻塞。用户侧主要表现为预定失败\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/8672/1728636894110-1a420fb6-47be-4468-a3a0-dd29e9498ffb.png)\n\n**单量影响：**由于10.01-10.07为国庆假日，所以选择10.08和10.09号数据对比予以参考，且从监控来看整体波动一致\n\n+ 10.08 C端订单总量为134299，10.09订单总量为133035。整体看8号总量高于9号(8号晚上量超过9号)，订单量差别在1200单左右\n+ 故障到恢复的2小时(15:00-17:00)内订单量对比，10.08为15879，10.09为16445，9号高于8号570单左右\n\n**所以粗略评估影响订单量大约为600单左右。**\n\n**监控表现：**\n\n| **业务场景** | **监控项** | **是否触发故障** | **影响时段** |\n| --- | --- | :---: | :---: |\n| 国内机票履约下单及预订成功量下跌 | [飞猪OFFER链路预定监控异常 ](https://tr.alibaba-inc.com/orm/config/emergency-scene/list/online?children=true&nodeId=17728&depth=1&refId=85f01cc8d1b78b5e&scenarioTypes%5B0%5D=FAULT_RISK&scenarioTypes%5B1%5D=FAULT)  | **P2** | 15:30-15:46成功率跌零（受影响时段：15:29-15:49，持续21分钟）![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/41240/1728638200302-38b0c0bd-58b7-4610-b0ec-2276af73a783.png) |\n| 交通辅营转交易下跌 | [飞猪虚拟商品支付成功率统计异常  ](https://x.alibaba-inc.com/custom/59/product/preview/spm/663?crossTenant=true) | **P4** | 15:32-15:47成功量与昨日相比下跌>20%持续16分钟![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/41240/1728637729470-c6ccc1e6-014c-4fb1-8e45-add5cdf3d983.png) |\n| 国内机票出票成功量下跌 | [飞猪供销票号回填整体监控异常](https://x.alibaba-inc.com/custom/59/product/preview/spm/10526?crossTenant=true)   | **P4** | 15:35-15:50成功量与昨日相比下跌>30%持续16分钟![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/41240/1728638540954-829bdb6a-f72b-4e48-918a-2870c0b4c21a.png) |\n| 【商旅】机票支付失败 | [商旅_预订-国内机票资金相关](https://x.alibaba-inc.com/custom/59/product/preview/spm/10821?crossTenant=true)   | 未触发 | 持续十来分钟支付回调总量跌零  （受影响时段：15:34-15:50，持续17分钟）![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/41240/1728638945747-a11430c3-cd04-41c4-9b61-232b1bbbe98e.png) |\n| 国内机票订单详情页打开异常 | [飞猪新版国内机票无线订单详情异常](https://x.alibaba-inc.com/custom/59/product/preview/spm/3612?crossTenant=true)   | 未触发 | 受影响时段：15:34-15:47，持续14分钟![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/41240/1728639549184-0288b991-8fbd-4674-ad42-ae0164097032.png) |\n\n\n- [x] 是否有客诉：C端客户无反馈，商旅企业客户有13个来电反馈",
    "chunk_order_index": 0,
    "full_doc_id": "doc-81fac8e0db4de4c47b2250dcf1666298"
  },
  "chunk-ff3886ef6e6ea44d3110f67a7d897d67": {
    "tokens": 1200,
    "content": "未触发 | 受影响时段：15:34-15:47，持续14分钟![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/41240/1728639549184-0288b991-8fbd-4674-ad42-ae0164097032.png) |\n\n\n- [x] 是否有客诉：C端客户无反馈，商旅企业客户有13个来电反馈\n- [x] 是否有社会舆情_：_否\n- [x] 是否产生资损：否\n\n## 三、故障过程回顾\n:::info\n###### 背景介绍：\nato应用（老的国内机票交易系统）存在atow分组和ator分组，其中atow分组承接写流量，ator分组承接读流量；这两个分组是通过归组规则和归组模板进行流量路由\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/8672/1728561969927-0422affd-3f3e-4c1b-bac8-94883c0d9bfe.png)\n\n其中规则模板配置如下\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/8672/1728561743977-cdca6a4e-dc69-4818-99e4-7cc5a7cc4a13.png)\n\nato应用正在下线，目前atow分组基本仅剩订单同步流量及拼接派单流量，为了节省机器资源希望将atow分组的流量迁移合并到ator分组，然后下线atow分组。\n\n根据当前规则TripAtoSyncService服务是路由到atow分组执行，目标是清空规则，然后所有流量可以均匀路由到所有机器。设计切流流程为：清空归组规则->删除规则->下线机器->清空归组模板。执行流程为：预发环境->安全生产->线上环境\n\n:::\n\n2024-09-27 14:47，开始执行预发环境atow分组机器下线\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/51556504/1728565506875-d5c76374-e4c2-4777-9b5d-74208b0476c8.png)\n\n2024-10-08 11:40，开始执行线上环境清空归组规则（线上环境和安全生产环境是一起的），13:37:05完成发布\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/51556504/1728395057587-7e56111a-e53b-4ae4-a9d2-3b18e2a61cac.png)\n\n随着hsf归组规则下线，ator正常进入原atow分组的流量\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/51556504/1728395228167-10c139d7-b779-4425-b963-743ec86b53fb.png)\n\n2024-10-08 13:46，开始执行安全生产环境atow分组机器下线，业务大盘正常无波动\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/51556504/1728565595679-9714b81f-84c2-470e-89ce-2f2b3412542d.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/51556504/1728637808389-d37fd140-30a7-41b0-8e7c-b9c5d2a2e415.png)\n\natow_spe流量切换到ator_spe，所以ator_spe分组cpu使用率略有上涨，符合预期\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/51556504/1728637894642-849bdc9e-bb53-4c50-8504-98702ded6c9b.png)\n\n2024-10-08 15:16，开始执行线上环境atow分组第一批机器下线****\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/51556504/1728395852491-57d47a4d-443e-4b57-a5ba-9cc01d413969.png)\n\n2024-10-08 15:29，atow分组最后一批下线**【风险注入】**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/51556504/1728395874774-e1ed19e9-73fd-4dce-add6-a8e46cb97efe.png)\n\n2024-10-08 15:34，批量监控报警**【故障发现】**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/51556504/1728395648647-6e8c8ff8-fdde-4169-93fb-ff3ce240475d.png)\n\n![](https://in",
    "chunk_order_index": 1,
    "full_doc_id": "doc-81fac8e0db4de4c47b2250dcf1666298"
  },
  "chunk-83e3f31174ccce74b7410d0a24a7c0d8": {
    "tokens": 1200,
    "content": "fd-4dce-add6-a8e46cb97efe.png)\n\n2024-10-08 15:34，批量监控报警**【故障发现】**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/51556504/1728395648647-6e8c8ff8-fdde-4169-93fb-ff3ce240475d.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/51556504/1728394441922-88788239-2c6d-42e1-94d2-8c393e7a3db7.png)\n\n2024-10-08 15:35，由于发生批量报警，考虑可能和下线分组有关，进行排查**【业务响应】【初因定位】**\n\n2024-10-08 15:36，交通辅营转交易下跌（15:36）、国内机票履约下单及预订成功量下跌（15:36）、国内机票出票成功量下跌（15:42）、【商旅】机票支付失败（15:43）、国内机票订单详情页打开异常（15:53）等场景陆续预警\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/41240/1728638009339-380b02dc-268d-4d83-940c-8f10a9c6f830.png)![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/41240/1728639201943-2d9fbbb7-819e-4711-b2e7-a619ede9cf3b.png)\n\n2024-10-08 15:36，未确认根因，但是现象和分组下线强相关，先进行紧急扩容**【恢复执行】**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/51556504/1728396515291-d660b3c4-9d5a-4e4a-92cd-fff5a9c38901.png)\n\n2024-10-08 15:39，15:30开始，飞猪OFFER链路预定监控异常，成功率最近10分钟最大值小于30%且失败量最近10分钟最小值大于30，触达P2故障**【故障发生】** \n2024-10-08 15:47，重启第一台机器成功，可以正常响应****\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/51556504/1728396679744-c5efe3ae-72f7-4148-b90d-ef6196cf10d6.png)\n\n2024-10-08 15:49，全部机器启动成功，预定成功率恢复正常水准**【故障恢复】【影响消除】**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/51556504/1728396845812-77953e2a-8009-44cd-96ec-d2fc551749fb.png)\n\n2024-10-08 17:45，和hsf团队进行详细沟通后，确认为线上环境**下线机器会触发归组规则的重新编译**，导致**已经删除的归组规则重新生成**，此时ator分组已经不能继续响应写流量，随着最后一批机器下线最终产生故障\n\n## 四、故障原因\n### 4.1【背景说明】\n##### 业务链路：\nato应用（老的国内机票交易系统）存在atow分组和ator分组，其中atow分组承接写流量，ator分组承接读流量\n\n##### 需求背景：\nato应用正在下线，目前atow分组基本仅剩订单同步流量及拼接派单流量，为了节省机器资源希望将atow分组的流量迁移合并到ator分组，然后下线atow分组。\n\n![画板](https://intranetproxy.alipay.com/skylark/lark/0/2024/jpeg/8672/1728640129771-cbec51e9-e3f8-4ece-9f23-261296b9000c.jpeg)\n\n**红色箭头为本次故障的节点，syncOrder流量在atow分组下线时重新路由回atow分组。**\n\n### 4.2【原因分析】\n##### 一句话原因：\n在atow分组下线时触发HSF归组规则的重新编译和推送，流量重新路由到atow服务，但此时atow已无机器导致报HSFServiceAddressNotFoundException。\n\n##### 根因分析：\n1. 和HSF团队进行详细沟通后，线上和预发\\安全生产流程存在差异，预发\\安全生产环境下线机器不会触发归组规则的重新编译，所以预发操作机器下线后，归组规则仍然是空的，所有流量都可以正常请求ator分组;但是线上环境**下线机器会触发归组规则的重新编译**，导致**已经删除的归组规则重新生成**，此时ator分组已经不能继续响应写流",
    "chunk_order_index": 2,
    "full_doc_id": "doc-81fac8e0db4de4c47b2250dcf1666298"
  },
  "chunk-1b8a87c67025df7187f5c3f0bd1c79c2": {
    "tokens": 1200,
    "content": "预发\\安全生产流程存在差异，预发\\安全生产环境下线机器不会触发归组规则的重新编译，所以预发操作机器下线后，归组规则仍然是空的，所有流量都可以正常请求ator分组;但是线上环境**下线机器会触发归组规则的重新编译**，导致**已经删除的归组规则重新生成**，此时ator分组已经不能继续响应写流量，随着最后一批机器下线产生最终故障****\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/51556504/1728397565612-284ab41a-9c5a-42a0-9962-08b16e7f075d.png)\n\n2. ato应用较为臃肿且支持预热等功能，启动时间较长（10+分钟）导致恢复时间较长。\n\n## 五、关注点分析\n##### 【关注点1】关键中间件变更方案设计是否经过中间件及团队核心开发QA同学的共同评估？\n:::info\n**问题总结：**\n\n团队内部对HSF归组规则和模版了解不够，导致方案不够完善：\n\n       a. 规则及模板运行机制；\n\n       b. 预发\\安全生产\\线上环境的规则机制不一致。\n\n**改进点：**\n\n+ 交通域 [@陨冰](undefined/xuanming.wxm)[@玄则](undefined/guozhiang.gza) 10.24\n    - 针对分组和应用下线场景，结合本次及其他团队的经验，整理一份完善的变更规范手册；随着成本治理的推进，后续其他团队也会有应用\\分组下线，以此保障相关操作的稳定性；\n    - 针对HSF规则和模板，结合本次故障进行相关经验沉淀并进行分享，杜绝团队内再次出现类似问题；\n+ 交易中台  [@陨冰](undefined/xuanming.wxm) 10.18\n    - 针对这个故障，如果在HSF归组文档、优先摘掉HSF任意点上进一步深入都可避免该问题；所以面临后续HSF\\DB等中间件高危操作，需要做到几点：\n        * 必须提前和中间件同学进行风险沟通，并落地到相关发布\\切流文档上；\n        * 需要拉齐组内核心开发+QA同学，一起对齐高危操作方案；\n        * TL通过发布文档进行最终把控\n    - **高危操作**：1）中间件规则调整：HSF路由\\DB分表路由等；2）架构链路切流；3）DB\\TAIR\\OTS等数据迁移、规格变更等；4）变更底层中间件，如OpenSearch->OTS等。\n+ **安全生产建议**：流量先清零再操作分组下线是更稳妥的方式，后续整理文档的时候一并考虑进去，可以是在线化的list，方便大家查看和执行。\n\n:::\n\n##### **【关注点2】变更过程中经过了测试验证、预发、灰度等所有流程，且过程中均有在观察监控，但仍未发现异常,未能及时阻断，后续可以做些什么提早发现问题？**\n:::info\n**问题总结：**操作流程严谨度上可进一步提升，针对各个节点进一步细化；\n\n    1. 在分组规则变更、机器缩容的各环节中需要明确关注哪些监控：大盘波动、流量变化以及机器性能；分批下线过程中需要多关注流量变化。\n    2. 针对ato老应用启动慢的情况，应该优先摘掉HSF服务，而不是下线机器。\n    3. 不要过度相信预发环境、安全生产环境的验证结果，不排除其他中间件也有类似差异。\n\n**改进点：**同关注点1\n\n:::\n\n##### **【关注点3】本次故障中扩容机器生效时间较长，是否还有其他的兜底策略或应急手段可以缩短故障恢复时长**\n:::info\n**问题总结：**如果正式流量下线中关注下ator的流量变化，就会意识到分组规则重新被编译，理论可以避免或缩短恢复时长。\n\n**改进点：**后续规范中在线上环境操作变更时要增加流量变化的观测，建议这些过程需要把QA同学一起拉上。\n\n:::\n\n##### **【关注点4】本次变更是否有同步上下游？若上下游提前知晓，是否可以有预案应对？**\n:::info\n**问题总结：**未同步上下游，不过根据目前情形来看，即便知晓也无很好的预案。\n\n**改进点：**暂无\n\n:::\n\n### 5.1【系统质量】\n#### 5.1.1 需求&设计评估\n**〖关注点1〗****是否涉及产品、技术方案评估？此核心的问题是什么，如何改进？**\n\n- [x] **是，涉及**\n    - [x] 需求评估遗漏：方案设计不完善\n    - [ ] 产品设计缺陷\n    - [ ] 系统架构设计缺陷",
    "chunk_order_index": 3,
    "full_doc_id": "doc-81fac8e0db4de4c47b2250dcf1666298"
  },
  "chunk-574436030b2068b61a472680591176e6": {
    "tokens": 1200,
    "content": ":::\n\n### 5.1【系统质量】\n#### 5.1.1 需求&设计评估\n**〖关注点1〗****是否涉及产品、技术方案评估？此核心的问题是什么，如何改进？**\n\n- [x] **是，涉及**\n    - [x] 需求评估遗漏：方案设计不完善\n    - [ ] 产品设计缺陷\n    - [ ] 系统架构设计缺陷\n        - [ ] 容错性不足 \n        - [ ] 单点，无冗余\n        - [ ] 缺乏自我保护\n        - [ ] 缓存设计不当\n        - [ ] 容量评估不足\n        - [ ] 非幂等设计\n        - [ ] 强弱依赖不合理\n        - [ ] 其他：__________\n- [ ] 否，不涉及\n\n\n\n#### 5.1.2 代码质量\n**〖关注点1〗是否代码自身存在漏洞或BUG、代码健壮性是否存在问题等?**\n\n**〖问题分析〗**不涉及\n\n\n\n**〖关注点2〗****是否经过CodeReview？CodeReview阶段是否发现问题？为何没发现？**\n\n+ **是否经过CR**\n    - [ ] 是\n    - [ ] 否\n    - [x] 不涉及\n+ **是否设置合理的CR卡点**\n    - [ ] 是\n    - [ ] 否\n    - [x] 不涉及\n+ **CodeReview阶段是否发现问题？为何没发现？后续如何发现？**\n    - [ ] 是\n    - [ ] 否\n    - [x] 不涉及\n\n\n\n**〖关注点3〗****测试阶段**\n\n+ **测试内容：**涉及的测试提交单、测试用例等\n+ **测试人员：**\n+ **是否经过测试验证**\n    - [x] 是，验证环境\n        - [x] 预发环境\n        - [ ] 日常环境\n    - [ ] 是，测试方法\n        - [ ] 单元测试\n        - [ ] 功能回归测试\n        - [ ] 集成测试/链路测试\n        - [ ] 验收测试\n    - [ ] 否\n    - [ ] 不涉及\n+ **测试未发现原因是什么？后续如何改进？**\n    - [ ] 回归测试遗漏\n        - [ ] 手工回归测试用例遗漏\n        - [ ] 自动化未建设\n        - [ ] 自动化回归覆盖不足\n        - [ ] 其他：__________\n    - [ ] 新场景测试遗漏\n        - [ ] 功能测试用例遗漏，包括正常分支和异常分支\n        - [ ] 容灾兜底测试遗漏\n        - [ ] 客户端兼容性测试遗漏\n        - [ ] 埋点测试遗漏\n        - [ ] 性能测试遗漏，影响评估不足\n        - [ ] 安全测试遗漏\n    - [x] 其他：_____中间件线上/预发存在差异_____\n\n#### 5.1.3 变更质量\n+ **是否涉及变更：**\n    - [x] 是\n    - [ ] 否\n+ **变更类型：**\n    - [ ] 代码发布\n    - [x] 配置变更\n    - [x] 其他变更：缩容\n    - [ ] 不涉及\n+ **变更平台是否接入ChangeFree：**\n    - [x] 是，CF变更单链接：_[https://aicf.alibaba-inc.com/aicf/approval/detail/8105987](https://aicf.alibaba-inc.com/aicf/approval/detail/8105987)______\n\n附缩容工单：\n\n[https://cd.aone.alibaba-inc.com/unite/micro/ops/app/4483/OFFLINE/detail?changeOrderId=456350611000118](https://cd.aone.alibaba-inc.com/unite/micro/ops/app/4483/OFFLINE/detail?changeOrderId=456350611000118)\n\n[https://cd.aone.alibaba-inc.com/unite/micro/ops/app/4483/OFFLINE/detail?changeOrderId=456597337000109](https://cd.aone.alibaba-inc.com/unite/micro/ops/app/4483/OFFLINE/detail?changeOrderId=456597337000109)\n\n    - [ ] 否\n+ **是否违反变更红线3.1 **[链接](https://aliyuque.antfin.com/trecs/fzg6dy/uar1k6)\n    - [ ] 是，违反哪条原则：\n    - [x] 否\n\n\n\n**〖关注点1〗****灰度阶段**\n\n+ **是否经过灰度：**\n    - [x] 是\n    - [ ] 否\n+ **观测了哪些监控**：__\n    - [ ] 黑屏、白屏\n    - [ ] GOC监控：\n    - [x] 系统大盘：[https://x.alibaba-inc.com/custom/59/product/preview/cms/1529](https://x.alibaba-inc.com/custom/59/product/preview/cms/1529)\n    - [x] 其他：\n    1. 安全生产环境负载：[https://eagleeye.alibaba-inc.com/#/statlog?appName=ato:atorhost_spe&tab=1](https://eagleeye.alibaba-inc.com/#/statlog?appName=ato:atorhost_spe&tab=1)\n    2",
    "chunk_order_index": 4,
    "full_doc_id": "doc-81fac8e0db4de4c47b2250dcf1666298"
  },
  "chunk-56fedc1e8622e2d1462710044d4a8b0e": {
    "tokens": 1200,
    "content": "/cms/1529](https://x.alibaba-inc.com/custom/59/product/preview/cms/1529)\n    - [x] 其他：\n    1. 安全生产环境负载：[https://eagleeye.alibaba-inc.com/#/statlog?appName=ato:atorhost_spe&tab=1](https://eagleeye.alibaba-inc.com/#/statlog?appName=ato:atorhost_spe&tab=1)\n    2. 安全生产环境流量：[https://eagleeye.alibaba-inc.com/#/statlog?appName=ato:atorhost_spe&tab=3](https://eagleeye.alibaba-inc.com/#/statlog?appName=ato:atorhost_spe&tab=3)\n+ **是否灰度期间发现问题？**\n    - [ ] 是\n        - [ ] 是否灰度流量过大，导致故障\n        - [ ] 灰度发现但未有效或及时修复，导致故障\n        - [ ] 其他：___________\n    - [x] 否，后续如何灰度发现？_____________\n+ **未灰度发现原因**\n    - [ ] 应用灰\n        - [ ] 灰度流量太小\n        - [ ] 灰度阶段无监控\n        - [ ] 灰度批次不合理\n        - [ ] 超长时间灰度才能发现\n    - [ ] 业务灰：策略不合理\n    - [x] 灰度无法发现 :下线atow_spe机器不会触发归组规则重新编译（同预发）\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/51556504/1728464021060-fe87f612-0526-4c7a-9e68-7903683e851a.png)\n\n    - [ ] 其他：_____________\n\n\n\n**〖关注点2〗****上线阶段**\n\n+ **是否有确定的监控观测指标**\n    - [x] 是，监控指标及监控链接：\n    1. 业务大盘：[https://x.alibaba-inc.com/custom/59/product/preview/cms/1529](https://x.alibaba-inc.com/custom/59/product/preview/cms/1529) \n    2. 线上环境机器负载[https://eagleeye.alibaba-inc.com/#/statlog?appName=ato:atorhost&tab=1](https://eagleeye.alibaba-inc.com/#/statlog?appName=ato:atorhost&tab=1)\n    3. 线上环境机器流量 [https://eagleeye.alibaba-inc.com/#/statlog?appName=ato:atorhost&tab=3](https://eagleeye.alibaba-inc.com/#/statlog?appName=ato:atorhost&tab=3)\n    - [ ] 否\n+ **是否在窗口期进行发布变更**\n    - [x] 是\n    - [ ] 否，原因：\n+ **变更是否影响上下游**\n    - [x] 是，是否有提前知会上下游评估及关注变更\n        - [ ] 有提前知会\n        - [x] 没有提前知会\n    - [ ] 否\n\n### 5.2【处置能力】\n#### 5.2.1 故障发现&响应\n+ **是否监控发现**\n    - [x] 故障触发方 监控发现\n    - [ ] 故障受影响方 监控发现\n    - [ ] 否，原因为：（监控无效/监控缺失）\n+ **是否5分钟内响应**\n    - [x] 是\n    - [ ] 否，原因为：\n+ **是否存在应急协同问题**\n    - [ ] 是\n        - [ ] 应急流程不明确（无流程或者流程不清晰、应急相关角色&职责不明确，缺失一号位等)\n        - [ ] 应急执行不到位（有流程，但未按流程执行，通告发送不及时，响应不及时等）\n    - [x] 否\n\n#### 5.2.2 故障定位&恢复\n+ **主要恢复方式：**\n    - [ ] 代码发布/回滚\n    - [ ] 配置发布/回滚\n    - [ ] 数据订正\n    - [x] 机器隔离/重启/扩容\n    - [ ] 配置限流\n    - [ ] 预案降级\n    - [ ] 自动恢复\n    - [ ] 其他：\n+ **是否10分钟内恢复**__\n    - [ ] 是\n    - [x] 否，原因：老应用重启时间较长__11分钟-13分钟\n\n**〖关注点1〗定位&恢复阶段存在什么问题？是否可以增加预案，****有更快的恢复方式？****相关的优化改进？**\n\n**〖问题总结〗**很老的应用，机器启动确实需要这么长的时间。\n\n**〖改进点〗**暂无\n\n## 六、故障Action\n| **序号** | *******Action** | *******负责人** | *******计划完成时间** | **验收人** | **是否keyAction** |\n| :---: | --- | :---: | --- | :---: | --- |\n| 1 | 短期：【交通】应用\\分组下线变更规范和推广 | �",
    "chunk_order_index": 5,
    "full_doc_id": "doc-81fac8e0db4de4c47b2250dcf1666298"
  },
  "chunk-f3e7bad8d91c97b635a21e667ece5ec8": {
    "tokens": 430,
    "content": "这么长的时间。\n\n**〖改进点〗**暂无\n\n## 六、故障Action\n| **序号** | *******Action** | *******负责人** | *******计划完成时间** | **验收人** | **是否keyAction** |\n| :---: | --- | :---: | --- | :---: | --- |\n| 1 | 短期：【交通】应用\\分组下线变更规范和推广 | 陨冰 |     10.24 | 鼎霖 | 是 |\n| 2 | 短期：【交通】HSF规则及模板注意事项沉淀分享 | 玄则 |     10.24 | 鼎霖 | 否 |\n| 3 | 短期：【交易中台】关键变更流程机制制定 | 陨冰 |     10.18 | 墨岚 | 否 |\n\n\n## 七、故障定级&定责&故障分自查\n【故障等级】P2\n\n【故障责任方】飞猪-飞猪技术部-交通行业研发中心-机票导购与交易-交易中台\t\n\n责任人：由宸\n\n测试责任人：鼎霖\n\n【故障分】_/* 以系统计算结果为准*/_\n\n| **  系统质量（30%）** | | | | | **处置能力（70%）** |\n| :---: | --- | --- | --- | --- | :---: |\n| **相关方** | **需求设计** | **代码质量** | **变更质量** | **自定义项** | **发生时间** | **发现时间（30%）** | **恢复时间（40%）** |\n|  飞猪-飞猪技术部-交通行业研发中心-机票导购与交易-交易中台 | 否 | 否 | 是 | 变更方案不完善 | 15:39 | 15:34 | 15:49 |",
    "chunk_order_index": 6,
    "full_doc_id": "doc-81fac8e0db4de4c47b2250dcf1666298"
  },
  "chunk-ed762209224b35a12dbe20e7a11d9ca3": {
    "tokens": 1200,
    "content": "_**会议开始，宣导复盘文化**_\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/9827/1659103353652-0274c8cd-7318-4cd9-b730-0d66221680b6.png)\n\n_**内容涉及公司B3级别以上机密数据，请注意保密！**_\n\n| **故障链接** | [https://tr.alibaba-inc.com/ormEmergency/workbench/emergency/202410100000001345001](https://tr.alibaba-inc.com/ormEmergency/workbench/emergency/202410100000001345001)[https://tr.alibaba-inc.com/ormEmergency/workbench/emergency/202410100000001345001](https://tr.alibaba-inc.com/ormEmergency/workbench/emergency/202410100000001345001) |\n| --- | --- |\n| **复盘时间** | 10月15日 15:00 - 16:00 |\n| **复盘地点** | A6-3-6-N 稻香谷 |\n| **参与人** | **手机天猫：****SRE：**裴度、若氺、异云、岱泽、追溯、德纯、立行、航洋、国梓、书牧开发、测试：奕博、千荷、天士、落时、胤弘、楚月、零雲、疏闳产品：方休客满：子昕GOC：木棉**TPP基础平台：**开发、测试：逸万、鬼彻GOC：徙南**终端平台：**京波 |\n| **主持人** | 木棉 |\n\n\n## 一、故障简述\n故障简述：\n\n2024-10-09 16:56左右，陆续有用户反馈手猫搜索存在问题，于22:00定位到手猫商品搜索TPP场景29724内解析QP返回结果异常报错，通过回滚+重启后，故障止血。故障期间客诉达到20+，触发P4。\n\n## 二、故障过程回顾\n### 2.1【时间线概览】\n_/* 填写说明：P1P2故障必填，后续考虑产品化，沉淀到故障管理平台，无需文档记录*/_\n\n![画板](https://intranetproxy.alipay.com/skylark/lark/0/2023/jpeg/7773/1688971427269-d3bc50df-aa87-4ac9-9d5c-bf10e0e07646.jpeg)\n\n\n\n### 2.2【故障处理时间线】\n2024-10-08 14:55，【风险注入】手猫搜索工程 [@奕博](undefined/zhengbo.wzb) 通过对手猫商品搜索TPP场景29724发布搜索摩罗插件升级，解决0928压测中发现的该TPP场景调用奥格SDK查询人群存在JSON反序列化报错问题。\n\n2024-10-09 15:50， 双11第一次全链路压测进行手猫导购&搜索压测试跑验证，联系奥格技术龚少检查0928问题修复情况。龚少通过arthas模拟验证发现手猫商品搜索TPP场景29724的服务器上还存在奥格老版本SDK，即还有JSON反序列化异常风险。\n\n2024-10-09 16:02， 导购&搜索10%压测试跑流量停止后，手猫搜索工程技术 [@奕博](undefined/zhengbo.wzb)对手猫商品搜索TPP场景29724的服务器进行重启，尝试解决老摩罗TPP插件引入的奥格老版本SDK问题。\n\n2024-10-09 16:16，【事件发生】手猫商品搜索TPP场景29724调用QP服务的异常率开始上涨。\n\n2024-10-09 18:30，【事件发现】【业务响应】手猫搜索工程技术[@银雕](undefined/yindiao.sq) 发现ha3中向量召回error上涨，手猫搜索算法[@疏闳](undefined/gyf265697) 排查ha3向量召回问题，排查过程中发现中发现有压测流需等待压测结束。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/14085/1728875703071-2a81d5f8-3c56-4b92-8dad-033f160ffecf.png)\n\n2024-10-09 20:20，【事件发现】【业务响应】压测停止，向量召回仍有少量error qps，手猫搜索算法[@疏闳](undefined/gyf265697)继续排查向量召回问题。\n\n2024-10-09 20:50，【事件发现】【业务响应】 手猫搜索算法[@疏闳](undefined/gyf265697) 定位是由于qp访问失败导致向量召回存在少量error qps，并反馈给手猫搜索工程技术 [@奕博](undefined/zhengbo.wzb)，开始进行问题排查。\n\n2024-10-09 22:00，【初因定位】手猫搜索工程 [@奕博](undefined/zhengbo.wzb) 定位到手猫商品搜索TPP场景29724内解析QP返回结果",
    "chunk_order_index": 0,
    "full_doc_id": "doc-542f60c16c2b08c54386ab05c5c3efbf"
  },
  "chunk-984ffdde71fee7339cdbc6bab499a073": {
    "tokens": 1200,
    "content": "265697) 定位是由于qp访问失败导致向量召回存在少量error qps，并反馈给手猫搜索工程技术 [@奕博](undefined/zhengbo.wzb)，开始进行问题排查。\n\n2024-10-09 22:00，【初因定位】手猫搜索工程 [@奕博](undefined/zhengbo.wzb) 定位到手猫商品搜索TPP场景29724内解析QP返回结果异常报错。\n\n2024-10-09 22:03，【恢复执行】手猫搜索工程 [@奕博](undefined/zhengbo.wzb) 对手猫商品搜索TPP场景29724代码回滚至10.8下午发布前版本，发布完成后22:17 对该TPP场景服务器进行重启。\n\n2024-10-09 23:30，【事件恢复】手猫商品搜索TPP场景29724线上环境重启完成，TPP调用QP服务异常率降低到0.1%以下，线上环境手猫搜索结果相关性恢复正常。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/10179/1728491245960-137759e9-f243-418b-ae22-f42b92ecfce4.png)\n\n## 三、故障原因\n### 3.1【背景说明】\n背景：\n\n一句话背景：手猫搜索tpp希望通过升级morro客户端版本解决调用奥格人群失败的问题\n\n+ 9月28日 手猫搜索全链路压测，奥格技术同学反馈tpp场景29724（手猫搜索tpp场景）通过奥格SDK查询人群存在JSON反序列化报错，经排查发现原因是场景29724使用的morro版本过低，当时给的方案是十一长假之后升级morro client版本\n+ 10月8日14:55，奕博将29724使用的morro sdk版本从1.0.53-SNAPSHOT升级到1.1.22.34-SNAPSHOT，morro插件版本从1.0.2-SNAPSHOT升级到1.0.3.21-SNAPSHOT，在预发发布并验证生效后，全量发布至线上\n+ 10月9日15:50，双11第一次全链路压测手猫导购&搜索压测试跑验证，奥格技术龚少检查0928问题修复情况。龚少通过arthas模拟验证发现手猫商品搜索TPP场景29724的服务器上还存在奥格老版本SDK，即还有JSON反序列化异常风险。随后反馈给奕博，奕博通过重启的方式试图让所有容器更新到最新的版本，以解决奥格人群JSON反序列化异常风险\n\n### 3.2【原因分析】\n**一句话原因：**\n\n新的morro sdk 包引入的dom4j版本和tpp平台dom4j的版本冲突，导致业务方案无法解析qp返回的xml结果，qp无结果进而导致搜索结果相关性差\n\n\n\n**根因分析：**\n\n方案代码在qp结果的get里，进行parse，parse会走到这一行，这个singleton的instance会在第一次调进来的时候进行初始化\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/49956/1728634838181-d37bb2a4-0dbb-4b4b-be99-b87fca1827fa.png)\n\n初始化的时候会取thread的contextClassloader，这时候取到了方案类加载器BootClassLoader，导致这个实例对应的类加载器是方案类加载器，而上面的强转，外面的类的加载器是KondyleBootrap类加载（平台的），导致类冲突报错。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/49956/1728634838810-03afdeb7-3855-4980-a1fa-dbaa5ceacdcf.png)\n\n在每次请求解析qp返回结果时报错\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/49956/1728638557986-7b7672d9-e05c-4dc8-bd4f-34abf074c920.png)\n\n## 四、关注点分析\nqp无结果@tianqing 先评估一下周期\n\n#### 〖关注点1〗2024-10-08发布后正常，但是9号下午搜索TPP场景29724的服务器重启后就出问题，重启为啥会导致问题？\n:::info\n**〖问题总结〗**\n\n方案代码在qp结果的get里，进行parse，parse会走到这一行，这个singleton的instance会在第一次调进来的时候进行初始化\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/14085/1728896424335-aff0f80f-ec43-4d42-8468-7f05416e8059.png)\n\n初始化的时候会取thread的contextClassloader，这时候取到了方案类加载器BootClassLoader，导致这个实例对应的类加载器是方案类加载器，而上面的强转，外面的类的加载器是KondyleBootrap类加载（平台的），导致类冲突报错。\n\n![](https://intranetproxy.alipay.com/skylark/l",
    "chunk_order_index": 1,
    "full_doc_id": "doc-542f60c16c2b08c54386ab05c5c3efbf"
  },
  "chunk-08229e6a320f27c92f35105e4686fce6": {
    "tokens": 1200,
    "content": "f-ec43-4d42-8468-7f05416e8059.png)\n\n初始化的时候会取thread的contextClassloader，这时候取到了方案类加载器BootClassLoader，导致这个实例对应的类加载器是方案类加载器，而上面的强转，外面的类的加载器是KondyleBootrap类加载（平台的），导致类冲突报错。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/14085/1728896424817-f103a407-4e1f-40b9-adab-270a9a9a5516.png)\n\n#### 为什么之前一直没错\n之前代码里没有引用到org.dom4j.util.SimpleSingleton这个类所在的包，所以BootClassLoader加载不到，由平台的类加载器加载。而新的代码以compile把这个依赖引进来了\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/14085/1728896424133-7f63625d-a9bb-4c9b-8963-a18512ae3421.png)\n\n#### 为什么发布没报错，重启报错了\n前面说的那个singleton实例是容器级别的，方案发布不会改这个实例，所以不会报错，但重启的时候只有新代码，singleton重新创建，就错了\n\n**〖改进点〗**\n\n+ 推荐使用干净 SDK ，TPP侧保障基础组件没有冲突[@鬼彻](undefined/guiche.zj) \n+ [@奕博](undefined/zhengbo.wzb) 搜索干净 SDK改造，逸万协助  1130\n+ 代码相关的变更，建议由热发布改成重启发布。[@奕博](undefined/zhengbo.wzb)** **\n\n:::\n\n\n\n#### 〖关注点2〗2024-10-09 22:00回滚后没有恢复，为什么需要重启才恢复\n:::info\n**〖问题总结〗**\n\n和上面类似，那个singleton实例是容器级别，在已经出问题的情况下，光回滚代码没用，得重启机器。\n\n**〖改进点〗**热发布改成重启发布后，只需要回滚代码。\n\n:::\n\n\n\n#### 〖关注点3〗2024-10-09 16:02重启是为了解决老摩罗TPP插件引入的奥格老版本SDK问题，现在这个问题是否解决？\n:::info\n**〖问题总结〗**\n\n已经解决， 通过排除dom4j上线完成，重启验证通过。\n\n**〖改进点〗**已解决\n\n:::\n\n#### 〖关注点4〗当晚人工客诉100+，但是吐槽吧和voc都没有预警，原因是？\n:::info\n**〖问题总结〗吐槽吧问题**[@京波](undefined/yongbo.wyb)** **\n\n1、吐槽吧：老旧代码隐藏bug，导致无法进行告警计算，已修复问题并添加监控。\n\n2、voc：配置的预警关键词存在问题\n\n**〖改进点〗**\n\n+ 吐槽吧问题已经修复\n+ VOC后续优化配置问题\n\n:::\n\n#### 〖关注点5〗整个恢复时长比较长，**是否还有其他的兜底策略或应急手段可以缩短故障恢复时长**？\n:::info\n**〖问题总结〗目前现有的能力是可以降级召回、引入搜索兜底。使用哪一套预案看当时的具体情况。**\n\n**〖改进点〗**\n\n改成重启发布后就可以快速回滚，如果不满足预期的，可联系平台同学。若出现其他问题，可用降级召回、引入搜索兜底。\n\n:::\n\n### 4.1【系统质量】\n#### 4.1.1 需求&设计评估 不涉及\n**〖关注点1〗****是否涉及产品、技术方案评估？此核心的问题是什么，如何改进？**\n\n- [ ] **是，涉及**\n    - [ ] 需求评估遗漏\n    - [ ] 产品设计缺陷\n    - [ ] 系统架构设计缺陷\n        - [ ] 容错性不足 \n        - [ ] 单点，无冗余\n        - [ ] 缺乏自我保护\n        - [ ] 缓存设计不当\n        - [ ] 容量评估不足\n        - [ ] 非幂等设计\n        - [ ] 强弱依赖不合理\n        - [ ] 其他：__________\n- [ ] 否，不涉及\n\n**〖问题总结〗**\n\n**〖改进点〗**_**需明确写明不同故障相关方的改进项（若有的话），下同。**_\n\n1、\n\n#### 4.1.2 代码质量 不涉及\n**〖关注点1〗是否代码自身存在漏洞或BUG、代码健壮性是否存在问题等?**\n\n**〖问题分析〗**\n\n**〖改进点〗**_**需明确写明不同故障相关方的改进项（若有的话），下同。**_\n\n1、\n\n\n\n**〖关注点2〗****是否经过CodeReview？CodeReview阶段是否发现问题？为何没发现？**\n\n+ **是否经过CR**\n    - [ ] 是\n    - [ ] 否\n    - [ ] 不涉及",
    "chunk_order_index": 2,
    "full_doc_id": "doc-542f60c16c2b08c54386ab05c5c3efbf"
  },
  "chunk-f51463ae484b7a581a46f088de0b7e11": {
    "tokens": 1200,
    "content": "性是否存在问题等?**\n\n**〖问题分析〗**\n\n**〖改进点〗**_**需明确写明不同故障相关方的改进项（若有的话），下同。**_\n\n1、\n\n\n\n**〖关注点2〗****是否经过CodeReview？CodeReview阶段是否发现问题？为何没发现？**\n\n+ **是否经过CR**\n    - [ ] 是\n    - [ ] 否\n    - [ ] 不涉及\n+ **是否设置合理的CR卡点**\n    - [ ] 是\n    - [ ] 否\n    - [ ] 不涉及\n+ **CodeReview阶段是否发现问题？为何没发现？后续如何发现？**\n    - [ ] 是\n    - [ ] 否\n    - [ ] 不涉及\n\n**〖问题分析〗******\n\n**〖改进点〗**_**需明确写明不同故障相关方的改进项（若有的话），下同。**_\n\n1、\n\n\n\n**〖关注点3〗****测试阶段**\n\n+ **测试内容：**涉及的测试提交单、测试用例等\n+ **测试人员：楚月**\n+ **是否经过测试验证**\n    - [x] 是，验证环境\n        - [x] 预发环境\n        - [ ] 日常环境\n    - [x] 是，测试方法\n        - [ ] 单元测试\n        - [ ] 功能回归测试\n        - [x] 集成测试/链路测试\n        - [ ] 验收测试\n    - [ ] 否\n    - [ ] 不涉及\n\nTPP变更发布时，开发奕博联系QA进行了规范的提测流程：\n\n1. 在预发环境通过TPP流量用例集执行自动化，失败4个，均为请求时间较长，无功能问题；\n2. 对比预发环境、SPE环境算法召回结果，召回结果相似度>80%的用例占61.8%，相似度<80%的用例通过预览商品对比没有相似度问题\n3. TPP代码发布到SPE环境后，自动化用例执行成功\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/242479/1728658850582-15b031d9-8ec0-483c-b9ba-a683a500dfa9.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/242479/1728659249086-e82d3a61-82d5-4ca2-a328-245466f4b7a1.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/242479/1728658894219-2babaa5a-c36a-4a28-9ad5-8207d6357f34.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/242479/1728658767296-45aa7653-e30c-4268-865b-ced41ed2a91f.png)\n\n+ **测试未发现原因是什么？后续如何改进？**\n    - [ ] 回归测试遗漏\n        - [ ] 手工回归测试用例遗漏\n        - [ ] 自动化未建设\n        - [ ] 自动化回归覆盖不足\n        - [x] 其他：发布前后问题未出现\n    - [ ] 新场景测试遗漏\n        - [ ] 功能测试用例遗漏，包括正常分支和异常分支\n        - [ ] 容灾兜底测试遗漏\n        - [ ] 客户端兼容性测试遗漏\n        - [ ] 埋点测试遗漏\n        - [ ] 性能测试遗漏，影响评估不足\n        - [ ] 安全测试遗漏\n    - [ ] 其他：__________\n\n**〖问题总结〗**\n\n**〖改进点〗**_**需明确写明不同故障相关方的改进项（若有的话），下同。**_\n\n1、本次发布流程操作规范，测试流程上无明显需要改进的地方\n\n#### 4.1.3 变更质量 不涉及\n+ **是否涉及变更：**\n    - [x] 是\n    - [ ] 否\n+ **变更类型：**\n    - [x] 代码发布\n    - [ ] 配置变更\n    - [ ] 其他变更：____________\n    - [ ] 不涉及\n+ **变更平台是否接入ChangeFree：**\n    - [ ] 是，CF变更单链接：________\n\n_/*要这样的链接_ [https://aicf.alibaba-inc.com/aicf/change/detail/1725370372](https://aicf.alibaba-inc.com/aicf/change/detail/1725370372) */\n\n    - [ ] 否\n+ **是否违反变更红线3.1**** **[链接](https://aliyuque.antfin.com/ngoc/fzg6dy/uar1k6)\n    - [ ] 是，违反哪条原则：\n    - [ ] 否\n\n\n\n**〖关注点1〗****灰度阶段**\n\n+ **是否经过灰度：**\n    - [x] 是\n    - [ ] 否\n+ **观测了哪些监控**：_可以附链接_\n    - [ ] 黑屏、白屏\n    - [x] GOC",
    "chunk_order_index": 3,
    "full_doc_id": "doc-542f60c16c2b08c54386ab05c5c3efbf"
  },
  "chunk-81861a3d4185abd9e00612cf9ff735c2": {
    "tokens": 1200,
    "content": "que.antfin.com/ngoc/fzg6dy/uar1k6)\n    - [ ] 是，违反哪条原则：\n    - [ ] 否\n\n\n\n**〖关注点1〗****灰度阶段**\n\n+ **是否经过灰度：**\n    - [x] 是\n    - [ ] 否\n+ **观测了哪些监控**：_可以附链接_\n    - [ ] 黑屏、白屏\n    - [x] GOC监控：\n    - [x] 系统大盘：\n    - [ ] 其他：___________\n+ **是否灰度期间发现问题？**\n    - [ ] 是\n        - [ ] 是否灰度流量过大，导致故障\n        - [ ] 灰度发现但未有效或及时修复，导致故障\n        - [ ] 其他：___________\n    - [ ] 否，后续如何灰度发现？______重启后出的问题_______\n+ **未灰度发现原因**\n    - [ ] 应用灰\n        - [ ] 灰度流量太小\n        - [ ] 灰度阶段无监控\n        - [ ] 灰度批次不合理\n        - [ ] 超长时间灰度才能发现\n    - [ ] 业务灰：策略不合理\n    - [ ] 灰度无法发现\n    - [ ] 其他：_____________\n\n**〖问题总结〗**\n\n**〖改进点〗**_**需明确写明不同故障相关方的改进项（若有的话），下同。**_\n\n1、\n\n\n\n**〖关注点2〗****上线阶段**\n\n+ **是否有确定的监控观测指标**\n    - [ ] 是，监控指标及监控链接：\n    - [ ] 否\n+ **是否在窗口期进行发布变更**\n    - [x] 是\n    - [ ] 否，原因：\n+ **变更是否影响上下游**\n    - [ ] 是，是否有提前知会上下游评估及关注变更\n        - [ ] 有提前知会\n        - [ ] 没有提前知会\n    - [ ] 否\n\n**〖问题总结〗**\n\n**〖改进点〗**_**需明确写明不同故障相关方的改进项（若有的话），下同。**_\n\n1、\n\n### 4.2【处置能力】\n#### 4.2.1 故障发现&响应\n+ **是否监控发现**\n    - [ ] 故障触发方 监控发现\n    - [ ] 故障受影响方 监控发现\n    - [x] 否，原因为：（监控无效）\n+ **是否5分钟内响应**\n    - [ ] 是\n    - [x] 否，原因为：\n+ **是否存在应急协同问题**\n    - [ ] 是\n        - [ ] 应急流程不明确（无流程或者流程不清晰、应急相关角色&职责不明确，缺失一号位等)\n        - [x] 应急执行不到位（有流程，但未按流程执行，通告发送不及时，响应不及时等）\n    - [ ] 否\n\n**〖问题总结〗**\n\n**1、未通过监控发现：**未配置预警规则\n\n**2、舆情告警失效，**吐槽吧和VOC舆情从10.09 17:30就开始产生，却由于系统故障未告警通知负责人和舆情群\n\n**〖改进点〗**_****_\n\n1、搜索监控改进：\n\n    - QA侧增加相关性线上自动化、CPC巡检每小时1次\n    - ![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/242479/1728975016532-43e5e2a6-3aa8-49c0-9ac8-615887457cef.png)\n\n2、舆情监控优化：\n\n    - 联系吐槽吧开发修复告警失效的问题\n    - 质量侧针对天猫APP业务的舆情，进行整体的趋势分析，加强自动化识别，聚类问题的能力，并改善预警机制。\n\n#### 4.2.2 故障定位&恢复\n+ **主要恢复方式：**\n    - [x] 代码发布/回滚\n    - [ ] 配置发布/回滚\n    - [ ] 数据订正\n    - [x] 机器隔离/重启/扩容\n    - [ ] 配置限流\n    - [ ] 预案降级\n    - [ ] 自动恢复\n    - [ ] 其他：\n+ **是否10分钟内恢复**_/* P1P2故障填写*/_\n    - [ ] 是\n    - [x] 否，原因：__________\n\n**〖关注点1〗定位&恢复阶段存在什么问题？是否可以增加预案，****有更快的恢复方式？****相关的优化改进？**\n\n**〖问题总结〗目前现有的能力是可以降级召回、引入搜索兜底。使用哪一套预案要看当时的具体情况。**\n\n\n\n\n**〖关注点2〗业务自身是否具备容灾逃逸能力？后续如何改进？**_/* 如涉及基础设施引发的故障，可填写*/_\n\n- [ ] 具备容灾能力\n    -",
    "chunk_order_index": 4,
    "full_doc_id": "doc-542f60c16c2b08c54386ab05c5c3efbf"
  },
  "chunk-8a72a322b95ff5060683846a2a95cd36": {
    "tokens": 1200,
    "content": "相关的优化改进？**\n\n**〖问题总结〗目前现有的能力是可以降级召回、引入搜索兜底。使用哪一套预案要看当时的具体情况。**\n\n\n\n\n**〖关注点2〗业务自身是否具备容灾逃逸能力？后续如何改进？**_/* 如涉及基础设施引发的故障，可填写*/_\n\n- [ ] 具备容灾能力\n    - [ ] 因未演练不敢执行\n    - [ ] 因有损评估决策不执行\n    - [ ] 无决策或者决策不当，未执行\n- [x] 不具备容灾能力\n\n**〖问题总结〗**\n\n**〖改进点〗**\n\n#### 4.2.3 SRE应急参与（淘天业务技术参考）\n_/* __复盘会议前补充好相关信息，复盘会议上达成一致，如果有争议由若氺带回最终决策，同步GOC。__*/_\n\n+ **SRE工程师应急参与**：_如果SRE工程师和专家是同一人，交由横向SRE来判断。_\n    - 是否响应（_参考标准：在群里5分钟内有发言即算响应，多个SRE情况下，只要其中一个响应就算响应，暂无时效要求。）_\n        - [x] 是\n        - [ ] 否\n    - 是否帮助定位（_参考标准：以SRE专家的判断结果为准）_\n        - [x] 是\n        - [ ] 否，备注：__________\n        - [ ] 未参与，备注：__________\n    - 是否操作恢复/提出有效恢复方案（_参考标准：以SRE专家的判断结果为准）_\n        - [x] 是\n        - [ ] 否，备注：__________\n        - [ ] 未参与，备注：__________\n+ **SRE专家是否有效指挥**（_参考标准：在群里有明确指定，谁来负责信息同步、谁来定位、谁来恢复。）_\n        - [x] 是\n        - [ ] 否，备注：__________\n        - [ ] 未参与，备注：__________\n\n\n\n## 五、故障Action\n| **序号** | *******Action** | *******负责人** | *******计划完成时间** | **验收标准** | **验收人** | **是否keyAction** | **是否回血Action** |\n| --- | --- | --- | --- | --- | --- | --- | --- |\n| 1 | 短期：增加tpp核心调用失败率监控报警 | 子集 | 10.10 |  | 子集 | | |\n| 2 | 短期：增加搜索强相关性监控和告警 | 天卿负责监控楚月负责告警配置 | 10.18 |  | | | |\n| 3 | 短期：搜索改造成干净 SDK | 奕博逸万协助处理 | 12.31 |  | | | |\n| 4 | 短期：tpp上代码相关的变更，由热发布改成重启发布。 | 奕博 | 12.31 |  | | | |\n| 5 | 短期：吐槽吧老旧代码隐藏bug，导致无法进行告警计算，进行修复问题并添加监控。 | 京波 | done |  | | | |\n| 6 | 短期：推荐使用干净 SDK ，TPP侧保障基础组件没有冲突 | 鬼彻 | 11.08 |  | | | |\n\n\n## 六、故障总结反思\n**【做得好的】**\n\n最佳实践\n\n**【经验教训】**\n\n举一反三，学习，避免踩坑\n\n## 七、影响产品线&影响面\n- [x] 是否影响可用性：\n\n可用性影响说明：用户搜索用的Query词和实际商品没有相关性。搜索CPC广告未受影响。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/21778/1728546478149-b13c67b7-bdb1-4e84-b5dc-1b7a49860dad.png)![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/21778/1728546623816-4c63db4c-9711-40d6-9189-6ca04cf524f8.png)![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/21778/1728546634401-fb5a4a05-66db-42a1-8ebd-66fb6f3e99fe.png)\n\n\n\n- [x] 业务影响：\n\n**业务影响说明：**由于用户搜索的相关性差，直接影响到搜索域的转化率，最终也会影响到搜索域的GMV；搜索CPC广告未受影响。\n\n10月9日 搜索UCTR 72.97%，环比-2.15pt，搜索CVR 24.45%，环比-0.43pt；GMV预估折损380万。 \n\n\n\n- [x] 是否有客诉：\n\n**客诉影响说明：**\n\n统计周期：10月9日16：00-23:40\n关键词：天猫&搜索\nVOC原声数据：有效客户原声共117",
    "chunk_order_index": 5,
    "full_doc_id": "doc-542f60c16c2b08c54386ab05c5c3efbf"
  },
  "chunk-29cf71e0371ef1ce0fba8710e96fa835": {
    "tokens": 1200,
    "content": "未受影响。\n\n10月9日 搜索UCTR 72.97%，环比-2.15pt，搜索CVR 24.45%，环比-0.43pt；GMV预估折损380万。 \n\n\n\n- [x] 是否有客诉：\n\n**客诉影响说明：**\n\n统计周期：10月9日16：00-23:40\n关键词：天猫&搜索\nVOC原声数据：有效客户原声共117条（其中在线人工75条，热线人工12 条，阿里/热线小蜜30条）\n\n## 八、故障定级&定责&故障分自查\n【故障等级】P4\n\n【故障责任方】无需定责\n\n【故障分】7\n\n### 高可用：\n| **  系统质量（30%）** | | | | | **处置能力（70%）** |\n| :---: | --- | --- | --- | --- | --- |\n| **相关方** | **需求设计** | **代码质量** | **变更质量** | **自定义项** | **发生时间** | **发现时间（30%）** | **恢复时间（40%）** |\n| 手猫 | N | N | N |  | 2024-10-09 19:47 | 2024-10-09 18:30 | 2024-10-09 23:30 |\n\n\n### 资损故障：\n| **  系统质量（60%）** | | | | | **处置能力（40%）** |\n| :---: | --- | --- | --- | --- | --- |\n| **相关方** | **需求设计** | **代码质量** | **变更质量** | **自定义项** | **发生时间** | **是否监控发现20%** | **恢复时间20%** |\n| A团队 |  |  |  |  |  |  |  |\n| B团队 |  |  |  |  |  |  |  |\n| C团队 |  |  |  |  |  |  |  |\n\n\n_/* 填写说明：*/_\n\n> 故障涉及相关方都需填写，相关方包括但不限于触发方、根因方、导致故障影响扩大方、受影响方。\n>\n> 参考安全生产度量规范：[https://aliyuque.antfin.com/trecs/fzg6dy/wf9gze](https://aliyuque.antfin.com/trecs/fzg6dy/wf9gze)\n>\n> **系统质量：**\n>\n> + 需求&设计：是否存在系统架构设计、产品设计缺陷等设计方面问题，填 是或否或不涉及\n> + 代码质量：是否自身或引入第三方组件，存在代码BUG、漏洞等。填 是或否或不涉及\n> + 变更质量 ：配置及运维类变更，是否存在方案设计、灰度执行方面问题；提供的工具不满足红线要求方面问题。填 是或否或不涉及\n> + 自定义项：可不填写，根据复盘时讨论点实际确定\n>\n> **处置能力：**\n>\n> + 发生时间、发现时间、恢复时间需填写各方的时间\n> + 填具体时间或不涉及，若非监控发现，则勾选未发现\n> + 发现或恢复能力如不涉及，需描述具体理由\n> + 发现能力：受影响方缺少有效的系统监控手段，未发现业务异常等问题；变更执行方或触发方，对变更没有进行有效的观测，发现能力不足等问题\n> + 恢复能力：受影响方缺少容灾能力，响应速度慢等问题；处置方预案不足，响应速度慢等问题\n>\n\n\n\n## 九、附录\n### 附1：故障打标规范\n参考：[https://aliyuque.antfin.com/ngoc/cltlwa/gw086g](https://aliyuque.antfin.com/ngoc/cltlwa/gw086g)\n\n#### 时间线打标规范\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/7773/1688969397509-2c9d7ddd-d346-4f1f-a73d-490bfab8acef.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/7773/1688969407141-945368c1-0780-4c63-8821-795ab3b5e1b3.png)\n\n\n\n### 附2：故障机制参考\n#### 故障相关方定义\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/7773/1688969946769-8bd28bca-7352-44d1-8b01-c73db5a2d281.png)\n\n[https://aliyuque.antfin.com/ngoc/fzg6dy/laf0oz](https://aliyuque.antfin.com/ngoc/fzg6dy/laf0oz)\n\n\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/2763/1656924636921-077e71cc-a8d1-40a0-8d7d-dc0e9ead77ba.png)\n\n#### 高可用故障分测算\n**",
    "chunk_order_index": 6,
    "full_doc_id": "doc-542f60c16c2b08c54386ab05c5c3efbf"
  },
  "chunk-273666d47dbfc46a20a21fef29f05297": {
    "tokens": 788,
    "content": ".com/ngoc/fzg6dy/laf0oz](https://aliyuque.antfin.com/ngoc/fzg6dy/laf0oz)\n\n\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/2763/1656924636921-077e71cc-a8d1-40a0-8d7d-dc0e9ead77ba.png)\n\n#### 高可用故障分测算\n**横轴表示故障从发生时间开始-恢复时间的整个时长（分钟）：**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/2763/1656924726389-a00fb430-c3bc-44cf-a2aa-cf94aa97d8d4.png)\n\n备注：实际故障分以系统计算结果为准。\n\n\n\n**高可用故障分计算系数：**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/2763/1656924851376-9d274389-90ce-47e1-a3b7-1ed29818f417.png)\n\n#### 资损故障定级\n参考：[https://aliyuque.antfin.com/ngoc/fzg6dy/hikl2ibbk8934lax](https://aliyuque.antfin.com/ngoc/fzg6dy/hikl2ibbk8934lax)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/7773/1688970048219-78b29218-2ff2-499b-8f9d-70d50392106e.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/7773/1688970064707-8e0efecd-f516-4bd0-83ed-78a49f9d8316.png)\n\n#### 资损故障分测算\n横轴表示实际资损金额（元）：\n\n| **** | **1W** | **5W** | **10W** | **30W** | **50W** | **80W** | **100W** | **150W** | **200W** | **500W** | **1KW/E2** |\n| :---: | :---: | :---: | :---: | :---: | :---: | --- | :---: | :---: | --- | --- | --- |\n| **P1** |  |  |  |  |  | | **233.0** | 243.0 | 253.0 | 313.0 | 826.0 |\n| **P2** |  |  |  |  | **57.5** | 72.5 | 82.5 |  | | | |\n| **P3** |  |  | **22.5** | 32.5 | 42.5 | 57.5 |  |  | | | |\n| **P4** | **10.0** | 12.0 | 14.5 | 24.5 |  | |  |  | | | |\n\n\n备注：实际故障分以系统计算结果为准。\n\n计算逻辑参考：[https://aliyuque.antfin.com/trecs/fzg6dy/wf9gze#VRs0g](https://aliyuque.antfin.com/trecs/fzg6dy/wf9gze#VRs0g)\n\necho '(P+(F-B)*0.5)*E' |bc -l",
    "chunk_order_index": 7,
    "full_doc_id": "doc-542f60c16c2b08c54386ab05c5c3efbf"
  },
  "chunk-24cf8f87b7efd5f1f2b20e44bd9a7aca": {
    "tokens": 1200,
    "content": "## 一、事件简述\n2024年11月1日 12:10 监控预警珠帘玉幕活动权益领取异常，用户参加珠帘玉幕云包场提示活动火爆，事件原因初步确认是代码Bug导致，由于预案有舆情风险，与业务决策采用代码修复的方式解决，13:23通过代码修复完成止血，13:30因客诉量累积触发客诉预警，期间共计产生58例客诉， 理论影响用户9000+，达P5事件等级。\n\n## 二、影响产品线&影响面\n| **Chcek项** | 影响概述 |\n| --- | --- |\n| **业务影响** | 影响珠帘玉幕云包场正常领取。用户侧表现：抢云包场的时候提示“活动太火爆”（该提示属于正常产品口径），但领取页面上显示仍有剩余座位。库存没有扣减，持续增加。持续时间：73分钟（12:10-13:23）监控链接：[https://x.alibaba-inc.com/custom/33/product/preview/spm/5980?crossTenant=true&from=1730433927000&to=1730434827000](https://x.alibaba-inc.com/custom/33/product/preview/spm/5980?crossTenant=true&from=1730433927000&to=1730434827000)![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/31456702/1730713704524-38ef6574-1104-4f65-8905-e769221f2ae2.png)![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/31456702/1730714748407-ffb0cc89-6d11-4d79-9b32-f4c60be6280b.png) |\n| **客诉量** | 58例，详情可参考：[https://abird.alibaba-inc.com/newFeedback#/ticketDetail?id=157561](https://abird.alibaba-inc.com/newFeedback#/ticketDetail?id=157561) |\n| **社会舆情** | 否 |\n| **资损** | 否 |\n| **可用性** | 否 |\n\n\n## 三、事件过程回顾\n| **时间线** | **处理动作** |\n| --- | --- |\n| 2024-09-25 10:21 | 云包场二期服务端代码发布线上**【风险注入】** |\n| 2024-11-01 12:00 | 珠帘玉幕活动上线 |\n| 2024-11-01 12:10 | 服务端通过监控发现领成功率下降，用户表现为珠帘玉幕活动权益领取异常，包场数量停止消耗，并且在增长（有用户进行加座）**【事件发现】** |\n| 2024-11-01 12:10 | 服务端开始排查问题**【业务响应】** |\n| 2024-11-01 12:18 | 服务端发现是代码有bug导致，有相应预案，经业务判断，存在公平公正等舆情问题，暂不执行预案**【初因定位】** |\n| 2024-11-01 12:30 | 业务方咨询活动权益领取异常问题**** |\n| 2024-11-01 13:17 | 服务端紧急修复bug，执行代码线上发布**【恢复执行】** |\n| 2024-11-01 13:23 | 第一批代码发布完毕，包场慢慢可以进行领取**【事件恢复】** |\n| 2024-11-01 13:30 | 优酷消防群通报珠帘玉幕云包场风险事件**【事件发生】** |\n| 2024-11-01 13:30 | 包场库存消耗完毕**** |\n| 2024-11-01 14:11 | 最后一批代码发布完毕**【影响消除】** |\n\n\n## 四、事件原因\n### 4.1【背景说明】\n###### 需求背景：\n用户购买包场（会员vip），通过公域分享以后，其他用户可领取，同时其他用户也可以给当前购买包场的用户进行加座，加座以后增加的权益座位（会员vip）也可以进行正常领取。\n\n##### 业务链路全景介绍：\n![画板](https://intranetproxy.alipay.com/skylark/lark/0/2024/jpeg/31456702/1730866052114-23cb5461-fe1d-4f18-8883-1a511dec3699.jpeg)\n\n有问题的链路：\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/31456702/1730644076282-7a3f0a47-e0c7-429c-99fb-4ba487fe157b.png)\n\n### 4.2【原因分析】\n###### 一句话原因：\n查询可用库存的时候，没有限制库存大于0的状态，并且加了20条的限制，导致加座用户数大于20以后的加座没办法领取。\n\n###### 根因分析：\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/31456702/1730701315870-695a5e45-d246-4280",
    "chunk_order_index": 0,
    "full_doc_id": "doc-3eb35c714523e0e10e812870e6a6c24b"
  },
  "chunk-001b0a0637828b6df51588bb579a9554": {
    "tokens": 1200,
    "content": ")\n\n### 4.2【原因分析】\n###### 一句话原因：\n查询可用库存的时候，没有限制库存大于0的状态，并且加了20条的限制，导致加座用户数大于20以后的加座没办法领取。\n\n###### 根因分析：\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/31456702/1730701315870-695a5e45-d246-4280-a124-dca04006fae8.png)\n\n## 五、事件关注点\n###### 核心关注点1：测试验证的时候为何没有验证到异常场景？\n:::info\n**问题总结：**\n\n1、从需求层面分析，云包场二期需求里没有涉及到该场景的变更，测试用例里没有设计验证此异常场景。\n2、从技术改动层面分析，开发和测试沟通技术方案过程中，没有针对此次变化的点进行讨论，导致此次基于技术优化带来的影响范围评估不全。\n3、从测试保障层面分析，云包场一期线上此场景下无问题，云包场一期上线后同产品、开发评审通过的回归用例里没有此场景。\n\n**改进点：**\n\n1、测试和开发加强项目过程中的沟通，加强对于技术优化改动所带来影响范围的评估。\n2、边界流程异常相关的自动化测试用例可以补充进来；后续流程链路的变化需要标注清楚，以流程图的形式把全链路和测试同步清楚。\n\n:::\n\n###### 核心关注点2: 灰度时是否有观测到异常情况，灰度能发现这个问题吗？\n:::info\n**问题总结：**活动场景比较特殊，暂时没有一个好的解决方案能够做到灰度。\n\n**改进点：**1、与测试共建，维护一个活动自动化模拟及自动化数据校验的自动化测试工具[@小珥](undefined/xiaojie.axj) 11.30\n\n2、后续新功能上线，最好是在一个小型活动上先进行使用，控制好影响范围。制定活动业务             层面的灰度规范 [@么一](undefined/magang.mg) 11.14\n\n:::\n\n###### 核心关注点3: 开发接收到的监控预警是通用接口配置，还是根据每个活动不同监控不同？是否可以根据权益包消耗的速度，比如停滞时间过长进行预警？\n:::info\n**问题总结：**云包场是一个秒杀类活动，消耗速度是断崖式扣减的，没办法通过消耗来直接判断是否有问题。开发是通过多个监控综合判断是否出问题。\n\n**改进点：**暂无\n\n:::\n\n###### 核心关注点4: 事先准备的预案内容是什么，为何会有舆情风险？\n:::info\n**问题总结：**库存置为0 ，所有用户不可领取，但是领取记录没有新用户增加。\n\n**改进点：**完善预案，库存置为0，所有用户不可领取，领取记录页面展示数据努力加载中，不进行数据渲染。然后通过离线的方式给符合条件的点击过领取按钮的用户进行发放权益。后续涉及明星粉丝效应的活动要准备多个预案（尽量无损），并经过产品、业务等相关方的评估。[@么一](undefined/magang.mg) 11.14\n\n:::\n\n###### 核心关注点5: 决策代码修复到第一批代码发布上线用时一小时，整个修复过程是否还可以再加速？\n:::info\n**问题总结：**\n\n1、代码修复之后需要经过预发发布、验证。验证通过，发布到安全生产，再次进行验证才能发布线上\n\n2、当时在决策过程中，还有另外一个方案，需要前后端共同配合修复，由于前端改动评估改动影响比较大，可行性比较低，最终决定采用方案一的方式解决问题。\n\n备注：方案一：服务端修复代码bug，修复线上问题。\n\n   方案二：服务端生成加座签名给到前端，前端在页面上随机选取一个签名请求服务端，也能保证用户正常领取，库存正常消耗\n\n**改进点：**后续尽量使用预案止血，若必须通过代码发布的方式进行，一个小时已经是比较快的时间了。\n\n:::\n\n###### 核心关注点6: 首例客诉反馈是12:28，一个小时后13:30才有客诉预警出来，感觉预警晚了点？\n:::info\n**问题总结：**前两天有过类似的问题，是业务人工配置货品出了问题，当时以为是同样的问题，所以将用户反馈关联到类似“已同步”分类上，12:54客服已将问题反馈给业务进行排查，13:30确定是技术故障后建立了故障分类，才有了客诉预警。\n\n**改进点：**后续活动保障若明确有技术问题的时候，需要评估影响面是否会有客诉风险，上报给如家、宫浩，若判断有故障风险，则同步给竖亥和GOC。这点写进活动重保规范中。\n\n:::\n\n## 六、事件基础信息\n### 6.1【系统质量】\n#### 6",
    "chunk_order_index": 1,
    "full_doc_id": "doc-3eb35c714523e0e10e812870e6a6c24b"
  },
  "chunk-fe1682d10ca16b8c8d5357b7f053c1a5": {
    "tokens": 1085,
    "content": "故障后建立了故障分类，才有了客诉预警。\n\n**改进点：**后续活动保障若明确有技术问题的时候，需要评估影响面是否会有客诉风险，上报给如家、宫浩，若判断有故障风险，则同步给竖亥和GOC。这点写进活动重保规范中。\n\n:::\n\n## 六、事件基础信息\n### 6.1【系统质量】\n#### 6.1.1 代码质量\n| **Chcek项** | **详细内容** |\n| --- | --- |\n| **CR链接** | [https://code.alibaba-inc.com/nintendo-youku/nintendo-youku/codereview/18107869?file=654a9e69bb6f55347dbac34ce9fdbe02c4c1e24c&tab=detail](https://code.alibaba-inc.com/nintendo-youku/nintendo-youku/codereview/18107869?file=654a9e69bb6f55347dbac34ce9fdbe02c4c1e24c&tab=detail) |\n| **是否经过测试** | 是 |\n| **测试环境** | 预发环境；安全生产环境；线上环境。 |\n| **测试提交单/测试用例/测试报告** | [https://rd.abird.alibaba-inc.com/commitTest/server/detail?id=95212](https://rd.abird.alibaba-inc.com/commitTest/server/detail?id=95212) |\n\n\n#### 6.1.2 变更质量\n| **Chcek项** | 详细内容 |\n| --- | --- |\n| **变更类型** | 代码变更 |\n| **CF变更执行单链接** | [_https://cd.aone.alibaba-inc.com/ec/app/195982/deploy/order?id=112230884&envId=3442201_](https://cd.aone.alibaba-inc.com/ec/app/195982/deploy/order?id=112230884&envId=3442201) |\n| **是否灰度** | 是 |\n| **灰度时长** | 安全生产灰度60分钟，线上第一批灰度20分钟 |\n| **发布批次** | 10 个批次 |\n| **灰度观测监控链接&截图** | [https://x.alibaba-inc.com/custom/33/product/preview/cms/1993](https://x.alibaba-inc.com/custom/33/product/preview/cms/1993) 大盘监控[https://x.alibaba-inc.com/custom/33/product/preview/dashboard/36753?activityCode=ACC2023030800364001](https://x.alibaba-inc.com/custom/33/product/preview/dashboard/36753?activityCode=ACC2023030800364001) |\n| **是否违反变更红线 **[**🔗**](https://aliyuque.antfin.com/trecs/fzg6dy/uar1k6) | 否 |\n\n\n### 6.2【处置能力】\n#### 6.2.1 事件发现&响应\n| **Chcek项** | 详细内容 |\n| --- | --- |\n| **是否监控发现** | 否，虽然开发通过监控发现异常并介入处理，但该事件是通过客诉预警上报至GOC |\n| **是否5分钟内响应** | 是 |\n\n\n#### 6.2.2 事件定位&恢复\n| **Chcek项** | 备注 |\n| --- | --- |\n| **主要恢复方式** | 1、有相关预案，和运营沟通以后暂不执行。2、以修复代码bug ，通过发布的方式解决问题。 |\n\n\n## 七、事件Action\n| **序号** | **类别** | *******Action** | *******负责人** | *******计划完成时间** | **验收人** | **是否keyAction** | **是否回血Action** |\n| :---: | :---: | --- | :---: | :---: | :---: | :---: | :---: |\n| 1 | 短期 | 完善云包场预案 | [@么一](undefined/magang.mg) | 11.14 |  | 否 | 否 |\n| 2 | 短期 | 建立活动自动化模拟及自动化数据校验的自动化测试工具 | [@小珥](undefined/xiaojie.axj) | 11.30 |  | 否 | 否 |\n| 3 | 短期 | 制定活动业务层面灰度规范 | [@么一](undefined/magang.mg) | 11.14 |  | 否 | 否 |\n| 4 | 长期 | 优化重点Ip活动保障机制，核心增加4部分内容：预案准备及风险同步；自动化测试能力；活动风险上报；活动影响面如何快速确认 | [@凌仔](undefined/lingzai.ll) | 11.30 | 安晓洁 | 是 | 否 |",
    "chunk_order_index": 2,
    "full_doc_id": "doc-3eb35c714523e0e10e812870e6a6c24b"
  },
  "chunk-be83937ea4d9431c46c27488bfddd60e": {
    "tokens": 1200,
    "content": "## 一、故障简述\n【P4】于15:28开始，淘天_红包签到_首页主接口成功率下跌，成功率最近10分钟最大值小于90%，15:37触达P4故障，确认与数据库升配变更有关，15:45DBA将数据库变更暂停，手工触发内核主备切换后故障恢复。\n\n## 二、故障过程回顾\n| **时间轴** | **事件** |\n| --- | --- |\n| 2024-10-24 15:22 | IRISES_NEW_APP集群计算规格变更开始执行**【故障引入】**![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256311/1730776757140-ecc30710-1c18-429e-b525-c46367427b9d.png) |\n| 2024-10-24 15:27 | 备库升配后自动主备切换，变配任务出现错误日志**【故障发现】【故障响应】** |\n| 2024-10-24 15:33 | 淘天_红包签到_首页主接口预警推送，晗幽接手，风险预警群拉起 |\n| 2024-10-24 15:34 | 联系DBA辰宿 |\n| 2024-10-24 15:37 | 成功率最近10分钟最大值小于90%，触达P4**【故障发生】** |\n| 2024-10-24 15:38 | 钉钉会议拉起 |\n| 2024-10-24 15:39 | 晗幽反馈处理中 |\n| 2024-10-24 15:42 | 清蓝暂停数据库变配未执行任务**【恢复执行】** |\n| 2024-10-24 15:44 | 人工介入kill异常的主库，触发内核主备切换 |\n| 2024-10-24 15:45 | 成功率恢复日常水位**【故障恢复】**![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256311/1730191985278-2736f2da-5e07-4e31-a3a2-6a23ae36e7bc.png) |\n| 2024-10-25 18:06 | 俞月同步：升配后往新启动的节点上切换，一定概率下触发社区8.0版本ACL Cache 的性能缺陷。**【故障定位】** |\n\n\n## 三、📌故障原因\n### 3.1【背景说明】\n**【业务链路】**签到主接口对db进行读写\n\n![画板](https://intranetproxy.alipay.com/skylark/lark/0/2024/jpeg/18214/1730268905191-c103c8e7-d568-42ba-831e-adbcb45ae2a8.jpeg)\n\n**【需求背景】**当前db在峰值期间（每天早上10点、11点）cpu的使用率为80%，需要进行db的规格升级。因此申请了db规格升级的发布单[link](https://dbservice.alibaba-inc.com/database/task_info)。（cpu16 -> 32）任务id：JVIZ19E-48YQLKCA5H306XPU7F2TWGSO\n\n> ![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256311/1730271587500-c098a765-0a9c-46c3-8a54-56fb0b35677f.png)  \n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/18214/1729758889819-38d593d1-9e72-49d5-894c-1caac276df73.png?x-oss-process=image%2Fformat%2Cwebp%2Fresize%2Cw_1500%2Climit_0)\n>\n\n### 3.2【原因分析】\n**1、一句话原因**\n\n升配后往新启动的节点上切换，一定概率下触发社区8.0版本ACL Cache 的性能缺陷。\n\n**2、根因分析**\n\n![画板](https://intranetproxy.alipay.com/skylark/lark/0/2024/jpeg/80256311/1730949338282-fee53fc5-efcd-4c54-b27d-681f906c8c22.jpeg)\n\n备库升配完成，主库切换至备库后，新的主库（升配的备库）因ACL cache性能缺陷建立连接效率不够，导致数据库连接打满。\n\n## 四、故障关注点\n### 用户互动侧\n1. 10分钟成功率<90%触达故障，预警规则当前配置是否需要调整？\n\n:::tips\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256311/1730192583885-e602d8fd-42f0-4b46-af1f-944407d357fd.png)\n\naction：红包签到_首页主接口成功率建设分钟级监控  @玄冰 已完成 \n\n:::\n\n2. 变配任务开始执行后，是否有观测",
    "chunk_order_index": 0,
    "full_doc_id": "doc-da16c95b80f03bd382652f2a5d740c3b"
  },
  "chunk-4a6d3504087578f5eea16ebc2e9b0dd4": {
    "tokens": 1200,
    "content": "是否需要调整？\n\n:::tips\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256311/1730192583885-e602d8fd-42f0-4b46-af1f-944407d357fd.png)\n\naction：红包签到_首页主接口成功率建设分钟级监控  @玄冰 已完成 \n\n:::\n\n2. 变配任务开始执行后，是否有观测，观测是否有发现异常？\n\n:::tips\n任务显示运行中（看不到实际运行状况），观察日志没有异常。——执行5分钟后出现错误日志\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/18214/1729757256614-ef763893-8236-4c05-b618-d5b7787fc70c.png?x-oss-process=image%2Fformat%2Cwebp%2Fresize%2Cw_1500%2Climit_0)\n\n:::\n\n错误日志### Error querying database.  Cause: ERR-CODE: [TDDL-4200][ERR_GROUP_NOT_AVALILABLE] The TDDL Group IRISES_NEW_0000_GROUP is running in fail-fast status, caused by this SQL:[24-10-24 下午3:31][/* 213e378717297550896483770ea912/0.1.3//1c6cd286/// */select `custom_task`.`id`,`custom_task`.`gmt_create`,`custom_task`.`gmt_modified`,`custom_task`.`user_id`,`custom_task`.`biz_type`,`custom_task`.`sub_biz_type`,`custom_task`.`unique_id`,`custom_task`.`progress`,`custom_task`.`target_progress`,`custom_task`.`start_time`,`custom_task`.`end_time`,`custom_task`.`version`,`custom_task`.`status`,`custom_task`.`reward_template`,`custom_task`.`feature`,`custom_task`.`source` from `custom_task_0042` `custom_task` WHERE ((`custom_task`.`sub_biz_type` = ?) AND (`custom_task`.`biz_type` = ?) AND (`custom_task`.`user_id` = ?) AND (`custom_task`.`end_time` > ?) AND (`custom_task`.`start_time` <= ?)) order by `custom_task`.`start_time` desc  limit ?,?] which threw a fatal exception as [ERR-CODE: [TDDL-4102][ERR_ATOM_GET_CONNECTION_FAILED_KNOWN_REASON] Get connection for db 'cn-zhangjiakou_i-8vb2udzj2xmymv1egwxs_irises_new_0000_3009:33.58.28.199:3009' failed because Data source rejected establishment of connection,  message from server: \"Too many connections\". More: [http://middleware.alibaba-inc.com/faq/faqByFaqCode.html?faqCode=TDDL-4102]]. More: [http://middleware.alibaba-inc.com/faq/faqByFaqCode.html?faqCode=TDDL-4200]### The error may exist in class path resource [mappernew/CustomTaskDAO.xml]### The error may involve defaultParameterMap\n3. 数据库连接池使用情况是否有配置监控？\n\n:::tips\n[查看详情](https://dbservice.alibaba-inc.com/performance/appname_detail?appname=IRISES_NEW_APP&granularity=1&region=cn-zhangjiakou&start=2024-10-24%2015:10&end=2024-10-24%2015:50)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256311/1730858029999-3633646e-4554-44be-97fb-aa5db42de761.png)\n\naction:配置连接数大于4.5w预警监控   @玄冰  已完成\n\n:::\n\n4. 后续计划如何操作，是否应选择在业务低峰期执行？\n\n:::tips\n24日选择的是白天的流量低峰期执行，后续保险起见，联系好dba值班，在夜里低峰期执行（凌晨2点）\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256311/1730769689035-8bf0309a-344e-49c5-b99d-d8f08dbb4707.png)\n\n:::\n\n### 云侧\n1. 变配任务暂停后，做了其他什么恢复动作？\n\n:::tips\n暂停未开始执行任务（执行中任务无法暂停），故需黑屏操作，流量切回原主库\n\n:::\n\n2. 常规主备切换为何不触发？\n\n:::tips\n常规的主备切换不会触发该问题，原因是tddl client有连接备库的心跳探活逻辑，帮助把连接认证依赖的元信息加载到ACL Cache（访问控制列表缓存）内，从而避免走到加写锁的路径。\n\n升配：新节点重启之后，ACL Cache数据为空，立刻主备切换命中当前性能缺陷。\n\n:::\n\n3. 社区8.0版本ACL Cache 的性能缺陷是否有复现？后续如何规避？\n\n:::tips\n根因已定位是社区8.0版本ACL Cache 的性能缺陷问题，详细解释如下\n\n1、 结合pstack的的观察，并没有acl ddl去持有acl cache写锁，只有20+个insert_entry_in_db_cache路径下的写锁争抢。\n\n2、在指定user/db 并发",
    "chunk_order_index": 1,
    "full_doc_id": "doc-da16c95b80f03bd382652f2a5d740c3b"
  },
  "chunk-9bd3e86d32cdf04a126f7812d91d50f6": {
    "tokens": 1200,
    "content": "。\n\n:::\n\n3. 社区8.0版本ACL Cache 的性能缺陷是否有复现？后续如何规避？\n\n:::tips\n根因已定位是社区8.0版本ACL Cache 的性能缺陷问题，详细解释如下\n\n1、 结合pstack的的观察，并没有acl ddl去持有acl cache写锁，只有20+个insert_entry_in_db_cache路径下的写锁争抢。\n\n2、在指定user/db 并发登陆， 第一次登陆这个db时，各连接都会从acl cache拿不到数据，进而并发去insert_entry_in_db_cache去争抢写锁。\n\n3、 而由于前面更多并发的请求在持有acl cache的读锁，在读取acl cache， 导致insert_entry_in_db_cache触发的写锁连接都在阻塞着。\n\n4、 而后面再新进来的连接，继续争抢acl cache的读锁去检测权限，但是由于前面已经有insert_entry_in_db_cache触发的写锁在排队了，所以就触发了锁冲突快速检测，检测失败，就会进行死锁检测，然后是慢速检测。\n\n5、 由于此时并发的链接太多，持有读锁的太多，死锁检测就耗时较多，而find_deadlock死锁检测时会持有检测队列的写锁。 又会导致后续其他链接去拿acl cache的读锁或者写锁阻塞，也就是阻塞4步骤的新链接，在登陆环节阻塞。\n\n6、 登陆环节阻塞， 会导致connect timeout， 业务的连接池就会断连接重连。\n\n7、 但是由于很多链接还卡着在等待锁，业务端断链并不能保证整个tcp和连接释放，就会有大量tcp链接就会处于CLOSE_WAIT。 也就和本地netstat 监控的一致\n\n - TCP 连接断开时需要进行四次挥手，TCP 连接的两端都可以发起关闭连接的请求，若对端发起了关闭连接，但本地没有进行后续的关闭连接操作，那么该链接就会处于 CLOSE_WAIT 状态。\n\naction：数据库内核发版修复问题，线上数据库版本升级 [@严华](undefined/jianhua.sjh)[@辰宿](undefined/chenlindun.cld) 11.30\n\n:::\n\n4. 平台侧是否可以对社区8.0版本升配任务做提醒？\n\n:::tips\n平台侧内部对8.0的变配任务通知到林顿，保持关注\n\n:::\n\n5. 升配工单是否有批次要求，切主库是否业务方可以执行？\n\n:::tips\n批次不做要求，业务方自行判断\n\n切主库业务方无法执行\n\n:::\n\n## 五、📌故障基础信息\n### 5.1【系统质量】\n#### 5.1.1 代码质量--不涉及\n#### 5.1.2 变更质量\n| **Chcek项** | 详细内容 |\n| --- | --- |\n| **变更类型** | _计算规格变更_ |\n| **CF变更执行单链接** | _CF执行单：_[_查看详情_](https://aicf.alibaba-inc.com/aicf/change/v2/detail/1320775944?spm=goc-apm.aicf-_changeList.0.0.77ba2388j8UBCr)_dbservice：_[_查看详情_](https://dbservice.alibaba-inc.com/database/task_info)_（_任务id：JVIZ19E-48YQLKCA5H306XPU7F2TWGSO） |\n| **是否灰度** | _是_ |\n| **灰度时长** | _8个实例，间隔10分钟执行一批_ |\n| **发布批次** | _8个实例，分8批执行__第一批执行：运行中__第二批执行：成功__其他批次：尚未执行_ |\n| **灰度观测监控链接&截图** | _日志观测_![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/18214/1729757256614-ef763893-8236-4c05-b618-d5b7787fc70c.png?x-oss-process=image%2Fformat%2Cwebp%2Fresize%2Cw_1500%2Climit_0%2Fresize%2Cw_1500%2Climit_0) |\n| **是否违反变更红线 **[**🔗**](https://aliyuque.antfin.com/trecs/fzg6dy/uar1k6) | _否_ |\n\n\n## 5.2【处置能力】\n#### 5.2.1 故障发现&响应\n| **Chcek项** | 详细内容 |\n| --- | --- |\n| **是否监控发现** | _是，故障受影响方监控发现_ |\n| **是否5分钟内响应** | _是_ |\n\n\n#### 5.2.2 故障定位&恢复\n| **Chcek项** | 备注 |\n| --- | --- |\n| **主要恢复方式** | _数据库变更暂停+主备切换_ |\n\n\n#### 4.2.3 SRE应急参与\n| **角色** | **Chcek项** | **详细内容** |\n| --- | --- | --- |\n| ** SRE****工程师** | **是否",
    "chunk_order_index": 2,
    "full_doc_id": "doc-da16c95b80f03bd382652f2a5d740c3b"
  },
  "chunk-247c4e9fba309a74746beb7ef329f359": {
    "tokens": 346,
    "content": "是_ |\n\n\n#### 5.2.2 故障定位&恢复\n| **Chcek项** | 备注 |\n| --- | --- |\n| **主要恢复方式** | _数据库变更暂停+主备切换_ |\n\n\n#### 4.2.3 SRE应急参与\n| **角色** | **Chcek项** | **详细内容** |\n| --- | --- | --- |\n| ** SRE****工程师** | **是否响应** | _是_ |\n| | **是否帮助定位** | _是_ |\n| | **是否操作恢复/提出有效恢复方案** | _是_ |\n| **SRE****专家** | **SRE专家是否有效指挥** | _是_ |\n\n\n## 五、故障Action\n| 序号 | 类别 | *Action标题 | *负责人 | *计划完成时间 | 验收标准 | 验收人 | 是否keyAction | 是否回血Action |\n| --- | :---: | --- | --- | --- | --- | :---: | --- | --- |\n| 1 | 短期 | 红包签到_首页主接口成功率建设分钟级监控   | 玄冰  | 已完成  |  | | | |\n| 2 | 短期 | 配置连接数大于4.5w预警监控   | 玄冰  | 已完成  |  | | | |\n| 3 | 短期 | 数据库内核发版修复问题，线上数据库版本升级 | 辰宿 严华 | 11.30 |  | | | |",
    "chunk_order_index": 3,
    "full_doc_id": "doc-da16c95b80f03bd382652f2a5d740c3b"
  },
  "chunk-d831499d809cb7316ca145415e3c2f14": {
    "tokens": 1200,
    "content": "![](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/9827/1659103353652-0274c8cd-7318-4cd9-b730-0d66221680b6.png)\n\n_**内容涉及公司B3级别以上机密数据，请注意保密！**_\n\n| **故障链接** | [https://tr.alibaba-inc.com/ormEmergency/workbench/emergency/202410290000000265001](https://tr.alibaba-inc.com/ormEmergency/workbench/emergency/202410290000000265001) |\n| --- | --- |\n| **复盘时间** | 2024-10-30 下午 |\n| **复盘地点** | 滨江园区 |\n| **参与人** | 慕静、沈泽飞(凜一)、风麦、光帅葛锋、良猛 |\n| **主持人** | 良猛 |\n\n\n## 一、故障简述\n故障简述：于10月29日9:08批量商家反馈运营工作台爆品骤降，确认根因为离线链路依赖切换不当导致的优品数据同步异常，于9:34暂停es同步任务故障止血，于15:04手动将全量数据同步完成，故障恢复，期间客诉100+\n\n## 二、故障过程回顾\n### 2.1【故障处理时间线】\n**【故障引入】**2024-10-28 16:02，优品模型进数仓配合DA进行改造，优品离线增量DIFF数据表切换上游依赖后发布。\n\n**【故障发现】【故障响应】**2024-10-29 09:08，批量商家反馈运营工作台爆品数量骤减，同时风麦接手处理。\n\n**【故障发生】**2024-10-29 09:15，客诉量20+，触达P4。\n\n**【舆情布防】**2024-10-29 09:34，业务同步cco和各大区，运营工作台公告发布；\n\n**【恢复执行】【故障止血】**2024-10-29 09:34，暂停es同步任务，增量止血；手动写任务全量同步优爆品数到es上\n\n**【故障定位】**2024-10-29 09:50，定位到优品离线增量DIFF数据表10.27分区增量数据异常，原因是上游依赖和实际代码执行依赖不一致导致优品数据减量同步。\n\n**【影响消除】**2024-10-29 15:04，手动优爆品全量数据同步更新完成，影响消除。\n\n## 三、故障原因\n### 3.1【背景说明】\n【需求背景】icbu核心指标要上象数，且能实验。目前优品模型表：icbutech.dwi_en_great_prod_tag_d由于不符合当前数仓模型规范，需要DA进行改造升级，沉淀到数仓当中，并引入象数核心表。优品模型进数仓配合DA进行改造（方案：[优品模型沉淀](https://aliyuque.antfin.com/yanjianwei.yjw/doh2om/ioweh0y42a36f17h?singleDoc#)），优品离线链路的上下游需要做切换。\n\n【离线链路】新老离线链路改造对比：\n\n![画板](https://intranetproxy.alipay.com/skylark/lark/0/2024/jpeg/325889/1730202688035-cf0684eb-529b-44be-81c1-40409e42b176.jpeg)\n\n**10.28 核心变更点**：\n\n1. 新增中间表dwi_en_great_prod_tag_middle_d（取代原来dwi_en_great_prod_tag_d）用于存储优品标签结果表\n2. 将后续增量标签同步表（每日DIFF表）的上游从dwi_en_great_prod_tag_d切换到dwi_en_great_prod_tag_middle_d。\n\n### 3.2【原因分析】\n**【一句话原因】**\n\n优品数据核心同步任务的上游依赖切换操作不当导致当天产出异常数据，商家优爆品数量减少。\n\n\n\n**【根因分析】**\n\n> 【原标签表】：dwi_en_great_prod_tag_d\n>\n> 【新标签表】：dwi_en_great_prod_tag_middle_d\n>\n> 【增量DIFF表】：dwi_en_great_prod_tag_diff_d\n>\n\n优品增量标签同步表（每日DIFF表）数据异常发生过程：\n\n1. 2024-10-28 16:02，【增量DIFF表】离线任务代码更新、上游依赖更新且发布。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/325889/1730190832739-442ce32e-4353-4fd8-905e-638267fc8b0e.png)\n\n2. 发布后实际1027分区的实例上游依赖未生效（因为实例在代码发布前已经生成），仍然依赖【原标签表】。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/325",
    "chunk_order_index": 0,
    "full_doc_id": "doc-7eef0063d4467a9da3b0271240ad88fe"
  },
  "chunk-c5a33f5af52e5c13ecfbd66e35c03563": {
    "tokens": 1200,
    "content": "0/2024/png/325889/1730190832739-442ce32e-4353-4fd8-905e-638267fc8b0e.png)\n\n2. 发布后实际1027分区的实例上游依赖未生效（因为实例在代码发布前已经生成），仍然依赖【原标签表】。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/325889/1730191230549-8877a866-4a87-4593-92e2-8ec998694f2f.png)\n\n3. 2024-10-29 00:02，【原标签表】数据产出，触发每日【增量DIFF表】实例开始运行，由于最新代码逻辑已经生效，代码执行实际取到【新标签表】数据，但是此时【新标签表】的1027分区仍未产出（3点左右产出）。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/325889/1730193701307-644fb9d2-aff3-4d91-915c-ab1bb94b48cd.png)\n\n4. DIFF任务代码执行时未取到【新标签表】的1027分区数据，代码逻辑判断商品不符合优爆品，导致后续执行优爆品去标操作。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/325889/1730193827703-78f2691b-5ff6-44a5-95ee-89509306ae3b.png)\n\n\n\n根因总结：\n\n+ ODPS 任务上游依赖切换执行流程不规范。\n+ DIFF 离线任务缺少针对品量变化的DQC预警拦截。\n\n## 四、关注点分析\n### 4.1【系统质量】\n#### 4.1.1 需求&设计评估\n**〖关注点1〗****是否涉及产品、技术方案评估？此核心的问题是什么，如何改进？**\n\n- [x] **是，涉及**\n    - [x] 系统架构设计缺陷\n        - [x] 容错性不足 \n        - [x] 缺乏自我保护\n\n**〖问题总结〗方案中缺少对依赖切换的流程细节说明，缺少规范化的依赖切换SOP**\n\n**〖改进点〗**_****_数据侧可以统一沉淀和输出一套上下游依赖切换的规范化SOP\n\n#### 4.1.2 代码质量\n**〖关注点1〗****测试阶段**\n\n+ **测试内容：**离线数据准确性验证\n+ **测试人员：**沈泽飞、严建炜\n+ **是否经过测试验证**\n    - [x] 是，测试方法\n        - [x] 集成测试/链路测试\n+ **测试未发现原因是什么？后续如何改进？**\n    - [x] 其他：__________\n\n#### 4.1.3 变更质量\n+ **是否涉及变更：**\n    - [x] 是\n+ **变更类型：**\n    - [x] 其他变更：_____ODPS任务变更_______\n+ **是否违反变更红线3.1**** **[链接](https://aliyuque.antfin.com/ngoc/fzg6dy/uar1k6)\n    - [x] 否\n\n**〖关注点2〗****上线阶段**\n\n+ **是否在窗口期进行发布变更**\n    - [x] 是\n+ **变更是否影响上下游**\n    - [x] 否\n\n### 4.2【处置能力】\n#### 4.2.1 故障发现&响应\n+ **是否监控发现**\n    - [x] 否，原因为：（监控无效/监控缺失）\n+ **是否5分钟内响应**\n    - [x] 是\n+ **是否存在应急协同问题**\n    - [x] 否\n\n#### 4.2.2 故障定位&恢复\n+ **主要恢复方式：**\n    - [x] 其他：暂停同步任务，手动写任务同步全量优品标签数据\n+ **是否10分钟内恢复**_/* P1P2故障填写*/_\n    - [ ] 是\n    - [x] 否，原因：___全量优爆品同步数量大，ES同步达标需要约5小时_______\n\n## 五、故障Action\n| **序号** | *******Action标题** | *******负责人** | *******计划完成时间** | **Action描述** | **验收标准** | **验收人** | **是否keyAction** | **是否回血Action** |\n| --- | --- | --- | --- | --- | --- | :---: | --- | --- |\n| 1 | 完善DQC预警和异常处理SOP（[链接](https://aliyuque.antfin.com/future/cultivation/etiik8839wiqe9ir?singleDoc#%20《优品运营离线数据问题处理SOP》)） | 沈泽飞、严建炜 | 10.29 | 1. DIFF表上游加入基线管控2. DIFF表数据量过大、数据异常做强规则拦",
    "chunk_order_index": 1,
    "full_doc_id": "doc-7eef0063d4467a9da3b0271240ad88fe"
  },
  "chunk-b2348bdb7858e10ee8124b0ec327dfbe": {
    "tokens": 771,
    "content": "QC预警和异常处理SOP（[链接](https://aliyuque.antfin.com/future/cultivation/etiik8839wiqe9ir?singleDoc#%20《优品运营离线数据问题处理SOP》)） | 沈泽飞、严建炜 | 10.29 | 1. DIFF表上游加入基线管控2. DIFF表数据量过大、数据异常做强规则拦截3. 补充DIFF表数据DQC拦截的预案SOP4. 整体摸排重要场景的DQC监控配置 | DQC监控可触发可拦截 | |  | |\n| 2 | 数据侧提供上下游依赖切换的规范化SOP（[链接](https://aliyuque.antfin.com/yanjianwei.yjw/doh2om/drd3klpd2zhprb1g?singleDoc#)） | | | |  | |  | |\n| 3 | 优品标签数据异常的快恢方案 | 沈泽飞 | 11.15产出方案 | 1. 输出优品数据兼容方案：ES数据异常可切换离线数据做兜底展示。2. 优化ES数据同步效率。 |  | | | |\n| 4 | 尝试与ODPS沟通从平台侧优化依赖切换 | 严建炜 | 11.05 结论 | 结论：目前odps平台侧针对依赖问题也没有对应措施，也是靠人工经验。针对此情况，已经需求给对应odps同学进行功能迭代需求链接如下：   [https://ione.alibaba-inc.com/v2/project/1158491/req#viewIdentifier=d7f112f9d023e2108fa1b0d8&openWorkitemIdentifier=60692969](https://ione.alibaba-inc.com/v2/project/1158491/req#viewIdentifier=d7f112f9d023e2108fa1b0d8&openWorkitemIdentifier=60692969) |  | | | |\n| 5 | 商品域离线和实时数据对账方案 | 彭文清、良猛 | 11.10 给方案 | |  | | | |\n\n\n## 七、影响产品线&影响面\n    - [x] 业务影响：\n        * 商家侧商品运营工作台优品数据展示异常，持续6小时\n    - [x] 是否有客诉量：\n        * 累计客诉100+\n\n## 八、故障定级&定责&故障分自查\n【故障等级】P4\n\n【故障责任方】无需定责\n\n【故障分】_/* 以系统计算结果为准*/_\n\n| **  系统质量（30%）** | | | | | **处置能力（70%）** |\n| :---: | --- | --- | --- | --- | --- |\n| **相关方** | **需求设计** | **代码质量** | **变更质量** | **自定义项** | **发生时间** | **发现时间（30%）** | **恢复时间（40%）** |\n| ICBU技术部-搜推与商家技术部-商品-商品成长 | - | - | - | - | 2024-10-29 09:15 | 2024-10-29 09:08（非监控发现） | 2024-10-29 09:34 |",
    "chunk_order_index": 2,
    "full_doc_id": "doc-7eef0063d4467a9da3b0271240ad88fe"
  },
  "chunk-c442c3d71359148af7aa3d2cb6be53e9": {
    "tokens": 1200,
    "content": "![](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/9827/1659103353652-0274c8cd-7318-4cd9-b730-0d66221680b6.png)\n\n_**内容涉及公司B3级别以上机密数据，请注意保密！**_\n\n| **故障链接** | [https://tr.alibaba-inc.com/ormEmergency/workbench/emergency/202410260000000265001](https://tr.alibaba-inc.com/ormEmergency/workbench/emergency/202410260000000265001) |\n| --- | --- |\n| **复盘时间** | 11月5日 周二 16:00 - 17:00(GMT+8) |\n| **复盘地点** | C1-209 风之谷（北京朝阳科技园C区） |\n| **参与人** | 稳定性负责人：广生SRE：娇娇工程技术-引擎平台-引擎数据工程：亮深、曦诚工程技术-效果引擎-搜索广告引擎：东垣工程技术-效果引擎-创意引擎：春播、皮咔工程技术-应用平台-业务平台：彦谦、北一、许乐工程技术-效果BP-内容场景&客增：杉松广告算法-直播商业化：林霁工程技术-基础平台-质量技术&平台-效果广告：青絮 |\n| **主持人** | 泽萱 |\n\n\n## 一、故障简述\n于2024年10月26日09:46分收到有关无界关键词推广无展现引发的客诉预警单，原因确认为素材链路由于智能创意重置新作，消息量增长较多；而且部分素材关联素材组过多(超过几万条)，消息量扩散较大。两者叠加，导致 blink 进程持续进行 full gc，内存无法释放，整个流程出现反压。新增素材无法进入索引，导致无展现。亮深同学通过执行清理数据重跑，及重新构建全量索引后重启增量回拨昨天素材更新数据，业务于07:09分恢复。期间累积客诉57例。\n\n## 二、故障过程回顾\n### 2.1【时间线概览】\n![画板](https://intranetproxy.alipay.com/skylark/lark/0/2024/jpeg/80256396/1730801590293-022d8df0-08d6-45ce-b621-e0d1716d1f12.jpeg)\n\n### 2.2【故障处理时间线】\n**2024-10-25 00:03**，第一波大促结束，主图变更，直通车智能素材链路消息量大幅上升，GC 频率开始增长。**——【故障引入】**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/102356460/1730118201870-df7aa487-dff6-4fa5-8637-ad99e5c64e3f.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/102356460/1730118228237-4edda296-6273-4d8d-85ee-015cea98e85e.png)\n\n2024-10-25 09:31，直通车智能素材链路完全卡死零消费，GC线程彻底抢占CPU。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/102356460/1730118294816-41a92f6e-8532-47a0-bbf6-f3f190078c58.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/102356460/1730118381435-a804f578-5a0f-4428-b9c3-e6dd12789f4c.png)\n\n2024-10-25 23:00，运营同学拉群反馈有无展现异常case；\n2024-10-26 01:00，阿里妈妈商家大客进一步在应急群反馈无展现的问题；\n\n**2024-10-26 07:07**，亮深排查发现databus_alimm_air_kgb_sn_prod_12470_r_i 索引任务流程卡住的问题；**——【故障发现】【故障响应】【初因定位】**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/102356460/1730120246221-9f02b7f5-a5cf-47c8-84da-47e6b7502a94.png)\n\n**2024-10-26 07:08**，亮深手动启动增量任务；**——【恢复执行】**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/102356460/1730119796465-32a5c935-993c-42ac-bb70-002b8d2d76ff.png)\n\n**2024-10-26 07:09**，发现位点延迟过久，执行清数据重跑；**——【故障恢复】**\n\n![](",
    "chunk_order_index": 0,
    "full_doc_id": "doc-b4bda7c94f51e568af4eb76073acce69"
  },
  "chunk-bb617d153b00398969a4ecd2625ed629": {
    "tokens": 1200,
    "content": "——【恢复执行】**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/102356460/1730119796465-32a5c935-993c-42ac-bb70-002b8d2d76ff.png)\n\n**2024-10-26 07:09**，发现位点延迟过久，执行清数据重跑；**——【故障恢复】**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/102356460/1730119974023-cf65f3b0-6f08-47a9-9f18-e378ef25af07.png)\n\n2024-10-26 07:11，引擎数据工程同学[@亮深](undefined/wf169406)联系搜索广告引擎同学[@东垣](undefined/zhenkui.hzk)反馈素材链路卡住，正在清理数据重跑，待全量索引数据跑完需要重新构建索引；\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/102356460/1730119665865-b33d2287-d426-4dab-b205-672e047bdd66.png)\n\n2024-10-26 09:19，全量数据跑完，开始构建全量索引，并回拨位点，补昨日素材更新数据。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/102356460/1730120074468-14cbd89f-f3b4-44a0-b454-c09baedd1881.png)\n\n**2024-10-26 09:20**，客服团队收到有关无界关键词推广无展现客诉达到10例；**——【故障发生】**\n\n2024-10-26 09:46，收到有关无界关键词推广无展现的客诉预警单；\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256396/1730775817645-1530018b-bbb1-494b-90d0-30c0ec42e452.png)\n\n2024-10-26 10:00，有关无界关键词推广无展现客诉达到40例（去重后）；****\n\n2024-10-26 11:07，全量索引切换完成，索引数据完全恢复；****\n\n2024-10-26 11:30，素材链路开始出现频繁 FO(频繁 GC 导致)；\n\n**2024-10-26 11:59**，春播同学发现素材绑定过多素材组；**——【根因定位】**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/102356460/1730166743610-3b74a654-7971-47c4-abe7-1a7e5032cb3d.png)\n\n2024-10-26 13:14:37，资源扩容，缓解解绑素材带来的负载；\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/102356460/1730169840026-c64e1560-bc38-4d8e-bc28-e93ffe056425.png)\n\n2024-10-26 13:15，解绑第一批素材；\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/102356460/1730166821207-bd3b9fb6-5083-41e9-9e8b-cdc0777b4795.png)\n\n2024-10-26 13:55，解绑第二批素材；\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/102356460/1730166893847-3e1f23b1-49b6-4657-83fc-940e2b95e1cd.png)\n\n2024-10-26 16:40:38，由于频繁的FO，且checkpoint不成功，流程会不停的从11点30分左右追数据，暂时取消ref表和素材组的触发，并过滤type=5的热点数据；\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/102356460/1730170144930-d263af1d-6d87-4bd8-bb5c-edafa2cd1e5b.png)\n\n2024-10-26 16:45，解绑第三批素材；\n2024-10-26 17:39:14，通过解绑素材以及屏蔽测试用户后，频繁 GC 导致的 FO 现象得到缓解；\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/102356460/1730169737020-c8026442-1ac2-4398-beeb-387449c13466.png)\n\n2024-10-26 18:25:38，恢复ref表和素材组的触发和type=5的数据，开始补丢失的消息；\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/102356460/1730170491747-ce55f714-0eca-4c86-bca",
    "chunk_order_index": 1,
    "full_doc_id": "doc-b4bda7c94f51e568af4eb76073acce69"
  },
  "chunk-91945f53ec2ac3a8444e48b71efc282f": {
    "tokens": 1200,
    "content": "8026442-1ac2-4398-beeb-387449c13466.png)\n\n2024-10-26 18:25:38，恢复ref表和素材组的触发和type=5的数据，开始补丢失的消息；\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/102356460/1730170491747-ce55f714-0eca-4c86-bca6-25bfd1553790.png)\n\n**2024-10-26 22:51:44**，对ref表增加分钟级别聚合，同一material_id 一分钟内只能更新一次，后续持续保持观察。**——【影响消除】**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/102356460/1730170561673-780eaf43-e434-4d62-8f6e-f35fab27ee37.png)\n\n## 三、影响产品线&影响面\n    - [x] 是否有客诉量：\n        * 本次引发的无界无展现客诉量共计：57例（去重后）\n\n[10月26日有关无界关键词推广无展现.xlsx](https://yuque.antfin.com/attachments/lark/0/2024/xlsx/147156506/1731031225086-fa4453da-c522-4fc0-85df-070b63f2eb01.xlsx)\n\n    - [ ] 是否产生资损：\n        * 无\n\n链接：[https://aliyuque.antfin.com/qf9pla/dx8mse/zs13byulnad58mg8#BaBo](https://aliyuque.antfin.com/qf9pla/dx8mse/zs13byulnad58mg8#BaBo)\n\n截图：![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256396/1730777470660-efa1de4b-d627-4e12-93d5-fe3df07f81eb.png)\n\n## 四、故障原因\n### 4.1【背景说明】\n【业务链路】\n\n智能素材链路卡死，广告主对素材的操作无法更新到线上召回引擎，所以导致无展现。\n\n如图所示：\n\n![画板](https://intranetproxy.alipay.com/skylark/lark/0/2024/jpeg/102356460/1730356095382-d7e9b123-bf1e-4179-b226-2e8fbb92364b.jpeg)\n\n\n\n### 4.2【原因分析】\n#### 4.2.1 【一句话原因】\n10月25日8点开始，直通车智能素材链路由于消息量增长和扩散量大导致流程卡住零消费，部分素材无展现。\n\n#### 4.2.2 【根因分析】\n【系统链路图】\n\n![画板](https://intranetproxy.alipay.com/skylark/lark/0/2024/jpeg/102356460/1730357132564-0bac9070-e79a-4850-a9a8-623bc8fa3037.jpeg)\n\n1. 报警未及时发现原因：该流程配置业务延迟报警(表示消费上游数据的延迟指标)，该指标从 10 月 25 日 8 点开始由于流程反压无法上报，掩盖了流程问题，同时由于 BP 数据库频繁的主备延迟以及 DRC 频繁断流问题，延迟报警指标被淹没。\n2. 流程卡主原因：素材索引关联素材组数据，监控指标发现有部分素材绑定的素材组超过 1 万条，任何一个素材组的新增会触发素材反查 几万条素材组数据，典型的 N*N 扩散问题。\n\n## 五、关注点分析\n### 5.1【系统质量】\n#### 5.1.1 需求&设计评估\n**〖关注点〗****是否涉及产品、技术方案评估？此核心的问题是什么，如何改进？**\n\n    - [x] **是，涉及**\n        - [ ] 需求评估遗漏\n        - [ ] 产品设计缺陷\n        - [x] 系统架构设计缺陷：\n\n            - [ ] 容错性不足 \n\n    - [ ] 单点，无冗余\n\n    - [ ] 缺乏自我保护\n\n            - [ ] 缓存设计不当\n\n    - [ ] 容量评估不足\n\n    - [ ] 非幂等设计\n\n            - [ ] 强弱依赖不合理\n\n    - [x] 其他：     流程设计时未充分考虑到素材量的增长，以及素材与素材组之间的扩散变化情况     \n\n    - [ ] **否，不涉及**\n\n**〖问题总结〗**\n\n本次智能素材绑定的素材组过多，导致智能素材链路流程卡住，推广无展现。\n\n**〖改进点〗**_****_\n\n1. 智能创意链路中过滤 0 期智能素材（0期指的是商品详情页素材，在非智能创意期间无需使用，可以从物料表中获取相关信息）；——负责人：曦诚，已完成\n2. 通过定时任务进行定期解绑智能创意链路中素材与素材组之间的历史关联关系，针对创意未绑定",
    "chunk_order_index": 2,
    "full_doc_id": "doc-b4bda7c94f51e568af4eb76073acce69"
  },
  "chunk-4508da0062af124a59f380254106c397": {
    "tokens": 1200,
    "content": "展现。\n\n**〖改进点〗**_****_\n\n1. 智能创意链路中过滤 0 期智能素材（0期指的是商品详情页素材，在非智能创意期间无需使用，可以从物料表中获取相关信息）；——负责人：曦诚，已完成\n2. 通过定时任务进行定期解绑智能创意链路中素材与素材组之间的历史关联关系，针对创意未绑定素材组的无效素材组会进行清理；——负责人：彦谦，已完成，验收人：北一\n3. 重构直通车素材链路，对齐展示侧方案，扩散问题会彻底解决。——负责人：曦诚，东垣，预计：11.29，验收人：亮深\n4. muse侧直播素材链路进行优化，素材组清理以及素材组ID的持久化（复用），直播链路无效素材组已清理。——负责人：北一，预计：11.29，验收人：春播\n\n#### 5.1.2 代码质量——运行态故障，不涉及代码发布\n##### **〖关注点1〗****CodeReview阶段——不涉及**\n+ **是否经过CR（****红线点****）**\n\n- [ ] 是   请提供代码提交or合并的Aone链接：                                      \n\n- [ ] 否\n\n- [x] 不涉及\n\n+ **是否设置合理的CR卡点**\n\n- [ ] 是     \n\n- [ ] 否\n\n- [x] 不涉及\n\n注：[CR卡点设置要求](https://ata.alibaba-inc.com/articles/225396?spm=ata.25287382.0.0.5e0c7536X43l05)\n\n+ **CodeReview阶段是否发现问题？**\n\n- [ ] 是\n\n- [ ] 否，未发现原因：\n\n**〖改进点〗**_****_\n\n1、\n\n##### **〖关注点2〗****单测阶段——不涉及**\n+ **在线变更，****是否经过功能单测：（****红线点****）**\n\n        - [ ] 是\n\n- [ ] 否\n\n+ **离线变更，****生成的离线数据是否经过数据校验：**（**红线点**，校验内容：与发布前版本对比，校验数据条数、数据大小、关键字段值域正态分布等是否符合预期）\n\n        - [ ] 是\n\n- [ ] 否\n\n+ **单测阶段是否发现问题？**\n\n- [ ] 是\n\n- [ ] 否，未发现原因：\n\n##### **〖关注点3〗****测试阶段——不涉及**\n+ **测试内容：**涉及的测试提交单、测试用例等\n+ **测试人员：**\n+ **是否经过测试验证：**\n    - [ ] 是\n\n验证环境：\n\n- [ ] 预发环境\n\n- [ ] 日常环境\n\n测试方法：\n\n- [ ] 回归测试\n\n- [ ] 集成测试\n\n- [ ] 链路测试\n\n- [ ] 验收测试\n\n    - [ ] 否\n\n- [ ] 不涉及\n\n+ **是否自动化测试可覆盖：**\n\n    - [ ] 是\n\n- [ ] 否\n\n\n\n+ **测试未发现的原因：**\n    - [ ] 回归遗漏\n\n        - [ ] 手工回归case遗漏\n\n- [ ] 自动化未建设\n\n- [ ] 自动化回归覆盖不足\n\n- [ ] 其它： \n\n    - [ ] 新场景遗漏\n\n        - [ ] 功能测试用例遗漏，包括正常分支和异常分支\n\n- [ ] 容灾兜底测试遗漏\n\n        - [ ] 客户端兼容性测试遗漏\n\n- [ ] 埋点测试遗漏\n\n        - [ ] 性能测试遗漏，影响评估不足\n\n- [ ] 安全测试遗漏\n\n        - [ ] 其他： \n\n****\n\n**〖改进点〗**_****_\n\n1、\n\n#### 5.1.3 变更质量——运行态故障，不涉及变更发布\n+ **是否涉及变更：**\n\n    - [ ] 是\n\n- [x] 否\n\n\n\n+ **变更类型：**\n\n- [ ] 在线生产代码变更\n\n- [ ] 引擎全量索引变更\n\n- [ ] 实时索引更新变更\n\n- [ ] 算法模型变更\n\n- [ ] whaleshark实验参数变更\n\n- [ ] 其他变更： \n\n- [ ] 不涉及\n\n+ **变更平台是否接入ChangeFree：**\n    - [ ] 是，CF变更单链接： \n\n_/*要这样的链接_ [https://aicf.alibaba-inc.com/aicf/change/detail/1725370372](https://aicf.alibaba-inc.com/aicf/change/detail/1725370372) */\n\n    - [ ] 否，外部变更系统： \n+ **是否违反变更红线3.2**** **[**链接**](https://aliyuque.antfin.com/trecs/fzg6dy/uar1k6)\n    - [ ] 是，违反哪条原则：\n    - [ ] 否\n\n##### **〖关注点1〗****灰度阶段**\n变更执行影响面**资损低于20%**或影响**客户数量低于20%**的变更统一称为灰度变更\n\n+ **是否经过灰度：（****红线点****）**\n- [ ] 是，\n    - 是否有效灰度",
    "chunk_order_index": 3,
    "full_doc_id": "doc-b4bda7c94f51e568af4eb76073acce69"
  },
  "chunk-2182e9630b11b2c102ba7049e4b5aa46": {
    "tokens": 1200,
    "content": "/fzg6dy/uar1k6)\n    - [ ] 是，违反哪条原则：\n    - [ ] 否\n\n##### **〖关注点1〗****灰度阶段**\n变更执行影响面**资损低于20%**或影响**客户数量低于20%**的变更统一称为灰度变更\n\n+ **是否经过灰度：（****红线点****）**\n- [ ] 是，\n    - 是否有效灰度（灰度发布时间间隔大于20分钟）：\n\n        - [ ] 是\n\n- [ ] 否\n\n- [ ] 否\n+ **观测了哪些监控**：_附链接_\n    - [ ] 黑屏、白屏\n    - [ ] GOC监控： \n    - [ ] 系统大盘： \n    - [ ] 其他： \n+ **是否灰度期间发现问题？**\n    - [ ] 是\n\n        - [ ] 灰度流量过大，引发故障\n\n- [ ] 灰度发现但未有效或及时修复，导致故障\n\n- [ ] 其它： \n\n    - [ ] 否，未发现原因：\n\n        - [ ] 应用灰：\n\n- [ ] 灰度流量太小\n\n- [ ] 灰度阶段无法监控\n\n- [ ] 灰度批次不合理\n\n- [ ] 超长时间恢复才能发现\n\n        - [ ] 业务灰：策略不合理\n        - [ ] 灰度无法发现\n        - [ ] 其它： \n\n**〖改进点〗**_****_\n\n1、\n\n##### **〖关注点2〗****上线阶段**\n+ **是否在窗口期进行发布变更：**【周一~周五 09：30~20：00（注意避开吃饭时间12:00~13:30）】\n    - [ ] 是\n    - [ ] 否，原因： \n+ **变更是否影响上下游**\n    - [ ] 是，是否有提前知会上下游评估及关注变更\n        - [ ] 有提前知会\n        - [ ] 没有提前知会\n    - [ ] 否\n+ **是否分批分机房或分批发布：（****红线点****）**\n\n    - [ ] 是\n\n\n\n    - 分机房或分批发布第一批发布时间间隔是否大于20分钟：\n\n        - [ ] 是\n\n- [ ] 否\n\n    - [ ] 否\n+ **是否进行黄金眼指标观察：**（涉及引擎相关变更，此点为**红线点**，变更10分钟左右，观察已发布本机房、核心pid、分广告主体类型的黄金眼业务指标）\n    - [ ] 是，观测监控链接： \n    - 是否发现问题\n\n        - [ ] 是\n\n- [ ] 否，原因： \n\n    - [ ] 否\n+ **是否验证变更改动点：**(**红线点**，已变更的功能逻辑&数据已经生效)\n    - [ ] 是 (请提供观测监控链接，或直接/间接生效截图记录)： \n    - 是否发现问题\n\n        - [ ] 是\n\n- [ ] 否，原因： \n\n    - [ ] 否\n+ **是否验证其它核心变点：**(错误日志/功能或接口成功率或失败率/rt、CPU、内存等系统指标等)\n    - [ ] 是 验证点： \n    - 是否发现问题\n\n        - [ ] 是\n\n- [ ] 否，原因： \n\n    - [ ] 否\n\n**〖改进点〗**_****_\n\n1、\n\n### 5.2【处置能力】\n#### 5.2.1 故障发现&响应\n+ **是否监控发现**\n    - [ ] 是，监控报警链接： \n\n        - [ ] 故障触发方\n\n- [ ] 受影响方\n\n    - [x] 否，原因为：\n\n        - [ ] 监控缺失\n\n- [x] 监控无效\n\n- [ ] 无法监控\n\n+ **发现后是否五分钟内响应**\n    - [x] 是\n    - [ ] 否，原因为：\n+ **应急协同组织是否存在问题，如何改进？**\n    - [ ] 是\n        - [ ] 应急流程不明确（无流程或者流程不清晰、应急相关角色&职责不明确，缺失一号位等)\n        - [ ] 应急执行不到位（有流程，但未按流程执行，通告发送不及时，响应不及时等）\n    - [x] 否\n\n**【问题分析】**\n\n该流程配置业务延迟报警(表示消费上游数据的延迟指标)，该指标从 25 日 8 点开始由于流程反压无法上报，掩盖了流程问题，同时由于 BP 数据库频繁的主备延迟以及 DRC 频繁断流问题，延迟报警指标被淹没。\n\n**【改进点】**\n\n1、添加智能创意链路系统延迟报警，针对系统消息来源与输出消息后指标延迟的监控。——负责人：曦诚，已完成，验收人：亮深\n2、BP数据库系统稳定性的提升，针对热点数据进行优化，降低单次操作数据量，单次操作的频率和次数都进行相关限制；——负责人：许乐，预计：12.31，验收",
    "chunk_order_index": 4,
    "full_doc_id": "doc-b4bda7c94f51e568af4eb76073acce69"
  },
  "chunk-3c44c80c4f0aee8b1a65b224593d66e4": {
    "tokens": 1200,
    "content": "【改进点】**\n\n1、添加智能创意链路系统延迟报警，针对系统消息来源与输出消息后指标延迟的监控。——负责人：曦诚，已完成，验收人：亮深\n2、BP数据库系统稳定性的提升，针对热点数据进行优化，降低单次操作数据量，单次操作的频率和次数都进行相关限制；——负责人：许乐，预计：12.31，验收人：亮深\n\n#### 5.2.2 故障定位&恢复\n+ **主要恢复方式：**\n\n    - [ ] 代码发布/回滚\n\n- [ ] 配置发布/回滚\n\n- [ ] 数据订正\n\n- [ ] 机器隔离/重启/扩容\n\n    - [ ] 配置限流\n\n- [ ] 预案降级\n\n- [ ] 自动恢复\n\n- [x] 其它：         清理数据重跑，及重新构建全量索引后重启增量回拨昨天素材更新数据          \n\n+ **是否10分钟内恢复**__\n    - [ ] 是\n    - [x] 否，原因：     涉及数据问题的恢复，全量索引构建时间本身就需要较长的时间     \n\n**〖关注点1〗定位&恢复阶段存在什么问题？是否可以增加预案，****有更快的恢复方式？****相关的优化改进？**\n\n后续考虑先进行更新链路中素材相关的实时消息更新，确保问题快速恢复，后续再进行全量索引数据的构建。\n\n## 六、故障总结反思\n+ **此次故障是否触发广告技术部安全生产中的红线点？**\n\n- [ ] 是，团队： \n\n- [x] 否\n\n## 七、故障Action\n| **序号** | *******Action标题** | *******负责人** | *******计划完成时间** | **Action描述** | **验收标准** | **验收人** | **是否keyAction** | **是否回血Action** |\n| :---: | --- | :---: | :---: | --- | --- | :---: | :---: | :---: |\n| 1 | 短期：过滤 0 期智能素材 | 曦诚 | 已完成 | 智能创意链路中过滤 0 期智能素材（0期指的是商品详情页素材，在非智能创意期间无需使用，可以从物料表中获取相关信息） | 确保智能创意链路中0期智能素材被过滤。 | - | 否 | 否 |\n| 2 | 短期：定时清理无效素材组 | 彦谦 | 已完成 | 通过定时任务进行定期解绑智能创意链路中素材与素材组之间的历史关联关系，针对创意未绑定素材组的无效素材组会进行清理。 | 确保新增有关无效素材组定时清理任务。 | 北一 | 否 | 否 |\n| 3 | 长期：重构直通车素材链路 | 曦诚东垣 | 11.29 | 重构直通车素材链路，对齐展示侧方案，扩散问题会彻底解决。 | 确保直通车素材链路重构完毕，解决扩散问题。 | 亮深 | 是 | 否 |\n| 4 | 长期：直播素材链路优化 | 北一 | 11.29 | muse侧直播素材链路进行优化，素材组清理以及素材组ID的持久化（复用），直播链路无效素材组已清理。 | 确保直播素材链路素材组相关内容得到优化。 | 春播 | 否 | 否 |\n| 5 | 短期：添加智能创意链路系统延迟报警 | 曦诚 | 已完成 | 添加智能创意链路系统延迟报警，针对系统消息来源与输出消息后指标延迟的监控。 | 确保智能创意链路现新增系统监控报警。 | 亮深 | 是 | 否 |\n| 6 | 长期：BP数据库系统稳定性的提升 | 许乐 | 12.31 | BP数据库系统稳定性的提升，针对热点数据进行优化，降低单次操作数据量，单次操作的频率和次数都进行相关限制。 | 确保BP数据库系统稳定性得到提升。 | 亮深 | 否 | 否 |\n\n\n## 八、故障定级&定责&故障分自查\n【故障等级】P5\n\n| **  系统质量（30%）** | | | | | **处置能力（70%）** |\n| :---: | --- | --- | --- | --- | :---: |\n| **相关方** | **需求&设计** | **代码质量** | **变更质量** | **自定义项** | **发生时间** | **发现时间（30%）** | **恢复时间（40%）** |\n| 淘天集团-用户平台&阿里妈妈事业部-阿里妈妈-广告技术部-工程技术-引擎平台-引擎数据工程 | 是 | 不涉及 | 不涉及 | - | 10-26 09:20 | 10-26 07:07 | 10-26 07:09 |\n\n\n## 九、附录\n### 附1：故",
    "chunk_order_index": 5,
    "full_doc_id": "doc-b4bda7c94f51e568af4eb76073acce69"
  },
  "chunk-92a12a3e7eeee501b5ba41d50a7495dc": {
    "tokens": 757,
    "content": "30%）** | **恢复时间（40%）** |\n| 淘天集团-用户平台&阿里妈妈事业部-阿里妈妈-广告技术部-工程技术-引擎平台-引擎数据工程 | 是 | 不涉及 | 不涉及 | - | 10-26 09:20 | 10-26 07:07 | 10-26 07:09 |\n\n\n## 九、附录\n### 附1：故障打标规范\n参考：[https://aliyuque.antfin.com/ngoc/cltlwa/gw086g](https://aliyuque.antfin.com/ngoc/cltlwa/gw086g)\n\n#### 时间线打标规范\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/7773/1688969397509-2c9d7ddd-d346-4f1f-a73d-490bfab8acef.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/7773/1688969407141-945368c1-0780-4c63-8821-795ab3b5e1b3.png)\n\n\n\n### 附2：故障机制参考\n#### 故障相关方定义\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/7773/1688969946769-8bd28bca-7352-44d1-8b01-c73db5a2d281.png)\n\n[https://aliyuque.antfin.com/ngoc/fzg6dy/laf0oz](https://aliyuque.antfin.com/ngoc/fzg6dy/laf0oz)\n\n\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/2763/1656924636921-077e71cc-a8d1-40a0-8d7d-dc0e9ead77ba.png)\n\n#### 高可用故障分\n**横轴表示故障从发生时间开始-恢复时间的整个时长（分钟）：**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/2763/1656924726389-a00fb430-c3bc-44cf-a2aa-cf94aa97d8d4.png)\n\n\n\n**高可用故障分计算系数：**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/2763/1656924851376-9d274389-90ce-47e1-a3b7-1ed29818f417.png)\n\n#### 资损故障定级标准\n参考：[https://aliyuque.antfin.com/ngoc/fzg6dy/hikl2ibbk8934lax](https://aliyuque.antfin.com/ngoc/fzg6dy/hikl2ibbk8934lax)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/7773/1688970048219-78b29218-2ff2-499b-8f9d-70d50392106e.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/7773/1688970064707-8e0efecd-f516-4bd0-83ed-78a49f9d8316.png)",
    "chunk_order_index": 6,
    "full_doc_id": "doc-b4bda7c94f51e568af4eb76073acce69"
  },
  "chunk-0d2fa000ad1cff750e2ad4ab0c239399": {
    "tokens": 1200,
    "content": "_**会议开始，宣导复盘文化**_\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/9827/1659103353652-0274c8cd-7318-4cd9-b730-0d66221680b6.png)\n\n_**内容涉及公司B3级别以上机密数据，请注意保密！**_\n\n| **故障链接** | [https://tr.alibaba-inc.com/ormEmergency/workbench/emergency/202410230000001170001?__tenant__=alibabaGroup&activeTabKey=summaryDetail](https://tr.alibaba-inc.com/ormEmergency/workbench/emergency/202410230000001170001?__tenant__=alibabaGroup&activeTabKey=summaryDetail) |\n| --- | --- |\n| **复盘时间** | 10月23日 周三 15:00 - 16:00(GMT+8) |\n| **复盘地点** | A1-6-11-N 斩龙岛 |\n| **参与人** | **稳定性负责人：**问衿、一男**相关的开发、测试：**元超、元茂、朱华、浪凡、杨晨、剑辛、光余、玉凇、寻弈、裕德、希桥、谷乐、泓文**GOC：**木棉 |\n| **主持人** | 木棉 |\n\n\n## 一、故障简述\n2024-09-18 16:40开始， idle-scene 应用，所有HSF服务、Mtop接口成功率下跌至10% (16:30开始错误率逐渐增长)，引发闲鱼币等相关客诉，初步定位到是idle-scene Metaspace空间不足频繁GC造成，于17:30通过重启后恢复。故障期间，客诉30+，到达P4。\n\n## 二、故障过程回顾\n### 【故障处理时间线】\n2024年09月18 16:40  idle-scene应用所有接口成功率大幅度下跌\n\n2024年09月18 16:52  回收商下单V1接口告警，通知到百夜（服务组告警值班需要调整）；【闲鱼H5页面】- 紧急-页面白屏告警，通知到丹侠\n\n2024年09月18 16:54  百夜通知到朱华，并开始接手排查（陆续参与人员： 寻弈、裕德、希桥、元茂、剑辛、华采、问衿、杨晨、浪凡）\n\n2024年09月18 17:10   发现在16:33，idle-scene出现VPA CPU资源弹性伸缩，并出现大量的诺亚限流\n\n    - ![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/15432/1728564095161-f23b5468-c4cd-446f-9cac-d70c795d6b9f.png)\n    - ![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/15432/1728564138203-7ee29316-81b0-40fb-9e95-1804151dcc84.png)\n\n2024年09月18 17:11   16:33有VPA弹性降配(na610 3core -> 2core), 寻弈开始执行VPA弹性伸缩回滚\n\n2024年09月18 17:13   元茂开始执行诺亚限流调整为观察者模式\n\n2024年09月18 17:30  VPA弹性伸缩，分10批回滚完成，HSF服务恢复正常，MTOP接口出现零星失败！【截止此时，业务恢复】\n\n+ 恢复的原因:\n    - 回滚弹性伸缩变更(2core -> 3core),  升配会出现机器置换和部署; 间接重启了应用na610部分机器\n    - 大批量日志堆积的日志打印事件, 被逐渐消费掉, Metaspace空间溢出问题缓解\n\n2024年09月18 17:40  发现MTOP接口的零星错误，是由于Vipserver上部分机器健康检查异常，流量仍然打到了有问题的机器（系统水位不稳定）\n\n2024年09月18 18:50  完成idle-scene机器重启，Vipserver健康度检查基本恢复正常\n\n## 三、故障原因\n#### 3.1 一句话原因：\nidle-scene Metaspace空间不足, 频繁GC, 绝大部分机器服务性能变差(小部分机器JVM宕机); 16:30左右有两个大批量日志打印堆积, 问题加剧、扩大!\n\n#### 3.2 根因分析：\n##### 3.2.1 idle-scene 水位\n+ 故障期间磁盘使用率、CPU使用率非常高, 部分机器GC变高;\n    -   ![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/15432/1729003126197-2eafcca4-4502-45a9-9431-844f64a260c8.png)![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png",
    "chunk_order_index": 0,
    "full_doc_id": "doc-62397f0cd5bc8d40fe285be441b9e060"
  },
  "chunk-a9100d1f66924f8dc4dc2f939b83418c": {
    "tokens": 1200,
    "content": "�障期间磁盘使用率、CPU使用率非常高, 部分机器GC变高;\n    -   ![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/15432/1729003126197-2eafcca4-4502-45a9-9431-844f64a260c8.png)![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/15432/1729003163771-936ed47b-20f1-417e-a112-3f4cdbcc0c96.png)\n    - ![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/15432/1729349690069-9c4a2db2-9814-4f27-b77a-641ec0c6923c.png)![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/15432/1729002952052-d9851f85-2652-44f8-a233-0a4f74d9ac8d.png)\n    - ![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/15432/1729349450076-d950eff1-ac08-433f-b9c4-2682f5c3258e.png)\n\n##### 3.2.2 Metaspace OOM分析\n1、在日志排查中, 发现故障发生期间有比较多的OutofMemoryError, 全部是Metaspace OOM; 在故障发生前也有, 只是比较少; 在28号下午出现集中爆发的情况;\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/15432/1729607813680-7b8001c7-b552-43e2-ace7-0e51e9b7b24c.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/15432/1729608140494-5d3938eb-607c-4341-84fc-b029ae9f7aea.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/15432/1729349236307-59f811da-8fb4-4d14-9e14-ae8ba26d249c.png)\n\n\n\n2、idle-scene Metaspace设置较小(512M, 其他应用768M), 日常水位比较高(大部分机器都在90%+), 很容易触发OOM\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/15432/1729004516067-6278a530-2dc1-422b-a846-302b0c38718b.png) \n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/15432/1729606288166-15fff07f-1e88-4b7c-b7e3-d101de3b1899.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/15432/1729608292894-5b4ec9ff-9e0e-4401-9434-3e4633ed2a1e.png)\n\n##### 3.2.3 DUMP分析\n| **机器** | **宕机时间** |\n| --- | --- |\n| 33.50.235.25 | 09.18 16:41 |\n\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/15432/1729347730469-d65d32e0-d74b-4dc0-95a7-5112ec56b52d.png)\n\nLog4j的RingBufferLogEvent内存占用比较高,  RingBufferLogEvent用于在日志事件等待被消费之前**保持日志事件的缓存**。RingBufferLogEvent内存占用问题，通常是因为日志生成速度过快，而日志写入速度跟不上，导致日志写入事件堆积，导致堆内存占用变高的同时, Metaspace 内存中加载的bean实例数也会变高!\n\n\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/67556656/1727273794684-65f0debe-bf20-436c-8849-ecb571ec74cd.png?x-oss-process=image%2Fformat%2Cwebp%2Fresize%2Cw_998%2Climit_0)\n\n结合我们自己排查 & JVM同学给的结论, 有一个明确的问题点: **日志写入量大, 出现写入堆积的情况! **堆内存中RingBufferLogEvent内存占用比较高, 但是并没有导致堆内存GC; \n\n核心问题还是Metaspace OOM导致, 但具体是哪一行代码引入的问题, 我们分析后没有结论!\n\n\n\n堆+Metaspace DUMP的文件, 找 萤音 也帮忙做了排查, 分析结论: 核心还是因为Metqspace 元数据空间溢出导致, 与具体的代码行没有关系!",
    "chunk_order_index": 1,
    "full_doc_id": "doc-62397f0cd5bc8d40fe285be441b9e060"
  },
  "chunk-e63bd49c7f6964ffa448b1dafe0cc646": {
    "tokens": 1200,
    "content": "存占用比较高, 但是并没有导致堆内存GC; \n\n核心问题还是Metaspace OOM导致, 但具体是哪一行代码引入的问题, 我们分析后没有结论!\n\n\n\n堆+Metaspace DUMP的文件, 找 萤音 也帮忙做了排查, 分析结论: 核心还是因为Metqspace 元数据空间溢出导致, 与具体的代码行没有关系! \n\n\n\n**最终结论**\n\n+ **Metaspace区域被打满, 大批量日志打印事件堆积, ****大量的类无法被回收, **** 频繁GC; 导致机器服务性能变差(影响健康度检查), 部分机器宕机;**\n+ **VPA容器弹性伸缩(与问题时间线刚好重合)、诺亚限流(保护了部分机器不挂), 不是导致本次问题的根因, 这个表象对最初快恢 和 问题排查有一些干扰;**\n\n\n\n##### 3.2.3 问题日志分析\n33.61.229.54 这台机器为例, 主日志中, 大日志统计出现比较频繁有两个: IdleItemDetailListener、CroViolationReadServiceImpl\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/15432/1729331197845-153f8da4-e215-472d-8321-2db5f92ed552.png)\n\nCroViolationReadServiceImpl 是因为接口调用超时打印的堆栈, 日志内容比较大, 但是数量较少\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/15432/1729337256384-47a5c958-606c-4f87-bb99-903f26155b38.png)\n\nIdleItemDetailListener 日志打印非常多, 而且日志内容整体偏大\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/15432/1729332087381-5e756351-bfaa-45ac-a8c8-cf3be25d703d.png)\n\n打印日志代码\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/15432/1729399321596-d806ae24-1423-4666-915e-5d7008a39225.png)\n\n在16:29有比较高的峰值(3200+QPS)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/15432/1729333470845-e633794e-5e11-40b1-9bbf-9469c16cac11.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/15432/1729333530036-8984591d-fee1-4e91-b5a1-57e0bdb0fde3.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/15432/1729333678302-1803e218-a070-4dc0-8bd0-3ec8118ffe8c.png)\n\n在16:49有的峰值: 6700+QPS\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/15432/1729331482154-7e9d8c80-3af7-403a-8512-0d243bdee919.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/15432/1729331859584-9d50f400-7854-4811-b20e-db61818787e2.png)\n\n且这个日志日常一直在打印, 日志量比较大(需要治理)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/15432/1729351540980-41a5319a-1c0d-4c51-ac19-e699feacba16.png)\n\n同时, 在16:29 严选验货报告-质检模版数据同步, 产生了6.6W条日志, 峰值qps 4000+ (主日志日常2000左右)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/15432/1729005457647-af33db39-5b96-428e-beb7-742a1626d3bd.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/15432/1729044810321-6f0d4837-cc5e-4f65-8045-42951a276a3f.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/15432/1729044989946-216339ca-f819-4556-be41-c9d1df951ea0.png)\n\n此日志出现峰值的原因: 服务商调用 质检模版绑定 TOPAPI接口时 出现较高峰值, 一次接口调用 会打印多条日志;\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png",
    "chunk_order_index": 2,
    "full_doc_id": "doc-62397f0cd5bc8d40fe285be441b9e060"
  },
  "chunk-53fcfdbbbdb9349a779729af55e188c0": {
    "tokens": 1200,
    "content": "/skylark/lark/0/2024/png/15432/1729044989946-216339ca-f819-4556-be41-c9d1df951ea0.png)\n\n此日志出现峰值的原因: 服务商调用 质检模版绑定 TOPAPI接口时 出现较高峰值, 一次接口调用 会打印多条日志;\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/15432/1729610892727-166df361-8174-45a3-8f4a-347deccd93ef.png)\n\n##### 3.2.4 其他大日志分析\n+ idle-scene还存在一些大日志打印,  还未统计全, 下面是一些示例\n    - 下面这个日志, 包含当个二次元卖家所有的订单信息打印, 比较大(发现过一条6.9M的), 但是打印量不多, 目前 [线上已去掉]\n    - ![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/15432/1729003248539-95fa0b40-b803-4beb-9f05-cfae74751ca7.png)\n    - 下面这个日志, 内容大概在2K+左右,  [ 待评估是否能去除 ]\n    - ![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/15432/1729003285097-5b050a75-550b-42bd-8e75-4561fc7d271a.png)\n    - 下面这个日志, 内容大概在2K+左右,  [ 待评估是否能去除 ]\n    - ![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/15432/1729003322056-5984bcfe-e693-4b2b-b1e1-097666225e55.png)\n    - 下面这个日志, 内容大概在2K+左右,  [ 待评估是否能去除 ]\n    - ![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/15432/1729003359862-e8cca8fa-38fc-4bb8-81a2-e0d33202c104.png)\n\n## 四、关注点分析\n**【关注点1】故障原因是****metaspace OOM过于频繁，触发FGC，宕机。****线上为啥在打印INFO日志？**\n\n:::info\n问题总结：打印INFO日志确实需要治理\n\n优化action：线上日志打印级别调整, INFO不打印\n\n:::\n\n****\n\n**【关注点2】三点多有机器挂掉，为啥没有提前告警出来？**\n\n:::info\n问题总结：当时确实存在监控项缺失，需要增加核心监控项。\n\n优化action：idle-scene应用监控告警完善（FullGC、YoungGC次数、Metaspace 使用率等）\n\n:::\n\n### 4.1【系统质量】\n#### 4.1.1 需求&设计评估 不涉及\n**〖关注点1〗****是否涉及产品、技术方案评估？此核心的问题是什么，如何改进？**\n\n- [ ] **是，涉及**\n    - [ ] 需求评估遗漏\n    - [ ] 产品设计缺陷\n    - [ ] 系统架构设计缺陷\n        - [ ] 容错性不足 \n        - [ ] 单点，无冗余\n        - [ ] 缺乏自我保护\n        - [ ] 缓存设计不当\n        - [ ] 容量评估不足\n        - [ ] 非幂等设计\n        - [ ] 强弱依赖不合理\n        - [ ] 其他：__________\n- [ ] 否，不涉及\n\n**〖问题总结〗**\n\n**〖改进点〗**_**需明确写明不同故障相关方的改进项（若有的话），下同。**_\n\n1、\n\n#### 4.1.2 代码质量 不涉及\n**〖关注点1〗是否代码自身存在漏洞或BUG、代码健壮性是否存在问题等?**\n\n**〖问题分析〗**\n\n**〖改进点〗**_**需明确写明不同故障相关方的改进项（若有的话），下同。**_\n\n1、\n\n\n\n**〖关注点2〗****是否经过CodeReview？CodeReview阶段是否发现问题？为何没发现？**\n\n+ **是否经过CR**\n    - [ ] 是\n    - [ ] 否\n    - [ ] 不涉及\n+ **是否设置合理的CR卡点**\n    - [ ] 是\n    - [ ] 否\n    - [ ] 不涉及\n+ **CodeReview阶段是否发现问题？为何没发现？后续如何发现？**\n    - [ ] 是\n    - [ ] 否\n    - [ ] 不涉及\n\n**〖问题分析〗******\n\n**〖改进点〗**_**需明确写明不同故障相关方的改进项（若有的话），下同。**_\n\n1、\n\n\n\n**〖关注点3〗****测试阶段**\n\n+ **测试内容：**涉及的测试提交单、测试用例等\n+ **测试人员：**\n+ **是否经过测试验证**\n    - [ ] 是，",
    "chunk_order_index": 3,
    "full_doc_id": "doc-62397f0cd5bc8d40fe285be441b9e060"
  },
  "chunk-84fd158b6904b22578049db406490158": {
    "tokens": 1200,
    "content": "�\n    - [ ] 不涉及\n\n**〖问题分析〗******\n\n**〖改进点〗**_**需明确写明不同故障相关方的改进项（若有的话），下同。**_\n\n1、\n\n\n\n**〖关注点3〗****测试阶段**\n\n+ **测试内容：**涉及的测试提交单、测试用例等\n+ **测试人员：**\n+ **是否经过测试验证**\n    - [ ] 是，验证环境\n        - [ ] 预发环境\n        - [ ] 日常环境\n    - [ ] 是，测试方法\n        - [ ] 单元测试\n        - [ ] 功能回归测试\n        - [ ] 集成测试/链路测试\n        - [ ] 验收测试\n    - [ ] 否\n    - [ ] 不涉及\n+ **测试未发现原因是什么？后续如何改进？**\n    - [ ] 回归测试遗漏\n        - [ ] 手工回归测试用例遗漏\n        - [ ] 自动化未建设\n        - [ ] 自动化回归覆盖不足\n        - [ ] 其他：__________\n    - [ ] 新场景测试遗漏\n        - [ ] 功能测试用例遗漏，包括正常分支和异常分支\n        - [ ] 容灾兜底测试遗漏\n        - [ ] 客户端兼容性测试遗漏\n        - [ ] 埋点测试遗漏\n        - [ ] 性能测试遗漏，影响评估不足\n        - [ ] 安全测试遗漏\n    - [ ] 其他：__________\n\n**〖问题总结〗**\n\n**〖改进点〗**_**需明确写明不同故障相关方的改进项（若有的话），下同。**_\n\n1、\n\n#### 4.1.3 变更质量 不涉及\n+ **是否涉及变更：**\n    - [ ] 是\n    - [ ] 否\n+ **变更类型：**\n    - [ ] 代码发布\n    - [ ] 配置变更\n    - [ ] 其他变更：____________\n    - [ ] 不涉及\n+ **变更平台是否接入ChangeFree：**\n    - [ ] 是，CF变更单链接：________\n\n_/*要这样的链接_ [https://aicf.alibaba-inc.com/aicf/change/detail/1725370372](https://aicf.alibaba-inc.com/aicf/change/detail/1725370372) */\n\n    - [ ] 否\n+ **是否违反变更红线3.1**** **[链接](https://aliyuque.antfin.com/ngoc/fzg6dy/uar1k6)\n    - [ ] 是，违反哪条原则：\n    - [ ] 否\n\n\n\n**〖关注点1〗****灰度阶段**\n\n+ **是否经过灰度：**\n    - [ ] 是\n    - [ ] 否\n+ **观测了哪些监控**：_可以附链接_\n    - [ ] 黑屏、白屏\n    - [ ] GOC监控：\n    - [ ] 系统大盘：\n    - [ ] 其他：___________\n+ **是否灰度期间发现问题？**\n    - [ ] 是\n        - [ ] 是否灰度流量过大，导致故障\n        - [ ] 灰度发现但未有效或及时修复，导致故障\n        - [ ] 其他：___________\n    - [ ] 否，后续如何灰度发现？_____________\n+ **未灰度发现原因**\n    - [ ] 应用灰\n        - [ ] 灰度流量太小\n        - [ ] 灰度阶段无监控\n        - [ ] 灰度批次不合理\n        - [ ] 超长时间灰度才能发现\n    - [ ] 业务灰：策略不合理\n    - [ ] 灰度无法发现\n    - [ ] 其他：_____________\n\n**〖问题总结〗**\n\n**〖改进点〗**_**需明确写明不同故障相关方的改进项（若有的话），下同。**_\n\n1、\n\n\n\n**〖关注点2〗****上线阶段**\n\n+ **是否有确定的监控观测指标**\n    - [ ] 是，监控指标及监控链接：\n    - [ ] 否\n+ **是否在窗口期进行发布变更**\n    - [ ] 是\n    - [ ] 否，原因：\n+ **变更是否影响上下游**\n    - [ ] 是，是否有提前知会上下游评估及关注变更\n        - [ ] 有提前知会\n        - [ ] 没有提前知会\n    - [ ] 否\n\n**〖问题总结〗**\n\n**〖改进点〗**_**需明确写明不同故障相关方的改进项（若有的话），下同。**_\n\n1、\n\n### 4.2【处置能力】\n#### 4.2.1 故障发现&响应\n+ **是否监控发现**\n    - [ ] 故障触发方 监控发现\n    - [x] 故障受影响方 监控发现\n    - [ ] 否，原因为：（监控无效/监控缺失）\n+ **是否5分钟内响应**\n    - [x] 是\n    - [ ] 否，原因为：\n+ **是否存在应急协同问题**\n    - [ ] 是\n        - [ ] 应急流程不明确（",
    "chunk_order_index": 4,
    "full_doc_id": "doc-62397f0cd5bc8d40fe285be441b9e060"
  },
  "chunk-d56246bf78e154f3b61f63242a1435a6": {
    "tokens": 1200,
    "content": "[ ] 故障触发方 监控发现\n    - [x] 故障受影响方 监控发现\n    - [ ] 否，原因为：（监控无效/监控缺失）\n+ **是否5分钟内响应**\n    - [x] 是\n    - [ ] 否，原因为：\n+ **是否存在应急协同问题**\n    - [ ] 是\n        - [ ] 应急流程不明确（无流程或者流程不清晰、应急相关角色&职责不明确，缺失一号位等)\n        - [ ] 应急执行不到位（有流程，但未按流程执行，通告发送不及时，响应不及时等）\n    - [x] 否\n\n#### 4.2.2 故障定位&恢复\n+ **主要恢复方式：**\n    - [ ] 代码发布/回滚\n    - [ ] 配置发布/回滚\n    - [ ] 数据订正\n    - [x] 机器隔离/重启/扩容\n    - [ ] 配置限流\n    - [ ] 预案降级\n    - [ ] 自动恢复\n    - [ ] 其他：\n+ **是否10分钟内恢复**__\n    - [ ] 是\n    - [x] 否，原因：定位问题花的时间比较久\n\n**〖关注点1〗定位&恢复阶段存在什么问题？是否可以增加预案，****有更快的恢复方式？****相关的优化改进？**\n\n**〖问题总结〗因为缺少有效的监控手段，导致定位问题花费的时间比较久**\n\n**〖改进点〗**\n\n- [ ] Sunfire应用监控告警完善\n    - FullGC、YoungGC次数\n    - Metaspace 使用率\n\n\n**〖关注点2〗业务自身是否具备容灾逃逸能力？后续如何改进？**__\n\n- [ ] 具备容灾能力\n    - [ ] 因未演练不敢执行\n    - [ ] 因有损评估决策不执行\n    - [ ] 无决策或者决策不当，未执行\n- [x] 不具备容灾能力\n\n## 五、故障Action\n| **序号** | *******Action** | *******负责人** | *******计划完成时间** | **验收标准** | **验收人** | **是否keyAction** | **是否回血Action** |\n| --- | --- | --- | --- | --- | :---: | --- | --- |\n| 1 | 短期：- [x] Metaspace空间大小从512M 调整到 768M | 元茂 | done |  | | | |\n| 2 | 短期：- [x] 机器扩容    - 增加了10台, 当前线上36台 | 元茂 | done |  | | | |\n| 3 | 短期：- [ ] idle-scene应用监控告警完善    - FullGC、YoungGC次数、Metaspace 使用率等 | 希桥 | 1031 |  | | | |\n| 4 | ~~短期：~~- [ ] ~~TOPAPI 配置合理限流~~ | ~~朱华~~ | ~~1107~~ | ~~直接进行接口的性能优化，这个action不做了~~ | | | |\n| 5 | 短期- [ ] 日志治理    - [x] service_stdout.log 日志同步打印去除 (解决磁盘使用率高的问题)     - [ ] 线上日志打印级别调整, INFO不打印 | 元茂 | 1031 |  | | | |\n| 6 | 长期：- [ ] JVM调优    - 应用发布期间, 机器水位会飙升, 需要分析治理 | 元茂玉凇 | 1231 |  | | | |\n| 7 | 长期：- [ ] 魔方券包迁移（目前把idle-scene当成数据库使用）    - 目前卡券平台的定位为: 卖家营销系统 | 剑辛 | 2025.03.31 |  | | | |\n\n\n## 六、影响产品线&影响面\n- [x] 是否有客诉：\n\n客诉影响说明：\n\n+ 闲鱼币券包：95条（达到故障等级：P4）\n+ 回收：10条\n+ 验货宝：12条\n+ 验货报告: 17条\n- [x] 是否有业务影响：\n+ idle-scene应用上所有业务，影响较大的几个业务如下\n    - 闲鱼币积分商城\n    - 服务：回收、验货宝、严选\n    - 小二后台：鱼符、Octopus\n+ idle-scene应用机器存活情况\n    - 总机器数26台\n        * jvm宕机的机器数: 10\n        * 负载高的机器数: 13\n        * 正常运行的机器数: 3\n\n## 七、故障定级&定责&故障分自查\n【故障等级】P4\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/8177/1729668355432-ee594c2c-e731-4a5e-9fa5-98a7f92fc8e6.png)\n\n【故障责任方】无需定责\n\n【故障分】",
    "chunk_order_index": 5,
    "full_doc_id": "doc-62397f0cd5bc8d40fe285be441b9e060"
  },
  "chunk-3848c252af35f8586527a502eb928107": {
    "tokens": 1200,
    "content": "3\n\n## 七、故障定级&定责&故障分自查\n【故障等级】P4\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/8177/1729668355432-ee594c2c-e731-4a5e-9fa5-98a7f92fc8e6.png)\n\n【故障责任方】无需定责\n\n【故障分】1\n\n| **  系统质量（30%）** | | | | | **处置能力（70%）** |\n| :---: | --- | --- | --- | --- | :---: |\n| **相关方** | **需求设计** | **代码质量** | **变更质量** | **自定义项** | **发生时间** | **发现时间（30%）** | **恢复时间（40%）** |\n| 闲鱼技术部 | N | N | N |  | 17:06 | 16:52 | 17:30 |\n\n\n_/* 填写说明：*/_\n\n> 故障涉及相关方都需填写，相关方包括但不限于触发方、根因方、导致故障影响扩大方、受影响方。\n>\n> 参考安全生产度量规范：[https://aliyuque.antfin.com/trecs/fzg6dy/wf9gze](https://aliyuque.antfin.com/trecs/fzg6dy/wf9gze)\n>\n> **系统质量：**\n>\n> + 需求&设计：是否存在系统架构设计、产品设计缺陷等设计方面问题，填 是或否或不涉及\n> + 代码质量：是否自身或引入第三方组件，存在代码BUG、漏洞等。填 是或否或不涉及\n> + 变更质量 ：配置及运维类变更，是否存在方案设计、灰度执行方面问题；提供的工具不满足红线要求方面问题。填 是或否或不涉及\n> + 自定义项：可不填写，根据复盘时讨论点实际确定\n>\n> **处置能力：**\n>\n> + 发生时间、发现时间、恢复时间需填写各方的时间\n> + 填具体时间或不涉及，若非监控发现，则勾选未发现\n> + 发现或恢复能力如不涉及，需描述具体理由\n> + 发现能力：受影响方缺少有效的系统监控手段，未发现业务异常等问题；变更执行方或触发方，对变更没有进行有效的观测，发现能力不足等问题\n> + 恢复能力：受影响方缺少容灾能力，响应速度慢等问题；处置方预案不足，响应速度慢等问题\n>\n\n\n\n## 八、附录\n### 附1：故障打标规范\n参考：[https://aliyuque.antfin.com/ngoc/cltlwa/gw086g](https://aliyuque.antfin.com/ngoc/cltlwa/gw086g)\n\n#### 时间线打标规范\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/7773/1688969397509-2c9d7ddd-d346-4f1f-a73d-490bfab8acef.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/7773/1688969407141-945368c1-0780-4c63-8821-795ab3b5e1b3.png)\n\n\n\n### 附2：故障机制参考\n#### 故障相关方定义\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/7773/1688969946769-8bd28bca-7352-44d1-8b01-c73db5a2d281.png)\n\n[https://aliyuque.antfin.com/ngoc/fzg6dy/laf0oz](https://aliyuque.antfin.com/ngoc/fzg6dy/laf0oz)\n\n\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/2763/1656924636921-077e71cc-a8d1-40a0-8d7d-dc0e9ead77ba.png)\n\n#### 高可用故障分测算\n**横轴表示故障从发生时间开始-恢复时间的整个时长（分钟）：**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/2763/1656924726389-a00fb430-c3bc-44cf-a2aa-cf94aa97d8d4.png)\n\n备注：实际故障分以系统计算结果为准。\n\n\n\n**高可用故障分计算系数：**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/2763/1656924851376-9d274389-90ce-47e1-a3b7-1ed29818f417.png)\n\n#### 资损故障定级\n参考：[https://aliyuque.antfin.com/ngoc/fzg6dy/hikl2ibbk8934lax](https://aliyuque.antfin.com/ngoc/fzg6dy/hikl2ibbk8934lax)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/",
    "chunk_order_index": 6,
    "full_doc_id": "doc-62397f0cd5bc8d40fe285be441b9e060"
  },
  "chunk-179b8d7a71fbcb736378fb55f0c77e3f": {
    "tokens": 553,
    "content": "90ce-47e1-a3b7-1ed29818f417.png)\n\n#### 资损故障定级\n参考：[https://aliyuque.antfin.com/ngoc/fzg6dy/hikl2ibbk8934lax](https://aliyuque.antfin.com/ngoc/fzg6dy/hikl2ibbk8934lax)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/7773/1688970048219-78b29218-2ff2-499b-8f9d-70d50392106e.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/7773/1688970064707-8e0efecd-f516-4bd0-83ed-78a49f9d8316.png)\n\n#### 资损故障分测算\n横轴表示实际资损金额（元）：\n\n| **** | **1W** | **5W** | **10W** | **30W** | **50W** | **80W** | **100W** | **150W** | **200W** | **500W** | **1KW/E2** |\n| :---: | :---: | :---: | :---: | :---: | :---: | --- | :---: | :---: | --- | --- | --- |\n| **P1** |  |  |  |  |  | | **233.0** | 243.0 | 253.0 | 313.0 | 826.0 |\n| **P2** |  |  |  |  | **57.5** | 72.5 | 82.5 |  | | | |\n| **P3** |  |  | **22.5** | 32.5 | 42.5 | 57.5 |  |  | | | |\n| **P4** | **10.0** | 12.0 | 14.5 | 24.5 |  | |  |  | | | |\n\n\n备注：实际故障分以系统计算结果为准。\n\n计算逻辑参考：[https://aliyuque.antfin.com/trecs/fzg6dy/wf9gze#VRs0g](https://aliyuque.antfin.com/trecs/fzg6dy/wf9gze#VRs0g)\n\necho '(P+(F-B)*0.5)*E' |bc -l",
    "chunk_order_index": 7,
    "full_doc_id": "doc-62397f0cd5bc8d40fe285be441b9e060"
  },
  "chunk-6e73b718ef185e36a76d00639f0197c4": {
    "tokens": 1200,
    "content": "## 一、故障简述\n于13:56收到反馈自定义装修无法推广到主题搜，反馈量50+，触达P4故障，初步排查与igraph数据缺失导致，通过全量触发增量数据于14:38批量恢复。\n\n## 二、故障过程回顾\n_/* 填写说明：整体故障时间线参考_【故障引入】**【故障发生】【故障发现】**【故障响应】【故障定位】【恢复执行】**【故障恢复】**【影响消除】_时间点。*/_\n\n| **时间轴** | **事件** |\n| :--- | :--- |\n| 2024-10-24 07:59 | **【故障引入】** 存储了主题搜卖家白名单的igraph表(querymatch表)索引切换完成 |\n| 2024-10-24 08:37  | 第一例主题搜舆情 |\n| 2024-10-24 13:56 | **【故障发现】【故障发生】【故障响应】**风险预警产生，拉群主搜同学开始排查![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/12771/1730208781535-225d1e59-39c3-4be5-bc4e-3d8076f015a2.png) |\n| 2024-10-24 14:26  | **【故障定位】**君默反馈调用线上HSF服务，返回注释说明商家不在白名单内，搜索侧初步判断是igraph数据问题 |\n| 2024-10-24 14:31  | 单个卖家通过igraph增量更新，前台验证恢复 |\n| 2024-10-24 14:38  | **【恢复执行】【故障恢复】**全量商家通过增量更新恢复，线上问题恢复 |\n\n\n## 三、故障原因\n### 3.1【背景说明】\n#### 【业务背景】\n:::tips\n主题搜产品上线背景是基于商业化。名单内商家可以在对应的品牌词下投放SRP的第一页第2位，每个商家支持投放的品牌query为1-4个。目前已开通的商家主题搜名单3529家。\n\n:::\n\n**【样式效果】**\n\n:::tips\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/73432/1730199103492-07505e3e-02d2-4037-9d7c-aee160d9f7b5.png)\n\n附：[https://aliyuque.antfin.com/jiayin.yzz/ghrve9/dyvkxu](https://aliyuque.antfin.com/jiayin.yzz/ghrve9/dyvkxu)\n\n:::\n\n#### 【业务链路】\n:::tips\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/73432/1730199103484-97072642-dd11-41ce-88aa-de2214eca695.png)\n\n:::\n\n### 3.2【原因分析】\n#### 一句话原因：\n:::tips\n商家主题搜卖家表被错峰调度到10点运行，导致该表的数据没有写入querymatch，进而导致在线接口查不到商家主题搜推广信息。\n\n:::\n\n#### 根因分析：\n:::tips\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/73432/1730199103440-8e2a68f8-42a9-42af-8aac-9146e9c5aaa9.png)\n\n+ 商家白名单表search_f2e_odps_core.skyline_ztsh5sellerwhite 被错峰调度到10点运行，querymatch表被全量回流至在线Igraph提供查询前，没有被调度，导致该表的数据缺失。\n+ 旺铺后台通过HSF接口查询商家权限时，导致对应商家权限未查到，商家后台不再透出 \"推广到主题搜\"。\n+ ODPS目前针对1到3级低优先级作业进行错峰延迟调度，将任务均匀分布在全天时段运行，优化作业运行效率。\n\n\n**【任务信息】【调度信息】**\n\n主题搜商家权限数据插入querymatch表的任务:\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/73432/1730199103486-48bc7e20-933e-4928-95f5-376776369f82.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/73432/1730199103528-4dfb10af-530d-4a83-ab8e-65062c41cdbb.png)\n\n产出querymatch.done分区的任务：\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/73432/1730199104121-403994e0-094e-4c14-abdf-6b7b308ba2a6.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/73432/1730199104313-d33cc851-b167",
    "chunk_order_index": 0,
    "full_doc_id": "doc-385f6b4ade94df3a0e2bb712f552c68f"
  },
  "chunk-247c289f0f9d96d9c85fbd47b5d46655": {
    "tokens": 1058,
    "content": "querymatch.done分区的任务：\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/73432/1730199104121-403994e0-094e-4c14-abdf-6b7b308ba2a6.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/73432/1730199104313-d33cc851-b167-42bf-8dc4-9497c776e246.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/73432/1730199104315-02331d73-fb00-4f1f-8017-0fc9a4cc1f0d.png)\n\n:::\n\n## 四、故障关注点\n**〖关注点1〗****如何确保核心任务调度不被错峰？**\n\n:::tips\n**〖问题总结〗**离线任务缺乏基线配置，核心依赖未被正确描述。\n\n**〖改进点〗**\n\n+  梳理querymatch核心依赖任务，并与querymatch.done任务设置依赖关系\n+  querymatch[所有依赖](https://alidocs.dingtalk.com/i/nodes/6LeBq413JA9BOdm2iy3kM0Z7JDOnGvpb)设置5基线，提升基线\n+ querymatch所有依赖表设置正确的负责人\n+ querymatch涉及的核心同步任务，预警有效性确认（接收人、方式等重点关注）\n\n:::\n\n\n\n**〖关注点2〗****图治进行错峰调度，被调度方是否有感知，如何避免同类问题？**\n\n:::tips\n**〖问题总结〗**任务被错峰调度，有通知，但是该任务由于之前同学离职，默认被转交到了空间管理员。空间管理员不关注具体的调度任务执行情况。\n\n**〖改进点〗**任务转交时，转交给主管，由主管进行再分配**    @天泷.      11.15 **日前给出结论或排期\n\n:::\n\n\n\n**〖关注点3〗****从链路上看，权限控制走的是ODPS离线链路，是否可直接取数据库数据？**\n\n:::tips\n**〖问题总结〗**该链路为历史链路，当初为何这样设计，无法追溯，后续主题搜链路优化，白名单权限查询链路去除querymatch依赖\n\n**〖改进点〗**\n\n+  主题搜链路优化，白名单权限查询链路去除querymatch依赖。      @**六泰**      11.31日\n+  推动业务链路下线，确定是否可行        @**六泰**      11.01日\n\n:::\n\n\n\n**〖关注点4〗****问题是否可以通过系统监控发现？**\n\n:::tips\n**〖问题总结〗**\n\n+ **  供给侧：**不能，该业务的服务接口调用量很低，配置监控维度的报警很容易误报，发现不了问题\n+ **  搜索侧：**不能，该业务的服务接口调用量很低(不到1QPS)，配置监控维度的报警很容易误报，并且在出问题期间接口服务正常，只是返回无权限的状态码。后续通过case冒烟的形式加强保障。\n\n       ![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/73432/1730260141966-ab03dd83-8dcd-4142-a0c3-a2c986948c03.png)\n\n**〖改进点〗**\n\n+   主题搜权限链路接口增加冒烟，确保功能正确         @成都.     11.15日\n\n:::\n\n## 五、故障Action\n| **序号** | *******Action** | *******负责人** | *******计划完成时间** | **验收标准** | **是否keyAction** | **是否回血Action** |\n| --- | --- | --- | --- | --- | --- | --- |\n| 1 | 主题搜权限链路接口增加冒烟，确保功能正确 | 成都 | 11.16 | 冒烟增加完成 | 否 | 否 |\n| 2 | 梳理querymatch核心依赖任务，并与querymatch.done任务设置依赖关系 | 六泰 | 11.31 | 依赖去除掉或业务下线 | 否 | 否 |\n| 3 | 任务转交时，转交给主管，由主管进行再分配 | 天泷 | 11.15 | 给出答复，如果现有能力不支持，需确定需求排期日期 | 否 | 否 |",
    "chunk_order_index": 1,
    "full_doc_id": "doc-385f6b4ade94df3a0e2bb712f552c68f"
  },
  "chunk-b9c223608b66bc5105b9c40d0a94c03b": {
    "tokens": 1200,
    "content": "## 一、故障简述\n2024-10-21 19:17，批量用户反馈商品详情展示原价，客诉反馈量530+，触达P3，于19:41通过关闭GCIH恢复。故障原因为双11大促，营销将优惠数据写入GCIH中，GCIH中优惠数据模型中没有gmtModified字段，线上代码使用该字段的地方没有判null，线上抛npe异常，导致券后价丢失。\n\n## 二、故障过程回顾\n| **时间轴** | **事件** |\n| --- | --- |\n| 2024-10-10 20:00 | **【故障注入】**[https://code.alibaba-inc.com/ump2/ump2/codereview/18639527?file=1c3c78b8f6059f6d779fc15ffe07d95a94a17f3f](https://code.alibaba-inc.com/ump2/ump2/codereview/18639527?file=1c3c78b8f6059f6d779fc15ffe07d95a94a17f3f)![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/64756282/1729587449607-3581c051-42c5-4ebf-9600-71b0e7089da0.png?x-oss-process=image%2Fformat%2Cwebp%2Fresize%2Cw_1500%2Climit_0) |\n| 2024-10-21 19:01 | **【故障发现】**UMP推送预案，ump线上marketDetail开始从GCIH缓存读取优惠数据，线上详情券后价、购物车券后价开始抛npe异常，价格一致率开始下跌![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/64756282/1729686789286-121ca34c-916f-4b12-a18b-c4d7bea440b1.png)![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/64756282/1729604337750-cc4e3b96-a11d-48fc-9397-57225295fd5d.png) |\n| 2024-10-21 19:04 | **【故障响应】**消费券业务同学反馈详情氛围腰带、利益点消失，苍蔚开始拉人排查问题； |\n| 2024-10-21 19:08 | 购物车反馈，线上购物车券后价无法透出；猫超同学反馈线上猫超商品在详情不展示券后价；UMP侧开始排查问题；![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/64756282/1729604438234-2880e3cf-43fe-4eb0-9e4b-393b2dc29e31.png) |\n| 2024-10-21 19:11 | 猫超提供线上有问题trace![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/64756282/1730118824396-839ac2e3-eee5-4787-be23-d41876684e72.png) |\n| 2024-10-21 19:14 | ** **购物车提供券后价不出的trace![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/64756282/1729688968784-bc75d76f-cf83-4211-826f-07124abb202e.png) |\n| 2024-10-21 19:17 | 线上开始出现舆情，详情展示原价![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/12771/1729906098167-b73723e8-1b03-42c3-9aa2-97e1c2d9d578.png) |\n| 2024-10-21 19:17 | 与扉梳理符合时间的开关推送，怀疑和奥格人群有关，拉奥格同学一起帮忙排查问题![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/64756282/1730119124323-a2d5a8cd-09c7-455c-8613-53b14a3cc2ad.png) |\n| 2024-10-21 19:18 | 墨锦组织ump和购物车同学集中线下排查问题![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/64756282/1729687205264-e33106e9-411d-401e-8e46-b192527a787c.png) |\n| 2024-10-21 19:21 | 猫超和详情、ump开始拉会对券后价及氛围丢失问题![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/64756282/1729688716027-710a6922-c70c-4e18-8908-b91dfbbb",
    "chunk_order_index": 0,
    "full_doc_id": "doc-91bc84dcb743c1f9a55130e6190845d1"
  },
  "chunk-d6f46c58b059ec300ff31752711dd08a": {
    "tokens": 1200,
    "content": "401e-8e46-b192527a787c.png) |\n| 2024-10-21 19:21 | 猫超和详情、ump开始拉会对券后价及氛围丢失问题![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/64756282/1729688716027-710a6922-c70c-4e18-8908-b91dfbbb8ca5.png) |\n| 2024-10-21 19:25 | 预发无法复现线上问题，开始使用百宝箱，在线上复现问题 |\n| 2024-10-21 19:26 | **【故障发生】**线上舆情触发p4故障![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/64756282/1729687960635-b726262c-8567-43aa-ba2e-b289b8ec9587.png) |\n| 2024-10-21 19:27 | 线上复现优惠整体消失，优惠域无结果，线上日志无异常，使用arthas抓线上异常 |\n| 2024-10-21 19:29 | 彬尉开始逐渐恢复预案: [降级单品补贴黑人群校验]、[猫超单品立减消费者AB实验停用预案]、[pmp详情日志百分比]等预案，到19:41分，共恢复24条预案 |\n| 2024-10-21 19:30 | 直播同学当时在写优惠数据，怀疑写入异常数据引起优惠域异常，拉直播和玩法同学排查 |\n| 2024-10-21 19:35 | 与扉通过复现问题，发现线上代码有npe![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/64756282/1729689098816-b8bbe1c5-3449-400b-9bbb-80a74af9425d.png) |\n| 2024-10-21 19:36 | 复现线上问题，找到问题数据，开始订正db，并且清理tair缓存，但是线上无效果 |\n| 2024-10-21 19:38 | **【初因定位】**查问题商品的优惠数据，缓存中已无数据，db数据也删除，但是线上仍然能查到这条数据，怀疑为GCIH导致问题 |\n| 2024-10-21 19:40 | ump侧初步怀疑线上异常和脏数据有关![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/64756282/1729689305225-bf07666f-e30d-4318-bcab-f8255f7e37da.png) |\n| 2024-10-21 19:41 | **【恢复执行】【故障恢复】**辛德推送恢复GCIH预案，线上恢复![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/64756282/1729689192996-6ef95106-6199-4f2f-9e81-1290c467f9ee.png) |\n\n\n\n\n## 三、故障原因\n### 3.1【背景说明】\n#### 【需求背景】\n:::tips\n全链接价格一致性专项中，为了识别导购(如搜索、首页等)跳转详情时，价格不一致CASE中，哪些是因为优惠变更导致符合预期的不一致，在ump侧透出优惠的变更时间gmtModified至ut日志埋点，供价格一致性报表使用\n\n:::\n\n#### 【业务链路】\n![画板](https://intranetproxy.alipay.com/skylark/lark/0/2024/jpeg/64756282/1729585416948-44637bff-bbd4-4b81-9cf2-737bcaece6bf.jpeg)\n\n\n\n### 3.2【原因分析】\n#### 一句话原因：\n:::tips\n大促态，ump的normalhost、detailhost分组切换使用GCIH中缓存读取优惠信息，GCIH缓存中使用的优惠对象模型MarketingDetaiVO中没有gmtModified字段，MarketingDetaiVO模型通过转换成MarketingDetailDO, gmtModified默认为null，ump代码使用MarketingDetailDO的gmtModified字段的地方没有判空，导致线上抛空指针异常\n\n:::\n\n#### 根因分析：\n:::tips\n1. 日常态情况：日常态ump查询marketDetail时，使用hotSensor、tair、db三级缓存，这三级缓存承载的模型为MarketingDetailDO\u0000，**底表中gmtModified字段为not null，日常态没有问题**\n2. 大促态情况：为了应对双11大促高流量、减少远端调用，消除读热点，提升应用性能，会提前将优惠数据提前写进本地GCIH缓存，GCIH总缓存的模型为MarketingDetailVO\u0000，该模型中gmtModified字段为null，通过转换回MarketingDetailDO后，MarketingDetailDO中gmtModified字\n3. 段为null，后续使用该字段的过程中，没有进行判null，导致线上抛空指针异常。\n\n问题代码：\n\n![](https://intranetproxy.alipay.com/skyl",
    "chunk_order_index": 1,
    "full_doc_id": "doc-91bc84dcb743c1f9a55130e6190845d1"
  },
  "chunk-ca59a47073af34092104db8eef44e12e": {
    "tokens": 1200,
    "content": "，提升应用性能，会提前将优惠数据提前写进本地GCIH缓存，GCIH总缓存的模型为MarketingDetailVO\u0000，该模型中gmtModified字段为null，通过转换回MarketingDetailDO后，MarketingDetailDO中gmtModified字\n3. 段为null，后续使用该字段的过程中，没有进行判null，导致线上抛空指针异常。\n\n问题代码：\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/64756282/1729587449607-3581c051-42c5-4ebf-9600-71b0e7089da0.png)\n\n:::\n\n![画板](https://intranetproxy.alipay.com/skylark/lark/0/2024/jpeg/64756282/1730122482478-509a8844-b1ff-43e5-92d6-4e5713be69d2.jpeg)\n\n### 四、故障关注点\n#### 1、故障前\n**〖关注点1〗****双11大促****前日常态线上为什么没有问题，为什么出技术方案及代码改造中没有考虑到该问题？**\n\n:::tips\n**〖总结〗ump：**该代码改造发布时间为10.10号，日常态没有问题，因为日常态使用的缓存不包括GCIH，日常态使用的缓存中使用MarketingDetailDO作为缓存对象，MarketingDetailDO字段中有gmtModified字段并且为2018年变更的字段，为线上已有字段，在没有新增字段的前提下，并没有考虑到，大促态使用GCIH缓存中使用MarketingDetailVO作为缓存对象，在MarketingDetailVO对象转换回MarketingDetailDO字段后，gmtModified字段为null，导致空指针异常。\n\n**〖改进点〗**\n\n+  代码中增加判null     [@夕柯](undefined/leiyuqi.lyq)   已完成\n+  梳理GCIH中MarketingDetailVO模型和MarketDetailDO模型中对不齐的字段，避免二次踩坑     [@夕柯](undefined/leiyuqi.lyq)   11.1日\n+  不对齐字段风险点落入代码规范，后续开发过程规避。    [@孜于](undefined/liming.slm)    11.8日\n\n:::\n\n\n\n**〖关注点2〗****为什么不同的缓存之间使用不同的缓存对象？为什么GCIH中缺少gmtModified字段？**\n\n:::tips\n**〖总结〗ump：**GCIH为GC不可见内存，非常适合优惠这种读多写少的场景，营销每次大促会将优惠数据提前写进本地GCIH缓存，达到减少远端调用，消除读热点，提升应用性能的目的。由于GCIH使用的为机器内存空间，为了尽量精简内存，缓存中仅保留有明确业务语意字段，gmtModified字段在日常开发中并不会使用到，因此，并没有缓存gmtModified字段。\n\n**〖改进点〗同上**\n\n:::\n\n\n\n**〖关注点3〗****GCIH写入优惠数据之前有无验证，之前全链路压测为何未发现？**\n\n:::tips\n**〖总结〗ump：**大促前，线上并未使用过GCIH缓存读取优惠数据，因此线上链路并未发现问题。全链路压测中，压测链路使用了GCIH缓存，但是由于大促压测过程中进行日志降级，导致压测过程中也没有发现该问题。\n\n**〖改进点〗**\n\n+   后续压测机器保留部分机器进行日志监控，增加至大促作战手册；       [@苍蔚](undefined/sensencui.css)  11.1日\n+   梳理导购交易测试用例集，后续压测时测试需要进行业务功能验证；    [@义武](undefined/hongze.hhz)  11.1日\n\n:::\n\n#### 2、故障处置\n**〖关注点1〗****是否有监控发现？监控方面是否有可优化空间？**\n\n:::tips\n**〖总结〗ump：**线上价格一致性监控于19:01分开始，主搜、店铺内搜等场域的价格一致性由98%跌至77%，当时该监控并未配置监控报警，且故障发生时，值班人群刚值班完预售商品去标，正在吃晚餐，发现有一定的延迟。\n\n**〖改进点〗**\n\n+ 完善告警阀值：价格一致性实时监控单独配置监控群，主搜、首页等关键场域价格一致性下预期外下跌至95%以下会持续告警。           [@夕柯](undefined/leiyuqi.lyq)   11.1日\n\n:::\n\n**〖关注点2〗****后续如何快速能够快速的发现、定位问题？**\n\n:::tips\n**〖总结〗当时应急过程中，没有明确的分工，**后续大促值班中，值班人员会有更加详情的分工，每人盯好负责的大盘，有预期之外的变更第一时间同步值班群\n\n:::\n\n## 五、故障Action\n| **序号** | *******Action** | *******负责人",
    "chunk_order_index": 2,
    "full_doc_id": "doc-91bc84dcb743c1f9a55130e6190845d1"
  },
  "chunk-f259450ff68927320d42335d1a2cb238": {
    "tokens": 456,
    "content": "2〗****后续如何快速能够快速的发现、定位问题？**\n\n:::tips\n**〖总结〗当时应急过程中，没有明确的分工，**后续大促值班中，值班人员会有更加详情的分工，每人盯好负责的大盘，有预期之外的变更第一时间同步值班群\n\n:::\n\n## 五、故障Action\n| **序号** | *******Action** | *******负责人** | *******计划完成时间** | **验收标准** | **是否keyAction** | **是否回血Action** |\n| --- | --- | --- | --- | --- | --- | --- |\n| 1 | 短期：代码中增加判null | 夕柯 | 11.1 | 代码修复完成 | 否 | 否 |\n| 2 | 短期：梳理GCIH中MarketingDetailVO模型和MarketDetailDO模型中对不齐的字段，避免二次踩坑 | 夕柯 | 11.1 | 不对齐字段梳理完成 | 否 | 否 |\n| 3 | 短期：不对齐字段风险点落入代码规范，后续开发过程规避。 | 孜于 | 11.8 | 代码规范中此条风险加入完成 | 否 | 否 |\n| 4 | 短期：   后续压测机器保留部分机器进行日志监控，增加至大促作战手册 | 苍蔚 | 11.1 | 大促作战手册中增加完成 | 否 | 否 |\n| 5 | 短期：梳理导购交易测试用例集，后续压测时测试需要进行业务功能验证 | 义武 | 11.1 | 测试用例梳理完成 | 否 | 否 |\n| 6 | 短期：完善告警阀值 | 夕柯 | 11.1 | 监控具体告警阀值配置完成 | 否 | 否 |\n\n\n##",
    "chunk_order_index": 3,
    "full_doc_id": "doc-91bc84dcb743c1f9a55130e6190845d1"
  },
  "chunk-7fa9af1272dee4192a630e9030d74c38": {
    "tokens": 1200,
    "content": "## 一、故障简述\n20:33开始天猫国际订单创建成功率异常，20:48成功率低于90%，20:52成功率最近5分钟最大值小于90%，达到P4故障。故障初步原因为精卫任务更新 tair 异常导致同步有延迟，21:00下线 tair 问题机器后故障恢复。\n\n## 二、故障过程回顾\n| **时间轴** | **事件** |\n| --- | --- |\n| 2024-10-21 20:19 | **【故障发现】**ump同学接到电话告警，ump2优惠缓存精卫出现延迟![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/321356/1730085335536-61c1bdd5-9f39-4942-bf54-b0a4ac213e1a.png) |\n| 2024-10-21 20:23 | **【故障响应】**ump 同学拉群开始定位问题 |\n| 2024-10-21 20:30 | tair 同学进群开始排查访问超时问题 |\n| 2024-10-21 20:33 | 天猫国际订单创建场景监控预警     ![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/12771/1729954138177-557f425f-4b59-463a-a813-f9c6b6fe3feb.png) |\n| 2024-10-21 20:35 | **【故障响应】**兵林接手拉群排查 |\n| 2024-10-21 20:35 | 天猫国际定位到报错和UMP相关，邀请UMP同学排查![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/12771/1729954303587-f04f5cc7-93d6-478a-92a2-c3acde065ac7.png) |\n| 2024-10-21 20:41 | **【恢复执行】**tair 同学开始杀有问题机器的进程，hotzone 会自动切到其他机器，center单元下线一台tair问题机器，发现业务指标恢复后开始逐个操作 unn1 单元的问题 tair 机器，停进程 |\n| 2024-10-21 20:45 | 中心单元精卫任务延迟追平，中心单元完全恢复 |\n| 2024-10-21 20:52 | **【故障发生】**20:48开始,成功率最近5分钟最大值小于90%，触达P4![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/12771/1729955050439-3348a6ec-255b-49aa-8d3a-77296766b2ee.png) |\n| 2024-10-21 20:53 | 同步原因：精卫同步有延迟 目前只有unn1机房有问题 导致优惠不一致 阻断下单![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/12771/1729954486669-dbdf2959-1098-4cd3-9df7-8fc28ebc9391.png) |\n| 2024-10-21 20:55 | tair 侧把异常的 hotzone机器全部杀停进程后业务测访问成功率开始恢复![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/16378/1730084394596-b47c2771-fc38-4f5b-ab50-197c45f6a67c.png) |\n| 2024-10-21 21:00 | **【故障恢复】**21点左右，数据追平，成功率恢复至日常水位 |\n\n\n## 三、故障原因\n### 3.1【背景说明】\n:::tips\n业务侧在峰值前临时决策关闭ump的gcih（本地缓存发现脏数据），关闭后会导致请求 tair 流量非常高。20点开始瞬间热点流量非常高，tair 单机压力增大。\n\n:::\n\n### 3.2【原因分析】\n#### 一句话原因：\n:::tips\n20点开始瞬间热点流量非常高，unn1 ump mtair集群7个hotzone tair节点上的部分线程被持续打满，进程处理不过来引发精卫同步延时，导致优惠不一致，阻断下单。\n\n:::\n\n#### 详细原因：\n![画板](https://intranetproxy.alipay.com/skylark/lark/0/2024/jpeg/12771/1730098847894-309cc964-cc68-40a6-9c64-2b28feaf92ab.jpeg)\n\n:::tips\nump2活动详情以及券模板等与优惠计算有关的数据存在tair中。当优惠活动发生变更，精卫监听到数据变更后会调tair失效缓存，ump2后续再查询对应的缓存key时查不到数据，就会重新将最新的数据写入tair，达到缓存和数据库一致。\n\n出问题时大量的 hotzone 请求和 slow query 导致tair 处理 hot zone及slow query对应的4",
    "chunk_order_index": 0,
    "full_doc_id": "doc-569b3c53f69397cabf16039c5ccf2eb4"
  },
  "chunk-af86a388cbdc66906d34da46d8c341db": {
    "tokens": 1200,
    "content": ")\n\n:::tips\nump2活动详情以及券模板等与优惠计算有关的数据存在tair中。当优惠活动发生变更，精卫监听到数据变更后会调tair失效缓存，ump2后续再查询对应的缓存key时查不到数据，就会重新将最新的数据写入tair，达到缓存和数据库一致。\n\n出问题时大量的 hotzone 请求和 slow query 导致tair 处理 hot zone及slow query对应的4个线程队列是最拥堵的，同时也会带来在同一个物理core上的其他worker线程的队列拥堵。由于hot zone及slow query的线程没有绑核，会在时间线上不同程度的影响其他所有worker线程，导致tair部分机器Hang住。tair部分机器hang住后，当精卫处理数据库消息失败后，失效缓存会失败。\n\n确认订单时的优惠计算取的是缓存中的数据，创建订单时优惠计算取的是数据库中的数据，由于缓存数据不一致这两次优惠计算结果不同，因此会阻断下单。\n\n\n\n**指标情况：**\n\nump集群中一共有10个ds开了hotzone，从20:00开始，从监控观测这10个hotzone所在的ds处于hang死状态（注：tair后面分析推测是metrics汇报线程被压制导致指标丢失，实际入口流量并未大量减少，但确实存在访问超时现象）\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/125991/1729579965320-a62bd35f-98df-487c-ab06-16c5b82833cd.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/125991/1729580029286-72b2aa59-7de8-45c0-9c62-f6d71ac25ddd.png)\n\n以33.37.66.95为例，峰值时刻的流量表现为：1.读写流量长时间丢弃；2.hotzone流量长时间丢弃；3.ds所在的物理机有4个cpu核被打满。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/125991/1729580147638-edbd712d-53e9-4f69-95d4-dfaa4173db3a.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/125991/1729581081913-17c9ed39-5311-45c9-acb3-77e6874cc078.png)\n\n\n\n20:20左右，运维同学收到ump集群的问题反馈，怀疑是处理hotzone的线程被打爆，导致ds不可服务。故开始尝试下线一台hotzone所在的ds。hotzone所在的ds下线后，这个hotzone会飘到其他ds上，使得集群内部署了hotzone的ds维持在10台。尝试下线一台hotzone所在的ds后，hotzone飘到了33.37.66.1。从指标可以看到，33.37.66.1的hotzone拉起后，33.37.66.1的服务能力正常。故而，陆续下线了7台被hotzone hang住的ds，并且发现新起hotzone都能正常服务。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/125991/1729580451399-3e61f79b-b4d4-4837-82b3-75353ff1081f.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/125991/1729580282548-64d9502c-0198-4d58-8cca-6a399b044d8e.png)\n\n:::\n\n\n\n## 四、故障关注点\n#### 1、变更过程\n**〖关注点1〗****为何une1单元影响较少 ？**\n\n:::tips\n**〖问题总结〗通过分析问题机器的hot_query.log及slow_query.log日志可以发现，业务query存在极热key问题和slow query的问题。**影响最大的 unn1单元对比 une1 ，unn1承担的压力比une1高15%，unn1比une1承担了更多的hot key和slow query。mdb ds在处理query的时候，如果发现query是slow query则交由slow query worker线程处理，否则如果发现是hotzone query则交由hotzone worker线程处理，如果都不是则由普通的worker线程处理。优先处理逻辑如下图所示。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/38549/1729581475886-ab69a180-8179-4941-8c2d-57c72ad0b3e3.png)\n\n由于业务明显的hot key及slow query特性， hot zone worker及slow query worker的2组共4个线程持续被打满\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/38549/1729588421529-9285d53e-5626-46e0-8eec-de28244f73f2.png)\n\n对比了一下unn1和une1的两台hotzone的机器一",
    "chunk_order_index": 1,
    "full_doc_id": "doc-569b3c53f69397cabf16039c5ccf2eb4"
  },
  "chunk-0a409cb1b23e28e74433c25d29a1e578": {
    "tokens": 1200,
    "content": "hot key及slow query特性， hot zone worker及slow query worker的2组共4个线程持续被打满\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/38549/1729588421529-9285d53e-5626-46e0-8eec-de28244f73f2.png)\n\n对比了一下unn1和une1的两台hotzone的机器一段时间内的slow query日志，une1的机器上几乎没有slow query(一条)，unn1却非常多(25189条)\n后续：分析unn1和une1模型差异，继续明确为何两边slow query分布不均，两次都在unn1机房出现。 \n\n**〖改进点〗**\n\n+ UMP先分析slow query的占比。      [@辛德](undefined/xinde.xy)       11.30日\n+ 长期：tair优化目前线程的调度模型，当前只是一个想法，方案等并补确定   --不记录具体完成时间\n\n:::\n\n__\n\n****\n\n**〖关注点2〗****实际请求为何没有被均匀分配，而是固定在几个核上？**\n\n:::tips\n**〖问题总结〗**目前按照 tair 测代码看未发现出问题的线程队列绑核的设置，但是实际发现是固定在几个核上，原因还未查明，需要内核同学一起排查。\n\n**〖改进点〗**tair继续推进排查，时间暂不确定。\n\n:::\n\n__\n\n**〖关注点3〗****tair 在逐个停进程的过程中，精卫没有逐步恢复，而是最后一台处理完成之后迅速恢复？**\n\n:::tips\n**〖问题总结〗**\n\n业务侧：当精卫处理数据库消息失败后，精卫会重试3次，仍然失败后会进行重启，随后继续尝试处理这条数据，这意味着只要tair集群中存在不可用的ds，精卫在处理对应不可用ds的数据时就会一直卡住，后续数据都不会被处理，因此只有在tair集群中完全恢复后，精卫才能连续消费数据，追平缓存差异。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/12771/1729955050439-3348a6ec-255b-49aa-8d3a-77296766b2ee.png)\n\ntair 侧：![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/16378/1730084394596-b47c2771-fc38-4f5b-ab50-197c45f6a67c.png)\n\n精卫这边能提供的能力是调整重试的次数和重试的间隔，暂无其它优化办法。业务方可根据实际情况酌情调整。\n\n**〖改进点〗**暂无\n\n:::\n\n**〖关注点4〗****在压测过程中是否有停掉过GICH，压测过程中是否有发现异常？**\n\n:::tips\n**〖问题总结〗**\n\n10.12压测的定金阶段，GCIH关闭后tair访问量为2亿，21号当天最高访问量为1.3亿，压测过程中也发现了问题，同样集中在unn1单元，当时压测有停止。\n\n10.12 21:10-21:20 定金压测\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/312798/1730186073323-dcff4e96-7469-41ac-920a-415dc03ce789.png)\n\n10.21 20:00-20:04 一峰实际\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/312798/1730186085480-155faa4e-eb78-4294-9f47-176c2f507fb0.png)\n\n**〖改进点〗**同关注点1，UMP需要重点分析slow query的占比，看看是否在不同的单元有不同的数据特性。\n\n:::\n\n####  2、应急处置\n**〖关注点1〗****是否有监控发现？监控方面是否有可优化空间？**\n\n:::tips\n**〖问题总结〗**\n\n+ 天猫国际和UMP在20:19分及20:33分均有告警出现\n+ tair 客户端监控日志采集ump 日志被降级导致 oncall 报警没有及时报警出来\n\n**〖改进点〗**\n\n+ tair增加worker线程拥堵日志报警及kmon监控。     [@三团](undefined/santuan.wxy)     已完成\n+ 增加tair/精卫客户端报错告警给业务方。               [@三团](undefined/santuan.wxy)     11.8日\n\n:::\n\n\n\n**〖关注点2〗****恢复过程中否有更快的方法找到问题机器？当时看到是精卫在捞取机器；**\n\n:::tips\n**〖问题总结〗**故障当时精卫和tair一起在捞取机器，相互之前需要做确认，另外，tair客户端是有大盘的，可以从大盘上直接看出异常的机器，tair服务端由于当前监控异常，所以没有从",
    "chunk_order_index": 2,
    "full_doc_id": "doc-569b3c53f69397cabf16039c5ccf2eb4"
  },
  "chunk-1138ea3d918d86beba8fd266457f9098": {
    "tokens": 464,
    "content": ":::\n\n\n\n**〖关注点2〗****恢复过程中否有更快的方法找到问题机器？当时看到是精卫在捞取机器；**\n\n:::tips\n**〖问题总结〗**故障当时精卫和tair一起在捞取机器，相互之前需要做确认，另外，tair客户端是有大盘的，可以从大盘上直接看出异常的机器，tair服务端由于当前监控异常，所以没有从后端直接看到异常的机器，监控问题修复后，后续可以从tair服务端直接发现问题机器，这个是tair已有的能力。\n\n**〖改进点〗**暂无\n\n:::\n\n\n\n## 五、故障Action\n_/* 填写说明：Action制定原则*/_\n\n> _机制流程建议不超过总数的20%；_\n>\n> _Action数量建议不超过10条；_\n>\n> _短期Action建议1-2周内完成，并内部验收（如缺陷修复、监控等避免故障再发的的措施需列为短期Action）；_\n>\n> _P1P2需至少有1个keyAction（治本Action，从根源上避免类似重大故障再发生/控制爆炸半径）；_\n>\n> _Action描述须完整、语言简洁，一目了然。_\n>\n\n| **序号** | *******Action** | *******负责人** | *******计划完成时间** | **验收标准** | **是否keyAction** | **是否回血Action** |\n| --- | --- | --- | --- | --- | --- | --- |\n| 1 | 短期：增加线程队列拥堵日志报警 | 三团 | 11.1 | 监控增加完成 | 否 | 否 |\n| 2 | 短期：UMP分析slow query的占比 | 辛德 | 11.30 | 分析完成 | 否 | 否 |\n| 3 | 短期：增加tair/精卫客户端报错告警给业务方 | 三团 | 11.8 | 监控增加完成 | 否 | 否 |",
    "chunk_order_index": 3,
    "full_doc_id": "doc-569b3c53f69397cabf16039c5ccf2eb4"
  },
  "chunk-9dceb71d540b4b41d4a3de66afa6fc08": {
    "tokens": 1200,
    "content": "![](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/9827/1659103353652-0274c8cd-7318-4cd9-b730-0d66221680b6.png)\n\n**内容涉及公司B3级别以上机密数据，请注意保密！**\n\n| **复盘参与人员** | 稳定性负责人：广生SRE：娇娇工程技术-引擎平台-引擎数据工程：亮深工程技术-效果引擎-展示广告引擎：莲童工程技术-引擎平台-引擎框架与中间件：明生工程技术-效果引擎-搜索&直播广告引擎：画沙工程技术-效果引擎-展示广告引擎：应灵广告算法-智能广告平台：弈理、涯岸工程技术-实验平台：撇捺工程技术-基础平台-质量技术&平台-效果广告：青絮 |\n| --- | --- |\n| **地点** | 10月29日 周二 11:00 - 12:00(GMT+8) |\n| **会议时间** | C1-211 忘忧谷（北京朝阳科技园C区） |\n| **复盘主持人** | 泽萱 |\n\n\n## 一、故障简述\n于2024年10月16日12:50分收到有关人群推广无展现客诉预警，原因确认是索引部分数据丢失导致，莲童同学通过执行新全量索引构建及日切操作，业务于13:51分恢复拿量，同时人群推广，智能场景推广，超级短视频计划进行出价参数快恢操作。故障期间累积客诉35例。\n\n**APM故障链接：**\n\n[https://trfree.alibaba-inc.com/ormEmergency/workbench/emergency/202410160000000779001](https://trfree.alibaba-inc.com/ormEmergency/workbench/emergency/202410160000000779001)\n\n\n\n## 二、故障过程回顾\n### 2.1【时间线概览】\n![画板](https://intranetproxy.alipay.com/skylark/lark/0/2024/jpeg/80256396/1730183932787-7e7d71cd-491f-4c96-8406-2ea64eff75b4.jpeg)\n\n故障发现～初因定位：130min\n\n初因定位～故障恢复：101min\n\n### 2.2【故障处理时间线】\n**2024-10-15 16:24**，开发同学 亮深 为解决线上 SN 索引脏数据问题，对展示广告 SN 单元流程 display_sn_adgroup，做清数据重跑操作，操作记录如下图操作：**——【故障引入】**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/121926/1729665540057-61bfab84-002b-44b0-9a78-052b93897161.png)发布之前做过前置标准操作流程：1) 离线流量由张北切换到南通；\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/121926/1729665849934-c0dac3c7-0c22-4f94-a248-b5bfb5247954.png)2) 暂停单元小时数据导出任务，避免清理数据对算法离线流程影响。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/121926/1729666103250-a0a03404-972c-4265-a157-df7afc75a8f1.png)\n\n2024-10-15 17:10，unibs（索引构建系统） 开始定时构建全量索引，单元流程此时还未完成，单元数据不完整；\n\n2024-10-15 17:37，对展示广告 SN 单元流程 display_sn_adgroup，清数据重跑操作完成；\n\n2024-10-15 18:25，全量索引构建成功，如下图所示，全量索引大小在 155G，较前一份全量索引大小下降至少 10%以上，索引构建行； 索引数据减少的数据规模符合行数校验大小，索引构建通过；\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/121926/1729666556126-6c70d09a-0737-42e7-8ae6-15c1f07ba019.png)\n\n2024-10-16 04:00，全量索引开始周期调度，此时单元数据无缺失，索引大小增长较大，达到 190G 以上，超过索引校验上限 20%以上，索引构建失败；\n\n2024-10-16 05:00，小时索引开始构建，依赖上一次成功的全量索引版本(2024 10-15 17 点版本)此时全量索引数据有缺失，导致增量索引也缺失；\n\n2024-10-16 06:00，展示广告 SN 开始进行索引日切，切换的是丢失部分数据的索引",
    "chunk_order_index": 0,
    "full_doc_id": "doc-2082e59ed308321f2e38eda55cfbd24e"
  },
  "chunk-420b7b788e74dba915f276b85b1883cd": {
    "tokens": 1200,
    "content": "索引构建失败；\n\n2024-10-16 05:00，小时索引开始构建，依赖上一次成功的全量索引版本(2024 10-15 17 点版本)此时全量索引数据有缺失，导致增量索引也缺失；\n\n2024-10-16 06:00，展示广告 SN 开始进行索引日切，切换的是丢失部分数据的索引版本；\n\n2024-10-16 08:00，展示广告各机房日切陆续完成；\n\n**2024-10-16 10:00**，陆续有产品运营同学反馈有超级短视频无展示的异常case，引擎同学开始介入排查，先订正部分客诉单元，订正的客诉单元拿量开始恢复；**——【故障发现】【业务响应】**\n\n**2024-10-16 10:08**，客服团队收到有关无界人群推广无展现的客诉达到3例；**——【故障发生】**\n\n2024-10-16 11:30，展示引擎同学开始拉会一起排查索引缺失的问题；\n\n**2024-10-16 12:10**，离线同学排查到切换索引大小存在异常，开始手动进行全量索引构建；**——【初因定位】【恢复执行】**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/121926/1729668226798-ea76d4de-0443-43e2-9fa2-985408c719ff.png)\n\n2024-10-16 12:50，收到有关人群推广无展现的客诉预警单；\n\n2024-10-16 12:51，深舟接手预警单并介入排查；\n\n2024-10-16 13:22，基本定位到索引缺失的原因，离线引擎同学开始协调索引切换以及根据出价异常 SOP 进行出价参数回滚操作，分别协调：人群 BCB(亦理) ，智能场景 BCB(涯岸)，超级短视频(问津)进行参数重置，防爆量。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/121926/1729668732935-8b81166b-8c2a-487b-9173-bb6bacc98d09.png)\n\n2024-10-16 13:36，莲童开始进行第一批索引切换，同时人群 BCB 计划，智能场景 BCB 计划开始进行参数重置/快恢，出价参数开始恢复到昨天相同时间段参数。\n\n**2024-10-16 13:51**，第一批索引切换成功，拿量异常计划开始起量；**——【故障恢复】**\n\n2024-10-16 13:55，超级短视频开始进行参数重置, 跟在线流量接流未严格一致，导致部分计划的爆量。\n\n2024-10-16 14:00，人群推广算法亦理和数据引擎同学操作人群 BCB 计划参数重置时，触发 WS 平台 bug, 预期生效 100%计划，实际生效 1%，重新发布后参数重置成功。此时出现人群 BCB 部分计划的爆量。\n\n2024-10-16 14:39，收到超级短视频集中消耗的客诉预警单；\n\n2024-10-16 14:56，收到人群推广集中消耗的客诉预警单；\n\n2024-10-16 15:07，第一批 25%流量生效后，出价链路观察第一个整点出价表现平稳，开始进行第二批 25%流量切换；\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/121926/1729669494900-bfc09ff1-6226-4db6-8ce3-65e1553f027f.png)\n\n2024-10-16 15:31，前三批机器流量切换完毕，第四批机器处于断流状态，因此开始执行人群 BCB 和智能 BCB 参数重置回滚操作；\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/121926/1729669534895-c7440a1c-4d6d-4d36-a7a2-25f2bc0b5c97.png)\n\n**2024-10-16 15:47**，全部机器切换到新索引。**——【影响消除】**\n\n## 三、影响产品线&影响面\n    - [x] 是否有客诉量：\n        * 故障期间累计客诉量：35例（去重后）\n\n[10.16人群推广无展现.xlsx](https://yuque.antfin.com/attachments/lark/0/2024/xlsx/147156506/1731031225107-9d914911-e3d2-41c5-b0c6-393563b0cf4b.xlsx)\n\n    - [ ] 是否产生资损：\n        * 无\n\n## 四、故障原因\n### 4.",
    "chunk_order_index": 1,
    "full_doc_id": "doc-2082e59ed308321f2e38eda55cfbd24e"
  },
  "chunk-f34a1900297e33106c46f2aa81d60e44": {
    "tokens": 1200,
    "content": "量：35例（去重后）\n\n[10.16人群推广无展现.xlsx](https://yuque.antfin.com/attachments/lark/0/2024/xlsx/147156506/1731031225107-9d914911-e3d2-41c5-b0c6-393563b0cf4b.xlsx)\n\n    - [ ] 是否产生资损：\n        * 无\n\n## 四、故障原因\n### 4.1【一句话原因】\n10.15日16点30分-17点37分，展示单元表清理数据重跑，17点10分定向全量索引构建，导致10%单元数据丢失，16日日切后导致部分计划拿不到量。\n\n### 4.2【详细原因】\n索引构建依赖lindorm 源数据进行清理，索引构建行数校验配置较为宽泛，数据部分丢失的情况下未卡住索引构建。\n\n![画板](https://intranetproxy.alipay.com/skylark/lark/0/2024/jpeg/121926/1729670165641-858fa533-ab70-43aa-a4bc-b74b30a1398f.jpeg)\n\n\n\n## 五、关注点讨论\n#### 1、问题引入阶段\n【在/离线变更代码开发完成后，需要经过**code review**确认无误后进行合并**代码主干**提交】--红线点\n【在线变更代码修改提交必须经过**功能单测；**离线变更代码修改完成后，生成的离线数据必须要经过**数据校验**】--红线点\n\n**〖关注点1〗**是否有经过CR？是否有经过单测？是否有经过测试？是否自动化测试可覆盖？测试阶段为何没发现？——不涉及\n [原因分析]不涉及\n ACTION：\n暂无  \n\n【生产变更，**务必要经过灰度发布**，灰度发布时间**间隔大于20min****】**--红线点\n\n**〖关注点2〗**是否变更窗口期进行发布？是否经过灰度？分机房或分批发布第一批发布时间间隔是否大于20分钟？灰度过程中为何未发现问题？\n请提供ChangeFree变更单链接：[https://aicf.alibaba-inc.com/aicf/change/v2/detail/1300038110?spm=goc-apm.aicf-_changeList.0.0.2cff2388mQemSc](https://aicf.alibaba-inc.com/aicf/change/v2/detail/1300038110?spm=goc-apm.aicf-_changeList.0.0.2cff2388mQemSc)\n\n [原因分析]是变更窗口期发布，重跑数据未进行数据内容的更改，不涉及灰度。\n ACTION：\n\n暂无\n\n\n\n**【****黄金眼指标观察**，10分钟左右，观察已发布**本机房、核心pid、分广告主体类型**的黄金眼业务指标】--红线点\n\n**【****变更改动点验证**，验证已变更的**功能逻辑&数据已经生效**(最好有直接或间接生效截图记录)**】**--红线点\n\n**〖关注点3〗**是否进行黄金眼指标观察，观察是否发现问题？是否验证变更改动点，验证是否发现问题？\n\n请提供观测链接：不涉及黄金眼指标观察\n [原因分析]通过执行切流操作，确保实时消息正常产出，本次数据重跑未发现问题。确保数据正常跑完，后续任务正常调度。缺少手动校验索引数据完整性。\n\n ACTION：\n\n数据重跑后手动触发全量索引构建（SN、MS、CRS、SCS），补充至团队内部变更发布流程中并进行宣讲。——负责人：克时，预计：11.15，验收人：亮深\n\n#### 2、故障应急阶段\n**〖关注点4〗**是否有监控发现？若没有，为什么？（监控缺失/报警太多未及时处理/。。） \n请提供监控报警链接：非监控发现\n[原因分析]索引构建失败监控有钉钉监控报警，但未关注。\n ACTION：\n核心索引构建失败的监控报警方式调整为电话报警，将离线、在线相关团队同学都邀请至报警群，确保问题发生后及时发现并定位到原因。——负责人：明生，预计：12.31，验收人：应灵、潇劼\n建设有关生产索引构建失败率相关的报表，提供给在线、离线团队同学观察使用。——负责人：明生，预计：03.31，验收人：画沙、亮深\n索引下某个周期内（连续7天内）持续没有构建后就进行biz下线的清理操作（前端有关联关系的接口，biz是否在线使用）；——负责人：应灵、明生，预计：12.31，验收人：亮深、画沙  \n  \n**〖关注点5〗**相关角色的应急响应是否有改进空间？故障恢复方式是什么？是否可优化\n[原因分析]暂无，故障恢复方式是执行新全量索引构建及日切操作。\n ACTION：\n梳理出参数回滚后需要观察",
    "chunk_order_index": 2,
    "full_doc_id": "doc-2082e59ed308321f2e38eda55cfbd24e"
  },
  "chunk-51f9410a7c90996091c3c2fbab1220c3": {
    "tokens": 1200,
    "content": "关系的接口，biz是否在线使用）；——负责人：应灵、明生，预计：12.31，验收人：亮深、画沙  \n  \n**〖关注点5〗**相关角色的应急响应是否有改进空间？故障恢复方式是什么？是否可优化\n[原因分析]暂无，故障恢复方式是执行新全量索引构建及日切操作。\n ACTION：\n梳理出参数回滚后需要观察的相关监控和具体内容，以及参数回滚操作和在线接流时间点确保一致的要求都补充至出价参数回滚SOP中。——负责人：念刃，预计：11.15，验收人：奕理、留泊、方函、问津\nWS平台修复代码bug。——负责人：撇捺，已完成\n对于AIS认为广告可投，引擎判断状态为不可投，可以通过参数上限的控制，参竞日志等方面进行评估，制定出具体方案。（不记为故障action，后续亮深、念刃与算法团队对焦）\n\n\n**〖关注点6〗****此次故障是否触发广告技术部安全生产中的红线点？**\n\n- [ ] 是，团队： \n\n- [x] 否\n\n## 六、后续Action\n| **序号** | *******Action标题** | **Action描述** | *******负责人** | *******计划完成时间** | **验收标准** | **验收人** | **是否keyAction** | **是否回血Action** |\n| :---: | --- | --- | :---: | :---: | --- | :---: | :---: | :---: |\n| 1 | 短期：调整索引校验规则 | 所有物料相关的索引表都需要调整校验规则的上下限（可参考下限调整为5%，上限调整为10%）。 | 画沙 | 11.15 | 确保索引校验规则调整的更为合理化。 | 亮深 | 是 | - |\n| 2 | 短期：补充变更规范并进行宣讲 | 数据重跑后手动触发全量索引构建（SN、MS、CRS、SCS），补充至引擎数据工程团队内部变更发布流程中并进行宣讲。 | 克时 | 11.15 | 确保变更规范补充完整且在团队内部进行宣讲。 | 亮深 | 否 | - |\n| 3 | 长期：调整监控报警方式 | 核心索引构建失败的监控报警方式调整为电话报警，将离线、在线相关团队同学都邀请至报警群，确保问题发生后及时发现并定位到原因。 | 明生 | 12.31 | 确保核心监控报警能及时通过电话报警发现。 | 应灵潇劼 | 是 | - |\n| 4 | 短期：建设索引相关报表 | 建设有关生产索引构建失败率等维度相关的报表，提供给在线、离线团队同学观察使用。 | 明生 | 03.31 | 确保新增有关索引构建失败率维度的数据报表。 | 画沙亮深 | 否 | -- |\n| 5 | 长期：新增biz清理机制 | 索引下某个周期内（连续7天内）持续没有构建后就进行biz下线的清理操作。 | 应灵明生 | 12.31 | 确保biz清理机制正常运行。 | 亮深画沙 | 否 | - |\n| 6 | 短期：完善出价参数回滚SOP | 梳理出参数回滚后需要观察的相关监控和具体内容，以及参数回滚操作和在线接流时间点确保一致的要求都补充至出价参数回滚SOP中。 | 念刃 | 11.15 | 确保出价参数回滚sop相关流程补充完毕，并同步至算法同学。 | 奕理留泊方函问津 | 否 | - |\n| 7 | 短期：代码修复 | WS（whaleshark）平台修复代码bug。 | 撇捺 | 已完成 | - | - | - | - |\n| 8 | 长期：新增databus全量任务状态校验规则 | databus 和 unibs 联动，索引构建开始时校验 databus 全量任务的状态。 | 明生海蝎 | 03.31 | 确保索引构建前进行databus全量索引任务的状态校验。 | 亮深 | - | - |\n| 9 | 长期：优化展示广告单元退出流程 | 展示广告单元退出流程优化，避免新加字段的索引异常。 | 曦诚 | 12.02 | 确保展示广告单元退出流程得到优化。 | 亮深 | - | - |\n\n\n\n\n## 七、故障相关方\n【故障等级】P5\n\n| **  系统质量（30%）** | | | | | **处置能力（70%）** |\n| :---: | --- | --- | --- | --- | :---: |\n| **相关方** | **需求设计** | **代码质量** | **变更质量** | **",
    "chunk_order_index": 3,
    "full_doc_id": "doc-2082e59ed308321f2e38eda55cfbd24e"
  },
  "chunk-d82631ce63cdb101cb0ecda75bcee9d6": {
    "tokens": 201,
    "content": "广告单元退出流程得到优化。 | 亮深 | - | - |\n\n\n\n\n## 七、故障相关方\n【故障等级】P5\n\n| **  系统质量（30%）** | | | | | **处置能力（70%）** |\n| :---: | --- | --- | --- | --- | :---: |\n| **相关方** | **需求设计** | **代码质量** | **变更质量** | **自定义项** | **发生时间** | **发现时间（30%）** | **恢复时间（40%）** |\n| 淘天集团-用户平台&阿里妈妈事业部-阿里妈妈-广告技术部-工程技术-引擎平台-引擎数据工程 | 不涉及 | 不涉及 | 是 |  | 10-16 10:08 | 10-16 10:00 | 10-16 13:51 |",
    "chunk_order_index": 4,
    "full_doc_id": "doc-2082e59ed308321f2e38eda55cfbd24e"
  },
  "chunk-c0421a61b1cc9782997b8a1a5395bb39": {
    "tokens": 1200,
    "content": "**一、故障简述**\n20:20分左右，批量用户已付款订单显示待付款，原因为单链路压测，混部单元付款回调域名cname到中心，压测两个混部场景下，流量大于付款回调限流，触发付款回调限流，导致淘宝订单推进支付成功状态延长，于20:29压测停止后恢复，客诉量级触达P4故障。\n\n**二、故障过程回顾**\n\n| **时间轴**  | **事件**  |\n| --- | --- |\n| 2024-09-26 20:20  | 交易链路单元压测验证定金链路起流量  |\n| 2024-09-26 20:24  | **【故障发现】【故障响应】** 蚂蚁GOC监控告警，开始应急  |\n| 2024-09-26 20:26  | **【故障发生】** 确认是淘天支付回调域名异常，开始拉广陌和芳亭，同时订单状态不一致，客诉量触达P4；  |\n| 2024-09-26 20:27  | 迹航进入排查  |\n| 2024-09-26 20:28  | **【初因定位】【恢复执行】** 定位到回调有限流，判断大概率是压测导致，通知先停止压测，止血后再排查原因  |\n| 2024-09-26 20:29  | **【故障恢复】** 压测停止  |\n| 2024-09-26 20:31  | VOC风险预警：订单显示待付款，淘系GOC拉起应急 ![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/12771/1728699695839-f50a6e28-ca24-41f0-bf1b-b0a0a5cd2da5.png?x-oss-process=image%2Fformat%2Cwebp%2Fresize%2Cw_728%2Climit_0) |\n| 2024-09-26 20:34  | 群内同步：压测导致支付回调变慢，判断同蚂蚁群内问题为同一原因  |\n| 2024-09-26 21:01  | **【根因定位】** 确认问题原因为：une1和25g，都cname到中心了，流量都到中心，触发中心回调限流 ![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/12771/1728748207308-986f04fa-0cc1-49c8-a88b-709fafb32e92.png?x-oss-process=image%2Fformat%2Cwebp%2Fresize%2Cw_1500%2Climit_0) |\n\n\n\n\n**三、故障原因**\n**3.1【背景说明】**\n之前不切流压测前需要把对应单元的dns切换到正确的单元，如果压测前忘了切换，那么就会全部打到中心环境。在这种情况下，去年（2023 3月份左右）做了改造，压测流量会走到压测的域名，从而减少了手动切换导致的复杂。  \n**3.2【原因分析】**\n**一句话原因：**\n交易单链路不切流压测，une1压测8w笔创单，unzmbix25g压测5w笔创单，定金期间，8w笔的压测流量**打到了线上的center单元**，导致verified_host发生了限流阻断，影响了线上流量的支付回调，导致支付宝的支付回调成功率下跌。  \n**详细原因：**\n支付回调是在创单的时候确定的，在请求到支付宝的notify_url参数里。在tp3中，如果是线上流量，则会根据用户所在的单元，拼出url，比如unzbmix25g.tcgw.taobao.com。**由于本次压测是不切流压测**，这个域名默认是cname到了中心的单元（unzbmix25g.tcgw.taobao.com->tcgw.taobao.com->center的vip）。当压测流量过来时，如果使用了线上的域名，那么就会把流量打到中心单元，就会导致这个问题。之前都是手动把对应单元的dns切换到正确的单元。  \n为了解决这个问题，2023年3月份在tp3里做了压测改造，如果是压测流量，则会把域名改为press.unzbmix25g.tcgw.taobao.com，这个是会到对应的unzbmix25g的vip，**避免了域名切换的步骤带来的压测复杂性**。但是当时改造只做了现货场景的改造，预售的定金和尾款支付（改价）都没有改造，所以本次定金场景的压测时候，支付回调又返回到了中心机房，导致了这个问题。  \n\n\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/320588/1727437542417-2cd4bb",
    "chunk_order_index": 0,
    "full_doc_id": "doc-0f1aa48617fee809539afc53a1ae5a71"
  },
  "chunk-2dee11d7848bcc0fb64c36d629311b48": {
    "tokens": 808,
    "content": "性**。但是当时改造只做了现货场景的改造，预售的定金和尾款支付（改价）都没有改造，所以本次定金场景的压测时候，支付回调又返回到了中心机房，导致了这个问题。  \n\n\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/320588/1727437542417-2cd4bb7a-954a-4f49-bed8-9f90ee57a165.png?x-oss-process=image%2Fformat%2Cwebp%2Fresize%2Cw_1350%2Climit_0)\n\n\n\n\n\n\n**四、故障关注点**\n**1、关于原因**\n**〖关注点1〗**** 之前压测为何没有发现问题？去年双11为何未有异常？是否有其它链路有遗漏**\n**〖问题总结〗**  \n** 之前压测未发现，主要有2个原因：**  \n  1）先前的压测模型不一定包含预售。这个问题在现货模型里不会有，只有预售模型里会有转发回到中心的问题，除了双11之类的有预售的大促，其他的模型不会包含预售场景。\n  2)量级原因。9.26的压测是总计13w的流量（Unzbmix25g混布单元5w笔和Une1混布单元8w），以前的压测没有这么大的流量（基本是3w，4w左右）。当流量小的时候，中心是能抗住这部分转发流量。  \n** 链路梳理：**已经统一梳理过，确定只是遗漏现货+预售场景  \n**〖改进点〗**对预售链路进行单链路压测改造 11.12日  [@迹航](https://aliyuque.antfin.com/zhenghang.wzh)\n\n\n**2、变更过程**\n**〖关注点1〗**** 压测改造后是否有办法验证？当时怎么验证的？。**\n**〖问题总结〗**主要是场景评估遗漏，只考虑到现货场景，所以验证的时候未验证到预售+现货场景。  \n**〖改进点〗**暂无\n\n**3、应急处置**\n**〖关注点1〗****整个交易侧问题发现为用户反馈，订单支付状态异常业务场景是否可直接/间接 监控？？**\n**〖问题总结〗**未技术监控主动发现的原因为限流未配置告紧。  \n**〖改进点〗** 添加限流的报警，能够及时发现问题。 --done  [@迹航](https://aliyuque.antfin.com/zhenghang.wzh)\n\n\n**五、故障Action**\n\n| **序号**  | **Action类型**  | *******Action**  | *******负责人**  | *******计划完成时间**  | **验收标准**  | **是否keyAction**  | **是否回血Action**  |\n| --- | --- | --- | --- | --- | --- | --- | --- |\n| 1  | 编码类  | 对预售链路进行单链路压测改造  | 迹航  | 11.12  | 改造完成  | 否  | 否  |\n| 2  | 监控类  | 添加支付回调限流报警  | 迹航  | 9.31  | 监控优化完成  | 否  | 否  |",
    "chunk_order_index": 1,
    "full_doc_id": "doc-0f1aa48617fee809539afc53a1ae5a71"
  },
  "chunk-c754e1a6b80d61cb68463774a6c65ac8": {
    "tokens": 1200,
    "content": "## 一、故障简述\n2024-10-10 18:18，批量用户反馈88VIP红包用不了，客诉反馈量40+，触达P4，于18:21通过回滚开关止血。同时影响天猫淘宝海外_手淘跨境前置支付功能，触达P3故障。故障原因为下单2.0准入配置switch值修改，配置顺序错乱导致优先匹配到低版本的配置，低版本配置中没有携带下单2.0一些必要的profile，导致功能缺失。\n\n## 二、故障过程回顾\n| **时间轴** | **海外** | **手淘** |\n| --- | --- | --- |\n| **2024-10-10 16:10** | **** | aone推送开关，aone平台提示http组件调用IO异常![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/17356624/1728980895804-13e94f2d-7a92-415a-b065-6c7a7f72bf89.png)拉aone和switch的人排查，swith侧分析原因是该开关值过大，aone从switch中获取的时候超时了，解决方案是通过swithc紧急发布流程，不走aone发布 |\n| 2024-10-10 17:50 | **** | switch平台打开buy2 switch紧急推送入口![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/17356624/1728981014578-97a21006-0b4e-4ef6-b39a-8b447b2d7af0.png) |\n| 2024-10-10 18:02 |  | 线上环境通过switch平台紧急发布推送**【故障注入】** |\n| 2024-10-10 18:03 | 海外前置支付创单成功量开始下跌，下跌超60%![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/116556437/1728701397360-bafb230e-8c4d-4a82-8cf5-4c2db802c211.png) | **** |\n| 2024-10-10 18:04 |  | 交易IOS端降级H5告警![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/12771/1729069411128-c8ccbe68-1757-4c01-bac1-824ceac909cd.png) |\n| 2024-10-10 18:06 | 海外收银支付创单触发告警**【故障发现】**![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/289266/1728702364656-cd0bd95c-d1f1-417e-8bad-4c5a4678b8c4.png) |  |\n| 2024-10-10 18:07 | 海外技术介入排查**【业务响应】** |  |\n| 2024-10-10 18:09 | 线上会议拉起报警是HKD下跌，因此第一时间与与IPAY同学联系，小锋 拉起线上会议![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/289266/1728972658081-73fbda44-83ef-4f78-b762-523585ff7263.png) |  |\n| 2024-10-10 18:12~18:14 | 相关监控报警均无成功率及系统的报错，怀疑是入口流量下跌，海外技术新庭线上复现发现是下单页降级到H5，导致海外支付组件不展示，最终成功量下跌；将手淘侧相关同学拉入会议 | 手淘侧同学麟空、怀宇、伏天入会 |\n| 2024-10-10 18:18 | 触达P3**【故障发生】** | 88VIP红包用不了风险预警，大虫拉群排查；**【故障发现】【故障发生】**![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/12771/1728988197863-b9e2c09e-e129-469c-abec-7d1ea61cf9fd.png) |\n| 2024-10-10 18:20 |  | 「交易」初步怀疑和开关同送相关，通过switch平台紧急发布回滚**【执行恢复】**「会员」拉孜于、立行协助排查 |\n| 2024-10-10 18:22 | 观察到回滚后海外监控恢复正常**【故障恢复】**![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/116556437/1728701470465-2429f9c0-f963-4d31-8b96-056d529a1fd8.png) |  |\n| 2024-10-10 18:25 |  | 排查发现现在线上都是正常的，无法复现 |\n| 2024-10",
    "chunk_order_index": 0,
    "full_doc_id": "doc-08bd81f8124d0a42800d336f4b8875cb"
  },
  "chunk-13995f6d87c190944d6d7017597b0407": {
    "tokens": 1200,
    "content": "障恢复】**![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/116556437/1728701470465-2429f9c0-f963-4d31-8b96-056d529a1fd8.png) |  |\n| 2024-10-10 18:25 |  | 排查发现现在线上都是正常的，无法复现 |\n| 2024-10-10 18:36 |  | 立行定位到红包不可用原因，needSplitThreshold**【原因定位】**![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/12771/1728997694287-dd0b443d-d30a-45a5-8823-1d02f40a0ca8.png) |\n\n\n## 三、故障原因\n### 3.1【背景说明】\n:::tips\n手淘H5支持下单2.0，需要放开H5的ttid准入下单2.0，需要修改newBuy2StageConfigTailNum switch开关\n\n:::\n\n### 3.2【原因分析】\n#### 一句话原因：\n:::tips\n下单2.0准入配置switch值修改，配置顺序错乱导致优先匹配到低版本的配置，低版本配置中没有携带下单2.0一些必要的profile，导致功能缺失\n\n:::\n\n![画板](https://intranetproxy.alipay.com/skylark/lark/0/2024/jpeg/12771/1729002004652-57610133-302d-4e73-ba14-8e09e51fdb37.jpeg)\n\n说明：profile的值有： profile_stage_2、profile_stage_3、profile_stage_4、newContainer、eticket\n\n#### 详细原因：\n:::tips\n+ 在推送newBuy2StageConfigTailNum开关的时候，grayAppList的顺序发生错乱\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/17356624/1728562041443-1b0e9b4f-020b-4b2f-969c-16b3da59bc11.png)\n\n+ _匹配的逻辑_\n\n获取当前请求的ttid，从List第一位根据app+系统+版本号匹配到**第一条**，然后取后面的profile值\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/17356624/1729063389629-c9b1004c-f60b-4e98-a8a3-d9c16424c130.png)\n\n比如说安卓10.8.40的版本匹配的灰度条件发生了变化，匹配后返回的profiles中缺少了**profile_stage_3,profile_stage_4,newContainer,eticket**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/17356624/1728563778122-e50c2f0c-08cb-47d5-89f8-58a0afe6bb3c.png)。 ![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/17356624/1728563868080-6cdc5e08-f985-4266-b651-e214f2bed28d.png)\n\n+ 海外场景依赖profile_stage_4，天天红包场景依赖newContainer，导致功能出现问题\n\n:::\n\n## 四、故障关注点\n#### 1、关于原因\n**〖关注点1〗****为什么开关值会乱序？**\n\n:::tips\n**〖问题总结〗主要是因为发开关值格式化过程中导致顺序重排：**\n\n在紧急发布switch时，填入开关值，显示Show more， 以为是被截断了，到[mobius平台的json对比工具](https://mobius.alibaba-inc.com/#/CompareCollection)中进行了格式化，格式化的时候工具重新排了序\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/17356624/1728564947758-bb8ebc4d-885b-4f5a-84be-ed329ef4b33b.png)\n\njson对比工具会排序\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/17356624/1728578863554-422459ea-d57f-4205-8f37-c1ceb99bbb58.png)\n\n把当时线上的开关，和要推送的开关放入对比发现，diff是符合预期的，但是实际上顺序已经重排，\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/17356624/1728579029405-b6bf49b1-c5c3-4098-8fab-e7ddb3ccdbea.png)\n\n接着，把右侧已经重排过的开关直接复制到了Switch平台中，走了紧急发布\n在紧急发布的时候switch紧急发布入口没有展示开关diff对比，没有机会识别到乱序的问题。\n\n**〖改进点〗**开关值配置入口开关值展示全**.       **[@修竺](undefined/huangzicheng.hzc)**     11.30 **\n\n::",
    "chunk_order_index": 1,
    "full_doc_id": "doc-08bd81f8124d0a42800d336f4b8875cb"
  },
  "chunk-824b18034162d1d81bdfc038e22c2fd4": {
    "tokens": 1200,
    "content": "3ccdbea.png)\n\n接着，把右侧已经重排过的开关直接复制到了Switch平台中，走了紧急发布\n在紧急发布的时候switch紧急发布入口没有展示开关diff对比，没有机会识别到乱序的问题。\n\n**〖改进点〗**开关值配置入口开关值展示全**.       **[@修竺](undefined/huangzicheng.hzc)**     11.30 **\n\n:::\n\n\n\n**〖关注点2〗****开关设计方式是否合理，是否可以不依赖顺序，而是代码内部做判断？**\n\n:::tips\n**〖问题总结〗**最开始设计的时候开关和顺序无关，后续逐渐迭代强依赖顺序\n\n**〖改进点〗**\n\n+  开关去顺序依赖            [@宸远](undefined/zhanglongbin.zlb)     11.30\n+ ** **开关拆分小于10KB ** **[@宸远](undefined/zhanglongbin.zlb)** ** 11.30\n\n:::\n\n\n\n**〖关注点3〗****当前超时设置是怎样的，是否合理？为何未采取调整超时时间解决？**\n\n:::tips\n**〖问题总结〗**拉switch 10s 超时，但是该 key 太大，预计需要拉 20s。改变超时时间需要多个系统联合发布，短时间内难以完成，另外，switch 不适合存储大配置，建议拆分\n\n**〖改进点〗**同上，开关值拆分\n\n:::\n\n\n\n#### 2、变更过程\n**〖关注点1〗****为什么用紧急发布一批推送，未经过灰度阶段？**\n\n:::tips\n**〖问题总结〗**一开始通过aone正常流程推送开关，aone工单，提示http组件调用IO异常![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/17356624/1728877967499-ec8e2b23-32f0-4f39-9745-7db1b271b847.png)\n\n重试多次都未成功，拉aone和switch的人排查，switch侧分析原因是该开关值过大，spe从switch中获取的时候超时了，解决方案是通过swich紧急发布流程，未走aone发布。\n\n当前switch紧急发布流程当前不支持分批线上生效，因此线上是一次性全部生效。\n\n**〖改进点〗**\n\n+ ** **紧急发布入口新增不支持灰度提示       [@修竺](undefined/huangzicheng.hzc)         11.30\n+  紧急发布入口接入CF执行单               [@修竺](undefined/huangzicheng.hzc)         11.30\n\n:::\n\n\n\n#### 3、应急处置\n**〖关注点1〗****海外从18:03分发现异常到18:14分联系到交易，这个过程是否可以缩短？同样手淘端是否可以主动判断到对88VIP会员的影响，做到信息互通？**\n\n:::tips\n**〖问题总结〗**\n\n**海外：**\n\n+ 海外这边03分开始下跌，04分触发预警，06分预警发出，sunfire平台发出预警的时间会有1-2分钟延迟，属于正常情况；\n+ 报警是最开始报的就是HKD成功量下跌，所以第一时间联系的就是下游IPAY侧，且链路本身排查也有一定的复杂性（涉及交易、支付、IPAY）\n\n [https://x.alibaba-inc.com/custom/17/product/preview/spm/4095?crossTenant=true](https://x.alibaba-inc.com/custom/17/product/preview/spm/4095?crossTenant=true)![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/116556437/1729061344586-7b536365-2768-4dc5-9f16-736db78075fe.png)\n\n**交易：**\n\n+ 88VIP应急的过程中，主要是营销的同学在排查，不知道88VIP也已有问题\n\n**〖改进点〗** 后续应急第一时间邀请交易同学共同排查     ---长期\n\n:::\n\n\n\n**〖关注点2〗****故障恢复的时候，88VIP客诉预警，是否可以做到系统层面主动发现？**\n\n:::tips\n**〖问题总结〗**88VIP本身无法监控，因为红包影响的是下单。交易当前未对下单进行细分监控，后边可以考虑加上，但是担心误报率会比较高（88VIP会员每天只有1次使用2元红包的机会，量不会很大）。\n\n**〖改进点〗 **交易增加监控观察。** **[@隆璟](undefined/wangguolong.wgl)** **11.30\n\n:::\n\n## 五、故障Action\n| **序号** | **Action类型** | *******Action** | *******负责人** | *******计划完成时间** | **验收标准** | **是否keyAction** | **是否回血Action** |\n| --- | --- | --- | --- | --- | --- | --- | --- |\n| 1 | 平台优化 | 开关值配置入口开关值展示全 | 修竺 | 11.30 | 开",
    "chunk_order_index": 2,
    "full_doc_id": "doc-08bd81f8124d0a42800d336f4b8875cb"
  },
  "chunk-e5cae696d896a5e486c17d732a3ad36c": {
    "tokens": 325,
    "content": ":\n\n## 五、故障Action\n| **序号** | **Action类型** | *******Action** | *******负责人** | *******计划完成时间** | **验收标准** | **是否keyAction** | **是否回血Action** |\n| --- | --- | --- | --- | --- | --- | --- | --- |\n| 1 | 平台优化 | 开关值配置入口开关值展示全 | 修竺 | 11.30 | 开关值配置入口开关值展示全 | 否 | 否 |\n| 2 | 平台优化 | Switch紧急发布入口不支持灰度提示 | 修竺 | 11.30 | Switch紧急发布入口不支持灰度提示 | 否 | 否 |\n| 3 | 平台优化 | 紧急发布入口接入CF执行单       | 修竺 | 11.30 | 接入完成 | 否 | 否 |\n| 4 | 代码类 | 开关去顺序依赖   | 宸远 | 11.30 | 开关去顺序依赖   | 否 | 否 |\n| 5 | 代码类 | 开关拆分小于10KB | 宸远 | 11.30 | 开关拆分小于10KB | 否 | 否 |\n| 6 | 监控类 | 交易增加88VIP红包下单监控 | 隆璟 | 11.30 | 监控增加完成 | 否 | 否 |\n\n\n##",
    "chunk_order_index": 3,
    "full_doc_id": "doc-08bd81f8124d0a42800d336f4b8875cb"
  },
  "chunk-b3c5905dee74893450625f0501e8817b": {
    "tokens": 1200,
    "content": "_**锁定会议开始，宣导复盘文化**_\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/9827/1659103353652-0274c8cd-7318-4cd9-b730-0d66221680b6.png)\n\n_**内容涉及公司B3级别以上机密数据，请注意保密！**_\n\n| **故障链接** | [https://tr.alibaba-inc.com/ormEmergency/workbench/emergency/202410120000000086001](https://tr.alibaba-inc.com/ormEmergency/workbench/emergency/202410120000000086001) |\n| --- | --- |\n| **复盘时间** | 2024/10/17 周四 10:00-11:00 |\n| **复盘地点** | C3-6-05-N 小镜湖 |\n| **参与人** | 研发：潇洛、广侯、哲欤、行壹、程飚、 子昊 、六观SRE：潇客、王双GOC：乐尽、徙南、吟峰云GOC：踱步、舟雪 |\n| **主持人** | 乐尽 |\n\n\n## 一、故障简述\n【P3】2024-10-12 凌晨2:40TRE核心节点最近10分钟内宕机节点数超100，故障等级触达P3，凌晨3:17确认故障原因为乌兰灵骏相关的CEN变更导致，通过变更回滚恢复，于凌晨3:22潇洛反馈所有宕机节点均已恢复正常，故障恢复，请知晓。\n\n## 二、故障过程回顾\n### 2.1【故障处理时间线】\n| **时间轴** | **事件** |\n| --- | --- |\n| 2024-10-12  凌晨 1:50 - 1:56 | 乌兰 灵骏vpd上下云流量从HGW切换至SNA（切完后HGW流量会清空） 变更无异常\t[https://acn.alibaba-inc.com/web/cc/OrderDetail?order_id=10558](https://acn.alibaba-inc.com/web/cc/OrderDetail?order_id=10558)\t流量从cn-wulanchabu-a-na130-h200切换至cn-wulan-a-na130-sna-h102CM链接：[https://bg.aliyun-inc.com/#/change-approval/detail?bgVid=BG2024100906S1RNFEE](https://bg.aliyun-inc.com/#/change-approval/detail?bgVid=BG2024100906S1RNFEE) |\n| 2024-10-12  凌晨 2:06 - 2:12 | 乌兰 集团业务之前切流后的残余cen策略清除 --- 变更触发异常\t[https://acn.alibaba-inc.com/web/cc/OrderDetail?order_id=10562](https://acn.alibaba-inc.com/web/cc/OrderDetail?order_id=10562)CM链接：[https://bg.aliyun-inc.com/#/change-approval/detail?bgVid=BG2024100903E1RRZW7](https://bg.aliyun-inc.com/#/change-approval/detail?bgVid=BG2024100903E1RRZW7) |\n| 2024-10-12 凌晨 2:09:30 | **【故障注入】**乌兰 集团业务之前切流后的残余cen策略清除 执行指令下发成功 |\n| 2024-10-12 凌晨02:10 | 监控 02:10 后开始断点![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/27645/1728971217486-53a47d97-e740-4eea-a674-2b4970a9e579.png) |\n| 2024-10-12 凌晨02:27 | 单机kubelet 心跳直到 02:27:08 都还正常![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/27645/1728971162666-d6dbaba3-6619-4c1b-83eb-0026b449b73d.png) |\n| 2024-10-12 凌晨02:28 | 直到 02:28:12 机器才变为 Not-Ready 继而触发宕机检测，发现\"脱网\"其中 单机 kubelet => apiserver 使用 SLB 代理，    问题机器示例：   source: 33.97.226.39dst: 11.183.216.121![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/27645/1728971544944-0910487a-0ce9-46b5-a96a-60ca7d46d752.png)触发宕机检测![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/27645/1728971255589-d29ff67a-369f-4c9d-9967-6ddf58411249.png) |\n| 2024-10-12 凌晨2:29分 | 为什么延时告警： 2:09分策略下发完成，底层路由",
    "chunk_order_index": 0,
    "full_doc_id": "doc-f426c624d187d5c7733f63b758edcbc6"
  },
  "chunk-36f57600ec01fecb30f6d91e290037a4": {
    "tokens": 1200,
    "content": ".png)触发宕机检测![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/27645/1728971255589-d29ff67a-369f-4c9d-9967-6ddf58411249.png) |\n| 2024-10-12 凌晨2:29分 | 为什么延时告警： 2:09分策略下发完成，底层路由收敛时间比较长，系统路由表里的路由在逐步减少。  2:33 路由完全收敛。GOC风险预警：核心节点宕机超过50台   |\n| 2024-10-12 凌晨2:30分 | 核心节点宕机超过100台  ![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/149256407/1728962531850-c3052c18-1e42-402e-b0c4-da57d2e227e5.png) |\n| 2024-10-12 凌晨2:32分 | **【故障发现】【故障响应】**风险预警卡片报出，GOC监控值班吟峰接手、联系oncall值班人反馈![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/149256407/1728958024488-3ca6f092-747e-4edc-bd81-cc2926a0b39c.png) |\n| 2024-10-12 凌晨2:39分 | **【故障发生】**最近10分钟内宕机节点数超50  故障等级触达P4 |\n| 2024-10-12 凌晨2:40分 | 最近10分钟内宕机节点数超100，已达到P3故障，监控值班同学发故障单并自动建群，相关研发、GOC陆续进故障应急群 |\n| 2024-10-12 凌晨2:42分 | 潇洛尝试核心节点重启恢复，初步怀疑欠费导致 |\n| 2024-10-12 凌晨2:43分 | **【故障通告】**![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/149256407/1728962695625-741a8883-6ac8-418d-871f-bc651296bdf9.png) |\n| 2024-10-12 凌晨2:58分 | 尝试登录发现可以登录，集群只是脱网，并不是宕机，开始排查网络方向 |\n| 2024-10-12 凌晨3:05分 | 排查是否有相关网络变更，定位中 |\n| 2024-10-12 凌晨 3:07 - 3:10 | 灵骏VBR所在CSW出口流量大幅下跌 ![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/34721/1728974229621-8660ac12-080e-4394-8afa-f97446f19011.png) |\n| 2024-10-12 凌晨 3:17 | **【故障定位】**【恢复执行】拉行壹进会确认乌兰存在变更，开始执行变更回滚开始回滚变更1 --- 非变更1的问题，回滚无效 触发变更1的两个步骤进行一键回滚 2024-10-12T03:17:46 ~ 2024-10-12T03:17:47 2024-10-12T03:18:20 ~ 2024-10-12T03:18:21 |\n| 2024-10-12 凌晨 3:21 | 开始回滚变更2 由于业务方反馈未恢复，触发变更2的4个步骤进行一键回滚 2024-10-12T03:21:06 ~ 2024-10-12T03:21:06 2024-10-12T03:21:12 ~ 2024-10-12T03:21:12 2024-10-12T03:21:32 ~ 2024-10-12T03:21:33 2024-10-12T03:21:58 ~ 2024-10-12T03:21:58 |\n| 2024-10-12 凌晨3:22 | **【故障恢复】**潇洛反馈机器均已恢复正常，节点正常工作 |\n\n\n\n\n### 2.2【时间线概览】\n![画板](https://intranetproxy.alipay.com/skylark/lark/0/2024/jpeg/149256407/1729129195499-d6dd2011-56fb-49dd-b758-7b5f2b9c7bf0.jpeg)\n\n## 三、故障原因\n### 3.1【背景说明】\n#### 【需求背景】\n:::tips\n变更背景：\n老版本的HGW由于性能/备件等历史问题需要下线，替换成新的SNA设备。本次操作分成以下三个变更完成，其中乌兰灵骏VPD上下云流量、集团上云业务流",
    "chunk_order_index": 1,
    "full_doc_id": "doc-f426c624d187d5c7733f63b758edcbc6"
  },
  "chunk-3f086e5a977b08922cac3a75945392ab": {
    "tokens": 1200,
    "content": "fb-49dd-b758-7b5f2b9c7bf0.jpeg)\n\n## 三、故障原因\n### 3.1【背景说明】\n#### 【需求背景】\n:::tips\n变更背景：\n老版本的HGW由于性能/备件等历史问题需要下线，替换成新的SNA设备。本次操作分成以下三个变更完成，其中乌兰灵骏VPD上下云流量、集团上云业务流量均已完成，在执行第三个变更时将 乌兰集团业务残余cen策略清除时触发异常。\n1、乌兰 灵骏vpd（灵骏网段）上下云流量从HGW切换至SNA（切完后HGW流量会清空）-- 此变更下云走SNA， 云网络9月底订正RI后上云流量走SNA\n变更时间：10.12凌晨 1:50 - 1:56 -- 变更无异常\nhttps://acn.alibaba-inc.com/web/cc/OrderDetail?order_id=10558\n\nCM链接：\n\n[https://bg.aliyun-inc.com/#/change-approval/detail?bgVid=BG2024100906S1RNFEE](https://bg.aliyun-inc.com/#/change-approval/detail?bgVid=BG2024100906S1RNFEE)\n\n2、集团上云业务流量从HGW切换至SNA -- 10月9号 已完成 -- - 变更无异常. -- 集团上云Vswitch 切新的VTB（路由表）\nhttps://acn.alibaba-inc.com/web/cc/OrderDetail?order_id=10409\nhttps://net.alibaba-inc.com/ncc-web/schedule/scheduleDetail?id=172725878088849\nhttps://net.alibaba-inc.com/ncc-web/schedule/scheduleDetail?id=172835882035240\nCM链接：\n\n[https://bg.aliyun-inc.com/#/change-approval/detail?bgVid=BG2024091201Z1MW1M6](https://bg.aliyun-inc.com/#/change-approval/detail?bgVid=BG2024091201Z1MW1M6)\n\n3、乌兰 集团业务之前切流后的残余cen策略清除 -- - 变更触发异常\n变更时间：10.12凌晨 2:06 - 2:12\nhttps://acn.alibaba-inc.com/web/cc/OrderDetail?order_id=10562\nCM链接：\n\n[https://bg.aliyun-inc.com/#/change-approval/detail?bgVid=BG2024100903E1RRZW7](https://bg.aliyun-inc.com/#/change-approval/detail?bgVid=BG2024100903E1RRZW7)\n\n:::\n\n\n\n### 3.2【原因分析】\n#### 一句话原因：\n:::tips\n一句话根因：由于早年集团乌兰灵骏vpd的业务访问公网、其他region的需求，云网络通过特殊的HACK方案，将公网流量绕行到集团乌兰云上VPC再去访问公网和弹内来满足集团的要求，本次对集团乌兰HGW切SNA变更完成后，在对云上VPC对应的残余CEN配置清除时未考虑此特殊HACK配置导致乌兰灵骏VPD业务通过CEN无法访问集团弹内，进而引起灵骏训练依赖的数据无法正常获取。\n\n:::\n\n#### 根因分析：\n:::tips\n详细原因解释：\nCGW从HGW切换到SNA后，灵骏VPD流量和集团上云流量均已切换到新的SNA，但是一条HACK路由的存在，新的SNA的转发逻辑依赖老的路由表，在老的路由表删除后走新的SNA的跨region流量黑洞。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/34721/1728960712148-f2ec6611-62cb-477d-889a-559c735fa17a.png)\n\n\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/34721/1728960718149-ca2e51b4-ca24-4395-802e-2a8b192b3a6e.png)\n\n\n\n通过此hack方案实现灵骏VPD业务通道乌兰集团上云实现访问其他region和公网。\n业务监控值班 -- 业务监控灵骏计算的节点指标\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/34721/1728906314771-88dc4bca-a3dd-4294-84f8-1e39d48b7a4b.png)\n\n1:57分切流前 可以看出来灵骏流量大概50G左右 (老的HGW流量)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/34721/1728906314534-b7725055-8552-42a0-a2c2-223043aab811.png)\n\n1:57分切流后 新集群增加幅度相当。 后续 流量一致是平稳的 (新的SNA流量)， 02:09 清理CEN垃圾配置引起问题，但此时流量并未发生明显变化\n\n![](https://intranetproxy.alipay.com/skyl",
    "chunk_order_index": 2,
    "full_doc_id": "doc-f426c624d187d5c7733f63b758edcbc6"
  },
  "chunk-54d46256989c803915894d9d321ff7a1": {
    "tokens": 1200,
    "content": "34721/1728906314534-b7725055-8552-42a0-a2c2-223043aab811.png)\n\n1:57分切流后 新集群增加幅度相当。 后续 流量一致是平稳的 (新的SNA流量)， 02:09 清理CEN垃圾配置引起问题，但此时流量并未发生明显变化\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/34721/1728906314571-329091a0-0ab1-42c8-a0c8-89ee4205470a.png)\n\n猜测： 理论不影响数据拉取等大流量业务，可能影响乌兰灵骏VPD到其他region集团上云的控制指令、监控等管控业务\n集团反馈： 乌兰VPD训练的结果或者checkpoint(此部分数据可能存下一阶段训练的输入)，需要定期通过跨region存储在南通等地方。故间接影响集团乌兰VPD的训练任务。\n简要处理过程：\n10.12凌晨 1:50 - 1:56\n1. 乌兰 灵骏vpd上下云流量从HGW切换至SNA（切完后HGW流量会清空） 变更无异常\nhttps://acn.alibaba-inc.com/web/cc/OrderDetail?order_id=10558\n流量从cn-wulanchabu-a-na130-h200切换至cn-wulan-a-na130-sna-h102\n监控：\naliping 集团上云大盘\nCGW(HGW SNA)流量图\n灵骏acvs 大盘\n手动探测：本Region、跨Region 手动ping 测灵骏vpd地址 --- 2:01 关闭\n10.12凌晨 2:06 - 2:12\n2. 乌兰 集团业务之前切流后的残余cen策略清除 --- 变更触发异常\nhttps://acn.alibaba-inc.com/web/cc/OrderDetail?order_id=10562\n监控：\naliping 集团上云大盘\nCGW（HGW SNA）流量图\n10.12凌晨 2:09:30\n指令下发时间点：--- 故障触发\n10.12凌晨 3:06 集团GOC联系到扫爷，由于报的是宕机怀疑和ASW有关，拉上善阳和时潮确认\n10.12凌晨 3:16 看到有灵骏相关的CEN变更，电话会议拉上行壹\n10.12凌晨 3:17 开始回滚变更1\n触发变更1的两个步骤进行一键回滚\n2024-10-12T03:17:46 ~ 2024-10-12T03:17:47\n2024-10-12T03:18:20 ~ 2024-10-12T03:18:21\n10.12凌晨 3:21 开始回滚变更2\n由于业务方反馈未恢复，触发变更2的4个步骤进行一键回滚\n2024-10-12T03:21:06 ~ 2024-10-12T03:21:06\n2024-10-12T03:21:12 ~ 2024-10-12T03:21:12\n2024-10-12T03:21:32 ~ 2024-10-12T03:21:33\n2024-10-12T03:21:58 ~ 2024-10-12T03:21:58\n10.12凌晨 3:22 业务方反馈恢复\n\n:::\n\n\n\n## 四、关注点分析\n**〖关注点1〗******\n\n:::tips\n1 . 故障预防\n〖关注点〗如何避免类似原因的故障再次发生？\n【问题分析】HGW切SNA已经进行多次变更，此问题只出现在存在灵骏VPD的场景，故障之前未出现问题。\n【改进点】\n重新和云网络评审变更方案，在方案评审完成中承载灵骏VPD相关业务的HGW/SNA变更暂停 -- 行壹   1031\n\n:::\n\n****\n\n**〖关注点2〗******\n\n:::tips\n2. 线上风险排除：\n〖关注点〗线上是否存在同类风险？\n【问题分析】承载集团VPD的HGW和SNA均存在类似风险，其他客户是否存在类似风险还需和云网络核实\n【改进点】\n和云网络核实其他客户是否存在类似风险 --- 苏晋    1031\n\n:::\n\n\n\n**〖关注点3〗******\n\n:::tips\n3. 变更方案评审\n〖关注点〗变更是否经过方案评审和风险评估？ 如何保证下一次变更方案评审正常\n【问题分析】hack方案网络运营清楚，但HGW流量切换完成后，底层逻辑依赖在强依赖老的系统VTB，网络运营和网络研发并不知道。导致变更未评估到位\n【改进点】暂无好的方案\n变更流程确认 （CM变更通知）行壹、程飚、舟雪   1031\n\n:::\n\n\n\n**〖关注点4〗**\n\n:::tips\n4. 变更执行",
    "chunk_order_index": 3,
    "full_doc_id": "doc-f426c624d187d5c7733f63b758edcbc6"
  },
  "chunk-899928ccb85e22b0dff363bc71d3d8ab": {
    "tokens": 1200,
    "content": "网络运营清楚，但HGW流量切换完成后，底层逻辑依赖在强依赖老的系统VTB，网络运营和网络研发并不知道。导致变更未评估到位\n【改进点】暂无好的方案\n变更流程确认 （CM变更通知）行壹、程飚、舟雪   1031\n\n:::\n\n\n\n**〖关注点4〗**\n\n:::tips\n4. 变更执行：\n〖关注点〗是否存在变更单，是否违反变更红线？\n【问题分析】存在变更单，如上\n【改进点】无\n\n〖关注点〗变更过程监控是否正常?\n【问题分析】本次只影响灵骏VPD和集团上云跨region访问，本次进行二个变更，第一个切流变更进行过打流测试，无丢包，且观察流量已经完全切换到新设备，故停止了打流监控， 第二个删除CEN残余路由后，变更同学认为是集团上云的变更，故障关闭了VPD相关的打流测试\n当前灵骏proxy监控是在本region内新开的ECS，通过ECS探测灵骏连接的质量。 本次是集团上云、集团弹内通过灵骏连接访问GPU资源出现异常。后续需要将集团灵骏VPD的资源纳入集团上云的探测。\n【改进点】\n将集团灵骏VPD的资源纳入集团上云的探测（集团大账户监控的改进）。 -- 圣堂 念琦 鸿儒  11.17\n\n:::\n\n\n\n**〖关注点5〗**\n\n:::tips\n 5. 2024-10-12 凌晨 3:07 灵骏VBR所在CSW出口流量大幅下跌原因\n〖关注点〗灵骏VBR所在CSW出口流量大幅下跌是什么原因导致？\n【问题分析】灵骏VBR所在CSW出口流量大幅下跌 \n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/34721/1728974229621-8660ac12-080e-4394-8afa-f97446f19011.png)\n\n【改进点】2024-10-12 凌晨 3:07 灵骏VBR所在CSW出口流量大幅下跌原因确认   行壹   1031\n\n:::\n\n\n\n## 五、常规检查项\n### 5.1【系统质量】\n#### 5.1.1 需求&设计评估\n###### 〖关注点1〗是否涉及产品、技术方案评估？此核心的问题是什么，如何改进？ __\n- [ ] **是，涉及**\n    - [ ] 需求评估遗漏\n    - [ ] 产品设计缺陷\n    - [ ] 系统架构设计缺陷\n        - [ ] 容错性不足 \n        - [ ] 单点，无冗余\n        - [ ] 缺乏自我保护\n        - [ ] 缓存设计不当\n        - [ ] 容量评估不足\n        - [ ] 非幂等设计\n        - [ ] 强弱依赖不合理\n        - [ ] 其他：__________\n- [x] 否，不涉及\n\n**〖问题总结〗暂无**\n\n**〖改进点〗暂无**\n\n\n\n#### 5.1.2 代码质量\n###### 〖关注点1〗是否代码自身存在漏洞或BUG、代码健壮性是否存在问题等?\n**〖问题分析〗**暂无\n\n**〖改进点〗**暂无\n\n###### 〖关注点2〗是否经过CodeReview？CodeReview阶段是否发现问题？为何没发现？\n+ **是否经过CR**\n    - [ ] 是\n    - [ ] 否\n    - [x] 不涉及\n+ **是否设置合理的CR卡点**\n    - [ ] 是\n    - [ ] 否\n    - [x] 不涉及\n+ **CodeReview阶段是否发现问题？为何没发现？后续如何发现？**\n    - [ ] 是\n    - [ ] 否\n    - [x] 不涉及\n\n**〖问题分析〗****暂无**\n\n**〖改进点〗****暂无**\n\n###### 〖关注点3〗测试阶段   __\n+ **测试内容：**涉及的测试提交单、测试用例等\n+ **测试人员：**\n+ **是否经过测试验证**\n    - [ ] 是，验证环境\n        - [ ] 预发环境\n        - [ ] 日常环境\n    - [ ] 是，测试方法\n        - [ ] 单元测试\n        - [ ] 功能回归测试\n        - [ ] 集成测试/链路测试\n        - [ ] 验收测试\n    - [ ] 否\n    - [ ] 不涉及\n+ **测试未发现原因是什么？后续如何改进？**\n    - [ ] 回归测试遗漏\n        - [ ] 手工回归测试用例遗漏\n        - [ ] 自动化未建设\n        - [ ] 自动化回归覆盖不足\n        - [ ] 其他：__________\n    - [ ] 新场景测试遗漏\n        - [ ] 功能测试用例遗漏，包括正常分支和异常分支\n        - [ ] 容灾兜底测试遗漏",
    "chunk_order_index": 4,
    "full_doc_id": "doc-f426c624d187d5c7733f63b758edcbc6"
  },
  "chunk-762d3d28a1858a9cdec2998f212a9501": {
    "tokens": 1200,
    "content": "后续如何改进？**\n    - [ ] 回归测试遗漏\n        - [ ] 手工回归测试用例遗漏\n        - [ ] 自动化未建设\n        - [ ] 自动化回归覆盖不足\n        - [ ] 其他：__________\n    - [ ] 新场景测试遗漏\n        - [ ] 功能测试用例遗漏，包括正常分支和异常分支\n        - [ ] 容灾兜底测试遗漏\n        - [ ] 客户端兼容性测试遗漏\n        - [ ] 埋点测试遗漏\n        - [ ] 性能测试遗漏，影响评估不足\n        - [ ] 安全测试遗漏\n    - [ ] 其他：__________\n\n**〖问题总结〗**\n\n**〖改进点〗**_**需明确写明不同故障相关方的改进项（若有的话），下同。**_\n\n1、\n\n#### 5.1.3 变更质量\n+ **是否涉及变更：**\n    - [x] 是\n    - [ ] 否\n+ **变更类型：**\n    - [ ] 代码发布\n    - [ ] 配置变更\n    - [x] 其他变更：____网络变更________\n    - [ ] 不涉及\n+ **变更平台是否接入ChangeFree：**\n    - [ ] 是，CF变更单链接：________\n    - [x] 否  变更单：[https://acn.alibaba-inc.com/web/cc/OrderDetail?order_id=10558](https://acn.alibaba-inc.com/web/cc/OrderDetail?order_id=10558)\n\n     CM链接：[https://bg.aliyun-inc.com/#/change-approval/detail?bgVid=BG2024100903E1RRZW7](https://bg.aliyun-inc.com/#/change-approval/detail?bgVid=BG2024100903E1RRZW7)\n\n+ **是否违反变更红线3.1**** **[链接](https://aliyuque.antfin.com/ngoc/fzg6dy/uar1k6)\n    - [ ] 是，违反哪条原则：\n    - [x] 否\n\n###### 〖关注点1〗灰度阶段     \n+ **是否经过灰度：**\n    - [x] 是\n    - [ ] 否\n+ **观测了哪些监控**：_可以附链接_\n    - [ ] 黑屏、白屏\n    - [ ] GOC监控：\n    - [x] 系统大盘：\n    - [x] 其他：  [https://x6.alibaba-inc.com/#/path/index/newCloud](https://x6.alibaba-inc.com/#/path/index/newCloud) \n+ **是否灰度期间发现问题？**\n    - [x] 是\n        - [ ] 是否灰度流量过大，导致故障\n        - [ ] 灰度发现但未有效或及时修复，导致故障\n        - [x] 其他：   灵骏是云最后一批执行变更的资源，目前只有灵骏出现过此类问题    \n    - [ ] 否，后续如何灰度发现？_____________\n+ **未灰度发现原因**\n    - [ ] 应用灰\n        - [ ] 灰度流量太小\n        - [ ] 灰度阶段无监控\n        - [ ] 灰度批次不合理\n        - [ ] 超长时间灰度才能发现\n    - [ ] 业务灰：策略不合理\n    - [x] 灰度无法发现\n    - [ ] 其他：_____________\n\n**〖问题总结〗**\n\n**〖改进点〗**_**需明确写明不同故障相关方的改进项（若有的话），下同。**_\n\n###### 〖关注点2〗上线阶段   \n+ **是否有确定的监控观测指标**\n    - [ ] 是，监控指标及监控链接：\n    - [ ] 否\n+ **是否在窗口期进行发布变更**\n    - [ ] 是\n    - [ ] 否，原因：\n+ **变更是否影响上下游**\n    - [ ] 是，是否有提前知会上下游评估及关注变更\n        - [ ] 有提前知会\n        - [ ] 没有提前知会\n    - [ ] 否\n\n**〖问题总结〗**\n\n**〖改进点〗**_**需明确写明不同故障相关方的改进项（若有的话），下同。**_\n\n### 5.2【处置能力】 __\n#### 5.2.1 故障发现&响应\n+ **是否监控发现**\n    - [ ] 故障触发方 监控发现\n    - [x] 故障受影响方 监控发现\n    - [ ] 否，原因为：（监控无效/监控缺失）\n+ **是否5分钟内响应**\n    - [x] 是\n    - [ ] 否，原因为：\n+ **是否存在应急协同问题**\n    - [ ] 是\n        - [ ] 应急流程不明确（无流程或者流程不清晰、应急相关角色&职责不明确，缺失一号位等)\n        - [ ] 应急执行不到位（有流程，但未按流程执行，通告发送不及时，响应不及时等）\n    - [x] 否\n\n**〖问题总结〗**\n\n**〖改进",
    "chunk_order_index": 5,
    "full_doc_id": "doc-f426c624d187d5c7733f63b758edcbc6"
  },
  "chunk-68258ec8c7faa167f8d277d6a690e152": {
    "tokens": 1200,
    "content": "因为：\n+ **是否存在应急协同问题**\n    - [ ] 是\n        - [ ] 应急流程不明确（无流程或者流程不清晰、应急相关角色&职责不明确，缺失一号位等)\n        - [ ] 应急执行不到位（有流程，但未按流程执行，通告发送不及时，响应不及时等）\n    - [x] 否\n\n**〖问题总结〗**\n\n**〖改进点〗**_**需明确写明不同故障相关方的改进项（若有的话），下同。**_\n\n1、\n\n#### 5.2.2 故障定位&恢复\n+ **主要恢复方式：**\n    - [ ] 代码发布/回滚\n    - [x] 配置发布/回滚\n    - [ ] 数据订正\n    - [ ] 机器隔离/重启/扩容\n    - [ ] 配置限流\n    - [ ] 预案降级\n    - [ ] 自动恢复\n    - [ ] 其他：\n+ **是否10分钟内恢复**_/* P1P2故障填写*/_\n    - [ ] 是\n    - [x] 否，原因：   受影响方对灵骏变更无感知，排查时间确认网络变更花费时间较长   \n\n**〖关注点1〗定位&恢复阶段存在什么问题？是否可以增加预案，****有更快的恢复方式？****相关的优化改进？**\n\n**〖问题总结〗**\n\n**〖改进点〗**\n\n1、\n\n\n**〖关注点2〗业务自身是否具备容灾逃逸能力？后续如何改进？**_/* 如涉及基础设施引发的故障，可填写*/_\n\n- [ ] 具备容灾能力\n    - [ ] 因未演练不敢执行\n    - [ ] 因有损评估决策不执行\n    - [ ] 无决策或者决策不当，未执行\n- [x] 不具备容灾能力\n\n**〖问题总结〗**\n\n**〖改进点〗**\n\n1、\n\n\n\n### \n## 六、故障Action\n| **序号** | *******Action** | *******负责人** | *******计划完成时间** | **验收标准** | **是否keyAction** | **是否回血Action** |\n| --- | --- | --- | --- | --- | --- | --- |\n| 1 | 重新和云网络评审变更方案，在方案评审完成中承载灵骏VPD相关业务的HGW/SNA变更暂停 | 行壹 | 2024.10.31 | 产出方案文档并评审通过 | 否 | 否 |\n| 2 | 和云网络核实其他客户是否存在类似风险 | 苏晋 | 2024.10.31 | 核实风险并解决 | 否 | 否 |\n| 3 | 变更流程确认 （CM变更通知） | 行壹 | 2024.10.31 | 产出变更流程规范文档，CM变更操作通知业务方 | 否 | 否 |\n| 4 | 将集团灵骏VPD的资源纳入集团上云的探测。 | 圣堂 | 2024.11.17 | 集团上云的探测上线灵骏VPD的资源 | 否 | 否 |\n| 6 | 2024-10-12 凌晨 3:07 灵骏VBR所在CSW出口流量大幅下跌原因确认 | 行壹 | 2024.10.31 | 确定灵骏VBR所在CSW出口流量大幅下跌原因并同步至业务方 | 否 | 否 |\n\n\n\n\n## 七、故障总结反思\n**【做得好的】**\n\n**【经验教训】**举一反三，学习，避免踩坑\n\n\n\n## 八、影响产品线&影响面\n| **受影响业务** | **等级** | **影响说明** |\n| --- | --- | --- |\n| 阿里小蜜，aone-copilot，达摩院 | 未达故障 | - [x] 是否影响可用性- [ ] 高可用影响：无- [ ] 是否有客诉：无在线人工反馈- [ ] 是否有社会舆情：否- [ ] 是否产生资损：否 |\n\n\n****\n\n## 九、故障定级&定责&故障相关方\n【故障等级】P3  \n【故障责任方】  \n【故障分】\n\n| ** 系统质量（30%）** | | | | | **处置能力（70%）** |\n| --- | --- | --- | --- | --- | --- |\n| **相关方** | **需求设计** | **代码质量** | **变更质量** | **自定义项** | **发生时间** | **发现时间（30%）** | **恢复时间（40%）** |\n| 阿里集团-云智能集团-阿里云智能-阿里云智能CTO线-基础设施事业部-网络研发-网络运营-工程效能 | N | N | Y |  | 2024-10-12 02:39:00 | 2024-10-12 02:32:00 | 2024-10-12 03:23:00 |\n\n\n> 故障涉及相关方都需填写，相关方",
    "chunk_order_index": 6,
    "full_doc_id": "doc-f426c624d187d5c7733f63b758edcbc6"
  },
  "chunk-31c8b0834590b15714b7f74562b991ab": {
    "tokens": 1200,
    "content": "阿里集团-云智能集团-阿里云智能-阿里云智能CTO线-基础设施事业部-网络研发-网络运营-工程效能 | N | N | Y |  | 2024-10-12 02:39:00 | 2024-10-12 02:32:00 | 2024-10-12 03:23:00 |\n\n\n> 故障涉及相关方都需填写，相关方包括但不限于触发方、根因方、导致故障影响扩大方、受影响方。\n>\n> 参考安全生产度量规范：[https://aliyuque.antfin.com/trecs/fzg6dy/wf9gze](https://aliyuque.antfin.com/trecs/fzg6dy/wf9gze)\n>\n> **系统质量：**\n>\n> + 需求&设计：是否存在系统架构设计、产品设计缺陷等设计方面问题，填 是或否或不涉及\n> + 代码质量：是否自身或引入第三方组件，存在代码BUG、漏洞等。填 是或否或不涉及\n> + 变更质量 ：配置及运维类变更，是否存在方案设计、灰度执行方面问题；提供的工具不满足红线要求方面问题。填 是或否或不涉及\n> + 自定义项：可不填写，根据复盘时讨论点实际确定\n>\n> **处置能力：**\n>\n> + 发生时间、发现时间、恢复时间需填写各方的时间\n> + 填具体时间或不涉及，若非监控发现，则勾选未发现\n> + 发现或恢复能力如不涉及，需描述具体理由\n> + 发现能力：受影响方缺少有效的系统监控手段，未发现业务异常等问题；变更执行方或触发方，对变更没有进行有效的观测，发现能力不足等问题\n> + 恢复能力：受影响方缺少容灾能力，响应速度慢等问题；处置方预案不足，响应速度慢等问题\n>\n\n## \n## 十、附录\n### 附1：故障打标规范\n参考：[https://aliyuque.antfin.com/ngoc/cltlwa/gw086g](https://aliyuque.antfin.com/ngoc/cltlwa/gw086g)\n\n#### 时间线打标规范\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/7773/1688969397509-2c9d7ddd-d346-4f1f-a73d-490bfab8acef.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/7773/1688969407141-945368c1-0780-4c63-8821-795ab3b5e1b3.png)\n\n\n\n### 附2：故障机制参考\n#### 故障相关方定义\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/7773/1688969946769-8bd28bca-7352-44d1-8b01-c73db5a2d281.png)\n\n[https://aliyuque.antfin.com/ngoc/fzg6dy/laf0oz](https://aliyuque.antfin.com/ngoc/fzg6dy/laf0oz)\n\n\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/2763/1656924636921-077e71cc-a8d1-40a0-8d7d-dc0e9ead77ba.png)\n\n#### 高可用故障分测算\n**横轴表示故障从发生时间开始-恢复时间的整个时长（分钟）：**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/2763/1656924726389-a00fb430-c3bc-44cf-a2aa-cf94aa97d8d4.png)\n\n备注：实际故障分以系统计算结果为准。\n\n\n\n**高可用故障分计算系数：**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/2763/1656924851376-9d274389-90ce-47e1-a3b7-1ed29818f417.png)\n\n#### 资损故障定级\n参考：[https://aliyuque.antfin.com/ngoc/fzg6dy/hikl2ibbk8934lax](https://aliyuque.antfin.com/ngoc/fzg6dy/hikl2ibbk8934lax)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/7773/1688970048219-78b29218-2ff2-499b-8f9d-70d50392106e.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/7773/1688970064707-8e0efecd-f516-4bd0-83ed-78a49f9d8316.png)\n\n#### 资损故障分测算\n![](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/301935/1659333193187-93e7c7a3-4625-4a9b-ab",
    "chunk_order_index": 7,
    "full_doc_id": "doc-f426c624d187d5c7733f63b758edcbc6"
  },
  "chunk-2cc588bf33e867534f80cb40bbc7c203": {
    "tokens": 1200,
    "content": "/lark/0/2023/png/7773/1688970064707-8e0efecd-f516-4bd0-83ed-78a49f9d8316.png)\n\n#### 资损故障分测算\n![](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/301935/1659333193187-93e7c7a3-4625-4a9b-ab58-f903830b1262.png)\n\n\n\n# 十一：FAQ\n**问题：HGW是什么？**\n\nHGW（High-speed Gateway）是一款高性能网关产品，主要应用于云环境中，提供高速、高吞吐量和低延迟的网络转发性能。以下是关于HGW的一些关键信息：\n\n1. **微服务化和流量管理**：\n    - HGW作为流量入口，负责卸载大象流和低延时诉求的实例流量，具备流量统计、镜像、抗DDoS等功能。\n    - HGW实现了无状态化设计，将复杂业务下沉至NFV（Network Functions Virtualization），使得HGW功能简单、稳定，可长时间不进行版本更新。\n    - HGW作为后端业务集群的流量调度器，可以根据多种策略进行流量调度，如容灾和故障逃逸能力的建设。\n2. **资源限制与挑战**：\n    - HGW使用的是Barefoot Tofino P4可编程芯片，但该芯片的片上资源（如SRAM、TCAM、PHV）非常有限，难以存储大量租户级别的配置文件。\n    - 随着新功能的不断增加，芯片资源逐渐被消耗殆尽，这限制了HGW未来功能扩展的可能性。\n3. **性能与稳定性**：\n    - HGW已经成功部署在多个地域，为集团大促、大数据业务、蚂蚁、公有云大客户及普通租户提供了高性能的网络服务。\n    - HGW在网络建设项目中表现出色，尤其是在应对突发业务需求时，能够迅速响应并提供双保险的网络建设方案。\n    - HGW在618和99大促期间，经受住了流量高峰的考验，性能和稳定性得到了业务方的认可。\n4. **未来发展**：\n    - HGW将继续面临资源限制的挑战，需要在功能扩展和性能提升之间找到平衡点。\n    - 随着网络技术的发展，如200G/400G技术的成熟，HGW需要与物理网络能力相匹配，确保全链路的性能。\n    - HGW的角色和网络解决方案将根据业务需求和场景变化进行调整，以适应未来的业务发展。\n\n\n\n**问题：SNA是什么？**\n\nSNA（可编程应用级监控）是一种集成了高性能转发能力和灵活可编程硬件的解决方案。它主要应用于网络设备中，能够高效处理复杂的业务逻辑和大流量数据传输。以下是SNA的关键特点和发展情况：\n\n1. **硬件优势**：\n    - **高性能转发**：SNA利用可编程交换芯片实现高速数据转发，满足大流量线速转发的需求。\n    - **强大的计算能力**：通过CPU处理复杂的业务逻辑，实现软硬一体化平台。\n    - **可扩展性**：支持PCIe扩展，可以通过FPGA实现表项扩充和加密等功能。\n2. **软件优势**：\n    - **统一的操作系统**：内置AliNos自研操作系统，提供标准化的网络系统底座。\n    - **业务容器化**：支持多业务以相对独立的容器化方式部署，实现交换机、负载均衡器、NAT网关等多种角色的超融合。\n3. **应用场景**：\n    - **云网关**：SNA平台作为下一代云网关的统一硬件平台，支撑线上IGW、CGW、VGW业务，满足未来五年线上云网络的软硬件一体化需求。\n    - **专线接入**：SNA-CGW目标是替代现有的S9180设备，为阿里云用户提供专线接入和跨区域高速通道的支持。\n4. **技术演进**：\n    - **可编程芯片**：采用Barefoot Tofino等可编程交换芯片，支持100GE接口，提供高性能转发能力。\n    - **多核CPU**：配备Intel Cascade Lake CPU，支持多核心处理，提高复杂业务逻辑的处理效率。\n    - **FPGA扩展**：通过FPGA实现表项扩充和加密等功能，增强系统的灵活性和扩展性。\n5. **运营与维护**：\n    - **自动化运维**：建立了一套针对自研机的运营体系，支撑自研交换机在线的稳定运营。\n    - **监控与管理**：提供统一的运营、监控接入，确保网络设备的高效运行。\n综上所述，SNA作为一种可编程应用级监控解决方案，在网络设备中实现了高性能转发和灵活的业务处理能力，广泛应用于云网关、专线接入等场景，并通过不断",
    "chunk_order_index": 8,
    "full_doc_id": "doc-f426c624d187d5c7733f63b758edcbc6"
  },
  "chunk-5624b64bc5d38ba90608c8ba144c4c43": {
    "tokens": 775,
    "content": "针对自研机的运营体系，支撑自研交换机在线的稳定运营。\n    - **监控与管理**：提供统一的运营、监控接入，确保网络设备的高效运行。\n综上所述，SNA作为一种可编程应用级监控解决方案，在网络设备中实现了高性能转发和灵活的业务处理能力，广泛应用于云网关、专线接入等场景，并通过不断的技术演进和优化，提升了整体网络系统的稳定性和效率。\n\n  \n\n\n问题 ：cen策略是什么？\n\nCEN（Cloud Enterprise Network）策略是指在阿里云云企业网中用于管理和控制网络路由的技术。这些策略使得用户能够灵活地配置和管理不同VPC（Virtual Private Cloud）之间的网络连接，从而实现高效、安全的云上网络架构。以下是cen策略的主要内容：\n\n1. **路由策略设计：**\n    - 云企业网路由策略的设计贴近传统网络设备的路由策略，便于企业网络工程师理解和应用。\n    - 提供了多种路由策略实践和配置方式，如限制VPC间互通、限制网段间互通、指定VPC间互通等。\n2. **混合云网络中的灵活路由控制：**\n    - 集团CEN网络为迄今CEN产品最为复杂的网络之一，通过集团的需求锤炼，云企业网CEN得到了更好的成长和沉淀。\n    - 云企业网CEN已经为集团打通了国内多个区域之间的云上互通，为后续业务全面上云奠定了扎实的网络基础。\n3. **互联网游戏客户CEN-TR不停机升级方案：**\n    - 在原有方案基础上，通过创建新的企业版CEN-TR网络，逐步迁移游戏项目VPC流量，形成去中心化的云上业务网络。\n    - 这种方案有效降低了业务增长带来的运维成本，同时提高了网络管理的灵活性。\n4. **网络架构优化：**\n    - 云企业网可以帮助用户在不同地域VPC间、VPC与本地数据中心间搭建私网通信通道，提高网络的快速收敛和跨网络通信的质量和安全性。\n    - 用户可以根据实际业务需求配置更严格的路由策略，实现选择性放通。\n5. **CEN流量调度能力：**\n    - 通过路由策略实现的流量调度能力在复杂业务场景中表现出色，例如根据不同业务需求分配不同的下一跳地址。\n    - 虽然这些功能目前不能直接开放给用户，但未来可以考虑做一定的封装，进行智能化调度的探索。\n6. **CEN路由灾备配置：**\n    - 在配置VBR（Virtual Border Router）接入CEN作为灾备冗余时，需要注意路由策略的正确配置。\n    - 解决方案包括在阿里云侧追加AS Path策略，在线下IDC侧增大AS路由策略应用到peer。\n\n综上所述，CEN策略是一种强大的工具，可以帮助用户实现灵活、高效、安全的云上网络架构。通过合理配置和管理这些策略，用户可以更好地满足自身业务需求。\n\n\n\n问题：特殊的HACK方案是什么？\n\n专门针对灵骏VPD 集团上云做的相关方案，如果没有此方案，灵骏VPD业务通过CEN无法访问集团弹内资源。\n\n\n\n####",
    "chunk_order_index": 9,
    "full_doc_id": "doc-f426c624d187d5c7733f63b758edcbc6"
  },
  "chunk-853ce75ce9dd2cdff7b42b83d104fefc": {
    "tokens": 1200,
    "content": "## 一、故障简述\n2024年9月26日23:56监控预警酒店_提交订单_排错成功率下跌，同时省钱卡、优惠扣减、酒店确认有房等接连预警，影响酒店订单提交和省钱卡相关权益查询，故障原因初步确认是会员DB库CPU被打满，导致诸葛/酒店交易接口成功率下跌，于00:07酒店定价任务停止后故障自动恢复，期间未产生集中性客诉，根据监控下跌幅度判定达P4故障等级。\n\n## 二、影响产品线及影响面\n- [x] 是否影响可用性：否\n- [x] 业务影响：\n\n**交易域业务影响：**\n\n酒店订单提交成功率持续12分钟小于80%\n\n**会员域业务影响：**\n\n会员中心，权益查询，省钱卡相关权益查询业务存在四分之一流量无法查询和展示情况\n\n| **业务场景** | **监控项** | **是否触发故障** | **影响时段** |\n| --- | --- | :---: | :---: |\n| 酒店日历房交易下跌（包含创建、下单） | [酒店_提交订单_排错](https://x.alibaba-inc.com/custom/59/product/preview/spm/7528?crossTenant=true)  | **P4** | 23:54-00:05成功率持续<80%（受影响时段：23:53-00:06，持续14分钟）![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/41240/1728544502119-f72d5cdc-03e8-4dfb-9601-8db963097217.png) |\n| 省钱卡-省钱卡开卡页成功率下跌 | [飞猪省钱卡开卡页监控异常](https://x.alibaba-inc.com/custom/59/product/preview/spm/4543?crossTenant=true)   | **P4** | 23:55-00:05成功率持续<80%（受影响时段：23:54-00:06，持续13分钟）![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/41240/1728544830632-9a41ebfc-97e0-4001-94b9-2f263441dca3.png) |\n| 优惠扣减失败 | [飞猪_营销优惠扣减异常  ](https://x.alibaba-inc.com/custom/59/product/preview/spm/4013?crossTenant=true) | 未触发 | 受影响时段：23:53-00:06，持续14分钟![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/41240/1728545058053-4557612d-de70-4cf7-8713-f71af9b14fe3.png) |\n| 酒店确认有房（信用住）、发货（预付）动作无法正常操作和更新，合并EBK的订单确认 | [飞猪酒店订单确认有房异常 ](https://x.alibaba-inc.com/custom/59/product/preview/spm/1772?crossTenant=true)  | 未触发 | 受影响时段：23:54-00:06，持续13分钟![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/41240/1728546048977-9e60b223-de6c-49c6-b8e9-e8491a37f26c.png) |\n| 高德分销交易量异常 | [飞猪分销_高德提交接口异常 ](https://x.alibaba-inc.com/custom/59/product/preview/spm/5567?crossTenant=true)  | 未触发 | 受影响时段：23:53-00:07，持续15分钟![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/41240/1728546708319-e0c0d7ac-ba8a-4c99-9f75-7a08e82392b9.png) |\n\n\n- [x] 是否有客诉：否\n- [x] 是否有社会舆情_：_否\n- [x] 是否产生资损：否\n\n## 三、故障过程回顾\n2024-09-26 23:53，由于业务策略调整，触发酒店定价任务启动**【风险注入】**\n\n2024-09-26 23:54，会员侧收到系统告警，并介入处理**【业务响应】**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/226531/1728376720985-26c06b79-8730-46a8-b9dc-83b16aa778a9.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/226531/1728556535619-24523544-2424-48c5-9a65-36b54060ab85.png)\n\n2024-09-26 23:56，飞猪预警群陆续出现数据库慢SQL（23:56）、酒店提交订单（23:56）、飞猪省钱卡（23:57）、优惠扣减（23:57）、飞猪酒店",
    "chunk_order_index": 0,
    "full_doc_id": "doc-197f302fa55cded8d66c12ea390cc345"
  },
  "chunk-7f393c2fb334134fd20c92c63a50aa53": {
    "tokens": 1200,
    "content": "/skylark/lark/0/2024/png/226531/1728556535619-24523544-2424-48c5-9a65-36b54060ab85.png)\n\n2024-09-26 23:56，飞猪预警群陆续出现数据库慢SQL（23:56）、酒店提交订单（23:56）、飞猪省钱卡（23:57）、优惠扣减（23:57）、飞猪酒店确认有房（23:58）、高德分销（23:58）等相关风险预警**【故障发现】**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/41240/1728544255145-1503b543-209e-4e68-99f1-c3c2e4f0c5a2.png)![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/41240/1728544283489-ace691c5-e4b8-4287-ab46-fac58fa2f921.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/41240/1728544689903-80252207-64d8-4996-80cd-e68c2e06dc1c.png)![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/41240/1728545200524-0487cedf-47c6-426b-9185-ff5646069489.png)\n\n2024-09-26 23:58，度假停止压测****\n\n2024-09-26 23:59，酒店交易同学介入排查****\n\n2024-09-27 00:00，酒店交易同学确认是圈人接口问题，会员的库报警了，当时怀疑是压测导致的**【初因定位】**\n\n2024-09-27 00:02，发现停止压测后故障还是未恢复\n\n2024-09-27 00:03，酒店日历房交易失败量最近10分钟最小值大于等于10，成功率最近10分钟最大值小于等于80%，触发P4**【故障发生】**\n\n2024-09-27 00:06，酒店定价任务结束，故障结束后发现db、huc都在此时恢复了**【恢复执行】**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/41240/1728548209309-eba59f6e-1d13-40d1-ad7b-2a27743dc19a.png)![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/41240/1728548224605-86299c63-1288-4f2c-b4db-af152b0084d0.png)\n\n2024-09-27 00:07，打算拉DBA协助排查数据库异常，发现监控已恢复至正常水位，但无人知晓是如何恢复的**【故障恢复】**\n\n2024-09-27 01:11，[@馬达](undefined/majingda.mjd) 群内提供排查思路：根据fliggyright的数据库性能表现及比价链路的任务请求图来看， 最近两次的比价任务和fliggyright的数据库水位是契合的，并且最近一次比价的执行和恢复时间是23:53和00:06，跟数据库的cpu保障和恢复的时间完全一致，调用链路是比价->酒店搜索->hotel-member->fliggyffa->诸葛->fliggyright****\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/41240/1728548375239-481d5a92-a41b-4997-a973-86875ac05d6f.png)![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/41240/1728548382412-a9a75955-5144-4c34-a967-ea7d00005cb5.png)\n\n2024-09-29 11:32，[@馬达](undefined/majingda.mjd) 群内同步会员侧排查结论：故障期间26号23:53到00:06造成会员DB问题的是账号【2024春运普客f2测试账号】批量请求会员接口查询该账号是否拥有省钱卡导致，该账号是比价在使用，比价任务的开始和结束时间与故障时间一致，需要会员侧协同比价、酒店导购、诸葛三方共同排查为什么这个账号当时会给会员那么大的请求**【根因定位】**    \n\n2024-09-29 15:48，[@馬达](undefined/majingda.mjd) 拉会对焦问题后群内同步会员、诸葛、酒店交易三方后续相关action。\n\n## 四、故障原因\n### 4.1【背景说明】\n发生故障的链路：诸葛的线程池满，导致酒店交易下跌\n\n1. 酒店交易\n2. 诸葛\n\n该链路导致会员db cpu过高，rt变长，从而诸葛的线程池满\n\n1. 定价\n2. 比价 \n3.",
    "chunk_order_index": 1,
    "full_doc_id": "doc-197f302fa55cded8d66c12ea390cc345"
  },
  "chunk-43136a01b1bd8ee0dd3cf8cf6d3c4f15": {
    "tokens": 1200,
    "content": "后群内同步会员、诸葛、酒店交易三方后续相关action。\n\n## 四、故障原因\n### 4.1【背景说明】\n发生故障的链路：诸葛的线程池满，导致酒店交易下跌\n\n1. 酒店交易\n2. 诸葛\n\n该链路导致会员db cpu过高，rt变长，从而诸葛的线程池满\n\n1. 定价\n2. 比价 \n3. 导购（酒店小搜）\n4. 诸葛人群\n5. 会员\n\n### 4.2【原因分析】\n#### 一句话原因：\n酒店定价任务带来的查询流量突增叠加会员数据库的慢SQL问题导致会员数据库CPU被打满，使得所有打到数据库查询省钱卡接口流量的耗时和错误整体上升，继而引发诸葛的hsf线程池满，酒店交易应用huc强依赖诸葛非核心分组，在诸葛非核心分组线程池满的情况下导致酒店交易成功率下跌。\n\n#### 根因分析：\n**酒店交易侧：**\n\n酒店交易应用huc强依赖诸葛非核心分组，在诸葛非核心分组线程池满的情况下导致酒店交易成功率下跌\n\n**诸葛侧：**\n\n诸葛早期在提供给外部配置泛化调用hsf的能力时，对于超时时间没有做详细Review。对接会员的开发提供的接口时设置了5000ms的超时时间，在下游出现异常后直接拖垮了诸葛的机器。\n\n9月26日 23:54 诸葛依赖的会员接口异常后 rt 大涨，导致应用 hsf 线程池满，圈人接口成功率下跌。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/6504/1727402055374-2b11f1ca-2fb6-4471-8134-888a9d3134ea.png)\n\n**会员侧：**\n\n9月26日 23:53，由于业务策略调整，触发酒店定价任务，调用比价接口，比价调用诸葛查询用户是否是省钱卡用户，缓存里存的都是有省钱卡的用户信息，若是非省钱卡用户，则对数据库直接进行查询，这会导致如果用户一直没有省钱卡，就会一直查询DB。此时**瞬时流量达到8000**，当瞬时流量上来之后，定价任务使用的用户id刚好路由到了fliggy_right_user_0003库，同时**fliggy_right_user_0003库存在慢sql**，导致fliggy_right_user_0003库的cpu被打满，使用率到达100%，使得所有打到fliggy_right_user_0003库查询省钱卡接口流量耗时和错误整体上升。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/226531/1728376828927-36d570d1-70e3-4ae1-8cbf-e4a578cb96ce.png)\n\n来源诸葛调用查询是否有省钱卡身份流量突然涨了8000：\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/226531/1728377893512-fa585506-3416-4457-a65c-c3046a7ebc92.png)fliggyright数据库cpu满：\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/226531/1728377224278-05e0bb50-fc92-4994-9b17-b30c5565a6d4.png)\n\nfliggy_right_user_0003库存在慢sql导致流量瞬时上来之后将db打挂了\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/226531/1728377348700-6cde632a-1d7f-46c0-b75a-5491b8010b2b.png)\n\n## 五、关注点分析\n###### 【关注点1】会员接口请求量最近几个月突增明显，之前是否有配置限流？另外是否需要去分析请求量的来源，避免后续打挂DB的风险？\n:::info\n**问题总结：**会员这两个判断省钱卡身份接口从2024年6月到现在从200qps到现在20k涨了20倍，之前没有进行限流，分析来源都来自于酒店侧。\n\n**改进点：**\n\n1、增加省钱卡判断接口限流（基于热点）[@惺沉](undefined/zhongwei.rzw)  整体限流已完成，细分限流策略待定\n\n**10.12故障处理群内惺沉同步：**\n\n_跟@马杰(牧熵) 对焦，这块action细粒度的流控，从这次的两个接口来看，一个接口限流比较高基本不会触发，也就不需要做细粒度的流控了，还有一个接口因为运营滥用了人群标签，改成去掉滥用的标签人群的调用即可，这个点已经同步@臧亚敬(雅净) ，下周进行操作。因此基于热点维度的限流action删除，新增去掉滥用的标签人群的调用action。",
    "chunk_order_index": 2,
    "full_doc_id": "doc-197f302fa55cded8d66c12ea390cc345"
  },
  "chunk-43ad9c6eec85d7b16a2d41affb9b1d36": {
    "tokens": 1200,
    "content": "，从这次的两个接口来看，一个接口限流比较高基本不会触发，也就不需要做细粒度的流控了，还有一个接口因为运营滥用了人群标签，改成去掉滥用的标签人群的调用即可，这个点已经同步@臧亚敬(雅净) ，下周进行操作。因此基于热点维度的限流action删除，新增去掉滥用的标签人群的调用action。_\n\n2、优化省钱卡判断逻辑强制走索引减低慢sql出现概率 [@惺沉](undefined/zhongwei.rzw) done\n\n3、加入缓存策略降低回源查询DB的量级 [@惺沉](undefined/zhongwei.rzw) done\n\n4、酒店搜索->诸葛->会员的链路分析，看是否可以把调用量降低。[@雅净](undefined/sunny.zyj) 10.11\n\n:::\n\n###### 【关注点2】此次是受影响方监控率先预警，会员侧和诸葛侧是否具备相应的监控能力，可以更早发现问题？\n:::info\n**问题总结：**\n\n会员侧：有配置相关监控，23:54预警。\n\n诸葛侧：开发自己的小群内有报警，预警时间: 2024/09/26 23:53，HSF 成功率下跌\n\n**改进点：**增加日常的流量增长的预警监控，会员侧先行评估 [@惺沉](undefined/zhongwei.rzw) 10.30\n\n              会员侧数据库相关的预警阈值可以调整的更敏感 [@惺沉](undefined/zhongwei.rzw) 10.30\n\n:::\n\n###### 【关注点3】故障中是否使用了相关预案来降低故障影响面？是否可以增加预案让故障更快恢复？\n:::info\n**问题总结：**\n\n会员侧：故障中因为属于突发情况无事先配置相关预案\n\n诸葛侧：有外调降级预案，但是因为预案是最近才录入的，无法线上直接推。@见羽 采取推 switch 的方式在0点06分做了推送，目前预案已经验证完毕。\n\n**改进点：**\n\n会员侧：\n\n（1）和业务沟通后确认是否可以日常开启缓存，减低数据库访问次数。[@惺沉](undefined/zhongwei.rzw) 10.11\n\n（2）增加限流配置，同关注点1\n\n:::\n\n###### 【关注点4】故障定位时间过长，是否有相关的优化手段？比如**是否有用户维度的监控，若单用户请求量过大可以及时预警或者做限流？**\n:::info\n问题总结：各域定位自己问题的时间不长，主要是把整个链路串联起来比较耗时\n\n改进点：暂无更好的优化手段\n\n:::\n\n### 5.1【系统质量】--不涉及\n#### 5.1.1 需求&设计评估\n**〖关注点1〗****是否涉及产品、技术方案评估？此核心的问题是什么，如何改进？**\n\n- [ ] **是，涉及**\n    - [ ] 需求评估遗漏\n    - [ ] 产品设计缺陷\n    - [ ] 系统架构设计缺陷\n        - [ ] 容错性不足 \n        - [ ] 单点，无冗余\n        - [ ] 缺乏自我保护\n        - [ ] 缓存设计不当\n        - [ ] 容量评估不足\n        - [ ] 非幂等设计\n        - [ ] 强弱依赖不合理\n        - [ ] 其他：__________\n- [ ] 否，不涉及\n\n**〖问题总结〗**\n\n**〖改进点〗**_**需明确写明不同故障相关方的改进项（若有的话），下同。**_\n\n\n\n#### 5.1.2 代码质量\n**〖关注点1〗是否代码自身存在漏洞或BUG、代码健壮性是否存在问题等?**\n\n**〖问题分析〗**\n\n**〖改进点〗**_**需明确写明不同故障相关方的改进项（若有的话），下同。**_\n\n\n\n\n\n**〖关注点2〗****是否经过CodeReview？CodeReview阶段是否发现问题？为何没发现？**\n\n+ **是否经过CR**\n    - [ ] 是\n    - [ ] 否\n    - [ ] 不涉及\n+ **是否设置合理的CR卡点**\n    - [ ] 是\n    - [ ] 否\n    - [ ] 不涉及\n+ **CodeReview阶段是否发现问题？为何没发现？后续如何发现？**\n    - [ ] 是\n    - [ ] 否\n    - [ ] 不涉及\n\n**〖问题分析〗******\n\n**〖改进点〗**_**需明确写明不同故障相关方的改进项（若有的话），下同。**_\n\n\n\n\n\n**〖关注点3〗****测试阶段**\n\n+ **测试内容：**涉及的测试提交单、测试用例等\n+ **测试人员：**\n+ **是否经过测试验证**\n    - [ ] 是，验证环境\n        - [ ] 预发环境\n        - [ ] 日常环境\n    - [ ] 是，测试方法\n        - [ ]",
    "chunk_order_index": 3,
    "full_doc_id": "doc-197f302fa55cded8d66c12ea390cc345"
  },
  "chunk-385ac2220d0c28bd7d58f336b6b11826": {
    "tokens": 1200,
    "content": "不同故障相关方的改进项（若有的话），下同。**_\n\n\n\n\n\n**〖关注点3〗****测试阶段**\n\n+ **测试内容：**涉及的测试提交单、测试用例等\n+ **测试人员：**\n+ **是否经过测试验证**\n    - [ ] 是，验证环境\n        - [ ] 预发环境\n        - [ ] 日常环境\n    - [ ] 是，测试方法\n        - [ ] 单元测试\n        - [ ] 功能回归测试\n        - [ ] 集成测试/链路测试\n        - [ ] 验收测试\n    - [ ] 否\n    - [ ] 不涉及\n+ **测试未发现原因是什么？后续如何改进？**\n    - [ ] 回归测试遗漏\n        - [ ] 手工回归测试用例遗漏\n        - [ ] 自动化未建设\n        - [ ] 自动化回归覆盖不足\n        - [ ] 其他：__________\n    - [ ] 新场景测试遗漏\n        - [ ] 功能测试用例遗漏，包括正常分支和异常分支\n        - [ ] 容灾兜底测试遗漏\n        - [ ] 客户端兼容性测试遗漏\n        - [ ] 埋点测试遗漏\n        - [ ] 性能测试遗漏，影响评估不足\n        - [ ] 安全测试遗漏\n    - [ ] 其他：__________\n\n**〖问题总结〗**\n\n**〖改进点〗**_**需明确写明不同故障相关方的改进项（若有的话），下同。**_\n\n\n\n#### 5.1.3 变更质量\n+ **是否涉及变更：**\n    - [ ] 是\n    - [ ] 否\n+ **变更类型：**\n    - [ ] 代码发布\n    - [ ] 配置变更\n    - [ ] 其他变更：____________\n    - [ ] 不涉及\n+ **变更平台是否接入ChangeFree：**\n    - [ ] 是，CF变更单链接：________\n\n_/*要这样的链接_ [https://aicf.alibaba-inc.com/aicf/change/detail/1725370372](https://aicf.alibaba-inc.com/aicf/change/detail/1725370372) */\n\n    - [ ] 否\n+ **是否违反变更红线3.1 **[链接](https://aliyuque.antfin.com/trecs/fzg6dy/uar1k6)\n    - [ ] 是，违反哪条原则：\n    - [ ] 否\n\n\n\n**〖关注点1〗****灰度阶段**\n\n+ **是否经过灰度：**\n    - [ ] 是\n    - [ ] 否\n+ **观测了哪些监控**：_可以附链接_\n    - [ ] 黑屏、白屏\n    - [ ] GOC监控：\n    - [ ] 系统大盘：\n    - [ ] 其他：___________\n+ **是否灰度期间发现问题？**\n    - [ ] 是\n        - [ ] 是否灰度流量过大，导致故障\n        - [ ] 灰度发现但未有效或及时修复，导致故障\n        - [ ] 其他：___________\n    - [ ] 否，后续如何灰度发现？_____________\n+ **未灰度发现原因**\n    - [ ] 应用灰\n        - [ ] 灰度流量太小\n        - [ ] 灰度阶段无监控\n        - [ ] 灰度批次不合理\n        - [ ] 超长时间灰度才能发现\n    - [ ] 业务灰：策略不合理\n    - [ ] 灰度无法发现\n    - [ ] 其他：_____________\n\n**〖问题总结〗**\n\n**〖改进点〗**_**需明确写明不同故障相关方的改进项（若有的话），下同。**_\n\n\n\n\n\n**〖关注点2〗****上线阶段**\n\n+ **是否有确定的监控观测指标**\n    - [ ] 是，监控指标及监控链接：\n    - [ ] 否\n+ **是否在窗口期进行发布变更**\n    - [ ] 是\n    - [ ] 否，原因：\n+ **变更是否影响上下游**\n    - [ ] 是，是否有提前知会上下游评估及关注变更\n        - [ ] 有提前知会\n        - [ ] 没有提前知会\n    - [ ] 否\n\n**〖问题总结〗**\n\n**〖改进点〗**_**需明确写明不同故障相关方的改进项（若有的话），下同。**_\n\n1、\n\n### 5.2【处置能力】\n#### 5.2.1 故障发现&响应\n+ **是否监控发现**\n    - [ ] 故障触发方 监控发现\n    - [x] 故障受影响方 监控发现\n    - [ ] 否，原因为：（监控无效/监控缺失）\n+ **是否5分钟内响应**\n    - [x] 是\n    - [ ] 否，原因为：\n+ **是否存在应急协同问题**\n    - [ ] 是\n        - [ ] 应急流程不明确（无流程或者流程不清晰、应急相关角色&职责不明确，缺失一号位等)\n        - [ ] 应急执行不到位（有流程，但未",
    "chunk_order_index": 4,
    "full_doc_id": "doc-197f302fa55cded8d66c12ea390cc345"
  },
  "chunk-21a07e6f0f66d1b8f17f2091c5e6c9fd": {
    "tokens": 1192,
    "content": "：（监控无效/监控缺失）\n+ **是否5分钟内响应**\n    - [x] 是\n    - [ ] 否，原因为：\n+ **是否存在应急协同问题**\n    - [ ] 是\n        - [ ] 应急流程不明确（无流程或者流程不清晰、应急相关角色&职责不明确，缺失一号位等)\n        - [ ] 应急执行不到位（有流程，但未按流程执行，通告发送不及时，响应不及时等）\n    - [x] 否\n\n#### 5.2.2 故障定位&恢复\n+ **主要恢复方式：**\n    - [ ] 代码发布/回滚\n    - [ ] 配置发布/回滚\n    - [ ] 数据订正\n    - [ ] 机器隔离/重启/扩容\n    - [ ] 配置限流\n    - [ ] 预案降级\n    - [x] 自动恢复\n    - [ ] 其他：\n\n## 六、故障Action\n| **序号** | *******Action** | *******负责人** | *******计划完成时间** | **验收人** | **是否keyAction** |\n| :---: | --- | :---: | :---: | :---: | --- |\n| 1 | 短期：诸葛调整会员接口超时配置，目前是100-200ms，会员侧可提供期望的超时时间后再调整配置 | 牧熵 | 2024/09/30done | 凤栖 | 否 |\n| 2 | 短期：修改huc_corehost、hotel_buyhost分组对圈人调用由非核心修改成核心分组 | 千尽 | 2024/10/17 | 名龙 | 否 |\n| 3 | 短期：添加比价用户黑名单不进行数据库查询 | 惺沉 | 2024/09/28done | 破势 | 否 |\n| 4 | 短期：增加省钱卡判断接口整体限流 | 惺沉 | 2024/10/10done | 破势 | 否 |\n| 5 | 短期：去掉滥用的标签人群的调用   | 雅净 | 2024/10/18 |  | 否 |\n| 6 | 短期：优化省钱卡判断逻辑强制走索引减低慢sql出现概率 | 惺沉 | 2024/10/12done | 破势 | 否 |\n| 7 | 短期：加入缓存策略降低回源查询DB的量级 | 惺沉 | 2024/10/12done | 破势 | 否 |\n| 8 | 短期：会员侧和业务确认是否日常可开启缓存**结论：**跟业务确认日常可以开启缓存并且现在无省钱卡用户也读缓存 | 惺沉 | 2024/10/12done | 破势 | 否 |\n| 9 | 短期：会员侧增加日常的流量增长的预警监控 | 惺沉 | 2024/10/30 | 破势 | 否 |\n| 10 | 短期：会员侧数据库相关的预警阈值调整 | 惺沉 | 2024/10/30 | 破势 | 否 |\n| 11 | 长期：酒店搜索->诸葛->会员的链路分析，降低调用量**10.11故障处理群内同步：**上午会员流量来源问题已经梳理清楚（调用链路：行业->诸葛->会员）：从6月到目前，行业侧调用诸葛的流量没有增加，但是在6月20号、8月1号、8月16号，诸葛调用会员接口均有一个徒增，跟@唐诗(破势) 联合排查之后，是业务配置暑促圈人导致，所以本身行业侧流量没有增加，但是流量结构有变化，导致到下游的调用链路有变化，目前先联系业务看下暑促的几个圈人配置是否还有需要，如果不需要，先下线掉，后面通过会员会及时感知核心接口的流量变化   | 雅净 | 2024/10/11done |  | 否 |\n\n\n## 七、故障定级&定责&故障分自查\n【故障等级】P4\n\n【故障责任方】飞猪-飞猪技术部-平台技术-会员&玩法平台\n\n责任人：惺沉\n\n测试责任人：破势\n\n【故障分】_/* 以系统计算结果为准*/_\n\n| **  系统质量（30%）** | | | | | **处置能力（70%）** |\n| --- | --- | --- | --- | --- | :---: |\n| **相关方** | **需求设计** | **代码质量** | **变更质量** | **自定义项** | **发生时间** | **发现时间（30%）** | **恢复时间（40%）** |\n| 飞猪-飞猪技术部-平台技术-会员&玩法平台 | 否 | 否 | 否 | 慢SQL、未及时感知流量变化 | 09-27 00:03 | 09-26 23:56 | 09-27 00:07 |",
    "chunk_order_index": 5,
    "full_doc_id": "doc-197f302fa55cded8d66c12ea390cc345"
  },
  "chunk-06cd04a2431cf2826f9f1cb61642d522": {
    "tokens": 92,
    "content": "定义项** | **发生时间** | **发现时间（30%）** | **恢复时间（40%）** |\n| 飞猪-飞猪技术部-平台技术-会员&玩法平台 | 否 | 否 | 否 | 慢SQL、未及时感知流量变化 | 09-27 00:03 | 09-26 23:56 | 09-27 00:07 |",
    "chunk_order_index": 6,
    "full_doc_id": "doc-197f302fa55cded8d66c12ea390cc345"
  },
  "chunk-27aae3573bf5666f09f668120c27eeca": {
    "tokens": 1200,
    "content": "## 一、故障简述\n2024年9月19日 20:11监控预警国内/国际OFFER链路预定成功率下跌，影响国内/国际机票预定，故障原因初步确认是压测引发自营agent-flight-buy机器挂掉导致，于20:23通过停止压测完成止血，故障恢复，根据监控下跌幅度判定达P4故障等级。\n\n## 二、影响产品线及影响面\n- [x] 是否影响可用性：否\n- [x] 业务影响：\n+ offer链路预定成功率下跌，国内国际机票预定失败，影响持续时间15分钟（20:08-20:22），触发P4。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/83132/1726908130616-d933824f-7347-4f58-8e36-bac3ae0c93d7.png)\n\n+ 国内机票出票成功量下跌：20:12-20:21持续10分钟成功量下跌幅度>30%，触发P4\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/41240/1727232050368-cb04fcc1-5923-4ce9-95a9-6364a0041457.png)\n\n+ 交通辅营转交易下跌：20:09-20:16成功量下跌幅度>20%  未触发故障\n+ 国内机票交易下跌（包含创建、下单）：未触发故障\n+ 国际机票订单详情页打开异常：未触发故障\n- [x] 是否有客诉：否\n- [x] 是否有社会舆情_：_否\n- [x] 是否产生资损：否\n\n## 三、故障过程回顾\n2024-09-19 19:51，飞猪交通内部开始双11摸底压测****\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/20856536/1726760164395-ef9acd1b-4d04-44ec-a000-f4403eff3779.png)![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/20856536/1726759798346-368c4506-c39e-47d8-a708-747f076c72fb.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/83132/1726908669898-22c7cbfa-25b1-4352-b9df-a8e928ce2d19.png)\n\n2024-09-19 20:05，HSF RT时间异常预警，此时开发并未关注到。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/41240/1727236468086-26949d3c-6468-44ae-84a8-4af5ed398591.png?x-oss-process=image%2Fformat%2Cwebp%2Fresize%2Cw_1044%2Climit_0)\n\n2024-09-19 20:09，国内/国际机票渲染/生单开始加压到目标10%**【风险注入】**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/83132/1726908328487-cdb09aaa-2082-4b77-9c0a-28199c95e199.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/20856536/1726759931439-2358efec-ed8a-415c-8d46-719b0e2eac4a.png)\n\n2024-09-19 20:11，监控开始报警**【故障发现】**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/83132/1726908828866-606fbd47-99fd-40f3-9953-a8023d6c8835.png)![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/20856536/1726760044190-b57e801a-2aa1-4832-9ade-c726ba4ae09f.png)\n\n2024-09-19 20:13，群内飞猪OFFER链路预定监控异常预警  \n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/41240/1727075290944-633f74a1-5ed6-4d57-81ab-61a61d22609d.png)\n\n2024-09-19 20:13，停止压测，成功率开始恢复**【业务响应】【初因定位】【恢复执行】**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/83132/1726909299841-6949d94d-9595-4462-8f52-4699aced0f06.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/83132/",
    "chunk_order_index": 0,
    "full_doc_id": "doc-b37726f1fcd54a646f201a87aeea2433"
  },
  "chunk-3d00bf4b3ad876a5426ccce25b6888cf": {
    "tokens": 1200,
    "content": "压测，成功率开始恢复**【业务响应】【初因定位】【恢复执行】**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/83132/1726909299841-6949d94d-9595-4462-8f52-4699aced0f06.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/83132/1726909648018-0fdc8a47-e2af-4855-b444-59ef754a7558.png)\n\n2024-09-19 20:15，飞猪虚拟商品支付成功率统计&国内机票_提交订单出现异常预警\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/41240/1727076804322-b2589288-8a9f-4865-91d4-c34c5c1d7b33.png)![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/41240/1727076831253-4320ae51-9c1f-458a-a0c0-8e4e3bf6c802.png)\n\n2024-09-19 20:16，飞猪订单无线详情成功率出现异常预警\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/41240/1727076922890-d5113fe8-47e9-41db-899d-691d18099c14.png)\n\n2024-09-19 20:16，监控未完全恢复，进行doubleCheck，发现国际机票压测脚本，2个机房只停了1个。20:18发现后立即停止另1个。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/83132/1726910311343-81fccf87-5dc2-481f-be3b-557f073387f0.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/83132/1726910462641-3369177b-8598-41ef-9269-3e6df3e218c9.png)\n\n2024-09-19 20:18，飞猪供销票号回填出现异常预警\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/41240/1727076943529-fdbf4826-e939-4aba-8168-0824bbf998f3.png)\n\n2024-09-19 20:18，OFFER链路预定监控成功率持续10分钟低于70%（20:09-20:19），触发P4**【故障发生】**![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/41240/1727076682593-b2a6ef1f-8170-4e91-8e92-69fc65523a75.png)\n\n2024-09-19 20:22，自营应用agent-flight-buy开始扩容，扩容到10台机器\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/20856536/1726761943786-f2d7b126-032c-400f-9f4a-97dfb68c91c7.png)\n\n2024-09-19 20:23，监控陆续恢复至正常水位。**【故障恢复】**\n\n## 四、故障原因\n### 4.1【背景说明】\n本次故障由压测触发，压测公告：[https://tr.alibaba-inc.com/orm/announcement/25831](https://tr.alibaba-inc.com/orm/announcement/25831)\n\n故障时，压测的水位为：\n\n| **场景** | **双11目标qps** | **9.19目标qps** | **实际压测qps** |\n| --- | --- | --- | --- |\n| 国际机票渲染&异步（供销） | 1000 | 120（日常峰值3倍） | 12 |\n| 国际机票生单（供销） | 350 | 40（日常峰值4倍） | 4 |\n| 国内机票渲染&异步 | 1000 | 350（日常峰值2倍） | 35 |\n| 国内机票生单 | 350 | 60（日常峰值3倍） | 6 |\n| 国内机票详情页 | 240 | 120（日常峰值2倍） | 24 |\n| 国际机票详情页 | 180 | 70（日常峰值2倍） | 14 |\n\n\n国内&国际生单核心调用链路为：wft-flight->flybuy->flytp->flybp->**agent-flight-buy, **验座/验价/预定都强依赖agent-flight-buy。\n\n订单详情的核心服务提供者为：flyorder，如果是退票订单：**flyorder->flyrp->agent-flight-buy,**\n\n如果是改签过的订单：**flyorder->flyrp-->flycp-->agent-flight-buy**\n\n### 4.2【原因分析】\n##### 一句话原因：\n因同时压测订单详情和生单，订单详情",
    "chunk_order_index": 1,
    "full_doc_id": "doc-b37726f1fcd54a646f201a87aeea2433"
  },
  "chunk-662b1fc7c09f94f6be94688778f9d5ce": {
    "tokens": 1200,
    "content": "->**agent-flight-buy, **验座/验价/预定都强依赖agent-flight-buy。\n\n订单详情的核心服务提供者为：flyorder，如果是退票订单：**flyorder->flyrp->agent-flight-buy,**\n\n如果是改签过的订单：**flyorder->flyrp-->flycp-->agent-flight-buy**\n\n### 4.2【原因分析】\n##### 一句话原因：\n因同时压测订单详情和生单，订单详情会查询退改信息，退改查询自营真实供给/出票渠道信息, agent-flight-buy应用查询DB流量增长，数据库连接池被打满（4台机器）。\n\n线上正常业务请求预定成功后，数据持久化时失败，转换的BookInfoPO插入DB失败一直在内存里导致频繁GC，最后导致机器挂掉。\n\n##### 根因分析：\n###### 自营应用agent-flight-buy机器数量不足关注点1\n压测开始前自营应用agent-flight-buy只有4台机器，压测期间系统负载过高，HSF线程池被打满，数据库连接池4台机器全部被打满。\n\n![agent-flight-buy压测时机器数](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/20856536/1727170314777-dec72126-2fe8-40c5-9919-47d029581b7d.png)\n\n![压测期间机器单机负载](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/20856536/1726762482932-b3455789-a991-4783-b9cd-72b01a24578b.png)\n\n###### 数据库连接占满的主要原因：查询入口方法调用量上涨明显，和订单详情压测有关系\n压测国际订单详情时退改域会大量调用自营的查询com.alitrip.agent.business.flight.buy.client.supply.SupplyInfoQueryAppService#queryAgentOrders**关注点2**，该接口会进行DB查询，压测期间该接口调用量较日常上涨明显，加上机器不足导致数据库连接占满。\n\n![查询接口调用量压测期间上涨明显](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/20856536/1726763783360-6a07edb7-1d9b-46c5-95ff-9069f571e02c.png)\n\n订单详情压测的数据分布：共15个订单，3个退，2个改。8点05分时，订单详情压测流量为38QPS，1/3的流量会查询自营agent-flight-buy，到agent-flight-buy的流量增长约为（33-18 + 21-10 =26qps）。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/83132/1727068115401-fa3f242f-6bed-4dc0-b9f9-4cf63c35a339.png)\n\n![退改调用自营查询QPS上涨明显](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/83132/1727067934201-e531b664-a0c0-41a5-be63-4e17b8a8ed88.png)\n\n![自营出现大量查询DB和写入DB异常](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/20856536/1726763192447-e2a65c5f-2800-4896-844f-28b73599a4eb.png)\n\n![异常原因](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/20856536/1726763300392-7dacff14-13be-44e0-9ef7-ce07399f29ec.png)\n\n![DBA答疑](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/20856536/1727167117405-50307d9f-2426-497f-8399-8c5558aae76c.png)\n\n![压测期间自营Top5 QPS](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/20856536/1726800914431-0eadc0ae-1571-4e16-bd9d-dd29c3214956.png)\n\n###### 写入DB异常\n压测时大量聚合在持久化时失败，转换的BookInfoPO插入DB失败一直在内存里导致频繁GC。一部分原因是查询接口占满了数据库连接池；另一部分原因是压测时使用同一个session_id重复验价、预定（去年是这样压测，只是去年压测前关了换货**关注点3**）会对本地BookInfo无限增加备货，验价时根据session_id缓存tair，询到备货就存入BookInfo会导致该实体无限扩大，预定时根据session_id读取tair然后预定完成将BookInfoPO后写入DB，BookInfoPO过大导致写入缓慢。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/20856536/1726765848253-6fef0cab-b67d-4581-9b3d-0459e58959ac.png)\n\n## 五",
    "chunk_order_index": 2,
    "full_doc_id": "doc-b37726f1fcd54a646f201a87aeea2433"
  },
  "chunk-a9b36e36dea0423931bd6711082d1bbe": {
    "tokens": 1200,
    "content": "Info会导致该实体无限扩大，预定时根据session_id读取tair然后预定完成将BookInfoPO后写入DB，BookInfoPO过大导致写入缓慢。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/20856536/1726765848253-6fef0cab-b67d-4581-9b3d-0459e58959ac.png)\n\n## 五、关注点分析\n###### 关注点1：压测的时候线上只有四台机器，是否符合大促期间正常的机器数量，在评估范围内吗？\n**问题总结：**9月14号和组内双十一负责同学粗略评估过agent-flight-buy双十一大促期间需要扩容的数量暂时上报了10台。9月15号中秋假期第一天线上国际订详查询有问题自营手动从4台扩容至14台**（手动扩容后弹性扩容被自动关闭）**。9月18号压测前检查了自营机器14台数量符合预期。9月19号下午组内其他同学进行了手动缩容从14台缩回4台，晚上压测前疏忽没有检查机器数量，导致压测时机器数量严重不符，且弹性扩缩容由于之前手动扩容后被自动关闭，导致在压测时应用本身没有自动扩容应急机制。\n\n![agent-flight-buy机器变化曲线](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/20856536/1727176694161-c79d5f62-0579-42c5-8ea0-c77b6b73d456.png)\n\n**改进点：**压测前、大促前、节假日前需要充分评估当前机器数量是否能满足需求，事前及时扩容。以及组内同学进行核心应用的手动扩缩容和开启/关闭弹性扩容时，都应该在团队群内及时与大家同步，避免产生不必要的信息差。后续以案例宣导的方式进行同步，包括在双11项目组内同步。[@馬达](undefined/majingda.mjd)\n\n###### 关注点2：订单详情退改签调用agent-flight-buy接口是否合理？\n**问题总结：**国际订详调用本身是不合理的（国内订详无此情况），且该问题于中秋假期第一天时暴露，在19号压测前未做限流处理且未评估到压测时会受影响，导致问题放大。\n\n**改进点：**自营目前已对该接口做了限流处理，且退改域也对该不合理调用进行了优化，在23号重新压测时该场景没有问题。\n\n###### 关注点3：去年压测的时候关闭了换货，为何今年没有关闭？如果是想对换货场景也进行压测，那是否有提前评估到BookInfoPO过大的问题？\n**问题总结：**今年国内加入了多端换货，换货量相较去年有所提升，想借今年双十一压测来检验换货是否能承受双十一流量，于是今年打开了压测换货开关。但在压测前自营没有评估到压测脚本重复sessionId调用生单会引发BookInfoPO无限膨胀的问题，只评估了正常验座、验价、预定是否会有sessionId幂等导致压测失败。（线上真实流量不会有重复sessionId反复调用生单）\n\n**改进点：**有额外的域内压测场景需求需要和总压测负责人及时同步，并评估相关风险，调整压测目标。同时针对压测特殊定制化场景（如重复sessionId生单），需要仔细考虑所有压测场景下是需要特殊改造以及是否有系统风险。\n\n###### 关注点4：为何20:11就监控就预警了，但是20:22才开始扩容机器？\n**问题总结：**20:11监控预警，查询系统日志排查后发现是压测影响（当时并没有意识到agent-flight-buy只有4台机器），于20:13在压测群内和线上会议紧急叫停压测，但压测没有完全停止机器也没有完全恢复，自营花了大量时间排查为何没有恢复，等到20:20不见好转准备重启高负载机器时才发现线上只有4台机器，随后才开始紧急扩容机器。\n\n**改进点：**对于压测期间出现问题时，处理问题方式需要改进，没有及时止血、扩容和重启问题机器。且当发现系统负载一旦开始无限升高时应该提前叫停压测，要对预期承受负载留有余量，而是不是等到机器扛不住时才叫停压测和扩容。\n\n###### 关注点5：第一次停止压测的时候没有完全恢复故障，是因为压测没有完全停止，后续这种情况要如何避免？\n**问题总结：**共14个压测场景，9个脚本，2人执行，在操作国际机票渲染生单脚本，停止时没有注意是按机房停止的，还是按整体停止。一开始也是口头进行确认已经停止，后来发现监控未恢复，进行二次check发现只停了一个机房",
    "chunk_order_index": 3,
    "full_doc_id": "doc-b37726f1fcd54a646f201a87aeea2433"
  },
  "chunk-5cd73072dd879cd78d449e5622f0272f": {
    "tokens": 1085,
    "content": "测的时候没有完全恢复故障，是因为压测没有完全停止，后续这种情况要如何避免？\n**问题总结：**共14个压测场景，9个脚本，2人执行，在操作国际机票渲染生单脚本，停止时没有注意是按机房停止的，还是按整体停止。一开始也是口头进行确认已经停止，后来发现监控未恢复，进行二次check发现只停了一个机房。\n\n**改进点：**压测时线上出问题应立即停止压测，操作停止压测后需要进行doubleCheck：1、确认所有的场景/机房都已停止。2、通过监控check压测流量是否已经消失。另外新人较多，建议压测、大促等重要场景要做到老带新。\n\n### 5.1【系统质量】\n#### 5.1.1 需求&设计评估\n**〖关注点1〗****是否涉及产品、技术方案评估？此核心的问题是什么，如何改进？**\n\n- [ ] **是，涉及**\n    - [x] 需求评估遗漏\n    - [ ] 产品设计缺陷\n    - [ ] 系统架构设计缺陷\n        - [ ] 容错性不足 \n        - [ ] 单点，无冗余\n        - [ ] 缺乏自我保护\n        - [ ] 缓存设计不当\n        - [x] 容量评估不足\n        - [ ] 非幂等设计\n        - [ ] 强弱依赖不合理\n        - [ ] 其他：__________\n- [ ] 否，不涉及\n\n**〖问题总结〗**压测前没有对应用机器进行合理评估；压测脚本涉及相同session_id验价、预定，没有对换货场景进行评估。\n\n**〖改进点〗**压测前充分评估系统负载水平，并在压测前及时扩容做好相关预案。压测前评估压测脚本和压测场景与现有系统链路是否存在兼容问题。\n\n#### 5.1.2 代码质量--不涉及\n#### 5.1.3 变更质量--不涉及\n### 5.2【处置能力】\n#### 5.2.1 故障发现&响应\n+ **是否监控发现**\n    - [x] 故障触发方 监控发现\n    - [x] 故障受影响方 监控发现\n    - [ ] 否，原因为：（监控无效/监控缺失）\n+ **是否5分钟内响应**\n    - [x] 是\n    - [ ] 否，原因为：\n+ **是否存在应急协同问题**\n    - [ ] 是\n        - [ ] 应急流程不明确（无流程或者流程不清晰、应急相关角色&职责不明确，缺失一号位等)\n        - [ ] 应急执行不到位（有流程，但未按流程执行，通告发送不及时，响应不及时等）\n    - [x] 否\n\n#### 5.2.2 故障定位&恢复\n+ **主要恢复方式：**\n    - [ ] 代码发布/回滚\n    - [ ] 配置发布/回滚\n    - [ ] 数据订正\n    - [x] 机器隔离/重启/扩容\n    - [ ] 配置限流\n    - [ ] 预案降级\n    - [ ] 自动恢复\n    - [x] 其他：停止压测\n\n**〖关注点1〗定位&恢复阶段存在什么问题？是否可以增加预案，****有更快的恢复方式？****相关的优化改进？**\n\n**〖问题总结〗**从故障发现到故障定位时间较长，无应急预案，没有及时进行应用扩容止血。\n\n**〖改进点〗**提前准备好应急预案，发现故障第一时间先止血，迅速扩容和重启问题机器。\n\n## 六、故障Action\n| **序号** | *******Action** | *******负责人** | *******计划完成时间** | **是否keyAction** |\n| :---: | --- | :---: | :---: | --- |\n| 1 | 短期：订单详情退票flyrp调自营agent-flight-buy查询真实供给/出票渠道屏蔽 | 心墙 | 9.23done |  |\n| 2 | 短期：订单详情改签flycp调自营agent-flight-buy查询真实供给/出票渠道屏蔽 | 陌华 | 9.20done |  |\n| 3 | 短期：自营agent-flight-buy限流配置优化，压测前准备好预案和机器扩容，压测时盯紧监控 | 翱速 | 9.27 | 是 |",
    "chunk_order_index": 4,
    "full_doc_id": "doc-b37726f1fcd54a646f201a87aeea2433"
  },
  "chunk-3d046e759c06d6f52c1a84cc9a8322c7": {
    "tokens": 1200,
    "content": "## 一、故障简述\n  2024-09-03 11:19 淘宝联盟法项目发布过程中配置项发布造成淘宝联盟引擎详情服务失败，进而导致淘宝联盟订单创建量下跌、淘宝主站订单创建量下跌 4%左右。11:20 接到线上报警，龙宝排查处理，11:22 开始回滚，11:28 完成回滚、服务恢复，11:30 左右淘宝联盟和淘宝主站的订单创建基本恢复。\n\n## 二、故障过程回顾\n| **时间轴** | **事件** |\n| --- | --- |\n| 2024-09-03 11:19 | **【故障注入】**超链项目发布过程中，发布 diamond ([contextToProductMap](https://mse.alibaba-inc.com/sh/diamond/configlist/configdetail?dataId=contextToProductMap&group=union-mic&namespaceId=union-mic&tab=content))，JSON 格式的配置里新增 campaignType（即：计划类型 12） 和 productType（即：营销产品类型 34）的映射。 |\n| 2024-09-03 11:20 | **【故障发生】【故障响应】**突发大量报警：引擎团队的商品详情聚合服务查询佣金成功率跌至 0. 龙宝开始排查.淘系交易开始下跌3%以上。![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/12771/1725936490383-5752f114-91d6-41c4-9b0e-d1d93a9e4d8a.png) |\n| 2024-09-03 11:22  | **【恢复执行】**排查发现相关服务报错原因是配置变更，开始回滚 diamond 配置 |\n| 2024-09-03 11:28 | 回滚完成 |\n| 2024-09-03 11:30 | **【故障恢复】**交易指标恢复至日常水位![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/12771/1725936575935-3b9ed677-c82f-4cbf-b4e3-7f577600d6dc.png) |\n\n\n## 三、故障原因\n### 3.1【背景说明】\n#### 【需求背景】\n:::tips\n淘宝联盟和百亿补贴合作，引进百亿补贴供应商出资，淘宝联盟下行，扩大百亿补贴商品销量、也为联盟带来增长。“百亿补贴超链活动”作为新的营销产品类型，需要导购和交易域感知。和本次故障相关的变更内容是**联盟营销计划**到**联盟营销产品**的映射关系。详见 [prd](https://alidocs.dingtalk.com/i/nodes/a9E05BDRVQRkezKGCjkxM6m2J63zgkYA?iframeQuery=utm_source%3Dportal%26utm_medium%3Dportal_star)。\n\n:::\n\n#### 【业务链路】\n:::tips\n营销中心团队承接广告主出价表达并存储其数据资产，直接对联盟引擎详情系统、联盟交易系统提供广告主出价查询服务。引擎详情服务又为各导购场景提供广告物料查询服务，导购的：二合一、转链（从站外跳转到站内详情引流）。\n\n:::\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/252919/1726035709961-1aa94a06-9136-48e6-b90d-a79bb027d01d.png)\n\n### 3.2【原因分析】\n#### 一句话原因：\n:::tips\n导致配置发布顺序有误，正常应该是 广告单元查询服务（应用）先于配置发布，由于发布顺序评估无问题，导致配置值先发后由于后端代码还未发布导致异常。\n\n:::\n\n#### 根因分析：\n:::tips\n上游应用首先从下游 client 的工具类里获取要查询的 productType 列表，然后带着参数查询佣金。配置引入了线上代码没有的 productType，佣金查询服务参数校验失败。配置内容如下：\n\n:::\n\n#### 配置详情：\n```json\n{\n  \"1\": {\n    \"default\": {\n      \"productTypes\": [\n        2\n      ],\n      \"desc\": \"通用计划产品类型\"\n    }\n  },\n  \"3\": {\n    \"default\": {\n      \"productTypes\": [\n        1,\n        3,\n        23,\n        30\n      ],\n      \"desc\": \"营销计划全局公开类型的产品类型列表\"\n    },\n   ......\n    \n  \"12\":{\n    \"default\": {\n      \"productTypes\": [\n        34\n      ],\n      \"desc\": \" 超链活动产品类型\"\n    }\n  }\n}\n```\n\n## 四、故障关注点\n#### 1、变更过程\n**〖关注点1〗****变更是否有经过测试？为何未发现？**\n\n:::tips\n**〖问题总结〗**核心是发布顺序评估失误，预发环境验证时由于代码已在预发，所以未发现问题。\n\n**〖改进点〗**线上发布顺序问题，预发测试如果想前置发现：则",
    "chunk_order_index": 0,
    "full_doc_id": "doc-e07a545db3cf20e68118e23b84a5da22"
  },
  "chunk-8e30ba756e1926df2d0f877ec0ee3be9": {
    "tokens": 1200,
    "content": "}\n}\n```\n\n## 四、故障关注点\n#### 1、变更过程\n**〖关注点1〗****变更是否有经过测试？为何未发现？**\n\n:::tips\n**〖问题总结〗**核心是发布顺序评估失误，预发环境验证时由于代码已在预发，所以未发现问题。\n\n**〖改进点〗**线上发布顺序问题，预发测试如果想前置发现：则需要把发布计划在预发预验证一遍，但这个成本很高（资源、人力成本纬度综合考虑），待评估。\n\n:::\n\n__\n\n**〖关注点2〗****灰度节奏是怎样的？是否灰度过程中发现问题？**\n\n:::tips\n**〖问题总结〗** \n\n_** SPE环境的灰度过程：**_\n\ndiamond 配置发布的安全生产环境只会把配置推送给当前发布应用的 SPE 机器。而我们这里的 diamond 主要是在上游客户端里使用的。后续推进 diamond 配置推送安全生产环境时包含所有监听系统。\n详见：[Aone工单流程](https://aliyuque.antfin.com/softloadblance/wpnllg/el2pl8)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/252919/1725595882980-5d6eafea-1f42-4add-86c6-541828ce3c14.png)\n\n_** 线上环境的灰度过程：**_\n\n线上有分4批，整个持续过程1分钟，业务特性如果时间太久会导致资损。所以整个过程过程较短。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/12771/1726044996418-ba6e9e5d-2372-4b89-ad1a-c54b47b3e355.png)\n\n广告有自己的变更规范，但变规范要求不能低于通用规范要求。通用规范要求如下：\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/12771/1726045634702-777f3185-e085-4f2d-9238-5be4ce53fec8.png)\n\n**〖改进点〗**变更规范注意事项，联盟带回综合评估后每批次观测时间。\n\n联盟备注：在没发生903问题之前：由于佣金接口的配置发布会导致算佣出现错误，从而导致媒体看到的佣金多但拿的少（媒体资损） Or 媒体看的少拿的多（商家资损）：故在这个现状下，我们和联盟的变更管控负责人聊，决定这里的观测时间尽快。但903问题后会重新审视这部分的合理性：综合对集团的影响取其轻。\n\n:::\n\n####  2、应急处置\n**〖关注点1〗****系统监控发现能力？**\n\n:::tips\n**〖问题总结〗**\n\n** **_**联盟侧**_** ****：**有监控发现，监控告警后立即介入处理\n\n** **_**交易侧**_** ****：**交易侧有监控，但本次未有告警出来，主要原因为：为了避免误报，4种检测算法必须全判为异常才会报警，详见：[预警算法介绍](https://aliyuque.antfin.com/sunfire/manual/znvqy9)，故障当时时间余弦相似度检测都没判为异常，所以，整体检测是通过状态，具体可以看下面截图，说明了这个情况：\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/jpeg/12771/1725952111649-72787477-c59d-485f-a1cb-b11d791304e4.jpeg)\n\n交易当前配置的规则是环比，_**这个是否需要调整？**_\n\n交易故障级别较高，对于监控准确性要求就高，所以是智能基线、xflush自身告警规则相结合的方式，暂时不用调整。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/12771/1725952740240-1275465b-7895-4c48-8767-d9302c5731c7.png)\n\n**〖改进点〗**暂无\n\n:::\n\n**〖关注点2〗****整个故障恢复是否有可提升空间？**\n\n:::tips\n**〖问题总结〗**从整个故障处理过程来看，定位及恢复过程均很快，联盟内部会梳理下上下游的依赖及降级方案。\n\n**〖改进点〗**\n\n**  短期：**梳理团队核心服务的上游依赖的降级方案，明确降级或容灾方案\n\n**  长期：**通过该问题联盟侧发现：集团交易的高可用故障标准要求高于联盟（包括妈妈），对方的P2大概是联盟的P4，如果要达到集团交易的标准，则对当前技术团队在系统稳定性上的要求更高，需要当前联盟导购全链路系统的初步摸排情况来看。\n   本次双11之前联盟需要基于整体导购链路review一遍：以无论联盟出现什么问题-从联盟导购->集团详情的链路不可挂",
    "chunk_order_index": 1,
    "full_doc_id": "doc-e07a545db3cf20e68118e23b84a5da22"
  },
  "chunk-ed299e7836be1c02f8ba012cf0293e2f": {
    "tokens": 1200,
    "content": "用故障标准要求高于联盟（包括妈妈），对方的P2大概是联盟的P4，如果要达到集团交易的标准，则对当前技术团队在系统稳定性上的要求更高，需要当前联盟导购全链路系统的初步摸排情况来看。\n   本次双11之前联盟需要基于整体导购链路review一遍：以无论联盟出现什么问题-从联盟导购->集团详情的链路不可挂or不低于xx%（这里的xx对标集团交易的高可用标准做换算），由于双11业务倒排较多，当前梳理ING，具体节奏待排。\n\n:::\n\n#### 3、其它\n**〖关注点1〗****系对于系统无法识别的配置项是否可以做兜底处理？**\n\n:::tips\n**〖问题总结〗**工具类中获取配置的逻辑里需要兼容配置先发布的情况，当配置里包含系统无法识别的部分时，暂不使用部分配置\n\n**〖改进点〗**有优化佣金查询基础服务\n\n:::\n\n## 五、故障Action\n_/* 填写说明：Action制定原则*/_\n\n> _机制流程建议不超过总数的20%；_\n>\n> _Action数量建议不超过10条；_\n>\n> _短期Action建议1-2周内完成，并内部验收（如缺陷修复、监控等避免故障再发的的措施需列为短期Action）；_\n>\n> _P1P2需至少有1个keyAction（治本Action，从根源上避免类似重大故障再发生/控制爆炸半径）；_\n>\n> _Action描述须完整、语言简洁，一目了然。_\n>\n\n| **序号** | *******Action标题** | *******负责人** | *******计划完成时间** | **Action描述** | **验收标准** | **验收人** | **是否keyAction** | **是否回血Action** |\n| --- | --- | --- | --- | --- | --- | --- | --- | --- |\n| 1 | 短期：优化佣金查询基础服务 | 龙宝 | 10.08 | 工具类中获取配置的逻辑里需要兼容配置先发布的情况，当配置里包含系统无法识别的部分时，暂不使用部分配置 | 线上验证 | 漫雪 | 否 | 否 |\n| 2 | 短期：梳理团队核心服务的上游依赖的降级方案 | 龙宝 | 09.30 | 梳理团队核心服务的上游依赖的降级方案，明确降级或容灾方案 | 文档 | 漫雪 | 否 | 否 |\n\n\n## 六、故障总结反思\n**【做得好的】**\n\n:::tips\n1. 监控报警了发现问题，发现时间远早于客诉\n2. 问题处理速度较快\n3. 上下游协同一致\n\n:::\n\n**【经验教训】**\n\n 举一反三，学习，避免踩坑\n\n:::tips\n1. 核心服务设计和实现时要充分考虑系统兼容性\n2. 核心服务对强依赖最好能有降级预案\n3. 基于安全生产环境当前的问题：要自行保障全链路可用，最小代价、最早时间发现问题【安全生产环境问题导致-安全生产环境发现不了该问题】\n4. 复杂项目和核心依赖：希望做好预发基于发布计划的事前冒烟->待评估成本！\n\n:::\n\n## 七、影响产品线&影响面\n| **受影响业务** | **等级** | **影响说明** |\n| --- | --- | --- |\n| 淘宝交易 | P2 | - [ ] 是否影响可用性：否- [x] 业务影响：淘宝交易创建11:20开始下跌，11:30恢复；成功率与基线比最高下跌7.82%![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/12771/1725952399993-d399be2f-6720-4be5-8922-89dc73df1d36.png)- [ ] 是否有客诉：否- [ ] 是否有社会舆情：否- [ ] 是否产生资损：否 |\n| 联盟 | P4 | - [ ] 是否影响可用性：否- [ ] 业务影响：否- [ ] 是否有客诉：否- [ ] 是否有社会舆情：否- [x] 是否产生资损：是      同比 0902 日，在 2024-09-03 11:19:00 到2024-09-03 11:30:00 期间，淘宝联盟付款订单数减少约 7w 笔（子订单维度），占比全天付款笔数约 0.35%。![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/252919/1725370138051-7c3250c3-6734-4c89-99c6-056a52391ada.png?x-oss-process=image%2Fformat%2Cwebp%2Fresize%2Cw_1500%2Climit_0%2Fresize%2Cw_1500%2Climit_0) |\n\n\n## 八、故障定级&定责",
    "chunk_order_index": 2,
    "full_doc_id": "doc-e07a545db3cf20e68118e23b84a5da22"
  },
  "chunk-7b89d3b0c01193c68640dfe12a49e8dc": {
    "tokens": 409,
    "content": "/2024/png/252919/1725370138051-7c3250c3-6734-4c89-99c6-056a52391ada.png?x-oss-process=image%2Fformat%2Cwebp%2Fresize%2Cw_1500%2Climit_0%2Fresize%2Cw_1500%2Climit_0) |\n\n\n## 八、故障定级&定责&故障相关方\n【故障等级】P2  \n【故障责任方】无需定责\t_/* P1故障必填，非P1故障可不填*/_  \n【故障分】_/* 以系统计算结果为准*/_\n\n| ** 系统质量（30%）** | | | | | **处置能力（70%）** |\n| --- | --- | --- | --- | --- | --- |\n| **相关方** | **需求设计** | **代码质量** | **变更质量** | **自定义项** | **发生时间** | **发现时间（30%）** | **恢复时间（40%）** |\n| 业务技术-营销&交易技术-交易业务技术-交易前链路 | N  | N  | N  |  | 2024-09-03 11:20 | 不涉及（此次有监控，但是未触发智能监控告警规则） | 恢复能力不涉及2024-09-03 11:30 |\n| 用户平台&阿里妈妈事业部-阿里妈妈-联盟-联盟技术-营销中心 | N  | N  | N | 发布方案评估问题 | 2024-09-03 11:20 | 2024-09-03 11:20 | 2024-09-03 11:30 |\n\n\n  \n\n\n\n\n### \n## \n### \n####",
    "chunk_order_index": 3,
    "full_doc_id": "doc-e07a545db3cf20e68118e23b84a5da22"
  },
  "chunk-89c095c2f6c842ae9830a06c31202a6f": {
    "tokens": 1200,
    "content": "## 一、故障简述\n2024-09-20 08:59，资产系统管理员反馈资产系统员工侧无法打开。原因定位是 EI 监控脚本改造升级变更导致，于9:40，回滚代码恢复。\n\n## 二、故障过程回顾\n### 2.1【故障处理时间线】\n2024-09-10 20:56，EI 监控脚本改造升级，部署的 1.0.5 分支包含了有问题的代码，当时在 EI 员工灰度阶段已发现该问题，发现后第一时间回滚到了 1.0.4 版本，但主干未回滚，上述代码已合并到主干。**【故障引入】**\n\n2024-09-19 21:29，部署的 1.0.6 分支从主干拉取，包含了上述问题代码（本地修改了未保存），并扩大了灰度范围，导致该问题再次在线上发生。****\n\n2024-09-20 08:59，资产系统管理员反馈资产系统员工侧无法打开。**【故障发现】【故障发生】**\n\n2024-09-20 08:59～09:17，资产开发复现问题，进行初步定位，定位为 EI 监控脚本**。****【故障响应】【初因定位】**\n\n2024-09-20 09:26，开始对 EI 监控脚本 的变更进行回滚操作。**【恢复执行】**\n\n2024-09-20 09:27，有数工作台页面发现同样的问题。\n\n2024-09-20 09:40，回滚完成，受影响的页面恢复正常。**【故障恢复】**\n\n\n\n## 三、故障原因\n### 3.1【背景说明】\n背景：\n\nEI 各产品的主要页面都引入了统一的监控脚本，该脚本近十年的增量迭代导致代码文件越来越大、依赖版本过旧且不可维护。为了及时响应业务的诉求，降低维护成本，发起了对 EI 监控脚本的升级改造。\n\n改造的内容包括：\n\n1. AEM SDK 从 1.x 升级到 3.x，后续定期同 AEM SDK 的更新同步\n2. 内置 Aplus 切换到新内核，从 WS 通道切换到 POST 通道\n3. 通过新的实现方式兼容历史 API，部分废弃 API 使用空方法替代\n4. 减小加载资源的体积，部分模块按需动态加载\n\n该改造预期对业务无感，已通过钉钉知会到各业务接口人，同时也通过安全生产公告邮件通知到了所有相关方。\n\n\n\n### 3.2【原因分析】\n一句话原因：\n\nEI 监控脚本改造升级，变更将 window.AES 变量设置成了只读，后续业务代码中如果有尝试修改该变量，会抛异常，导致业务逻辑中断。\n\n\n\n根因分析：\n\nEI 监控脚本的变更将 window.AES 变量设置成了只读（原意是为了防止外部代码侵入导致监控脚本本身报错），后续业务代码中如果有尝试修改该变量，会抛异常，导致业务逻辑中断。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/3750/1726838859628-782e204f-82f1-458d-88b8-fe988a5c0a80.png)\n\n\n\n## 四、关注点分析\n**〖关注点1〗9月19日 21:29开始灰度，问题到20号资产同学发现上报。期间监控是否有异常？灰度过程是否有观测，观测了哪些监控，灰度期间未发现问题原因**\n\n:::tips\n监控脚本本身增加了异常监控，未发现异常情况。\n\n灰度过程中观测了阿里内外、采购、欢行、绩效、会议室预定等产品的异常指标，未发现异常情况，未发现问题的原因是观测范围没有覆盖全（本次发现问题的页面均非 EI 主航道产品，业务本身也没有配置白屏监控）。\n\n\n\n改进点：\n\n1、核心应用加观测的异常指标。  ---已完成 曹柯\n\n2、 所有历史方法向上兼容最新版本   \n\n3、规范流程：全量发布完成 和 灰度出现问题 邮件通知各业务负责人。\n\n:::\n\n**〖关注点2〗****测试阶段未发现原因是什么？后续如何改进？**\n\n:::tips\n测试和第一阶段灰度过程中已发现该问题并第一时间进行部署回滚，但未回滚主干代码，而后续迭代的过程中又漏合了该问题的修复代码，导致在扩大灰度过程中同样的问题又重现。\n\n后续会在团队内强化安全生产规范的宣导，严格做到以下两点：\n\n1. 回滚部署但不回滚主干的情况下，需要第一时间修复主干代码，不能隔天； \n2. 灰度过程中发现的问题需要第一时间解决，解决后再扩大灰度范围，代码变更和扩大灰度范围不能同时操作。\n\n:::\n\n**〖关注点3〗资采系统和有数是否有配置监控告",
    "chunk_order_index": 0,
    "full_doc_id": "doc-1bec12703fbabc0211f6de19077ca38f"
  },
  "chunk-e647ad097461e9da8d3a1ff375b2e05a": {
    "tokens": 682,
    "content": "续会在团队内强化安全生产规范的宣导，严格做到以下两点：\n\n1. 回滚部署但不回滚主干的情况下，需要第一时间修复主干代码，不能隔天； \n2. 灰度过程中发现的问题需要第一时间解决，解决后再扩大灰度范围，代码变更和扩大灰度范围不能同时操作。\n\n:::\n\n**〖关注点3〗资采系统和有数是否有配置监控告警提前发现问题？**\n\n:::tips\n**资采系统：**\n\n资产系统是EI的主航道产品，也配置了白屏监控，资产平台问题现象是页面页头能打开，但是是一直loading状态，白屏监控识别不出。\n\n**有数：**\n\n有数系统不是EI的主航道产品，配置了AEM监控，由于AEM升级引发页面崩溃， 因此没有捕捉到白屏监控，本次通过人为访问发现\n\n:::\n\n**〖关注点4〗AEM出问题影响应用如何保障**\n\n:::tips\n核心应用对AEM  SDK 是强依赖  ，SDK变更影响上游业务做好通知，影响风险评估、变更频率评估重点判断\n\n:::\n\n## 五、故障总结反思\n**【做得好的】**\n\n第一时间回滚到正常版本\n\n**【经验教训】**\n\n1. 回滚部署但不回滚主干的情况下，需要第一时间修复主干代码，不能隔天；\n2. 灰度过程中发现的问题需要第一时间解决，解决后再扩大灰度范围，代码变更和扩大灰度范围不能同时操作。\n\n## 六、故障Action\n| **序号** | *******Action标题** | *******负责人** | *******计划完成时间** | **Action描述** | **验收标准** | **验收人** | **是否keyAction** |\n| --- | --- | --- | --- | --- | --- | --- | --- |\n| 1 | 短期：修复问题 | 正李 | 09-23  | 修复上述导致报错的问题，并重新开始灰度 | EI 所有站点可正常访问 | 曹柯 | 是 |\n| 2 | 短期：监控问题 | 曹柯 | 已完成 | 核心应用加观测的异常指标 |  |  |  |\n| 3 | 长期：安全生产规范宣导 | 曹柯 |  | 回滚部署但不回滚主干的情况下，需要第一时间修复主干代码，不能隔天；灰度过程中发现的问题需要第一时间解决，解决后再扩大灰度范围，代码变更和扩大灰度范围不能同时操作。 |  | | |\n\n\n## 七、影响产品线&影响面\n    - [x] 业务影响：\n        * 资产员工主页、有数工作台、饿了么E站 部分页面白屏不可用（09-20 08:59 ~ 09-20 09:40）\n        * 资产员工303人访问主页异常（8:43-9:40）",
    "chunk_order_index": 1,
    "full_doc_id": "doc-1bec12703fbabc0211f6de19077ca38f"
  },
  "chunk-a0d321cad7090cda76ff705406b0f07d": {
    "tokens": 1200,
    "content": "## 一、故障简述\n【P4】于2024-09-28 15:20收到反馈直播间异常闪退，15:46下线直播间新人礼退出挽留组件后故障恢复，期间客诉量65例，触达P4故障。\n\n## 二、故障过程回顾\n### 2.1【故障处理时间线】\n| **时间轴** | **事件** |\n| --- | --- |\n| 2024-09-28 15:20 | ‘直播闪退’预警卡片推送**【故障发生】【故障发现】** |\n| 2024-09-28 15:22 | 预警群拉起 |\n| 2024-09-28 15:26 | 行悟响应**【故障响应】** |\n| 2024-09-28 15:31 | 钉钉会议拉起 |\n| 2024-09-28 15:38 | 竹睿反馈mtop.tblive.growth.api.play.quitpop新人推挽接口报错**【故障定位】** |\n| 2024-09-28 15:39 | 橘宝操作下线【时长膨胀红包】组件 |\n| 2024-09-28 15:42 | 监控值班反馈：初步怀疑是变更导致，已经回滚，正在观察 |\n| 2024-09-28 15:46 | 下线直播间新人礼退出挽留组件后故障恢复**【恢复执行】【故障恢复】**![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256311/1728630346478-561ca2af-82e8-4d7b-8c89-ea4a9e0a0c6a.png) |\n| 2024-09-28 17:03 | 定位到和回滚的第一个变更【时长膨胀红包】组件无关，17:03-17:41重新上线该组件**** |\n\n\n### 三、故障原因\n### 3.1【背景说明】\n**【业务背景】**\n\n 用户进入直播间之后，若命中业务新人退挽规则，退出直播间会弹出退出挽留组件\n\n**【业务链路】**\n\n![画板](https://intranetproxy.alipay.com/skylark/lark/0/2024/jpeg/80256311/1728648658075-19b64c3f-171e-443b-bc3d-0b22e9bea09b.jpeg)\n\n+ 命中新人退挽规则的人群，会在本地缓存查询组件版本\n+ 压测数据构造通过content-livekit应用，content-livekit构造影子链路缓存查询组件版本的sql查询alive组件库同步db数据到影子链路缓存\n+ 线上真实链路由应用wideload通过定时任务，定时查询alive组件库同步db数据到tair中\n+ 为减少直播间对tair组件缓存qps调用次数以及优化缓存热点key，会将组件写入本地缓存\n\n### 3.2【原因分析】\n**一句话原因： **\n\n压测影子链路查询直播间组件版本的SQL返回的结果字段中缺失了deliveryType字段，导致压测影子链路写入的缓存对象污染了本地缓存，直播间退出挽留组件的deliveryType字段本应为“message”缺失后兜底成“default”，线上接口数据字段概率性返回错误导致闪退。\n\n**根因分析：**\n\n1、content-livekit构造影子链路缓存查询组件版本的sql返回的字段不完整，缺少deliveryType等字段，导致压测影子链路写入的缓存对象部分数据字段缺失\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/319358/1727515750814-f6ad1cab-774e-40fe-8e0e-ebec1c83e7d4.png?x-oss-process=image%2Fformat%2Cwebp%2Fresize%2Cw_808%2Climit_0)\n\n2、影子链路捞取的缓存污染了本地缓存\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/319358/1727516804110-3c6a1cd2-7c77-4626-bb79-0e5ad8679ec4.png)\n\n3、缓存数据存在缺失情况下，接口数据返回转化时如果没有deliveryType，会兜底成“常驻组件”，导致“退出挽留”组件从“消息组件”变成了“常驻组件”。 常驻组件客户端在进入直播间就触发组件加载。 相当于系统模拟触发了用户退出直播间的行为，展示了退挽浮层，用户关闭推挽后自动退出直播间。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/319358/1727515915093-f5969166-28e5-4737-8a0c-7039dddd80d9.png)\n\n## 四、关注点分析\n「关注点」：直播闪退是否有监控，监控是否有预警？\n\n:::tips",
    "chunk_order_index": 0,
    "full_doc_id": "doc-5d97463d29a44b2a4311ef44bb441a0b"
  },
  "chunk-dea234c48d76abc0ba1d2df1b838a1ca": {
    "tokens": 1200,
    "content": "挽浮层，用户关闭推挽后自动退出直播间。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/319358/1727515915093-f5969166-28e5-4737-8a0c-7039dddd80d9.png)\n\n## 四、关注点分析\n「关注点」：直播闪退是否有监控，监控是否有预警？\n\n:::tips\n当前无监控\n\n长期action：组件曝光基线监控 雪泽  11.30 \n\n:::\n\n「关注点」：组件请求处理过程中涉及本地缓存该链路是否为新上链路？\n\n:::tips\n链路无变化，历史就是该链路\n\n:::\n\n「关注点」：为什么本次压测出问题？\n\n:::tips\n926压测发现组件查询接口rt偏短  \n**压测表现**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/319358/1727517932714-a61d7e5d-8120-4f24-8f0e-bab586529570.png?x-oss-process=image%2Fformat%2Cwebp%2Fresize%2Cw_1404%2Climit_0)\n**线上表现**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/319358/1727517963655-8cfbce8b-31e2-495f-8fb8-7fc364377321.png?x-oss-process=image%2Fformat%2Cwebp%2Fresize%2Cw_1356%2Climit_0)\n**排查原因**\n\n+ 组件display接口可以指定部分组件跳过不处理，模拟旧版客户端请求的是老组件接口已经拿到了组件信息，在display时不需要二次查询。\n+ 为了确保线上和压测接口rt一致性，928压测过程中将部分组件从不请求的白名单中移除。\n0928压测变化点：\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256311/1728640780329-4edb5f93-715e-4217-8855-5c710bd6ecd0.png)\n\n:::\n\n「关注点」为何content-livekit构造的sql返回字段不完整？\n\n:::tips\n压测数据链路构造SQL历史存在，本次直接使用，不适配当前压测场景\n\n:::\n\n「关注点」wideload应用和content-livekit应用数据一致性后续如何保障？\n\n:::tips\n由content-livekit查询alive组件库同步db数据到影子链路缓存，改造成取线上缓存写到影子链路 已完成 沉沐\n\n:::\n\n「关注点」压测/线上本地缓存是否有隔离？\n\n:::tips\naction：压测流量与线上流量本地缓存隔离  沉沐 已完成\n\n:::\n\n「关注点」‘消息组件’兜底成“常驻组件”是否合理？\n\n:::tips\naction：1、检查各组件deliveryType字段是否都存在 1030 沉沐\n\n            2、组件兜底逻辑下线  1130 沉沐\n\n:::\n\n### 4.1【系统质量】\n#### 4.1.1 需求&设计评估----涉及\n**〖关注点〗****是否涉及产品、技术方案评估？此核心的问题是什么，如何改进？**\n\n- [ ] **是，涉及**\n    - [ ] 需求评估遗漏\n    - [ ] 产品设计缺陷\n    - [ ] 系统架构设计缺陷\n        - [ ] 容错性不足 \n        - [ ] 单点，无冗余\n        - [ ] 缺乏自我保护\n        - [ ] 缓存设计不当\n        - [ ] 容量评估不足\n        - [ ] 非幂等设计\n        - [ ] 强弱依赖不合理\n        - [x] 其他：影子链路缓存查询组件版本的sql未评估到不适配当前压测场景\n- [ ] 否，不涉及\n\n#### 4.1.2 代码质量----不涉及\n#### 4.1.3 变更质量-----不涉及\n### 4.2【处置能力】\n#### 4.2.1 故障发现&响应\n+ **是否监控发现**\n    - [ ] 故障触发方 监控发现\n    - [ ] 故障受影响方 监控发现\n    - [x] 否，原因为：（监控缺失）\n+ **是否5分钟内响应**\n    - [x] 是\n    - [ ] 否，原因为：\n+ **是否存在应急协同问题**\n    - [ ] 是\n        - [ ] 应急流程不明确（无流程或者流程不清晰、应急相关角色&职责不明确，缺失一号位等)\n        - [ ] 应急执行不到位（有流程，但未按流程执行，通告发送不及时，响应不及时等）\n    - [x] 否\n\n#### 4.2.2 故障定位&恢复\n+ **主要恢复方式：**\n    - [ ] 代码发布/回滚\n    - [ ] 配置发布/回滚",
    "chunk_order_index": 1,
    "full_doc_id": "doc-5d97463d29a44b2a4311ef44bb441a0b"
  },
  "chunk-140ca18217313c12e219228d5d33152e": {
    "tokens": 561,
    "content": "清晰、应急相关角色&职责不明确，缺失一号位等)\n        - [ ] 应急执行不到位（有流程，但未按流程执行，通告发送不及时，响应不及时等）\n    - [x] 否\n\n#### 4.2.2 故障定位&恢复\n+ **主要恢复方式：**\n    - [ ] 代码发布/回滚\n    - [ ] 配置发布/回滚\n    - [ ] 数据订正\n    - [ ] 机器隔离/重启/扩容\n    - [ ] 配置限流\n    - [ ] 预案降级\n    - [ ] 自动恢复\n    - [x] 其他：组件下线\n\n#### 4.2.3 SRE应急参与（淘天业务技术参考）\n+ **SRE工程师应急参与**：__\n    - 是否响应\n        - [x] 是\n        - [ ] 否\n    - 是否帮助定位\n        - [x] 是\n        - [ ] 否\n        - [ ] 未参与\n    - 是否操作恢复/提出有效恢复方案\n        - [x] 是\n        - [ ] 否，备注：__________\n        - [ ] 未参与\n+ **SRE专家是否有效指挥**\n        - [x] 是\n        - [ ] 否\n        - [ ] 未参与\n\n## 五、故障Action\n| **序号** | *******Action标题** | *******负责人** | *******计划完成时间** | **Action描述** | **验收标准** | **验收人** | **是否keyAction** | **是否回血Action** |\n| --- | --- | --- | --- | --- | --- | :---: | --- | --- |\n| 1 | 短期：压测影子链路数据初始化改造 | 沉沐 | 已完成 | |  | | | |\n| 2 | 短期：压测流量与线上流量本地缓存隔离 | 沉沐 | 已完成 | |  | | | |\n| 3 | 短期：检查各组件deliveryType字段是否都存在   | 沉沐 | 10.30  | |  | | | |\n| 4 | 长期：deliveryType字段都存在，组件兜底逻辑下线 | 沉沐 | 11.30  | |  | | | |\n| 5 | 长期：组件曝光基线监控 | 雪泽 | 11.30 | |  | | | |",
    "chunk_order_index": 2,
    "full_doc_id": "doc-5d97463d29a44b2a4311ef44bb441a0b"
  },
  "chunk-613791db900ca8db064f0f460b374d28": {
    "tokens": 1200,
    "content": "## 一、故障简述\n于2024-10-02 10:45开始收到用户反馈西溪c区网络异常，于10:49在热线舆情达到10例，触达P5故障，经确认故障原因为计划内市政电力检修，园区强电断路器异常，导致机房断电断网，通过操作绕过UPS切回市电后，于11:35所有网络设备恢复，故障恢复。\n\n## 二、故障过程回顾\n### 2.1【故障处理时间线】\n9月中旬收到行政发出的国庆电力检修通知，网络组内同步，网络全部由ups供电并不会影响业务；十一前行政内外小蜜消息推送全员（但是通知中并没有涉及停电风险）\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/113456498/1728436777272-59a77bf3-77ff-428f-95f6-8e88fe75e8fa.png)\n\n[西溪C区中秋国庆停电(1).xlsx](https://alidocs.dingtalk.com/spreadsheetv2/R4aJkO4XaizlNLZX/edit?dontjump=true&onlineEdit=true&type=s&docKey=5VLqXQgWKwRYOX19&ext=xlsx&dentryKey=R4aJkO4XaizlNLZX)\n\n2024-10-01 07:00，行政对A路市电进行计划内断电检修\n\n2024-10-01 15:23，网络设备出现单电源告警，**UPS-A电源耗尽**，网络值班判断为预期告警\n\n2024-10-01 21:23，行政完成检修灰度A路供电（**UPS-A未恢复输出供电，网络设备单电源运行**），网络值班同学未知晓供电信息，一直判断为正常电力检修告警；交由第二天同学检查\n\n2024-10-02 07:00，行政对B路市电进行计划内断电检修\n\n2024-10-02 08:50，网络值班检查遗漏告警，发现尚存在遗漏电源告警，立即联系西溪C区工程指挥中心进行排查，并进行跟踪；这时电力检修已经开始，西溪C区工程指挥中心未给出明确答复 **【故障发现】【故障响应】**\n\n2024-10-02 10:43，网络设备断电离线，网络中断（UPS-B电源耗尽）；网络监控检查设备，初步判断工程操作导致核心设备批量离线。**【初因定位】**\n\n2024-10-02 10:45，首例在热线进线。\n\n2024-10-02 10:46，网络监控值班电话西溪C区工程指挥中心  \n2024-10-02 10:49，在热线达到10例。**【故障发生】**\n\n2024-10-02 10:52，网络组尼候接到电话，并协同行政排查  \n2024-10-02 10:53，GOC值班侧发现断网联系常璇、博向   \n2024-10-02 11:01，常璇 人工上报风险单拉群处理，拉会拉入网络侧同学，初步确认网络核心机房断电断网\n\n2024-10-02 11:03，行政工程人员现场发现UPS-A未工作，断路器1、2、3处于断开状态；依次将断路器1、2依次上推，发现断路器2无法推上。断路器1正常工作，于是合闸断路器1、4，将UPS-A切成旁路状态。**【恢复执行】**\n\n2024-10-02 11:11，PDU-A供电恢复正常，网络陆续开始恢复。\n\n2024-10-02 11:35，网络全部恢复。**【故障恢复】**\n\n**机房供电图：**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/69036/1728359271461-b996e9ca-1374-46bd-9d57-cab7e7d709ec.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/jpeg/69036/1728359212138-d7049282-4776-4947-8e3a-b72e7cc5123b.jpeg)  \n2024-10-02 12:34，尼候到达西溪C区现场，与行政工程一起定位问题原因，由于市电B仍处于断电检修状态，市电A的问题排查需要等当晚检修结束后进行\n\n2024-10-02 15:30， UPS供应商达到现场\n\n2024-10-02 19:30， B路电检修提前完成，变电站开始合闸。\n\n**排查过程：**\n\nB路电合闸后，B路所有断路器正常工作，B路UPS开始启动，大概30秒后，断路器1、2自动分闸。UPS断开负载，进行UPS故障排除：UPS启动正常，",
    "chunk_order_index": 0,
    "full_doc_id": "doc-a4f9ae07d9a19ffdc9ae6d9e5a5d6332"
  },
  "chunk-39e46c1957441b471e56f7c9c3931833": {
    "tokens": 1200,
    "content": "15:30， UPS供应商达到现场\n\n2024-10-02 19:30， B路电检修提前完成，变电站开始合闸。\n\n**排查过程：**\n\nB路电合闸后，B路所有断路器正常工作，B路UPS开始启动，大概30秒后，断路器1、2自动分闸。UPS断开负载，进行UPS故障排除：UPS启动正常，UPS旁路正常，UPS逆变模式正常，电池充电正常；在UPS逆变模式下，未带载工作正常，开始对输出抽屉电源合闸，抽屉电源1合闸，断路器1、2立刻分闸。\n\n在断路器1、2分闸的情况下，先合闸所有输出抽屉电源；然后依次合闸断路器1、断路器2，正常供电。检查断路器事件记录，事件表明前面出现Ig脱扣；检查断路器告警，仪表盘断路器显示Ig告警。推断由于Ig保护，触发断路器脱扣。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/69036/1728359310908-c9526a42-e8aa-4294-951c-96075ebbf306.png)\n\n调整断路器设置，关闭接地保护；重复上面的合闸过程，未发生脱扣情况，B路电正常工单。\n\n重复操作A路供电，同样恢复A路正常状态供电。\n\n## 三、故障原因\n### 3.1【背景说明】\n西溪C区断电为计划内市政断电，所有西溪C区内涉及到的用电设备都会受到影响，且断电都会有一定的风险性，行政并也做出相应的通告。\n\n### 3.2【原因分析】\n**一句话原因：**\n\n计划内市政电力检修，园区强电断路器异常，导致机房断电\n\n\n\n**根因分析：**\n\n园区强电设备施耐德断路器，设置了Ig接地保护，在合闸时触发该设置导致断路器脱扣。\n\n## 四、关注点分析\n**〖关注点1〗园区强电设备的统一维护、配置。园区行政工程和基础网络事件的联动、处理机制、管理边界.**\n\n:::tips\n1、糖排带回ups详细界面、ups机房分工问题，总责任人、谁牵头分配 ，以及断路器监控、巡检、维保等运维动作 上升讨论 （其他园区统一拉通规则）  --- 糖排 10.15 给出结论\n\n2、梳理西溪C区ups机房 点位图  ---孟义存  10.18\n\n3、盘点所有园区ups机房可能存在管理真空机房的存在  （行政和IT分别提供各园区接口人  IT给出有机房的信息（10.18给出），行政各园区负责人带回盘点）   ---- 行政各园区负责人 11.10\n\n:::\n\n**〖关注点2〗批量问题上报，未及时拉起风险预警。**\n\n:::tips\n正常5例拉铃上报 --- 博向带回看下未上报原因，宣讲上报流程\n\n:::\n\n**〖关注点4〗故障发现能力，是否有监控发现。如何更快发现问题**\n\n:::tips\n**1、网络侧**：有正常的监控和告警，10.1 UPS-A电源耗尽，网络值班判断为预期告警未处理。10.2 检查有遗漏告警，有及时联系西溪C区工程指挥中心进行排查。\n\nups告警分层管理，仅有ups供电拉起应急响应   ----10.18 镜岩\n\n网络侧故障场景定义对焦，关联ups告警监控    ----10.18  博向\n\n**2、断路器：**监控、巡检、维保等运维动作 待讨论确认\n\n**3、同步机制**：\n\n1）通电断电行政工程值班同学提前通知到IT接口人（网络监控中心公共账号） ---糖排带回同步\n\n账号如下：\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/113456498/1728554494792-d20569ec-5ce5-42b6-88af-34233a97597a.png)\n\n2）拉群：行政IT协作群 \n\n3）各园区行政接口人负责在通电和断电时间同步出来。\n\n4）检修期间出问题由网络监控中心同学内部通知，是否去现场内部评估沟通决定。\n\n5）ups厂商需要提供值班人员出问题能电话联系到，找IT值班账号\n\n6）行政提前通知断电详情，IT评估是否会影响网络，是否发对应公告通知邮件\n\n:::\n\n**〖关注点5〗IG保护后续如何工作？触发机制**\n\n:::tips\n后续关闭，不开启IG保护。\n\n怀疑逆变器工作中谐波电流让断路器异常识别导致触发IG保护。\n\n:::\n\n## 五、故",
    "chunk_order_index": 1,
    "full_doc_id": "doc-a4f9ae07d9a19ffdc9ae6d9e5a5d6332"
  },
  "chunk-ecc2e608ca037bba944750d1d5f9dc2c": {
    "tokens": 505,
    "content": "人员出问题能电话联系到，找IT值班账号\n\n6）行政提前通知断电详情，IT评估是否会影响网络，是否发对应公告通知邮件\n\n:::\n\n**〖关注点5〗IG保护后续如何工作？触发机制**\n\n:::tips\n后续关闭，不开启IG保护。\n\n怀疑逆变器工作中谐波电流让断路器异常识别导致触发IG保护。\n\n:::\n\n## 五、故障Action\n| **序号** | *******Action标题** | *******负责人** | *******计划完成时间** | **Action描述** | **验收标准** | **验收人** | **是否keyAction** | **是否回血Action** |\n| --- | --- | --- | --- | --- | --- | :---: | --- | --- |\n| 1 | 短期：ups详细界面、ups机房分工问题，总责任人、谁牵头分配 ，以及断路器监控、巡检、维保等运维动作 上升讨论 （其他园区统一拉通规则） | 糖排 | 10.15给出结论 | |  | | | |\n| 2 | 短期：梳理西溪C区ups机房 点位图  | 孟义存 |  10.18 | |  | | | |\n| 3 | 短期：IT给出所有园区有ups机房信息 | 尼侯 | 10.18 | |  | | | |\n| 4 | 短期：ups告警分层管理 | 镜岩 | 10.18  | |  | | | |\n| 5 | 短期：网络侧故障场景定义对焦，关联ups告警监控     | 博向 | 10.18 | |  | | | |\n| 6 | 长期：盘点所有园区ups机房可能存在管理真空机房的存在   |  | 11.10 | |  | | | |\n\n\n## 六、影响产品线&影响面\n+ 在线，热线，排队量：热在线工单27例\n+ 故障期间在园连wifi人数：1981人，实际在园工作人数300人左右（不含行政工程工作同学）。\n\n###",
    "chunk_order_index": 2,
    "full_doc_id": "doc-a4f9ae07d9a19ffdc9ae6d9e5a5d6332"
  },
  "chunk-984e121ba7683f5c86b88b366df3e4fd": {
    "tokens": 1200,
    "content": "## 一、故障简述\n2024年10月3日18:36监控预警优酷APP_点播_播放核心错误码(31502)异常，影响联通运营商播放成功率下跌0.2%，影响用户量909，故障原因确认是联通侧设备异常导致，于19:07联通修复设备问题完成止血，19:27错误码下降至10以下，故障恢复，期间未产生集中客诉，根据监控下跌幅度判定达P4故障等级。\n\n## 二、影响产品线及影响面\n##### 影响面：\n- [x] 是否影响可用性：否\n- [x] 业务影响：\n\n区域：广西、四川、贵州、海南、重庆、云南\n\n影响持续时间：18:29开始出现31502报错，19:27降到10以下\n\n客户影响：4G联通用户手机端播放所有视频出现31502报错（CDN出现了502错误）\n\n| 错误数 | 设备数 | vv数 | 端类型 | 是否会员 |\n| :---: | :---: | :---: | :---: | :---: |\n| 6036 | 805 | 5652 | 主客 | 1 |\n| 347 | 104 | 328 | 主客 | 0 |\n\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/252905/1728484498467-933f7108-2bd2-4c7e-91de-f1784ee042fe.png)\n\n- [x] 是否有客诉：未产生集中客诉\n- [x] 是否有社会舆情_：_否\n- [x] 是否产生资损：否\n\n## 三、故障过程回顾\n2024-10-03 18:29，联通CDN广州节点缓存系统负载高触发内存溢出**【风险注入】**\n\n2024-10-03 18:36，优酷消防群推出“优酷APP_点播_播放核心错误码异常”风险预警卡片**【故障发现】**\n\n2024-10-03 18:37，优酷SRE联系阿里云，f-vali.cp31.ott.cibntv.net 贵州联通18:45回切，18:55回切全国。**【业务响应】**\n\n2024-10-03 18:54，优酷研发发现错误码下降不明显，猜测联通问题，18:57电话联系对方。**【初因定位】**\n\n2024-10-03 18:39，失败量持续10分钟>100，触发P4**【故障发生】**\n\n2024-10-03 19:07，联通侧反馈已触发故障处理程序，节点功能自动恢复，优酷错误码明显下降。****\n\n2024-10-03 19:10，联通CDN运维排查，发现广州磁盘告警。****\n\n2024-10-03 19:15，联通CDN清理磁盘。**【恢复执行】**\n\n2024-10-03 19:27，优酷错误基本恢复。**【故障恢复】**\n\n2024-10-03 19:50，优酷错误彻底恢复。**【影响消除】**\n\n2024-10-03 23:30，联通CDN侧复盘定位到具体技术原因。**【根因定位】**\n\n## 四、故障原因\n### 4.1【背景说明】\n联通4G定向代理免流业务场景下，客户端通过调用免流SDK替换联通CDN域名来实现点播场景下的定向免流。\n\n### 4.2【原因分析】\n##### 一句话原因：\n优酷联通4G定向代理免流业务，因节假日运营商服务占用内存过高，节点返回502，导致优酷播放出现502错误。\n\n##### 根因分析：\n联通运营商缓存节点服务进程受业务突增影响，导致服务占⽤内存过⾼，节点服务异常， 期间服务⽆法完整响应请求，导致 502 状态升⾼。\n\n## 五、关注点分析\n###### 【关注点1】 阿凡达聚类分析为什么没有第一时间发现联通定向免流CDN异常？\n:::info\n**问题总结：**端侧上报域名维度未考虑免流换域名的逻辑，导致上报域名失真。\n\n**改进点：**阿凡达聚类分析免流域名上报校准 [@宇昭](undefined/yuzhao.zpy) 10.29 \n             所有新的CDN接入需要有标准流程，包括建立监控，验收通过才可上线等 [@伯诚](undefined/yi.fu) 11.15\n             和湾湾确认是否有做CDN相关的监控 [@边遥](undefined/jing.zengj) \n\n:::\n\n###### 【关注点2】联通CDN发生502为何兜底降级策略没有生效？\n:::info\n**问题总结：**目前端侧针对定向代理免流只会针对403鉴权失败降级。\n\n**改进点：**端侧后续会针对联通CDN域名增加完善的切回能力（手动回切到阿里云上的联",
    "chunk_order_index": 0,
    "full_doc_id": "doc-0d3f4985370e2c6cac62eb68e3f60627"
  },
  "chunk-c8bcc67823ffc44affeaeddd4e5fa580": {
    "tokens": 1200,
    "content": "[@边遥](undefined/jing.zengj) \n\n:::\n\n###### 【关注点2】联通CDN发生502为何兜底降级策略没有生效？\n:::info\n**问题总结：**目前端侧针对定向代理免流只会针对403鉴权失败降级。\n\n**改进点：**端侧后续会针对联通CDN域名增加完善的切回能力（手动回切到阿里云上的联通节点X-及后续若实施有损降级需要联通赔付的方案确认）。 [@宇昭](undefined/yuzhao.zpy) 10.29\n\n:::\n\n###### 【关注点3】联通侧是否有发现磁盘异常问题？双方的风险同步及应急处理流程是否具备？\n:::info\n**问题总结：**联通侧告警被淹没。\n\n**改进点：**后续联通侧将升级优酷免流业务告警优先级，增加语⾳告警，并同时通知优酷侧，制定业务和节点巡检机制，对优酷免流业务和核⼼节点按⽇巡检；增加应⽤层健康检查机制，针对 5xx 异常节点做故障剔除。\n\n后续如果联通有预警的话第一时间通过微信和钉钉群同步至优酷侧。\n\n:::\n\n### 5.1【系统质量】--不涉及\n#### 5.1.1 需求&设计评估\n**〖关注点1〗****是否涉及产品、技术方案评估？此核心的问题是什么，如何改进？**\n\n- [ ] **是，涉及**\n    - [ ] 需求评估遗漏\n    - [ ] 产品设计缺陷\n    - [ ] 系统架构设计缺陷\n        - [ ] 容错性不足 \n        - [ ] 单点，无冗余\n        - [ ] 缺乏自我保护\n        - [ ] 缓存设计不当\n        - [ ] 容量评估不足\n        - [ ] 非幂等设计\n        - [ ] 强弱依赖不合理\n        - [ ] 其他：__________\n- [ ] 否，不涉及\n\n**〖问题总结〗**\n\n**〖改进点〗**_**需明确写明不同故障相关方的改进项（若有的话），下同。**_\n\n1、\n\n#### 5.1.2 代码质量\n**〖关注点1〗是否代码自身存在漏洞或BUG、代码健壮性是否存在问题等?**\n\n**〖问题分析〗**\n\n**〖改进点〗**_**需明确写明不同故障相关方的改进项（若有的话），下同。**_\n\n1、\n\n\n\n**〖关注点2〗****是否经过CodeReview？CodeReview阶段是否发现问题？为何没发现？**\n\n+ **是否经过CR**\n    - [ ] 是\n    - [ ] 否\n    - [ ] 不涉及\n+ **是否设置合理的CR卡点**\n    - [ ] 是\n    - [ ] 否\n    - [ ] 不涉及\n+ **CodeReview阶段是否发现问题？为何没发现？后续如何发现？**\n    - [ ] 是\n    - [ ] 否\n    - [ ] 不涉及\n\n**〖问题分析〗******\n\n**〖改进点〗**_**需明确写明不同故障相关方的改进项（若有的话），下同。**_\n\n1、\n\n\n\n**〖关注点3〗****测试阶段**\n\n+ **测试内容：**涉及的测试提交单、测试用例等\n+ **测试人员：**\n+ **是否经过测试验证**\n    - [ ] 是，验证环境\n        - [ ] 预发环境\n        - [ ] 日常环境\n    - [ ] 是，测试方法\n        - [ ] 单元测试\n        - [ ] 功能回归测试\n        - [ ] 集成测试/链路测试\n        - [ ] 验收测试\n    - [ ] 否\n    - [ ] 不涉及\n+ **测试未发现原因是什么？后续如何改进？**\n    - [ ] 回归测试遗漏\n        - [ ] 手工回归测试用例遗漏\n        - [ ] 自动化未建设\n        - [ ] 自动化回归覆盖不足\n        - [ ] 其他：__________\n    - [ ] 新场景测试遗漏\n        - [ ] 功能测试用例遗漏，包括正常分支和异常分支\n        - [ ] 容灾兜底测试遗漏\n        - [ ] 客户端兼容性测试遗漏\n        - [ ] 埋点测试遗漏\n        - [ ] 性能测试遗漏，影响评估不足\n        - [ ] 安全测试遗漏\n    - [ ] 其他：__________\n\n**〖问题总结〗**\n\n**〖改进点〗**_**需明确写明不同故障相关方的改进项（若有的话），下同。**_\n\n1、\n\n#### 5.1.3 变更质量\n+ **是否涉及变更：**\n    - [ ] 是\n    - [ ] 否\n+ **变更类型：**\n    - [ ] 代码发布\n    - [ ] 配置变更\n    - [ ] 其他变更：____________\n    - [ ] 不涉及\n+ **变更平台是否接入ChangeFree：**\n    - [ ]",
    "chunk_order_index": 1,
    "full_doc_id": "doc-0d3f4985370e2c6cac62eb68e3f60627"
  },
  "chunk-8172a5488818ef01ae9bf1b405e84d93": {
    "tokens": 1200,
    "content": "的话），下同。**_\n\n1、\n\n#### 5.1.3 变更质量\n+ **是否涉及变更：**\n    - [ ] 是\n    - [ ] 否\n+ **变更类型：**\n    - [ ] 代码发布\n    - [ ] 配置变更\n    - [ ] 其他变更：____________\n    - [ ] 不涉及\n+ **变更平台是否接入ChangeFree：**\n    - [ ] 是，CF变更单链接：________\n\n_/*要这样的链接_ [https://aicf.alibaba-inc.com/aicf/change/detail/1725370372](https://aicf.alibaba-inc.com/aicf/change/detail/1725370372) */\n\n    - [ ] 否\n+ **是否违反变更红线3.1**** **[链接](https://aliyuque.antfin.com/ngoc/fzg6dy/uar1k6)\n    - [ ] 是，违反哪条原则：\n    - [ ] 否\n\n\n\n**〖关注点1〗****灰度阶段**\n\n+ **是否经过灰度：**\n    - [ ] 是\n    - [ ] 否\n+ **观测了哪些监控**：_可以附链接_\n    - [ ] 黑屏、白屏\n    - [ ] GOC监控：\n    - [ ] 系统大盘：\n    - [ ] 其他：___________\n+ **是否灰度期间发现问题？**\n    - [ ] 是\n        - [ ] 是否灰度流量过大，导致故障\n        - [ ] 灰度发现但未有效或及时修复，导致故障\n        - [ ] 其他：___________\n    - [ ] 否，后续如何灰度发现？_____________\n+ **未灰度发现原因**\n    - [ ] 应用灰\n        - [ ] 灰度流量太小\n        - [ ] 灰度阶段无监控\n        - [ ] 灰度批次不合理\n        - [ ] 超长时间灰度才能发现\n    - [ ] 业务灰：策略不合理\n    - [ ] 灰度无法发现\n    - [ ] 其他：_____________\n\n**〖问题总结〗**\n\n**〖改进点〗**_**需明确写明不同故障相关方的改进项（若有的话），下同。**_\n\n1、\n\n\n\n**〖关注点2〗****上线阶段**\n\n+ **是否有确定的监控观测指标**\n    - [ ] 是，监控指标及监控链接：\n    - [ ] 否\n+ **是否在窗口期进行发布变更**\n    - [ ] 是\n    - [ ] 否，原因：\n+ **变更是否影响上下游**\n    - [ ] 是，是否有提前知会上下游评估及关注变更\n        - [ ] 有提前知会\n        - [ ] 没有提前知会\n    - [ ] 否\n\n**〖问题总结〗**\n\n**〖改进点〗**_**需明确写明不同故障相关方的改进项（若有的话），下同。**_\n\n1、\n\n### 5.2【处置能力】\n#### 5.2.1 故障发现&响应\n+ **是否监控发现**\n    - [ ] 故障触发方 监控发现\n    - [x] 故障受影响方 监控发现\n    - [ ] 否，原因为：（监控无效/监控缺失）\n+ **是否5分钟内响应**\n    - [x] 是\n    - [ ] 否，原因为：\n+ **是否存在应急协同问题**\n    - [ ] 是\n        - [ ] 应急流程不明确（无流程或者流程不清晰、应急相关角色&职责不明确，缺失一号位等)\n        - [ ] 应急执行不到位（有流程，但未按流程执行，通告发送不及时，响应不及时等）\n    - [x] 否\n\n#### 5.2.2 故障定位&恢复\n+ **主要恢复方式：**\n    - [ ] 代码发布/回滚\n    - [ ] 配置发布/回滚\n    - [ ] 数据订正\n    - [ ] 机器隔离/重启/扩容\n    - [ ] 配置限流\n    - [ ] 预案降级\n    - [ ] 自动恢复\n    - [x] 其他：联通侧修复设备异常\n\n## 六、故障Action\n| **序号** | *******Action** | *******负责人** | *******计划完成时间** | **是否keyAction** |\n| :---: | --- | :---: | :---: | --- |\n| 1 | 梳理主机进程状态，关停⾮必要服务，减少内存溢出隐患 | 刘光辉 | 已完成 | 联通侧Action |\n| 2 | 增加解析覆盖范围，避免⼴东节点对省分的单点覆盖 | 刘光辉 | 已完成 | |\n| 3 | 升级优酷免流业务告警优先级，增加语⾳告警 | 刘光辉 | 10.31 | |\n| 4 | 制定业务和节点巡检机制，对优酷免流业务和核⼼节点按⽇巡检 | 刘光辉 | 10.31 | |\n| 5 | 增加",
    "chunk_order_index": 2,
    "full_doc_id": "doc-0d3f4985370e2c6cac62eb68e3f60627"
  },
  "chunk-2236069b79c7cc9bdccfb13b8a8d7d6d": {
    "tokens": 229,
    "content": "节点对省分的单点覆盖 | 刘光辉 | 已完成 | |\n| 3 | 升级优酷免流业务告警优先级，增加语⾳告警 | 刘光辉 | 10.31 | |\n| 4 | 制定业务和节点巡检机制，对优酷免流业务和核⼼节点按⽇巡检 | 刘光辉 | 10.31 | |\n| 5 | 增加应⽤层健康检查机制，针对 5xx 异常做故障剔除 | 刘光辉 | 10.31 | |\n| 6 | 阿凡达聚类分析免流域名上报校准 | 宇昭 | 10.29 | 是 |\n| 7 | 端侧针对5xx兜底能力完善，增加端侧回切阿里云域名能力 | 宇昭 | 10.29 | 否 |\n| 8 | 制定新CDN接入的标准流程 | 伯诚 | 11.15 | 否 |",
    "chunk_order_index": 3,
    "full_doc_id": "doc-0d3f4985370e2c6cac62eb68e3f60627"
  },
  "chunk-2721299d8db53f212b4532190731e4a4": {
    "tokens": 1200,
    "content": "## 一、故障简述\n【P3】于2024-09-30 19:33千牛登录_成功率异常，成功率最近5分钟最大值小于90%且失败量最近5分钟最小值大于2000，触达P4，于19:40，千牛_插件列表异常，成功率最近15分钟最大值小于80%且总量最近15分钟最小值大于3000，故障触达P3，于19:41操作限流故障恢复。 排查为千牛插件DB前置缓存保护逻辑有问题，导致tair写缓存逻辑失效，查询流量击穿至数据库CPU上涨。\n\n## 二、故障过程回顾\n### 2.1【故障处理时间线】\n| **时间轴** | **事件** |\n| --- | --- |\n| 2024-09-30 17:56 | multi应用发布第一批【故障注入】![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256311/1728651390085-66e494b2-8320-45a0-a22b-9304de709335.png) |\n| 2024-09-30 19:22 | multi最后一批发布开始 |\n| 2024-09-30 19:24 | 关键字错误监控告警触发，研发排查介入**【故障发现】** |\n| 2024-09-30 19:29 | ‘千牛_插件列表异常’预警卡片推送，勇剑拉起风险预警群******【故障响应】** |\n| 2024-09-30 19:31 | 勇剑反馈multi TOP_PLATFORM_APP DB打满**【故障定位】** |\n| 2024-09-30 19:31 | ‘淘系千牛登录异常’预警卡片推送 |\n| 2024-09-30 19:33 | 淘系千牛登录异常：成功率最近5分钟最大值小于90%且失败量最近5分钟最小值大于2000，触达P4**【故障发生】** |\n| 2024-09-30 19:33 | 钉钉会议拉起 |\n| 2024-09-30 19:34 | 白璋操作回滚变更****![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256311/1728704269412-c6b152aa-07dd-42ea-b0c0-92260a6d406e.png) |\n| 2024-09-30 19:40 | 千牛_插件列表异常，成功率最近15分钟最大值小于80%且总量最近15分钟最小值大于3000，触达P3 |\n| 2024-09-30 19:41 | 勇剑操作限流故障恢复**【恢复执行】【故障恢复】**![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256311/1728704473386-f8b5df46-51f2-4bc3-990b-0f400b2ba027.png) |\n\n\n## 三、故障原因\n### 3.1【背景说明】\n【需求背景】multi的插件接口线上有性能问题，接口RT持续上涨，rt高点超过2.5s，如果持续有小程序插件新增会导致国庆和大促期间稳定性风险\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/9783/1728647453419-5940edae-a50a-4a07-a3bb-52b620b8cc6d.png)\n\n**现状**：投放到千牛的小程序应用，近1个月多出700+ ISV给商家定制小程序(单个商家专用)，导致千牛侧服务端链路负载变高。\n\n**问题原因：**从数据库拉出来数据看，线上拉出的有效小程序数量近期出现数量膨胀，超过了本地缓存的阈值(5000)，导致接口性能差，成功率下跌、抖动和超时\n\n**优化方案：**针对不活跃的定制小程序，使用黑名单配置过滤，同时将本地缓存阈值扩到9000，降低接口的RT\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/9783/1728647453402-10377506-5848-476e-aa23-242525dea63b.png)\n\n\n\n【业务链路】yungw千牛登录应用/multi千牛工作台\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/9783/1728647413429-4a58f384-b5bd-4e78-ac88-0f6c77b94038.png)\n\n### 3.2【原因分析】\n**一句话原因**\n\n稳定性优化变更发布，导致插件tair缓存加载逻辑失效，读逻辑击穿至DB，影响了千牛登录/插件业务\n\n\n\n**根因分析**\n\n机器发布完成时，diamond配置未发布，配置变量为空触发NPE，导致缓存加载逻辑异常\n\n![](https://intranetproxy",
    "chunk_order_index": 0,
    "full_doc_id": "doc-77262018b03362d5cb725aaf657bbf6b"
  },
  "chunk-4f4b987aefdb74477d9afaba15bf76d8": {
    "tokens": 1200,
    "content": "78-ac88-0f6c77b94038.png)\n\n### 3.2【原因分析】\n**一句话原因**\n\n稳定性优化变更发布，导致插件tair缓存加载逻辑失效，读逻辑击穿至DB，影响了千牛登录/插件业务\n\n\n\n**根因分析**\n\n机器发布完成时，diamond配置未发布，配置变量为空触发NPE，导致缓存加载逻辑异常\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/9783/1728647547917-8397e197-f0c3-4902-9840-89eb457d4a5c.png)\n\n## 四、关注点分析\n「关注点」：代码无配置变量为空兜底逻辑？是否已修复\n\n:::tips\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/9783/1728715370234-c41fc0e3-725c-4069-92db-771bbb7c3c2c.png)\n\n已修复上线，针对配置为空的情况，不覆盖变量\n\n:::\n\n「关注点」灰度期间是否有预警，为何最后一批发布完成线上才出问题？后续如何在灰度期间发现？\n\n:::tips\n灰度期间NPE预警被淹没，有问题的代码是缓存更新逻辑，线上未发布的机器依然能正常更新缓存，不会击穿。缓存时效是4分钟。当最后一台机器发布后再等4分钟后，Tair缓存正式失效，流量才击穿到数据库\n\naction：清理异常日志，确保NPE预警及时发现  白璋 已完成\n\naction：补充缓存到DB的回源监控，如果回源次数升高则监控告警，在灰度发布中可发现 白璋 10.24\n\n:::\n\n「关注点」：DB是否有配置相关监控？监控是否有预警？\n\n:::tips\n[https://x.alibaba-inc.com/application/appmonitor/multi/monitor/middleware/tddl?v=2](https://x.alibaba-inc.com/application/appmonitor/multi/monitor/middleware/tddl?v=2),有预警\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/9783/1728715495021-8275592f-6e3a-4894-804f-643a63af4be7.png)\n\n:::\n\n「关注点」：yungw千牛登录应用/multi千牛工作台两个应用各自是否有限流？DB库是否有限流？\n\n:::tips\nyungw/multi应用及DB有配置接口级限流，对单独SQl日常不进行配置限流\n\n:::\n\n### 4.1【系统质量】\n#### 4.1.1 需求&设计评估----不涉及\n#### 4.1.2 代码质量\n**〖关注点〗****是否经过CodeReview？CodeReview阶段是否发现问题？为何没发现？**\n\n+ **是否经过CR：**\n    - [x] 是 ，可祯，CR链接：[**https://code.alibaba-inc.com/qianniu/multi/codereview/18583410**](https://code.alibaba-inc.com/qianniu/multi/codereview/18583410)\n    - [ ] 否\n    - [ ] 不涉及\n+ **是否设置合理的CR卡点**\n    - [x] 是\n    - [ ] 否\n    - [ ] 不涉及\n+ **CodeReview阶段是否发现问题？为何没发现？后续如何发现？**\n    - [ ] 是\n    - [x] 否\n    - [ ] 不涉及\n\n**〖关注点〗****测试阶段**\n\n+ **测试人员：**可祯\n+ **是否经过测试验证**\n    - [x] 是，验证环境\n        - [x] 预发环境\n        - [x] 日常环境\n    - [x] 是，测试方法\n        - [ ] 单元测试\n        - [x] 功能回归测试\n        - [ ] 集成测试/链路测试\n        - [ ] 验收测试\n    - [ ] 否\n    - [ ] 不涉及\n+ **测试未发现原因是什么？后续如何改进？**\n    - [ ] 回归测试遗漏\n        - [ ] 手工回归测试用例遗漏\n        - [ ] 自动化未建设\n        - [ ] 自动化回归覆盖不足\n        - [x] 其他：预发先发布diamond配置，在发布代码，不会复现该问题\n    - [ ] 新场景测试遗漏\n        - [ ] 功能测试用例遗漏，包括正常分支和异常分支\n        - [ ] 容灾兜底测试遗漏\n        - [ ] 客户端兼容性测试遗漏\n        - [ ] 埋点测试遗漏\n        - [ ] 性能测试遗漏，影响评估不足\n        - [ ] 安全测试遗漏\n    - [ ] 其他：__________\n\n#### 4.1.3 变更质量----不涉及\n+ **是否涉及变更：**\n    - [x] 是\n    - [ ] 否\n+ **变更类型：**\n    - [x] 代码发布\n    - [x] 配置变更\n    - [ ] 其他变更\n    - [ ] 不涉及\n+",
    "chunk_order_index": 1,
    "full_doc_id": "doc-77262018b03362d5cb725aaf657bbf6b"
  },
  "chunk-0d0523ee823cb377ab1575bac015becf": {
    "tokens": 1200,
    "content": "不足\n        - [ ] 安全测试遗漏\n    - [ ] 其他：__________\n\n#### 4.1.3 变更质量----不涉及\n+ **是否涉及变更：**\n    - [x] 是\n    - [ ] 否\n+ **变更类型：**\n    - [x] 代码发布\n    - [x] 配置变更\n    - [ ] 其他变更\n    - [ ] 不涉及\n+ **变更平台是否接入ChangeFree：**\n    - [x] 是，CF变更单链接：[https://aicf.alibaba-inc.com/aicf/approval/detail/8116528](https://aicf.alibaba-inc.com/aicf/approval/detail/8116528)\n    - [ ] 否\n+ **是否违反变更红线3.1**** **[链接](https://aliyuque.antfin.com/ngoc/fzg6dy/uar1k6)\n    - [ ] 是，违反哪条原则：\n    - [x] 否\n\n\n\n\n\n**〖关注点1〗****灰度阶段**\n\n+ **是否经过灰度：**\n    - [x] 是\n    - [ ] 否\n+ **观测了哪些监控**：_可以附链接_\n    - [ ] 黑屏、白屏\n    - [ ] GOC监控：\n    - [x] 系统大盘：\n\n         [https://x.alibaba-inc.com/custom/11/product/preview/spm/666](https://x.alibaba-inc.com/custom/11/product/preview/spm/666)\n\n        [https://x.alibaba-inc.com/custom/11/product/preview/generalComp/125](https://x.alibaba-inc.com/custom/11/product/preview/generalComp/125)\n\n    - [ ] 其他：\n+ **是否灰度期间发现问题？**\n    - [ ] 是\n        - [ ] 是否灰度流量过大，导致故障\n        - [ ] 灰度发现但未有效或及时修复，导致故障\n        - [ ] 其他：___________\n    - [x] 否，后续如何灰度发现？\n\naction：补充缓存到DB的回源监控，如果回源次数升高则监控告警，在灰度发布中可发现\n\n+ **未灰度发现原因**\n    - [ ] 应用灰\n        - [ ] 灰度流量太小\n        - [ ] 灰度阶段无监控\n        - [ ] 灰度批次不合理\n        - [ ] 超长时间灰度才能发现\n    - [ ] 业务灰：策略不合理\n    - [ ] 灰度无法发现\n    - [x] 其他:有问题的代码是缓存更新逻辑，线上未发布的机器依然能正常更新缓存，不会击穿。缓存时效是4分钟。当最后一台机器发布后再等4分钟后，Tair缓存正式失效，流量才击穿到数据库\n\n\n\n**〖关注点2〗****上线阶段**\n\n+ **是否有确定的监控观测指标**\n    - [x] 是，监控指标及监控链接：\n\n[https://x.alibaba-inc.com/custom/11/product/preview/generalComp/1239](https://x.alibaba-inc.com/custom/11/product/preview/generalComp/1239)\n\n[https://x.alibaba-inc.com/custom/11/product/preview/keywordMonitor/52?v=2](https://x.alibaba-inc.com/custom/11/product/preview/keywordMonitor/52?v=2)\n\n    - [ ] 否\n+ **是否在窗口期进行发布变更**\n    - [ ] 是\n    - [x] 否，原因：国庆节前一天申请紧急发布，正常走发布审批流程，发布必要性在背景中阐述\n+ **变更是否影响上下游**\n    - [ ] 是，是否有提前知会上下游评估及关注变更\n        - [ ] 有提前知会\n        - [ ] 没有提前知会\n    - [x] 否\n\n### 4.2【处置能力】\n#### 4.2.1 故障发现&响应\n+ **是否监控发现**\n    - [x] 故障触发方 监控发现\n    - [x] 故障受影响方 监控发现\n    - [ ] 否，原因为：（监控无效/监控缺失）\n+ **是否5分钟内响应**\n    - [x] 是\n    - [ ] 否，原因为：\n+ **是否存在应急协同问题**\n    - [ ] 是\n        - [ ] 应急流程不明确（无流程或者流程不清晰、应急相关角色&职责不明确，缺失一号位等)\n        - [ ] 应急执行不到位（有流程，但未按流程执行，通告发送不及时，响应不及时等）\n    - [x] 否\n\n#### 4.2.2 故障定位&恢复\n+ **主要恢复方式：**\n    - [x] 代码发布/回滚\n    - [ ] 配置发布/回滚\n    - [ ] 数据订正\n    - [ ] 机器隔离/重启/扩容\n    - [x] 配置限流\n    - [ ] 预案降级\n    - [ ] 自动恢复\n    - [ ] 其他：\n\n#### 4.2.3 SRE应急参与（淘天业务技术参考）\n+ **SRE工程师应",
    "chunk_order_index": 2,
    "full_doc_id": "doc-77262018b03362d5cb725aaf657bbf6b"
  },
  "chunk-cb7f6b3e165905c0444804202f59c31f": {
    "tokens": 490,
    "content": "代码发布/回滚\n    - [ ] 配置发布/回滚\n    - [ ] 数据订正\n    - [ ] 机器隔离/重启/扩容\n    - [x] 配置限流\n    - [ ] 预案降级\n    - [ ] 自动恢复\n    - [ ] 其他：\n\n#### 4.2.3 SRE应急参与（淘天业务技术参考）\n+ **SRE工程师应急参与**：__\n    - 是否响应\n        - [ ] 是\n        - [x] 否\n    - 是否帮助定位\n        - [ ] 是\n        - [ ] 否，备注：__________\n        - [x] 未参与\n    - 是否操作恢复/提出有效恢复方案\n        - [ ] 是\n        - [ ] 否，备注：__________\n        - [x] 未参与\n+ **SRE专家是否有效指挥**\n        - [x] 是\n        - [ ] 否，备注：__________\n        - [ ] 未参与，备注：__________\n\n\n\n## 五、故障Action\n| **序号** | *******Action标题** | *******负责人** | *******计划完成时间** | **Action描述** | **验收标准** | **验收人** | **是否keyAction** | **是否回血Action** |\n| --- | --- | --- | --- | --- | --- | --- | --- | --- |\n| 1 | 短期：数据库回源查询监控补全 | 白璋 | 10.24 | 补充缓存到DB的回源监控，如果回源次数升高则监控告警，在灰度发布中可发现 | 监控有效性 | 可祯 | | |\n| 2 | 短期：清理异常日志 | 白璋 | 已完成 | 异常日志淹没了发布中告警，清理完可以辅助发现发布异常 |  | 可祯 | | |\n| 3 | 短期：规范发布流程 | 白璋 | 10.18 | 每次发布CF单中附带发布计划，核心应用发布流程定制aone流程节点检查关联配置发布 | aone发布流水线 | 可祯 | | |",
    "chunk_order_index": 3,
    "full_doc_id": "doc-77262018b03362d5cb725aaf657bbf6b"
  },
  "chunk-f94f52adf361af465a25498c93c30f58": {
    "tokens": 1196,
    "content": "## 【故障过程回顾】\n2024-09-25 10:00前，星云产品界面加载慢，已经介入排查。\n2024-09-25 11:40，星云训练作业pending状态异常。\n2024-09-25 12:00，定位到服务能力不足的问题。\n2024-09-25 12:00，nebula-one-proxy服务应用实例个数从10个扩容到30个。\n\n[https://drogo.taobao.org/#/role/view/nebula-one-proxy/publish/nebula-one-proxy_publish?_k=ceh75z](https://drogo.taobao.org/#/role/view/nebula-one-proxy/publish/nebula-one-proxy_publish?_k=ceh75z)\n\n2024-09-25 13:00，nebula-one-proxy服务扩容完成。\n2024-09-25 中午，限制提交spot任务。\n2024-09-25 14:37，星云训练作业失败量大于300。  \n****2024-09-25 15:06，持续30分钟，触达P4。\n2024-09-25 15:36，持续60分钟，升级P3\n2024-09-25 16:00，开始订正异常状态的作业。 \n2024-09-25 16:08，服务状态已恢复。\n2024-09-25 18:00，手动处理部分问题作业后影响消除。\n2024-09-25 22:31，星云训练作业状态监控再次异常，当前10分钟的平均值296.00>阈值280.0触发风险预警。\n2024-09-25 22:42，监控中心拉起应急群，默绯接手处理。\n2024-09-25 23:45，默绯反馈原因初步判断为redis被打满，并进行redis扩容操作\n2024-09-26 00:30，星云训练作业状态监控恢复到日常水位，故障恢复。\n\n## 【故障原因】\n### 【背景说明】\n#### 一句话原因：\n由于外部调用增加叠加星云服务依赖的mysql发生死锁，导致星云服务（nebula-one-proxy）服务能力下降；\n\n会导致鉴权服务回调星云服务失败且没有重试机制，导致任务堆积，redis内存打满，最终导致星云服务异常，pending任务增加。\n\n##### 根因分析：\n**.事件激增**\n\n排查发现有外部调用 meta更新接口，有success状态的任务的状态更新接口会被外部调用，加重了nebula-one-proxy服务的处理负担。\n\n**处理能力不够**\n\n2024-09-25 11:40，mysql 死锁sql激增，导致每个mysql conn都占用10秒以上，mysql conn pool爆掉，继而导致星云http conn pool满了，导致星云服务hang掉，无法正常访问。\n唯一索引加上 Share Record Lock + Gap Lock。（即使是RC事务隔离级别）也会存在，结论就是并发insert 唯一键冲突死锁，这个不太好结论，mysql内核行为死锁后，InnoDB会选择资源最小的那个事务进行回滚。另外一个事务会执行成功，解决这个问题可以考虑把事务提交的数据变小，这里能看到undo log entries是4，单纯的INSERT一条记录只有一个undo entry，所以，这里至少是插入一条，然后更新N条的结果\n\ninsert into duplicate的sql 是一个事务里执行了批量的insert into duplicate，如果发生死锁会加重mysql负担。\n\n## 【核心关注点】\n【关注点1】 告警监控上午11点40左右报出来的，技术同学什么时候介入处置的，定位过程有什么问题？ \n[原因分析〕\n\n10点前后已经关注到任务打开链接缓慢，在报pending前已经开始在处理\n\nACTION:  \nredis内存满告警，mysql数据库死锁告警 --[@里烟](undefined/kimwang.wq)\n\n\n\n\n\n【关注点2】  造成成mysql死锁的代码是什么时候上线的，之前是否有暴露过类似死锁相关的问题？\n[原因分析〕\n\n随着星云用户规模不断增加，处理能力开始不足，【mysql死锁的代码】 很早就已经上线\n\nACTION:  \n\n优化代码，减少sql事务插入开销。\n\n\n\n【关注点3】  本次故障恢复做了哪些动作，事后看是否有更快的止血方式？\n[原因分析〕\n恢复流程：拉黑+扩容+订正任务\nACTION:  \n产出问题处理SOP并内部宣讲。--[@里烟](undefined/kimwang.wq)\n\nODPS鉴权服务重试或者增加鉴权服务超时机制。\n\n##### 【故障Action】\n1. 优化代码，减少sql事务插入开销。\n2. 产出星云作业异常问题处理SOP并内部宣讲\n3. 补充redis内存满告警，mysql数据库死锁告警 \n4. 确认redis内存上涨到100%的原因，并明确内存满之后快速恢复的方案。\n5. 星云服务增加性能测试流程。产出性能测试流程方案\n6. ODPS鉴权服务增加重试机制，避免流程卡死。\n\n\n\n\n\n##",
    "chunk_order_index": 0,
    "full_doc_id": "doc-f94f52adf361af465a25498c93c30f58"
  },
  "chunk-2afc267a89e86cf54e04cf41c9be91a5": {
    "tokens": 96,
    "content": "产出星云作业异常问题处理SOP并内部宣讲\n3. 补充redis内存满告警，mysql数据库死锁告警 \n4. 确认redis内存上涨到100%的原因，并明确内存满之后快速恢复的方案。\n5. 星云服务增加性能测试流程。产出性能测试流程方案\n6. ODPS鉴权服务增加重试机制，避免流程卡死。\n\n\n\n\n\n##",
    "chunk_order_index": 1,
    "full_doc_id": "doc-f94f52adf361af465a25498c93c30f58"
  },
  "chunk-1e22e33143b5f3d1ccf8e5361e6f46df": {
    "tokens": 1200,
    "content": "## 一、故障简述\n故障简述：于9月28日9:14 批量商家反馈揽收显示失败报错提示6102，根因为CP揽收失败回传未按标准文档进行回传导致，通过将受影响订单转跨越揽方案故障止血，16:19全量订单重推完成故障恢复，期间客诉共36+\n\n## 二、故障过程回顾\n### 【故障处理时间线】\n故障时间线：\n\n2024-09-26 ，4PX业务开启了金华市和湖州市两个区域的U-备货仓发订单，下发给安能物流 **【故障引入】**\n\n2024-09-28 09:14，客诉群批量3个商家反馈，揽收显示失败 取消原因为6102 **【故障发现】**\n\n2024-09-28 09:16，@至清 群里响应排查**【业务响应】**\n\n2024-09-28 09:18，@晓午 协同菜鸟拉起电话会议 \n\n2024-09-28 09:18，4PX产技@董天保@赖宇鹏参与会议以及定位问题原因\n\n2024-09-28 09:33，@至清 同步小二：判断单据是正常取消，是错误信息透出6102，有商家体感咨询。不影响实操，请商家稍后再试****\n\n2024-09-28 09:55，4PX技术@赖宇鹏捞取安能回传报文并通知安能侧产技及时处理问题 \n2024-09-28 10:25，会议结束，会议结论：安能回传报文有误，9月27日下午业务停止分单给新增揽收cp，业务降级止血完成，存量的需要cco话术下放，让商家重新下揽收单 **【故障定位】**\n\n2024-09-28 10:37，@采月 表示供应链侧的止血应该是：已经错的单据要恢复。不然客诉会增加，重新拉起电话会议对焦存量处理方案，结论如下：存量cco布控\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/128756344/1728359809753-51bbede7-0bbf-48a4-aa25-a0e504be5cc1.png)\n\n2024-09-28 11:03，@春道 评估是否发公告 主动布防【后续确认：评估无需发公告】\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/128756344/1728372609242-8c5fa611-8c84-4666-9855-14f4cca19b3f.png)\n\n2024-09-28 11:35，从10:26到11:15分，期间49分钟无客诉增长并于11:11分在群里同步客诉暂无增长。11:35左右 @流鸢 发现客诉又新增了3个，电话@春道 确认是否可以捞取商家id 主动布防 ****\n\n2024-09-28 11:50，@春道 拉齐产品讨论下一步方案\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/128756344/1728371735048-b0feab08-c824-4430-b910-c2d6b900c17e.png)\n\n2024-09-28 12:10，GOC流鸢 重新拉起电话会议，再次讨论存量处理方案\n2024-09-28 13:00，4PX产技侧实施降级预案，评估将存量订单转跨越揽方案 **【恢复执行】**\n\n同时揽收业务侧 @多助 调度资源外呼1000多商家进行布防\n2024-09-28 15:26，4PX 的技术开发完重推工具，验证重推接单\n2024-09-28 15:55，菜鸟侧 @多助 反馈系统已恢复正常，现场已根据系统在揽收\n2024-09-28 16:19，4PX @陈宇亭 反馈换配的已全部重推完成，故障恢复**【故障恢复】**\n\n****\n\n## 三、故障原因 \n### 3.1【背景说明】\n【项目背景】四方揽收一马平川项目将部分揽收订单按分单规则下发给揽收CP，各个揽收作业节点由CP负责处理和回传；\n\n【业务背景】四方业务于9月26日开启了金华市和湖州市两个区域的U-备货仓发订单，下发给安能物流，由其进行揽收；\n\n【故障背景】由于9月26日上游下发大量揽收任务，安能揽产能不足无法进行揽收，28日批量回传揽收失败且未按照定义约定回传报文，导致6102报错\n\n### 3.2【原因分析】\n一句话原因：\n\n:::tips\n临近国庆，安能揽收能力未能完全消化下发的大量�",
    "chunk_order_index": 0,
    "full_doc_id": "doc-628aeec84ae928ca4c3ef78b82fe1bd0"
  },
  "chunk-9bda18f7ea67647018a5d7aa6f091a47": {
    "tokens": 1200,
    "content": "�收；\n\n【故障背景】由于9月26日上游下发大量揽收任务，安能揽产能不足无法进行揽收，28日批量回传揽收失败且未按照定义约定回传报文，导致6102报错\n\n### 3.2【原因分析】\n一句话原因：\n\n:::tips\n临近国庆，安能揽收能力未能完全消化下发的大量揽收订单，导致安能回传了大量的当天未揽的异常，且异常报文未按标准文档进行回传，导致异常未能正确显示\n\n:::\n\n\n\n根因分析：\n\n1、业务于9月26日下发揽收任务给安能物流，在27号技术发现了预报订单和揽收订单差异过大，已及时反馈，但安能错误估计了其产能（表示正在逐步消化），28号批量回传揽收失败【诱因】\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/268572/1728698415326-985c1b2d-1c8c-4478-bb76-834f3fe4c7c3.png)\n\n2、9月28日故障的引发\n\n:::tips\n业务逻辑：菜鸟根据errorCode匹配对应的异常原因，若4PX传入errorCode，菜鸟会根据errorCode的映射文案透传至供应链，若没有传入errorCode则兜底取remark的值透传给供应链\n\n:::\n\n\n\n约定报文协议【菜鸟&4PX】\n\n实际报文协议【菜鸟&4PX】\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/144856316/1728955217121-ee751e2a-72d1-48b4-acad-97a5d253c0bf.png)\n\n+ 安能将errorCode内容填到remark字段，而errorCode缺失\n+ 4PX透传至菜鸟侧\n+ 菜鸟取remark值透传给供应链\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/144856316/1728955233806-332fbf9f-8cd8-4dd7-b2c8-77e9469da3f6.png)\n\n\n\n3、在6月份与安能进行对接及联调测试时，已明确约定报文格式及内容\n\n###### 联调记录：【6月份】\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/jpeg/144856316/1728955583058-b1e46892-b775-4f52-a191-329e212e8fe7.jpeg)\n\n数据库推送日志：\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/144856316/1728955583463-227ee84f-56c1-409a-aa73-6a8679c9bcc1.png)\n\n## 四、关注点分析\n【关注点1】测试通过，为何线上仍然出问题？\n\n:::tips\n6月份对接安能，当时测试的完全链路，安能按照正常约定传入，测试正常。9月业务开始灰度放量\n\n3个月的时间，cp可能会存在不规范变更引发故障\n\n改进：\n\n规范约束CP\n\n灰度时，场景要全（详见关注点2）\n\n增加校验（详见关注点3）\n\n:::\n\n\n\n【关注点2】灰度过程是怎样的？为何没有发现\n\n:::tips\n**分析：**实际单量超过了安能实际揽收能力，小单量灰度安能可正常揽收，未回传揽收失败，所以未发现问题\n\n1、对CP的揽收能力评估不到位\n\n2、灰度场景考虑不全\n\n**改进：**\n\n**规范要求：**\n\n1、灰度场景要全，最好走完全链路【盘点业务场景，先走少量实包，验证各场景正确后再扩大灰度范围】 \n\n2、联合上游一起，确认灰度结果是符合预期的 \n\n:::\n\n\n\n【关注点3】对于约定的字段内容是否能做校验（是否中文），提前发现？\n\n:::tips\n**4PX：**\n\n1、针对不同的业务场景对报文内容进行强制校验（从目前从Link的交互过程，没有进行强制校验）\n\n2、针对异常name、code数据字典内进行强校验（校验失败后触达CP重新处理）\n\n**菜鸟：**\n\n盘点应传errorCode但未传的场景，若发现没有errorCode监控报警  @不尤   11.30\n\n**（核实之前为何存在兜底传remark值的原因）**\n\n**供应链：**\n\n端面错误码体验：梳理错误码名单，若不在名单内需要报警  @晓午    10.17梳理\n\n长期：梳理目前还存在直接透传的页面，规避风险  @春道\n\n:::\n\n\n\n### 4.1【系统质量】\n#### 4.1.1 需求&设计评估\n**〖关注点1〗****是否涉及产品、技术方案评估？此核心",
    "chunk_order_index": 1,
    "full_doc_id": "doc-628aeec84ae928ca4c3ef78b82fe1bd0"
  },
  "chunk-494f864a7c050eb3f1a85684bb836c08": {
    "tokens": 1200,
    "content": "**\n\n端面错误码体验：梳理错误码名单，若不在名单内需要报警  @晓午    10.17梳理\n\n长期：梳理目前还存在直接透传的页面，规避风险  @春道\n\n:::\n\n\n\n### 4.1【系统质量】\n#### 4.1.1 需求&设计评估\n**〖关注点1〗****是否涉及产品、技术方案评估？此核心的问题是什么，如何改进？**\n\n- [x] 否，不涉及\n\n**〖问题总结〗N/A**\n\n#### 4.1.2 代码质量\n**〖关注点1〗是否代码自身存在漏洞或BUG、代码健壮性是否存在问题等?**\n\n**〖问题分析〗**\n\n+ **代码自身存在漏洞或BUG：否，代码逻辑按接口约定的字段和结构传值，并无问题**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/144856316/1728955881885-a2290dc0-ac53-4fab-934e-9a10db6d65c2.png)\n\n+ **代码健壮性是否存在问题：否，多个CP通用，且按固定报文结构回传上游，并无问题**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/144856316/1728955896854-abe7b3fb-90e4-461b-a83a-f9e19ab8054a.png)\n\n**〖改进点〗**主流程没问题时，加强场景细节验证\n\n\n\n**〖关注点2〗****是否经过CodeReview？CodeReview阶段是否发现问题？为何没发现？**\n\n+ **是否经过CR**\n    - [x] 是\n+ **是否设置合理的CR卡点**\n    - [x] 是\n+ **CodeReview阶段是否发现问题？为何没发现？后续如何发现？**\n    - [x] 不涉及\n\n**〖问题分析〗****N/A**\n\n\n\n**〖关注点3〗****测试阶段**\n\n+ **测试内容：**涉及的测试提交单、测试用例、测试结果等\n\n     ![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/331340/1728716526050-a9747bc1-6ad4-4735-a163-9fa05fe9486b.png)\n\n+ **测试人员：**刘定龙\n+ **是否经过测试验证**\n    - [x] 是，验证环境\n        - [x] 预发环境\n        - [x] 日常环境\n    - [x] 是，测试方法\n        - [x] 单元测试\n        - [x] 功能回归测试\n        - [x] 集成测试/链路测试\n        - [x] 验收测试\n+ **测试未发现原因是什么？后续如何改进？**\n    - [x] 其他：6月份联调测试并无问题\n\n**〖问题总结〗N/A**\n\n#### 4.1.3 变更质量 \n+ **是否涉及变更：**\n    - [x] 是\n+ **变更类型：**\n    - [x] 代码发布\n+ **变更平台是否接入ChangeFree：-不涉及**\n    - [x] 否\n+ **是否违反变更红线3.1**** **[链接](https://aliyuque.antfin.com/ngoc/fzg6dy/uar1k6)\n    - [x] 否\n\n**〖关注点1〗****灰度阶段**\n\n+ **是否经过灰度：**\n    - [x] 是\n+ **观测了哪些监控**：_可以附链接_\n    - [x] 其他：接收安能回传的数据，回传给上游，没有异常\n+ **是否灰度期间发现问题？**\n    - [x] 否，后续如何灰度发现？\n\n【问题总结】先走少量实包，盘点业务场景，验证各场景正确后再扩大灰度范围\n\n+ **未灰度发现原因**\n    - [x] 其他：灰度单量超过了安能实际揽收能力，小单量灰度未发现问题\n\n**〖问题总结〗**\n\n1、对CP的揽收能力评估不到位\n2、灰度场景考虑不全\n\n**〖改进点〗**_****_\n\n1、灰度场景要全，最好能走完全链路\n2、联合上游一起，确认灰度结果是符合预期的\n\n\n\n**〖关注点2〗****上线阶段**\n\n+ **是否有确定的监控观测指标**\n    - [x] 是，监控指标及监控链接：\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/144856316/1728956208464-bff86da2-98f0-4a4b-9d7a-169e30e31538.png)\n\n    - [ ] 否\n+ **是否在窗口期进行发布变更**\n    - [x] 是\n    - [ ] 否，原因：\n+ **变更是否影响上下游**\n    - [x] 是，是否有提前知会上下游评估及关注变更\n        - [x] 有提前知会\n\n![](https://intranet",
    "chunk_order_index": 2,
    "full_doc_id": "doc-628aeec84ae928ca4c3ef78b82fe1bd0"
  },
  "chunk-309c67f0e49c02befcc38b33b32fd074": {
    "tokens": 1200,
    "content": "0-4a4b-9d7a-169e30e31538.png)\n\n    - [ ] 否\n+ **是否在窗口期进行发布变更**\n    - [x] 是\n    - [ ] 否，原因：\n+ **变更是否影响上下游**\n    - [x] 是，是否有提前知会上下游评估及关注变更\n        - [x] 有提前知会\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/144856316/1728956225104-9f50a650-7e84-4b73-9ab6-eb57a13c68d9.png)\n\n****\n\n### 4.2【处置能力】\n#### 4.2.1 故障发现&响应\n+ **是否监控发现**\n    - [x] 故障触发方 监控发现：4PX监控发现\n    - [x] 故障受影响方 监控发现 \n    - [ ] 否，原因为：（监控无效/监控缺失）\n+ **是否5分钟内响应**\n    - [x] 是\n    - [ ] 否，原因为：\n+ **是否存在应急协同问题**\n    - [x] 是\n\n###### 应急SOP：【供应链内部探讨】\n:::tips\n###### 过程还原：\n+ 供应链和菜鸟GOC 在10点左右介入电话会议， 10:25电话会议结束，当时第一次会议同步的结论为：9月27日下午业务停止分单给新增揽收cp，业务降级止血完成。不会有增量，存量的只需cco布控，会上已经确认话术已下放，当时会议中无人判断对存量单据修复需要订正\n+ 10:37分供应链技术@采月 群里同步：供应链侧的止血应该是：已经错的单据要恢复。不然客诉会增加，于是重新拉起第二次电话会议对焦存量处理方案，结论如下：\n\n   ![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/128756344/1728359809753-51bbede7-0bbf-48a4-aa25-a0e504be5cc1.png)\n\n+ 11:03 供应链技术 @春道也在群内同步 ：评估是否挂公告\n+ 从10:26到11:15分，期间49分钟无客诉增长。流鸢于11:11分群里同步客诉情况8+（叠加会议结论误以为止血）\n+ 11:35左右 @流鸢 发现客诉又新增了3个，联系供应链技术@春道 确认是否可以捞取商家id 主动布防\n+ 11:45左右GOC流鸢再次拉起第三次应急会议，拉通各方讨论影响消除方案（由4PX&菜鸟负责消除）\n\n ![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/128756344/1728371991139-936f29e9-7e51-4a9d-a57f-32033cb9b2be.png?x-oss-process=image%2Fformat%2Cwebp%2Fresize%2Cw_604%2Climit_0)\n\n**问题：**\n\n受影响方对于业务影响的判断\n\n:::\n\n2、风险预警的触达以及应急中客诉量的统计（应急中有关此疑问的解答）\n\n[**link**](https://aliyuque.antfin.com/ngoc/ul2sru/ysga9oyu82d809nf?singleDoc#%20)\n\n#### 4.2.2 故障定位&恢复\n+ **主要恢复方式：**\n    - [x] 预案降级\n\n**〖关注点1〗定位&恢复阶段存在什么问题？是否可以增加预案，****有更快的恢复方式？****相关的优化改进？**\n\n**〖问题总结〗**已提前准备了预案，但预案在执行的过程中出现了新问题\n已下发安能的揽收订单，换配过程中其实需要重新开发工具\n\n**〖改进点〗**\n\n1、单量放大时，提前与安能沟通好产能问题\n2、预案覆盖场景要全面，比如：揽收时间过期接单方数据校验问题\n\n\n**〖关注点2〗业务自身是否具备容灾逃逸能力？后续如何改进？**_/* 如涉及基础设施引发的故障，可填写*/_\n\n- [x] 具备容灾能力\n\n**〖问题总结〗**异常转单线上化能力缺失\n\n**〖改进点〗**异常转单线上化能力建设，出现异常在运营后台能用交互界面实现转单\n\n## 五、故障总结反思\n**【做得好的】**\n\n1、提前考虑CP揽收产能不足的情况，提前准备揽收订单转发技术实操预案\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/144856316/1728956380497-f9ce3ff4-9d15-4f2c-a72",
    "chunk_order_index": 3,
    "full_doc_id": "doc-628aeec84ae928ca4c3ef78b82fe1bd0"
  },
  "chunk-11f451ea6693350f9abe3fd4cbd6622a": {
    "tokens": 820,
    "content": "交互界面实现转单\n\n## 五、故障总结反思\n**【做得好的】**\n\n1、提前考虑CP揽收产能不足的情况，提前准备揽收订单转发技术实操预案\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/144856316/1728956380497-f9ce3ff4-9d15-4f2c-a72c-edf9ca1d091c.png)\n\n2、应急响应及时，积极解决存量单量问题，在技术侧接收到具体的存量订单解决方案后，连同业务侧确认并捞取需要处理的订单，并执行和优化订单重推预案，验证重推结果，分批量进行重推。\n\n**【经验教训】**\n\n1、新的功能上线，不仅要考虑正常流场景，异常流场景也要考虑全面。在功能上线后，确保异常流运营工具能快速处理实际问题。\n\n2、要做好全链路联调、测试、验收、灰度问题，并通知到各域负责人\n\n## 六、故障Action\n_/* 填写说明：Action制定原则*/_\n\n> _机制流程建议不超过总数的20%；_\n>\n> _Action数量建议不超过10条；_\n>\n> _短期Action建议1-2周内完成，并内部验收（如缺陷修复、监控等避免故障再发的的措施需列为短期Action）；_\n>\n> _P1P2需至少有1个keyAction（治本Action，从根源上避免类似重大故障再发生/控制爆炸半径）；_\n>\n> _Action描述须完整、语言简洁，一目了然。_\n>\n\n| **序号** | **BU** | *******Action标题** | *******负责人** | *******计划完成时间** | **Action描述** | **验收标准** |\n| --- | --- | --- | --- | --- | --- | --- |\n| 1 | 4PX | 短期：强制校验 | 赖宇鹏 | 2024-10-24 | 针对不同的业务场景对报文内容进行强制校验（从目前从Link的交互过程，没有进行强制校验） | 异常code和描述必须有值 |\n| 2 | | 短期：数据校验 | | | 4PX针对异常code以数据字典定义好的进行强校验；remark校验是否中文（校验失败后触达CP重新处理） | 异常code必须符合约定的内容 |\n| 3 | | 长期：跨域联调 | 刘定龙 | sop  | 针对涉及多方的变更进行跨域联调（测试PM关注各域报文的参数含义和用途） |  |\n| 4 | | 长期：业务验收 | 赖宇鹏 | sop | 业务验收需要关注前台业务影响 |  |\n| 5 | 菜鸟 | 盘点应传errorCode但未传的场景，若发现没有errorCode监控报警   | 不尤    | 11.30 |  |  |\n| 6 | 供应链 | 端面错误码体验：梳理错误码名单，若不在名单内需要报警   【揽收页面】 |  晓午  |  10.17梳理 |  |  |\n| 7 | | 长期：梳理域内目前还存在直接透传的页面，规避风险   | 春道 |  |  |  |\n\n\n## 七、影响产品线&影响面\n    - [x] 是否有客诉量：36",
    "chunk_order_index": 4,
    "full_doc_id": "doc-628aeec84ae928ca4c3ef78b82fe1bd0"
  },
  "chunk-42ac4ecbe4f36e1a05ee2913f6e0d87a": {
    "tokens": 1200,
    "content": "![](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/9827/1659103353652-0274c8cd-7318-4cd9-b730-0d66221680b6.png)\n\n_**内容涉及公司B3级别以上机密数据，请注意保密！**_\n\n| **故障链接** | [https://tr.alibaba-inc.com/ormEmergency/workbench/emergency/202410030000000450001](https://tr.alibaba-inc.com/ormEmergency/workbench/emergency/202410030000000450001) |\n| --- | --- |\n| **复盘时间** | 10月12日 周六 10:00 - 11:00 |\n| **复盘地点** | C1-6-14-S |\n| **参与人** | 兮扬、不策、太妍元召、冷泉、华邪、春道、斯启至清、鲸月 |\n| **主持人** | 流鸢 |\n\n\n## 一、故障简述\n故障简述：于10月3日13:16批量客诉预警，JIT揽收组包报错“请求响应错误“，根因为接口请求header长度超过接口服务设置请求头8k大小限制导致报错，于17:33前端发布文案为引导文案故障恢复，于23:42将服务请求头限制从8k增加至16k，影响消除，期间客诉26+\n\n## 二、故障过程回顾\n### 2.1【故障处理时间线】\n故障时间线：\n\n2024-04，上门揽商业化二期项目在4月中旬上线，当时referer叠加cookie未出现超长情况**【故障引入】**\n\n2024-10-02 15:34，客诉群3例商家反馈JIT揽收无法组包，报错“请求响应错误”，当时告知客服历史问题引导商家分批操作。2号当天客诉共4个\n\n2024-10-03 13:16，共3例商家反馈，触发风险预警，GOC值班同学拉起应急群**【故障发现】**\n\n2024-10-03 13:24，兮扬 接手风险单 【故障响应】\n\n2024-10-03 13:49，@晓午 拉起电话会议\n2024-10-03 14:07，会议达成一致结论：历史问题（cookie过长），商家通过清除缓存或分批操作即可解决，影响可控，长期需要等架构升级10.15 完成全量。短期方案是将报错文案修改为引导商家操作的提示（此时客诉从9:30截止当前共4个）【初因定位】\n应急电话会议结束，@华邪 和 @景钟 单独电话对焦action具体事项\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/128756344/1728354012947-919ab64b-c6f8-4600-accc-f3cd826c9789.png)\n\n2024-10-03 15:09，确认action的进展为：需进一步确认数据\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/128756344/1728354478973-08a68ad7-9de1-460d-971e-ce55760ef19d.png)\n\n2024-10-03 16:10，@流鸢 发现客诉突增到20+，群里确认情况并发布故障通告**【故障发生】**\n\n2024-10-03 17:33，验证通过，@华邪 发布错误提示文案 【恢复执行】\n\n客诉无增长，故障恢复**【故障恢复】**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/128756344/1728355120658-9a126080-cecc-4722-8707-6ef395393d4d.png)\n\n2024-10-03 17:40，技术内部讨论影响消除方案\n2024-10-03 23:42，aidc-ib-web-f 服务请求头限制从8k增加至16k变更已发布线上【影响消除】![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/128756344/1728355546593-45346df9-8dc0-49d6-b2eb-119e18377fd9.png)\n\n## 三、故障原因\n### 3.1【背景说明】\n:::tips\n创建揽收单的弹窗页面使用RB搭建，弹窗时将用户勾选的所有PO单号以url的方式带到了新页面里，在该页面提交创建揽收单的http请求的，请求头里的referer会将之前的所有PO单号带上，当请求头和cookie加起来超过8KB大小，会被nginx拦截，报400错误\n\n:::\n\n\n\n### 3.2【原因分析】\n**一句话原因：**\n\n:::tips\n接口请求header长度超过接口服务设置请求头8k大小限制\n\n:::\n\n\n\n**根因分析：**\n\n:::tips\n1、依赖前台域名 *.aliexpress.com，用户在c",
    "chunk_order_index": 0,
    "full_doc_id": "doc-830453f9be1ea4ce5e3f9825ec9a5eb2"
  },
  "chunk-0a3f93d17b6ef04c7b63c699c1f4a31d": {
    "tokens": 1200,
    "content": "求头里的referer会将之前的所有PO单号带上，当请求头和cookie加起来超过8KB大小，会被nginx拦截，报400错误\n\n:::\n\n\n\n### 3.2【原因分析】\n**一句话原因：**\n\n:::tips\n接口请求header长度超过接口服务设置请求头8k大小限制\n\n:::\n\n\n\n**根因分析：**\n\n:::tips\n1、依赖前台域名 *.aliexpress.com，用户在csp平台操作后会被其他服务写入较多cookie，导致接口请求时携带的cookie长度轻松超过4k\n\n2、jit上门揽在csp页面上通过页面访问 https://dchain-web.aliexpress.com/river/app/clp_standard_pick_up/entities/PickupOrderCreateVO/update?recordCod=${PO单号列表} 的方式请求RB搭建的上门揽页面，在批量接单几百单的场景下，每个PO单号长度20个字符，批量接单超过两百，就会导致页面url超过4k；http请求中，浏览器会自动将当前页面url带入请求头的referer中，占据请求头大小；\n\n3、上门揽服务接口使用基础镜像，默认请求头大小限制为8k，在以上的两个较大的header值下，加上，批量揽收时候接口请求头会超过服务限制，导致接口请求返回400，用户无法进行操作。\n\n:::\n\n\n\n\n\n## 四、关注点分析\n【关注点1】架构容错性不足\n\n:::tips\n**分析：**所有服务默认限制header大小为8k，在AE场景下通过域名*.aliexpress.com提供服务，此域名下提供的服务较多，写入较多cookie，所有请求都会带上所有服务写入cookie，会占据较大header值，在此基础上get接口参数和页面url稍长即超出服务header限制，导致前端请求服务接口失败；此次处理只将aidc-ib-web-f应用请求header升级到16k，其他应用还存在此类风险，并且此应用还存在cookie过长导致接口失败\n\n**改进：**\n\n短期：网关层统一拦截去除无用header以及cookie值（按照应用纬度）确保服务稳定提供服务  [@不策](undefined/jeff.fjf) 带回，和架构组后续讨论\n\n长期：cookie会出现过长的问题，风险上升，推动前台架构升级   [@兮扬](undefined/wensong.ws)\n\n:::\n\n\n\n【关注点2】前端组件设计&使用合理性\n\n:::tips\n**分析：**\n\n当前RB搭建的页面即使是弹窗也使用的是新页面方式，会将所有请求参数以url的方式带入\n\n**改进：**\n\n1. 捞取批量单号场景 改成post请求   [@华邪](undefined/zoukanghua.zkh)  10.13捞取\n2. RB页面升级 [@张猴](undefined/kaihao.zkh) 10.30给方案\n\n:::\n\n\n\n【关注点3】监控合理性\n\n:::tips\n**分析：**\n\n1. 报错的http请求打到了aidc-ib-web-f应用的层，未到达tomcat层，当前nginx层错误返回码监控有缺失\n\n**改进：**\n\n1. 域内web应用增加nginx层返回错误码监控   已完成\n\n:::\n\n\n\n### 4.1【系统质量】\n#### 4.1.1 需求&设计评估\n**〖关注点1〗****是否涉及产品、技术方案评估？此核心的问题是什么，如何改进？**\n\n- [ ] **是，涉及**\n    - [x] 系统架构设计缺陷\n        - [x] 容错性不足 \n\n**〖问题总结〗见关注点1**\n\n#### 4.1.2 代码质量-不涉及\n**〖关注点1〗是否代码自身存在漏洞或BUG、代码健壮性是否存在问题等?**\n\n**〖问题分析〗**\n\n**〖改进点〗**_**需明确写明不同故障相关方的改进项（若有的话），下同。**_\n\n1、\n\n\n\n**〖关注点2〗****是否经过CodeReview？CodeReview阶段是否发现问题？为何没发现？**\n\n+ **是否经过CR**\n    - [x] 是\n    - [ ] 否\n    - [ ] 不涉及\n+ **是否设置合理的CR卡点**\n    - [x] 是\n    - [ ] 否\n    - [ ] 不涉及\n+ **CodeReview阶段是否发现问题？为何没发现？后续如何发现？**\n    - [ ] 是\n    - [x] 否\n    - [ ] 不涉及\n\n**〖问题分析〗******\n\n**〖改进点〗**_**需明确写明不同故障相关方的改进项（若有的话），下同。**_\n\n1、\n\n\n\n**〖关注点3〗****测试阶段**\n\n+ **测试内容：**涉及的测试提交单、测试用例等\n+ **测试人员：**\n+ **是否经过测试验证**\n    - [ ] 是，验证环境\n        - [ ] 预发环境\n        - [ ] 日常环境\n    - [ ] 是，测试方法\n        - [ ] 单元测试\n        - [ ] 功能回归测试\n        - [ ] 集成",
    "chunk_order_index": 1,
    "full_doc_id": "doc-830453f9be1ea4ce5e3f9825ec9a5eb2"
  },
  "chunk-639cd5199c56a6ae6febbe756297be4c": {
    "tokens": 1200,
    "content": "**〖关注点3〗****测试阶段**\n\n+ **测试内容：**涉及的测试提交单、测试用例等\n+ **测试人员：**\n+ **是否经过测试验证**\n    - [ ] 是，验证环境\n        - [ ] 预发环境\n        - [ ] 日常环境\n    - [ ] 是，测试方法\n        - [ ] 单元测试\n        - [ ] 功能回归测试\n        - [ ] 集成测试/链路测试\n        - [ ] 验收测试\n    - [ ] 否\n    - [ ] 不涉及\n+ **测试未发现原因是什么？后续如何改进？**\n    - [ ] 回归测试遗漏\n        - [ ] 手工回归测试用例遗漏\n        - [ ] 自动化未建设\n        - [ ] 自动化回归覆盖不足\n        - [ ] 其他：__________\n    - [ ] 新场景测试遗漏\n        - [ ] 功能测试用例遗漏，包括正常分支和异常分支\n        - [ ] 容灾兜底测试遗漏\n        - [ ] 客户端兼容性测试遗漏\n        - [ ] 埋点测试遗漏\n        - [ ] 性能测试遗漏，影响评估不足\n        - [ ] 安全测试遗漏\n    - [ ] 其他：__________\n\n**〖问题总结〗**\n\n**〖改进点〗**_**需明确写明不同故障相关方的改进项（若有的话），下同。**_\n\n1、\n\n#### 4.1.3 变更质量-不涉及\n+ **是否涉及变更：**\n    - [ ] 是\n    - [x] 否\n+ **变更类型：**\n    - [ ] 代码发布\n    - [ ] 配置变更\n    - [ ] 其他变更：____________\n    - [ ] 不涉及\n+ **变更平台是否接入ChangeFree：**\n    - [ ] 是，CF变更单链接：________\n\n_/*要这样的链接_ [https://aicf.alibaba-inc.com/aicf/change/detail/1725370372](https://aicf.alibaba-inc.com/aicf/change/detail/1725370372) */\n\n    - [ ] 否\n+ **是否违反变更红线3.1**** **[链接](https://aliyuque.antfin.com/ngoc/fzg6dy/uar1k6)\n    - [ ] 是，违反哪条原则：\n    - [ ] 否\n\n\n\n**〖关注点1〗****灰度阶段**\n\n+ **是否经过灰度：**\n    - [x] 是\n    - [ ] 否\n+ **观测了哪些监控**：_可以附链接_\n    - [ ] 黑屏、白屏\n    - [ ] GOC监控：\n    - [ ] 系统大盘：\n    - [ ] 其他：___________\n+ **是否灰度期间发现问题？**\n    - [ ] 是\n        - [ ] 是否灰度流量过大，导致故障\n        - [ ] 灰度发现但未有效或及时修复，导致故障\n        - [ ] 其他：___________\n    - [ ] 否，后续如何灰度发现？_____________\n+ **未灰度发现原因**\n    - [ ] 应用灰\n        - [ ] 灰度流量太小\n        - [ ] 灰度阶段无监控\n        - [ ] 灰度批次不合理\n        - [ ] 超长时间灰度才能发现\n    - [ ] 业务灰：策略不合理\n    - [ ] 灰度无法发现\n    - [ ] 其他：_____________\n\n**〖问题总结〗**\n\n**〖改进点〗**_**需明确写明不同故障相关方的改进项（若有的话），下同。**_\n\n1、\n\n\n\n**〖关注点2〗****上线阶段**\n\n+ **是否有确定的监控观测指标**\n    - [ ] 是，监控指标及监控链接：\n    - [ ] 否\n+ **是否在窗口期进行发布变更**\n    - [ ] 是\n    - [ ] 否，原因：\n+ **变更是否影响上下游**\n    - [ ] 是，是否有提前知会上下游评估及关注变更\n        - [ ] 有提前知会\n        - [ ] 没有提前知会\n    - [ ] 否\n\n**〖问题总结〗**\n\n**〖改进点〗**_**需明确写明不同故障相关方的改进项（若有的话），下同。**_\n\n1、\n\n\n\n#### 注（历史变更）：上门揽商业化二期项目4月中旬上线，验证过100单组包发货验证通过（当时referer叠加cookie未出现超长情况）\n### 4.2【处置能力】\n#### 4.2.1 故障发现&响应\n+ **是否监控发现**\n    - [x] 否，原因为：（监控缺失）\n- [ ] [https://gsre.alibaba-inc.com/risk-detail?id=21953&tenant=SC](https://gsre.alibaba-inc.com/risk-detail?id=21953&tenant=SC)\n+ **是否5分钟内响应**\n    - [x] 是\n    - [ ] 否，原因为：\n+ **是否存在应急协同问题**\n    - [x] 否\n\n**〖问题",
    "chunk_order_index": 2,
    "full_doc_id": "doc-830453f9be1ea4ce5e3f9825ec9a5eb2"
  },
  "chunk-985f4978a5d92caa582540c11f771fe6": {
    "tokens": 622,
    "content": "] 否，原因为：（监控缺失）\n- [ ] [https://gsre.alibaba-inc.com/risk-detail?id=21953&tenant=SC](https://gsre.alibaba-inc.com/risk-detail?id=21953&tenant=SC)\n+ **是否5分钟内响应**\n    - [x] 是\n    - [ ] 否，原因为：\n+ **是否存在应急协同问题**\n    - [x] 否\n\n**〖问题总结〗**\n\n#### 4.2.2 故障定位&恢复\n+ **主要恢复方式：**\n    - [x] 代码发布/回滚：修改aidc-ib-web-f的nginx和tomcat参数\n\n**〖关注点1〗定位&恢复阶段存在什么问题？是否可以增加预案，****有更快的恢复方式？****相关的优化改进？**\n\n**〖问题总结〗无其他止血方案**\n\n\n\n## 六、故障Action\n| **序号** | *******Action标题** | *******负责人** | *******计划完成时间** | **验收标准** | **验收人** |\n| --- | --- | --- | --- | --- | --- |\n| 1 | 短期：aidc-ib-web-f调整nginx和tomcat最大请求头参数 | 晓午 | 已完成 | 线上400单建单无报错 | 鲸月 |\n| 2 | 短期：aidc-ib-web-f应用增加nginx 400报错监控 | 晓午 | 已完成 | 配置sunfire监控 | 鲸月 |\n| 3 | 捞取批量单号场景 改成post请求 | 华邪 | 10.13（捞取） |  | |\n| 4 | RB页面升级 | 张猴 | 10.30 给方案 |  | |\n| 5 | 全局架构升级：网关层统一拦截去除无用header以及cookie值（按照应用纬度）确保服务稳定提供服务  | 不策带回讨论  |  |  | |\n| 6 | 长期：cookie会出现过长的问题，风险上升，推动前台架构升级 | 兮扬 |  |  | |\n\n\n## 七、影响产品线&影响面\n    - [x] 是否有客诉量：26+\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/128756344/1728549496560-fafc2fc6-0b40-4c3b-a254-c10d9c670554.png)\n\n## 八、故障定级&定责&故障分自查【P5，无需定责】\n【故障等级】P5\n\n【故障责任方】无需定责\n\n【故障分】_无需记录_",
    "chunk_order_index": 3,
    "full_doc_id": "doc-830453f9be1ea4ce5e3f9825ec9a5eb2"
  },
  "chunk-a657dc72dca56e2aaa32dd7af32f12ed": {
    "tokens": 1200,
    "content": "## 一、故障简述\n2024年10月21日20:03收到用户上报出现订单详情打开报错误码问题，飞猪订单详情无法正常打开，故障原因初步确认是omega服务端线程池满导致，于20:18流量洪峰过后自然恢复，期间国内酒店进线反馈100+，达P4故障等级。\n\n## 二、影响产品线及影响面\n- [x] 是否影响可用性：否\n- [x] 业务影响：\n\n1）酒店套餐订单详情无法正常打开；\n\n2）机票宝贝订详无法打开；\n\n3）首页偶发仅展示部分模块/猜喜丢失。\n\n![酒店Android订详](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/675/1729561072149-0ea41559-4101-43fc-93e6-f7c8be48f5db.png)![酒店iOS订详](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/675/1729561037564-0b9efd36-0157-4e5d-87df-2c7cae23c543.png)![机票订详](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/675/1729562955655-8ee342cf-b760-4bc3-b4c3-0922a3415386.png)![首页猜喜](https://intranetproxy.alipay.com/skylark/lark/0/2024/jpeg/4559/1729563909367-e5e0b9d9-95f3-4f74-a6e8-9768e6fd7030.jpeg)\n\n- [x] 是否有客诉：\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/41240/1730080448055-d3fe70ee-5b6a-447c-a65a-5246c08b700b.png)\n\n- [x] 是否有社会舆情_：_否\n- [x] 是否产生资损：否\n\n## 三、故障过程回顾\n2024-10-21 20:03，**【故障发生】【故障发现】**飞猪全员群、双11值班现场等用户集中上报出现订单详情打开报错误码问题\n\n2024-10-21 20:03，**【业务响应】**值班现场思承、馬达、园直、司命、龙幽等即时响应排查，确认受影响的是宝贝订单详情问题，且是前端报错，并拉度假前端率然介入排查。率然确认酒店订详与度假订详是两套代码，互不影响，遂拉酒店前端影羽、秦渡进行排查\n\n2024-10-21 20:05，首页出现报警，出现部分模块加载不出，项前介入排查\n\n2024-10-21 20:08，**【初因定位】**秦渡定位，后端mtop接口\"mtop.fliggy.ssif.pattern.hotelgroup.orderdetail.get\"返回结果中，data为空\n\n2024-10-21 20:09，首页问题，项前通过扩容解决  \n2024-10-21 20:10，酒店，fod-hotelgroup扩容+40台机器\n\n2024-10-21 20:18，**【故障恢复】**流量洪峰过后自然恢复，以fod-hotelgroup的rt恢复时间判断，在20:18恢复至正常\n\n2024-10-21 20:30，影羽联系项前反馈omega问题，需要项前一起排查\n\n2024-10-21 21:00，**【初因定位】**项前经初步排查、看代码，猜测是omega client线程池满后拒绝策略，不返回结果。21日夜间双11汇报确定，22日进行问题梳理和确认。\n\n2024-10-22 10:00，龙幽、影羽、项前、化云、思承等梳理过程材料，确认当天进行单机压测，做现场还原。\n\n2024-10-22 15:00，**【根因定位】**馬达、秋合、项前，在预发环境经过单机压测进行问题复现，确认为omega client线程池满后，不返回聚合结果\n\n## 四、故障原因\n### 4.1【背景说明】\n背景：omega以客户端形式在应用启动，核心线程和最大线程设置均是32，在大流量冲击场景下，线程池打满后，大量请求拒绝处理。\n\n参考材料：[飞猪接入dx的动态模板](https://aliyuque.antfin.com/omega/twilwu/eq6n4q)\n\n### 4.2【原因分析】\n##### 一句话原因：\n双11订详流量上涨超出预期，导致订详fod-hotelgroup的omega线程池打满，大量进等待队列的请求超时，请求直接拒绝失败，返回空数据。酒店宝贝订详对该异常情况缺少兜底，对C透出用户不可理解的错误码，引发用户进线增长。\n\n##### 根因分析：\n![首页流量相对于平时，上涨4倍](https://intranetproxy",
    "chunk_order_index": 0,
    "full_doc_id": "doc-78aaada48aaca19a422d20d8113dbffb"
  },
  "chunk-1f3b916f07f5d2f78c1c1253eb7cbb4c": {
    "tokens": 1200,
    "content": "双11订详流量上涨超出预期，导致订详fod-hotelgroup的omega线程池打满，大量进等待队列的请求超时，请求直接拒绝失败，返回空数据。酒店宝贝订详对该异常情况缺少兜底，对C透出用户不可理解的错误码，引发用户进线增长。\n\n##### 根因分析：\n![首页流量相对于平时，上涨4倍](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/29156495/1729655001111-a834ee40-941c-4ffc-a92c-c71847061d23.png)  \n![机票详情页上涨50倍](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/29156495/1729655244714-583906e8-74bf-47c8-861c-92d4606cf80a.png)\n\n![酒店详情页上涨100倍](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/29156495/1729655537069-b4b8fb7f-f5ce-4b12-9cb1-6fdfee81c7a0.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/29156495/1729655071115-b2483522-f491-42f1-9957-8376d868d2e2.png)\n\n![详情页线程池](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/29156495/1729655080305-27e9de32-e834-4190-b6cb-139d5917dda9.png)\n\n![首页线程池](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/29156495/1729655152702-cfa7c562-f4a2-4319-b582-6a9c72e99112.png)\n\n可以看到，核心线程和最大线程设置均是32，不太合理，线程池打满处理不过来。\n\n![机票宝贝订详报错量（日）](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/675/1729565218072-8074ef31-8c86-4857-995f-781b43ef5f81.png)\n\n![机票宝贝订详阻塞数据](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/675/1729565253789-c92d03b3-d42f-4680-9467-a5d3811d6ad5.png)\n\n![机票宝贝订详取omega数据为空](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/675/1729565277559-90ca4d8b-097b-4424-8b65-f1e449c20e91.png)\n\n![机票宝贝订详链路树示意](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/675/1729565299670-42f49e37-ef69-4866-86c5-3219df0533af.png)\n\n## 五、关注点分析\n###### 关注点1：线程池满的原因是什么？大促期间对于流量是否有进行过评估，线程池的管理机制和failover机制是什么？\n:::info\n**问题总结：**\n\n线程池满原因---流量超预期，超出设计的承载能力；\n\n线程池管理机制---线程池写死32，量偏低，高并发情况下会有风险\n\nfailover机制---拒绝策略，如果满会用当前线程继续执行，大流量情况下只会加剧问题\n\n**改进点：**线程池数量及failover机制会给使用方自行调整配置的操作空间，若不调整按默认值进行。[@项前](undefined/xiangbingtong.xbt) 11.1\n\n:::\n\n###### 关注点2：大促压测为何没发现这个问题？是该场景未压测到，还是压测流量评估不到位？\n:::info\n**问题总结：**压测未发现原因---未压到瓶颈（按APP首页3倍流量来压测，当天首页实际已远超过3倍）、未从mtop入口施压\n\n**改进点：**后续压测方案从mtop入口开始施压。\n\n:::\n\n###### 关注点3：本次故障用户看到的订详报错文案是不合适的，订详对该异常情况是否有相应的兜底策略？\n:::info\n**问题总结：**不应对C端直接透传错误码\n\n**改进点：**调整对C的兜底错误提示（具体细分到什么颗粒度及文案由产品端决定）---酒店套餐订详侧 [@墨银](undefined/moyin.lxy) 11.1\n\n:::\n\n###### 关注点4：本次故障依赖用户上报发现，监控为什么没有预警？\n:::info\n**问题总结：**高峰期，ateye采集资源也瓶颈了，导致异常采集不到，\n\n![1021高峰期ateye采集资源瓶颈](https://intranetproxy.alipay.com/skylark",
    "chunk_order_index": 1,
    "full_doc_id": "doc-78aaada48aaca19a422d20d8113dbffb"
  },
  "chunk-2d337716ebe1cd05ef0d2155fb196578": {
    "tokens": 1200,
    "content": "订详侧 [@墨银](undefined/moyin.lxy) 11.1\n\n:::\n\n###### 关注点4：本次故障依赖用户上报发现，监控为什么没有预警？\n:::info\n**问题总结：**高峰期，ateye采集资源也瓶颈了，导致异常采集不到，\n\n![1021高峰期ateye采集资源瓶颈](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/675/1729590852501-deffafaa-aeda-4f4f-9c69-00f10c6a631d.png)\n\n**改进点：**后续要高保的话，还是要用sunfire，这个交由各业务方自行判断。\n\n:::\n\n\n\n### 5.1【系统质量】--不涉及\n#### 5.1.1 需求&设计评估\n**〖关注点1〗****是否涉及产品、技术方案评估？此核心的问题是什么，如何改进？**\n\n- [ ] **是，涉及**\n    - [ ] 需求评估遗漏\n    - [ ] 产品设计缺陷\n    - [ ] 系统架构设计缺陷\n        - [ ] 容错性不足 \n        - [ ] 单点，无冗余\n        - [ ] 缺乏自我保护\n        - [ ] 缓存设计不当\n        - [ ] 容量评估不足\n        - [ ] 非幂等设计\n        - [ ] 强弱依赖不合理\n        - [ ] 其他：__________\n- [ ] 否，不涉及\n\n**〖问题总结〗**\n\n**〖改进点〗**_**需明确写明不同故障相关方的改进项（若有的话），下同。**_\n\n\n\n#### 5.1.2 代码质量\n**〖关注点1〗是否代码自身存在漏洞或BUG、代码健壮性是否存在问题等?**\n\n**〖问题分析〗**\n\n**〖改进点〗**_**需明确写明不同故障相关方的改进项（若有的话），下同。**_\n\n\n\n\n\n**〖关注点2〗****是否经过CodeReview？CodeReview阶段是否发现问题？为何没发现？**\n\n+ **是否经过CR**\n    - [ ] 是\n    - [ ] 否\n    - [ ] 不涉及\n+ **是否设置合理的CR卡点**\n    - [ ] 是\n    - [ ] 否\n    - [ ] 不涉及\n+ **CodeReview阶段是否发现问题？为何没发现？后续如何发现？**\n    - [ ] 是\n    - [ ] 否\n    - [ ] 不涉及\n\n**〖问题分析〗******\n\n**〖改进点〗**_**需明确写明不同故障相关方的改进项（若有的话），下同。**_\n\n\n\n\n\n**〖关注点3〗****测试阶段**\n\n+ **测试内容：**涉及的测试提交单、测试用例等\n+ **测试人员：**\n+ **是否经过测试验证**\n    - [ ] 是，验证环境\n        - [ ] 预发环境\n        - [ ] 日常环境\n    - [ ] 是，测试方法\n        - [ ] 单元测试\n        - [ ] 功能回归测试\n        - [ ] 集成测试/链路测试\n        - [ ] 验收测试\n    - [ ] 否\n    - [ ] 不涉及\n+ **测试未发现原因是什么？后续如何改进？**\n    - [ ] 回归测试遗漏\n        - [ ] 手工回归测试用例遗漏\n        - [ ] 自动化未建设\n        - [ ] 自动化回归覆盖不足\n        - [ ] 其他：__________\n    - [ ] 新场景测试遗漏\n        - [ ] 功能测试用例遗漏，包括正常分支和异常分支\n        - [ ] 容灾兜底测试遗漏\n        - [ ] 客户端兼容性测试遗漏\n        - [ ] 埋点测试遗漏\n        - [ ] 性能测试遗漏，影响评估不足\n        - [ ] 安全测试遗漏\n    - [ ] 其他：__________\n\n**〖问题总结〗**\n\n**〖改进点〗**_**需明确写明不同故障相关方的改进项（若有的话），下同。**_\n\n\n\n#### 5.1.3 变更质量\n+ **是否涉及变更：**\n    - [ ] 是\n    - [ ] 否\n+ **变更类型：**\n    - [ ] 代码发布\n    - [ ] 配置变更\n    - [ ] 其他变更：____________\n    - [ ] 不涉及\n+ **变更平台是否接入ChangeFree：**\n    - [ ] 是，CF变更单链接：________\n\n_/*要这样的链接_ [https://aicf.alibaba-inc.com/aicf/change/detail/1725370372](https://aicf.alibaba-inc.com/aicf/change/detail/1725370372) */\n\n    - [ ] 否\n+ **是否违反变更红线3.1 **[链接](https://aliyuque.antfin.com/trecs/fzg6dy/uar1k6)\n    - [ ] 是，违反哪条原则：\n    - [ ] 否\n\n\n\n**〖关注点1〗****灰度阶段**\n\n+ **是否经过灰度：**",
    "chunk_order_index": 2,
    "full_doc_id": "doc-78aaada48aaca19a422d20d8113dbffb"
  },
  "chunk-937624f445b8d5ef5f621ead49ddd2c3": {
    "tokens": 1059,
    "content": "aicf.alibaba-inc.com/aicf/change/detail/1725370372) */\n\n    - [ ] 否\n+ **是否违反变更红线3.1 **[链接](https://aliyuque.antfin.com/trecs/fzg6dy/uar1k6)\n    - [ ] 是，违反哪条原则：\n    - [ ] 否\n\n\n\n**〖关注点1〗****灰度阶段**\n\n+ **是否经过灰度：**\n    - [ ] 是\n    - [ ] 否\n+ **观测了哪些监控**：_可以附链接_\n    - [ ] 黑屏、白屏\n    - [ ] GOC监控：\n    - [ ] 系统大盘：\n    - [ ] 其他：___________\n+ **是否灰度期间发现问题？**\n    - [ ] 是\n        - [ ] 是否灰度流量过大，导致故障\n        - [ ] 灰度发现但未有效或及时修复，导致故障\n        - [ ] 其他：___________\n    - [ ] 否，后续如何灰度发现？_____________\n+ **未灰度发现原因**\n    - [ ] 应用灰\n        - [ ] 灰度流量太小\n        - [ ] 灰度阶段无监控\n        - [ ] 灰度批次不合理\n        - [ ] 超长时间灰度才能发现\n    - [ ] 业务灰：策略不合理\n    - [ ] 灰度无法发现\n    - [ ] 其他：_____________\n\n**〖问题总结〗**\n\n**〖改进点〗**_**需明确写明不同故障相关方的改进项（若有的话），下同。**_\n\n\n\n\n\n**〖关注点2〗****上线阶段**\n\n+ **是否有确定的监控观测指标**\n    - [ ] 是，监控指标及监控链接：\n    - [ ] 否\n+ **是否在窗口期进行发布变更**\n    - [ ] 是\n    - [ ] 否，原因：\n+ **变更是否影响上下游**\n    - [ ] 是，是否有提前知会上下游评估及关注变更\n        - [ ] 有提前知会\n        - [ ] 没有提前知会\n    - [ ] 否\n\n**〖问题总结〗**\n\n**〖改进点〗**_**需明确写明不同故障相关方的改进项（若有的话），下同。**_\n\n### 5.2【处置能力】\n#### 5.2.1 故障发现&响应\n+ **是否监控发现**\n    - [ ] 故障触发方 监控发现\n    - [ ] 故障受影响方 监控发现\n    - [x] 否，原因为：监控失效\n+ **是否5分钟内响应**\n    - [x] 是\n    - [ ] 否，原因为：\n+ **是否存在应急协同问题**\n    - [ ] 是\n        - [ ] 应急流程不明确（无流程或者流程不清晰、应急相关角色&职责不明确，缺失一号位等)\n        - [ ] 应急执行不到位（有流程，但未按流程执行，通告发送不及时，响应不及时等）\n    - [x] 否\n\n#### 5.2.2 故障定位&恢复\n+ **主要恢复方式：**\n    - [ ] 代码发布/回滚\n    - [ ] 配置发布/回滚\n    - [ ] 数据订正\n    - [ ] 机器隔离/重启/扩容\n    - [ ] 配置限流\n    - [ ] 预案降级\n    - [x] 自动恢复\n    - [ ] 其他：\n\n## 六、故障Action\n| **序号** | *******Action** | *******负责人** | *******计划完成时间** | **验收人** | **是否keyAction** |\n| :---: | --- | :---: | :---: | :---: | --- |\n| 1 | 短期：套餐订单详情不合理文案兜底修复 | 墨银 | 11.1 | 毅堂 | 否 |\n| 2 | 长期：套餐订单详情和日历房订单详情去omega | 影羽 | 待定 | 毅堂孟一 | 否 |\n| 3 | 短期：排查相关应用，是否还存在omega相关，整体推进去omega | 项前 | 11.30 | \\ | 是 |\n| 4 | 短期：omega二方包能力升级（包括线程池可配置、异常监控、数据源状态码、二方升级等） | 项前 | 11.1 | 秋合 | 否 |",
    "chunk_order_index": 3,
    "full_doc_id": "doc-78aaada48aaca19a422d20d8113dbffb"
  },
  "chunk-24b1024b4129ff2391255f926e99db81": {
    "tokens": 1200,
    "content": "## 一、故障简述\n【P2】于16:00开始，手淘Android_CRASH监控异常，16:03crash设备数>10W，触达P3故障。16:19crash设备数>40W，故障升级至P2。16:32下线安卓10.41.12版本首页直播横通入口，故障恢复。16:35上线安卓10.41.12首页会场横通入口。排查为首页10.41.12增加直播间预加载功能，该功能识别首页楼层数据里存在直播地址时，延迟5s执行直播间预加载，直播间预加载执行时如果直播间未初始化完成会触发空指针异常导致Crash。\n\n## 二、故障过程回顾\n| **时间轴** | **时间点** | **事件** |\n| --- | --- | --- |\n| 故障前 | 2024-10-10 12:57  | 手淘首页线上正式上线直播Banner![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256311/1729650022905-f4df3b99-b7e7-4bc2-b28b-a556f8631fc7.png?x-oss-process=image%2Fformat%2Cwebp%2Fresize%2Cw_592%2Climit_0) |\n| | 2024-10-10 14:49  | 产品向性能项目组提出对双11首页横栏投放的性能保障诉求。和直播服务端讨论，跳转直播间链接带秒开参数方案  |\n| | 2024-10-11 16:49  | 直播服务右侧第三坑链接带秒开参数线上发布完毕，直播测试开始验收首帧性能 |\n| | 2024-10-12  | 直播测试完成性能数据产出，架构组同学验收不通过。首页和直播客户端合作进一步优化，直播提供双端接入技术文档及一个判断是否直播链接的api，通过能力接入方式提供给首页 |\n| | 2024-10-14  | 首页和直播进行联调和提测，直播测试验收之后直播的同学配合集成 |\n| 故障时 | 2024-10-21 16:00  | 业务同学在首页banner投放天猫官方直播间链接，链接未带秒开参数（静态配置）**【故障注入】** |\n| | 2024-10-21 16:01 | Crash设备数>5w，触达P4**【故障发生】** |\n| | 2024-10-21 16:03 | Crash设备数>10w，触达P3 |\n| | 2024-10-21 16:05  | 手淘Android_CRASH监控触发风险预警，风险预警群拉起**【故障发现】** |\n| | 2024-10-21 16:06  | 白衣从Crash堆栈信息初步判断直播SDK tblive空指针异常，终端同学、直播同学进群**【故障响应】** |\n| | 2024-10-21 16:07  | 钉钉会议拉起，相关同学均入会，尝试从Crash堆栈定位原因并讨论止血方案 |\n| | 2024-10-21 16:09  | 家愿反馈该问题整点触发，尝试定位相关变更，未找到直接相关可疑变更，白衣怀疑存在预加载的预案（由于不知道服务端变更，从崩溃代码看到相关的开关进行处理） |\n| | 2024-10-21 16:12  | 预案同学提供16点附近执行过的相关预案，未找到相关直接相关预案 |\n| | 2024-10-21 16:13  | 大促项目组、直播相关同学集中到1-7-19-S集中排查，并同步开始准备推送orange降级崩溃相关代码链路 |\n| | 2024-10-21 16:18  | 首页质量同学怀疑与首页入口相关，拉首页相关同学协同排查 |\n| | 2024-10-21 16:19 | Crash设备数>40w，触达P2 |\n| | 2024-10-21 16:20  | 首页同学与直播同学确认，是否需要下线横通卡片，直播同学反馈需等待操作开关效果判断是否需要下线，首页同学同步进行卡片替换验证 |\n| | 2024-10-21 16:21  | 直播侧同学开始Orange开关推送 |\n| | 2024-10-21 16:26  | 直播同学完成关闭静音开关Orange全量推送，并执行开关加速逻辑，但线上Crash未有明显下降趋势。 |\n| | 2024-10-21 16:30 | 直播同学确认可以执行下线操作，业务运营执行下线。 |\n| | 2024-10-21 16:32  | 首页同学与业务完成确认，针对手淘最新版10.41.12下线直播横通卡片**【恢复执行】【故障恢复",
    "chunk_order_index": 0,
    "full_doc_id": "doc-cba186d790d557ea7bdeef22b3eaa7c6"
  },
  "chunk-c968684a018ae0debef386b5fbe6595f": {
    "tokens": 1200,
    "content": "量推送，并执行开关加速逻辑，但线上Crash未有明显下降趋势。 |\n| | 2024-10-21 16:30 | 直播同学确认可以执行下线操作，业务运营执行下线。 |\n| | 2024-10-21 16:32  | 首页同学与业务完成确认，针对手淘最新版10.41.12下线直播横通卡片**【恢复执行】【故障恢复】** |\n| | 2024-10-21 16:33  | 下线操作生效，Crash开始下降**** |\n| | 2024-10-21 16:35 | 上线安卓10.41.12首页会场横通入口 |\n\n\n## 三、故障原因\n### 3.1【背景说明】\n#### 3.1.1需求背景 [🔗](https://aone.alibaba-inc.com/v2/project/2032316/req#viewIdentifier=d7f112f9d023e2108fa1b0d8&openWorkitemIdentifier=60208131)\n##### 【10.10】 业务方有明确体验诉求\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/100559/1729590852017-10c96e34-3e9e-415b-825a-25ad848a6c2f.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/26323/1729591746821-0235be10-ec99-408c-a19e-c0ba4b980617.png)\n\n##### 【10.12 】终端平台提供性能工具，业务质量产出性能报告，存在性能问题\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/26323/1729591957740-267daf5c-f8ad-481b-885b-28fa650617bf.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/26323/1729592082546-e278b49e-32e2-4beb-8ee8-740d12dc46f7.png)\n\n##### 【10.12】 直播提供已有的线上优化方案，反馈首猜卡片也有相关优化\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/26323/1729592111288-fd5270c1-46bf-41ed-93e4-e0e2b6ca318a.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/26323/1729592233685-c277f832-a0fa-4d60-b77b-6e838945ef49.png)\n\n##### 【10.14】 集成review，开关默认开，反馈orange止血及服务端模版配置能力\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/26323/1729592484284-e2d38ad1-038e-4a1d-8263-d247c6ec42d6.png?x-oss-process=image%2Fformat%2Cwebp%2Fresize%2Cw_1500%2Climit_0)\n\n\n\n\n\n\n\n##### \n#### 3.1.2_直播预加载_业务链路\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/83868/1729680049646-32465bbc-318f-47fa-8b76-7fc1b5a2e55c.png)\n\n### 3.2【原因分析】\n**一句话原因：**\n\n首页10.41.12及以上版本增加直播间预加载功能，该功能识别首页楼层数据里存在直播地址时，则延迟5s执行直播间预加载，直播间预加载执行时如果直播间未初始化完成会触发空指针异常导致Crash。\n\n\n**根因分析：**\n\n1. 首页在 10.41.12版本增加了直播间预加载功能，在识别到首页楼层数据里存在直播卡片时，则延迟5s（可配置）会执行直播间预加载（PreloadMediaPlayerManager.getInstance.preloadByUrl）\n2. 直播间预加载执行时，如果直播间TaoLiveApplication的初始化没有完成，则在preloadByUrl内部执行到获取context时会为空，此时进一步调用getSystemService就会触发NPE![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/2227/1729664252536-092d8f99-215c-489d-8e6c-22f09e6b5369.png)\n3. 触发NPE未被catch原因：不带有秒开参数的链接（静态配置），需要先请求cdn的播放地址，在异步请求回播放地址后，出发的 NPE 已经脱离了首页代码的 try catch 保护。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/141194/1729506866509-50633a3d-3ea0-4ad4-9200-42508c7ee35e.png?x-oss-process=image%2Fformat%2Cwebp%2Fresize",
    "chunk_order_index": 1,
    "full_doc_id": "doc-cba186d790d557ea7bdeef22b3eaa7c6"
  },
  "chunk-deacbffdbdc30108369c5a2b5529f7d8": {
    "tokens": 1200,
    "content": "步请求回播放地址后，出发的 NPE 已经脱离了首页代码的 try catch 保护。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/141194/1729506866509-50633a3d-3ea0-4ad4-9200-42508c7ee35e.png?x-oss-process=image%2Fformat%2Cwebp%2Fresize%2Cw_1500%2Climit_0)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/111856/1729501263143-70d79b10-0afd-4fb7-a7c5-257108927f48.png?x-oss-process=image%2Fformat%2Cwebp%2Fresize%2Cw_1500%2Climit_0)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256311/1729685021560-cff1f879-21eb-4110-b089-0bd8f310b5f3.png)\n\n## 四、关注点分析\n**1、预加载在详情和tab2场景是如何应用的，是否有过报错信息？首页接入预加载能力是否合理？**\n\n:::tips\n+ tab2链路\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/83868/1729680426549-b14a393b-c3d0-4764-b984-73eb08beafee.png)\n\n+ 商品详情链路（AliTTDetail）\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/83868/1729685970820-422948e1-f4d7-425b-a0b8-87ef870b31d9.png)\n\n+ 线上稳定性情况[ link](https://ha.emas.alibaba-inc.com/#/page/crash?r_=/converge/detail/:appId&g_={%22appId%22:%2212278902@android%22}&l_={%22id%22:%22e11ab173927c3abed22548ef28b57183%22,%22errorType%22:%22ANDROID_JAVA_CRASH%22,%22begin%22:%221729162141949%22,%22end%22:%221729680541949%22,%22subject%22:%22countHistory%22,%22version%22:%22%22,%22countVersion%22:%22%22,%22compareVersion%22:%22%22,%22date%22:%221722509341949%22,%22compareDate%22:%221729594141949%22,%22historyRange%22:%221725187744598,1729680544598%22,%22precision%22:%221%22,%22threadName%22:%22%22})：方案tab2互动面板接入版本：10.40.0， 商详接入版本0.40.20，此间崩溃的量级基本上是0\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/83868/1729680802725-28d9f3d7-5f75-47d0-8d6b-23dec654f9bf.png)\n\n:::\n\n**2、直播间TaoLiveApplication为何没有初始化？为什么主要集中在安卓机？**\n\n:::tips\n+ TaoLiveApplication有2种初始化时机：\n    - 首页的闲时加载(TaoLiveIdelTask)，低端机闲时加载任务靠后，更有可能出现在二刷延迟5秒后\n    - 首页存在直播卡片，直播卡播放时，会初始化TaoLiveApplication\n    - 结论：在低端机系统繁忙或也没有直播卡片播放，TaoLiveApplication 没有初始化机会\n+ 首页存在无直播卡片原因：\n    - 在安卓低端机，首页直播卡片被降级成图片\n\naction：（低端机占比、闲时触发的概率、低端机不出卡片的量级）线下去跑数据验证，低端机跟Crash量级如果不一致，需继续排查是否有其他原因  @月轮  1027\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/83868/1729827875264-7abd83e8-88ea-43b6-9992-d5715d251945.png)\n\n从机型占比上看：低端机占比49.4%，中端机 36.68%，高端机8.67%，其他5.24%。\n\n分析：\n\n1. 【中端机占比问题】通过中端机crash样本的tlog发现，用户基本命中了首页宫格的非直播商品卡和非直播卡的case（无相关卡片日志），也就是需要依赖闲时任务拉起直播。\n2. 【中端机占比问题】从整体的机型占比来看（高24.33%，中63.22%，低12.43%），中端机相比低端机是5:1，中端机的整体基数过大，导致崩溃占比达到36.68%。但统一按低端机的数量来归一化计算",
    "chunk_order_index": 2,
    "full_doc_id": "doc-cba186d790d557ea7bdeef22b3eaa7c6"
  },
  "chunk-0d81cbafde15bf0ec86ec100bb9bdce6": {
    "tokens": 1200,
    "content": "（无相关卡片日志），也就是需要依赖闲时任务拉起直播。\n2. 【中端机占比问题】从整体的机型占比来看（高24.33%，中63.22%，低12.43%），中端机相比低端机是5:1，中端机的整体基数过大，导致崩溃占比达到36.68%。但统一按低端机的数量来归一化计算，高中低崩溃概率比为 6:14:80，也就是低端机的崩溃概率更高。\n3. 【低端机崩溃率问题】半个小时整体的崩溃数量是749747设备量，低端机有370375，根据DAU和低端机占比来计算半小时的在线数据，期间的低端机是749747 /（用户crash率 0.3959%）* （低端机占比 12.43%）= 490409。测算出当时低端机的崩溃大概是75%，剩下有25%低端机用户不会崩溃。\n4. 【低端机崩溃率问题】在线下复现的时候发现，首页启动时如果有可能初始化tab2的直播卡，也会初始化TaoLiveApplication，整体占比是（直播tab dau 484w/tab2整体 dau2488w=19.4%）。也就是有20%的低端机用户因为命中tab2直播卡人群，不会出现这个崩溃。剩下约5%推测是因闲时任务执行成功而不会崩溃。\n\n总结：\n\n在低端机系统繁忙或也没有直播卡片播放，也没有命中tab2直播卡，TaoLiveApplication 没有初始化机会，是本次崩溃的主要原因。\n\n:::\n\n**3、为什么直播预加载实现在iOS侧未发生该问题，在安卓侧发生？**\n\n:::tips\n+ 双端实现存在差异： iOS走预热逻辑(播放器创建在进直播间才执行)\n\n                                  安卓走预播逻辑（预加载阶段就创建播放器，故用户没点进直播间也会闪退）\n\n:::\n\n**4、集成后测试验收阶段，会关注低端机上的表现吗？为什么在验收阶段未发现该问题？**\n\n:::tips\n+ 直播测试会验收直播卡片相关链路，直播卡与账号有关（验收账号加白，默认有直播卡），未复现问题\n+ 性能验收以低端机为主，低端机验收使用的是带秒开参数地址，未复现问题\n\n  结论：线下验证复现需要满足多种条件，静态配置（未带秒开地址链接）+账号无直播卡+低端机\n\naction：\n\n    - 首页侧提供各类版面+账号组合，提供相关文档  @遇风  ---不录入TR系统\n    - 测试验收时，基于业务场景覆盖上述各类组合条件  ---不录入TR系统\n    - 安全环境：直播需要的环境都补偿初始化 月轮  1130\n\n:::\n\n**5、静态配置/动态配置区别？**\n\n:::tips\n动态配置带秒开参数\n\n静态配置不带秒开参数，会触发一次网络请求拉取播放地址（动态无异步请求）\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/83868/1729680368280-a4877250-c432-4ee2-87b5-6aaa9e6a33fd.png)\n\n:::\n\n**6、18日版本上架至21日期间为什么没有发现？运营投放的链接与测试回归的链接是否存在差异？**\n\n:::tips\n+ 19日测试验收时使用动态带秒开参数的链接（动态配置），未复现该问题\n+ 21日运营投放的是静态未带秒开参数的链接（静态配置）\n\n  总结：是否带秒开参数运营无法感知\n\naction：\n\n    -  临时方案：首页同学验收市场部投放链接，加签直播技术郡望同学 \n    -  长期方案：牵头完善运营投放方案，对运营投放链接校验  @达野  @予瑶\n    -  长期方案：运营平台投放变更执行记录接入CF或摩天轮  @予瑶 @家愿   @岱泽   @玄聪   @泠乐   \n\n:::\n\n 7、**后续修复逻辑是怎样的？**\n\n:::tips\n+ 当前首页侧已调整DX模块，避免预加载调用\n+ 预加载功能优化：\n\naction：直播侧提供通用稳定预加载接口  @玄聪 @月轮  @庐轩   1130\n\n:::\n\n**8、此次改动直播、首页是否有配置相关预案？**\n\n:::tips\n首页有开关，直播无\n\naction：直播测预加载兜底开关验证上线 @郡望   已完成\n\n:::\n\n**9、本次未10分钟内恢复，是否有更快恢复手段？**\n\n:::tips\n通过运营更换投放链接已是最快的恢复方式，执行后2分钟Crash几乎跌0；未10分钟恢复的主要原因是最开始怀疑方向与tbl",
    "chunk_order_index": 3,
    "full_doc_id": "doc-cba186d790d557ea7bdeef22b3eaa7c6"
  },
  "chunk-110d82a8e3aeb64dda440cad34e64cf9": {
    "tokens": 1200,
    "content": "相关预案？**\n\n:::tips\n首页有开关，直播无\n\naction：直播测预加载兜底开关验证上线 @郡望   已完成\n\n:::\n\n**9、本次未10分钟内恢复，是否有更快恢复手段？**\n\n:::tips\n通过运营更换投放链接已是最快的恢复方式，执行后2分钟Crash几乎跌0；未10分钟恢复的主要原因是最开始怀疑方向与tblive sdk相关，未直接定位到问题触发点；（恢复手段有，定位时间耗时长）\n\naction：紧急预案orange快速推送能力开放（双十一后正式开放） 1031  @家愿\n\n:::\n\n## 五、基本信息\n### 4.1【系统质量】\n#### 4.1.1 代码质量\n| **Chcek项** | **详细内容** |\n| --- | --- |\n| **CR链接** | _首页：_[_查看详情1_](https://code.alibaba-inc.com/taobao-android-infoflow/InformationFlow_Core/codereview/18701125)_、_[_查看详情2_](https://code.alibaba-inc.com/taobao-android/homepage_component/codereview/18701147)___直播：_[_查看详情_](https://code.alibaba-inc.com/taobao-android/taoliveroom/codereview/18699497) |\n| **是否经过测试** | _是_ |\n| **测试环境** | _预发环境__线上验收_ |\n| **测试提交单/测试用例/测试报告** | 测试机型：红米K40；；VIVOY50（低端机）；Iphone15pro；Iphone7（低端机）   测试内容：   1、范围：预发走到算法推荐链路。验证1坑（同宫格首坑，livesource=liveother.shouye_banner_2024）、2、3坑（liveSource=tpp_88_activity_card）   2、播放方法验证：klifecycle埋点，IOS走到warmup，Android 走到OptPlayPreload   3、核心功能表现：首页无漏音、进入直播间正常播放、返回首页无漏音。   4、降级：由首页控制。5、性能测试验收预加载后验收报告[https://media2.alibaba-inc.com/#/live/indicatorsCheck/firstFrameEvalData?taskId=2210](https://media2.alibaba-inc.com/#/live/indicatorsCheck/firstFrameEvalData?taskId=2210)录屏：[http://appmaster2017-bucket.cn-hangzhou.oss-cdn.aliyun-inc.com/videos/1729093240723_%E9%A6%96%E5%B1%8F%E6%97%B6%E9%97%B4_%E6%B7%98%E5%AE%9Dbanner%E7%9B%B4%E6%92%AD%E9%97%B4_10.35.31_L1_0.mp4?spm=a1zltg.b35694215.0.0.58954d5a7ezMYx&file=1729093240723_%E9%A6%96%E5%B1%8F%E6%97%B6%E9%97%B4_%E6%B7%98%E5%AE%9Dbanner%E7%9B%B4%E6%92%AD%E9%97%B4_10.35.31_L1_0.mp4](http://appmaster2017-bucket.cn-hangzhou.oss-cdn.aliyun-inc.com/videos/1729093240723_%E9%A6%96%E5%B1%8F%E6%97%B6%E9%97%B4_%E6%B7%98%E5%AE%9Dbanner%E7%9B%B4%E6%92%AD%E9%97%B4_10.35.31_L1_0.mp4?spm=a1zltg.b35694215.0.0.58954d5a7ezMYx&file=1729093240723_%E9%A6%96%E5%B1%8F%E6%97%B6%E9%97%B4_%E6%B7%98%E5%AE%9Dbanner%E7%9B%B4%E6%92%AD%E9%97%B4_10.35.31_L1_0.mp4)结果数据：进入直播间总耗时：638ms,平均响应时长：364ms,平均首帧时长：274ms |\n\n\n#### 4.1.2 变更质量\n| **Chcek项** | **详细内容** |\n| --- | --- |\n| **变更类型** | _ 代码发布_ |\n| **CF变更执行单链接** | _客户端版本发布_ |\n| **是否灰度** | _不涉及灰度，本次是运营线上投放直接生效_ |\n| **发布批次** | _客户端PMO分批发版_ |\n| **灰度观测监控链接&截图** | _客户端crash监控 _[_链接_](https://ha.emas.alibaba-inc.com/#/page/crash?base64_=cl89L2NvbnZlcmdlL2RldGFpbC86YXBwSWQmZ189eyJhcHBJZCI6IjEyMjc4OTAyQGFuZHJ",
    "chunk_order_index": 4,
    "full_doc_id": "doc-cba186d790d557ea7bdeef22b3eaa7c6"
  },
  "chunk-0c59d493a0e81539b90f77f980d8ce02": {
    "tokens": 1156,
    "content": "次** | _客户端PMO分批发版_ |\n| **灰度观测监控链接&截图** | _客户端crash监控 _[_链接_](https://ha.emas.alibaba-inc.com/#/page/crash?base64_=cl89L2NvbnZlcmdlL2RldGFpbC86YXBwSWQmZ189eyJhcHBJZCI6IjEyMjc4OTAyQGFuZHJvaWQifSZsXz17ImlkIjoiZTExYWIxNzM5MjdjM2FiZWQyMjU0OGVmMjhiNTcxODMiLCJlcnJvclR5cGUiOiJBTkRST0lEX0pBVkFfQ1JBU0giLCJiZWdpbiI6IjE3Mjk0OTc2MDAwMDAiLCJlbmQiOiIxNzI5NDk3NjAwMDAwIiwic3ViamVjdCI6ImFuYWx5c2lzIiwidmVyc2lvbiI6IjEwLjQxLjEyIiwiY29tcGFyZVZlcnNpb24iOiIxMC40MS4xMiIsImRhdGUiOjE3Mjk0OTc2MDAwMDAsImNvbXBhcmVEYXRlIjoxNzI5NDExMjAwMDAwLCJwcmVjaXNpb24iOiIxIn0=) |\n| **是否违反变更红线 **[**🔗**](https://aliyuque.antfin.com/tbsre/ggo7n2/uki482dbgdo6ol2o) | _否_ |\n\n\n### 4.2【处置能力】\n#### 4.2.1 故障发现&响应\n| **Chcek项** | **详细内容** |\n| --- | --- |\n| **是否监控发现** | _是，故障受影响方监控发现_ |\n| **是否5分钟内响应** | _是_ |\n\n\n#### 4.2.2 故障定位&恢复\n| **Chcek项** | **详细内容** |\n| --- | --- |\n| **主要恢复方式** | _下线产品功能_ |\n| **是否10分钟恢复** | _否_ |\n\n\n#### 4.2.3 SRE应急参与\n| **角色** | **Chcek项** | **详细内容** |\n| --- | --- | --- |\n| ** SRE****工程师** | **是否响应** | _是 _ |\n| | **是否帮助定位** | _是 _ |\n| | **是否操作恢复/提出有效恢复方案** | _是 _ |\n| **SRE****专家** | **SRE专家是否有效指挥** | _是_ |\n\n\n## 六、故障Action\n| **序号** | *******Action标题** | *******负责人** | *******计划完成时间** | **Action描述** | **验收标准** | **验收人** | **是否keyAction** | **是否回血Action** |\n| --- | --- | --- | --- | --- | --- | :---: | --- | --- |\n| 1 | 低端机占比、闲时触发的概率、低端机不出卡片的量级）线下去跑数据验证，低端机跟Crash量级如果不一致，需继续排查是否有其他原因   | @月轮  |  2024-10-27 | |  | | | |\n| 2 | 安全环境：直播需要的环境都补偿初始化 | @月轮  | 2024-11-30 | |  | | | |\n| 3 | 直播测预加载兜底开关验证上线  | @郡望  | 已完成 | |  | | | |\n| 4 | 长期方案：迏野牵头完善运营投放方案，对运营投放链接校验   | @达野  @予瑶 | 2025-03-31 | |  | | | |\n| 5 | 长期方案：运营平台投放变更执行记录接入CF或摩天轮   | @予瑶 @家愿   @岱泽   @玄聪   @泠乐    | 2025-03-31 | |  | | | |\n| 6 | 直播侧提供通用稳定预加载接口    | @玄聪 @月轮  @庐轩 |  2024-11-30 | |  | | | |\n| 7 | 紧急预案orange快速推送能力开放（家愿同步SRE团队，双十一期间权限收敛）  | @家愿 | 2024-10-31   | |  | | | |\n| 8 | 首页侧提供各类版面+账号组合，提供相关文档  @遇风 TR系统 | 不录入TR | | |  | | | |\n| 9 | 测试验收时，基于业务场景覆盖上述各类组合条件  | | | |  | | | |\n| 10 | 首页同学验收市场部投放链接，加签直播技术郡望同学  | | | |  | | | |",
    "chunk_order_index": 5,
    "full_doc_id": "doc-cba186d790d557ea7bdeef22b3eaa7c6"
  },
  "chunk-663591c68ac5d1067c870da137bda85b": {
    "tokens": 56,
    "content": "时，基于业务场景覆盖上述各类组合条件  | | | |  | | | |\n| 10 | 首页同学验收市场部投放链接，加签直播技术郡望同学  | | | |  | | | |",
    "chunk_order_index": 6,
    "full_doc_id": "doc-cba186d790d557ea7bdeef22b3eaa7c6"
  },
  "chunk-eccc343d5559a8e8e4046d483ecbd43a": {
    "tokens": 1200,
    "content": "_**锁定会议开始，宣导复盘文化**_\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/9827/1659103353652-0274c8cd-7318-4cd9-b730-0d66221680b6.png)\n\n_**内容涉及公司B3级别以上机密数据，请注意保密！**_\n\n| **故障链接** | [https://tr.alibaba-inc.com/ormEmergency/workbench/emergency/202410150000001265001](https://tr.alibaba-inc.com/ormEmergency/workbench/emergency/202410150000001265001) |\n| --- | --- |\n| **复盘时间** | 2024/10/21 周一 16:00-18:00 |\n| **复盘地点** | C3-6-05-N 小镜湖 |\n| **参与人** | 研发：冀锋、项升、临赫、北纬、朝生SRE：潇客GOC：乐尽、徙南 |\n| **主持人** | 乐尽 |\n\n\n## 一、故障简述\n【P5】2024-10-15 12:50 答疑同学反馈各官方答疑群、研发小蜜等渠道“新上线应用，启动失败”的进线,客诉量级触达P5故障，故障原因为ConfigServer 于2024-10-15 11:50 左右执行地址注册的变更导致，12:55变更回滚完成并推送配置，业务线监控恢复正常水位，故障恢复，请知晓。\n\n## 二、故障过程回顾\n### 2.1【故障处理时间线】\n| **时间轴** | **事件** |\n| --- | --- |\n| 2024-10-15 11:50 | **【故障注入】**由于误操作，CS 运维同学在地址服务器页面，将数个已下线的机器添加到 sh 单元，同时设置了错误的权重：9600。 |\n| 2024-10-15 11:55 | 出现 CS 监控指标异常，但未产生告警。 |\n| 2024-10-15 12:20 | **【故障发现】【故障响应】**客户开始报障，出现“新上线应用，启动失败的问题”，并开始建群排查问题。 |\n| 2024-10-15 12:40 | **【故障定位】**【**恢复执行**】冀锋观察cs监控异常，定位到是错误配置 CS IP 引起的问题，开始回滚，将错误的地址摘除 |\n| 2024-10-15 12:50 | **【故障发生】**客诉累计5例，故障等级触达P5 |\n| 2024-10-15 12:54 | **【故障恢复】**推送配置，监控恢复正常 |\n| 2024-10-15 13:07 | 通知业务方重启异常应用，业务方反馈问题恢复。 |\n| 2024-10-15 18:00 | 【其他线上问题】出现客户报障，特定机房的新上线应用，服务启动失败，在服务端重启后止血。 |\n| 2024-10-15 19:22-20:09 | 云侧音视频通信管控openAPI可用率下跌至约50% |\n| 2024-10-15 20:09 | 云侧音视频通信研发侧重启一台异常机器后恢复。后音视频通信产研反馈至HSF侧确认是受该异常影响 |\n| 2024-10-16 12:00 | 排查问题，发现部分（2k个左右实例）provider 持续注册失败，且机房分布较为固定。查到问题根因，获取到全部受影响ip列表（2600个），拉群，发布公告，告知业务方影响面及恢复方案。 |\n| 2024-10-16 20:00 | 遗留 700 个可能存在风险的ip |\n| 2024-10-17 19:00 | 将全部风险应用负责人单独拉群，要求业务方重启provider，告知风险，遗留200个可能存在风险的 ip 列表。 |\n| 2024-10-18 18:00 | 继续筛选问题ip列表，告知负责人风险，要求重启，风险ip全部重启完成。 |\n\n\n\n\n### 2.2【时间线概览】\n![画板](https://intranetproxy.alipay.com/skylark/lark/0/2024/jpeg/149256407/1729233518479-cbee226c-c5f4-44a7-bed3-5697c1eac313.jpeg)\n\n## 三、故障原因\n### 3.1【背景说明】\n#### 【需求背景】\n:::tips\nCS 存在地址服务器注册 IP 和真实 IP不一致的问题，造成流量不均，且一直未完全解决。\n\n故障出现的前一天2024-10-14，我们扫描出了地址服务器缺失的 IP 列表，决定将缺失的部分 IP 手动在地址服务器上补齐。\n\n出现故障当天2024-10-15，已经正确补齐了部分单元的 IP 列表，**临时决定** 将 unzbmix 单元的缺失 ip 也进行补齐，于是",
    "chunk_order_index": 0,
    "full_doc_id": "doc-5e7ab53c51e7274920383ccc517422fc"
  },
  "chunk-46ee71508e33f5337d28ec426c05f28a": {
    "tokens": 1200,
    "content": "流量不均，且一直未完全解决。\n\n故障出现的前一天2024-10-14，我们扫描出了地址服务器缺失的 IP 列表，决定将缺失的部分 IP 手动在地址服务器上补齐。\n\n出现故障当天2024-10-15，已经正确补齐了部分单元的 IP 列表，**临时决定** 将 unzbmix 单元的缺失 ip 也进行补齐，于是出现了本次变更。\n\n:::\n\n#### 【业务链路】\n![画板](https://intranetproxy.alipay.com/skylark/lark/0/2024/jpeg/1156570/1729242670621-d2ba57e9-5eef-4edd-84fc-a55f8880306e.jpeg)\n\n\n\n### 3.2【原因分析】\n#### 一句话原因：\n:::tips\nCS 地址的错误变更，**误将已经下线（不存在）的 cs 机器注册到 sh （张北中心）单元**，同时误设置了**极高权重**，导致 sh 单元新扩容机器建联 CS 失败，无法启动。\n\n:::\n\n#### 根因分析：\n:::tips\n在地址服务器上进行 CS 地址补齐的过程中，出现了误操作：\n\n+ 在地址服务器批量添加ip配置页面：\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/1156570/1729045492388-886034ee-070a-4192-b812-856c08ff87b0.png)\n\n按照ip:port_weight_cluster的格式进行配置，在配置过程中，由于错误的填写，导致了如下误配：\n\n1. 端口填写成了权重\n2. cluster 填写成了 sh\n3. 填写的机器为不存在的机器\n+ 导致本故障批量添加的文本：\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/152956355/1728974564047-ab42a47a-420b-426c-a7a6-c1e000465d36.png)\n\n\n\n+ 添加地址之后，地址服务器的 sh 集群可以看到多个异常ip、并且带有很高的权重。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/1156570/1728976369814-77788985-5462-45af-902d-a5be3f12b1c8.png?x-oss-process=image%2Fformat%2Cwebp%2Fresize%2Cw_1650%2Climit_0)\n\n\n\n+ 【故障】上述错误操作，导致结果：\n\n11:50-12:50 新启动的应用，会根据权重选择ip建联，导致其反复向错误的 ip 建联，失败重试，导致地址找不到。\n\n某个故障应用的config-client.log：\n\n可以看到拉到极长的 错误 ip 列表。权重是9600，拉到的ip列表中，对应ip就会出现9600次。并持续按照权重尝试建联失败，无法订阅到下游地址。造成应用启动失败。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/1156570/1728976819125-a6a1db72-aba2-478d-9650-9e65b33d122b.png?x-oss-process=image%2Fformat%2Cwebp%2Fresize%2Cw_1650%2Climit_0)\n\n:::\n\n\n\n\n\n:::tips\n+ 【故障引起的其他线上问题】\n\n于此同时，由于地址服务器规则，中心部分机房 **仅推送了极高权重的错误机器**，导致这些机房的全部应用的健康CS链接**主动断开**，进入重连循环，**无法建联，服务摘除**。\n\n11:50 异常地址配置之后，由于地址服务器的同机房规则逻辑，将不存在的地址视为同机房地址，因此：仅将错误地址列表推送给机房  et2,eu13,et15,em14,em21,oc27,ot7,ru66 的全部应用。\n\n机房  et2,eu13,et15,em14,em21,oc27,ot7,ru66 的全部应用接收到权重极高的错误地址列表，CS 客户端断开健康链接，进入一个重试循环，不断向错误地址列表建联，7天 [9600*7*(3+5)/24/3600]  后才能自行恢复。\n\n\n\n:::\n\n```java\n\"app2SiteGroup\": {\n        \"configserver\": {\n            \"pre\": \"na61,na62,nu16|et2,eu13,et15,em14\",\n            \"sh\": \"na61,na62,nu16,cm3,cm10,cm11,eu6,nt12,os30,meg,st3,su18,nu29,nm89,et93|et2,eu13,et15,em14,em21,oc27,ot7,ru66\"\n        },\n}\n```\n\n:::tips\n受影响应用的上游应用，11:55 左右收到空地址推送，触发推空保护。\n\n+ 上游应用重启失败\n\n上游应用重启后，推空保护失效，订阅到空地址，报",
    "chunk_order_index": 1,
    "full_doc_id": "doc-5e7ab53c51e7274920383ccc517422fc"
  },
  "chunk-b1b5db0566990e5553aecf4c0a71c6bd": {
    "tokens": 1200,
    "content": "st3,su18,nu29,nm89,et93|et2,eu13,et15,em14,em21,oc27,ot7,ru66\"\n        },\n}\n```\n\n:::tips\n受影响应用的上游应用，11:55 左右收到空地址推送，触发推空保护。\n\n+ 上游应用重启失败\n\n上游应用重启后，推空保护失效，订阅到空地址，报错地址找不到。\n\n此时业务方重启下游受影响应用，重新注册服务，上游即可启动成功。\n\n:::\n\n\n\n## 四、关注点分析\n\n\n**〖关注点1】为什么要变更**\n\n:::tips\n【问题分析】故障出现的前一天，我们扫描出了地址服务器缺失的 IP 列表，决定将缺失的部分 IP 手动在地址服务器上补齐。\n\n出现故障当天，已经正确补齐了部分单元的 IP 列表，决定将 unzbmix 单元的缺失 ip 也进行补齐。\n\n在大促期间，**临时决定补齐不全的地址服务器 ip 列表，是本次变更的原因**，决定的较为草率，需要深刻反思。\n\n【改进点】临时的操作坚决不可执行，完善变更文档，一必须两禁止严格执行。\n\n\n\n:::\n\n****\n\n**〖关注点2〗为什么问题发现不及时**\n\n:::tips\n【问题分析】\n\n1. 本次变更完成后，**并没有进行监控查看，并没有 double check**，导致问题未及时感知。\n2. CS 监控指标出现异常，但由于出现极高异常IP权重，导致监控组件的日志轮转很快，Sunfire agent 采集出现异常，**未触发告警。**\n3. 本次变更造成地址服务器 CS IP 列表中，出现7个错误 IP，并且权重极高。这对存量业务应用不造成影响，但对新扩容的机器会造成影响，因此业务方在执行**扩容之后才感知到问题**。\n\n【改进点】\n\n1. 告警机制需要优化（稳定后上oncall）  冀锋   deadline：1130   时间可细化\n+ Sunfire采集度需求确认（确保Sunfire采集不到应用监控告警能告出）\n+ 保证高频打印异常日志时依然能收到有效告警  \n2. cs发布流程规范化 (同时确认规范是否能落到发布平台)  项升     1130 \n\n:::\n\n****\n\n**〖关注点3】为什么没有告警**\n\n:::tips\n【问题分析】\n\n+ CS 监控组件通过对全量地址列表进行pub/sub ，进行校验。本次变更导致异常IP 权重极高，即拉到的地址列表数目约为7w 个IP，CS 监控组件会对 7w 个 IP 进行校验，打印了大量异常日志，超过 sunfire-agent 的日志采集能力。\n+ sunfire-agent 将打印大量异常日志的 CS 线上监控程序视为“日志齐全度不足”状态 ，因此未触发任何告警。\n\n【改进点】\n\n1. ~~告警机制需要优化，保证高频打印异常日志时依然能收到有效告警。~~\n\n:::\n\n**〖关注点4〗为什么权重会误配到9600**\n\n:::tips\n【问题分析】\n\n地址服务器页面的批量配置规则：按照ip:port_weight_cluster的格式进行配置。\n\n操作同学误配的文本：33.59.11.66_9600_1_sh，**和要求的规则并未对应上，但依然配置成功了**。平台将 port 默认设为了80，并将权重设为了 9600\n\n【改进点】\n\n1. env-control 禁止 CS 非 0-1 的权重变更    修竺   1130 \n2. 对配置的内容进行校验\t修竺   1130 \n\n:::\n\n**〖关注点5〗为什么配置的IP是已下线的IP**\n\n:::tips\n【问题分析】\n\n集群内 服务发现列表本身存在脏数据：故障出现的前一天，我们扫描出了地址服务器缺失的 IP 列表，这个 IP 列表来源是 CS 集群内 session.xml ，即CS 内部服务发现的列表，这个列表本身 **存在脏数据**。该脏数据被比对出来之后，**未经过验证**，直接认为应该注册地址服务器，此处操作非常不严谨。\n\n【改进点】\n\n1. ~~发布流程规范化，需要评估好配置风险，影响范围，配置必要性。提前将变更涉及的脏数据剔除。~~\n2. 长期改进：定时巡检脏数据 diff 并告警，及时发现集群内脏数据ip   冀锋   1231。\n\n\n\n:::\n\n****\n\n**〖关注点6〗为什么存量机器未出现问题**\n\n:::tips\n【问题分析】\n\n对于现存业务应用，config-client 地址轮转逻辑是：会对拿到的 ip 列表和现存 CS 链接做比对，如果拿到的ip列表中存在现存已建立的 CS 链接，则不做调整。\n\n因此对于存量应用，并没有感知到权重变化的影响。但是对于新启动的业务应用，会按照权重进行建联，造成故障。\n\n:::\n\n\n\n**【关注点7〗【线上问题】我们",
    "chunk_order_index": 2,
    "full_doc_id": "doc-5e7ab53c51e7274920383ccc517422fc"
  },
  "chunk-c9c8cf60c83e6568ff0c5f07b2d5f94f": {
    "tokens": 1200,
    "content": "应用，config-client 地址轮转逻辑是：会对拿到的 ip 列表和现存 CS 链接做比对，如果拿到的ip列表中存在现存已建立的 CS 链接，则不做调整。\n\n因此对于存量应用，并没有感知到权重变化的影响。但是对于新启动的业务应用，会按照权重进行建联，造成故障。\n\n:::\n\n\n\n**【关注点7〗【线上问题】我们如何告知业务方风险，要求业务方重启：**\n\n:::tips\n【问题分析】\n\n我们通过地址服务器推送记录，查询到两千多台“仅收到异常地址”的机器。\n\n通过机器查询应用，将全部应用负责人拉群，告知风险“异常机器列表的 CS 注册信息丢失”\n\n告知应用负责人，重启异常机器，恢复服务。持续3天多次拉取现存异常列表，通知业务方，重启机器。\n\n最终全部ip都达到： 重启后服务恢复/评估风险后保留 的状态\n\n\n\n应急流程完善（影响多bu发送技术支持联席群）  乐尽   1130\n\n长期：大批量provide下线告警方案   项升 \n\n:::\n\n\n\n## 五、常规检查项\n### 5.1【系统质量】\n#### 5.1.1 需求&设计评估\n###### 〖关注点1〗是否涉及产品、技术方案评估？此核心的问题是什么，如何改进？ __\n- [ ] **是，涉及**\n    - [ ] 需求评估遗漏\n    - [ ] 产品设计缺陷\n    - [ ] 系统架构设计缺陷\n        - [ ] 容错性不足 \n        - [ ] 单点，无冗余\n        - [ ] 缺乏自我保护\n        - [ ] 缓存设计不当\n        - [ ] 容量评估不足\n        - [ ] 非幂等设计\n        - [ ] 强弱依赖不合理\n        - [ ] 其他：__________\n- [x] 否，不涉及\n\n**〖问题总结〗暂无**\n\n**〖改进点〗暂无**\n\n\n\n#### 5.1.2 代码质量\n###### 〖关注点1〗是否代码自身存在漏洞或BUG、代码健壮性是否存在问题等?\n**〖问题分析〗**暂无\n\n**〖改进点〗**暂无\n\n###### 〖关注点2〗是否经过CodeReview？CodeReview阶段是否发现问题？为何没发现？\n+ **是否经过CR**\n    - [ ] 是\n    - [ ] 否\n    - [x] 不涉及\n+ **是否设置合理的CR卡点**\n    - [ ] 是\n    - [ ] 否\n    - [x] 不涉及\n+ **CodeReview阶段是否发现问题？为何没发现？后续如何发现？**\n    - [ ] 是\n    - [ ] 否\n    - [x] 不涉及\n\n**〖问题分析〗****暂无**\n\n**〖改进点〗****暂无**\n\n###### 〖关注点3〗测试阶段   __\n+ **测试内容：**涉及的测试提交单、测试用例等\n+ **测试人员：**\n+ **是否经过测试验证**\n    - [ ] 是，验证环境\n        - [ ] 预发环境\n        - [ ] 日常环境\n    - [ ] 是，测试方法\n        - [ ] 单元测试\n        - [ ] 功能回归测试\n        - [ ] 集成测试/链路测试\n        - [ ] 验收测试\n    - [ ] 否\n    - [ ] 不涉及\n+ **测试未发现原因是什么？后续如何改进？**\n    - [ ] 回归测试遗漏\n        - [ ] 手工回归测试用例遗漏\n        - [ ] 自动化未建设\n        - [ ] 自动化回归覆盖不足\n        - [ ] 其他：__________\n    - [ ] 新场景测试遗漏\n        - [ ] 功能测试用例遗漏，包括正常分支和异常分支\n        - [ ] 容灾兜底测试遗漏\n        - [ ] 客户端兼容性测试遗漏\n        - [ ] 埋点测试遗漏\n        - [ ] 性能测试遗漏，影响评估不足\n        - [ ] 安全测试遗漏\n    - [ ] 其他：__________\n\n**〖问题总结〗**\n\n**〖改进点〗**_**需明确写明不同故障相关方的改进项（若有的话），下同。**_\n\n1、\n\n#### 5.1.3 变更质量\n+ **是否涉及变更：**\n    - [x] 是\n    - [ ] 否\n+ **变更类型：**\n    - [ ] 代码发布\n    - [x] 配置变更\n    - [ ] 其他变更：____________\n    - [ ] 不涉及\n+ **变更平台是否接入ChangeFree：**\n    - [x] 是，接入CF但未提单：[https://aicf.alibaba-inc.com/aicf/grayscale/hm?publishInfoDownId=434320054](https://aicf.alibaba-inc.com/aicf/grayscale/hm?publishInfoDownId=434320054)\n    - [ ] 否  \n+ **是否违反变更红线3.2**** **[链接](https://aliyuque.antfin.com/trecs/fzg6dy/uar1",
    "chunk_order_index": 3,
    "full_doc_id": "doc-5e7ab53c51e7274920383ccc517422fc"
  },
  "chunk-8e484dde8409b4af8a55122c43297a36": {
    "tokens": 1200,
    "content": "，接入CF但未提单：[https://aicf.alibaba-inc.com/aicf/grayscale/hm?publishInfoDownId=434320054](https://aicf.alibaba-inc.com/aicf/grayscale/hm?publishInfoDownId=434320054)\n    - [ ] 否  \n+ **是否违反变更红线3.2**** **[链接](https://aliyuque.antfin.com/trecs/fzg6dy/uar1k6)\n    - [x] 是，违反哪条原则：禁止一切未通过变更管理平台申请或报备的变更操作\n    - [ ] 否\n\n###### 〖关注点1〗灰度阶段     \n+ **是否经过灰度：**\n    - [ ] 是\n    - [x] 否\n+ **观测了哪些监控**：_可以附链接_\n    - [ ] 黑屏、白屏\n    - [ ] GOC监控：\n    - [ ] 系统大盘：\n    - [x] 其他：______无_____\n+ **是否灰度期间发现问题？**\n    - [ ] 是\n        - [ ] 是否灰度流量过大，导致故障\n        - [ ] 灰度发现但未有效或及时修复，导致故障\n        - [ ] 其他：___________\n    - [x] 否，后续如何灰度发现？_____________\n+ **未灰度发现原因**\n    - [ ] 应用灰\n        - [ ] 灰度流量太小\n        - [ ] 灰度阶段无监控\n        - [ ] 灰度批次不合理\n        - [ ] 超长时间灰度才能发现\n    - [ ] 业务灰：策略不合理\n    - [ ] 灰度无法发现\n    - [x] 其他：____未灰度_________\n\n**〖问题总结〗**\n\n**〖改进点〗**_**需明确写明不同故障相关方的改进项（若有的话），下同。**_\n\n###### 〖关注点2〗上线阶段   \n+ **是否有确定的监控观测指标**\n    - [x] 是，监控指标及监控链接：\n    - [ ] 否\n+ **是否在窗口期进行发布变更**\n    - [ ] 是\n    - [x] 否，原因：\n+ **变更是否影响上下游**\n    - [x] 是，是否有提前知会上下游评估及关注变更\n        - [ ] 有提前知会\n        - [x] 没有提前知会\n    - [ ] 否\n\n**〖问题总结〗**\n\n**〖改进点〗**_**需明确写明不同故障相关方的改进项（若有的话），下同。**_\n\n### 5.2【处置能力】 __\n#### 5.2.1 故障发现&响应\n+ **是否监控发现**\n    - [ ] 故障触发方 监控发现\n    - [ ] 故障受影响方 监控发现\n    - [x] 否，原因为：（监控无效/监控缺失）\n+ **是否5分钟内响应**\n    - [x] 是\n    - [ ] 否，原因为：\n+ **是否存在应急协同问题**\n    - [x] 是\n        - [x] 应急流程不明确（无流程或者流程不清晰、应急相关角色&职责不明确，缺失一号位等)\n        - [ ] 应急执行不到位（有流程，但未按流程执行，通告发送不及时，响应不及时等）\n    - [ ] 否\n\n**〖问题总结〗**\n\n**〖改进点〗**_**需明确写明不同故障相关方的改进项（若有的话），下同。**_\n\n1、\n\n#### 5.2.2 故障定位&恢复\n+ **主要恢复方式：**\n    - [ ] 代码发布/回滚\n    - [x] 配置发布/回滚\n    - [ ] 数据订正\n    - [ ] 机器隔离/重启/扩容\n    - [ ] 配置限流\n    - [ ] 预案降级\n    - [ ] 自动恢复\n    - [ ] 其他：\n+ **是否10分钟内恢复**_/* P1P2故障填写*/_\n    - [ ] 是\n    - [ ] 否，原因：__________\n\n**〖关注点1〗定位&恢复阶段存在什么问题？是否可以增加预案，****有更快的恢复方式？****相关的优化改进？**\n\n**〖问题总结〗**\n\n**〖改进点〗**\n\n1、\n\n\n**〖关注点2〗业务自身是否具备容灾逃逸能力？后续如何改进？**_/* 如涉及基础设施引发的故障，可填写*/_\n\n- [x] 具备容灾能力\n    - [ ] 因未演练不敢执行\n    - [ ] 因有损评估决策不执行\n    - [ ] 无决策或者决策不当，未执行\n- [ ] 不具备容灾能力\n\n**〖问题总结〗**\n\n**〖改进点〗**\n\n\n\n## 六、故障Action\n| **序号** | *******Action** | *******负责人** | *******计划完成时间** | **",
    "chunk_order_index": 4,
    "full_doc_id": "doc-5e7ab53c51e7274920383ccc517422fc"
  },
  "chunk-f028026bbb8df7dd5d023cc461a4281b": {
    "tokens": 1200,
    "content": "- [ ] 因未演练不敢执行\n    - [ ] 因有损评估决策不执行\n    - [ ] 无决策或者决策不当，未执行\n- [ ] 不具备容灾能力\n\n**〖问题总结〗**\n\n**〖改进点〗**\n\n\n\n## 六、故障Action\n| **序号** | *******Action** | *******负责人** | *******计划完成时间** | **验收标准** | **是否keyAction** | **是否回血Action** |\n| --- | --- | --- | --- | --- | --- | --- |\n| 1 | 告警机制需要优化（稳定后上oncall）+ Sunfire采集度需求确认（确保Sunfire采集不到应用监控告警能告出）+ 保证高频打印异常日志时依然能收到有效告警   | 冀锋 | 1130 | 告警上线并验证通过 | 否 | 否 |\n| 2 | cs发布流程规范化 (同时确认规范是否能落到发布平台) | 项升 | 1130 | 产出更完善的《CS 变更规范》规范文档，同时确定规范是否能落到平台 | 否 | 否 |\n| 3 | 地址服务器批量添加IP页面的格式校验 | 项升 | 1231 | 地址服务器批量添加IP页面，可根据格式拒绝不合法配置 | 否 | 否 |\n| 4 | 地址服务器CS 权重修改逻辑的升级 | 修竺 | 1231 | 地址服务器只允许 CS 权重修改 0-1 | 否 | 否 |\n| 5 | 地址服务器遗留同机房规则的配置修改 | 项升 | 1231 | 地址服务器 将中心同机房规则、以及其它遗留无用规则移除 | 否 | 否 |\n| 6 | 长期改进：定时巡检脏数据 diff 并告警，及时发现集群内脏数据ip  | 冀锋 | 1231 | 完成改进内容并发布上线验收通过 | 否 | 否 |\n| 7 | 应急流程完善（影响多bu发生技术联席群）  | 乐尽 | 1130 | 产出应急流程规范文档并同步给中间件研发 | 否 | 否 |\n| 8 | CS 多语言 SDK 地址过长导致陷入长轮训，风险修复 | 朝生 | 1130 | CS 多语言 SDK  增加地址过长保护、增加地址更新跳出循环保护 | 是 | 否 |\n\n\n\n\n## 七、故障总结反思\n**【经验教训】**\n\n1. **CS 变更流程不规范：**\n    1. 未评估变更必要性\n    2. 未提交变更单，变更单应该体现风险评估、验证方案、回滚方案。\n    3. 大促期间，未和队长进行报备\n    4. 变更过程未灰度\n    5. 变更后未查看监控确保变更无误\n    6. 变更后未进行人工 double check确保变更无误\n2. CS 巡检监控仍需建设：\n    1. 出现异常，但告警失败\n    2. 基础监控告警要进一步完善，关于链接数变动，资源消耗变动。\n3. CS SDK/Client 存在设计缺陷，需要深挖系统链路，提前预知风险。\n    1. cs 异常地址过多，陷入长轮训，长时间无法恢复\n    2. cs 异常地址过多，CS Java SDK 长轮训过程存在内存泄露。\n\n\n\n2. **暴露了运维同学的问题：**\n+ 对 **变更红线 **认识不足、对 **敏感期变更 **的重视程度不够、对变更操作的步骤 **规范性 **不够\n\n\n\n**【做得好的】**\n\n+ 基于监控快速确认是 CS 变更导致的问题，及时回滚。\n+ 发现异常机房问题，及时定位问题ip列表，及时通知全部应用负责人。\n\n## 八、影响产品线&影响面\n| **受影响业务** | **等级** | **影响说明** |\n| --- | --- | --- |\n| 菜鸟、淘天、高德、居家设计 | P5 | - [x] 是否影响可用性：新上线应用，启动失败- [x] 是否有客诉：故障期间累计6例客诉客诉如下：[https://aliyuque.antfin.com/bx5106/gvmtiw/iddsg6865blgetpp](https://aliyuque.antfin.com/bx5106/gvmtiw/iddsg6865blgetpp)菜鸟应急：[https://alidocs.dingtalk.com/i/nodes/YQBnd5ExVEjea40qCyMAOwrPJyeZqMmz?cid=63537259329&utm_source=im&utm_scene=team_space&iframeQuery=utm_medium%3Dim_card%26utm_source%3Dim&utm_medium=im_card&corpId=dingd8e1123006514592](https://alidocs.dingtalk.com/i/nodes/YQBnd5ExVEjea40qCyMAOwrPJyeZqMmz?cid=63537259329&utm_source=im&utm_scene=team_space&iframeQuery=",
    "chunk_order_index": 5,
    "full_doc_id": "doc-5e7ab53c51e7274920383ccc517422fc"
  },
  "chunk-bbaea54917e0ebfeee24411c4208ba36": {
    "tokens": 1200,
    "content": "63537259329&utm_source=im&utm_scene=team_space&iframeQuery=utm_medium%3Dim_card%26utm_source%3Dim&utm_medium=im_card&corpId=dingd8e1123006514592](https://alidocs.dingtalk.com/i/nodes/YQBnd5ExVEjea40qCyMAOwrPJyeZqMmz?cid=63537259329&utm_source=im&utm_scene=team_space&iframeQuery=utm_medium%3Dim_card%26utm_source%3Dim&utm_medium=im_card&corpId=dingd8e1123006514592) |\n| 【线上问题】 | 未达故障 | 18:00 出现首个客诉，业务方自行重启provider 恢复，但未查到问题根因。次日上午查到问题根因并拉群处理，中午告知了全部受影响业务方风险点和解决方案，并持续跟进修复。 |\n| 【影响云侧音视频通信】 | * | 影响云侧音视频通信，10-15 19:22-20:09 音视频通信管控openAPI可用率下跌至约50%。20:09 音视频通信研发侧重启一台异常机器后恢复。后音视频通信产研反馈至HSF侧确认是受该异常影响。故障期间影响客户量：34个 (GC9:3个,GC7:3个,GC6:7个,GC5及以下:21个) 。![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/93056342/1729219029744-b05a53f0-2f5e-4522-9ee1-9392cbee2e84.png)音视频通信非核心管控openAPI可用率下跌至约50%， |\n\n\n****\n\n## 九、故障定级&定责&故障相关方\n【故障等级】P5  \n【故障责任方】不涉及  \n【故障分】P5不扣分\n\n| ** 系统质量（30%）** | | | | | **处置能力（70%）** |\n| --- | --- | --- | --- | --- | --- |\n| **相关方** | **需求设计** | **代码质量** | **变更质量** | **自定义项** | **发生时间** | **发现时间（30%）** | **恢复时间（40%）** |\n| 阿里控股-爱橙科技-技术风险与效能部-分布式基础技术 | N | N | Y |  | 2024-10-15 12:50 | 2024-10-15 12:20 | 2024-10-15 12:54 |\n\n\n> 故障涉及相关方都需填写，相关方包括但不限于触发方、根因方、导致故障影响扩大方、受影响方。\n>\n> 参考安全生产度量规范：[https://aliyuque.antfin.com/trecs/fzg6dy/wf9gze](https://aliyuque.antfin.com/trecs/fzg6dy/wf9gze)\n>\n> **系统质量：**\n>\n> + 需求&设计：是否存在系统架构设计、产品设计缺陷等设计方面问题，填 是或否或不涉及\n> + 代码质量：是否自身或引入第三方组件，存在代码BUG、漏洞等。填 是或否或不涉及\n> + 变更质量 ：配置及运维类变更，是否存在方案设计、灰度执行方面问题；提供的工具不满足红线要求方面问题。填 是或否或不涉及\n> + 自定义项：可不填写，根据复盘时讨论点实际确定\n>\n> **处置能力：**\n>\n> + 发生时间、发现时间、恢复时间需填写各方的时间\n> + 填具体时间或不涉及，若非监控发现，则勾选未发现\n> + 发现或恢复能力如不涉及，需描述具体理由\n> + 发现能力：受影响方缺少有效的系统监控手段，未发现业务异常等问题；变更执行方或触发方，对变更没有进行有效的观测，发现能力不足等问题\n> + 恢复能力：受影响方缺少容灾能力，响应速度慢等问题；处置方预案不足，响应速度慢等问题\n>\n\n## \n## 十、附录\n### 附1：故障打标规范\n参考：[https://aliyuque.antfin.com/ngoc/cltlwa/gw086g](https://aliyuque.antfin.com/ngoc/cltlwa/gw086g)\n\n#### 时间线打标规范\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/7773/1688969397509-2c9d7ddd-d346-4f1f-a73d-490bfab8acef.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/7773/1688969407141-945368c1-0780-4c63-8821-795ab3b5e1b3.png)\n\n\n\n### 附2：故障机制参考\n#### 故障相关方定义\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/7773/",
    "chunk_order_index": 6,
    "full_doc_id": "doc-5e7ab53c51e7274920383ccc517422fc"
  },
  "chunk-139c17baad0190b2a15919f1eaabdfb8": {
    "tokens": 640,
    "content": "![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/7773/1688969407141-945368c1-0780-4c63-8821-795ab3b5e1b3.png)\n\n\n\n### 附2：故障机制参考\n#### 故障相关方定义\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/7773/1688969946769-8bd28bca-7352-44d1-8b01-c73db5a2d281.png)\n\n[https://aliyuque.antfin.com/ngoc/fzg6dy/laf0oz](https://aliyuque.antfin.com/ngoc/fzg6dy/laf0oz)\n\n\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/2763/1656924636921-077e71cc-a8d1-40a0-8d7d-dc0e9ead77ba.png)\n\n#### 高可用故障分测算\n**横轴表示故障从发生时间开始-恢复时间的整个时长（分钟）：**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/2763/1656924726389-a00fb430-c3bc-44cf-a2aa-cf94aa97d8d4.png)\n\n备注：实际故障分以系统计算结果为准。\n\n\n\n**高可用故障分计算系数：**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/2763/1656924851376-9d274389-90ce-47e1-a3b7-1ed29818f417.png)\n\n#### 资损故障定级\n参考：[https://aliyuque.antfin.com/ngoc/fzg6dy/hikl2ibbk8934lax](https://aliyuque.antfin.com/ngoc/fzg6dy/hikl2ibbk8934lax)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/7773/1688970048219-78b29218-2ff2-499b-8f9d-70d50392106e.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/7773/1688970064707-8e0efecd-f516-4bd0-83ed-78a49f9d8316.png)\n\n#### 资损故障分测算\n![](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/301935/1659333193187-93e7c7a3-4625-4a9b-ab58-f903830b1262.png)\n\n\n\n# \n### \n## \n### \n####",
    "chunk_order_index": 7,
    "full_doc_id": "doc-5e7ab53c51e7274920383ccc517422fc"
  },
  "chunk-a241f9f6feb62aea1b84dda5e14ec2da": {
    "tokens": 1200,
    "content": "![](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/9827/1659103353652-0274c8cd-7318-4cd9-b730-0d66221680b6.png)\n\n_**内容涉及公司B3级别以上机密数据，请注意保密！**_\n\n| **故障链接** | [https://tr.alibaba-inc.com/ormEmergency/workbench/emergency/202410110000000481001](https://tr.alibaba-inc.com/ormEmergency/workbench/emergency/202410110000000481001) |\n| --- | --- |\n| **复盘时间** | 10月16日 周三 17:00 - 18:00(GMT+8) |\n| **复盘地点** | C1-209 风之谷（北京朝阳科技园C区） |\n| **参与人** | 淘天集团-用户平台&阿里妈妈事业部-阿里妈妈-广告技术部：稳定性负责人：广生工程技术-基础平台-SRE：娇娇工程技术-应用平台-业务平台：北一、彦谦、许乐 工程技术-效果BP-电商场景：麟彦、仲古、迁龙工程技术-基础平台-质量技术&平台-效果广告：落葵、卡卡商业化运营中心-客户体验-体验优化：珺景 |\n| **主持人** | 泽萱 |\n\n\n## 一、故障简述\n于10月11日10:35分开始客服团队陆续收到有关无界编辑创意报错的客户反馈，原因确认是发布harmonia-solar系统的diamond配置导致。通过回滚diamond配置，并重启harmonia-solar应用，业务于11:01分恢复。故障期间累计客诉272例。\n\n## 二、故障过程回顾\n### 2.1【时间线概览】\n![画板](https://intranetproxy.alipay.com/skylark/lark/0/2024/jpeg/80256396/1729067067541-9413edf8-c8e5-46a3-bbc4-206996aca90e.jpeg)\n\n故障发现～初因定位：17min\n\n初因定位～故障恢复：7min\n\n### 2.2【故障处理时间线】\n2024-10-11 10:33, 开始提交发布单，准备进行diamond配置变更发布，准备进行harmonia应用发布；\n\n**2024-10-11 10:34**，开始执行第一批diamond配置发布；**——【故障引入】**\n\n2024-10-11 10:35，开始发布第二批diamond配置发布；\n2024-10-11 10:36，diamond配置开关发布完成；\n\n**2024-10-11 10:37**，测试团队同学[@卡卡](undefined/kaka.lq)收到自动化巡检有关绑定创意异常的巡检报警；**——【故障发现】【业务响应】**\n\n2024-10-11 10:38，测试同学[@卡卡](undefined/kaka.lq)开始陆续同步bp开发直温、泽源、麟彦进行排查，[@麟彦](undefined/zmh356266)经排查发现是harmonia-solar问题，同时拨会联系创意中心开发北一、彦谦、许乐、测试落葵、赵淼复现跟进；\n\n**2024-10-11 10:43**，有关无界编辑创意报错的客诉达到40例（去重后）；**——【故障发生】**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/219530/1728724529126-8b1e2391-b93a-40b7-9dc9-df0efd369f3d.png)\n\n2024-10-11 10:46， [@仲古](undefined/zhonggu.qyc)创建应急群协同对焦处理；\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256396/1728993804716-8c92171b-9b86-464b-b733-73c5ee9d140d.png)\n\n2024-10-11 10:47，[@麟彦](undefined/zmh356266)发起语音会议进行对焦；\n\n**2024-10-11 10:54**，经排查初步确认与上午diamond配置发布时间点吻合，会间接影响系统调用引发编辑创意报错； [@北一](undefined/yidan.lyd)回滚diamond配置；**——【故障定位】【恢复执行】**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/219530/1728724040299-3c25eb19-f5c3-406a-9f6a-6386cdff0ca3.png)\n\n2024-10-11 10:56，[@北一](undefined/yidan.lyd)重启harmonia应用；\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/219530/1728724098828-7507502b-6273-4d80-8606-868f9263f5b6.png)\n\n**2024-10-11 11:01**，harmonia重启完成。**——【",
    "chunk_order_index": 0,
    "full_doc_id": "doc-f0b0d9aa267cdcedf7f7770d2332cb54"
  },
  "chunk-b3f83212693a7af2428076fec5f2334b": {
    "tokens": 1200,
    "content": "11 10:56，[@北一](undefined/yidan.lyd)重启harmonia应用；\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/219530/1728724098828-7507502b-6273-4d80-8606-868f9263f5b6.png)\n\n**2024-10-11 11:01**，harmonia重启完成。**——【故障恢复】【影响消除】**\n\n## 三、影响产品线&影响面\n    - [x] 是否有客诉量：\n        * 故障期间累计客诉：272例（去重后）\n        * 技术通过后台统计客户创意创编接口调用，10.35到11.01共匹配到272例客诉\n\n[1011日无界编辑创意报错客诉数据明细.xlsx](https://yuque.antfin.com/attachments/lark/0/2024/xlsx/147156506/1731031226165-a22189d5-2654-4dd3-a24c-a880273c8eb8.xlsx)\n\n    - [ ] 是否有社会舆情：\n        * 无\n    - [ ] 是否产生资损：\n        * 无\n\n链接：[https://aliyuque.antfin.com/qf9pla/dx8mse/zs13byulnad58mg8#BaBo](https://aliyuque.antfin.com/qf9pla/dx8mse/zs13byulnad58mg8#BaBo)\n\n截图：\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256396/1728984333488-816fef05-582a-469e-9d56-88852c4a96ed.png)\n\n## 四、故障原因\n### 4.1【背景说明】\n在直播链路中，会监听直播商品消息，并查询关联创意更新到创意上。直播批量添加大量商品，一个直播对应创意量的增加，在创意查询和更新时带来性能的问题。为提高系统性能，在harmonia系统中，对相关逻辑进行了优化保证，同时考虑避免对线上造成影响，在diamond平台配置了新的开关字段。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/219530/1728725266949-f9ba7134-96f2-4068-8e5c-caa3f8f753d5.png)\n\n### 4.2【原因分析】\n#### **【一句话原因】**\nharmonia发布diamond配置开关。配置最后一行k-v结构的value为空，解析配置的时候，用=号拆分kv，v解析是空值，从而引发致解析问题，导致异常。\n\n#### **【根因分析】**\n根据拉取的配置展示，diamond会在每行结尾增加\\r字符，所以使用=解析配置时，即使=后没有写值，也能正常拆分。但是在配置的最后一行，diamond不会增加\\r字符，所以=解析配置时，导致数组越界，抛出异常。\n\ndiamond平台页面展示：\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/219530/1728725266949-f9ba7134-96f2-4068-8e5c-caa3f8f753d5.png)\n\n拉取配置展示：\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/219530/1728725384818-01ed1af9-9e43-4dc6-931a-d24f29451e55.png)\n\n解析代码：\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/219530/1728725454647-753c4f5f-8c7e-4f39-a233-35a7dbc31f39.png)\n\n\n\ndiamond推送和回滚流程：\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/219530/1728988954231-bb78f8dd-82f9-4b93-a116-6c021df8f28b.png)\n\n**【回滚失败分析】**\n\n由于diamond解析失败，导致系统存的是旧的md5，在diamond回滚后，由于diamond机制，代码里的listener会缓存配置的md5和新下发的md5做对比，在diamond回滚后，md5和旧值相同，所以不会加载回滚后的配置。在harmonia系统重启后，重新拉取，所以才生效。\n\n\n\n## 五、关注点分析\n### 5.1【系统质量】\n#### 5.1.1 需求&设计评估\n**〖关注点〗****是否涉及产品、技术方案评估？此核心的问题是什么，如何改进？**\n\n    - [x] **是，涉及**\n        - [ ] 需求评估遗漏\n        - [ ] 产品设计缺陷\n        - [x] 系统架构设计缺陷：\n\n            - [x] 容错性不足 \n\n    - [ ] 单点，无冗余\n\n    - [ ] 缺乏自我保护\n\n            - [ ] 缓存设计不当\n\n    - [ ] 容量评估不足\n\n    - [ ] 非幂等设计\n\n            - [ ] 强弱依赖不合理\n\n    - [ ]",
    "chunk_order_index": 1,
    "full_doc_id": "doc-f0b0d9aa267cdcedf7f7770d2332cb54"
  },
  "chunk-825d53f0dd42f67cd7f327eac764f256": {
    "tokens": 1200,
    "content": "产品设计缺陷\n        - [x] 系统架构设计缺陷：\n\n            - [x] 容错性不足 \n\n    - [ ] 单点，无冗余\n\n    - [ ] 缺乏自我保护\n\n            - [ ] 缓存设计不当\n\n    - [ ] 容量评估不足\n\n    - [ ] 非幂等设计\n\n            - [ ] 强弱依赖不合理\n\n    - [ ] 其他： \n\n    - [ ] **否，不涉及**\n\n**〖问题总结〗**\n\ndiamond配置解析能力不够健壮。\n\n**〖改进点〗**_****_\n\n优化harmonia读取diamond配置的能力，提高代码兼容性，避免配置文件解析失败后对线上造成影响。对异常配置能及时报警以及避免对其他业务影响。——负责人：北一，预计：11.28，验收人：彦谦\n\n#### 5.1.2 代码质量\n##### **〖关注点1〗****CodeReview阶段**\n+ **是否经过CR（****红线点****）**\n\n- [x] 是   请提供代码提交or合并的Aone链接：[https://code.alibaba-inc.com/alimama-app-platform/harmonia/codereview/18663025?file=2a637ea1e6550abc67f6303d787dae3863e2db46](https://code.alibaba-inc.com/alimama-app-platform/harmonia/codereview/18663025?file=2a637ea1e6550abc67f6303d787dae3863e2db46)  （属于harmonia分支发布的CR） \n\n- [ ] 否\n\n- [ ] 不涉及\n\n+ **是否设置合理的CR卡点**\n\n- [ ] 是     \n\n- [x] 否，diamond变更没有cr卡点\n\n- [ ] 不涉及\n\n注：[CR卡点设置要求](https://ata.alibaba-inc.com/articles/225396?spm=ata.25287382.0.0.5e0c7536X43l05)\n\n+ **CodeReview阶段是否发现问题？**\n\n- [ ] 是\n\n- [x] 否，未发现原因：harmonia分支有进行CR；diamond配置变更无CR卡点，未进行CR\n\n**〖改进点〗**_****_\n\n1、harmonia系统配置发布增加审批流程。——负责人：北一，预计：10.25，验收人：彦谦\n\n##### **〖关注点2〗****单测阶段**\n+ **在线变更，****是否经过功能单测：（****红线点****）**\n\n        - [x] 是\n\n- [ ] 否\n\n+ **离线变更，****生成的离线数据是否经过数据校验：**（**红线点**，校验内容：与发布前版本对比，校验数据条数、数据大小、关键字段值域正态分布等是否符合预期）\n\n        - [ ] 是\n\n- [ ] 否\n\n+ **单测阶段是否发现问题？**\n\n- [ ] 是\n\n- [x] 否，未发现原因：测试阶段开关打开，diamond最后一行=后不为空，主要验证业务逻辑正常\n\n##### **〖关注点3〗****测试阶段**\n+ **测试内容：**业务性能优化逻辑正常，且将diamond配置开关置为生效、未生效状态进行的测试。\n+ **测试人员：北一**\n+ **是否经过测试验证：**\n    - [x] 是\n\n验证环境：\n\n- [x] 预发环境\n\n- [ ] 日常环境\n\n测试方法：\n\n- [ ] 回归测试\n\n- [ ] 集成测试\n\n- [x] 链路测试\n\n- [ ] 验收测试\n\n    - [ ] 否\n\n- [ ] 不涉及\n\n+ **是否自动化测试可覆盖：**\n\n    - [ ] 是\n\n- [x] 否\n\n\n\n+ **测试未发现的原因：**\n    - [x] 回归遗漏\n\n        - [x] 手工回归case遗漏\n\n- [ ] 自动化未建设\n\n- [ ] 自动化回归覆盖不足\n\n- [ ] 其它： \n\n    - [x] 新场景遗漏\n\n        - [x] 功能测试用例遗漏，包括正常分支和异常分支\n\n- [ ] 容灾兜底测试遗漏\n\n        - [x] 客户端兼容性测试遗漏\n\n- [ ] 埋点测试遗漏\n\n        - [ ] 性能测试遗漏，影响评估不足\n\n- [ ] 安全测试遗漏\n\n        - [ ] 其他： \n\n**〖改进点〗**_****_\n\n对diamond的兼容性测试应该全面。\n\n保障测试阶段与发布阶段的发布内容一致性。\n\n#### 5.1.3 变更质量\n+ **是否涉及变更：**\n\n    - [x] 是\n\n- [ ] 否\n\n\n\n+ **变更类型：**\n\n- [x] 在线生产代码变更\n\n- [ ] 引擎全量索引变更\n\n- [ ] 实时索引更新变更\n\n- [ ] 算法模型变更\n\n- [ ] whaleshark实验参数变更\n\n- [ ] 其他变更： \n\n- [ ] 不涉及\n\n+ **变更平台是否接入ChangeFree：**\n    - [x] 是，CF变更单链接： [https://aicf.alibaba-inc.com/aicf/grayscale/hm?publishInfo",
    "chunk_order_index": 2,
    "full_doc_id": "doc-f0b0d9aa267cdcedf7f7770d2332cb54"
  },
  "chunk-a39466db9b5fff1bb92bf9d44a25e17f": {
    "tokens": 1200,
    "content": "擎全量索引变更\n\n- [ ] 实时索引更新变更\n\n- [ ] 算法模型变更\n\n- [ ] whaleshark实验参数变更\n\n- [ ] 其他变更： \n\n- [ ] 不涉及\n\n+ **变更平台是否接入ChangeFree：**\n    - [x] 是，CF变更单链接： [https://aicf.alibaba-inc.com/aicf/grayscale/hm?publishInfoDownId=432731293](https://aicf.alibaba-inc.com/aicf/grayscale/hm?publishInfoDownId=432731293) \n    - [ ] 否，外部变更系统： \n+ **是否违反变更红线3.2**** **[**链接**](https://aliyuque.antfin.com/trecs/fzg6dy/uar1k6)\n    - [x] 是，违反哪条原则：本次diamond配置发布未经过beta环境发布，且灰度间隔时间不符合变更规范。\n    - [ ] 否\n\n##### **〖关注点1〗****灰度阶段**\n变更执行影响面**资损低于20%**或影响**客户数量低于20%**的变更统一称为灰度变更\n\n+ **是否经过灰度：（****红线点****）**\n- [x] 是，\n    - 是否有效灰度（灰度发布时间间隔大于20分钟）：\n\n        - [ ] 是\n\n- [x] 否\n\n- [ ] 否\n+ **是否灰度期间发现问题？**\n    - [ ] 是\n\n        - [ ] 灰度流量过大，引发故障\n\n- [ ] 灰度发现但未有效或及时修复，导致故障\n\n- [ ] 其它： \n\n    - [x] 否，未发现原因：\n\n        - [ ] 应用灰：\n\n- [ ] 灰度流量太小\n\n- [ ] 灰度阶段无法监控\n\n- [ ] 灰度批次不合理\n\n- [ ] 超长时间灰度才能发现\n\n        - [ ] 业务灰：策略不合理\n        - [ ] 灰度无法发现\n        - [x] 其它：      灰度间隔时间过短， 且harmonia代码发布还未到beta环境       \n\n**〖改进点〗**_****_\n\n1、diamond发布也要注意灰度间隔时间，将业务平台变更规范带回团队进行宣讲。——负责人：许乐，预计：10.25\n\n2、重要配置变更发布前通过diamond平台指定至业务代码在beta环境生效的机器中先进行验证，验证通过后再进行线上发布。\n\n##### **〖关注点2〗****上线阶段**\n+ **是否在窗口期进行发布变更：**【周一~周五 09：30~20：00（注意避开吃饭时间12:00~13:30）】\n    - [x] 是\n    - [ ] 否，原因： \n+ **变更是否影响上下游**\n    - [ ] 是，是否有提前知会上下游评估及关注变更\n        - [ ] 有提前知会\n        - [ ] 没有提前知会\n    - [x] 否\n+ **是否分批分机房或分批发布：（****红线点****）**\n\n    - [x] 是\n\n\n\n    - 分机房或分批发布第一批发布时间间隔是否大于20分钟：\n\n        - [ ] 是\n\n- [x] 否  harmonia分支发布，会有时间间隔；但diamond分批发布时间间隔不足20min\n\n    - [ ] 否\n+ **是否进行黄金眼指标观察：**（涉及引擎相关变更，此点为**红线点**，变更10分钟左右，观察已发布本机房、核心pid、分广告主体类型的黄金眼业务指标）\n    - [ ] 是，观测监控链接： \n    - 是否发现问题\n\n        - [ ] 是\n\n- [ ] 否，原因： \n\n    - [ ] 否    \n    - [x] 不涉及\n+ **是否验证变更改动点：**(**红线点**，已变更的功能逻辑&数据已经生效)\n    - [ ] 是 (请提供观测监控链接，或直接/间接生效截图记录)： \n    - 是否发现问题\n\n        - [ ] 是\n\n- [ ] 否，原因： \n\n    - [x] 否  发布时间到问题发生时间较短，还未来得及验证改动点。\n+ **是否验证其它核心变点：**(错误日志/功能或接口成功率或失败率/rt、CPU、内存等系统指标等)\n    - [ ] 是 验证点： \n    - 是否发现问题\n\n        - [ ] 是\n\n- [ ] 否，原因： \n\n    - [x] 否 发布时间到问题发生时间较短，还未来得及验证改动点。\n\n**〖改进点〗 **\n\n1、diamond配置发布拉大间隔时间，及时验证改动点。\n\n### 5.2【处置能力】\n#### 5.2.1 故障发现&响应\n+ **是否监控发现**\n    - [x] 是，监控报警链接： \n\n        - [ ] 故障触发方\n\n- [x] 受影响方\n\n    - [ ] 否\n\n        - [ ] 监",
    "chunk_order_index": 3,
    "full_doc_id": "doc-f0b0d9aa267cdcedf7f7770d2332cb54"
  },
  "chunk-e065d091ac08161a72fe6030b2f2276b": {
    "tokens": 1200,
    "content": "进点〗 **\n\n1、diamond配置发布拉大间隔时间，及时验证改动点。\n\n### 5.2【处置能力】\n#### 5.2.1 故障发现&响应\n+ **是否监控发现**\n    - [x] 是，监控报警链接： \n\n        - [ ] 故障触发方\n\n- [x] 受影响方\n\n    - [ ] 否\n\n        - [ ] 监控缺失\n\n- [ ] 监控无效\n\n- [ ] 无法监控\n\n+ **发现后是否五分钟内响应**\n    - [x] 是\n    - [ ] 否，原因为：\n+ **应急协同组织是否存在问题，如何改进？**\n    - [ ] 是\n        - [ ] 应急流程不明确（无流程或者流程不清晰、应急相关角色&职责不明确，缺失一号位等)\n        - [ ] 应急执行不到位（有流程，但未按流程执行，通告发送不及时，响应不及时等）\n    - [x] 否\n\n**〖改进点〗**_****_\n\n1、针对harmonia-solar应用的java异常错误数监控报警方式调整为电话报警，调整核心监控报警方式，对系统报警及时关注并处理。——负责人：北一，预计：10.25，验收人：彦谦\n\n2、业务平台新增接口异常的业务监控；——负责人：北一，预计：10.25，验收人：彦谦\n\n#### 5.2.2 故障定位&恢复\n+ **主要恢复方式：**\n\n    - [ ] 代码发布/回滚\n\n- [x] 配置发布/回滚\n\n- [ ] 数据订正\n\n- [x] 机器隔离/重启/扩容\n\n    - [ ] 配置限流\n\n- [ ] 预案降级\n\n- [ ] 自动恢复\n\n- [ ] 其它： \n\n+ **是否10分钟内恢复**__\n    - [ ] 是\n    - [x] 否，原因：      配置回滚未生效，重启了机器。                  \n\n**〖关注点1〗定位&恢复阶段存在什么问题？是否可以增加预案，****有更快的恢复方式？****相关的优化改进？**\n\ndiamond回滚机制问题，如果了解详细原理，可采取其他diamond修改方式，快速恢复。\n\n**〖关注点2〗业务自身是否具备容灾逃逸能力？后续如何改进？**_/* 如涉及基础设施引发的故障，可填写*/_\n\n- [ ] 具备容灾能力\n\n    - [ ] 因未演练不敢执行\n\n- [ ] 因有损评估决策不执行\n\n- [ ] 无决策或者决策不当，未执行\n\n- [x] 不具备容灾能力\n\n**〖改进点〗**\n\n切流无法解决该问题。\n\n## 六、故障总结反思\n+ **此次故障是否触发广告技术部安全生产考试中的红线点？**\n\n- [x] 是，团队：     淘天集团-用户平台&阿里妈妈事业部-阿里妈妈-广告技术部-工程技术-应用平台-业务平台（未经过beta环境验证，灰度间隔时间不符合要求，发布后故障影响较为迅速，未来得及进行发布后变更改动点的验证） \n\n- [ ] 否\n\n**【做得好的】**\n\n问题发生到处理，可及时对问题进行定位和恢复。\n\n**【经验教训】**\n\ndiamond配置发布也需要增加关注度，diamond更新原理的了解，有助于更快恢复问题。\n\n## 七、故障Action\n| **序号** | *******Action标题** | *******负责人** | *******计划完成时间** | **Action描述** | **验收标准** | **验收人** | **是否keyAction** | **是否回血Action** |\n| :---: | --- | :---: | :---: | --- | --- | :---: | :---: | :---: |\n| 1 | 短期：增加配置变更审批卡点 | 北一 | 10.25 | harmonia系统配置发布增加审批流程。 | 确保harmonia系统配置发布新增审批流程的卡点。 | 彦谦 | - | - |\n| 2 | 短期：将变更规范要求带回团队宣导 | 许乐 | 10.25 | 将业务平台变更规范带回团队进行宣讲，包括但不限于以下内容：1. 配置变更上线前需要经过beta环境验证；2. 留意diamond配置变更兼容性测试方面；3. 保障发布阶段与测试阶段的内容一致性；4. diamond发布也要注意灰度时间间隔；5. diamond配置发布后及时验证改动点。 | - | - | - | - |\n| 3 | 短期：监控报警方式调整 | 北一 | 10.25 | 针对harmonia-solar应用的java异常错误数监控报警方式调整为电话报警，调整核心监控报警方式，对系统报警及时关注并处理。 | 确保核心监控报警方式调整为电话报警，及时发现问题。 | 彦谦 | 是 | - |\n| 4 | 短期：新增接口监控 | 北一 | 10.",
    "chunk_order_index": 4,
    "full_doc_id": "doc-f0b0d9aa267cdcedf7f7770d2332cb54"
  },
  "chunk-ca3aa02821362388ba341c137075f405": {
    "tokens": 1103,
    "content": "：监控报警方式调整 | 北一 | 10.25 | 针对harmonia-solar应用的java异常错误数监控报警方式调整为电话报警，调整核心监控报警方式，对系统报警及时关注并处理。 | 确保核心监控报警方式调整为电话报警，及时发现问题。 | 彦谦 | 是 | - |\n| 4 | 短期：新增接口监控 | 北一 | 10.25 | 业务平台新增接口异常的业务监控。 | 确保新增接口监控的监控有效性和报警及时性。 | 彦谦 | - | - |\n| 5 | 长期：harmonia的配置解析逻辑增加健壮性 | 北一 | 11.28 | 优化harmonia读取diamond配置的能力，提高代码兼容性，避免配置文件解析失败后对线上造成影响，针对异常配置能及时报警以及避免对其他业务影响。 | 确保代码兼容性得到优化处理。 | 彦谦 | 是 | - |\n\n\n## 八、故障定级&定责&故障分自查\n【故障等级】P4\n\n【故障分】_/* 以系统计算结果为准*/_\n\n| **  系统质量（30%）** | | | | | **处置能力（70%）** |\n| :---: | --- | --- | --- | --- | :---: |\n| **相关方** | **需求设计** | **代码质量** | **变更质量** | **自定义项** | **发生时间** | **发现时间（30%）** | **恢复时间（40%）** |\n| 淘天集团-用户平台&阿里妈妈事业部-阿里妈妈-广告技术部-工程技术-应用平台-业务平台 | 是 | 是 | 是 | - | 10-11 10:43 | 10-11 10:37 | 10-11 11:01 |\n\n\n## 九、附录\n### 附1：故障打标规范\n参考：[https://aliyuque.antfin.com/ngoc/cltlwa/gw086g](https://aliyuque.antfin.com/ngoc/cltlwa/gw086g)\n\n#### 时间线打标规范\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/7773/1688969397509-2c9d7ddd-d346-4f1f-a73d-490bfab8acef.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/7773/1688969407141-945368c1-0780-4c63-8821-795ab3b5e1b3.png)\n\n\n\n### 附2：故障机制参考\n#### 故障相关方定义\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/7773/1688969946769-8bd28bca-7352-44d1-8b01-c73db5a2d281.png)\n\n[https://aliyuque.antfin.com/ngoc/fzg6dy/laf0oz](https://aliyuque.antfin.com/ngoc/fzg6dy/laf0oz)\n\n\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/2763/1656924636921-077e71cc-a8d1-40a0-8d7d-dc0e9ead77ba.png)\n\n#### 高可用故障分\n**横轴表示故障从发生时间开始-恢复时间的整个时长（分钟）：**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/2763/1656924726389-a00fb430-c3bc-44cf-a2aa-cf94aa97d8d4.png)\n\n\n\n**高可用故障分计算系数：**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/2763/1656924851376-9d274389-90ce-47e1-a3b7-1ed29818f417.png)\n\n#### 资损故障定级标准\n参考：[https://aliyuque.antfin.com/ngoc/fzg6dy/hikl2ibbk8934lax](https://aliyuque.antfin.com/ngoc/fzg6dy/hikl2ibbk8934lax)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/7773/1688970048219-78b29218-2ff2-499b-8f9d-70d50392106e.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/7773/1688970064707-8e0efecd-f516-4bd0-83ed-78a49f9d8316.png)",
    "chunk_order_index": 5,
    "full_doc_id": "doc-f0b0d9aa267cdcedf7f7770d2332cb54"
  },
  "chunk-c6ff41005db6a4e80842f60302eba34d": {
    "tokens": 3,
    "content": "6.png)",
    "chunk_order_index": 6,
    "full_doc_id": "doc-f0b0d9aa267cdcedf7f7770d2332cb54"
  },
  "chunk-192a25adbea68f08ede06f3166ab9aa6": {
    "tokens": 1200,
    "content": "![](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/9827/1659103353652-0274c8cd-7318-4cd9-b730-0d66221680b6.png)\n\n**内容涉及公司B3级别以上机密数据，请注意保密！**\n\n| **复盘参与人员** | 淘天集团-用户平台&阿里妈妈事业部-阿里妈妈-广告技术部：稳定性负责人：广生工程技术-基础平台-SRE：娇娇工程技术-应用平台-业务平台：端默、许乐、乐焱工程技术-效果BP-电商场景：仲古工程技术-AI数据与应用平台：聚米工程技术-基础平台-质量技术&平台：林寒、落葵---  淘天集团-业务技术-自营技术：SRE：潮汐、贰肆经营技术-商业化&财务分析：学禹、荀一经营技术-计费业务：彬灵质量与安全生产-经营技术质量：识久 GOC：晓宇---  云智能集团-阿里云智能-政企事业部-专有云-云平台运维与交付-集团服务专家组：CRE：传学云智能集团-阿里云智能-阿里云智能CTO线-数据库产品事业部-ADB产品部-AnalyticDB MySQL：存储服务组-存储稳定性组：柯尽弹性计算组：凌彬智能优化组：西问 |\n| --- | --- |\n| **地点** | 北京：C1-211 忘忧谷（北京朝阳科技园C区）杭州：A7-4-19-S 温风至（西溪A区）、1-3-D14 上林坞（云谷园区） |\n| **会议时间** | 10月17日 周四 17:00 - 18:00 （GMT +8:00） |\n| **复盘主持人** | 泽萱 |\n\n\n## 一、故障简述\n于2024年10月11日10:35分开始陆续收到有关无界猫超店铺添加宝贝报错、货品运营修改预算空白、关键词计划点击报错的相关客诉，原因确认是猫超团队ADB实例集群因为FullGC引发大量的连接阻塞、慢查询，进而导致妈妈侧调用猫超选品接口时报错引发客诉。ADB团队同学通过执行集群垂直扩容后，业务于12:31分恢复。故障期间累计客诉32例。\n\n**APM故障链接：**\n\n [https://tr.alibaba-inc.com/ormEmergency/workbench/emergency/202410110000000602001](https://tr.alibaba-inc.com/ormEmergency/workbench/emergency/202410110000000602001)\n\n## 二、故障过程回顾\n### 2.1【时间线概览】\n【阿里妈妈】\n\n![画板](https://intranetproxy.alipay.com/skylark/lark/0/2024/jpeg/80256396/1729148364490-37f69791-18e3-4313-bd46-c6b79582d018.jpeg)\n\n### 2.2【故障处理时间线】\n#### **2.2.1【关键时间节点】**\n**2024-09-03 00:10**，阿里云团队ADB集群版本升级；**——【故障注入】**\n\n**2024-10-11 10:30**，阿里妈妈测试团队巡检任务报错，测试同学[@落葵](undefined/fengxia.lfx)介入排查，确认货品运营场景主流程打开超时，并联系货品场景同学排查；**——【阿里妈妈故障发现】【阿里妈妈故障响应】**\n\n**2024-10-11 10:57**，阿里妈妈客服团队收到有关无界猫超商家相关客诉反馈达到3例。**——【故障发生】**\n\n**2024-10-11 11:00**，猫超监控发现选品接口所在服务成功率告警；**——【猫超故障发现】【猫超故障响应】**\n\n2024-10-11 11:03，猫超开发[@荀一](undefined/chengjinqi.cjq)联系阿里妈妈技术同学[@端默](undefined/duanmo.cp)联合排查；****\n\n**2024-10-11 11:27:38**，猫超同学[@荀一](undefined/chengjinqi.cjq)监控发现实例链接池满导致接口耗时增加，联系集团ADB团队同学协助排查实例am-zhbsmsuppplatform 连接池满的问题，工单链接：[https://aone.alibaba-inc.com/v2/project/1109817/bug/60160367](https://aone.alibaba-inc.com/v2/project/1109817/bug/60160367)。**——【初因定位】**\n\n**2024-10-11 11:35:33**，阿里云ADB团队[@柯尽](undefined/linhaojie.lhj)同学开始介入排查；**——【阿里云故障发现】【阿里云业务响应】**\n\n2024-10-11 11:42，阿里妈妈技术同学[@端默](undefined/duanmo.cp",
    "chunk_order_index": 0,
    "full_doc_id": "doc-8919b47a13c30569aae09a184cc8291d"
  },
  "chunk-c8f1fa54691a5f179e1dca86b1303ac7": {
    "tokens": 1200,
    "content": "/bug/60160367)。**——【初因定位】**\n\n**2024-10-11 11:35:33**，阿里云ADB团队[@柯尽](undefined/linhaojie.lhj)同学开始介入排查；**——【阿里云故障发现】【阿里云业务响应】**\n\n2024-10-11 11:42，阿里妈妈技术同学[@端默](undefined/duanmo.cp)排查发现影响猫超adb的慢查询请求来自 mama-ai-tools 联系[@聚米](undefined/shaodi.ssd) 排查；\n2024-10-11 11:58:16，阿里妈妈AI应用团队[@聚米](undefined/shaodi.ssd)同学，开始执行有关mama-ai-tools应用的降级操作；\n2024-10-11 12:02:00，猫超同学[@学禹](undefined/grey.gl)联系ADB同学[@柯尽](undefined/linhaojie.lhj)[@沉尘](undefined/zhuzhanyang.zzy) 进行集群垂直扩容；****\n\n2024-10-11 12:04:04，阿里妈妈团队执行mama-ai-tools应用降级操作完毕，该应用不再请求BP报表；\n\n**2024-10-11 12:28:28**，ADB团队[@柯尽](undefined/linhaojie.lhj)同学开始执行集群垂直扩容操作；**——【阿里云恢复执行】**\n\n**2024-10-11 12:31**，猫超查询接口平均耗时恢复至日常水位；**——【故障恢复】**\n\n2024-10-11 12:44:25，ADB团队集群垂直扩容操作执行完毕；\n\n**2024-10-15 18:41**，集群重启后关闭对应bug功能。**——【影响消除】**\n\n#### **2.2.2【故障详细时间点】**\n| **时间轴** | **事件** |\n| :---: | --- |\n| 2024-09-03 00:10 | **【故障注入】**** **阿里云团队ADB集群版本升级 |\n| **2024-10-11 10:30** | **【阿里妈妈故障发现】**** ****【阿里妈妈业务响应】**巡检报错，伪登录复现时，发现主流程无法打开，联系货品运营场景排查主流程问题，人群等业务巡检未报错，因此未第一时间怀疑是猫超侧问题。![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/5845/1729048197726-38c85b6e-c4e3-49ea-919e-ceaedab50b80.png) |\n| **2024-10-11 10:57** | **【阿里妈妈故障发生】**阿里妈妈客服团队收到有关无界猫超商家相关客诉反馈达到3例。 |\n| **2024-10-11 11:00** | **【猫超故障发现】 **** **** 【猫超故障响应】**** **猫超监控发现选品接口所在服务成功率告警。![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/18456389/1728724878422-af71e4a8-447a-4fd3-8e23-2868b1798218.png) |\n| 2024-10-11 11:03 | 猫超开发[@荀一](undefined/chengjinqi.cjq)联系阿里妈妈技术同学[@端默](undefined/duanmo.cp)联合排查。![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/18456389/1728724744567-fa2a0326-98ec-430a-aae2-19bea3526c23.png) |\n| 2024-10-11 11:25 | 阿里妈妈广告技术部收到有关无界猫超店铺添加宝贝提示报错的客诉预警单。![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256396/1729045254188-ac8e6db5-3efa-49da-9f95-d8bddda909e7.png) |\n| 2024-10-11 11:26 | 阿里妈妈研发同学[@麟彦](undefined/zmh356266)接手预警单，并创建应急协同群协同处理。 |\n| 2024-10-11 11:27 | 阿里妈妈测试同学[@落葵](undefined/fengxia.lfx)反馈巡检已经有发现，并将traceid：213d561117286131102122207d0d50 提供给研发同学[@麟彦](undefined/zmh356266)[@文见](undefined/wangwenjian.wwj)。 |\n| 2024-10-11 11:27:38 | **【初因定位】**** **猫超同学[@荀一](undefined/chengjinqi.cjq)监控发现实例链接池满导致接口耗时增加，联系集团ADB团队同学协助排查实例am-zhbsmsuppplatform 连接池满的问题，工单",
    "chunk_order_index": 1,
    "full_doc_id": "doc-8919b47a13c30569aae09a184cc8291d"
  },
  "chunk-4979a59d60c832cc150156e33e8f1fdd": {
    "tokens": 1200,
    "content": "undefined/zmh356266)[@文见](undefined/wangwenjian.wwj)。 |\n| 2024-10-11 11:27:38 | **【初因定位】**** **猫超同学[@荀一](undefined/chengjinqi.cjq)监控发现实例链接池满导致接口耗时增加，联系集团ADB团队同学协助排查实例am-zhbsmsuppplatform 连接池满的问题，工单链接：[https://aone.alibaba-inc.com/v2/project/1109817/bug/60160367](https://aone.alibaba-inc.com/v2/project/1109817/bug/60160367)。 |\n| 2024-10-11 11:28 | 阿里妈妈研发同学[@仲古](undefined/zhonggu.qyc)发起语音会议对焦；[@文见](undefined/wangwenjian.wwj)提供异常业务日志报错信息；[@端默](undefined/duanmo.cp)邀请猫超同学[@荀一](undefined/chengjinqi.cjq)进应急群对焦。![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256396/1729046534665-a22c16bf-0dfe-46d7-bbee-938547a80568.png) |\n| 2024-10-11 11:32 | 阿里妈妈研发同学[@端默](undefined/duanmo.cp)咨询猫超同学[@荀一](undefined/chengjinqi.cjq)能否紧急止血。 |\n| 2024-10-11 11:35 | 猫超同学[@荀一](undefined/chengjinqi.cjq)提供接口报错及异常流量（慢查询）的报错日志。 |\n| 2024-10-11 11:35:33 | **【阿里云故障发现】**** ****【阿里云业务响应】**阿里云ADB团队[@柯尽](undefined/linhaojie.lhj)同学开始介入排查； |\n| 2024-10-11 11:42 | 阿里妈妈技术同学[@端默](undefined/duanmo.cp)排查发现影响猫超adb的慢查询请求来自 mama-ai-tools 应用，并联系[@聚米](undefined/shaodi.ssd) 排查； |\n| 2024-10-11 11:58:16 | 阿里妈妈AI应用团队[@聚米](undefined/shaodi.ssd)同学，开始执行有关mama-ai-tools应用的降级操作。 |\n| 2024-10-11 12:02:00 | 猫超同学[@学禹](undefined/grey.gl)联系ADB同学[@柯尽](undefined/linhaojie.lhj)[@沉尘](undefined/zhuzhanyang.zzy) 进行集群垂直扩容。 |\n| 2024-10-11 12:04:04 | mama-ai-tools应用降级操作完毕，该应用不再请求BP报表。![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256396/1728725791754-9d4dc002-2b34-48de-a216-b6c187b94934.png) |\n| **2024-10-11 12:28:28** | **【阿里云恢复执行】**ADB团队[@柯尽](undefined/linhaojie.lhj)同学开始执行集群垂直扩容操作。 |\n| **2024-10-11 12:31** | **【故障恢复】**猫超查询接口平均耗时恢复至日常水位。![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256396/1729053744186-b4b00b29-d74e-4ad3-8149-f22dc440d765.png) |\n| 2024-10-11 12:44:25 | ADB团队集群垂直扩容操作执行完毕。 |\n| 2024-10-11 12:49:00 | 线上巡检恢复，伪登陆客户可正常打开选品功能，妈妈开发 [@端默](undefined/duanmo.cp) 完结风险预警单。 |\n| **2024-10-15 18:41** | **【影响消除】**集群重启后关闭对应bug功能。**** |\n\n\n\n\n\n\n## 三、影响产品线&影响面\n    - [x] 是否有客诉量：\n        * 故障期间无界整体累计客诉：32例（去重后）\n\n[1011日无界猫超店铺添加宝贝报错客诉明细.xlsx](https://yuque.antfin.com/attachments/lark/0/2024/xlsx/147156506/1731031226221-1c795d22-e80d-4a15-952a-bb8e2193e285.xlsx)\n\n    - [ ] 是否产生资损：\n        * 无\n\n## 四、故障原因\n### 4.1【一句话原因】\n猫超团队ADB实例集群因为FGC引发大量的连接阻塞、慢查询，进而导致妈妈侧调用猫超选品接口时报错引发客诉。\n\n### 4.2【详细原因】\n**【阿里",
    "chunk_order_index": 2,
    "full_doc_id": "doc-8919b47a13c30569aae09a184cc8291d"
  },
  "chunk-9df642381d795f77f1d8a1d617c851af": {
    "tokens": 1200,
    "content": "d-4a15-952a-bb8e2193e285.xlsx)\n\n    - [ ] 是否产生资损：\n        * 无\n\n## 四、故障原因\n### 4.1【一句话原因】\n猫超团队ADB实例集群因为FGC引发大量的连接阻塞、慢查询，进而导致妈妈侧调用猫超选品接口时报错引发客诉。\n\n### 4.2【详细原因】\n**【阿里妈妈受影响链路】**\n\n猫超客户登录到万相台无界版后，打开选品浮层、货品运营修改预算、关键词计划点击会请求ad-feed进行商品查询，ad-feed中会根据账户类型识别到猫超客户从而请求猫超侧接口。如果猫超侧接口超时或报错，则猫超客户的选品浮层、货品运营修改预算、关键词计划点击也会对应报错。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/313976/1728964194041-0ac0573c-6edb-4e35-a313-6975dd26ff90.png)![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256396/1729049440040-522a2465-583a-4721-9398-5cbb0f3c6c0e.png)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256396/1729049786422-18cbd9b9-e5a7-4a59-8279-bd4064d04407.png)![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256396/1729049798082-7d303115-9b63-4123-96d1-27f7f2f11ad7.png)\n\n---\n\n**【猫超】**\n\n猫超侧对外（For 阿里妈妈）提供的选品查询接口，底层使用到ADB进行数据存储，故障期间发现ADB实例集群因为FGC引发大量的连接阻塞、慢查询，进而导致妈妈侧调用猫超选品接口时报错。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/18456389/1729049638324-3eed5fdd-03cc-4b4c-ab45-f0f538c40566.png)\n\n---\n\n**【阿里云】**\n\n【发布背景】\nADB集群正常版本迭代升级，进行集群实例性能优化。\n【原因分析】\n新版本native引擎的bug导致在并发较大时，可能会造成内存回收不及时导致fullgc\n\n+ 1、堆外内存生命周期太长导致的内存压力大。adaptor connector方案设计时，因涉及到java和c++之间的数据传输，每个线程需要一块堆外内存。堆外内存的生命周期设计太长，基本对应整个query的生命周期。导致并发高情况下，最多同时存在 `query并发数 * 单query并发线程数 * tablescan个数`的堆外内存同时存在，增大 GC 压力，在高并发情况下，可能导致堆外内存被打满。\n+ 2、native adaptor connector ConnectorPageSource存在对象泄漏，加深内存压力。一个数据分片（split）对应一个ConnectorPageSource，旧引擎整体逻辑是一个分片起一个线程，线程销毁时，ConnectorPageSource会调用close方法释放自身资源占用。native引擎整体逻辑是固定大小的线程池，每个线程处理一个分片，新建一个ConnectorPageSource对象，分片处理完后，继续处理下一个。由于复用之前释放逻辑，只有当线程结束时，才会释放ConnectorPageSource对象，导致只有最后一个被处理分片的ConnectorPageSource对象会被释放，其余对象保持着资源占用，直到超时（3天）才会释放。\n\n\n\nadaptor connector addsplit 同一个线程会被调用多次，每一次调用新建一个新的connectorPageSource。\n\n但是旧的connectorPageSource 并不会没有调用close()\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/2756591/1729149251936-8b3ca7df-c6f8-4921-aa9d-f836af6b9f73.png)\n\n只有最后一个connectorPageSource会被close掉。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/2756591/1729149251881-8f44bff5-2a84-4240-80eb-451846e8d3c2.png)\n\n## 五、关注点讨论\n#### 1、问题引入阶段\n【在/离线变更代码开发完成后，需要经过**code review**确认无误后进行合并**代码主干**提交】--红线点\n【在线变更代码修改提交必须经过**功能单测；**离线变更代码修改完成后，生成的离线数据必须要经过**数据校验**】--红线点\n\n**〖关注点1〗**是否有经过CR？是否有经过单测？是否有经过测试？是否自动化测试可覆盖？测试阶段为何没",
    "chunk_order_index": 3,
    "full_doc_id": "doc-8919b47a13c30569aae09a184cc8291d"
  },
  "chunk-1e0277988c8b0846df952e88f13f4d7e": {
    "tokens": 1200,
    "content": "code review**确认无误后进行合并**代码主干**提交】--红线点\n【在线变更代码修改提交必须经过**功能单测；**离线变更代码修改完成后，生成的离线数据必须要经过**数据校验**】--红线点\n\n**〖关注点1〗**是否有经过CR？是否有经过单测？是否有经过测试？是否自动化测试可覆盖？测试阶段为何没发现？\n请提供CR链接：[https://code.alibaba-inc.com/garuda/adb-xihe/codereview/15200173?tab=changes](https://code.alibaba-inc.com/garuda/adb-xihe/codereview/15200173?tab=changes)\n\n[https://code.alibaba-inc.com/garuda/adb-xihe/codereview/15287571](https://code.alibaba-inc.com/garuda/adb-xihe/codereview/15287571)\n\n [原因分析] 有CR，有功能单测并经过测试。bug触发条件较复杂，需要一段时间，对象慢慢泄漏，加深内存压力，并在并发较大时，才可能会造成内存回收不及时，导致fgc。常规压测集下，并未发现该问题。\n ACTION：\n针对内存打满后对象泄漏的场景进行测试用例的补充。——负责人：西问，已完成\n\n【生产变更，**务必要经过灰度发布**，灰度发布时间**间隔大于20min****】**--红线点\n\n**〖关注点2〗**是否变更窗口期进行发布？是否经过灰度？分机房或分批发布第一批发布时间间隔是否大于20分钟？灰度过程中为何未发现问题？\n请提供ChangeFree变更单链接：[https://bg.aliyun-inc.com/#/change-approval/detail?bgVid=BG2024082907K1KCDWF](https://bg.aliyun-inc.com/#/change-approval/detail?bgVid=BG2024082907K1KCDWF)\n\n [原因分析]非变更窗口期发布，有经过审批，同时有对ADB集群实例owner进行通知。是经过灰度发布，发布涉及几十个实例，率先灰度的均为弹内的实例，持续观察24h，实例升级后有集群CPU水位、查询RT、失败率等系统指标监控，但是灰度期间监控指标均正常，因此无法发现本次问题。\n ACTION：\n\n暂无。\n\n\n\n**【****黄金眼指标观察**，10分钟左右，观察已发布**本机房、核心pid、分广告主体类型**的黄金眼业务指标】--红线点\n\n**【****变更改动点验证**，验证已变更的**功能逻辑&数据已经生效**(最好有直接或间接生效截图记录)**】**--红线点\n\n**〖关注点3〗**是否进行黄金眼指标观察，观察是否发现问题？是否验证变更改动点，验证是否发现问题？\n\n请提供观测链接：[https://perth.aliyun-inc.com/query_analysis?searchType=instId&instId=500182691&command=3h&startTime=1729147967160&endTime=1729144367160](https://perth.aliyun-inc.com/query_analysis?searchType=instId&instId=500182691&command=3h&startTime=1729147967160&endTime=1729144367160)\n\n [原因分析]不涉及黄金眼指标观察。有进行功能逻辑验证，针对性能优化方面，通过sql性能测试集验证集群实例性能有所提升；同时有进行数据正确性的验证，验证期间一切正常，均未出现问题。\n ACTION：\n\n暂无\n\n#### 2、故障应急阶段\n**〖关注点4〗**是否有监控发现？若没有，为什么？（监控缺失/报警太多未及时处理/。。） \n[原因分析]\n【阿里妈妈】测试团队测试任务巡检报错监控发现货品运营场景主流程打开超时\n监控链接：[https://armor.alibaba-inc.com/testsupport/apitest/snapshot/detail?productId=10100&snapshotId=24109679&deptNo=&productionId=10100](https://armor.alibaba-inc.com/testsupport/apitest/snapshot/detail?productId=10100&snapshotId=24109679&deptNo=&productionId=10100)\n\n\n【猫超】研发团队收到有关选品接口所在服务成功率监控报警\n监控链接：\n\n[https://sunfire.alibaba-inc.com/custom/42/product/preview/spm/1828](https://sunfire.alibaba-inc.com/custom/42/product/preview/spm/1828)\n\n\n\n【阿里云】针对本次出问题的实例有监控，但未配置报警，由于日常业务方会存在因业务活动导致SQL查询量变大的正常情况，因此针对实例监控报警的配置，按阿里云侧正常流程是在发布前后几天内进行监控报警配置，因为本次故障发生时间是10月11日，该实例监控在10月11日近几天没有发布，因此未配置监控报警。\n监控链接：[https://perth.aliyun-inc.com/query_analysis?searchType=instId&instId=500182691&command=3h&startTime=1729147967160&endTime=1729144367160](https://perth.aliyun-inc.com/query_analysis?searchType=instId&instId",
    "chunk_order_index": 4,
    "full_doc_id": "doc-8919b47a13c30569aae09a184cc8291d"
  },
  "chunk-1e4d66eb40bfa4aa57fa2ebd4804e1f4": {
    "tokens": 1200,
    "content": "故障发生时间是10月11日，该实例监控在10月11日近几天没有发布，因此未配置监控报警。\n监控链接：[https://perth.aliyun-inc.com/query_analysis?searchType=instId&instId=500182691&command=3h&startTime=1729147967160&endTime=1729144367160](https://perth.aliyun-inc.com/query_analysis?searchType=instId&instId=500182691&command=3h&startTime=1729147967160&endTime=1729144367160)\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/2756591/1729149696140-2199714b-05ec-497b-8e9b-9da69e3cfd00.png)\n\n ACTION：\n1、妈妈物料中新增加对猫超接口专门监控；——负责人：乐焱，预计：10.23，验收人：端默  \n2、猫超团队针对本次实例监控新增系统指标监控报警；——负责人：荀一，预计：10.25\n3、阿里云同学为业务方提供监控需要的相关核心指标，确保本次问题能及时发现；——负责人：西问，预计：10.18，验收人：荀一\n\n**〖关注点5〗**相关角色的应急响应是否有改进空间？故障恢复方式是什么？是否可优化\n[原因分析]\n应急过程中恢复时间较久，在重启、垂直扩容两个解决方案进行决策，以及云侧再次排查需确认该问题垂直扩容可解决，再进行集群垂直扩容走审批流后恢复。\n ACTION：\n1、猫超侧选品接口热备：增加一路Holo数据源热备，支持一键切换；——负责人：荀一，预计：10.12，验收人：\n2、当业务方处于故障应急阶段时，涉及云侧的协同排查，第一时间联系阿里云CRE团队同学协助跟进。\n\n\n**〖关注点6〗****此次故障是否触发广告技术部安全生产中的红线点？**\n\n- [ ] 是，团队： \n\n- [x] 否\n\n## 六、后续Action\n| **序号** | *******Action标题** | **Action描述** | *******负责人** | *******计划完成时间** | **验收标准** | **验收人** | **是否keyAction** | **是否回血Action** |\n| :---: | --- | --- | :---: | :---: | --- | :---: | :---: | :---: |\n| 1 | 短期：猫超侧选品接口热备 | 增加一路Holo数据源热备，支持一键切换。 | 荀一 | 10.12 | 预发环境切换后，选品接口正常相应。 | 荀一 | - | - |\n| 2 | 短期：增加对猫超接口专门监控 | 妈妈物料中新增加对猫超接口专门监控。 | 乐焱 | 10.20 | 确保新增猫超专门接口监控，保障监控有效性和报警及时性。 | 端默 | - | - |\n| 3 | 短期：补充测试用例 | 自动化测试中针对内存打满后对象泄漏的场景进行测试用例的补充。 | 西问 | 已完成 | - | - | 是 | - |\n| 4 | 短期：云侧ADB代码修复 | 阿里云ADB团队针对本次代码bug进行修复，实例升级时间需与猫超业务方进行确认。 | 西问 | 10.25 | 确保本次代码问题修复后发布上线后一切正常。 | 传学 | 是 | - |\n| 5 | 短期：新增系统指标监控报警 | 阿里云同学为业务方提供监控需要的相关核心指标，确保本次问题能及时发现，猫超团队针对本次实例监控新增系统指标监控报警。 | 荀一西问 | 10.25 | - | - | - | - |\n\n\n## 七、故障相关方\n【故障等级】P5\n\n| **  系统质量（30%）** | | | | | **处置能力（70%）** |\n| :---: | --- | --- | --- | --- | :---: |\n| **相关方** | **需求设计** | **代码质量** | **变更质量** | **自定义项** | **发生时间** | **发现时间（30%）** | **恢复时间（40%）** |\n| 淘天集团-用户平台&阿里妈妈事业部-阿里妈妈-广告技术部-工程技术-效果BP-电商场景 | 不涉及 | 不涉及 | 不涉及 | - | 10-11 10:57 | 10-11 10:30 | 10-11 12:31 |\n| 淘天集团-业务技术-自营技术-经营技术-商业化&财务分析 | 不涉及 | 不涉及 | 不涉及 | - | 10-11 10:57 | 10-11 11:00 | 10-11 12:31 |",
    "chunk_order_index": 5,
    "full_doc_id": "doc-8919b47a13c30569aae09a184cc8291d"
  },
  "chunk-4fd926333b1c9b97a7bba9902164631a": {
    "tokens": 179,
    "content": "景 | 不涉及 | 不涉及 | 不涉及 | - | 10-11 10:57 | 10-11 10:30 | 10-11 12:31 |\n| 淘天集团-业务技术-自营技术-经营技术-商业化&财务分析 | 不涉及 | 不涉及 | 不涉及 | - | 10-11 10:57 | 10-11 11:00 | 10-11 12:31 |\n| 云智能集团-阿里云智能-阿里云智能CTO线-数据库产品事业部-ADB产品部-AnalyticDB MySQL及开源OLAP-智能优化组 | 否 | 是 | 否 | - | 10-11 10:57 | 10-11 11:35 | 10-11 12:31 |",
    "chunk_order_index": 6,
    "full_doc_id": "doc-8919b47a13c30569aae09a184cc8291d"
  },
  "chunk-e9010b811b2a6b71fd052ffba2b55cf0": {
    "tokens": 1200,
    "content": "![](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/9827/1659103353652-0274c8cd-7318-4cd9-b730-0d66221680b6.png)\n\n**内容涉及公司B3级别以上机密数据，请注意保密！**\n\n| **复盘参与人员** | 稳定性负责人：广生工程技术-基础平台-SRE：娇娇营销研究和体验中心-前端技术部-体验二组：奇贤、左莫工程技术-效果BP-BP工具：久遥工程技术-基础平台-质量技术&平台：青絮、萧风商业化运营中心-客户体验-体验优化：儿布 |\n| --- | --- |\n| **地点** | 杭州：A3-3-11-N 溪枫阁（西溪A区）北京：C1-211 忘忧谷（北京朝阳科技园C区） |\n| **会议时间** | 10月12日 周六 15:00 - 16:00(GMT+8) |\n| **复盘主持人** | 泽萱 |\n\n\n## 一、故障简述\n于2024年10月9日09:42分广告技术部收到有关无界下载报表提示系统异常的客诉预警单，原因确认是下载接口参数格式错误，导致下载接口报错。通过执行adc回滚操作，业务于10:03分恢复。故障期间累计客诉19例。\n\n\n**APM故障链接：**\n\n [https://tr.alibaba-inc.com/ormEmergency/workbench/emergency/202410090000000289001](https://tr.alibaba-inc.com/ormEmergency/workbench/emergency/202410090000000289001)\n\n## 二、故障过程回顾\n### 2.1【时间线概览】\n![画板](https://intranetproxy.alipay.com/skylark/lark/0/2024/jpeg/80256396/1728640093424-67aede59-18de-4a51-b89f-802bbd3f6c2f.jpeg)\n\n故障发现～初因定位：09:43~09:51，8min\n\n初因定位～故障恢复：09:51~10:03，12min\n\n### 2.2【故障处理时间线】\n**2024-10-08 17:56:54**，[@奇贤](undefined/changlong.jcl)同学执行前端CDN版本上线；**——【故障注入】**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/285375/1728645634530-731fbbe5-9588-4656-9ab8-f36b47591716.png)\n\n2024-10-09 09:17，阿里妈妈客满团队收到第一例有关无界下载报表提示系统异常的客诉反馈；\n\n**2024-10-09 09:28**，客诉达到3例（去重后）；**——【故障发生】**\n\n2024-10-09 09:42，广告技术部收到有关无界下载报表提示系统异常的客诉预警单；\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256396/1728627643259-445a1c57-1aea-4ca2-9718-adc8ea3e3f97.png)\n\n**2024-10-09 09:43**，[@三朝](undefined/zefan.wzf)接手并介入处理；**——【故障发现】【业务响应】**\n\n2024-10-09 09:48，创建应急群协同各团队同学对焦处理，联系客满同学[@儿布](undefined/erbu.lxx)提供客诉细节；rttpp旗舰店客诉内容：客户表示人群报表 可以正常导出；关键词报表 就提示有错误。\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256396/1728628169314-098f3968-7c64-42a2-b253-7224881e38de.png)\n\n**2024-10-09 09:51**，[@仲古](undefined/zhonggu.qyc)发起语音会议进行对焦；[@三朝](undefined/zefan.wzf)联系[@久遥](undefined/xuwen.pangxuwen)同步报错trace ID：213e3f7217284373028921159e1368，经排查发现queryDomains传参异常导致；关于基础报表关键词场景在前一天有发布，初步怀疑是前端发布导致，进一步联系[@奇贤](undefined/changlong.jcl)介入排查；**——【初因定位】**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256396/1728628367468-c7034ced-00ab-41f5-81a4-dd240fec8507.png)![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256396/1728628399471-09a23ded-7f6f-44ec-be20-604180999d2b.png)\n\n2024-10-09 09:57，[@",
    "chunk_order_index": 0,
    "full_doc_id": "doc-9fc81576c9fb5ecee10d07a16d66297f"
  },
  "chunk-4c84be54b5c499b439de02900f9a8f16": {
    "tokens": 1200,
    "content": "4/png/80256396/1728628367468-c7034ced-00ab-41f5-81a4-dd240fec8507.png)![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256396/1728628399471-09a23ded-7f6f-44ec-be20-604180999d2b.png)\n\n2024-10-09 09:57，[@久遥](undefined/xuwen.pangxuwen)同步复现方式，关键词报表 维度勾选2个以上，点击下载报表即可复现该报错内容；\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/80256396/1728628448897-f451a9f1-80ea-4250-809f-210f66434a10.png)\n\n**2024-10-09 10:02**，[@奇贤](undefined/changlong.jcl)开始操作adc回滚前端cdn版本；**——【恢复执行】**\n\n**2024-10-09 10:03**，[@奇贤](undefined/changlong.jcl)完成adc回滚前端cdn版本的操作；**——【故障恢复】【影响消除】**\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/285375/1728645550774-06d3caf3-b3b6-440d-a040-b35c26909a2e.png)\n\n2024-10-09 10:04，[@久遥](undefined/xuwen.pangxuwen)反馈是昨天前端发布导致，已回滚恢复。\n\n## 三、影响产品线&影响面\n    - [x] 是否有客诉量：\n        * 故障期间累计客诉量：19例（去重后）\n\n[10.9报表不能下载问题.xlsx](https://yuque.antfin.com/attachments/lark/0/2024/xlsx/147156506/1731031226240-4705211c-6a10-42c9-9c4a-1a0f26ce5241.xlsx)\n\n    - [ ] 是否产生资损：\n        * 无\n\n## 四、故障原因\n### 4.1【一句话原因】\n修复关键词报表 多tab灰度客户场景过滤参数被覆盖失效问题，这个问题会导致用户看到的关键词场景汇总报表数据是全场景的数据。 修复代码bug导致下载接口传参错误。\n\n### 4.2【详细原因】\n原处理参数默认值的逻辑，会因为预设参数不区分列表和汇总数据有互相覆盖的问题。后面新添加了单独的参数处理逻辑，  但是新的逻辑从url读取参数后， 没有 使用JSON.parse()反解，导致参数类型不对的接口报错。\n\n问题代码\n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/285375/1728647183856-157b3da1-094e-45ae-9001-da4965de87ab.png)\n\n\n\n可以看到 通过 loc.get(item.key) || item.default没有parse 直接赋值了 \n\n\n\n正确的修复代码 \n\n![](https://intranetproxy.alipay.com/skylark/lark/0/2024/png/285375/1728647432374-5b150acc-034d-452f-8a4d-d60e8a75ced0.png)\n\n## 五、关注点讨论\n#### 1、问题引入阶段\n【在/离线变更代码开发完成后，需要经过**code review**确认无误后进行合并**代码主干**提交】--红线点\n【在线变更代码修改提交必须经过**功能单测；**离线变更代码修改完成后，生成的离线数据必须要经过**数据校验**】--红线点\n\n**〖关注点1〗**是否有经过CR？是否有经过单测？是否有经过测试？是否自动化测试可覆盖？测试阶段为何没发现？\n请提供CR链接：[https://code.alibaba-inc.com/mm/onebp/compare?from=publish/20240910.104629.536&to=publish/20241008.112207.137&mergeBase=true](https://code.alibaba-inc.com/mm/onebp/compare?from=publish/20240910.104629.536&to=publish/20241008.112207.137&mergeBase=true)\n\n [原因分析] 发布前经过了代码cr和自测，测试团队也进行了测试。\ncr时候过于关注值相互覆盖影响的逻辑了 忽略了值类型的问题\n测试时候也没有测到筛选条件后 下载的case。\n ACTION： \n针对新的项目需求后续开发设计要考虑降低代码耦合性，使代码迭代改动的影响范围清晰可控。\n自动化测试中补充关键词场景下多维度下载报表的测试用例；——负责人：萧风，已完成，验收人：青絮\n\n【生产变更，**务必要经过灰度发布**，灰度发布时间**间隔大于20min****】**--红线点\n\n**〖关注点2〗**是否变更窗口期进行发布？是否经过灰度？分机房或分批发布第一批发布时间间隔",
    "chunk_order_index": 1,
    "full_doc_id": "doc-9fc81576c9fb5ecee10d07a16d66297f"
  },
  "chunk-98f37f241e60fafdafa0a4cb69508278": {
    "tokens": 1200,
    "content": "补充关键词场景下多维度下载报表的测试用例；——负责人：萧风，已完成，验收人：青絮\n\n【生产变更，**务必要经过灰度发布**，灰度发布时间**间隔大于20min****】**--红线点\n\n**〖关注点2〗**是否变更窗口期进行发布？是否经过灰度？分机房或分批发布第一批发布时间间隔是否大于20分钟？灰度过程中为何未发现问题？\n请提供ChangeFree变更单链接：  [https://aicf.alibaba-inc.com/aicf/change/v2/detail/1284068623?spm=goc-apm.aicf-_changeList.0.0.cab4238875jP6N](https://aicf.alibaba-inc.com/aicf/change/v2/detail/1284068623?spm=goc-apm.aicf-_changeList.0.0.cab4238875jP6N)\n\n [原因分析]是变更窗口期发布，不涉及灰度发布，前端发布经过了beta环境测试验证  但是漏了这个case  所有没有发现问题。\n ACTION：\n\nADC平台预计11月底支持前端灰度发布。\n\n\n\n**【****黄金眼指标观察**，10分钟左右，观察已发布**本机房、核心pid、分广告主体类型**的黄金眼业务指标】--红线点\n\n**【****变更改动点验证**，验证已变更的**功能逻辑&数据已经生效**(最好有直接或间接生效截图记录)**】**--红线点\n\n**〖关注点3〗**是否进行黄金眼指标观察，观察是否发现问题？是否验证变更改动点，验证是否发现问题？\n\n [原因分析]本次变更不涉及黄金眼指标观察。发布后有进行报表场景的功能回归验证，未发现问题是因为本次变更不知晓针对关键词报表筛选多维度进行下载的场景会受影响，因此未发现问题。\n ACTION：\n\n暂无\n\n#### 2、故障应急阶段\n**〖关注点4〗**是否有监控发现？若没有，为什么？（监控缺失/报警太多未及时处理/。。） \n请提供监控报警链接：[https://aem.alibaba-inc.com/project/mmbp_onebp/page/performance/stability/api](https://aem.alibaba-inc.com/project/mmbp_onebp/page/performance/stability/api)\n\n[原因分析] \n本次属于非监控发现\n前端监控缺失，前端接口报错监控 只有adc接口是专门区分 单独监控的  其他接口是统一监控的\n这个下载接口报错量级太小    3000报错/天   线上常规报错3000000左右每天\n后端监控阈值未触发，后端有整体大盘监控，触发条件接口成功率跌至95%以下。报表下载是通用接口，基础报表下的多个报表下载均复用。本次故障仅出现在关键词场景下且只有筛选维度勾选2个及以上才会触发，占整体请求不足1/100。\n ACTION：\n短期方案：重点业务接口 单独监控；——负责人：奇贤，预计：2周，验收人：左莫\n长期方案：前端团队针对无界业务场景每个接口独立监控报警。——负责人：奇贤，预计：已完成，验收人：左莫  \n  \n**〖关注点5〗**相关角色的应急响应是否有改进空间？故障恢复方式是什么？是否可优化\n[原因分析] 初步判断问题  排除回滚不会引发更严重问题 操作回滚 回滚操作两次 （第一次回滚到出问题的版本）\n ACTION：\n\n熟悉平台回滚操作流程。\n\n\n\n**〖关注点6〗****此次故障是否触发广告技术部安全生产中的红线点？**\n\n- [ ] 是，团队： \n\n- [x] 否\n\n## 六、后续Action\n| **序号** | *******Action标题** | **Action描述** | *******负责人** | *******计划完成时间** | **验收人** | **是否keyAction** | **是否回血Action** |\n| :---: | --- | --- | :---: | :---: | :---: | :---: | :---: |\n| 1 | 短期：补充测试用例 | 自动化测试中补充关键词场景下多维度下载报表的测试用例 | 萧风 | 已完成 | 青絮 | 是 | - |\n| 2 | 短期：新增重点业务接口监控 | 新增关键词报表场景重点业务接口的单独监控 | 奇贤 | 10.25 | 左莫 | 是 | - |\n| 3 | 短期：新增接口监控 | 前端团队针对无界业务场景每个接口独立监控报警 | 奇贤 | 10.25 | 左莫 | - | - |\n\n\n\n\n## 七、故障相关方\n【故障等级】P5\n\n| **  系统质量（30%）** | | | | | **处置能力（70%）** |\n| :---: | --- | --- | --- | --- | :---: |\n| **相关方** |",
    "chunk_order_index": 2,
    "full_doc_id": "doc-9fc81576c9fb5ecee10d07a16d66297f"
  },
  "chunk-c1ee3bf60a21d778367bfe59e9bb3d5b": {
    "tokens": 219,
    "content": "| 前端团队针对无界业务场景每个接口独立监控报警 | 奇贤 | 10.25 | 左莫 | - | - |\n\n\n\n\n## 七、故障相关方\n【故障等级】P5\n\n| **  系统质量（30%）** | | | | | **处置能力（70%）** |\n| :---: | --- | --- | --- | --- | :---: |\n| **相关方** | **需求设计** | **代码质量** | **变更质量** | **自定义项** | **发生时间** | **发现时间（30%）** | **恢复时间（40%）** |\n| 淘天集团-用户平台&阿里妈妈事业部-阿里妈妈-广告技术部-营销研究和体验中心-前端技术部-体验二组 | 不涉及 | 是 | 否 | - | 10-09 09:28 | 10-09 09:43 | 10-09 10:03 |",
    "chunk_order_index": 3,
    "full_doc_id": "doc-9fc81576c9fb5ecee10d07a16d66297f"
  }
}